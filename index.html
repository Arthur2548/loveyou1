<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Family Tree (Enhanced Lineage & Surnames)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Mali:wght@400;600&family=Chakra+Petch:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* ================= THEME VARIABLES ================= */
        :root {
            --bg-main: #f8fafc;
            --bg-dots: #e2e8f0;
            --text-main: #334155;
            --text-sub: #64748b;
            --primary: #475569;
            --primary-light: #94a3b8;
            --accent-bg: #ffffff;
            --accent-border: #e2e8f0;
            --card-shadow: rgba(0, 0, 0, 0.05);
            /* New Themed Line Colors */
            --line-color-child: #94a3b8; /* Slate */
            --line-color-spouse: #fca5a5; /* Red (light) */
            --line-width: 1.5px;
            --heart-color: #ef4444;
        }

        /* Themes */
        [data-theme="pink"] { 
            --bg-main: #fff0f5; --bg-dots: #fbcfe8; --text-main: #831843; --text-sub: #be185d; 
            --primary: #ec4899; --primary-light: #f9a8d4; --accent-bg: #fff; 
            --accent-border: #fbcfe8; 
            --line-color-child: #f472b6; /* Pink */
            --line-color-spouse: #34d399; /* Green for contrast */
        }
        [data-theme="purple"] { 
            --bg-main: #faf5ff; --bg-dots: #e9d5ff; --text-main: #581c87; --text-sub: #7e22ce; 
            --primary: #a855f7; --primary-light: #d8b4fe; --accent-bg: #fff; 
            --accent-border: #e9d5ff; 
            --line-color-child: #c084fc; /* Purple */
            --line-color-spouse: #fcd34d; /* Yellow for contrast */
        }
        [data-theme="yellow"] { 
            --bg-main: #fffbeb; --bg-dots: #fde68a; --text-main: #78350f; --text-sub: #b45309; 
            --primary: #f59e0b; --primary-light: #fcd34d; --accent-bg: #fff; 
            --accent-border: #fde68a; 
            --line-color-child: #fbbf24; /* Amber */
            --line-color-spouse: #38bdf8; /* Blue for contrast */
        }
        [data-theme="blue"] { 
            --bg-main: #f0f9ff; --bg-dots: #bae6fd; --text-main: #0c4a6e; --text-sub: #0284c7; 
            --primary: #0ea5e9; --primary-light: #7dd3fc; --accent-bg: #fff; 
            --accent-border: #bae6fd; 
            --line-color-child: #38bdf8; /* Blue */
            --line-color-spouse: #f472b6; /* Pink for contrast */
        }

        /* ================= GENERAL STYLES ================= */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        h1, h2, h3, .font-cute { font-family: 'Mali', cursive; }
        .font-royal { font-family: 'Chakra Petch', sans-serif; }

        
        /* ================= CANVAS AREA (SVG) ================= */
        #canvas-container {
            flex: 1;
            position: relative;
            cursor: grab;
            background-color: var(--bg-main);
            background-image: radial-gradient(var(--bg-dots) 1px, transparent 1px);
            background-size: 24px 24px;
            overflow: hidden;
        }
        #canvas-container:active { cursor: grabbing; }

        #main-svg { width: 100%; height: 100%; display: block; }

        /* Nodes inside SVG */
        .node-box {
            width: 100%; height: 100%;
            background: var(--accent-bg);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 8px 6px;
            box-shadow: 0 4px 15px -3px var(--card-shadow);
            border-width: 2px;
            border-style: solid;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-sizing: border-box;
            position: relative;
        }
        .node-box:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.15); z-index: 10; border-color: var(--primary); }
        
        /* Focused & Highlight Animation */
        .node-box.focused { box-shadow: 0 0 0 4px var(--primary-light); }
        
        .node-flash {
            animation: flash-highlight 1.5s infinite ease-in-out;
            border-color: #ef4444 !important;
            border-width: 3px !important;
            z-index: 50;
        }

        @keyframes flash-highlight {
            0% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0); transform: scale(1); }
        }

        /* Status Borders */
        .border-male { border-color: #38bdf8; } 
        .border-female { border-color: #c084fc; } 
        .border-king { border-color: #fbbf24; background: linear-gradient(to bottom, #fff, #fffbeb); } 
        .border-queen { border-color: #f472b6; background: linear-gradient(to bottom, #fff, #fff0f5); } 
        
        /* Death Visuals */
        .border-dead { filter: grayscale(1) opacity(0.8); border-style: dashed !important; border-color: #64748b !important; }
        
        /* Monarch Death: Black Border, Normal Image */
        .border-dead-royal { 
            border-color: #000000 !important; 
            border-width: 3px !important;
            background: #f8f8f8;
        }
        
        .img-grayscale { filter: grayscale(1); }
        .img-normal { filter: none; }

        /* Connectors (Updated for Themed Lines) */
        .connector { fill: none; stroke-width: var(--line-width); transition: stroke 0.3s; }
        .connector-child { stroke: var(--line-color-child); } /* New: Color for parent-child connection */
        .connector-spouse { stroke: var(--line-color-spouse); } /* New: Color for spouse connection */
        .connector:hover { stroke: var(--primary); stroke-width: 2.5px; }
        .heart-icon { font-size: 14px; fill: var(--heart-color); filter: drop-shadow(0px 1px 2px rgba(255, 255, 255, 0.8)); }

        /* Ancestor Label */
        .ancestor-label {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: bold;
            z-index: 5;
        }

        /* ================= TABLE VIEW ================= */
        .table-view-container {
            background-color: var(--bg-main);
            overflow-y: auto;
            flex: 1;
            padding: 2rem;
        }
        .table-wrapper {
             overflow-x: auto; /* Ensure horizontal scrolling for table */
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { color: var(--text-sub); font-weight: 600; padding: 12px; font-size: 14px; border-bottom: 2px solid var(--accent-border); white-space: nowrap; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--accent-border); background: var(--accent-bg); color: var(--text-main); font-size: 14px; vertical-align: middle; }
        tr.data-row:hover td { background-color: var(--bg-dots); cursor: pointer; }
        tr.data-row:first-child td:first-child { border-top-left-radius: 16px; }
        tr.data-row:first-child td:last-child { border-top-right-radius: 16px; }
        tr.data-row:last-child td:first-child { border-bottom-left-radius: 16px; }
        tr.data-row:last-child td:last-child { border-bottom-right-radius: 16px; }

        /* NEW: Glowing tags for table view */
        .monarch-tag-table { 
            background-color: #fffbeb; 
            color: #a16207; 
            border: 1px solid #fcd34d; 
            padding: 1px 6px; 
            border-radius: 6px; 
            font-size: 10px; 
            font-weight: bold; 
            box-shadow: 0 0 8px rgba(253, 211, 77, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        .queen-consort-tag-table {
            background-color: #fce7f3; /* Light pink */
            color: #be185d; /* Darker pink */
            border: 1px solid #fbcfe8;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(251, 207, 232, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        .heir-tag-table {
            background-color: #fee2e2; /* Light red */
            color: #991b1b; /* Darker red */
            border: 1px solid #fecaca;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(254, 202, 202, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        /* ================= UI CONTROLS ================= */
        .floating-controls {
            position: absolute; bottom: 24px; right: 24px;
            display: flex; flex-direction: column; gap: 8px; z-index: 50;
        }
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-bg); border: 1px solid var(--accent-border);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .ctrl-btn:hover { transform: scale(1.1); background: var(--bg-dots); }

        .btn-theme { background-color: var(--primary); color: white; border-radius: 50px; font-weight: 600; padding: 6px 16px; font-size: 12px; transition: all 0.2s; }
        .btn-theme:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-icon { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--primary); border-radius: 50%; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-dots); transform: scale(1.1); }

        .input-theme { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--text-main); border-radius: 12px; padding: 8px; outline: none; }
        .input-theme:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--bg-dots); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 24px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2); }

        /* Fantasy Celebration Modal */
        #fantasyModal .modal-content {
            background: linear-gradient(135deg, #1a0b00 0%, #4a2c0a 100%);
            border: 2px solid #d4af37;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3), inset 0 0 30px rgba(0,0,0,0.8);
            color: #f3e5ab;
            max-width: 500px;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 40px 20px;
        }
        .golden-frame {
            border: 3px double #d4af37;
            padding: 4px;
            display: inline-block;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            background: #000;
        }
        .shimmer-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            animation: shimmer 3s infinite linear;
            background-size: 200% auto;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        .particle { position: absolute; background: #ffd700; border-radius: 50%; opacity: 0; animation: rise 4s infinite ease-in; }
        @keyframes rise { 0% { bottom: -10px; opacity: 0; transform: scale(0); } 50% { opacity: 1; } 100% { bottom: 100%; opacity: 0; transform: scale(1); } }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; }
        .toast { background: #334155; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideUp 0.3s ease-out; opacity: 0.9; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 0.9; } }

        /* Monarch Banner */
        .monarch-frame { border: 2px solid #fbbf24; background: linear-gradient(to right, #fffbeb, #fff); box-shadow: 0 4px 6px rgba(251, 191, 36, 0.2); }
        
        /* Badges for Tree */
        .badge-monarch { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-krom { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-heir { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }

/* --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå --- */
.badge-kulachet {
    background: linear-gradient(135deg, #78350f 0%, #b45309 100%); /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
    color: #fffbeb;
    border: 1px solid #92400e;
    padding: 2px 10px;
    border-radius: 99px;
    font-size: 10px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(120, 53, 15, 0.4);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-left: 5px;
    vertical-align: middle;
}


        /* Kingdom Selector */
        .kingdom-selector {
            background: white;
            border: 1px solid var(--accent-border);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            color: var(--text-main);
            max-width: 200px;
            font-weight: bold;
        }

        /* View Mode Selector */
        .view-mode-selector {
            background: var(--accent-bg);
            color: var(--primary);
            border: 1px solid var(--accent-border);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            outline: none;
            cursor: pointer;
            text-align: center;
            appearance: none;
        }
        .view-mode-wrapper { position: relative; }
        .view-mode-wrapper::after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            pointer-events: none;
            font-size: 10px;
        }






        
    /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà --- */
.mother-tag-container {
    display: inline-flex;
    align-items: center;
    margin-left: 10px;
    font-size: 11px;
    font-weight: bold;
    border: 1px solid #dbeafe;
    border-radius: 6px;
    overflow: hidden;
    vertical-align: middle;
}

.mother-tag-label {
    background-color: #eff6ff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    color: #1e40af; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    padding: 2px 6px;
}

.mother-tag-value {
    background-color: #eff6ff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    color: #92400e; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏ß‡πà‡∏≤‡∏á (Amber/Brown) */
    padding: 2px 8px;
    border-left: 1px solid #dbeafe;
}

.mother-group-header {
    background-color: #f8fafc;
    border-left: 4px solid #3b82f6;
}

.mother-group-header td {
    padding: 12px 20px;
    font-weight: bold;
    color: #1e40af;
    font-size: 14px;
    border-bottom: 1px solid #e2e8f0;
}

.child-index-circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background-color: #eff6ff;
    color: #3b82f6;
    border-radius: 50%;
    font-weight: bold;
    font-size: 12px;
    border: 1px solid #dbeafe;
}
/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà (‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) */
.tag-order {
    display: inline-block;
    border: 2px solid #fbbf24;
    background-color: #fffbeb;
    color: #b45309;
    padding: 2px 8px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 11px;
    margin-right: 5px;
    font-family: 'Mali', cursive;
}

/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó (‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á) */
.tag-heir {
    display: inline-block;
    border: 2px solid #a855f7;
    background-color: #faf5ff;
    color: #7e22ce;
    padding: 2px 8px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 11px;
    margin-left: 5px;
    font-family: 'Mali', cursive;
}

/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Item) */
.appoint-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: left;
    background: white;
}

.appoint-item:hover {
    background-color: #fffbeb;
    border-color: #fbbf24;
    transform: scale(1.02);
}

.appoint-item.selected {
    border-color: #fbbf24;
    background-color: #fffbeb;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.2);
}

/* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
.appoint-list-container {
    max-height: 350px;
    overflow-y: auto;
    margin-bottom: 15px;
    padding: 5px;
    /* Custom scrollbar */
}

.appoint-list-container::-webkit-scrollbar { width: 6px; }
.appoint-list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° */
#modalTitle {
    transition: all 0.3s ease;
}
/* ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏ö‡∏¥‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
#modalTitle:contains("‡∏ö‡∏¥‡∏î‡∏≤") { color: #1e40af; }
/* ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π */
#modalTitle:contains("‡∏°‡∏≤‡∏£‡∏î‡∏≤") { color: #be185d; }


/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ */
.destiny-card {
    background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    border: 2px solid #6366f1;
    position: relative;
    overflow: hidden;
}
.destiny-shimmer {
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.1), transparent);
    transform: rotate(45deg);
    animation: destiny-shimmer 3s infinite;
}
@keyframes destiny-shimmer {
    0% { transform: translate(-30%, -30%) rotate(45deg); }
    100% { transform: translate(30%, 30%) rotate(45deg); }
}


#canvas-container:fullscreen {
    background-color: var(--bg-main);
    width: 100vw;
    height: 100vh;
}


/* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô Header ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏±‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
:fullscreen header {
    display: none;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Header */
:fullscreen main {
    height: 100vh;
}

/* ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Modal ‡∏°‡∏µ z-index ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
:fullscreen .modal {
    z-index: 9999;
}

/* --- ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°) --- */
.sortable-ghost {
    opacity: 0.3;
    background-color: #eef2ff !important;
    border: 2px dashed #6366f1;
}
.sortable-chosen {
    background-color: #ffffff;
    box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
}
.sortable-drag {
    opacity: 1 !important;
    background-color: #ffffff !important;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    cursor: grabbing;
    transform: scale(1.02);
    z-index: 9999;
}
.drag-handle {
    cursor: grab;
    padding: 8px;
    color: #cbd5e1;
    transition: all 0.2s;
}
.drag-handle:hover { color: #6366f1; }
.drag-handle:active { cursor: grabbing; }

/* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç --- */
.table-row-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-bottom: 1px solid #f1f5f9;
    background-color: #ffffff;
}
.table-row-item:hover {
    background-color: #f8fafc;
}
.index-number {
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    color: #94a3b8;
    width: 30px;
}
.sortable-fallback {
    opacity: 1 !important;
}

/* --- ‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏® (Base Style) --- */
.badge-rank {
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 10px;
    font-weight: 700;
    border-width: 1px;
    display: inline-flex;
    align-items: center;
    text-transform: uppercase;
}

/* --- üé® ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏®‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô --- */

/* ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (Chao Fa) - ‡πÇ‡∏ó‡∏ô‡∏°‡πà‡∏ß‡∏á/‡∏ä‡∏°‡∏û‡∏π */
.rank-jf-special { 
    background-color: #ddd6fe !important; /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
    color: #4c1d95; 
    border: 2px solid #a855f7; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏û‡∏¥‡πÄ‡∏®‡∏©" */
} 
.rank-jf-1 { 
    background-color: #ddd6fe !important; /* ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏° (Purple 200) */
    color: #4c1d95; 
    border-color: #c4b5fd; 
} 
.rank-jf-2 { 
    background-color: #ede9fe !important; /* ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Purple 100) */
    color: #6d28d9; 
    border-color: #ddd6fe; 
} 
.rank-jf-3 { 
    background-color: #f5f3ff !important; /* ‡∏°‡πà‡∏ß‡∏á‡∏à‡∏≤‡∏á (Purple 50) */
    color: #7c3aed; 
    border-color: #ede9fe; 
}

/* ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (Phra Ong Chao) - ‡πÇ‡∏ó‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô/‡∏ü‡πâ‡∏≤ */
.rank-po-1 { 
    background-color: #bfdbfe !important; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏° (Blue 200) */
    color: #1e3a8a; 
    border-color: #93c5fd; 
} 
.rank-po-2 { 
    background-color: #dbeafe !important; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Blue 100) */
    color: #1d4ed8; 
    border-color: #bfdbfe; 
} 
.rank-po-3 { 
    background-color: #eff6ff !important; /* ‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏á (Blue 50) */
    color: #2563eb; 
    border-color: #dbeafe; 
}

/* ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (Mom Chao) - ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.rank-mc { 
    background-color: #dcfce7 !important; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô (Green 100) */
    color: #15803d; 
    border-color: #bbf7d0; 
}

/* ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå & ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á */
.rank-royal-mr { 
    background-color: #ffedd5 !important; /* ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô (Orange 100) */
    color: #9a3412; 
    border-color: #fed7aa; 
} 
.rank-royal-ml { 
    background-color: #ffe4e6 !important; /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô (Rose 100) */
    color: #9f1239; 
    border-color: #fecdd3; 
}

/* ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô */
.rank-common { 
    background-color: #f1f5f9 !important; 
    color: #475569; 
    border-color: #e2e8f0; 
}

/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.mother-tag-container {
    display: inline-flex;
    align-items: center;
    margin-left: 8px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    font-size: 9px;    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° 11px */
    font-weight: bold;
    border: 1px solid #7dd3fc;
    border-radius: 9999px; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡πÅ‡∏ö‡∏ö‡∏ß‡∏á‡∏£‡∏µ (Pill shape) */
    overflow: hidden;
    vertical-align: middle;
    padding: 1px 4px;  /* ‡∏•‡∏î padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    background-color: #e0f2fe; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
}

.mother-tag-label {
    color: #0369a1;    /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    padding: 1px 4px;
    margin-right: 2px;
}

.mother-tag-value {
    color: #075985;    /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    padding: 1px 6px;
    border-left: 1px solid #7dd3fc;
}


/* --- ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --- */
        #p_titlePrefix, #p_relationship, .input-theme {
            text-overflow: clip !important; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡πÑ‡∏Ç‡πà‡∏õ‡∏•‡∏≤ ... */
            white-space: nowrap !important; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
            overflow: visible !important;   /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ */
            padding-right: 2rem !important; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏î‡∏£‡∏≠‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå */
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏à‡∏£‡∏¥‡∏á */
        #p_titlePrefix option {
            width: auto;
            white-space: nowrap;
        }

/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ select ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° */
#p_titlePrefix, #p_relationship, #p_royalRank, .input-theme {
    text-overflow: clip !important;
    white-space: nowrap !important;
    overflow: visible !important;
    padding-right: 2rem !important;
}

/* ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö */
    .badge-informal {
        background-color: #f3e8ff !important; /* ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        color: #7e22ce !important;           /* ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
        padding: 2px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid #e9d5ff;
        display: inline-block;
        margin: 2px;
    }


    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£ (Spin Buttons) ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */
    #p_heirOrder {
        position: relative;
        appearance: none;
        -moz-appearance: textfield; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firefox */
    }

    #p_heirOrder::-webkit-inner-spin-button,
    #p_heirOrder::-webkit-outer-spin-button {
        -webkit-appearance: inner-spin-button !important;
        position: absolute;
        right: 4px;
        top: 0;
        bottom: 0;
        margin: auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
        height: 100%;
    }
    

#p_globalReignNumber {
    position: relative;
    appearance: textfield; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firefox */
    padding-right: 20px !important; /* ‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
}

/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏≠‡∏á Chrome/Safari ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î */
#p_globalReignNumber::-webkit-inner-spin-button {
    -webkit-appearance: inner-spin-button !important;
    position: absolute;
    right: 5px;   /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */
    top: 0;
    bottom: 0;
    margin: auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πä‡∏∞ */
    height: 100%;
    cursor: pointer;
}

/* ==================== THEME: ROYAL GLASS & GOLD ==================== */

/* 1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡∏ô‡∏∏‡πà‡∏°‡∏•‡∏∂‡∏Å */
.table-view-container {
    background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    padding: 2.5rem;
}

/* 2. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß */
table {
    border-collapse: separate;
    border-spacing: 0 12px; /* ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á */
    width: 100%;
}

/* 3. ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Row Card) */
tr.data-row {
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    border-radius: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    border: 1px solid rgba(255,255,255,0.6);
}

/* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏° */
tr.data-row td { border: none !important; padding: 16px; vertical-align: middle; }
tr.data-row td:first-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
tr.data-row td:last-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

/* 4. Hover Effect ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢‡∏ô‡∏∏‡πà‡∏°‡πÜ */
tr.data-row:hover {
    transform: translateY(-4px) scale(1.01);
    background: #ffffff;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    z-index: 10;
    border-color: #e0e7ff;
}

/* 5. ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TOP 3 (‡∏ó‡∏≠‡∏á, ‡πÄ‡∏á‡∏¥‡∏ô, ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á) */
tr.rank-card-1 {
    background: linear-gradient(to right, #fffbeb, #ffffff); /* ‡∏ó‡∏≠‡∏á‡∏à‡∏≤‡∏á‡πÜ */
    border: 1px solid #fcd34d;
    box-shadow: 0 10px 30px -5px rgba(251, 191, 36, 0.3);
}
tr.rank-card-2 {
    background: linear-gradient(to right, #f8fafc, #ffffff); /* ‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏á‡πÜ */
    border: 1px solid #cbd5e1;
}
tr.rank-card-3 {
    background: linear-gradient(to right, #fff7ed, #ffffff); /* ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡∏à‡∏≤‡∏á‡πÜ */
    border: 1px solid #fdba74;
}

/* 6. ‡∏ï‡∏£‡∏≤‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö (Rank Badge) */
.rank-badge-box {
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 12px;
    font-family: 'Chakra Petch', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    position: relative;
    overflow: hidden;
}
/* ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö */
.badge-gold { background: linear-gradient(135deg, #FFD700, #FDB931); color: #8a5700; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); text-shadow: 0 1px 0 rgba(255,255,255,0.5); border: 1px solid #fff; }
.badge-silver { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); color: #424242; box-shadow: 0 4px 10px rgba(189, 189, 189, 0.4); border: 1px solid #fff; }
.badge-bronze { background: linear-gradient(135deg, #f6d365, #fda085); color: #7c2d12; box-shadow: 0 4px 10px rgba(253, 160, 133, 0.4); border: 1px solid #fff; }
.badge-normal { background: #f1f5f9; color: #64748b; font-size: 0.9rem; }

/* 7. ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
.avatar-frame {
    width: 56px; height: 56px;
    padding: 2px;
    background: white;
    border-radius: 18px; /* Squircle */
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative;
}
.avatar-img {
    width: 100%; height: 100%;
    border-radius: 16px;
    object-fit: cover;
}
/* ‡∏°‡∏á‡∏Å‡∏∏‡∏é‡∏•‡∏≠‡∏¢‡∏°‡∏∏‡∏°‡∏£‡∏π‡∏õ */
.crown-icon {
    position: absolute; top: -6px; right: -6px;
    background: white; border-radius: 50%;
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    color: #f59e0b; font-size: 10px;
    border: 1px solid #fef3c7;
}

/* 8. ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Score Bar) */
.score-track {
    width: 100px; height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 6px;
}
.score-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #6366f1, #818cf8);
}
.score-fill-gold { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    


/* Animation: ‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á (Spring/Bounce Effect) */
@keyframes popUpSpring {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.05); opacity: 1; }
    80% { transform: scale(0.95); }
    100% { transform: scale(1); }
}

.modal-bounce-anim {
    animation: popUpSpring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* Custom Scrollbar ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ */
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }




    </style>
</head>
<body>

    <!-- Header -->
 <header class="sticky top-0 z-40 px-4 py-3" style="background-color: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--accent-border);">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
        <div class="flex items-center space-x-3 w-full md:w-auto">
            <div class="w-10 h-10 rounded-full flex items-center justify-center shadow-md text-white flex-shrink-0" style="background: var(--primary);">
                <i class="fa-solid fa-chess-king"></i>
            </div>
            <div class="flex flex-col min-w-0 flex-1">
                <div class="flex items-center gap-2">
                    <select id="kingdomSelector" class="kingdom-selector" onchange="switchKingdom(this.value)"></select>
                    <div class="flex items-center gap-3 bg-slate-900 text-white rounded-2xl px-4 py-2 shadow-lg border border-slate-700 ml-2">
                        <div class="flex flex-col items-center border-r border-slate-700 pr-3">
                            <div class="text-[9px] text-indigo-300 font-bold uppercase tracking-tight">
                                ‡∏û.‡∏®. <span id="displayYear">‡πí‡πï‡πñ‡πò</span> | <span id="displayDay">‡πë</span> <span id="displayMonth">‡∏°.‡∏Ñ.</span>
                            </div>
                            <div class="text-lg font-mono font-bold text-amber-400 leading-none">
                                <span id="displayHour">‡πê‡πê</span>:<span id="displayMinute">‡πê‡πê</span>:<span id="displaySecond">‡πê‡πê</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-1">
                                <button id="btnTimePlay" onclick="toggleTimePlay()" class="w-6 h-6 flex items-center justify-center rounded-full bg-indigo-600 text-white hover:bg-indigo-500 transition-all"><i class="fa-solid fa-play text-[9px]"></i></button>
                                <button onclick="openChronicleModal()" class="text-[9px] bg-slate-800 px-2 py-1 rounded border border-slate-600">‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="setTimeMultiplier(1)" id="speed1" class="text-[8px] px-1.5 py-0.5 rounded bg-indigo-500 font-bold">x‡πë</button>
                                <button onclick="setTimeMultiplier(10)" id="speed10" class="text-[8px] px-1.5 py-0.5 rounded bg-slate-700 font-bold">x‡πë‡πê</button>
                                <button onclick="setTimeMultiplier(100)" id="speed100" class="text-[8px] px-1.5 py-0.5 rounded bg-slate-700 font-bold">x‡πë‡πê‡πê</button>
                                <button onclick="setTimeMultiplier('month')" id="speedMonth" class="text-[8px] px-1.5 py-0.5 rounded bg-slate-700 font-bold text-emerald-400">+‡πë ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                                <button onclick="setTimeMultiplier('year')" id="speedYear" class="text-[8px] px-1.5 py-0.5 rounded bg-slate-700 font-bold text-blue-400">+‡πë ‡∏õ‡∏µ</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteCurrentKingdom()" class="w-6 h-6 flex items-center justify-center rounded-full text-red-400 hover:bg-red-50" title="‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏ô‡∏µ‡πâ"><i class="fa-solid fa-trash text-xs"></i></button>
                    <button onclick="openCreateKingdomModal()" class="w-6 h-6 flex items-center justify-center rounded-full text-emerald-500 hover:bg-emerald-50" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà"><i class="fa-solid fa-plus text-xs"></i></button>
                </div>
                <p id="dynastyLabel" class="text-[10px] text-slate-400 truncate"></p>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2 items-center justify-center md:justify-end w-full">
            <div class="flex gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
                <button onclick="setTheme('white')" class="w-4 h-4 rounded-full border border-gray-300 bg-gray-50"></button>
                <button onclick="setTheme('pink')" class="w-4 h-4 rounded-full border border-pink-300 bg-pink-400"></button>
                <button onclick="setTheme('purple')" class="w-4 h-4 rounded-full border border-purple-300 bg-purple-400"></button>
                <button onclick="setTheme('yellow')" class="w-4 h-4 rounded-full border border-yellow-300 bg-yellow-400"></button>
                <button onclick="setTheme('blue')" class="w-4 h-4 rounded-full border border-blue-300 bg-blue-400"></button>
            </div>

            <div class="flex flex-col gap-1">
    <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
        <input type="checkbox" id="toggleSpouseLabel" onchange="updateSpouseLabelToggle(this.checked)" class="accent-pink-500 w-3 h-3 cursor-pointer">
        <label for="toggleSpouseLabel" class="text-[10px] font-bold text-slate-500 cursor-pointer">‡∏õ‡πâ‡∏≤‡∏¢‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</label>
    </div>
    
<div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
    <input type="checkbox" id="toggleHideAge" onchange="updateHideAgeToggle(this.checked)" class="accent-indigo-500 w-3 h-3 cursor-pointer">
    <label for="toggleHideAge" class="text-[10px] font-bold text-slate-500 cursor-pointer">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</label>
</div>
</div>

            <div class="flex bg-white/50 p-1 rounded-full border border-slate-200">
                <button onclick="switchView('tree')" id="btn-view-tree" class="px-3 py-1 text-xs rounded-full transition font-bold" style="background: var(--primary); color: white;">
                    <i class="fa-solid fa-sitemap mr-1"></i> ‡∏ú‡∏±‡∏á
                </button>
                <button onclick="switchView('table')" id="btn-view-table" class="px-3 py-1 text-xs rounded-full transition text-slate-500 hover:text-slate-700">
                    <i class="fa-solid fa-table mr-1"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                </button>
            </div>

            <button onclick="openRelationshipModal()" class="btn-theme flex items-center space-x-2" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå">
                <i class="fa-solid fa-users-rays"></i> <span class="hidden lg:inline">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span>
            </button>

            <div class="relative">
                <input type="text" id="focusSearch" list="focusOptions" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•..." class="pl-8 pr-3 py-1.5 text-xs rounded-full border border-slate-200 focus:border-primary focus:ring-1 focus:ring-primary outline-none bg-white/80 w-32 transition-all focus:w-48" onchange="focusOnPerson(this.value)">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <datalist id="focusOptions"></datalist>
            </div>

            <button onclick="openRankManagementModal()" class="btn-icon w-9 h-9 flex items-center justify-center shadow-sm" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®"><i class="fa-solid fa-sliders"></i></button>
            
            <button onclick="openAddRootModal()" class="btn-theme flex items-center space-x-2"><i class="fa-solid fa-user-plus"></i><span class="hidden sm:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å</span></button>

             <div onclick="location.reload()" 
     class="w-10 h-10 rounded-full flex items-center justify-center shadow-md text-white flex-shrink-0 cursor-pointer hover:rotate-180 transition-all duration-700 active:scale-90" 
     style="background: var(--primary);" 
     title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö">
    <i class="fa-solid fa-arrows-rotate text-lg"></i>
</div>

            <div id="monarchBannerContainer" class="flex items-center">
                <div id="monarchBanner" class="hidden monarch-frame rounded-full pl-1 pr-4 py-1 flex items-center gap-2 transition-all duration-500 cursor-pointer hover:scale-105" onclick="focusOnMonarch()">
                    <div class="relative">
                        <img id="monarchImg" src="" class="w-9 h-9 rounded-full border-2 border-white shadow-sm object-cover">
                        <i class="fa-solid fa-crown text-[10px] text-yellow-500 absolute -top-1 -right-1 bg-white rounded-full p-0.5 shadow-sm"></i>
                    </div>
                    <div class="text-xs text-left hidden lg:block">
                        <div class="text-[9px] text-amber-600 font-bold uppercase tracking-wide">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</div>
                        <div id="monarchName" class="font-bold leading-none text-slate-800 text-[11px]">-</div>
                    </div>
                </div>
                <div id="monarchVacant" class="hidden bg-red-50 border border-red-200 text-red-600 rounded-full px-3 py-1 flex items-center gap-2 text-xs shadow-sm animate-pulse">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span class="font-bold hidden md:inline">‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á</span>
                    <button onclick="openAppointModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full font-bold shadow-sm transition text-[10px]">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</button>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- Tree View -->
        <div id="canvas-container" class="flex-1">
            <svg id="main-svg">
                <g id="viewport-group">
                    <g id="links-layer"></g>
                    <g id="nodes-layer"></g>
                </g>
            </svg>
            
            <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div class="bg-white/80 backdrop-blur p-6 rounded-2xl shadow-xl text-center max-w-sm pointer-events-auto border-2 border-dashed border-slate-300">
                    <div class="text-4xl mb-4 text-slate-300"><i class="fa-solid fa-sitemap"></i></div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡∏ô‡∏µ‡πâ</h3>
                    <button onclick="openAddRootModal()" class="btn-theme w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏£‡∏Å</button>
                </div>
            </div>

            <div class="floating-controls">
                <div class="view-mode-wrapper">
                    <select id="treeViewMode" class="view-mode-selector" onchange="changeViewMode(this.value)">
                        <option value="all">1. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="all_v2">2. ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏±‡∏á‡∏£‡∏ß‡∏° (v2)</option> 
                        <option value="descendants">3. ‡∏™‡∏≤‡∏¢‡∏™‡∏Å‡∏∏‡∏• (‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô)</option>
                        <option value="direct">4. ‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©+‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô)</option>
                        <option value="ancestors">5. ‡∏™‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏© (Ancestors)</option>
                        <option value="royalSurname">6. ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</option>
                        
                    </select>
                </div>

                <!-- NEW: Reign Filter Dropdown for Royal Surname View -->
                <select id="reignFilterSelector" class="view-mode-selector hidden" onchange="changeRoyalSurnameFilter(this.value)">
                    <option value="all">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•... (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                    <!-- Options populated by JS -->
                </select>

                <!-- Royal Surname Selector/Header -->
                <select id="royalSurnameSelector" class="view-mode-selector hidden" onchange="changeRoyalSurnameRoot(this.value)">
                    <!-- Options populated by JS -->
                </select>
                
                <div id="surnameViewHeader" class="bg-white/90 p-2 rounded-xl text-center shadow-md hidden">
                     <div class="text-[10px] text-slate-500">‡∏´‡∏±‡∏ß‡∏ú‡∏±‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</div>
                     <div id="surnameHeaderName" class="font-bold text-sm text-indigo-600">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.</div>
                </div>

                <div class="h-px w-20 bg-slate-300 mx-auto my-1"></div>
                <button class="ctrl-btn" onclick="toggleOrientation()" title="‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ô‡∏ß (‡∏ï‡∏±‡πâ‡∏á/‡∏ô‡∏≠‡∏ô)"><i class="fa-solid fa-arrow-right-arrow-left"></i></button>
                <button class="ctrl-btn" onclick="zoomIn()"><i class="fa-solid fa-plus"></i></button>
                <button class="ctrl-btn" onclick="zoomOut()"><i class="fa-solid fa-minus"></i></button>
                <button class="ctrl-btn" onclick="resetView()"><i class="fa-solid fa-crosshairs"></i></button>
                <button class="ctrl-btn" onclick="toggleFullScreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠"><i id="fs-icon" class="fa-solid fa-expand"></i></button>

            </div>
        </div>

      <div id="tableView" class="table-view-container hidden">
    <div class="container mx-auto max-w-5xl">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="font-cute text-2xl" style="color: var(--primary);">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            
            <div class="flex gap-2 items-center flex-wrap justify-center">
                <button id="btnResetPrecedence" onclick="resetPrecedence()" class="hidden bg-red-50 hover:bg-red-100 text-red-500 px-3 py-1.5 rounded-full text-xs font-bold transition border border-red-100" title="‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏õ‡∏Å‡∏ï‡∏¥">
                    <i class="fa-solid fa-rotate-left mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏≥‡∏î‡∏±‡∏ö
                </button>
            
        <div id="monarchFilterContainer" class="hidden flex gap-2">
    <select id="monarchFilterSelect" class="bg-amber-50 px-4 py-1.5 rounded-full border border-amber-200 text-sm font-bold text-amber-700 outline-none shadow-sm" onchange="renderTable()">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå --</option>
    </select>

    <select id="royalGenderFilter" class="bg-rose-50 px-4 py-1.5 rounded-full border border-rose-200 text-sm font-bold text-rose-700 outline-none shadow-sm" onchange="renderTable()">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="M">‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ </option>
        <option value="F">‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤ </option>
    </select>

    <select id="royalSubFilter" class="bg-blue-50 px-4 py-1.5 rounded-full border border-blue-200 text-sm font-bold text-blue-700 outline-none shadow-sm" onchange="renderTable()">
        <option value="mother_rank">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤</option>
        <option value="age_all">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</option>
    </select>
</div>

<div id="surnameFilterContainer" class="hidden flex gap-2">
    <select id="surnameLineageFilterSelect" class="bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-200 text-sm font-bold text-indigo-700 outline-none shadow-sm" onchange="filterSurnameOptions(); renderTable();">
        <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• --</option>
    </select>

    <select id="surnameFilterSelect" class="bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-200 text-sm font-bold text-indigo-700 outline-none shadow-sm" onchange="renderTable()">
        <option value="overview">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• --</option>
    </select>
</div>

<div id="kingsFilterContainer" class="hidden flex gap-2">
    <select id="kingsReignNameSelect" class="bg-emerald-50 px-4 py-1.5 rounded-full border border-emerald-200 text-sm font-bold text-emerald-700 outline-none shadow-sm" onchange="renderTable()">
        <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô --</option>
    </select>
</div>

<div id="spouseFilterContainer" class="hidden flex gap-3 mb-6">
    <div class="relative min-w-[200px]">
        <select id="spouseKingSelect" class="w-full appearance-none bg-white px-5 py-2.5 rounded-2xl border border-slate-200 text-sm font-bold text-slate-700 outline-none shadow-sm hover:border-rose-300 transition-all cursor-pointer pr-10" onchange="renderTable()">
            <option value="all">üëë ‡∏ó‡∏∏‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</option>
        </select>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] pointer-events-none"></i>
    </div>

    <div class="relative min-w-[200px]">
        <select id="spouseTypeSelect" class="w-full appearance-none bg-purple-50 px-5 py-2.5 rounded-2xl border border-purple-100 text-sm font-bold text-purple-700 outline-none shadow-sm hover:bg-purple-100 transition-all cursor-pointer pr-10" onchange="renderTable()">
            <option value="all">üíç ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="royal_consort">‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤ / ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ</option>
            <option value="concubine">‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤</option>
             <option value="high_consort">‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ</option>
        </select>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-purple-400 text-[10px] pointer-events-none"></i>
    </div>
</div>

<div id="kulachetFilterContainer" class="hidden flex gap-3 mb-6">
    <div class="relative min-w-[200px]">
         <select id="kulachetFilterSelect" class="w-full appearance-none bg-amber-50 px-5 py-2.5 rounded-2xl border border-amber-200 text-sm font-bold text-amber-800 outline-none shadow-sm hover:border-amber-300 transition-all cursor-pointer pr-10" onchange="renderTable()">
            <option value="all">üìú ‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="current">‚ú® ‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</option>
            </select>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-amber-600 text-[10px] pointer-events-none"></i>
    </div>
</div>

<div id="affiliationFilterContainer" class="hidden flex gap-3 mb-6 relative z-50">
    <div class="relative min-w-[320px]">
        <input type="text" id="affiliationSearchInput" 
               class="w-full bg-pink-50 px-5 py-2.5 rounded-2xl border border-pink-200 text-sm text-pink-700 font-bold outline-none shadow-sm placeholder-pink-400 focus:border-pink-400 transition-all pl-10 cursor-pointer"
               placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á..." 
               autocomplete="off"
               oninput="filterAffiliationList()"
               onclick="this.value=''; document.getElementById('affiliationSelect').value=''; filterAffiliationList()">
               <input type="hidden" id="affiliationSelect">

        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-pink-400 text-xs pointer-events-none"></i>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-pink-400 text-[10px] pointer-events-none"></i>
        
        <div id="affiliationDropdownList" class="hidden absolute top-full left-0 w-full mt-2 bg-white border border-pink-100 rounded-xl shadow-xl max-h-[300px] overflow-y-auto z-50 p-2 custom-scrollbar space-y-1">
            </div>
    </div>
</div>
                

               <select id="tableFilterStatus" class="bg-white px-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition cursor-pointer shadow-sm" onchange="onTableFilterChange()">
    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="alive" selected>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="dead">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
    <option value="precedence">‚ú® ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°</option>
    <option value="royal_children">üëë ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á</option>
    <option value="royal_surnames">üè∞ ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</option>
    <option value="kings">üèÜ ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</option> 
    <option value="royal_spouses">üíç ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</option> 
    <option value="kulachet">üëµ ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå</option>
    <option value="palace_law">üìú ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</option> 
    <option value="affiliation">üå∏ ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏ô‡∏≤‡∏á‡πÉ‡∏ô</option>
</select>

                <div class="relative group">
                    <input type="text" id="tableSearch" oninput="renderTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="pl-10 pr-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary outline-none transition w-64 bg-white shadow-sm">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>
        </div>
                    
            
        
        </div>

                <h2 id="royalChildrenHeader" class="hidden font-royal text-xl text-indigo-700 font-bold mb-4 text-center"></h2>

                <div class="rounded-[20px] shadow-sm border overflow-hidden" style="background: var(--accent-bg); border-color: var(--accent-border);">
                    <div class="table-wrapper"> <table class="w-full text-left">
                            <thead>
                                <tr style="background: var(--bg-dots);">
                                    <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                                    <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
                                    <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div> </div>
            </div>
        </div>
    </main>

  <div id="detailModal" class="modal">
   <div class="modal-content w-full max-w-xl overflow-hidden relative border-4 border-white">
        <button onclick="closeModal('detailModal')" class="absolute top-3 right-3 text-white bg-black/10 rounded-full w-8 h-8 z-20 hover:bg-black/20 backdrop-blur-sm flex items-center justify-center transition">‚úï</button>
        
        <div class="h-48 relative" style="background: linear-gradient(to top right, var(--bg-dots), var(--primary-light));">
            <div class="absolute inset-0 overflow-hidden rounded-t-[20px]">
                <div class="absolute inset-0 opacity-30 mix-blend-overlay bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            </div>
            
            <div class="absolute -bottom-10 left-1/2 -translate-x-1/2 flex flex-col items-center z-10">
                <div class="relative">
                    <img id="d_img" class="w-28 h-28 rounded-full border-[4px] border-white bg-white object-cover shadow-lg aspect-square">
                    <i id="d_crown" class="fa-solid fa-crown absolute -top-6 left-1/2 -translate-x-1/2 text-3xl text-yellow-400 drop-shadow-md hidden filter saturate-150 animate-pulse"></i>
                </div>
            </div>
        </div>

        <div class="pt-14 pb-8 px-6 text-center" style="background: var(--accent-bg);">
            <h3 id="d_name" class="text-lg font-royal font-bold leading-tight mb-1" style="color: var(--text-main);"></h3>

            <div id="d_nickname_container" class="text-indigo-500 font-cute text-sm mb-2 font-semibold">
                (<span id="d_nickname_display"></span>)
            </div>

            <div class="flex justify-center items-center gap-2 mb-3">
                <div class="text-[10px] font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-500 flex items-center gap-1 cursor-pointer hover:bg-gray-200 transition" onclick="copyToClipboard(window.curPID)">
                    <span id="d_id"></span> <i class="fa-regular fa-copy"></i>
                </div>
            </div>
            
            <p id="d_krom" class="text-xs font-bold text-amber-600 bg-amber-50 inline-block px-4 py-1.5 rounded-xl mb-4 border border-amber-200 shadow-sm hidden"></p>
   
            <div id="d_spouse_tag" class="bg-pink-100 text-pink-700 text-[10px] font-bold px-3 py-1 rounded-full mb-4 inline-block hidden shadow-sm border border-pink-200 animate-fade-in"></div>

            <div id="d_badges" class="flex flex-wrap justify-center gap-2 mb-4"></div>

            <div class="grid grid-cols-1 gap-2 mb-4">
                <div id="restoreRankArea" class="hidden">
                    <button onclick="restoreRoyalRankAction()" class="w-full py-2.5 bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-600 text-white rounded-xl text-xs font-bold shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 mb-1">
                        <i class="fa-solid fa-crown"></i> ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏û‡∏£‡∏∞‡∏¢‡∏®
                    </button>
                </div>

                <button onclick="setAsRoot(window.curPID)" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-sitemap"></i> ‡∏î‡∏π‡∏ú‡∏±‡∏á‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏•‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openSpouseSelectionModal(window.curPID)" class="py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-heart"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™
                    </button>
                    <button onclick="openAddChildModal(window.curPID)" class="py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-baby"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å
                    </button>
                </div>
                <button onclick="showHistoryModal(window.curPID)" class="w-full py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2 mb-2">
                    <i class="fa-solid fa-scroll"></i> ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
                </button>
               <button id="btnManageParents" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
               <i class="fa-solid fa-arrow-up"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤/‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤
               </button>
            </div>

            <div id="d_statusBox" class="text-left text-sm space-y-2 p-4 rounded-3xl border shadow-inner mb-4" style="background: var(--bg-main); border-color: var(--accent-border);"> 
                
                <div id="d_kromFullNameRow" class="flex flex-col items-start border-b border-slate-100 pb-2 mb-2 hidden">
                    <span class="text-xs text-slate-400 shrink-0 mb-1">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡∏Å‡∏£‡∏°</span>
                    <span id="d_kromFullName" class="font-bold text-red-600 text-left text-sm leading-relaxed"></span>
                </div>
                
                <div id="d_generationRankRow" class="flex justify-between border-b border-slate-100 pb-2 mb-2 hidden">
                    <span class="text-xs text-slate-400 shrink-0">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</span>
                    <span id="d_generationRank" class="font-bold text-indigo-700 text-right text-xs"></span>
                </div>
                
                <div id="d_informalNameRow" class="flex flex-col border-b border-slate-100 pb-2 mb-2 hidden">
                      <span class="text-xs text-slate-400 shrink-0 mb-1">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ô‡∏≤‡∏°‡∏•‡∏≥‡∏•‡∏≠‡∏á</span>
                        <div id="d_informalNamesDisplay" class="flex flex-wrap gap-1"></div>
                     </div>


               <div id="d_originalRankRow" class="flex justify-between border-b border-slate-100 pb-2 mb-2 hidden">
              <span class="text-xs text-slate-400 shrink-0">‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏°</span>
             <span id="d_originalRank" class="font-bold text-blue-600 text-right text-xs"></span>
            </div>


                               <div id="d_ageRow" class="flex justify-between">
              <span class="text-xs text-slate-400">‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏≤‡∏¢‡∏∏ / ‡∏≠‡∏≤‡∏¢‡∏∏</span>
            <span id="d_currentAge" class="font-bold text-rose-600"></span>
               </div>
                
                <div class="flex justify-between"><span class="text-xs text-slate-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span id="d_status" class="font-bold"></span></div>
                
                <div class="flex justify-between">
                    <span class="text-xs text-slate-400">‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®</span>
                    <span id="d_royalRankDetail" class="font-bold text-indigo-600"></span>
                </div>
<div id="row_original_surname" class="flex justify-between border-t border-slate-50 pt-1 mt-1 hidden">
    <span id="label_original_surname" class="text-xs text-slate-400">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°</span>
    <span id="d_originalSurname" class="font-bold text-pink-600"></span>
</div>

<div id="row_married_surname" class="flex justify-between border-t border-slate-50 pt-1 mt-1 hidden">
    <span id="label_married_surname" class="text-xs text-slate-400">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™</span>
    <span id="d_marriedSurname" class="font-bold text-indigo-600"></span>
</div>


               <div id="row_affiliation" class="flex justify-between border-t border-slate-50 pt-1 mt-1 hidden">
    <span class="text-xs text-slate-400">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</span>
    <span id="d_affiliationName" class="font-bold text-pink-600"></span>
</div>

<div class="flex justify-between">
    <span class="text-xs text-slate-400">‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥ (‡∏û.‡∏®.)</span>
    <span id="d_birthYear"></span>
</div>

<div id="row_royal_surname" class="flex justify-between hidden">
    <span class="text-xs text-slate-400">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</span>
    <span id="d_royalSurname" class="font-bold text-indigo-600"></span>
</div>

<div class="flex justify-between border-b border-slate-50 pb-2">
    <span class="text-xs text-slate-400">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</span>
    <span id="d_spouses_count"></span>
</div>

<div id="d_children_row" class="flex justify-between items-start hidden">
    <span class="text-xs text-slate-400 mt-1">‡∏ö‡∏∏‡∏ï‡∏£ / ‡∏ò‡∏¥‡∏î‡∏≤</span>
    <div id="d_children_list" class="text-right flex flex-col gap-0.5"></div>
</div>

<div id="row_umbrella" class="flex justify-between border-t border-slate-50 pt-2 hidden">
    <span class="text-xs text-slate-400">‡∏â‡∏±‡∏ï‡∏£</span>
    <span id="d_umbrella"></span></div>
</div>

            <div class="flex gap-2 justify-center border-t pt-4 border-slate-100">
                <button onclick="editCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fa-solid fa-pen"></i></button>
                <button onclick="toggleResignation(window.curPID)" id="btnResign" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-slate-500 hover:text-red-500 transition-all" title="‡∏ñ‡∏≠‡∏î/‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå">
                    <i class="fa-solid fa-user-slash"></i>
                </button>
                <button onclick="promoteMomChao()" id="btnPromoteMC" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-amber-500 hidden" title="‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤">
                    <i class="fa-solid fa-medal"></i>
                </button>
                <button onclick="promoteNobilityRank()" id="btnPromoteNobility" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-blue-600 hidden" title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á">
                    <i class="fa-solid fa-arrow-up-right-dots"></i>
                </button>
                <button onclick="abdicateCurrent()" id="btnAbdicate" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-purple-600 hover:text-purple-700 hidden" title="‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥">
                    <i class="fa-solid fa-person-walking-arrow-right"></i>
                </button>
                <button onclick="toggleDeath()" id="btnDeath" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û"><i class="fa-solid fa-skull"></i></button>
                <button onclick="deleteCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-red-400" title="‡∏•‡∏ö"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="personModal" class="modal">
    <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center p-5 border-b" style="background: var(--bg-dots);">
            <h2 id="modalTitle" class="font-cute font-bold text-lg"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
            <button onclick="closeModal('personModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar flex-1" style="background: var(--accent-bg);">
            <form id="personForm" onsubmit="handleSavePerson(event)" class="space-y-6">
                <input type="hidden" id="p_isEditMode">
                <div class="flex gap-8 flex-col md:flex-row">
                    <div class="flex-shrink-0 flex flex-col items-center gap-3">
                        <div class="w-36 h-36 rounded-full border-4 flex items-center justify-center overflow-hidden relative group cursor-pointer transition shadow-sm" style="background: var(--bg-dots);" onclick="document.getElementById('p_imageFile').click()">
                            <img id="p_imagePreview" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white transition backdrop-blur-sm"><i class="fa-solid fa-camera text-2xl"></i></div>
                        </div>
                        <input type="file" id="p_imageFile" accept="image/*" class="hidden" onchange="handleImageUpload(this)"><input type="hidden" id="p_imageFinal">
                        <div class="flex gap-2">
                            <label class="cursor-pointer bg-blue-50 text-blue-500 px-4 py-1.5 rounded-full text-xs font-bold border border-blue-100 peer-checked:bg-blue-400 peer-checked:text-white transition">
                                <input type="radio" name="gender" value="M" checked class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();updateRoyalRelationshipByGender(); toggleTaoVisibility();"> ‡∏ä‡∏≤‡∏¢
                            </label>
                            <label class="cursor-pointer bg-pink-50 text-pink-500 px-4 py-1.5 rounded-full text-xs font-bold border border-pink-100 peer-checked:bg-pink-400 peer-checked:text-white transition">
                                <input type="radio" name="gender" value="F" class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();updateRoyalRelationshipByGender(); toggleTaoVisibility();"> ‡∏´‡∏ç‡∏¥‡∏á
                            </label>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                            <input type="checkbox" id="p_isAlive" checked class="accent-emerald-500 rounded" onchange="calculateLivingAge()"> <span class="text-xs text-emerald-600 font-bold">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà</span>
                        </label>

                        <div id="deathAgeContainer" class="mt-2 w-full">
                            <label class="text-[10px] font-bold text-slate-400 block mb-1 ml-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢ (‡∏õ‡∏µ)</label>
                            <input type="number" id="p_deathAge" min="1" max="200" placeholder="‡πÄ‡∏ä‡πà‡∏ô 80"
                                class="w-full text-xs p-2 rounded-xl border border-slate-200 outline-none focus:border-indigo-400 bg-white">
                        </div>
                    </div>

                    <div class="flex-1 space-y-4">
                        <div class="flex gap-2 items-end bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-slate-500">ID (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                                <input type="text" id="p_id" readonly class="w-full text-sm font-mono bg-transparent border-none focus:ring-0 text-slate-600">
                            </div>
                            <button type="button" onclick="copyToClipboard(document.getElementById('p_id').value)" class="p-1.5 text-xs bg-white border rounded shadow-sm hover:bg-slate-50">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                        </div>
                        <div class="p-4 rounded-[25px] border grid grid-cols-1 md:grid-cols-2 gap-4" style="background: var(--bg-dots);">
                            <div>
                                <label class="text-xs font-bold text-indigo-400 mb-1 block ml-2">‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤</label>
                                <div class="flex gap-1 relative">
                                    <input type="text" id="p_fatherSearch" list="fatherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID/‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateParent('father')">
                                    <datalist id="fatherOptions"></datalist><input type="hidden" id="p_fatherId">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-pink-400 mb-1 block ml-2">‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤</label>
                                <div class="flex gap-1 relative">
                                    <input type="text" id="p_motherSearch" list="motherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID/‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateParent('mother')">
                                    <datalist id="motherOptions"></datalist><input type="hidden" id="p_motherId">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-12 md:col-span-3">
                                <label class="text-xs ml-2 text-slate-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label>
                                <select id="p_relationship" class="w-full text-sm input-theme" onchange="updatePrefixOptions(); checkQueenConsortEligible(); toggleTaoVisibility()"></select>
                            </div>

                            <div class="col-span-12 md:col-span-12 flex flex-col gap-2 p-3 rounded-xl border border-amber-100 bg-amber-50/50 hidden" id="taoCheckboxContainer">
                                <div class="flex items-center gap-2">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="p_isTao" onchange="toggleTaoInput(); toggleAffiliationInput();">
                                        <span class="text-sm font-bold text-amber-800">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß" </span>
                                    </label>
                                </div>
                                <div id="taoInputSection" class="hidden pl-6">
                                    <label class="text-xs text-amber-600 font-bold mb-1 block">‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏° </label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-bold text-amber-700">‡∏ó‡πâ‡∏≤‡∏ß</span>
                                        <input type="text" id="p_taoTitle" class="flex-1 text-sm input-theme border-amber-200 bg-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏£‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå, ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏≤">
                                    </div>
                                </div>
                            </div>

                            <div class="col-span-12 md:col-span-5">
                                <label class="text-xs ml-2 text-slate-400">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                                <select id="p_titlePrefix" class="w-full text-sm input-theme" onchange="updateSuffixOptions(); toggleAffiliationInput()"></select>
                            </div>

                            <div class="col-span-12 hidden animate-fade-in" id="consortAffiliationContainer">
                                <div class="p-3 rounded-xl border border-pink-100 bg-pink-50/30">
                                    <label class="text-xs font-bold text-pink-600 mb-1 block">
                                        <i class="fa-solid fa-users-rectangle mr-1"></i>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î 
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="p_affiliationSearch" list="affiliationOptions" 
                                            class="w-full text-sm input-theme border-pink-200 focus:border-pink-400 bg-white pl-9" 
                                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á..."
                                            onchange="handleAffiliationSelect(this)">
                                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-pink-300 text-xs"></i>
                                        <datalist id="affiliationOptions"></datalist>
                                        <input type="hidden" id="p_affiliationId">
                                    </div>
                                    <p class="text-[10px] text-pink-400 mt-1 pl-2">
                                        * ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå, ‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤, ‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á, ‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤, ‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤ (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà)
                                    </p>
                                </div>
                            </div>
                            <div class="col-span-12 md:col-span-4 hidden" id="nobilityTitleContainer">
                                <label class="text-xs ml-2 text-indigo-500 font-bold">‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°)</label>
                                <input type="text" id="p_nobilityTitle" class="w-full text-sm input-theme border-indigo-200" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Å‡∏©‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ">
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="text-xs ml-2 text-slate-400">‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®</label>
                                <select id="p_royalRank" class="w-full text-sm input-theme" onchange="updateAutoId(); toggleSurnameFields(); toggleKrom(); toggleTaoVisibility();">
                                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)</option>

                                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)</option>
                                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)</option>
                                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)</option>
                                    <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)</option>
                                    <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)</option>
                                    <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)</option>
                                    <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤">‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤</option>
                                    <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå">‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå</option>
                                    <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á">‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á</option>
                                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä">‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</option>
                                    <option value="‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô">‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô</option>
                                </select>

                            </div>
                        </div>

                        <div class="col-span-12">
                            <label class="flex items-center gap-2 cursor-pointer ml-2">
                                <input type="checkbox" id="p_hideRoyalRank" class="accent-slate-500 rounded">
                                <span class="text-xs text-slate-500">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="p_isRankLocked" class="accent-indigo-500 rounded">
                                <span class="text-xs text-indigo-600 font-bold">‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-6 md:col-span-4">
                                <label class="text-xs font-bold ml-2 text-primary">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ä‡∏∑‡πà‡∏≠ *</label>
                                <input type="text" id="p_name" required class="w-full font-bold input-theme">
                            </div>
                            <div class="col-span-6 md:col-span-4">
                                <label class="text-xs ml-2 text-slate-400">‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</label>
                                <select id="p_titleSuffix" class="w-full text-sm input-theme"></select>
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="text-xs ml-2 text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                <input type="text" id="p_nickname" class="w-full text-sm input-theme">
                            </div>
                        </div>

                        <div class="col-span-12 md:col-span-8">
                            <label class="text-xs ml-2 text-slate-400">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ô‡∏≤‡∏°‡∏•‡∏≥‡∏•‡∏≠‡∏á (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ , ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)</label>
                            <input type="text" id="p_informalName" class="w-full text-sm input-theme" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå, ‡πÇ‡∏¢‡∏ò‡∏µ, ‡∏Ç‡∏∏‡∏ô‡πÅ‡∏ú‡∏ô">
                        </div>

                        <div class="col-span-12 space-y-3 p-3 rounded-xl border border-slate-100 bg-white shadow-sm">
                            <div class="flex justify-between items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="p_isSurnameFounder" class="accent-indigo-500 rounded" onchange="toggleSurnameFields()">
                                    <span class="text-sm font-bold text-indigo-600">‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•?</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-500">
                                    <input type="checkbox" id="p_hideSurname" class="accent-slate-500 rounded"> ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                                </label>
                            </div>
                            <div id="royalSurnameFounderPanel" class="hidden">
                                <label class="text-xs ml-2 text-slate-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠)</label>
                                <input type="text" id="p_royalSurnameInput" class="w-full text-sm input-theme font-bold" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•">
                            </div>
                            <div id="commonerSurnamePanel" class="hidden">
                                <label class="text-xs ml-2 text-slate-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)</label>
                                <input type="text" id="p_commonerSurnameInput" class="w-full text-sm input-theme" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ)">
                            </div>
                        </div>
                        <div id="kromFullWrapper" class="col-span-12 md:col-span-6">
                            <label class="text-xs ml-2 text-slate-400">‡∏¢‡∏®‡∏Å‡∏£‡∏° ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏°</label>
                            <div class="flex items-center gap-2">
                                <div class="w-1/3">
                                    <select id="p_kromRank" class="w-full text-sm input-theme" onchange="toggleKrom()">
                                        <option value="">-</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô">‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô">‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á">‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞">‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤">‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤</option>
                                        <option value="‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞">‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <input type="text" id="p_kromTitle" class="w-full text-sm hidden input-theme" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°...">
                                </div>
                            </div>
                        </div>
                        <div class="col-span-12 grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div class="p-3 rounded-2xl border bg-blue-50/30 border-blue-100">
                                <label class="text-[11px] font-bold text-blue-600 mb-2 block"><i class="fa-solid fa-baby-carriage mr-1"></i> ‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥/‡πÄ‡∏Å‡∏¥‡∏î</label>
                                <div class="grid grid-cols-4 gap-1.5">
                                    <select id="p_birthDayOfWeek" class="text-[10px] input-theme p-1">
                                        <option value="">‡∏ß‡∏±‡∏ô</option>
                                        <option>‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                                        <option>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                                        <option>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                                        <option>‡∏û‡∏∏‡∏ò</option>
                                        <option>‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                                        <option>‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                                        <option>‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                                    </select>
                                    <select id="p_birthDay" class="text-[10px] input-theme p-1" onchange="autoCalcDayOfWeek('birth')">
                                        <option value="">‡∏ó‡∏µ‡πà</option>
                                        <script>for(let i=1;i<=31;i++)document.write(`<option value="${i}">${i}</option>`)</script>
                                    </select>
                                    <select id="p_birthMonth" class="text-[10px] input-theme p-1" onchange="autoCalcDayOfWeek('birth')">
                                        <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                        <option value="1">‡∏°.‡∏Ñ.</option>
                                        <option value="2">‡∏Å.‡∏û.</option>
                                        <option value="3">‡∏°‡∏µ.‡∏Ñ.</option>
                                        <option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                        <option value="5">‡∏û.‡∏Ñ.</option>
                                        <option value="6">‡∏°‡∏¥.‡∏¢.</option>
                                        <option value="7">‡∏Å.‡∏Ñ.</option>
                                        <option value="8">‡∏™.‡∏Ñ.</option>
                                        <option value="9">‡∏Å.‡∏¢.</option>
                                        <option value="10">‡∏ï.‡∏Ñ.</option>
                                        <option value="11">‡∏û.‡∏¢.</option>
                                        <option value="12">‡∏ò.‡∏Ñ.</option>
                                    </select>
                                    <input type="text" id="p_birthYear" inputmode="numeric" class="text-[10px] input-theme p-1" placeholder="‡∏û.‡∏®." oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoCalcDayOfWeek('birth'); updateRoyalRelationshipByGender();">
                                </div>
                            </div>
                            <div class="p-3 rounded-2xl border bg-slate-50 border-slate-200">
                                <label class="text-[11px] font-bold text-slate-500 mb-2 block"><i class="fa-solid fa-monument mr-1"></i> ‡∏ß‡∏±‡∏ô‡∏°‡∏£‡∏ì‡∏∞/‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå</label>
                                <div class="grid grid-cols-4 gap-1.5">
                                    <select id="p_deathDayOfWeek" class="text-[10px] input-theme p-1">
                                        <option value="">‡∏ß‡∏±‡∏ô</option>
                                        <option>‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                                        <option>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                                        <option>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                                        <option>‡∏û‡∏∏‡∏ò</option>
                                        <option>‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                                        <option>‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                                        <option>‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                                    </select>
                                    <select id="p_deathDay" class="text-[10px] input-theme p-1" onchange="autoCalcDayOfWeek('death')">
                                        <option value="">‡∏ó‡∏µ‡πà</option>
                                        <script>for(let i=1;i<=31;i++)document.write(`<option value="${i}">${i}</option>`)</script>
                                    </select>
                                    <select id="p_deathMonth" class="text-[10px] input-theme p-1" onchange="autoCalcDayOfWeek('death')">
                                        <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                        <option value="1">‡∏°.‡∏Ñ.</option>
                                        <option value="2">‡∏Å.‡∏û.</option>
                                        <option value="3">‡∏°‡∏µ.‡∏Ñ.</option>
                                        <option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                        <option value="5">‡∏û.‡∏Ñ.</option>
                                        <option value="6">‡∏°‡∏¥.‡∏¢.</option>
                                        <option value="7">‡∏Å.‡∏Ñ.</option>
                                        <option value="8">‡∏™.‡∏Ñ.</option>
                                        <option value="9">‡∏Å.‡∏¢.</option>
                                        <option value="10">‡∏ï.‡∏Ñ.</option>
                                        <option value="11">‡∏û.‡∏¢.</option>
                                        <option value="12">‡∏ò.‡∏Ñ.</option>
                                    </select>
                                    <input type="text" id="p_deathYear" inputmode="numeric" class="text-[10px] input-theme p-1" placeholder="‡∏û.‡∏®." oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoCalcDayOfWeek('death')">
                                </div>
                            </div>
                        </div>
                        <div class="col-span-12 flex justify-end">
                            <div class="text-[11px] font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100">
                                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏: <span id="p_calc_age_display" class="text-sm">-</span> ‡∏õ‡∏µ
                            </div>
                        </div>

                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="p_hasUmbrella" class="accent-amber-500 w-4 h-4" onchange="toggleUmbrella()">
                            <label class="text-sm font-bold text-amber-700">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏â‡∏±‡∏ï‡∏£</label>
                        </div>
                        <select id="p_umbrellaType" class="w-full text-sm input-theme hidden">
                            <option value="‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (3 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                            <option value="‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (5 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                            <option value="‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (7 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                            <option value="‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (9 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                        </select>
                    </div>
                    <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-bold text-rose-400">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</h3>
                            <div class="flex gap-1">
                                <input type="text" id="p_spouseSearch" list="spouseOptions" class="text-xs w-28 rounded-full input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                                <datalist id="spouseOptions"></datalist>
                                <button type="button" onclick="addSpouse()" class="bg-rose-300 text-white w-6 h-6 rounded-full text-xs hover:bg-rose-400">+</button>
                            </div>
                        </div>
                        <ul id="p_spouseList" class="flex flex-wrap gap-2 text-xs"></ul>
                    </div>
                </div>
                <div class="flex flex-wrap gap-4 pt-2 items-center">
                    <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-amber-50 border-amber-100">
                        <input type="checkbox" id="p_isMonarch" class="accent-amber-400 w-4 h-4" onchange="toggleMonarch()">
                        <span class="text-sm font-bold text-amber-600">‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ</span>
                    </label>
                    <div class="flex items-center gap-2 px-4 py-2 rounded-2xl border transition bg-blue-50 border-blue-100">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="p_isHeir" class="accent-blue-400 w-4 h-4" onchange="toggleHeirOrder()">
                            <span class="text-sm font-bold text-blue-600">‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</span>
                        </label>
                        <input type="number" id="p_heirOrder" min="1" placeholder="‡∏•‡∏≥‡∏î‡∏±‡∏ö" class="w-16 text-xs input-theme hidden border-blue-200 text-blue-800 font-bold text-center">
                    </div>
                    <label id="queenConsortOption" class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-pink-50 border-pink-100 hidden">
                        <input type="checkbox" id="p_isQueenConsort" class="accent-pink-400 w-4 h-4">
                        <span class="text-sm font-bold text-pink-600">‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå</span>
                    </label>
                </div>
                <div id="monarchPanel" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-200 grid grid-cols-4 gap-3 animate-fade-in">
                    <div class="col-span-4 flex flex-col md:flex-row gap-2 mb-2 bg-white/50 p-2 rounded-xl">
                        <div class="flex items-center gap-2 flex-1">
                            <input type="checkbox" id="p_useReignName" class="accent-amber-600" onchange="toggleReignName()">
                            <span class="text-xs font-bold text-amber-800">‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</span>
                            <select id="p_reignNameSelect" class="text-xs input-theme hidden flex-1"></select>
                            <span id="p_autoReignNameNumber" class="text-xs font-bold text-amber-600 hidden bg-amber-100 px-2 py-1 rounded"></span>
                        </div>
                        <div class="flex items-center gap-2 border-l pl-2 border-amber-200">
                            <span class="text-xs font-bold text-amber-800">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà :</span>
                            <input type="number" id="p_globalReignNumber" class="w-16 text-xs font-bold text-center input-theme border-amber-300 text-amber-900" min="1">
                        </div>
                    </div>
                    <input type="text" id="p_reignStart" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå (‡∏û.‡∏®.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                    <input type="text" id="p_reignEnd" placeholder="‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û.‡∏®.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                    <input type="text" id="p_eraName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢" class="col-span-2 text-sm bg-white border-amber-100 rounded-lg p-1">
                    <div id="maleMonarchQueenSelect" class="col-span-4 mt-2 pt-2 border-t border-amber-200/50 hidden">
                        <label class="text-xs font-bold text-amber-700 block mb-1">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)</label>
                        <select id="p_queenSelectForKing" class="text-xs input-theme w-full bg-white/80 border-amber-200 text-pink-700 font-bold">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="hidden"></button>
            </form>
        </div>
        <div class="p-4 flex justify-end gap-3 border-t" style="background: var(--accent-bg);">
            <button onclick="closeModal('personModal')" class="px-5 py-2 rounded-full transition text-sm font-bold bg-gray-100 text-gray-500 hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" form="personForm" class="px-8 py-2 btn-theme text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
</div>
    
    <!-- Initial Setup Modal -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content w-full max-w-sm p-8 text-center relative">
            <button onclick="closeModal('initialSetupModal')" class="absolute top-4 right-4 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-2xl font-cute font-bold mb-2" style="color: var(--text-main);">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£</h2>
            <p class="text-sm mb-6" style="color: var(--text-sub);">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="space-y-3">
                <input type="text" id="setupKingdomName" class="w-full input-theme text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£">
                <input type="text" id="setupDynastyName" class="w-full input-theme text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå">
            </div>
            <button onclick="completeInitialSetup()" class="btn-theme w-full mt-6 py-3 text-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢ ‚ú®</button>
        </div>
    </div>

    <!-- Rank & Data Management Modal (Updated HTML with Scores) -->
    <div id="rankManagementModal" class="modal">
    <div class="modal-content rounded-3xl p-0 w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden bg-[#f8fafc]">
        <div class="p-5 bg-white border-b flex justify-between items-center shadow-sm z-10">
            <h2 class="font-cute font-bold text-xl text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏® (‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°)</h2>
            <button onclick="closeModal('rankManagementModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100">‚úï</button>
        </div>

        <div class="flex flex-1 overflow-hidden p-6 gap-4 flex-col lg:flex-row bg-[#f8fafc]">
            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-indigo-600 font-bold"><i class="fa-solid fa-layer-group"></i> 1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="flex gap-2">
                        <input id="nr" class="flex-1 min-w-0 px-3 py-2 rounded-xl border text-sm outline-none focus:ring-2 focus:ring-indigo-400" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addData('rel')" class="bg-indigo-500 text-white w-10 h-10 rounded-xl hover:bg-indigo-600 transition flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <ul id="rl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-pink-600 font-bold"><i class="fa-solid fa-tag"></i> 2. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="space-y-2">
                        <div class="flex gap-1">
                            <input id="np" class="flex-grow min-w-0 px-2 py-2 rounded-xl border text-xs outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠..">
                            <input id="np_score" type="number" class="w-16 shrink-0 px-1 py-2 rounded-xl border text-xs text-center outline-none" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                        </div>
                        <button onclick="addData('pre')" class="w-full bg-pink-500 text-white py-2 rounded-xl font-bold text-xs hover:bg-pink-600 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>
                <ul id="pl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-emerald-600 font-bold"><i class="fa-solid fa-medal"></i> 3. ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="space-y-2">
                        <div class="flex gap-1">
                            <input id="ns" class="flex-grow min-w-0 px-2 py-2 rounded-xl border text-xs outline-none" placeholder="‡∏™‡∏£‡πâ‡∏≠‡∏¢..">
                            <input id="ns_score" type="number" class="w-16 shrink-0 px-1 py-2 rounded-xl border text-xs text-center outline-none" value="0">
                        </div>
                        <button onclick="addData('suf')" class="w-full bg-emerald-500 text-white py-2 rounded-xl font-bold text-xs hover:bg-emerald-600 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>
                <ul id="sl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-amber-50/30 rounded-[2rem] border border-amber-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-amber-600 font-bold"><i class="fa-solid fa-crown"></i> 4. ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</div>
                <div class="p-4 bg-white/50 border-b">
                    <div class="flex gap-2">
                        <input id="nreign" class="flex-1 min-w-0 px-3 py-2 rounded-xl border border-amber-100 outline-none text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô...">
                        <button onclick="addData('reign')" class="bg-amber-500 text-white w-10 h-10 rounded-xl hover:bg-amber-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <ul id="reignl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>
        </div>
    </div>
</div>

    <!-- Appoint Modal -->
   <div id="appointModal" class="modal">
    <div class="modal-content w-full max-w-md p-6 text-center">
        <h3 class="font-cute text-2xl mb-4 text-amber-600">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</h3>
        <p class="text-[11px] text-slate-400 mb-6 italic">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∑‡∏ö‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå</p>
        
        <div id="appointSelectModal" class="appoint-list-container"></div>
        
        <div class="flex flex-col gap-2 mt-4">
            <button onclick="appointFromModal()" class="btn-theme w-full py-3 shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</button>
            <button onclick="closeModal('appointModal')" class="text-xs text-slate-400 hover:text-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

    <!-- Reign Name Selection Modal -->
    <div id="reignSelectionModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-lg mb-4 text-amber-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</h3>
            <p class="text-xs text-slate-500 mb-4">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà</p>
            <select id="reignSelectionInput" class="input-theme w-full mb-4"></select>
            <button onclick="confirmReignSelection()" class="btn-theme w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>
    
    <!-- Relationship Finder Modal -->
    <div id="relationshipModal" class="modal">
        <div class="modal-content w-full max-w-md p-6 relative">
            <button onclick="closeModal('relationshipModal')" class="absolute top-4 right-4 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-cute font-bold text-xl mb-6 text-center text-primary"><i class="fa-solid fa-users-rays mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h3>
            
            <div class="space-y-4">
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <label class="text-xs font-bold text-indigo-500 mb-1 block">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà 1 (A)</label>
                    <div class="flex gap-2">
                        <div class="w-10 h-10 rounded-full bg-white border-2 border-indigo-200 flex items-center justify-center overflow-hidden">
                            <img id="rel_img_a" src="" class="w-full h-full object-cover opacity-50">
                        </div>
                        <input type="text" id="rel_input_a" list="relOptions" class="flex-1 input-theme text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." onchange="updateRelPreview('a')">
                    </div>
                    <input type="hidden" id="rel_id_a">
                </div>
                
                <div class="flex justify-center -my-2 relative z-10">
                    <div class="bg-white p-2 rounded-full shadow-sm border text-slate-400 text-xs">
                        <i class="fa-solid fa-arrow-down-up"></i>
                    </div>
                </div>

                <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100">
                    <label class="text-xs font-bold text-pink-500 mb-1 block">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà 2 (B)</label>
                    <div class="flex gap-2">
                         <div class="w-10 h-10 rounded-full bg-white border-2 border-pink-200 flex items-center justify-center overflow-hidden">
                            <img id="rel_img_b" src="" class="w-full h-full object-cover opacity-50">
                        </div>
                        <input type="text" id="rel_input_b" list="relOptions" class="flex-1 input-theme text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." onchange="updateRelPreview('b')">
                    </div>
                    <input type="hidden" id="rel_id_b">
                </div>
                
                <datalist id="relOptions"></datalist>
                
                <button onclick="calculateRelationship()" class="btn-theme w-full py-3 mt-2 shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-search mr-2"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Fantasy Celebration Modal -->
    <div id="fantasyModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('fantasyModal')" class="absolute top-2 right-2 text-amber-200 hover:text-white z-20">‚úï</button>
            <div id="fantasyParticles"></div>
            
            <div class="golden-frame">
                <img id="fan_img" src="" class="w-32 h-32 rounded-full object-cover border-4 border-black">
            </div>
            
            <div class="space-y-4 relative z-10">
                <div class="font-royal text-sm text-amber-200 tracking-widest uppercase">‡∏Ç‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£</div>
                <h2 id="fan_name" class="font-royal text-2xl md:text-3xl shimmer-text leading-tight px-4"></h2>
                
                <div class="text-xs text-amber-100/80 font-light mt-4">
                    ‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå <span id="fan_dynasty" class="font-bold text-white"></span> ‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ <span id="fan_kingdom" class="font-bold text-white"></span><br>
                    ‡∏ó‡∏£‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å‡πÄ‡∏™‡∏ß‡∏¢‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥<br>
                    ‡πÄ‡∏õ‡πá‡∏ô <span id="fan_rama" class="font-bold text-lg text-white"></span>
                </div>

                <div class="my-6 h-px w-3/4 mx-auto bg-gradient-to-r from-transparent via-[#d4af37] to-transparent"></div>

                <p class="text-xs md:text-sm text-amber-100 italic leading-relaxed px-4">
                    "‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÄ‡∏î‡∏ä‡∏≤‡∏ô‡∏∏‡∏†‡∏≤‡∏û<br>
                    ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ï‡πâ‡∏ù‡πà‡∏≤‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ò‡∏∏‡∏•‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏ó‡∏£‡∏á‡∏ô‡∏≥‡∏û‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏ú‡∏≤‡∏™‡∏∏‡∏Å<br>
                    ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏û‡∏ö‡∏π‡∏•‡∏¢‡πå ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•‡∏ô‡∏≤‡∏ô"
                </p>

                <div class="font-royal text-xl text-[#ffd700] mt-6 animate-pulse">
                    ‡∏Ç‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏à‡∏£‡∏¥‡∏ç
                </div>
            </div>
        </div>
    </div>
    
    <!-- Spouse Selection Method Modal (NEW) -->
    <div id="spouseSelectionModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 relative overflow-hidden">
            <button onclick="closeModal('spouseSelectionModal')" class="absolute top-3 right-3 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-3 text-pink-500 text-2xl border-2 border-pink-200">
                    <i class="fa-solid fa-heart"></i>
                </div>
                <h3 class="font-cute font-bold text-xl text-slate-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</h3>
                <p class="text-xs text-slate-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>

            <div class="space-y-4">
                <!-- Option 1: Existing Person -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <label class="text-xs font-bold text-slate-500 mb-2 block"><i class="fa-solid fa-users mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <!-- Note: list attribute is bound to eligibleSpouseList -->
                            <input type="text" id="existingSpouseSearch" list="eligibleSpouseList" class="w-full input-theme text-sm pl-8" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateExistingSpouseInput()">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        </div>
                        <input type="hidden" id="selectedExistingSpouseId">
                    </div>
                    <datalist id="eligibleSpouseList"></datalist>
                    <button onclick="confirmLinkExistingSpouse()" class="w-full mt-2 py-2 bg-white border border-pink-200 text-pink-600 font-bold rounded-xl text-xs hover:bg-pink-50 transition shadow-sm">
                        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™
                    </button>
                </div>

                <div class="relative flex py-1 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-300 text-[10px]">‡∏´‡∏£‡∏∑‡∏≠</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <!-- Option 2: New Person -->
                <button onclick="proceedToNewSpouse()" class="w-full py-3 btn-theme flex items-center justify-center gap-2 shadow-lg shadow-pink-100">
                    <i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>
    <!-- End Spouse Selection Method Modal -->

    <div id="historyModal" class="modal">
    <div class="modal-content w-full max-w-md p-6 relative">
        <button onclick="closeModal('historyModal')" class="absolute top-4 right-4 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-cute font-bold text-xl text-center text-slate-700 flex-1">
                <i class="fa-solid fa-history mr-2"></i>‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
            </h3>
            <button id="historyEditBtn" onclick="toggleHistoryEditMode()" class="ml-2 px-2 py-1 rounded text-xs text-blue-500 hover:bg-blue-50 flex items-center gap-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                <i class="fa-solid fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
        </div>
        <div id="historyBatchDeleteBar" class="mb-2 flex items-center gap-2 hidden">
            <button onclick="deleteSelectedHistoryEntries()" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-bold flex items-center gap-1"><i class='fa-solid fa-trash'></i> ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            <span id="historySelectedCount" class="text-xs text-slate-500"></span>
        </div>
        <div id="historyList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"></div>
    </div>
</div>
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <div id="spouseListModal" class="modal">
    <div class="modal-content w-full max-w-sm p-0 overflow-hidden relative border-4 border-indigo-100">
        <div class="p-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
            <h3 id="sl_title" class="font-royal font-bold text-indigo-700"></h3>
            <button onclick="closeModal('spouseListModal')" class="text-indigo-400 hover:text-indigo-600 transition">‚úï</button>
        </div>
        <div id="sl_body" class="max-h-[60vh] overflow-y-auto p-2 space-y-2 bg-white">
            </div>
    </div>
</div>

<script>

// ========== MULTI-SELECT DELETE FOR HISTORY MODAL ===========
let historyEditMode = false;
let selectedHistoryIndexes = [];

function toggleHistoryEditMode() {
    historyEditMode = !historyEditMode;
    selectedHistoryIndexes = [];
    renderHistoryListWithEdit();
}

function renderHistoryListWithEdit() {
    const list = document.getElementById('historyList');
    const batchBar = document.getElementById('historyBatchDeleteBar');
    const selectedCount = document.getElementById('historySelectedCount');
    const editBtn = document.getElementById('historyEditBtn');
    const p = state.members.find(m => m.id === window.curPID);
    if (!p || !p.titleHistory) return;
    list.innerHTML = '';
    if (historyEditMode) {
        batchBar.classList.remove('hidden');
        editBtn.classList.add('bg-blue-100');
    } else {
        batchBar.classList.add('hidden');
        editBtn.classList.remove('bg-blue-100');
    }
    p.titleHistory.forEach((h, index) => {
        const item = document.createElement('div');
        item.className = "relative pl-8 border-l-2 border-slate-100 pb-4 last:pb-0 group flex items-start";
        let checkboxHTML = '';
        if (historyEditMode) {
            checkboxHTML = `<input type="checkbox" class="mr-2 mt-1 accent-blue-500" onchange="toggleSelectHistoryIndex(${index})" ${selectedHistoryIndexes.includes(index) ? 'checked' : ''}>`;
        }
        item.innerHTML = `
            <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-200 border-2 border-white"></div>
            <div class="flex-1 flex items-start">
                ${checkboxHTML}
                <div>
                    <div class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-500 inline-block mb-1">‡∏™‡∏°‡∏±‡∏¢${h.reign}</div>
                    <div class="text-sm font-bold text-slate-700 leading-snug">${h.title}</div>
                </div>
            </div>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all ${historyEditMode ? 'hidden' : ''}">
                <button onclick="openGazetteModal('${p.id}', ${index})" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded-lg" title="‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®">
                    <i class="fa-solid fa-file-signature text-xs"></i>
                </button>
                <button onclick="deleteHistoryEntry('${p.id}', ${index})" class="p-1.5 text-red-300 hover:text-red-500" title="‡∏•‡∏ö">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
            </div>
        `;
        list.appendChild(item);
    });
    if (historyEditMode) {
        selectedCount.textContent = selectedHistoryIndexes.length > 0 ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedHistoryIndexes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
    }
}

function toggleSelectHistoryIndex(idx) {
    const i = selectedHistoryIndexes.indexOf(idx);
    if (i === -1) selectedHistoryIndexes.push(idx);
    else selectedHistoryIndexes.splice(i, 1);
    renderHistoryListWithEdit();
}

function deleteSelectedHistoryEntries() {
    if (selectedHistoryIndexes.length === 0) return;
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
    const p = state.members.find(m => m.id === window.curPID);
    if (!p || !p.titleHistory) return;
    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å index ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ index shift
    selectedHistoryIndexes.sort((a,b)=>b-a).forEach(idx => p.titleHistory.splice(idx,1));
    saveState();
    selectedHistoryIndexes = [];
    renderHistoryListWithEdit();
    showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

// ‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á showHistoryModal ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const _showHistoryModal = showHistoryModal;
showHistoryModal = function(id) {
    window.curPID = id;
    historyEditMode = false;
    selectedHistoryIndexes = [];
    renderHistoryListWithEdit();
    document.getElementById('historyModal').classList.add('active');
}


let tableSortableInstance = null;

function getRankBadgeClass(rank) {
    if (!rank) return 'rank-common';
    
    // ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤
    if (rank === '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)') return 'rank-jf-special';
    if (rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) return 'rank-jf-1';
    if (rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)')) return 'rank-jf-2';
    if (rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)')) return 'rank-jf-3';
    
    // ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
    if (rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) return 'rank-po-1';
    if (rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)')) return 'rank-po-2';
    if (rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)')) return 'rank-po-3';
    
    // ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
    if (rank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) return 'rank-mc';

    // ‡∏¢‡∏®‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≠‡∏á (MR/ML)
    if (rank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå')) return 'rank-royal-mr';
    if (rank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á')) return 'rank-royal-ml';
    
    return 'rank-common';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤)
function initTableSortable() {
    const tbody = document.getElementById('tableBody');
    const filterStatus = document.getElementById('tableFilterStatus').value;

    if (!tbody || filterStatus !== 'precedence') return;

    if (window.tableSortableInstance) window.tableSortableInstance.destroy();

    window.tableSortableInstance = new Sortable(tbody, {
        animation: 300,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag', // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å
        forceFallback: false,
        onEnd: function() {
            const rows = Array.from(tbody.children);
            let startScore = 2000000000;
            
            rows.forEach((row, idx) => {
                const id = row.getAttribute('data-id');
                const member = state.members.find(m => m.id === id);
                if (member) {
                    member.customPrecedence = startScore - idx;
                }
            });

            saveState();
            showToast("‚ú® ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            renderTable(); 
        }
    });
}

// ================= CONFIG & CONSTANTS =================
const DEFAULT_IMG_MALE = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
const DEFAULT_IMG_FEMALE = "https://cdn-icons-png.flaticon.com/512/4128/4128253.png";

const BASE_CONFIG = { nodeWidth: 180, nodeHeight: 100, gapX: 40, gapY: 150, spouseGap: 50 };
const ANCESTOR_CONFIG = { nodeWidth: 160, nodeHeight: 90, gapX: 100, gapY: 150 };
// Added new ranks for MR/ML
const RANK_CODES = { "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)":'1',"‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)":'1', "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)":'2', "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)":'3', "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)":'4', "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)":'5',"‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)":'B', "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤":'6', "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå":'7', "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á":'8', "‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä":'9', "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô":'A' };

// ================= ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï 20 ‡πÅ‡∏ö‡∏ö (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏•‡∏≠‡∏ô‡πÅ‡∏õ‡∏î) =================
const DESTINY_TRAITS = [
    // ==========================================
    // === ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≤‡∏¢ (MALE - 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ===
    // ==========================================
    { 
        gender: 'M', label: "‡∏û‡∏ç‡∏≤‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏´‡πå‡∏Ñ‡∏≥‡∏£‡∏≤‡∏°", effect: "leader", icon: "ü¶Å", color: "text-amber-700", 
        description: "‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏π‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≥‡πÄ‡∏Å‡∏£‡∏á", 
        poem: "‡∏î‡∏ß‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏î‡∏ä‡πÄ‡∏î‡∏ä‡∏≤‡∏ô‡∏∏‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏≥  ‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏Ñ‡πâ‡∏≥‡∏ô‡∏≥‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πÄ‡∏Å‡∏£‡∏¥‡∏Å‡πÑ‡∏Å‡∏£‡∏™‡∏ô\n‡∏î‡∏±‡πà‡∏á‡∏™‡∏µ‡∏´‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏ç‡∏õ‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡∏Å‡∏•  ‡∏Ñ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏¢‡∏ö‡∏®‡∏±‡∏•‡∏¢‡πå‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏Å‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤  ‡∏ó‡∏±‡πà‡∏ß‡∏ô‡∏†‡∏≤‡∏™‡∏¢‡∏ö‡∏à‡∏ö‡∏™‡∏¥‡∏á‡∏Ç‡∏£\n‡πÄ‡∏´‡∏•‡πà‡∏≤‡πÑ‡∏û‡∏£‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™‡πÑ‡∏°‡πà‡∏≠‡∏≤‡∏ß‡∏£‡∏ì‡πå  ‡∏õ‡∏£‡∏∞‡∏ô‡∏°‡∏Å‡∏£‡∏Å‡∏£‡∏≤‡∏ö‡πÑ‡∏´‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡∏õ‡∏≠‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏î‡∏≤‡∏ß‡∏ï‡∏Å‡∏≠‡∏±‡∏ö", effect: "unlucky", icon: "üåë", color: "text-gray-600", 
        description: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô ‡∏°‡∏±‡∏Å‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ", 
        poem: "‡∏î‡∏±‡πà‡∏á‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏°‡∏∑‡∏î‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≥  ‡∏ö‡∏∏‡∏ç‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≥‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏±‡∏ö‡∏™‡∏ô\n‡∏ó‡∏≥‡∏î‡∏µ‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏°‡∏•  ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏î‡∏ó‡∏ô‡∏ù‡πà‡∏≤‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°\n‡πÄ‡∏Ñ‡∏¢‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏î‡∏°‡∏¥‡∏î  ‡∏™‡∏¥‡πâ‡∏ô‡∏°‡∏¥‡πà‡∏á‡∏°‡∏¥‡∏ï‡∏£‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≤‡∏´‡∏ô‡∏µ‡∏´‡∏≤‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ï‡∏Å‡∏≠‡∏±‡∏ö‡∏•‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ö‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏°‡∏≤‡∏™‡∏∏‡∏°‡∏ó‡∏£‡∏ß‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏Ç‡∏∏‡∏ô‡∏®‡∏∂‡∏Å‡πÑ‡∏£‡πâ‡∏û‡πà‡∏≤‡∏¢", effect: "warrior", icon: "‚öîÔ∏è", color: "text-red-700", 
        description: "‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", 
        poem: "‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏ö‡πÄ‡∏•‡∏¥‡∏®‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ  ‡πÇ‡∏•‡∏Å‡∏¢‡πà‡∏≠‡∏°‡∏£‡∏π‡πâ‡∏ô‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ\n‡∏î‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡∏±‡∏î‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÑ‡∏Å‡∏ß‡∏õ‡∏£‡∏≤‡∏ö‡πÑ‡∏û‡∏£‡∏µ  ‡∏õ‡∏ê‡∏û‡∏µ‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡∏Ç‡∏™‡∏á‡∏ö\n‡∏™‡∏∞‡∏ö‡∏±‡∏î‡∏î‡∏≤‡∏ö‡∏õ‡∏£‡∏≤‡∏ö‡∏°‡∏≤‡∏£‡∏ú‡∏•‡∏≤‡∏ç‡πÑ‡∏û‡∏£‡∏µ  ‡∏õ‡∏ê‡∏û‡∏µ‡∏™‡∏∞‡∏ó‡πâ‡∏≤‡∏ô‡∏´‡∏ß‡∏±‡πà‡∏ô‡∏û‡∏£‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß\n‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏≤‡∏ä‡∏≤‡πÑ‡∏ô‡∏¢  ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡πÑ‡∏ß‡πâ‡∏°‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏µ‡∏ß‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏ú‡∏π‡πâ‡∏ô‡∏¥‡∏£‡∏≤‡∏®", effect: "exiled", icon: "üõñ", color: "text-orange-900", 
        description: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏°‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏©‡∏ñ‡∏π‡∏Å‡πÄ‡∏ô‡∏£‡πÄ‡∏ó‡∏®", 
        poem: "‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏•‡πâ‡∏ô‡∏û‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏±‡∏ß‡∏´‡∏°‡∏≠‡∏á  ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á‡∏ä‡∏µ‡∏û‡∏ï‡∏ô‡πÉ‡∏ô‡πÑ‡∏û‡∏£‡∏™‡∏±‡∏ì‡∏ë‡πå\n‡∏ñ‡∏π‡∏Å‡πÄ‡∏ô‡∏£‡πÄ‡∏ó‡∏®‡∏û‡∏£‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡∏ñ‡∏¥‡πà‡∏ô‡∏•‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå  ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏á‡∏≤‡∏´‡∏á‡∏≠‡∏¢‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡∏≤‡∏¢\n‡∏ï‡∏≥‡∏£‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°  ‡πÉ‡∏à‡∏¢‡∏≠‡∏°‡∏ô‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏û‡∏£‡πà‡∏´‡∏•‡∏≤‡∏¢\n‡∏£‡∏≠‡∏ß‡∏±‡∏ô‡∏ü‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏¢‡∏≤‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°" 
    },
    { 
        gender: 'M', label: "‡∏°‡∏´‡∏≤‡πÄ‡∏™‡∏ô‡∏≤‡∏ö‡∏î‡∏µ", effect: "scholar", icon: "üëî", color: "text-blue-800", 
        description: "‡∏°‡∏µ‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", 
        poem: "‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏ß‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡πÄ‡∏•‡∏¥‡∏®  ‡∏ö‡∏∏‡∏ç‡∏Å‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏™‡πà‡∏≠‡∏á\n‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏£‡∏•‡∏≠‡∏á  ‡πÑ‡∏ó‡∏¢‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á‡∏Ñ‡∏á‡∏£‡∏±‡∏ê‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏î‡∏µ\n‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏û‡∏≤‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏°‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Ç‡∏ï  ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏´‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏µ  ‡∏õ‡∏ê‡∏û‡∏µ‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡∏Ç‡πÉ‡∏à" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏£‡∏±‡∏Å", effect: "lonely", icon: "üíî", color: "text-red-400", 
        description: "‡∏°‡∏±‡∏Å‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÄ‡∏™‡∏°‡∏≠", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡πÉ‡∏à‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏£‡πâ‡∏Ñ‡∏π‡πà  ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏î‡πÉ‡∏™\n‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡∏≤‡∏Å‡πá‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏õ  ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏Ç‡∏∑‡πà‡∏ô‡∏Ç‡∏°‡∏£‡∏∞‡∏ó‡∏°‡∏ó‡∏£‡∏ß‡∏á\n‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Ç‡∏≤‡∏£‡∏±‡∏Å‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ô  ‡πÉ‡∏à‡∏£‡πâ‡∏≤‡∏ß‡∏£‡∏≤‡∏ô‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏ô  ‡πÉ‡∏ô‡∏Å‡∏°‡∏•‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤", effect: "leader", icon: "üìø", color: "text-yellow-600", 
        description: "‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏®‡∏û‡∏¥‡∏ò‡∏£‡∏≤‡∏ä‡∏ò‡∏£‡∏£‡∏°", 
        poem: "‡∏¢‡∏∂‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏à‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå  ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏®‡∏≤‡∏™‡∏ô‡πå‡πÅ‡∏ú‡πà‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà\n‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πà‡∏°‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏£‡πà‡∏°‡πÑ‡∏ó‡∏£‡πÉ‡∏ô‡∏ò‡∏≤‡∏ô‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡∏ö‡∏∏‡∏ç‡∏Ñ‡∏á\n‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏ó‡πâ  ‡πÑ‡∏°‡πà‡∏ú‡∏±‡∏ô‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå\n‡πÉ‡∏´‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á  ‡∏™‡∏∑‡∏ö‡∏ß‡∏á‡∏®‡πå‡∏û‡∏á‡∏®‡πå‡∏ï‡∏£‡∏≤‡∏ö‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏≤‡∏ô" 
    },
    { 
        gender: 'M', label: "‡∏Ç‡∏∏‡∏ô‡∏®‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏≤‡∏£", effect: "wounded", icon: "ü¶Ø", color: "text-stone-500", 
        description: "‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", 
        poem: "‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£‡πÉ‡∏ô‡∏®‡∏∂‡∏Å‡∏ô‡∏∂‡∏Å‡πÉ‡∏à‡∏´‡∏≤‡∏¢  ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πâ‡∏≥\n‡∏î‡∏≤‡∏ö‡∏ß‡∏≤‡∏á‡∏•‡∏á‡∏ï‡∏£‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏£‡∏≤‡∏Å‡∏ï‡∏£‡∏≥  ‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∑‡∏≠\n‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÄ‡∏Ñ‡∏¢‡∏£‡∏ö‡∏™‡∏¢‡∏ö‡∏®‡∏∂‡∏Å  ‡πÉ‡∏à‡∏™‡∏∞‡∏≠‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∏‡∏î\n‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î  ‡∏ó‡∏£‡∏∏‡∏î‡∏•‡∏á‡∏ó‡∏£‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏µ‡∏ä‡∏≤" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á", effect: "wealthy", icon: "üíé", color: "text-emerald-600", 
        description: "‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤", 
        poem: "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏´‡∏•‡∏±‡πà‡∏á‡πÑ‡∏´‡∏•‡∏°‡∏≤‡∏î‡∏±‡πà‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™  ‡∏ö‡∏∏‡∏ç‡πÄ‡∏ú‡∏¢‡πÅ‡∏ú‡πà‡∏ó‡∏≤‡∏á‡∏Ñ‡πâ‡∏≤‡∏û‡∏≤‡∏Å‡∏∏‡∏®‡∏•\n‡∏ó‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏•‡πâ‡∏ô‡∏û‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ï‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏î‡∏µ\n‡∏™‡∏≥‡πÄ‡∏†‡∏≤‡∏ó‡∏≠‡∏á‡∏•‡πà‡∏≠‡∏á‡∏•‡∏≠‡∏¢‡πÉ‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£  ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏≤‡∏û‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°\n‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏î‡∏±‡πà‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏ï‡∏¥‡∏°  ‡∏ö‡∏∏‡∏ç‡∏°‡∏≤‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡∏ç‡πà" 
    },
    { 
        gender: 'M', label: "‡∏Ç‡∏≠‡∏ó‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ö‡∏∏‡∏ç", effect: "volatile", icon: "ü•£", color: "text-amber-900", 
        description: "‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏à‡∏ô‡πÅ‡∏ï‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏µ", 
        poem: "‡∏ï‡πâ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏¢‡∏≤‡∏Å‡πÅ‡∏Ñ‡πâ‡∏ô‡πÅ‡∏™‡∏ô‡∏•‡∏≥‡∏ö‡∏≤‡∏Å  ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏ô‡∏û‡∏£‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ù‡∏∑‡∏ô\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏Ç‡∏°‡∏Ç‡∏∑‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ù‡∏∑‡∏ô‡∏°‡∏≤‡∏Å  ‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏†‡∏≤‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÅ‡∏£‡∏á‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏≠‡∏¢\n‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡πà‡∏á  ‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏£‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏à‡∏ô  ‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏î‡∏µ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô" 
    },
    { 
        gender: 'M', label: "‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏´‡∏•‡∏ß‡∏á", effect: "spiritual", icon: "üîÆ", color: "text-purple-700", 
        description: "‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡∏ü‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏§‡∏Å‡∏©‡πå‡∏¢‡∏≤‡∏°", 
        poem: "‡πÄ‡∏ô‡∏ï‡∏£‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏Å‡∏•‡∏´‡πà‡∏≤‡∏á  ‡∏ä‡∏µ‡πâ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏°‡∏á‡∏Ñ‡∏•‡∏û‡πâ‡∏ô‡πÇ‡∏®‡∏Å‡∏®‡∏±‡∏•‡∏¢‡πå\n‡∏£‡∏π‡πâ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏±‡∏î‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô  ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏π‡πà‡∏ò‡∏≤‡∏ô‡∏µ\n‡∏ï‡∏≥‡∏£‡∏≤‡∏ü‡πâ‡∏≤‡∏Å‡∏≤‡∏á‡∏Å‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡πÇ‡∏•‡∏Å  ‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡πÇ‡∏¢‡∏Ñ‡∏û‡πâ‡∏ô‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡∏õ‡∏ê‡∏û‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡πâ‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ä‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡πÇ‡∏ó‡∏©‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á", effect: "exiled", icon: "‚õìÔ∏è", color: "text-red-900", 
        description: "‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏©‡∏≠‡∏≤‡∏ç‡∏≤", 
        poem: "‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏ó‡∏£‡∏∏‡∏î‡∏•‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ï‡∏Å‡∏≠‡∏±‡∏ö‡∏•‡∏±‡∏ö‡πÅ‡∏™‡∏á‡∏™‡πà‡∏≠‡∏á\n‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏ó‡∏ô‡∏à‡∏≥‡∏à‡∏≠‡∏á  ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏ô‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏∏‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏£‡∏∞‡∏ó‡∏°\n‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏≠‡∏±‡∏Ñ‡∏£‡∏ê‡∏≤‡∏ô  ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏Ç‡∏∑‡πà‡∏ô‡∏Ç‡∏°\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå‡∏û‡∏±‡∏á‡∏ó‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏°  ‡∏à‡∏°‡∏£‡∏∞‡∏ó‡∏°‡πÉ‡∏ô‡∏ï‡∏£‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ô‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÄ‡∏≠‡∏Å‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô", effect: "artistic", icon: "üé®", color: "text-orange-500", 
        description: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏á‡∏≤‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏∑‡∏≠", 
        poem: "‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏®‡∏¥‡∏•‡∏õ‡πå‡∏ß‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏®‡∏•‡πâ‡∏≥  ‡∏Ñ‡∏ô‡∏à‡∏î‡∏à‡∏≥‡∏ù‡∏µ‡∏û‡∏£‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡πå‡∏™‡∏ñ‡∏≤‡∏û‡∏£\n‡∏°‡∏£‡∏î‡∏Å‡∏ó‡∏≤‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏ó‡∏Å‡∏•‡∏≠‡∏ô  ‡∏™‡∏ñ‡∏≤‡∏û‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÑ‡∏Å‡∏•\n‡∏ù‡∏≤‡∏Å‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏ú‡∏∑‡∏ô  ‡πÇ‡∏•‡∏Å‡∏´‡∏¢‡∏±‡∏î‡∏¢‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏™\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà  ‡∏£‡πâ‡∏≠‡∏¢‡∏î‡∏ß‡∏á‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡∏£‡∏ì‡∏ô‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏Ñ‡∏ô‡∏Ç‡∏µ‡πâ‡πÇ‡∏£‡∏Ñ", effect: "fragile", icon: "ü§í", color: "text-teal-700", 
        description: "‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏ö‡πà‡∏≠‡∏¢ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏≠‡∏°‡πÅ‡∏´‡πâ‡∏á  ‡πÑ‡∏£‡πâ‡πÄ‡∏£‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏£‡∏á‡∏à‡∏∞‡∏™‡∏π‡πâ‡∏£‡∏π‡πâ‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß\n‡∏ô‡∏≠‡∏ô‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏Ç‡πâ‡∏ö‡∏ô‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏ô‡∏ä‡πâ‡∏≥‡πÉ‡∏à  ‡∏ö‡∏∏‡∏ç‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î‡∏î‡∏±‡πà‡∏á‡∏ñ‡πà‡∏≤‡∏ô‡∏°‡∏≠‡∏î  ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à\n‡∏Å‡∏≤‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏¢‡∏±‡∏á‡∏ä‡∏π‡πÄ‡∏ä‡πá‡∏î  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏±‡∏ô" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤", effect: "warrior", icon: "‚ö°", color: "text-yellow-400", 
        description: "‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à", 
        poem: "‡∏ß‡πà‡∏≠‡∏á‡πÑ‡∏ß‡∏î‡∏±‡πà‡∏á‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤‡∏ü‡∏≤‡∏î‡∏ü‡∏±‡∏ô‡∏®‡∏±‡∏ï‡∏£‡∏π  ‡πÇ‡∏•‡∏Å‡∏¢‡πà‡∏≠‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏®\n‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê  ‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏õ\n‡∏ó‡∏∞‡∏•‡∏ß‡∏á‡∏ó‡∏±‡∏û‡∏ù‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢  ‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏à‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏°‡∏±‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏Ç‡∏à‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÅ‡∏Ñ‡∏ß‡πâ‡∏ô‡πÅ‡∏î‡∏ô‡∏™‡∏¢‡∏≤‡∏°" 
    },
    { 
        gender: 'M', label: "‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡∏∞", effect: "longevity", icon: "üê¢", color: "text-stone-500", 
        description: "‡∏°‡∏µ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏à‡∏ô‡∏ß‡∏±‡∏¢‡∏ä‡∏£‡∏≤", 
        poem: "‡πÅ‡∏°‡πâ‡∏ß‡∏±‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏™‡∏±‡∏á‡∏Ç‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢\n‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πà‡∏°‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏£‡πà‡∏°‡πÑ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô  ‡∏™‡∏ñ‡∏≤‡∏û‡∏£‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏à‡∏ô‡∏´‡∏°‡∏∑‡πà‡∏ô‡∏õ‡∏µ\n‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏∏‡∏à‡∏´‡∏¥‡∏ô  ‡∏ó‡∏±‡πà‡∏ß‡∏ú‡∏∑‡∏ô‡∏î‡∏¥‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ\n‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ  ‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏™‡∏∑‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏ô‡∏¥‡πà‡∏ô‡∏ô‡∏≤‡∏ô" 
    },
    { 
        gender: 'M', label: "‡∏à‡∏≠‡∏°‡πÇ‡∏à‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°", effect: "volatile", icon: "üë§", color: "text-gray-700", 
        description: "‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏•‡∏ß‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏à‡∏ô", 
        poem: "‡πÉ‡∏ô‡πÄ‡∏á‡∏≤‡∏°‡∏∑‡∏î‡∏Ñ‡∏≠‡∏¢‡∏õ‡∏£‡∏≤‡∏ö‡∏ú‡∏π‡πâ‡∏â‡πâ‡∏≠‡∏â‡∏•  ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏ß‡∏á‡∏ä‡∏ô‡∏û‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∏‡∏°‡πÄ‡∏£‡πâ‡∏≤\n‡πÅ‡∏°‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡πÅ‡∏ï‡πà‡πÉ‡∏à‡πÄ‡∏£‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ù‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°\n‡∏õ‡∏•‡πâ‡∏ô‡∏Ñ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏°‡∏≤‡πÄ‡∏à‡∏∑‡∏≠‡∏à‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏¢‡∏≤‡∏Å  ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏´‡∏•‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≥\n‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÉ‡∏à‡∏à‡∏≥  ‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏°‡∏∑‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏î‡πÉ‡∏™" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏µ‡πâ‡∏Ç‡∏•‡∏≤‡∏î", effect: "unlucky", icon: "üê≠", color: "text-yellow-900", 
        description: "‡∏°‡∏±‡∏Å‡∏´‡∏ô‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤", 
        poem: "‡∏¢‡∏≤‡∏°‡∏®‡∏∂‡∏Å‡∏°‡∏≤‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏ô‡∏Å‡∏•‡∏±‡∏ß  ‡∏´‡∏•‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡πÄ‡∏á‡∏≤‡∏°‡∏∑‡∏î‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á\n‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≠‡∏á‡∏î‡∏≠‡∏á  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£\n‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô  ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏î‡∏ó‡∏ô‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏î‡∏π‡∏ñ‡∏π‡∏Å‡∏™‡∏°‡∏±‡∏¢\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏ö‡∏´‡∏ô‡∏µ‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ  ‡πÑ‡∏£‡πâ‡∏ã‡∏∂‡πà‡∏á‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏Å‡∏°‡∏•" 
    },
    { 
        gender: 'M', label: "‡∏û‡∏ç‡∏≤‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏ó‡∏≠‡∏á", effect: "wealthy", icon: "üêâ", color: "text-yellow-500", 
        description: "‡∏ô‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏°‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•", 
        poem: "‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏ó‡∏≠‡∏á‡∏ú‡∏á‡∏≤‡∏î‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™  ‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏•‡∏±‡πà‡∏á‡πÑ‡∏´‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó  ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏ô\n‡∏ô‡∏≥‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î  ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏∏‡∏ç‡∏û‡∏π‡∏ô‡∏Å‡∏∏‡∏®‡∏•\n‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏™‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏°‡∏ì‡∏ë‡∏•  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡∏£‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ô‡∏±‡∏ö‡∏ó‡∏ß‡∏µ" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏ï‡∏Å‡∏¢‡∏≤‡∏Å", effect: "unlucky", icon: "üìâ", color: "text-orange-700", 
        description: "‡πÄ‡∏Ñ‡∏¢‡∏£‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", 
        poem: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏ó‡πà‡∏ß‡∏°‡∏ü‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏•‡∏≤‡∏¢  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏π‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πâ‡∏≥\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πâ‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°  ‡∏ö‡∏∏‡∏ç‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≥‡∏¢‡∏≤‡∏°‡∏ä‡∏£‡∏≤‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏≤‡∏£\n‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó  ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏≤‡∏ñ‡πÑ‡∏£‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏≥‡∏ô‡∏±‡∏Å‡∏ê‡∏≤‡∏ô\n‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏≤‡∏¢‡∏ß‡∏≤‡∏¢‡∏ß‡∏≠‡∏î‡πÉ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏•  ‡∏ó‡∏£‡∏°‡∏≤‡∏ô‡πÉ‡∏à‡∏ï‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" 
    },
    { 
        gender: 'M', label: "‡∏û‡∏ç‡∏≤‡∏ô‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ", effect: "leader", icon: "ü¶Ö", color: "text-amber-800", 
        description: "‡∏°‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏Å‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß", 
        poem: "‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏Ñ‡∏°‡∏î‡∏±‡πà‡∏á‡∏ô‡∏Å‡∏ö‡∏ô‡∏ô‡∏†‡∏≤  ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏•‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà\n‡πÇ‡∏â‡∏ö‡πÄ‡∏â‡∏µ‡πà‡∏¢‡∏ß‡∏Ñ‡∏ß‡πâ‡∏≤‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏£‡∏π‡πâ  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏ß‡∏•‡∏ß‡∏¥‡∏°‡∏≤‡∏ô\n‡∏°‡∏≠‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡∏Å‡∏•‡∏•‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏´‡πå‡∏£‡πâ‡∏≤‡∏¢  ‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏ô‡∏Ñ‡∏•‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≤‡∏¢‡∏ê‡∏≤‡∏ô\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏¥‡∏°‡∏≤‡∏ô  ‡∏Å‡∏≤‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏µ‡∏ä‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏û‡∏ç‡∏≤‡∏Ñ‡∏ä‡∏™‡∏≤‡∏£", effect: "warrior", icon: "üêò", color: "text-gray-600", 
        description: "‡∏û‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á", 
        poem: "‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏î‡∏±‡πà‡∏á‡∏û‡∏•‡∏≤‡∏¢‡∏á‡∏≤‡∏°‡∏¢‡∏≤‡∏°‡∏®‡∏∂‡∏Å‡πÉ‡∏´‡∏ç‡πà  ‡∏Å‡πâ‡∏≤‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß\n‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏û‡∏á‡∏®‡πå‡πÄ‡∏ú‡πà‡∏≤‡πÑ‡∏Å‡∏•  ‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πâ‡∏≠‡∏°‡∏°‡∏∑‡∏≠\n‡∏û‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≤  ‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏™‡∏ï‡∏£‡∏≤‡πÑ‡∏û‡∏£‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∑‡∏≠\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏∑‡∏≠  ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏π‡∏ó‡∏±‡πà‡∏ß‡∏ò‡∏≤‡∏ô‡∏µ" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏≤‡πÄ‡∏õ‡πã‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ", effect: "warrior", icon: "ü¶µ", color: "text-orange-900", 
        description: "‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡πÉ‡∏à‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ", 
        poem: "‡πÅ‡∏°‡πâ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏¢‡∏±‡∏á‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ô‡∏û‡∏≤‡∏û‡πâ‡∏ô‡∏Ñ‡∏≥‡∏î‡∏π‡∏´‡∏°‡∏¥‡πà‡∏ô\n‡πÉ‡∏ä‡πâ‡∏™‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏á‡∏à‡∏¥‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏™‡∏π‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï\n‡∏Å‡πâ‡∏≤‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ú‡∏¥‡∏î\n‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏¥‡∏°‡∏¥‡∏ï  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏™‡∏ñ‡∏¥‡∏ï‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏≤‡∏£" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏à‡∏≠‡∏°‡∏Å‡∏∞‡∏•‡πà‡∏≠‡∏ô", effect: "volatile", icon: "üé≠", color: "text-purple-400", 
        description: "‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î‡πÄ‡∏Å‡πà‡∏á‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à‡∏¢‡∏≤‡∏Å", 
        poem: "‡∏ß‡∏≤‡∏à‡∏≤‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•‡πÄ‡∏õ‡∏µ‡πà‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡πà‡∏´‡πå‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°  ‡πÉ‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏µ‡πà‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏±‡∏à‡∏à‡∏∞‡∏°‡∏∏‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢\n‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏µ‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏£‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πâ\n‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡∏£‡∏°‡∏Ñ‡∏°‡∏Ñ‡∏≤‡∏¢‡∏´‡∏•‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏Ñ‡∏ô  ‡∏´‡∏ß‡∏±‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏£‡πÅ‡∏Å‡πâ\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏à‡∏∂‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏à‡∏≠‡∏°‡∏õ‡∏•‡∏≠‡∏°‡πÅ‡∏û‡πâ  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ó‡πâ‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏±‡∏ô" 
    },
    { 
        gender: 'M', label: "‡∏ï‡∏∏‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ò‡∏£‡∏£‡∏°", effect: "leader", icon: "‚öñÔ∏è", color: "text-slate-600", 
        description: "‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ò‡∏£‡∏£‡∏°", 
        poem: "‡∏Ñ‡∏£‡∏≤‡∏ä‡∏±‡πà‡∏á‡∏ï‡∏ß‡∏á‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á  ‡πÑ‡∏£‡πâ‡∏™‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏á‡∏≠‡∏Ñ‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏ó‡∏≤‡∏á  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏à‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢\n‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à  ‡πÉ‡∏à‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏î‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏î‡∏™‡∏≤‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏≥‡∏ó‡∏≥‡∏•‡∏≤‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏ß‡∏£‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏ó‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏ó‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡∏ó‡∏±‡∏û", effect: "unlucky", icon: "üèÉ", color: "text-red-500", 
        description: "‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏•‡πà‡∏≤", 
        poem: "‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß  ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡∏±‡∏ß‡∏´‡∏°‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô‡πÉ‡∏ô‡∏û‡∏á‡∏õ‡πà‡∏≤\n‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏ü‡πâ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ï‡∏Å‡∏≠‡∏±‡∏ö‡∏•‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡∏î‡∏µ\n‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏î‡∏£‡∏∞‡πÅ‡∏ß‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏®‡∏Å  ‡πÉ‡∏à‡∏™‡∏∞‡∏ó‡∏Å‡∏™‡∏∞‡∏ó‡πâ‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà\n‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏ô‡∏µ‡∏†‡∏±‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤‡πÑ‡∏õ‡∏à‡∏ô‡∏ï‡∏≤‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏Å‡∏ß‡∏µ‡πÄ‡∏≠‡∏Å‡∏£‡∏±‡∏ï‡∏ô‡πÇ‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡πå", effect: "artistic", icon: "üñãÔ∏è", color: "text-pink-400", 
        description: "‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤", 
        poem: "‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡πå  ‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏ñ‡∏¥‡πà‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤\n‡∏ù‡∏≤‡∏Å‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°‡∏•‡πâ‡∏≥‡πÄ‡∏•‡∏¥‡∏®‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏£‡∏µ‡∏ä‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Å‡∏ß‡∏µ‡πÄ‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£\n‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÇ‡∏•‡∏Å‡∏≠‡πà‡∏≤‡∏ô  ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏≤‡∏ô‡πÉ‡∏ô‡∏ö‡∏ó‡∏Å‡∏•‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏¢\n‡∏°‡∏£‡∏î‡∏Å‡∏ó‡∏≤‡∏á‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏à‡∏≤‡∏á‡πÑ‡∏õ  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÄ‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏†‡∏≤", effect: "wealthy", icon: "üö¢", color: "text-cyan-700", 
        description: "‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏î‡∏ô", 
        poem: "‡∏™‡∏≥‡πÄ‡∏†‡∏≤‡∏ó‡∏≠‡∏á‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏™‡∏°‡∏∏‡∏ó‡∏£  ‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∏‡∏î‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ö‡πâ‡∏≤‡∏ô\n‡∏Å‡∏≥‡πÑ‡∏£‡∏û‡∏π‡∏ô‡∏ó‡∏ß‡∏µ‡∏ó‡∏±‡πà‡∏ß‡∏°‡∏ß‡∏•‡∏ß‡∏¥‡∏°‡∏≤‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏á\n‡∏Ç‡πâ‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏•‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÇ‡∏û‡πâ‡∏ô  ‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÇ‡∏î‡∏ô‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå\n‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏≥‡∏£‡∏á  ‡∏û‡∏á‡∏®‡πå‡πÄ‡∏ú‡πà‡∏≤‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏°‡∏ì‡∏ë‡∏•" 
    },
    { 
        gender: 'M', label: "‡∏à‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏ô‡πÑ‡∏ñ", effect: "clever", icon: "üåæ", color: "text-amber-900", 
        description: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢", 
        poem: "‡πÅ‡∏°‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏õ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏£‡πà‡πÉ‡∏à‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå  ‡∏ò‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á\n‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏à‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏à‡πà‡∏≤‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏á  ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ñ‡∏ß‡∏°‡∏≤‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ\n‡πÑ‡∏°‡πà‡∏ó‡∏∞‡πÄ‡∏¢‡∏≠‡∏ó‡∏∞‡∏¢‡∏≤‡∏ô‡πÉ‡∏ô‡∏•‡∏≤‡∏†‡∏¢‡∏®  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏™‡∏π‡πâ\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏õ‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡∏£‡∏π‡πâ  ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô‡∏≠‡∏≤‡∏†‡∏±‡∏û", effect: "unlucky", icon: "ü•Ä", color: "text-red-300", 
        description: "‡∏à‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏¢‡∏´‡∏ô‡∏∏‡πà‡∏°", 
        poem: "‡∏î‡∏±‡πà‡∏á‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á‡πÇ‡∏£‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏ö‡∏≤‡∏ô  ‡πÉ‡∏ô‡∏Å‡∏≤‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏î‡∏™‡∏≤‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏•‡∏≤‡∏¢  ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏¢‡∏ä‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°\n‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏¥‡∏ï‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏û‡πâ‡∏ô  ‡πÉ‡∏ô‡∏Å‡∏°‡∏•‡∏Ç‡∏°‡∏Ç‡∏∑‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏û‡∏£‡∏£‡∏ì‡∏≤‡∏°\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏°  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏û‡πÄ‡∏ô‡∏à‡∏£‡∏ï‡∏≤‡∏ö‡∏≠‡∏î", effect: "lonely", icon: "ü¶Ø", color: "text-blue-900", 
        description: "‡πÑ‡∏£‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡πà‡∏≠‡∏ô‡πÄ‡∏£‡πà", 
        poem: "‡πÇ‡∏•‡∏Å‡∏°‡∏∑‡∏î‡∏°‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡πâ‡∏≤‡∏ß‡πÄ‡∏î‡∏¥‡∏ô  ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ú‡∏ä‡∏¥‡∏ç‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡πÄ‡∏û‡∏®\n‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏≠‡∏ô‡πÄ‡∏£‡πà‡πÑ‡∏£‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ô‡∏¥‡πÄ‡∏ß‡∏®  ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏û‡∏á‡∏û‡∏µ\n‡πÑ‡∏£‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡πÄ‡∏í‡πà‡∏≤  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏∂‡∏°‡πÄ‡∏ã‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏≠‡∏≤‡∏†‡∏±‡∏û‡πÑ‡∏£‡πâ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤  ‡∏≠‡∏ô‡∏≤‡∏ñ‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤", effect: "healer", icon: "üçÉ", color: "text-emerald-500", 
        description: "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏†‡∏±‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•", 
        poem: "‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏≠‡∏™‡∏ñ‡∏ó‡∏¥‡∏û‡∏¢‡πå‡πÄ‡∏•‡∏¥‡∏®‡∏û‡πâ‡∏ô‡πÇ‡∏£‡∏Ñ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡∏∏‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà\n‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡πâ‡∏≥‡∏ó‡∏£‡∏ß‡∏á‡πÉ‡∏ô  ‡πÉ‡∏´‡πâ‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤\n‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡∏ä‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏•‡∏∂‡∏Å  ‡∏õ‡∏•‡∏∏‡∏Å‡∏™‡∏≥‡∏ô‡∏∂‡∏Å‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏°‡∏£‡∏ì‡∏≤\n‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤‡∏Ñ‡πà‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏´‡∏°‡∏≠‡πÄ‡∏ó‡∏ß‡∏î‡∏≤‡∏Ñ‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÉ‡∏´‡∏°‡πà", effect: "traveler", icon: "üß≠", color: "text-yellow-800", 
        description: "‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡πÜ", 
        poem: "‡∏ö‡∏∏‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß\n‡∏û‡∏ö‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÅ‡∏î‡∏ô‡πÑ‡∏Å‡∏•  ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•\n‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏¥‡∏î‡∏â‡∏≤‡∏¢‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏™‡∏á‡∏à‡∏≥‡∏£‡∏π‡∏ç  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡∏≠‡∏±‡∏°‡∏û‡∏£" 
    },
    { 
        gender: 'M', label: "‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏≤‡∏•", effect: "guardian", icon: "üåô", color: "text-gray-900", 
        description: "‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î", 
        poem: "‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î‡∏°‡∏µ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏≠‡∏¢‡πÄ‡∏ù‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà  ‡πÇ‡∏•‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÅ‡∏ï‡πà‡πÉ‡∏à‡πÄ‡∏£‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏±‡πà‡∏ô\n‡∏õ‡∏£‡∏≤‡∏ö‡πÇ‡∏à‡∏£‡∏†‡∏±‡∏¢‡∏£‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏à‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡∏±‡∏ì‡∏ë‡πå  ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢\n‡∏õ‡∏¥‡∏î‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏û‡∏£‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏≠‡∏Å  ‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏Å‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô  ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ù‡∏±‡∏ô‡∏î‡∏µ‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏Å‡∏ß‡∏µ‡∏û‡πÄ‡∏ô‡∏à‡∏£", effect: "artistic", icon: "üéª", color: "text-rose-700", 
        description: "‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏ß‡∏µ‡∏Ç‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏°‡πÇ‡∏•‡∏Å", 
        poem: "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡∏û‡∏£‡∏¥‡πâ‡∏ß‡πÑ‡∏´‡∏ß‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏•‡∏°  ‡∏Ñ‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≠‡∏á‡∏®‡∏¥‡∏•‡∏õ‡πå\n‡∏û‡πÄ‡∏ô‡∏à‡∏£‡πÑ‡∏õ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏£‡∏µ\n‡∏Ç‡∏±‡∏ö‡∏Ç‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÄ‡∏Ñ‡∏•‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤  ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ\n‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡∏û‡∏≤‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå  ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏†‡∏±‡∏¢‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏¢‡∏´‡∏ô‡∏µ" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡∏û‡∏£‡∏ï‡∏ú‡∏π‡πâ‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©", effect: "hermit", icon: "üßò", color: "text-stone-600", 
        description: "‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡πÇ‡∏•‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏±‡∏à‡∏ò‡∏£‡∏£‡∏°", 
        poem: "‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡πÇ‡∏•‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏∞  ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏á‡∏ö\n‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πà‡∏á‡πÅ‡∏¢‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏û‡∏ö  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á‡∏ô‡∏ö‡∏Ñ‡∏∑‡∏≠‡∏•‡∏≤‡∏†‡∏≠‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê\n‡∏ô‡∏±‡πà‡∏á‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏ß‡πà‡∏≤‡∏á  ‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏û‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡πÄ‡∏à‡∏¥‡∏î  ‡∏™‡∏∏‡∏Ç‡∏•‡πâ‡∏≥‡πÄ‡∏•‡∏¥‡∏®‡πÉ‡∏ô‡∏®‡∏≤‡∏ô‡∏ï‡∏¥‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ô" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏µ‡πâ‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡πÉ‡∏à‡πÅ‡∏Å‡∏£‡πà‡∏á", effect: "fragile", icon: "üí™", color: "text-blue-500", 
        description: "‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 
        poem: "‡πÅ‡∏°‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏à‡∏∞‡∏≠‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤  ‡πÅ‡∏ï‡πà‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡πÉ‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏≠‡∏¢\n‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏Ñ‡∏≠‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏î‡∏ß‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡∏ç‡πà\n‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡πá‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ï‡∏¥  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏≥‡∏£‡∏¥‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏±‡∏¢\n‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à  ‡∏Å‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏á‡∏î‡∏á‡∏≤‡∏°" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡∏á‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πâ", effect: "volatile", icon: "ü•ä", color: "text-red-800", 
        description: "‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏ô‡∏≤‡∏®", 
        poem: "‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πâ‡∏≠‡∏â‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏á‡πÉ‡∏ô‡∏≠‡πÄ‡∏ß‡∏à‡∏µ  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πà‡πÉ‡∏ô‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏∏‡∏Å‡∏´‡∏¢‡πà‡∏≠‡∏°‡∏´‡∏ç‡πâ‡∏≤  ‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¥‡∏á‡∏û‡∏¥‡∏á\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏ï‡∏Å‡∏ï‡πà‡∏≥‡πÑ‡∏£‡πâ‡∏Ñ‡∏ô‡∏≠‡∏¥‡∏á  ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≠‡∏î‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡∏•‡∏á" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡∏£‡∏±‡∏Å‡∏≠‡∏≤‡∏†‡∏±‡∏û", effect: "lonely", icon: "üíî", color: "text-pink-500", 
        description: "‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏û‡∏ö‡∏£‡∏±‡∏Å‡πÅ‡∏ó‡πâ", 
        poem: "‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏°‡∏ô‡∏≤‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏•‡πâ‡∏≥  ‡πÉ‡∏à‡∏î‡∏∑‡πà‡∏°‡∏î‡∏∑‡πà‡∏°‡∏î‡πà‡∏≥‡∏£‡∏±‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏ú‡∏±‡∏ô‡∏´‡∏ô‡∏≤\n‡∏ô‡∏≤‡∏£‡∏µ‡∏•‡πâ‡∏≠‡∏°‡∏£‡∏∏‡∏°‡∏£‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏£‡∏±‡∏ó‡∏ò‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Ñ‡∏π‡πà‡∏ö‡∏∏‡∏ç‡∏û‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏µ\n‡πÅ‡∏ï‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏Å  ‡∏ñ‡∏π‡∏Å‡∏ú‡∏•‡∏±‡∏Å‡πÑ‡∏™‡πÑ‡∏•‡πà‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ô‡∏Å‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏µ  ‡πÑ‡∏£‡πâ‡∏Ñ‡∏ô‡∏î‡∏µ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ö‡∏±‡πâ‡∏ô‡∏õ‡∏•‡∏≤‡∏¢" 
    },
    { 
        gender: 'M', label: "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏™‡∏µ", effect: "wealthy", icon: "üåæ", color: "text-amber-600", 
        description: "‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£", 
        poem: "‡∏£‡∏ß‡∏á‡∏ó‡∏≠‡∏á‡∏ó‡πà‡∏ß‡∏°‡∏ó‡πâ‡∏ô‡πÉ‡∏ô‡∏¢‡∏∏‡πâ‡∏á‡∏â‡∏≤‡∏á  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™‡πÑ‡∏°‡πà‡∏≠‡∏≤‡∏†‡∏±‡∏û\n‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö  ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏á‡πÑ‡∏´‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏±‡πâ‡∏á\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏∞‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏≤‡∏Ç‡∏≤‡∏ô‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏ß‡∏±‡∏á\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á  ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏á‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ" 
    },
    { 
        gender: 'M', label: "‡∏ô‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢", effect: "unlucky", icon: "üå´Ô∏è", color: "text-gray-400", 
        description: "‡∏´‡∏≤‡∏¢‡∏™‡∏≤‡∏ö‡∏™‡∏π‡∏ç‡πÑ‡∏õ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", 
        poem: "‡∏Å‡πâ‡∏≤‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏Å‡∏•‡πÇ‡∏û‡πâ‡∏ô  ‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÇ‡∏î‡∏ô‡∏†‡∏±‡∏¢‡∏û‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏±‡πâ‡∏ô‡∏Ç‡∏ß‡∏≤‡∏á\n‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏≤‡∏á  ‡πÑ‡∏£‡πâ‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏à‡∏≠\n‡∏ç‡∏≤‡∏ï‡∏¥‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏ß‡∏±‡∏á  ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏´‡∏•‡∏±‡πà‡∏á‡∏£‡πà‡∏ß‡∏á‡∏£‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏∞‡πÄ‡∏á‡πâ‡∏≠\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏•‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡πÄ‡∏û‡πâ‡∏≠  ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ò‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π", effect: "lucky", icon: "üôè", color: "text-indigo-400", 
        description: "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏î‡∏π‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏î‡∏µ", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏î‡∏µ  ‡∏ö‡∏∏‡∏ç‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏´‡∏ô‡∏∏‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏´‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏¢\n‡πÄ‡∏ó‡∏ß‡∏î‡∏≤‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏¢  ‡∏™‡∏∏‡∏Ç‡∏™‡∏ö‡∏≤‡∏¢‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏û‡∏£\n‡∏õ‡∏£‡∏ô‡∏ô‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏™‡πà‡∏á‡∏ú‡∏•‡∏î‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏≠‡∏ô\n‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏ß‡∏£‡∏≠‡∏ô  ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ß‡∏≤‡∏à‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", effect: "spiritual", icon: "üëÑ", color: "text-orange-400", 
        description: "‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ß‡∏≤‡∏à‡∏≤", 
        poem: "‡∏ß‡∏≤‡∏à‡∏≤‡πÄ‡∏≠‡πà‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏à‡∏Å‡∏≥‡∏´‡∏ô‡∏î  ‡∏ú‡∏•‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏°‡∏ô‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô  ‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ñ‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏ô‡∏ó‡∏£\n‡∏û‡∏π‡∏î‡∏™‡∏¥‡πà‡∏á‡∏î‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏î‡∏µ‡∏Å‡πá‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏≤  ‡∏û‡∏π‡∏î‡∏£‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πá‡∏£‡πâ‡∏≤‡∏¢‡πÉ‡∏™‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏≠‡∏ô\n‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ï‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏à‡∏∞‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏à‡∏¥‡∏ô‡∏ï‡πå" 
    },
    { 
        gender: 'M', label: "‡∏¢‡∏≠‡∏î‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ", effect: "warrior", icon: "ü•ä", color: "text-red-600", 
        description: "‡∏à‡∏∞‡∏•‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡∏•‡∏á", 
        poem: "‡πÅ‡∏°‡πâ‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏Ç‡∏ß‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•  ‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡∏™‡∏∞‡∏ó‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏ù‡∏∑‡∏ô\n‡∏•‡πâ‡∏°‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏¢‡∏∑‡∏ô  ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï\n‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏π‡πâ‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏∞‡∏ï‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏à‡∏∞‡∏û‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏•‡∏î\n‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏á‡∏î‡∏á‡∏≤‡∏°  ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏Ñ‡∏ô‡πÇ‡∏á‡πà‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ", effect: "lucky", icon: "üçÄ", color: "text-green-400", 
        description: "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πà‡∏á‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÄ‡∏™‡∏°‡∏≠", 
        poem: "‡πÅ‡∏°‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡∏â‡∏≤‡∏ô  ‡πÅ‡∏ï‡πà‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏∏‡∏Ç‡∏™‡∏ñ‡∏≤‡∏û‡∏£\n‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏•‡∏≠‡∏¢‡∏°‡∏≤‡∏´‡∏≤‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô  ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≠‡∏ô‡∏Ç‡∏≠‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÉ‡∏à\n‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏†‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡∏£‡∏ß‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÑ‡∏°‡πà‡∏™‡∏á‡∏™‡∏±‡∏¢\n‡∏Ñ‡∏ô‡∏â‡∏•‡∏≤‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ö‡∏Å‡∏£‡∏≤‡∏ô‡∏™‡∏°‡∏±‡∏¢  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏±‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏á‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏Ñ‡∏ô‡∏ö‡∏≤‡∏õ‡∏ú‡∏π‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏à", effect: "volatile", icon: "üïØÔ∏è", color: "text-white", 
        description: "‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏ß‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏ò‡∏£‡∏£‡∏°", 
        poem: "‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏ä‡πâ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ó‡∏≤‡∏á‡∏°‡∏∑‡∏î‡∏™‡∏±‡∏ö‡∏™‡∏ô\n‡πÅ‡∏ï‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà  ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏∞‡∏û‡∏≤‡∏™‡∏∏‡∏Ç‡∏•‡πâ‡∏ô\n‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏•‡∏ó‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏®‡∏£‡∏±‡∏ó‡∏ò‡∏≤  ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡∏Å‡∏°‡∏•\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ï‡∏∑‡πà‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏≤‡∏Å‡∏•  ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á" 
    },
    { 
        gender: 'M', label: "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏µ‡∏¢", effect: "lucky", icon: "üíç", color: "text-rose-300", 
        description: "‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡∏û‡∏≤‡∏Å‡∏±‡∏ô‡∏£‡∏ß‡∏¢", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏á‡∏î‡∏ó‡∏≤‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏≤‡∏´‡∏≤‡∏ê‡∏≤‡∏ô\n‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏à‡∏∞‡∏û‡∏≤‡∏£‡∏ß‡∏¢‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏î‡∏µ  ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô\n‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏ó‡∏∏‡∏Å‡∏ó‡∏≤‡∏á‡∏£‡∏∑‡πà‡∏ô  ‡∏™‡∏∏‡∏Ç‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô‡∏û‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏£‡∏≤‡∏ç  ‡∏£‡∏ß‡∏¢‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡∏Ñ‡∏π‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏à‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢", effect: "unlucky", icon: "üó°Ô∏è", color: "text-red-900", 
        description: "‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ô‡πÇ‡∏Å‡∏á‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏à‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏•‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏¥‡∏à‡∏â‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏û‡∏¥‡∏ô‡∏≤‡∏®‡πÉ‡∏ô‡∏Å‡∏≤‡∏•‡∏ô‡∏µ‡πâ\n‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏†‡∏±‡∏¢  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ\n‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏≠‡∏ö‡∏ä‡πâ‡∏≥  ‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà\n‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏±‡∏ß‡∏´‡∏°‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡∏•‡∏µ‡πâ‡∏´‡∏ô‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏à‡∏ô‡∏ï‡∏≤‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏û‡∏ç‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ß", effect: "volatile", icon: "ü¶á", color: "text-purple-900", 
        description: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ", 
        poem: "‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡∏Ñ‡πà‡∏≥‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏à‡∏∞‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå  ‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏î‡πÉ‡∏™\n‡πÅ‡∏ï‡πà‡∏¢‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏°‡∏∑‡∏î‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡πÉ‡∏à  ‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏î‡∏±‡∏á‡πÉ‡∏à‡∏õ‡∏≠‡∏á\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏™‡∏≠‡∏á‡πÇ‡∏•‡∏Å  ‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏ô‡πÄ‡∏á‡∏≤‡∏°‡∏∑‡∏î‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏≤‡∏•  ‡∏™‡∏ñ‡∏≤‡∏û‡∏£‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏á‡∏≤‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'M', label: "‡∏î‡∏ß‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå", effect: "lucky", icon: "‚òÄÔ∏è", color: "text-yellow-500", 
        description: "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏¢‡πÄ‡∏¢‡∏≤‡∏ß‡πå", 
        poem: "‡∏î‡∏±‡πà‡∏á‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á‡∏™‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡∏Ç  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏Å‡∏£‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô\n‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏´‡∏ô‡∏∏‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ï‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏¢\n‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏¢‡πÄ‡∏¢‡∏≤‡∏ß‡πå‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ä‡∏£‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏ö‡πÄ‡∏≠‡∏¢\n‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å‡πÄ‡∏•‡∏¢  ‡∏™‡∏∏‡∏Ç‡πÄ‡∏™‡∏ö‡∏¢‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä" 
    },

    // ==========================================
    // === ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ç‡∏¥‡∏á (FEMALE - 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ===
    // ==========================================
    { 
        gender: 'F', label: "‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á", effect: "charming", icon: "üåπ", color: "text-pink-600", 
        description: "‡∏á‡∏î‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏á", 
        poem: "‡πÇ‡∏â‡∏°‡∏™‡∏∞‡∏Ñ‡∏£‡∏≤‡∏ç‡∏Å‡∏£‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡πÉ‡∏à‡πÑ‡∏´‡∏ß‡∏´‡∏ß‡∏±‡πà‡∏ô  ‡∏î‡∏±‡πà‡∏á‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä\n‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏´‡∏°‡∏î‡∏à‡∏î‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå  ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡πà‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏û‡∏¥‡∏•‡∏≤‡∏™‡∏û‡∏¥‡πÑ‡∏•‡πÄ‡∏≠‡∏¢\n‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏°‡∏ü‡∏∏‡πâ‡∏á‡∏à‡∏£‡∏∏‡∏á‡πÉ‡∏à‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®  ‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏™‡∏°‡∏™‡∏°‡∏±‡∏¢\n‡πÉ‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏±‡∏Å‡∏õ‡∏±‡∏Å‡∏î‡∏ß‡∏á‡πÉ‡∏à  ‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á‡πÇ‡∏£‡∏¢", effect: "fragile", icon: "ü•Ä", color: "text-orange-400", 
        description: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô", 
        poem: "‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏õ‡∏£‡∏∞‡∏î‡∏∏‡∏à‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤  ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏â‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡∏™‡∏≤‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏•‡∏≤‡∏¢  ‡∏ö‡∏∏‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤\n‡πÇ‡∏£‡∏Ñ‡∏£‡∏∏‡∏°‡πÄ‡∏£‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≤‡∏¢‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡∏™‡∏≤‡∏ß  ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡∏£‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô‡∏≠‡∏±‡∏ô‡πÇ‡∏®‡∏Å‡∏≤\n‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏™‡∏∏‡∏™‡∏≤‡∏ô  ‡∏Å‡∏≤‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏£‡∏≤‡∏Å‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πà‡∏°‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß", effect: "leader", icon: "üêé", color: "text-slate-100", 
        description: "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≠‡∏ö‡∏Å‡∏π‡πâ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£", 
        poem: "‡∏¢‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï  ‡∏ô‡∏≤‡∏£‡∏µ‡∏°‡∏≤‡πÄ‡∏ô‡∏£‡∏°‡∏¥‡∏ï‡∏ó‡∏≤‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á  ‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏ß‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á\n‡∏ô‡∏≥‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏£‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏π‡πâ‡πÑ‡∏û‡∏£‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏ô‡∏≤‡∏£‡∏µ‡∏û‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå\n‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô  ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤‡∏™‡∏î‡πÉ‡∏™‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ", effect: "unlucky", icon: "üíÄ", color: "text-purple-900", 
        description: "‡∏°‡∏±‡∏Å‡∏ô‡∏≥‡∏û‡∏≤‡πÇ‡∏ä‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î", 
        poem: "‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏ñ‡∏£‡∏£‡∏û‡πå‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡∏•‡∏∂‡∏Å  ‡πÉ‡∏à‡∏™‡∏∞‡∏≠‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∞‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡πÄ‡∏û‡∏®\n‡πÉ‡∏Ñ‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î‡∏û‡∏¥‡∏ô‡∏≤‡∏®‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏≤‡∏ß‡∏£‡∏ì‡πå  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏´‡∏•‡∏≠‡∏ô‡∏´‡∏•‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ó‡∏°\n‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡∏î‡∏≠‡∏≤‡πÄ‡∏û‡∏®‡∏û‡∏≤‡∏™‡∏∞‡∏™‡∏°\n‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏®‡∏Å‡πÄ‡∏®‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏á‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏°  ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∑‡πà‡∏ô‡∏Ç‡∏°‡∏à‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏•‡∏°‡∏õ‡∏£‡∏≤‡∏ì" 
    },
    { 
        gender: 'F', label: "‡πÄ‡∏ó‡∏û‡∏ò‡∏¥‡∏î‡∏≤‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå", effect: "spiritual", icon: "‚ú®", color: "text-violet-500", 
        description: "‡∏°‡∏µ‡∏ç‡∏≤‡∏ì‡∏ó‡∏¥‡∏û‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©", 
        poem: "‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡πÉ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏±‡∏î‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡∏´‡∏°‡∏≤‡∏¢  ‡∏£‡∏π‡πâ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏±‡πà‡∏ô\n‡πÄ‡∏ó‡∏û‡πÄ‡∏ó‡∏ß‡∏≤‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏ô  ‡∏î‡∏ß‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏≠‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏à\n‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡∏≠‡∏î‡∏µ‡∏ï‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏ó‡∏±‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏Å‡∏•  ‡∏û‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏á‡∏™‡πå‡∏õ‡∏µ‡∏Å‡∏´‡∏±‡∏Å", effect: "unlucky", icon: "ü¶¢", color: "text-slate-400", 
        description: "‡πÄ‡∏Ñ‡∏¢‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏Å‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á", 
        poem: "‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏ö‡∏ô‡πÄ‡∏ß‡∏´‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡∏ï‡∏£‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏¥‡∏ô\n‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏à‡∏ô‡∏£‡∏≤‡∏Ñ‡∏¥‡∏ô  ‡∏™‡∏π‡∏ç‡∏™‡∏¥‡πâ‡∏ô‡∏ñ‡∏¥‡πà‡∏ô‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡∏£‡∏≠‡∏á\n‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏Å‡∏£‡∏∞‡πÄ‡∏´‡∏¥‡∏ô‡πÉ‡∏ô‡∏ñ‡∏¥‡πà‡∏ô‡πÑ‡∏Å‡∏•  ‡∏ä‡πâ‡∏≥‡∏ó‡∏£‡∏ß‡∏á‡πÉ‡∏ô‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏£‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏á‡∏Ñ‡∏•‡∏≠‡∏á\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏±‡∏á‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏•‡∏á  ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏Ç‡∏°‡∏Ç‡∏∑‡πà‡∏ô" 
    },
    { 
        gender: 'F', label: "‡πÅ‡∏°‡πà‡∏°‡∏ì‡∏µ‡∏®‡∏£‡∏µ‡∏™‡∏¢‡∏≤‡∏°", effect: "artistic", icon: "üé≠", color: "text-orange-500", 
        description: "‡πÄ‡∏Å‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏è‡∏®‡∏¥‡∏•‡∏õ‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", 
        poem: "‡∏£‡πà‡∏≤‡∏¢‡∏£‡∏≥‡∏™‡∏ß‡∏¢‡πÅ‡∏ä‡πà‡∏°‡∏ä‡πâ‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏à‡∏¥‡∏ï  ‡∏á‡∏≤‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏¥‡∏®‡∏Ñ‡πà‡∏≤\n‡∏ù‡∏≤‡∏Å‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏•‡πÄ‡∏ß‡∏•‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ñ‡∏¥‡πà‡∏ô‡πÑ‡∏ó‡∏¢‡∏á‡∏≤‡∏°\n‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡πÑ‡∏ó‡∏¢‡∏ö‡∏£‡∏£‡πÄ‡∏•‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏™‡∏¢‡∏≤‡∏°\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏£‡∏±‡∏Å‡∏©‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°  ‡∏™‡∏∑‡∏ö‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Ñ‡∏π‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏°‡πâ‡∏≤‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û", effect: "lonely", icon: "üëµ", color: "text-stone-500", 
        description: "‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏¢‡∏™‡∏≤‡∏ß", 
        poem: "‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å  ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏´‡∏•‡∏≤‡∏Å‡∏≠‡∏≤‡∏ß‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á\n‡∏™‡∏≤‡∏°‡∏µ‡∏à‡∏≤‡∏Å‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á  ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏û‡∏±‡∏á‡∏ó‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏•\n‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏á‡∏≤‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏´‡∏≠  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏¢‡∏∑‡∏ô  ‡∏ó‡∏£‡∏°‡∏≤‡∏ô‡πÉ‡∏à‡∏ï‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏á‡∏û‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤", effect: "leader", icon: "ü¶ã", color: "text-sky-500", 
        description: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡πÅ‡∏ù‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏î‡∏ä‡∏≠‡∏≥‡∏ô‡∏≤‡∏à", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à  ‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡∏µ\n‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏õ‡∏ß‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô\n‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡∏Ñ‡∏á‡∏Ñ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏Ñ‡∏ô‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏¥‡∏ô\n‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏Ñ‡∏ß‡πâ‡∏ô‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏Ñ‡πÄ‡∏£‡∏®  ‡∏ó‡∏±‡πà‡∏ß‡πÄ‡∏Ç‡∏ï‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏á‡∏ó‡∏≤‡∏™‡∏ú‡∏π‡πâ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π", effect: "volatile", icon: "üßπ", color: "text-amber-900", 
        description: "‡∏à‡∏≤‡∏Å‡∏ó‡∏≤‡∏™‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á", 
        poem: "‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏™‡πÉ‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÑ‡∏ã‡∏£‡πâ‡∏´‡∏ô‡∏∏‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å  ‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏ß‡∏á\n‡∏≠‡∏î‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏Ç‡∏∑‡πà‡∏ô  ‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≥‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏´‡∏ô‡∏´‡∏ß‡∏á\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏û‡πâ‡∏ô‡∏ö‡πà‡∏ß‡∏á  ‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏û‡∏ß‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏î‡∏µ" 
    },
    { 
        gender: 'F', label: "‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏∏‡∏ç", effect: "charming", icon: "üíç", color: "text-rose-400", 
        description: "‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Ñ‡∏π‡πà‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°  ‡∏Ñ‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà\n‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ó‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏±‡∏Å‡∏î‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡πÑ‡∏Å‡∏•‡∏Ñ‡∏π‡πà‡πÑ‡∏≠‡∏®‡∏π‡∏£‡∏¢‡πå\n‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏î‡πÉ‡∏™  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏±‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏π‡∏ç\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡∏≠‡∏±‡∏°‡∏û‡∏£" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πâ‡∏≠‡∏¥‡∏à‡∏â‡∏≤", effect: "unlucky", icon: "üêç", color: "text-green-900", 
        description: "‡∏°‡∏±‡∏Å‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏¥‡∏©‡∏¢‡∏≤", 
        poem: "‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏≤‡πÉ‡∏à‡∏£‡πâ‡∏≠‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Ñ‡∏•‡∏≠‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏¢\n‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏Å‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏≥‡∏•‡∏≤‡∏¢  ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏ô‡∏≤‡∏®\n‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏∂‡∏°‡πÄ‡∏ã‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏á‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏≤‡∏î\n‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û‡∏û‡∏±‡∏á‡∏ó‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏≠‡∏≤‡∏Ü‡∏≤‡∏ï‡∏û‡∏≤‡∏ï‡∏£‡∏°‡πÉ‡∏à" 
    },
    { 
        gender: 'F', label: "‡πÅ‡∏°‡πà‡∏û‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô", effect: "healer", icon: "üçµ", color: "text-teal-400", 
        description: "‡∏°‡∏µ‡∏û‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏£‡∏±‡∏Å‡∏©‡∏≤", 
        poem: "‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏û‡∏≤‡πÇ‡∏£‡∏Ñ‡∏†‡∏±‡∏¢‡∏´‡∏≤‡∏¢  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏£‡∏µ‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏®‡∏Å‡πÄ‡∏®‡∏£‡πâ‡∏≤\n‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡∏•‡∏≤  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÄ‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏à‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ô‡∏≤‡∏ô\n‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ô  ‡∏ó‡∏∏‡∏Å‡∏°‡∏ì‡∏ë‡∏•‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡∏∏‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏ß‡∏¥‡∏°‡∏≤‡∏ô  ‡∏™‡∏ñ‡∏≤‡∏û‡∏£‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏á‡∏Ñ‡∏°" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏ï‡∏¥‡∏ü‡∏±‡πà‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏ô", effect: "unlucky", icon: "ü§™", color: "text-gray-500", 
        description: "‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏ï‡∏¥‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏®‡∏Å‡∏ô‡∏≤‡∏è‡∏Å‡∏£‡∏£‡∏°", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡πá‡∏ö‡∏ä‡πâ‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏à‡∏à‡∏∞‡∏£‡∏±‡∏ö  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡∏ö‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤\n‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÉ‡∏ô‡∏û‡∏á‡∏®‡∏≤  ‡πÑ‡∏£‡πâ‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡πÑ‡∏£‡πâ‡∏™‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå\n‡∏ç‡∏≤‡∏ï‡∏¥‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡∏ä‡∏∞‡∏ï‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏π‡∏ç\n‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡∏à‡∏≥‡∏£‡∏π‡∏ç  ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏®‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô‡πÑ‡∏õ‡∏ä‡∏±‡πà‡∏ß‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå" 
    },
    { 
        gender: 'F', label: "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á", effect: "scholar", icon: "üåô", color: "text-yellow-200", 
        description: "‡∏â‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏´‡∏•‡∏° ‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏®", 
        poem: "‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏ß‡πÑ‡∏Å‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏î‡∏±‡∏á‡πÅ‡∏™‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå  ‡∏£‡∏π‡πâ‡∏≠‡πÄ‡∏ô‡∏Å‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå‡∏ó‡∏∏‡∏Å‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏®‡∏¥‡∏•‡∏õ‡πå\n‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ñ‡∏ß‡∏¥‡∏•‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤\n‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô  ‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏á‡∏Ç‡∏≤\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏û‡∏≤  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏ó‡∏±‡∏¢" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏õ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏á‡∏≤‡∏°", effect: "lucky", icon: "üé≠", color: "text-stone-400", 
        description: "‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏á‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏∞‡∏û‡∏ö‡∏£‡∏±‡∏Å‡πÅ‡∏ó‡πâ", 
        poem: "‡πÅ‡∏°‡πâ‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏â‡∏°‡πÑ‡∏°‡πà‡∏û‡∏£‡∏¥‡πâ‡∏°‡∏î‡∏π‡∏Ç‡∏±‡∏î‡∏ï‡∏≤  ‡πÅ‡∏ï‡πà‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ\n‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à  ‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏á‡∏≤‡∏°‡∏ä‡∏ô‡∏∞‡πÄ‡∏•‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ú‡∏¥‡∏ß‡∏û‡∏£‡∏£‡∏ì  ‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á  ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡πà‡∏≠‡∏á‡πÉ‡∏™‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏á‡∏™‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏±‡∏á‡∏Å‡∏£", effect: "leader", icon: "ü¶¢", color: "text-red-400", 
        description: "‡∏°‡∏µ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ä‡∏≤‡∏¢", 
        poem: "‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏û‡∏≤‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå\n‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á‡∏¢‡∏≠‡∏°‡∏™‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏£‡∏±‡∏Å  ‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏ô‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ô‡∏≤‡∏£‡∏µ\n‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏∂‡∏Å‡∏Å‡πâ‡∏≠‡∏á  ‡πÑ‡∏°‡πà‡∏°‡∏±‡∏ß‡∏´‡∏°‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏≤‡∏Å‡∏•‡πÉ‡∏ô‡∏õ‡∏ê‡∏û‡∏µ  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏°" 
    },
    { 
        gender: 'F', label: "‡∏ò‡∏¥‡∏î‡∏≤‡∏à‡∏≠‡∏°‡πÅ‡∏Å‡πà‡∏ô", effect: "volatile", icon: "üéà", color: "text-orange-400", 
        description: "‡∏â‡∏•‡∏≤‡∏î‡πÅ‡∏Å‡∏°‡πÇ‡∏Å‡∏á‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå", 
        poem: "‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö‡πÑ‡∏ß‡πÉ‡∏à‡∏™‡∏π‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏≠‡∏¢‡∏´‡∏ô‡∏µ  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≥\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡πÄ‡∏ä‡πâ‡∏≤‡∏Ñ‡πà‡∏≥  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏•‡∏¥‡∏®‡∏•‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏õ‡∏≠‡∏á\n‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡∏∏‡∏Å‡∏ã‡∏ô‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™  ‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏°‡πà‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏∏‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏£‡∏•‡∏≠‡∏á  ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡πà‡∏≠‡∏á‡πÉ‡∏™‡∏™‡∏∏‡∏Ç‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥", effect: "diplomat", icon: "üß∂", color: "text-amber-500", 
        description: "‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏£‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ", 
        poem: "‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏ß‡πÉ‡∏à‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏ï‡∏ï‡∏≤\n‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏£‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏£‡πâ‡∏≤‡∏ß‡∏£‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏ö‡πÄ‡∏¢‡πá‡∏ô\n‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏¢‡∏∏‡∏ï‡∏¥‡∏®‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏¥‡πâ‡∏°‡∏≠‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ç‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏™‡πâ‡∏ô\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏Ç‡πá‡∏ç  ‡πÇ‡∏•‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏á‡∏ü‡πâ‡∏≤‡∏û‡∏•‡∏±‡∏î‡∏ñ‡∏¥‡πà‡∏ô", effect: "unlucky", icon: "üëº", color: "text-yellow-200", 
        description: "‡∏Ñ‡∏ô‡∏î‡∏µ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏ß‡∏£‡πâ‡∏≤‡∏¢", 
        poem: "‡∏î‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏û‡∏ò‡∏¥‡∏î‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏•‡∏ô‡∏ï‡∏°  ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ó‡∏°‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏≤\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏ã‡∏ö‡πÄ‡∏ã‡∏≤  ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏ô‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ß‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡∏±‡∏á\n‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡∏±‡πà‡∏ô‡πÅ‡∏Å‡∏•‡πâ‡∏á‡∏£‡∏±‡∏á‡πÅ‡∏Å‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏£‡∏™‡∏´‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á  ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≠‡∏î‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢" 
    },
    { 
        gender: 'F', label: "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏ó‡∏∞‡πÄ‡∏•", effect: "traveler", icon: "üêö", color: "text-blue-300", 
        description: "‡∏ä‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏®‡∏©", 
        poem: "‡∏ä‡∏≠‡∏ö‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏™‡∏°‡∏∏‡∏ó‡∏£  ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡πÉ‡∏´‡∏°‡πà\n‡∏ô‡∏≥‡∏°‡∏∏‡∏Å‡πÄ‡∏•‡∏≠‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ô‡πÑ‡∏Å‡∏•  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥\n‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡πÉ‡∏ï‡πâ‡∏ö‡∏≤‡∏î‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏î‡∏™‡∏ß‡∏¢  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏£‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≥\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ô‡∏≤‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ô‡∏≥  ‡πÇ‡∏ä‡∏Ñ‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏Ç‡∏•‡πâ‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏Ñ‡∏π‡πà", effect: "lonely", icon: "üåë", color: "text-gray-600", 
        description: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏Ç‡∏≠‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏ô‡πÅ‡∏Å‡πà", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏á  ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏ï‡∏Å‡∏£‡∏∞‡πÅ‡∏´‡∏á‡πÉ‡∏ô‡∏ó‡∏∏‡πà‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á\n‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏à‡∏µ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏á  ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡∏≤‡∏¢\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ñ‡πà‡∏≠‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏¢  ‡∏ä‡πâ‡∏≥‡∏ó‡∏£‡∏ß‡∏á‡πÉ‡∏ô‡πÄ‡∏´‡∏á‡∏≤‡∏´‡∏á‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢  ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡∏≤‡∏¢‡∏à‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏¢" 
    },
    { 
        gender: 'F', label: "‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏®‡∏≤‡∏™‡∏ô‡∏≤", effect: "spiritual", icon: "üèÆ", color: "text-orange-300", 
        description: "‡∏°‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡πÉ‡∏´‡∏ç‡πà", 
        poem: "‡πÉ‡∏à‡∏®‡∏£‡∏±‡∏ó‡∏ò‡∏≤‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏∏‡∏®‡∏•  ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏´‡∏≤‡∏£‡∏õ‡∏±‡∏ô‡∏ö‡∏∏‡∏ç‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏á\n‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏™‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏≤‡∏á  ‡πÉ‡∏´‡πâ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏´‡πà‡∏á‡∏™‡∏±‡∏à‡∏ò‡∏£‡∏£‡∏°‡∏à‡∏£‡∏¥‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏•‡∏Å  ‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏≠‡∏¥‡∏á\n‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏ä‡∏µ‡∏ß‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á  ‡∏™‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏°‡∏¥‡πà‡∏á‡∏°‡∏á‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏ß‡∏£" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°‡∏™‡∏¢‡∏≤‡∏°", effect: "charming", icon: "üòä", color: "text-yellow-500", 
        description: "‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡πâ‡∏° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏á‡πà‡∏≤‡∏¢", 
        poem: "‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏¢‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏û‡πâ‡∏ô‡πÇ‡∏ó‡∏©‡πÇ‡∏®‡∏Å‡∏®‡∏±‡∏•‡∏¢\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô  ‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥\n‡πÉ‡∏Ñ‡∏£‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πà  ‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≥\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏ú‡∏π‡πâ‡∏ô‡∏≥  ‡πÇ‡∏ä‡∏Ñ‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏î‡πÉ‡∏™" 
    },
    { 
        gender: 'F', label: "‡∏î‡∏≤‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡∏ü‡πâ‡∏≤", effect: "longevity", icon: "‚≠ê", color: "text-yellow-400", 
        description: "‡∏≠‡∏≤‡∏¢‡∏∏‡∏¢‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏°‡∏ï‡∏∞", 
        poem: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏±‡πà‡∏ô  ‡∏î‡∏±‡πà‡∏á‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏î‡πà‡∏ô‡∏ü‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á\n‡∏≠‡∏≤‡∏¢‡∏∏‡∏¢‡∏∑‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏û‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏õ‡∏ß‡∏á  ‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ô\n‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡πà‡∏ô‡∏ö‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™‡πÑ‡∏£‡πâ‡∏£‡∏≤‡∏Ñ‡∏¥‡∏ô\n‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏°‡∏ï‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏î‡∏ô‡∏î‡∏¥‡∏ô  ‡∏™‡∏∑‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏à‡∏ô‡∏´‡∏°‡∏∑‡πà‡∏ô‡∏õ‡∏µ" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πâ‡πÅ‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û", effect: "fragile", icon: "üò¢", color: "text-blue-400", 
        description: "‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠ ‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ö‡∏ö‡∏≤‡∏á  ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ö‡πÑ‡∏°‡πâ‡∏î‡∏π‡πÑ‡∏´‡∏ß‡∏´‡∏ß‡∏±‡πà‡∏ô\n‡πÄ‡∏à‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πá‡∏ï‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ô  ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏´‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏™‡∏≤‡∏¢\n‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏≠‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ô‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏à‡∏∂‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏≤‡∏¢  ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡∏≤‡∏¢‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏û‡∏±‡∏á" 
    },
    { 
        gender: 'F', label: "‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏±‡∏Å‡∏£‡∏ö", effect: "warrior", icon: "ü§∫", color: "text-red-800", 
        description: "‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡πÅ‡∏•‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡∏ß‡∏¥‡∏ò‡∏µ", 
        poem: "‡∏û‡∏£‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡πå‡∏à‡∏±‡∏ö‡∏î‡∏≤‡∏ö‡∏°‡∏±‡πà‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß  ‡∏ô‡∏≥‡∏ó‡∏±‡∏û‡∏ä‡∏±‡∏¢‡∏õ‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡∏ô‡∏≤‡∏£‡∏µ‡∏°‡∏µ‡∏™‡∏≥‡πÅ‡∏î‡∏á  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏Å‡∏≥‡πÅ‡∏´‡∏á‡πÄ‡∏Å‡∏£‡∏¥‡∏Å‡πÑ‡∏Å‡∏£‡πÉ‡∏ô‡∏£‡∏±‡∏ô\n‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏£‡∏á‡∏Å‡∏•‡∏±‡∏ß‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏®‡∏∂‡∏Å‡∏ô‡∏±‡πâ‡∏ô\n‡∏õ‡∏ê‡∏û‡∏µ‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏±‡πà‡∏ô  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏õ‡∏±‡∏ô‡∏ä‡∏±‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö", effect: "guardian", icon: "üóùÔ∏è", color: "text-gray-600", 
        description: "‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°", 
        poem: "‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏°‡∏±‡πà‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ô‡∏±‡πâ‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏î‡πâ\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏û‡∏á‡∏®‡πå‡πÄ‡∏ú‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà  ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ò‡∏≠\n‡πÑ‡∏°‡πà‡πÄ‡∏≠‡πà‡∏¢‡∏õ‡∏≤‡∏Å‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•  ‡πÅ‡∏°‡πâ‡∏†‡∏±‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ú‡∏•‡∏≠\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏à‡∏≠  ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πÄ‡∏™‡∏°‡∏≠‡∏Ñ‡∏π‡πà‡∏ü‡πâ‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£" 
    },
    { 
        gender: 'F', label: "‡∏Å‡∏±‡∏•‡∏¢‡∏≤‡∏ì‡∏µ‡∏®‡∏£‡∏µ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", effect: "clever", icon: "üéì", color: "text-indigo-400", 
        description: "‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡πÅ‡∏´‡∏•‡∏° ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", 
        poem: "‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ñ‡∏•‡∏µ‡πà‡∏Ñ‡∏•‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏±‡∏ç‡∏ç‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏®‡∏¥‡∏•‡∏õ‡πå\n‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏Ç‡∏à‡∏£‡∏î‡∏¥‡∏ô  ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏û‡∏¥‡∏•‡∏≤‡∏™‡πÑ‡∏ß\n‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå  ‡πÉ‡∏à‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ô‡∏≥‡∏û‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏¢\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£  ‡∏û‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô", effect: "unlucky", icon: "üí∏", color: "text-red-700", 
        description: "‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πà‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢", 
        poem: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏á‡∏´‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•  ‡πÅ‡∏ï‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏±‡πâ‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á  ‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏±‡∏ô\n‡∏´‡∏¢‡∏¥‡∏ö‡∏à‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏Å‡πá‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏Å‡∏ä‡πâ‡∏≥‡πÉ‡∏à‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡∏à‡∏∂‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ô  ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ô‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ" 
    },
    { 
        gender: 'F', label: "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏Å‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏•‡∏ß‡∏á", effect: "wealthy", icon: "üí∞", color: "text-yellow-600", 
        description: "‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô", 
        poem: "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°  ‡πÉ‡∏à‡πÄ‡∏õ‡∏µ‡πà‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏°‡∏±‡πà‡∏ô\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç\n‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏ï‡∏Å  ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏≠‡∏Å‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏£‡∏∏‡∏Å  ‡∏û‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏á‡∏£‡∏≥‡∏≠‡∏≤‡∏†‡∏±‡∏û", effect: "unlucky", icon: "ü©∞", color: "text-red-300", 
        description: "‡∏£‡∏≥‡∏™‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á", 
        poem: "‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡πÄ‡∏•‡∏¥‡∏®‡∏£‡πà‡∏≤‡∏¢‡∏£‡∏≥‡∏õ‡∏≤‡∏ô‡πÄ‡∏ó‡∏û‡∏®‡∏¥‡∏•‡∏õ‡πå  ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏≤‡∏™‡∏ô‡∏≤\n‡∏ñ‡∏π‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏°‡∏≤  ‡πÑ‡∏£‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏á\n‡∏£‡∏≥‡∏Å‡∏•‡∏≤‡∏á‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ó‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏≠‡∏´‡πâ‡∏≠‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á  ‡∏à‡∏ö‡∏Ñ‡∏£‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î‡∏°‡∏ô‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'F', label: "‡πÄ‡∏ó‡∏û‡∏ò‡∏¥‡∏î‡∏≤‡∏™‡∏≤‡∏¢‡∏ù‡∏ô", effect: "healer", icon: "üåßÔ∏è", color: "text-blue-400", 
        description: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏£‡πâ‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô", 
        poem: "‡∏î‡∏±‡πà‡∏á‡∏´‡∏¢‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏ä‡πÇ‡∏•‡∏°‡πÉ‡∏à‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡∏ú‡∏≤‡∏Å  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏Ñ‡∏•‡∏µ‡πà‡∏Ñ‡∏•‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡πÅ‡∏ú‡πà‡∏ã‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏£‡∏ß‡∏á‡πÉ‡∏ô  ‡∏õ‡∏≤‡∏è‡∏¥‡∏´‡∏≤‡∏£‡∏¥‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ô‡∏≤‡∏£‡∏µ‡∏û‡∏≤‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô\n‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏á‡πÑ‡∏£‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô  ‡∏™‡∏∏‡∏Ç‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡πâ‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏≥‡πÄ‡∏Ç‡πá‡∏ç  ‡πÇ‡∏•‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏π‡∏´‡∏ô‡∏ß‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á", effect: "spiritual", icon: "üëÇ", color: "text-stone-600", 
        description: "‡∏´‡∏π‡∏î‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏à‡∏ò‡∏£‡∏£‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô", 
        poem: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏∏‡πà‡∏ô‡∏ß‡∏≤‡∏¢  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡πÉ‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏ß‡πà‡∏≤‡∏á\n‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏ó‡∏≤‡∏á  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏à‡πà‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏ó‡∏±‡∏¢\n‡∏™‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏á‡∏ö‡∏Ñ‡∏≥  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏û‡∏≤‡∏Ñ‡∏ô‡∏û‡πâ‡∏ô‡∏™‡∏°‡∏±‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£  ‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏≤‡∏à‡∏≤" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏á‡∏™‡πå‡∏ü‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏°‡∏á‡∏Ñ‡∏•", effect: "leader", icon: "ü¶¢", color: "text-amber-400", 
        description: "‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏°‡∏≤‡∏™‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", 
        poem: "‡∏´‡∏á‡∏™‡πå‡∏ú‡∏á‡∏≤‡∏î‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™  ‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏•‡∏±‡πà‡∏á‡πÑ‡∏´‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏á‡∏Ñ‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó  ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏ô\n‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏°‡∏ì‡∏ë‡∏•\n‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏™‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ" 
    },
    { 
        gender: 'F', label: "‡∏ò‡∏¥‡∏î‡∏≤‡∏à‡∏≠‡∏°‡∏õ‡∏•‡∏≠‡∏°", effect: "unlucky", icon: "üé≠", color: "text-red-900", 
        description: "‡∏ä‡∏≠‡∏ö‡πÄ‡∏™‡πÅ‡∏™‡∏£‡πâ‡∏á‡∏à‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠", 
        poem: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ö‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏≤‡∏™‡∏á‡∏™‡∏≤‡∏£  ‡πÅ‡∏ï‡πà‡∏ô‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏ö‡πÄ‡∏≠‡∏¢  ‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏•‡∏ß‡∏á\n‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á‡πÇ‡∏•‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡∏ô  ‡πÉ‡∏ô‡∏Å‡∏°‡∏•‡∏Ç‡∏∏‡πà‡∏ô‡∏°‡∏±‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏∏‡πà‡∏°‡∏û‡∏ß‡∏á\n‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡πÅ‡∏â‡πÉ‡∏´‡πâ‡∏ä‡πâ‡∏≥‡∏ó‡∏£‡∏ß‡∏á  ‡∏à‡∏°‡πÉ‡∏ô‡∏ö‡πà‡∏ß‡∏á‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏°‡∏≤" 
    },
    { 
        gender: 'F', label: "‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û‡∏´‡∏ç‡∏¥‡∏á‡∏ú‡∏π‡πâ‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà", effect: "warrior", icon: "‚öîÔ∏è", color: "text-red-700", 
        description: "‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥", 
        poem: "‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏ö‡πÄ‡∏•‡∏¥‡∏®‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô  ‡∏ó‡∏±‡πà‡∏ß‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏¢‡∏≠‡∏°‡∏™‡∏¢‡∏ö‡πÉ‡∏ô‡πÄ‡∏î‡∏ä‡∏Ç‡∏•‡∏±‡∏á\n‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏£‡∏µ‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á  ‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÇ‡∏î‡πà‡∏á‡∏î‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ò‡∏≤‡∏ô‡∏µ\n‡∏ô‡∏≥‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏ö‡∏∏‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®  ‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û‡∏ú‡∏π‡πâ‡∏ô‡∏µ‡πâ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏Å‡∏£‡∏¥‡∏Å‡πÑ‡∏Å‡∏£‡∏Ñ‡∏π‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå", effect: "lucky", icon: "üßπ", color: "text-blue-300", 
        description: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å‡∏à‡∏≤‡∏Å‡∏ô‡∏≤‡∏¢", 
        poem: "‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏°‡∏≤‡∏´‡∏≤‡∏ê‡∏≤‡∏ô\n‡∏ô‡∏≤‡∏¢‡∏£‡∏±‡∏Å‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏π‡πÉ‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô  ‡∏°‡∏≠‡∏ö‡∏ß‡∏¥‡∏°‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á\n‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô  ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏•‡πâ‡∏ô‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô\n‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏õ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏ò‡∏¥‡∏î‡∏≤‡∏û‡∏ç‡∏≤‡∏ô‡∏≤‡∏Ñ", effect: "spiritual", icon: "üêç", color: "text-green-700", 
        description: "‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏µ‡πâ‡∏•‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏î‡∏ß‡∏á‡∏ï‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£\n‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡πÑ‡∏´‡∏•‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î  ‡∏û‡∏π‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏ß‡∏µ‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏£‡∏ß‡∏á‡πÉ‡∏à\n‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡πÉ‡∏à‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏•‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏°‡∏≤‡∏™‡∏°‡∏±‡∏¢\n‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏†‡∏±‡∏¢‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÑ‡∏Å‡∏•  ‡πÉ‡∏´‡πâ‡πÑ‡∏ó‡∏¢‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'F', label: "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏∑‡∏°", effect: "unlucky", icon: "üå´Ô∏è", color: "text-slate-400", 
        description: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏á‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ", 
        poem: "‡∏ó‡∏≥‡∏î‡∏µ‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡πÑ‡∏£‡πâ‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô  ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏û‡∏±‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ\n‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏•‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏ï‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏ä‡∏µ‡∏¢‡∏ö‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏∑‡∏î  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡∏î‡∏£‡∏∞‡∏ó‡∏°‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏ö‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Å‡∏•  ‡πÑ‡∏£‡πâ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå", effect: "clever", icon: "üí°", color: "text-yellow-500", 
        description: "‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏•‡πâ‡∏≥‡∏ô‡∏≥‡∏™‡∏°‡∏±‡∏¢  ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏î‡πÉ‡∏™\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏à‡∏£‡πÑ‡∏Å‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏ç‡∏ç‡∏≤\n‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏Å‡∏•‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏©‡∏é‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏≥‡∏õ‡∏£‡∏µ‡∏ä‡∏≤\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏û‡∏≤  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡πÅ‡∏î‡∏ô‡πÑ‡∏ó‡∏¢" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô", effect: "healer", icon: "üïäÔ∏è", color: "text-teal-300", 
        description: "‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏ô‡∏•‡∏∑‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", 
        poem: "‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏≤‡∏™‡∏î‡πÉ‡∏™  ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏´‡∏ß‡∏±‡∏á\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡∏î‡∏±‡∏á‡πÉ‡∏ô‡πÉ‡∏à‡∏Ñ‡∏ô\n‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ  ‡πÉ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏á‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡∏î‡∏™‡∏ô\n‡∏ö‡∏∏‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏™‡∏≤‡∏Å‡∏•  ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á‡πÑ‡∏û‡∏£‡∏£‡∏±‡∏Å‡∏©‡πå", effect: "traveler", icon: "üåø", color: "text-green-600", 
        description: "‡∏£‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ú‡∏∑‡∏ô‡∏õ‡πà‡∏≤", 
        poem: "‡∏£‡πà‡∏°‡πÑ‡∏°‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∑‡∏≠‡∏õ‡πà‡∏≤  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Ç‡∏à‡∏µ\n‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÉ‡∏Ñ‡∏£‡πà‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏ô‡∏≤‡∏£‡∏µ‡∏Ñ‡∏∏‡πâ‡∏°‡∏û‡∏á‡πÑ‡∏û‡∏£\n‡∏ö‡∏∏‡∏Å‡∏õ‡πà‡∏≤‡∏ù‡πà‡∏≤‡∏î‡∏á‡πÑ‡∏°‡πà‡∏¢‡πà‡∏≠‡∏ó‡πâ‡∏≠  ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏•‡∏Å‡∏™‡∏°‡∏±‡∏¢\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏£‡∏±‡∏Å‡∏©‡πå‡∏¢‡∏≤‡∏ß‡πÑ‡∏Å‡∏•  ‡πÉ‡∏´‡πâ‡∏õ‡πà‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ä‡∏≠‡∏∏‡πà‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå" 
    },
    { 
        gender: 'F', label: "‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏ú‡∏π‡πâ‡πÇ‡∏®‡∏Å‡πÄ‡∏®‡∏£‡πâ‡∏≤", effect: "unlucky", icon: "üåßÔ∏è", color: "text-blue-900", 
        description: "‡πÄ‡∏à‡∏≠‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÜ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î", 
        poem: "‡∏î‡∏±‡πà‡∏á‡∏°‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏Ü‡∏ö‡∏î‡∏ö‡∏±‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á  ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≠‡∏á‡πÉ‡∏™\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏°‡πÑ‡∏õ  ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏î‡∏ó‡∏ô‡∏£‡∏≠‡πÑ‡∏ü‡πÅ‡∏´‡πà‡∏á‡∏ö‡∏∏‡∏ç‡∏°‡∏≤\n‡πÇ‡∏®‡∏Å‡∏ô‡∏≤‡∏è‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏±‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå‡∏£‡πâ‡∏≤‡∏¢‡πÜ ‡∏°‡∏≤‡∏´‡∏≤‡∏ê‡∏≤‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏ó‡∏£‡∏°‡∏≤‡∏ô  ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏û‡πâ‡∏ô‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°" 
    },
    { 
        gender: 'F', label: "‡πÅ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏±‡∏ß‡∏õ‡πà‡∏≤‡∏Å‡πå", effect: "artistic", icon: "üç≤", color: "text-orange-400", 
        description: "‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏®‡∏£‡∏™‡∏à‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏Å", 
        poem: "‡∏£‡∏™‡∏°‡∏∑‡∏≠‡πÄ‡∏•‡∏¥‡∏®‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏¥‡πà‡∏ô‡∏°‡∏á‡∏Ñ‡∏•\n‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏¥‡∏î‡πÉ‡∏à‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πâ‡∏ô‡∏ó‡∏ß‡∏µ‡∏Ñ‡∏π‡πà‡∏ß‡∏á‡∏®‡πå‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•\n‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå‡πÉ‡∏´‡πâ‡πÇ‡∏•‡∏Å‡∏Å‡∏¥‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ß‡∏¥‡∏•‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏¥‡πà‡∏ô‡∏û‡∏π‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏´‡πà‡∏á‡∏£‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏ß‡∏≤‡∏à‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", effect: "spiritual", icon: "üëÑ", color: "text-orange-400", 
        description: "‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏°‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏≠", 
        poem: "‡∏ß‡∏≤‡∏à‡∏≤‡πÄ‡∏≠‡πà‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏à‡∏Å‡∏≥‡∏´‡∏ô‡∏î  ‡∏ú‡∏•‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏°‡∏ô‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô  ‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ñ‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏ô‡∏ó‡∏£\n‡∏û‡∏π‡∏î‡∏î‡∏µ‡∏î‡∏µ‡∏Å‡πá‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏≤‡∏û‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤‡∏†  ‡∏û‡∏π‡∏î‡∏£‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ö‡∏ö‡∏≤‡∏õ‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏™‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏≠‡∏ô\n‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ï‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏à‡∏¥‡∏ô‡∏ï‡πå" 
    },
    { 
        gender: 'F', label: "‡∏ò‡∏¥‡∏î‡∏≤‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß", effect: "volatile", icon: "üå†", color: "text-indigo-300", 
        description: "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå", 
        poem: "‡∏î‡∏±‡πà‡∏á‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏û‡∏£‡∏≤‡∏ß‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≥  ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå\n‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏≤‡∏°‡∏¥‡∏ï‡∏£‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ú‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ù‡∏±‡∏ô\n‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏™‡∏π‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î  ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå  ‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏õ‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå", effect: "scholar", icon: "üß†", color: "text-purple-400", 
        description: "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏∑‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï", 
        poem: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏ö  ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÉ‡∏à‡∏°‡∏±‡πà‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏±‡∏î‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô  ‡∏à‡∏≤‡∏Å‡∏≠‡∏î‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÑ‡∏Å‡∏•\n‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï  ‡πÄ‡∏ó‡∏û‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏¢\n‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏£  ‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏ô" 
    },
    { 
        gender: 'F', label: "‡∏ô‡∏≤‡∏£‡∏µ‡∏û‡∏¥‡∏ì‡∏ó‡∏¥‡∏û‡∏¢‡πå", effect: "artistic", icon: "üé∏", color: "text-rose-300", 
        description: "‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡πÑ‡∏î‡πâ‡πÑ‡∏û‡πÄ‡∏£‡∏≤‡∏∞‡∏à‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏•‡∏¥‡πâ‡∏°", 
        poem: "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏¥‡∏ì‡πÅ‡∏ß‡πà‡∏ß‡∏Å‡∏±‡∏á‡∏ß‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏•‡∏°  ‡∏Ñ‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏µ\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡∏°‡∏µ  ‡πÄ‡∏û‡∏•‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡∏û‡∏≤‡∏™‡∏∏‡∏Ç‡∏™‡∏ñ‡∏≤‡∏û‡∏£\n‡∏Å‡∏•‡πà‡∏≠‡∏°‡πÇ‡∏•‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏á‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏≥‡∏ô‡∏≠‡∏á  ‡πÑ‡∏°‡πà‡∏°‡∏±‡∏ß‡∏´‡∏°‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏≠‡∏ô\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ô‡∏≤‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏û‡∏•‡∏≠‡∏î‡∏ß‡∏≠‡∏ô  ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏¥‡∏ì‡∏ó‡∏µ‡πà‡∏Ç‡∏à‡∏£‡πÑ‡∏õ‡πÑ‡∏Å‡∏•‡πÄ‡∏≠‡∏¢" 
    },
    { 
        gender: 'F', label: "‡∏î‡∏ß‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏≤‡∏£‡∏µ", effect: "lucky", icon: "üåû", color: "text-yellow-600", 
        description: "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß ‡πÑ‡∏£‡πâ‡πÄ‡∏°‡∏Ü‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ", 
        poem: "‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏û‡∏≤‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏î‡∏±‡πà‡∏á‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏û‡∏≤‡∏û‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÑ‡∏£‡πâ\n‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ‡∏î‡∏±‡∏á‡πÉ‡∏à  ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏Å‡∏•‡∏Ç‡∏à‡∏£‡πÑ‡∏õ‡∏ó‡∏±‡πà‡∏ß‡∏ò‡∏≤‡∏ô‡∏µ\n‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô  ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå‡∏™‡∏ñ‡∏¥‡∏ï‡πÉ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà\n‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏á‡∏õ‡∏ê‡∏û‡∏µ  ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏ú‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå" 
    }
];



// ================= GLOBAL STATE =================
let appIndex = []; // List of all kingdoms [{id, kingdomName, dynastyName}]
let currentKingdomId = null;
let timeTicker = null;

let state = {
    kingdomName: "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£",
    dynastyName: "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå",
    hideAgePopUp: true, 
    worldTime: {
            year: 2568,
            month: 1,
            day: 1,
            hour: 0,
            minute: 0,
            second: 0,
            historyLog: [],
            isRunning: false,
            multiplier: 1,    // ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß x1, x10, x100
            baseTickMs: 100   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        },

      // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ ---
    kulachetHistory: [], 
    // ---------------------- 
        
    members: [],
    reignNames: ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡πÄ‡∏°‡∏ô‡∏ó‡∏£", "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏°‡∏¥‡∏ô‡∏ó‡∏£", "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡πà‡∏ß‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤", "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥"], 
  hierarchy: {
        "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": ["‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ": ["‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"],"‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": ["‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"], "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ": ["‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"] } },
        
        "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤": { 
            prefixes: [
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", 
                "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"
            ], 
            suffixes: { 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": [
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"
                ],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è": ["‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è": ["‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ": [""],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": [""],
                "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": [""]
            } 
        },
        "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤": { 
            prefixes: ["‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°"], 
            suffixes: {} 
        },
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ"] } 
        },
        "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ"] } 
        },
        "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤": { prefixes: ["‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"], suffixes: {} },
        "‡∏´‡∏°‡πà‡∏≠‡∏°": { prefixes: ["‡∏´‡∏°‡πà‡∏≠‡∏°", "‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏Ñ‡∏∏‡∏ì"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"], "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä": ["‡∏°‡∏´‡∏≤‡∏°‡∏Å‡∏∏‡∏è‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"] } },
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ö‡∏∏‡∏ï‡∏£‡∏µ‡∏ò‡∏¥‡∏£‡∏≤‡∏ä"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏ï‡∏£‡∏µ", "‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤"], "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏ï‡∏£‡∏µ"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ö‡∏∏‡∏ï‡∏£‡∏µ‡∏ò‡∏¥‡∏£‡∏≤‡∏ä": ["‡∏°‡∏´‡∏≤‡∏°‡∏Å‡∏∏‡∏è‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£‡∏µ"] } },
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏Å‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ‡πë": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡∏ö‡∏£‡∏°‡πÄ‡∏ä‡∏©‡∏ê‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡∏ö‡∏£‡∏°‡πÄ‡∏ä‡∏©‡∏ê‡∏†‡∏Ñ‡∏ô‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡∏ö‡∏£‡∏°‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡∏ö‡∏£‡∏°‡∏†‡∏Ñ‡∏ô‡∏µ"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",  "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"], suffixes: { "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤"], "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ"] } }, 
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏Ñ‡∏¥‡πÑ‡∏ô‡∏¢‡πÄ‡∏ò‡∏≠" , "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏Ñ‡∏¥‡πÑ‡∏ô‡∏¢‡πÄ‡∏ò‡∏≠","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏ï‡∏¥‡∏¢‡πÄ‡∏ò‡∏≠" , "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏ï‡∏¥‡∏¢‡πÄ‡∏ò‡∏≠" ], suffixes: {} },
        "‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä": ["‡∏™‡∏¢‡∏≤‡∏°‡∏°‡∏Å‡∏∏‡∏é‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"] } },
        "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô": { prefixes: ["‡∏ô‡∏≤‡∏¢", "‡∏ô‡∏≤‡∏á", "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß","‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå","‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á","‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á", "‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á"], suffixes: {} },
        
        "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏°‡∏≤‡∏ï‡∏∏‡∏â‡∏≤"], 
            suffixes: {
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤": [""],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏°‡∏≤‡∏ï‡∏∏‡∏â‡∏≤": [""]
            }
        },
        "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤"], 
            suffixes: {
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤": [""],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤": [""]
            }
        },
        "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏Å‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏õ‡∏¥‡∏ï‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏°‡∏≤‡∏ï‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏õ‡∏¥‡∏ï‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≠‡∏±‡∏¢‡∏Å‡∏≤"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏°‡∏≤‡∏ï‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≠‡∏±‡∏¢‡∏Å‡∏≤"] } 
        },
        "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ‡∏õ‡∏¥‡∏ï‡∏≤‡∏¢‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ‡∏°‡∏≤‡∏ï‡∏≤‡∏¢‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ‡∏õ‡∏¥‡∏ï‡∏≤‡∏¢‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≠‡∏±‡∏¢‡∏Å‡∏µ"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ‡∏°‡∏≤‡∏ï‡∏≤‡∏¢‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≠‡∏±‡∏¢‡∏Å‡∏µ"] } 
        },
        "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏Å": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏¥‡∏î‡∏≤"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠": ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏¥‡∏î‡∏≤"], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏¥‡∏î‡∏≤": [""] } 
        },
        "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤"], 
            suffixes: { 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á","‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á"], 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á"] 
            } 
        },
        "‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á": { 
            prefixes: ["‡∏´‡∏°‡∏π‡πà", "‡∏à‡πà‡∏≤", "‡∏û‡∏±‡∏ô", "‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡∏Ç‡∏∏‡∏ô", "‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞", "‡∏à‡∏°‡∏∑‡πà‡∏ô", "‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤"], 
            suffixes: { "‡∏´‡∏°‡∏π‡πà": [""], "‡∏à‡πà‡∏≤": [""], "‡∏û‡∏±‡∏ô": [""], "‡∏´‡∏°‡∏∑‡πà‡∏ô": [""], "‡∏Ç‡∏∏‡∏ô": [""], "‡∏´‡∏•‡∏ß‡∏á": [""], "‡∏û‡∏£‡∏∞": [""], "‡∏à‡∏°‡∏∑‡πà‡∏ô": [""], "‡∏û‡∏£‡∏∞‡∏¢‡∏≤": [""], "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤": [""], "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤": [""] } 
        },
        "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤": ["‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•"] } 
        },
        "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤"], 
            suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤": ["‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç"] } 
        },

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ---
        "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"], 
            suffixes: {} 
        },
        "‡∏û‡∏£‡∏∞‡∏õ‡∏±‡∏¢‡∏Å‡∏≤": { 
            prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏°‡∏´‡∏±‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏°‡∏´‡∏±‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠"], 
            suffixes: { 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏°‡∏´‡∏±‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏õ‡∏±‡∏¢‡∏Å‡∏≤‡∏ö‡∏î‡∏µ"], 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏°‡∏´‡∏±‡∏¢‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏õ‡∏±‡∏¢‡∏Å‡∏≤‡∏ö‡∏î‡∏µ"] } 
        }
    },
    prefixScores: {}, 
    suffixScores: {}, 
    currentTheme: 'white',
    zoom: 1, panX: window.innerWidth/2, panY: 50, isDragging: false, isHorizontal: false,
    viewRootId: null, 
    viewMode: 'tree',
    treeViewType: 'all', 
    currentSurnameRootId: null, 
    currentReignFilter: 'all', 
    highlightIds: [] 
};

// ================= INITIALIZATION & KINGDOM MANAGEMENT =================
let targetOriginIdForSpouse = null; // NEW: Global state to hold the person ID requesting a spouse

window.onload = () => {
    loadAppIndex();
    
    // Check if we have any kingdoms
    if(appIndex.length === 0) {
        // Try to migrate from old single-save version
        const oldSave = localStorage.getItem('royal_tree_v2');
        if(oldSave) {
            const oldData = JSON.parse(oldSave);
            createNewKingdom(oldData.kingdomName || "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏î‡∏¥‡∏°", oldData.dynastyName || "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏î‡∏¥‡∏°", oldData);
            localStorage.removeItem('royal_tree_v2'); // Clean up old save
        } else {
            document.getElementById('initialSetupModal').classList.add('active');
        }
    } else {
        // Load the last used kingdom or the first one
        const lastId = localStorage.getItem('royal_tree_last_id');
        if(lastId && appIndex.find(k => k.id === lastId)) {
            switchKingdom(lastId);
        } else {
            switchKingdom(appIndex[0].id);
        }
    }
    
    setupPanZoom();
};

function loadAppIndex() {
    const raw = localStorage.getItem('royal_tree_index');
    appIndex = raw ? JSON.parse(raw) : [];
    renderKingdomSelector();
}

function saveAppIndex() {
    localStorage.setItem('royal_tree_index', JSON.stringify(appIndex));
    renderKingdomSelector();
}

function renderKingdomSelector() {
    const sel = document.getElementById('kingdomSelector');
    sel.innerHTML = '';
    appIndex.forEach(k => {
        const op = document.createElement('option');
        op.value = k.id;
        op.innerText = k.kingdomName + " (" + k.dynastyName + ")";
        if(k.id === currentKingdomId) op.selected = true;
        sel.appendChild(op);
    });
}

function createNewKingdom(kName, dName, initialData = null) {
    const newId = 'kingdom_' + Date.now();
    const meta = { id: newId, kingdomName: kName, dynastyName: dName };
    appIndex.push(meta);
    saveAppIndex();

    // Init state for new kingdom
    let newState = JSON.parse(JSON.stringify(state)); // Clone default
    if(initialData) newState = {...newState, ...initialData};
    newState.kingdomName = kName;
    newState.dynastyName = dName;
    newState.members = initialData ? initialData.members : [];
    
    // Save new kingdom data
    localStorage.setItem('royal_tree_data_' + newId, JSON.stringify(newState));
    
    switchKingdom(newId);
}

function updateSpouseLabelToggle(checked) {
    state.showSpouseLabel = checked;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤ Modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const modal = document.getElementById('memberDetailModal');
    if (modal && !modal.classList.contains('hidden')) {
        const currentId = document.getElementById('d_id')?.innerText;
        if (currentId) showDetail(currentId);
    }
}

function switchKingdom(id) {
    currentKingdomId = id;
    localStorage.setItem('royal_tree_last_id', id);
    
    const dataRaw = localStorage.getItem('royal_tree_data_' + id);
    if(dataRaw) {
        state = JSON.parse(dataRaw);
    } else {
        // Fallback should not happen normally
        state.members = [];
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ---
    if (timeTicker) clearInterval(timeTicker); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    if (state.worldTime && state.worldTime.isRunning) {
        timeTicker = setInterval(tick, state.worldTime.baseTickMs);
        const btn = document.getElementById('btnTimePlay');
        if(btn) btn.innerHTML = '<i class="fa-solid fa-pause text-[9px]"></i>';
    } else {
        timeTicker = null;
        const btn = document.getElementById('btnTimePlay');
        if(btn) btn.innerHTML = '<i class="fa-solid fa-play text-[9px]"></i>';
    }
    updateTimeUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
    // ------------------------------------------

    // Init scores if missing from old save
    if(!state.prefixScores) state.prefixScores = {};
    if(!state.suffixScores) state.suffixScores = {};
    
    // Init new surname state if missing
    if(!state.currentSurnameRootId) state.currentSurnameRootId = null;
    if(!state.currentReignFilter) state.currentReignFilter = 'all';

    // Update UI
    document.getElementById('kingdomSelector').value = id;
    document.getElementById('dynastyLabel').innerText = state.dynastyName;
    setTheme(state.currentTheme || 'white');
    
    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡πä‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ ---
    const toggleSpouseBtn = document.getElementById('toggleSpouseLabel');
    if (toggleSpouseBtn) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô state ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô false (‡∏ã‡πà‡∏≠‡∏ô) ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
        toggleSpouseBtn.checked = !!state.showSpouseLabel;
    }

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà]: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡πä‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô Pop-up ---
    const toggleHideAgeBtn = document.getElementById('toggleHideAge');
    if (toggleHideAgeBtn) {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ hideAgePopUp ‡∏à‡∏≤‡∏Å state ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà Checkbox
        toggleHideAgeBtn.checked = !!state.hideAgePopUp;
    }

    // Restore View Settings
    document.getElementById('treeViewMode').value = state.treeViewType || 'all';
    
    updateApp();
}

function deleteCurrentKingdom() {
    if(appIndex.length <= 1) {
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ");
        return;
    }
    if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ "${state.kingdomName}" ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£`)) return;

    localStorage.removeItem('royal_tree_data_' + currentKingdomId);
    appIndex = appIndex.filter(k => k.id !== currentKingdomId);
    saveAppIndex();
    
    switchKingdom(appIndex[0].id);
    showToast("‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

function completeInitialSetup() { 
    const kName = document.getElementById('setupKingdomName').value || "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£"; 
    const dName = document.getElementById('setupDynastyName').value || "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå"; 
    createNewKingdom(kName, dName);
    closeModal('initialSetupModal'); 
}

function openCreateKingdomModal() {
    document.getElementById('setupKingdomName').value = "";
    document.getElementById('setupDynastyName').value = "";
    document.getElementById('initialSetupModal').classList.add('active');
}

function applyRoyalMarriageRules(female, male) {
    if (!female || !male || female.gender !== 'F') return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 0: ‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏ã‡πâ‡∏≥) ---
    if (female.isAutoTitled) return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
    const isMonarch = female.isMonarch;
    const isHeir1 = female.isHeir && parseInt(female.heirOrder) === 1;
    if (isMonarch || isHeir1) return;

    const royalRanks = ['‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)', '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)', '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)', '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)', '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)', '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)', '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'];
    const isFemaleRoyal = royalRanks.includes(female.royalRank);
    const isFemaleMRML = ['‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(female.royalRank);
    const isMaleRoyal = (male.royalRank && !['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(male.royalRank));

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏•‡∏≤‡∏≠‡∏≠‡∏Å) ---
    if (isFemaleRoyal && !isMaleRoyal) {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤, ‡∏™‡∏£‡πâ‡∏≠‡∏¢, ‡∏Å‡∏£‡∏°, ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°)
        female.originalRoyalRank = female.royalRank;
        female.originalTitlePrefix = female.titlePrefix;
        female.originalTitleSuffix = female.titleSuffix; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°
        female.originalKromRank = female.kromRank;       // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏®‡∏Å‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°
        female.originalKromTitle = female.kromTitle;     // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°
        female.originalRoyalSurname = female.royalSurname; // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡∏ì... ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®

        // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        female.isResigned = true;
        female.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
        female.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
        female.titlePrefix = "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á";
        female.isAutoTitled = true; 

        // [‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏µ] 
        female.surname = male.surname || "";           // 1. ‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏µ
        female.royalSurname = "";                      // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ "‡∏ì..." ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡πÜ

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏≠‡∏≠‡∏Å (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ)
        female.kromRank = "";
        female.kromTitle = "";
        female.titleSuffix = ""; // ‡∏•‡∏ö‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà ‡∏ä‡∏∑‡πà‡∏≠ + ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏µ

        // [‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á + ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏µ" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
        if (typeof recordTitleHistory === 'function') {
            recordTitleHistory(female);
        }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏£‡∏ì‡∏µ‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏≤‡∏¢ ---
    else if (isMaleRoyal) {
        const husbandSurname = male.royalSurname || male.surname || "";
        
        if (isFemaleRoyal || isFemaleMRML) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏£‡∏ß./‡∏°‡∏•. ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏µ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°)
            female.surname = husbandSurname;
            female.isAutoTitled = true; 

        } else {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ç‡∏¥‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ---
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏® (royalRank) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (relationship) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
            const isReallyCommoner = (!female.royalRank || female.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') && 
                                     (!female.relationship || female.relationship === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô');

            if (isReallyCommoner) {
                female.originalSurname = female.surname; 
                female.relationship = "‡∏´‡∏°‡πà‡∏≠‡∏°";
                female.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°";
                female.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
                female.surname = `${husbandSurname} ‡∏ì ${state.kingdomName}`;
                
                female.isAutoTitled = true; // ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                
                // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°] ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
                if (typeof showToast === "function") {
                    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`);
                }

                if (typeof recordTitleHistory === 'function') {
                    recordTitleHistory(female);
                }
            }
        }
    }
}

function saveState() { 
    if(!currentKingdomId) return;
    localStorage.setItem('royal_tree_data_' + currentKingdomId, JSON.stringify(state)); 
    
    // Update index name if changed
    const idx = appIndex.findIndex(k => k.id === currentKingdomId);
    if(idx !== -1) {
        if(appIndex[idx].kingdomName !== state.kingdomName || appIndex[idx].dynastyName !== state.dynastyName) {
            appIndex[idx].kingdomName = state.kingdomName;
            appIndex[idx].dynastyName = state.dynastyName;
            saveAppIndex();
        }
    }
}


// --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ---
function markPhraKulachet() {
    // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    state.members.forEach(m => {
        m.isPhraKulachet = false;
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° property ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå
        if (typeof m.wasPhraKulachet === 'undefined') m.wasPhraKulachet = false;
    });

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï + ‡∏¢‡∏®‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)
    const candidates = state.members.filter(m => {
        if (!m.isAlive) return false; // ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï

        const r = (m.royalRank || "").trim();
        // ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        if (m.isMonarch || m.isQueenConsort) return true;

        // ‡∏ï‡∏±‡∏î‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏≠‡∏Å (‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤, ‡∏°.‡∏£.‡∏ß., ‡∏°.‡∏•., ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)
        if (r.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") || r.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå") || 
            r.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á") || r === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô") {
            return false;
        }

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏®‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á (‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤, ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤, ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à)
        const validKeywords = ["‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à"];
        return validKeywords.some(k => r.includes(k));
    });

    if (candidates.length === 0) return;

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÅ‡∏Å‡πà‡∏™‡∏∏‡∏î) -> ‡∏¢‡∏® (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
    candidates.sort((a, b) => {
        // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏µ
        const yA = parseInt(a.birthYear) || 9999;
        const yB = parseInt(b.birthYear) || 9999;
        if (yA !== yB) return yA - yB;
        // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const mA = parseInt(a.birthMonth) || 0;
        const mB = parseInt(b.birthMonth) || 0;
        if (mA !== mB) return mA - mB;
        // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô
        const dA = parseInt(a.birthDay) || 0;
        const dB = parseInt(b.birthDay) || 0;
        if (dA !== dB) return dA - dB;
        // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏® (‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
        return calculatePojiamScore(b) - calculatePojiamScore(a);
    });

    // 4. ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå
    candidates[0].isPhraKulachet = true;

    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ï‡πà‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
    state.members.forEach(m => {
        if (!m.isAlive && m.wasPhraKulachet === false) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            const history = getPhraKulachetHistory();
            const found = history.find(h => h.member.id === m.id && !h.isCurrent);
            if (found) m.wasPhraKulachet = true;
        }
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ---
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (‡∏≠‡∏î‡∏µ‡∏ï + ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ---
// ==========================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Loop ‡∏û‡∏±‡∏á)
// ==========================================
function getPhraKulachetHistory() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å (World Time) ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    const currentSimYear = (state && state.worldTime && !isNaN(state.worldTime.year)) 
        ? parseInt(state.worldTime.year) 
        : new Date().getFullYear() + 543;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡∏® (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    const getRankScore = (m) => {
        let s = 0;
        const r = (m.royalRank || "").trim();
        if (m.isMonarch) s += 1000;
        if (r.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) s += 100;
        if (r.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) s += 50;
        return s;
    };

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (Pre-process)
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô NaN
    let candidates = state.members.filter(m => {
        const r = (m.royalRank || "").trim();
        const validRank = ["‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à"].some(k => r.includes(k)) 
                          || m.isMonarch || m.isQueenConsort;
        const hasBirthYear = !isNaN(parseInt(m.birthYear));
        return validRank && hasBirthYear;
    }).map(m => {
        const bY = parseInt(m.birthYear);
        let dY = 99999; // ‡∏Ñ‡πà‡∏≤ Default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï

        // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏õ‡∏µ‡∏ï‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏µ‡∏ï‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å 90
        if (!m.isAlive) {
            const specifiedDeath = parseInt(m.deathYear);
            dY = (!isNaN(specifiedDeath) && specifiedDeath > 0) ? specifiedDeath : (bY + 90);
        }
        
        return { 
            original: m, // ‡πÄ‡∏Å‡πá‡∏ö object ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ
            id: m.id, 
            bY: bY, 
            dY: dY 
        };
    });

    if (candidates.length === 0) return [];

    // 3. ‡∏´‡∏≤‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏à‡∏≤‡∏Å NaN)
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
    const sortedByBirth = [...candidates].sort((a, b) => a.bY - b.bY);
    const startYear = sortedByBirth[0].bY;

    let history = [];
    let currentHolder = null;
    let periodStart = startYear;

    // 4. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÑ‡∏•‡πà‡∏õ‡∏µ (Timeline Simulation)
    for (let y = startYear; y <= currentSimYear; y++) {
        // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏µ y
        const aliveInYear = candidates.filter(c => c.bY <= y && c.dY >= y);

        // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏•‡∏¢ (‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡πâ‡∏ô)
        if (aliveInYear.length === 0) {
            if (currentHolder) {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏ö‡∏ä‡πà‡∏ß‡∏á
                history.push({
                    member: currentHolder.original,
                    start: periodStart,
                    end: y - 1,
                    isCurrent: false
                });
                currentHolder = null;
            }
            continue;
        }

        // ‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° aliveInYear
        // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô (bY ‡∏ô‡πâ‡∏≠‡∏¢) ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏î‡∏π‡∏¢‡∏®
        aliveInYear.sort((a, b) => {
            if (a.bY !== b.bY) return a.bY - b.bY;
            return getRankScore(b.original) - getRankScore(a.original);
        });

        const winner = aliveInYear[0];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        if (!currentHolder) {
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
            currentHolder = winner;
            periodStart = y;
        } else if (currentHolder.id !== winner.id) {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∑‡∏≠ (‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏Å‡πà‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤)
            history.push({
                member: currentHolder.original,
                start: periodStart,
                end: y - 1,
                isCurrent: false
            });
            currentHolder = winner;
            periodStart = y;
        }
    }

    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Current)
    if (currentHolder) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏Ç‡∏≤‡∏ï‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
        const isActuallyAlive = currentHolder.original.isAlive;
        history.push({
            member: currentHolder.original,
            start: periodStart,
            end: isActuallyAlive ? currentSimYear : currentHolder.dY, // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            isCurrent: isActuallyAlive
        });
    }

    return history;
}

function updatePhraKulachetHistory() {
    // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Timeline
    const history = getPhraKulachetHistory();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á "‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå" ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á render ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const filterStatus = document.getElementById('tableFilterStatus')?.value;
    if (filterStatus === 'kulachet') {
        renderTable(); 
    }
}

function updateApp() {
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
    state.members.forEach(member => {
        member.pojiamScore = calculatePojiamScore(member);
    });

    // ---‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
    markPhraKulachet(); 
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    if (typeof updatePhraKulachetHistory === 'function') {
        updatePhraKulachetHistory();
    }
    // ---------------------------------

    // 2. [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏•‡∏π‡∏Å‡∏ú‡∏™‡∏° (Hybrid Sort)
    state.members.sort((a, b) => {
        // ‡πÉ‡∏ä‡πâ customPrecedence (‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pojiamScore (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é)
        const scoreA = a.customPrecedence !== undefined ? a.customPrecedence : (a.pojiamScore || 0);
        const scoreB = b.customPrecedence !== undefined ? b.customPrecedence : (b.pojiamScore || 0);
        return scoreB - scoreA; // ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
    });

    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
    if(state.viewMode === 'tree') renderTree();
    else renderTable();
    renderMonarchBanner();
    populateSearchLists();
}

// ================= VIEW LOGIC =================

// ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateApp()
function refreshAllDisplays() {
    updateApp(); // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ú‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
    if (typeof showDetail === 'function' && window.curPID) {
        showDetail(window.curPID);
    }
}

function switchView(mode) {
    state.viewMode = mode;
    saveState();
    const treeBtn = document.getElementById('btn-view-tree');
    const tableBtn = document.getElementById('btn-view-table');
    const canvas = document.getElementById('canvas-container');
    const table = document.getElementById('tableView');

    if(mode === 'tree') {
        canvas.classList.remove('hidden'); table.classList.add('hidden');
        treeBtn.style.background = "var(--primary)"; treeBtn.style.color = "white";
        tableBtn.style.background = "transparent"; tableBtn.style.color = "#64748b";
        renderTree();
    } else {
        canvas.classList.add('hidden'); table.classList.remove('hidden');
        tableBtn.style.background = "var(--primary)"; tableBtn.style.color = "white";
        treeBtn.style.background = "transparent"; treeBtn.style.color = "#64748b";
        renderTable();
    }
}

function changeRoyalSurnameRoot(founderId) {
    state.currentSurnameRootId = founderId;
    saveState();
    renderTree();
    resetView();
}

function changeRoyalSurnameFilter(reignId = null) {
    const selectedReignId = reignId || document.getElementById('reignFilterSelector').value;
    state.currentReignFilter = selectedReignId;
    
    let founders = getRoyalSurnameFounders(); // Get all founders

    // Filter founders based on selected Reign (Monarch's descendant)
    if (selectedReignId !== 'all') {
        const descendantIds = getMonarchDescendants(selectedReignId);
        // A founder is included if they are a descendant of the selected monarch OR if they *are* the monarch.
        // NOTE: A Monarch can also be a founder of a Royal Surname.
        founders = founders.filter(f => descendantIds.has(f.id) || f.id === selectedReignId);
    }

    // Update the Royal Surname Selector dropdown with the filtered list
    populateRoyalSurnameSelector(founders); 

    // Reset current root if the previous one is filtered out
    if (state.currentSurnameRootId && !founders.some(f => f.id === state.currentSurnameRootId)) {
        state.currentSurnameRootId = founders.length > 0 ? founders[0].id : null;
    } else if (!state.currentSurnameRootId && founders.length > 0) {
        state.currentSurnameRootId = founders[0].id;
    }
    
    saveState();
    renderTree(); // Re-render with the new root/filters
    updateSurnameHeader();
}

function changeViewMode(mode) {
    state.treeViewType = mode;
    const surnameSelector = document.getElementById('royalSurnameSelector');
    const surnameHeader = document.getElementById('surnameViewHeader');
    const reignFilterSelector = document.getElementById('reignFilterSelector');

    if (mode === 'royalSurname') {
        populateReignFilterSelector();
        reignFilterSelector.classList.remove('hidden');
        
        // This will now call changeRoyalSurnameFilter, which populates the surname selector
        changeRoyalSurnameFilter(state.currentReignFilter); 

        surnameSelector.classList.remove('hidden');
        surnameHeader.classList.remove('hidden');
        updateSurnameHeader();
    } else {
        surnameSelector.classList.add('hidden');
        surnameHeader.classList.add('hidden');
        reignFilterSelector.classList.add('hidden');
    }

    saveState();
    renderTree();
    resetView();
    showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: ${document.querySelector('#treeViewMode option[value="'+mode+'"]').text}`);
}

function findAbsoluteRoot(startId) {
    if(!startId) return null;
    let curr = state.members.find(m => m.id === startId);
    if(!curr) return null;
    let guard = 0;
    while((curr.fatherId || curr.motherId) && guard < 50) {
        let parent = null;
        if(curr.fatherId) parent = state.members.find(m => m.id === curr.fatherId);
        if(!parent && curr.motherId) parent = state.members.find(m => m.id === curr.motherId);
        
        if(parent) curr = parent;
        else break;
        guard++;
    }
    return curr.id;
}

function getDirectLineMembers(focusId) {
    const directIds = new Set();
    const spousesToAdd = new Set();
    
    let curr = state.members.find(m => m.id === focusId);
    while(curr) {
        directIds.add(curr.id);
        if(curr.spouseIds) curr.spouseIds.forEach(s => spousesToAdd.add(s));
        if(curr.fatherId) curr = state.members.find(m => m.id === curr.fatherId);
        else if(curr.motherId) curr = state.members.find(m => m.id === curr.motherId);
        else curr = null;
    }

    function addDescendants(pid) {
        const children = state.members.filter(m => m.fatherId === pid || m.motherId === pid);
        children.forEach(c => {
            directIds.add(c.id);
            if(c.spouseIds) c.spouseIds.forEach(s => spousesToAdd.add(s));
            addDescendants(c.id);
        });
    }
    addDescendants(focusId);

    spousesToAdd.forEach(s => directIds.add(s));
    return state.members.filter(m => directIds.has(m.id));
}

function getRoyalSurnameFounders() {
    // Note: Use isRoyalSurnameFounder flag to correctly identify the designated founder, 
    // even if other people have the same surname property (due to inheritance).
    return state.members.filter(m => m.isRoyalSurnameFounder && m.royalSurname && m.royalSurname.trim() !== '')
                        .sort((a, b) => a.royalSurname.localeCompare(b.royalSurname, 'th'));
}

// NEW HELPER: Find the founder ID of the royal surname a person belongs to.
function getSurnameFounderForPerson(id) {
    const p = state.members.find(m => m.id === id);
    if (!p || !p.royalSurname) return null;

    // Find the member who is designated as the founder and has the same royalSurname
    const founder = state.members.find(m => m.isRoyalSurnameFounder && m.royalSurname === p.royalSurname);
    
    // Fallback: If no designated founder found, but the person themselves is the founder, use them.
    if (p.isRoyalSurnameFounder && p.royalSurname && !founder) return p.id;
    
    return founder ? founder.id : null;
}
// END NEW HELPER

function getMonarchsByReign() {
    return state.members.filter(m => m.isMonarch && m.globalReignNumber)
                        .sort((a, b) => parseInt(a.globalReignNumber) - parseInt(b.globalReignNumber));
}

// [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤ ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏∑‡∏ö‡∏™‡∏≤‡∏¢‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á)
function getMonarchDescendants(monarchId) {
    const descendants = new Set();
    const queue = [monarchId];
    
    while (queue.length > 0) {
        const currentId = queue.shift();
        const member = state.members.find(m => m.id === currentId);
        
        if (member && member.childrenIds) {
            member.childrenIds.forEach(childId => {
                if (!descendants.has(childId)) {
                    descendants.add(childId);
                    queue.push(childId);
                }
            });
        }
    }
    return descendants;
}

function populateReignFilterSelector() {
    const sel = document.getElementById('reignFilterSelector');
    sel.innerHTML = '<option value="all">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•... (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>';
    
    const monarchs = getMonarchsByReign();
    monarchs.forEach(m => {
        const rNum = toThaiNumerals(m.globalReignNumber);
        const op = document.createElement('option');
        op.value = m.id; // Filter by the Monarch's ID
        op.innerText = `‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${rNum} (${m.name})`;
        if (m.id === state.currentReignFilter) op.selected = true;
        sel.appendChild(op);
    });
}

function populateRoyalSurnameSelector(founders) {
    const sel = document.getElementById('royalSurnameSelector');
    sel.innerHTML = '';
    
    if (founders.length === 0) {
        sel.innerHTML = '<option value="">(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</option>';
        return;
    }

    founders.forEach(f => {
        const op = document.createElement('option');
        op.value = f.id;
        op.innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.${f.royalSurname} (${f.name})`;
        if (f.id === state.currentSurnameRootId) op.selected = true;
        sel.appendChild(op);
    });
}

function updateSurnameHeader() {
    const founder = state.members.find(m => m.id === state.currentSurnameRootId);
    if (founder) {
        document.getElementById('surnameHeaderName').innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.${founder.royalSurname}`;
    } else {
         document.getElementById('surnameHeaderName').innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•. (‡πÑ‡∏°‡πà‡∏û‡∏ö)`;
    }
}

function getRoyalSurnameMembers(founderId) {
    const founder = state.members.find(m => m.id === founderId);
    if (!founder || !founder.royalSurname) return [];

    const lineageIds = new Set();
    const currentSurname = founder.royalSurname;

    function addDescendants(id, currentSurnameRoot) {
        const p = state.members.find(m => m.id === id);
        if (!p || lineageIds.has(id)) return;

        // 1. ‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏¢‡∏Å‡∏™‡∏≤‡∏¢)
        if (p.id !== founderId && p.isRoyalSurnameFounder && p.royalSurname && p.royalSurname !== currentSurnameRoot) {
            return;
        }

        lineageIds.add(id);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö 1
        const isExceptionalFemale = (p.gender === 'F') && (p.isMonarch || (p.isHeir && parseInt(p.heirOrder) === 1));

        // 2. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (Spouses)
        if (p.gender === 'M' || p.id === founderId || isExceptionalFemale) {
            (p.spouseIds || []).forEach(sid => {
                const spouse = state.members.find(s => s.id === sid);
                if (spouse) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ExceptionalFemale ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô block ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                    lineageIds.add(sid);
                }
            });
        }

        // 3. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å (Children)
        state.members.filter(c => c.fatherId === id || c.motherId === id)
            .forEach(c => {
                let shouldFollow = false;

                // ‡∏™‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏±‡∏ß Founder ‡πÄ‡∏≠‡∏á: ‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏•‡∏π‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠)
                if (p.gender === 'M' || p.id === founderId) {
                    if (c.fatherId === id) shouldFollow = true;
                } 
                
                // ‡∏™‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á: ‡∏ï‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                else if (p.gender === 'F' && c.motherId === id) {
                    if (isExceptionalFemale) {
                        shouldFollow = true;
                    }
                    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ExceptionalFemale ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà follow ‡∏ï‡πà‡∏≠ 
                    // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏ú‡πà‡∏≤‡∏ô getRoyalSurnameMembers ‡∏Ç‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏û‡πà‡∏≠‡πÄ‡∏Ç‡∏≤‡πÄ‡∏≠‡∏á
                }

                if (shouldFollow) {
                    addDescendants(c.id, currentSurnameRoot);
                }
            });
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Ancestors (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Tree)
    function addAncestorsToFounder(id) {
        const p = state.members.find(m => m.id === id);
        if (!p || lineageIds.has(id)) return;
        
        lineageIds.add(id);
        // (Logic Spouse ‡∏Ç‡∏≠‡∏á Ancestor ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÑ‡∏î‡πâ)
        
        if (p.id === founderId) return; 
        if (p.fatherId) addAncestorsToFounder(p.fatherId);
    }

    addDescendants(founderId, currentSurname);
    addAncestorsToFounder(founderId);

    return state.members.filter(m => lineageIds.has(m.id));
}

function renderTree() {
    const focusId = state.viewRootId || (state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch)?.id) || (state.members[0]?.id);
    
    // Toggle surname controls visibility (for persistence on reload)
    const surnameSelector = document.getElementById('royalSurnameSelector');
    const surnameHeader = document.getElementById('surnameViewHeader');
    const reignFilterSelector = document.getElementById('reignFilterSelector');
    const isSurnameView = state.treeViewType === 'royalSurname';
    
    surnameSelector.classList.toggle('hidden', !isSurnameView);
    surnameHeader.classList.toggle('hidden', !isSurnameView);
    reignFilterSelector.classList.toggle('hidden', !isSurnameView);

    if(!focusId) { document.getElementById('empty-state').classList.remove('hidden'); return; }
    document.getElementById('empty-state').classList.add('hidden');

    const svgL = document.getElementById('links-layer');
    const svgN = document.getElementById('nodes-layer');
    svgL.innerHTML = ''; svgN.innerHTML = '';

    let renderRootId = focusId;
    let membersToRender = state.members;
    

    if (state.treeViewType === 'all' || state.treeViewType === 'all_v2') { 
    renderRootId = findAbsoluteRoot(focusId);
    membersToRender = state.members;
} else if (state.treeViewType === 'descendants') {
        renderRootId = focusId;
        membersToRender = state.members;
    } else if (state.treeViewType === 'direct') {
        renderRootId = findAbsoluteRoot(focusId);
        membersToRender = getDirectLineMembers(focusId);
    } else if (state.treeViewType === 'ancestors') {
        const layout = calculateAncestryLayout(focusId);
        // FIX: Use c.fromUUID and c.toUUID to find nodes based on layoutId
        layout.connections.forEach(c => {
            const f = layout.nodes.find(n => n.layoutId === c.fromUUID);
            const t = layout.nodes.find(n => n.layoutId === c.toUUID);
            // In Ancestor View, isSpouse is always false
            if(f && t) drawLink(f, t, false, svgL); 
        });
        layout.nodes.forEach(n => drawNode(n, svgN));
        return;
    } else if (isSurnameView) {
        // Handle Royal Surname View
        
        // This is necessary to ensure the selectors are correctly populated on direct load/rerender
        // if changeViewMode wasn't called (e.g., after focus change).
        if (!document.getElementById('reignFilterSelector').options.length > 1) {
             populateReignFilterSelector();
        }
        
        if (reignFilterSelector.value !== state.currentReignFilter || surnameSelector.options.length === 0) {
             changeRoyalSurnameFilter(state.currentReignFilter);
        }

        if (!state.currentSurnameRootId) {
             surnameHeader.classList.add('hidden');
             document.getElementById('empty-state').classList.remove('hidden');
             return;
        }
        updateSurnameHeader();
        
        membersToRender = getRoyalSurnameMembers(state.currentSurnameRootId);
        if (membersToRender.length === 0) {
            const founder = state.members.find(m => m.id === state.currentSurnameRootId);
            if (founder) membersToRender.push(founder);
        }
        
        if (membersToRender.length === 0) {
             document.getElementById('empty-state').classList.remove('hidden');
             return;
        }

        // Use the founder ID as the root for layout calculation
        renderRootId = state.currentSurnameRootId; 
    }


    const layout = calculateTreeLayout(renderRootId, membersToRender);
    
    layout.connections.forEach(c => {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Node ‡∏à‡∏≤‡∏Å layoutId (UUID) ‡πÅ‡∏ó‡∏ô ID ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        const f = layout.nodes.find(n => n.layoutId === c.fromUUID);
        const t = layout.nodes.find(n => n.layoutId === c.toUUID);
        if(f && t) drawLink(f, t, c.isSpouse, svgL);
    });
    layout.nodes.forEach(n => drawNode(n, svgN));
}

 function calculateAncestryLayout(rootId) {
    const nodes = [];
    const connections = [];
    
    // --- [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    const maxGen = 5; // ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏´‡∏£‡∏∑‡∏≠ 6 ‡∏£‡∏∏‡πà‡∏ô ‡∏ú‡∏±‡∏á‡∏à‡∏∞‡∏Å‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    
    const config = ANCESTOR_CONFIG;

    function getRelName(path) {
        if(path === "") return "‡∏ï‡∏ô‡πÄ‡∏≠‡∏á";
        const p = path.toLowerCase();
        if(p === "f") return "‡∏û‡πà‡∏≠";
        if(p === "m") return "‡πÅ‡∏°‡πà";
        if(p === "ff") return "‡∏õ‡∏π‡πà";
        if(p === "fm") return "‡∏¢‡πà‡∏≤";
        if(p === "mf") return "‡∏ï‡∏≤";
        if(p === "mm") return "‡∏¢‡∏≤‡∏¢";
        if(p.length >= 3) {
             const prefix = "‡∏ó‡∏ß‡∏î".repeat(p.length - 2); // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏ó‡∏ß‡∏î, ‡πÄ‡∏ó‡∏µ‡∏¢‡∏î, ‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
             return prefix;
        }
        return "";
    }

    function addAncestor(id, gen, path, spreadOffset, currentRange) {
        if (gen > maxGen) return;
        const p = state.members.find(m => m.id === id);
        if (!p) return;
        
        const ancestorLayoutId = `ancestor_${id}_${gen}_${path}`;
        let x, y;

        if(state.isHorizontal) {
            x = gen * (config.nodeWidth + config.gapX);
            y = spreadOffset;
        } else {
            x = spreadOffset;
            y = -(gen * (config.nodeHeight + config.gapY));
        }

        nodes.push({ data: p, x, y, type: 'ancestor', ancestorLabel: getRelName(path), layoutId: ancestorLayoutId });

        const nextRange = currentRange / 2;
        
        if (p.fatherId) {
            const fOffset = spreadOffset - nextRange;
            addAncestor(p.fatherId, gen + 1, path + "f", fOffset, nextRange);
            connections.push({ fromUUID: ancestorLayoutId, toUUID: `ancestor_${p.fatherId}_${gen + 1}_${path}f`, isSpouse: false });
        }
        
        if (p.motherId) {
            const mOffset = spreadOffset + nextRange;
            addAncestor(p.motherId, gen + 1, path + "m", mOffset, nextRange);
            connections.push({ fromUUID: ancestorLayoutId, toUUID: `ancestor_${p.motherId}_${gen + 1}_${path}m`, isSpouse: false });
        }
    }

    // --- [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Dynamic ---
    // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á + ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü
    const safeSpace = state.isHorizontal ? (config.nodeHeight + 50) : (config.nodeWidth + 80);
    
    // ‡∏™‡∏π‡∏ï‡∏£: 2^(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô - 1) * ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    const initialRange = Math.pow(2, maxGen - 1) * safeSpace;
    
    addAncestor(rootId, 0, "", 0, initialRange);
    
    return { nodes, connections };
}
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏Ç‡∏ß‡πâ]
  function calculateTreeLayout(rootId, memberList) {
        if(!rootId) return { nodes:[], connections:[] };
        
        // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ "‡∏Å‡∏•‡πà‡∏≠‡∏á" ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const uuid = () => 'layout_' + Math.random().toString(36).substr(2, 9);
        
        // Priority 1: Use Birth Year for children sorting (oldest first)
        const childSortFn = (a, b) => {
            const aYear = parseInt(a.birthYear) || Infinity;
            const bYear = parseInt(b.birthYear) || Infinity;
            if (aYear !== bYear) return aYear - bYear;
            return a.id.localeCompare(b.id); 
        };
        
        const config = state.isHorizontal ? {...BASE_CONFIG, gapX: 40, gapY: 250} : BASE_CONFIG;
        const nodes = []; 
        const connections = []; 

        function build(pid, level) {
            const p = getP(pid);
            if(!p) return { width: config.nodeWidth, nodes: [] };

            const myLayoutId = uuid();

            let spouses = (p.spouseIds || []).map(id => getP(id)).filter(s => s);
            
         // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏∏‡∏ï‡∏£‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î All View (v2) ---
const children = memberList.filter(m => {
    const isChild = m.fatherId === pid || m.motherId === pid;
    if (!isChild) return false;

    // ‡∏Å‡∏é‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î All View (v2): ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    if (state.treeViewType === 'all_v2') {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
        const father = memberList.find(x => x.id === m.fatherId);
        const mother = memberList.find(x => x.id === m.motherId); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡πÅ‡∏°‡πà ---
        if (mother && mother.isMonarch) {
            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î (p) ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            if (p.id === mother.id) return true;
            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î (p) ‡∏Ñ‡∏∑‡∏≠‡∏û‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ú‡∏±‡∏á‡∏£‡∏ß‡∏°
            if (father && p.id === father.id) return false;
        }
        // ---------------------------------------------------------

        // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡πÅ‡∏°‡πà" (F) ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        if (p.gender === 'F' && father) {
            // ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà "‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠" ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î (‡∏°‡∏µ‡∏ö‡∏¥‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏ú‡∏±‡∏á)
            // ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏Ç‡∏¢" (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö) ‡∏•‡∏π‡∏Å‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            if (father.fatherId || father.motherId) {
                return false;
            }
        }
    }
    return true;
}).sort(childSortFn);
// --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

            const groups = [];
            spouses.forEach(s => {
                const kids = children.filter(c => c.fatherId === s.id || c.motherId === s.id);
                groups.push({ spouse: s, children: kids });
            });

            const accountedChildrenIds = new Set(groups.flatMap(g => g.children.map(c => c.id)));
            const loneChildren = children.filter(c => !accountedChildrenIds.has(c.id));
            if (loneChildren.length > 0) { groups.push({ spouse: null, children: loneChildren }); }
            
            if (groups.length === 0) { 
                return { 
                    width: config.nodeWidth, 
                    nodes: [{ data: p, x: 0, y: 0, type: 'root', layoutId: myLayoutId }] 
                }; 
            }

            let totalSubtreeWidth = 0;
            const groupLayouts = groups.map(g => {
                let childrenBlockWidth = 0;
                const childResults = [];
                if (g.children.length > 0) {
                    g.children.forEach(child => {
                        const res = build(child.id, level + 1);
                        const childRootNode = res.nodes.find(n => n.type === 'root' && n.data.id === child.id); 
                        childResults.push({ ...res, childRootLayoutId: childRootNode ? childRootNode.layoutId : null });
                        childrenBlockWidth += res.width + config.gapX;
                    });
                    childrenBlockWidth -= config.gapX; 
                }
                const groupWidth = Math.max(g.spouse ? config.nodeWidth : 0, childrenBlockWidth);
                return { group: g, width: groupWidth, childResults };
            });

            totalSubtreeWidth = groupLayouts.reduce((acc, gl) => acc + gl.width + config.spouseGap, 0);
            if (groupLayouts.length > 0) totalSubtreeWidth -= config.spouseGap;
            totalSubtreeWidth = Math.max(totalSubtreeWidth, config.nodeWidth); 

            const localNodes = [];
            const rootX = totalSubtreeWidth / 2 - config.nodeWidth / 2;
            
            localNodes.push({ data: p, x: rootX, y: 0, type: 'root', layoutId: myLayoutId });

            let currentX = 0;
            groupLayouts.forEach(gl => {
                const g = gl.group;
                const groupCenterX = currentX + gl.width / 2;
                
                if (g.spouse) {
                    const spouseX = groupCenterX - config.nodeWidth / 2;
                    const spouseLayoutId = uuid(); 

                    localNodes.push({ 
                        data: g.spouse, 
                        x: spouseX, 
                        y: config.gapY, 
                        type: 'spouse', 
                        partnerId: pid,
                        layoutId: spouseLayoutId 
                    });

                    connections.push({ fromUUID: myLayoutId, toUUID: spouseLayoutId, isSpouse: true });
                    
                    let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                    if (gl.childResults.length === 0) childX = currentX; 

                    gl.childResults.forEach(res => {
                        res.nodes.forEach(n => {
                            localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                        });
                        
                        if (res.childRootLayoutId) { 
                            connections.push({ fromUUID: spouseLayoutId, toUUID: res.childRootLayoutId, isSpouse: false }); 
                        } 
                        childX += res.width + config.gapX;
                    });

                } else {
                    let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                    gl.childResults.forEach(res => {
                        res.nodes.forEach(n => {
                            localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                        });
                        
                        if (res.childRootLayoutId) { 
                            connections.push({ fromUUID: myLayoutId, toUUID: res.childRootLayoutId, isSpouse: false }); 
                        }
                        childX += res.width + config.gapX;
                    });
                }
                currentX += gl.width + config.spouseGap;
            });
            return { width: totalSubtreeWidth, nodes: localNodes };
        }
        
        const getP = (id) => memberList.find(m => m.id === id);
        const treeData = build(rootId, 0);
        return { nodes: treeData.nodes, connections };
    }


    
    // ================= DRAWING =================
    function drawNode(node, container) {
        let config = BASE_CONFIG;
        if (state.treeViewType === 'ancestors') config = ANCESTOR_CONFIG;
        else if (state.isHorizontal) config = {...BASE_CONFIG, gapX: 40, gapY: 250};

        let x = node.x, y = node.y;
        
        // MODIFICATION: Only apply coordinate swap for NON-ANCESTOR view
        if (state.isHorizontal && state.treeViewType !== 'ancestors') { x = node.y; y = node.x; }

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${x},${y})`);
        g.style.cursor = "pointer";
        g.onclick = (e) => { e.stopPropagation(); showDetail(node.data.id); };
        
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("width", config.nodeWidth); fo.setAttribute("height", config.nodeHeight);
        
        const p = node.data;
        const isDead = !p.isAlive;
        const isExMonarchAlive = p.isMonarch && p.isExMonarch && p.isAlive; // NEW: Ex-Monarch
        const deathTerm = isDead ? getDeathTerm(p) : "";
        let borderClass = p.gender === 'M' ? "border-male" : "border-female";
        // MODIFICATION: Check isMonarch: true to apply King/Queen border
        if(p.isMonarch) borderClass = "border-king"; 
        else if(p.isQueenConsort) borderClass = "border-queen";
        
        let imgClass = "";
        if(isDead) {
            // Note: The isMonarch flag is now intentionally kept true even if the King is deceased, 
            // per user request. We rely on isAlive for the display of death status.
            if(p.isMonarch) { borderClass = "border-dead-royal"; imgClass = "img-grayscale"; } 
            else { borderClass = "border-dead"; imgClass = "img-grayscale"; }
        } else if (isExMonarchAlive) { 
             // NEW: Apply King death border but keep image color
             borderClass = "border-dead-royal"; 
             imgClass = "img-normal"; 
        }
        
        const treeName = getTreeNodeName(p); 
        const showCrown = (p.isMonarch || p.isQueenConsort || p.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ");
        
        const isFlash = state.highlightIds.includes(p.id);
        const flashClass = isFlash ? "node-flash" : "";
        
        let badgeHTML = "";
        if (state.treeViewType === 'ancestors' && node.ancestorLabel) {
            badgeHTML += `<div class="ancestor-label">${node.ancestorLabel}</div>`;
        }
        
        if (p.isMonarch && p.useReignName && p.reignNameBase && !p.isExMonarch) { // Only show reign name badge for active monarch
            let reignTxt = p.reignNameBase;
            const autoNum = getReignNameRank(p);
            if(autoNum) reignTxt += `‡∏ó‡∏µ‡πà ${toThaiNumerals(autoNum)}`;
            if(p.globalReignNumber) reignTxt += ` (‡∏£.${toThaiNumerals(p.globalReignNumber)})`;
            badgeHTML += `<div class="badge-monarch truncate w-full text-center mt-1">${reignTxt}</div>`;
        } else if (p.isExMonarch && p.isAlive) { // NEW: Show Ex-Monarch badge
            const reignNum = p.globalReignNumber ? `‡∏£. ${toThaiNumerals(p.globalReignNumber)}` : '';
            badgeHTML += `<div class="badge-krom bg-purple-100 text-purple-700 border-purple-300 truncate w-full text-center mt-1">‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignNum}</div>`;
        } else if (p.isHeir) {
             badgeHTML += `<div class="badge-heir truncate w-full text-center mt-1">‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${toThaiNumerals(p.heirOrder)}</div>`;
        } else if (!p.isMonarch && p.kromRank) {
            // NOTE: Krom Rank is kept in node badge, but removed from full name display (per request)
            badgeHTML += `<div class="badge-krom truncate w-full text-center mt-1">${p.kromRank}${p.kromTitle||''}</div>`;
            
        }
        
        // --- MODIFICATION FOR RULE 2: Royal Surname Badge (Removed from Node) ---
        // Per user request, the Royal Surname badge is REMOVED from the node to fulfill: 
        // "‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ú‡∏±‡∏á(‡∏ó‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢)"
        // --- END MODIFICATION ---

        const div = document.createElement("div");
        div.className = `node-box ${borderClass} ${flashClass} ${state.viewRootId === p.id ? 'focused' : ''}`;
        div.innerHTML = `
            <div class="relative mb-1">
                <img src="${p.image || (p.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full border border-white shadow-sm object-cover bg-slate-100 ${imgClass}">
                ${showCrown ? `<i class="fa-solid fa-crown absolute -top-1 -right-1 text-xs ${p.isAlive && !p.isExMonarch ?'text-yellow-500':'text-slate-600'} bg-white rounded-full p-0.5 shadow-sm"></i>` : ''}
            </div>
            <div class="text-[11px] font-bold text-center leading-tight truncate w-full px-1 ${p.isMonarch?'text-amber-700':'text-slate-700'}">${treeName}</div>
            ${badgeHTML}
            ${isDead ? `<div class="absolute top-1 left-1 text-[8px] bg-slate-800 text-white px-1.5 py-0.5 rounded shadow-sm opacity-90">${deathTerm}</div>` : ''}
        `;
        fo.appendChild(div); g.appendChild(fo); container.appendChild(g);
    }

    function drawLink(n1, n2, isSpouse, container) {
        let config = BASE_CONFIG;
        if (state.treeViewType === 'ancestors') config = ANCESTOR_CONFIG;
        else if (state.isHorizontal) config = {...BASE_CONFIG, gapX: 40, gapY: 250};

        const getC = (n, type) => {
            let nx = n.x, ny = n.y;
            
            // Fix: In ancestor view, use raw calculated coordinates (no swap)
            if (state.treeViewType !== 'ancestors' && state.isHorizontal) { nx = n.y; ny = n.x; }

            if (state.treeViewType === 'ancestors') {
                 // For ancestor view, we determine connection points based on state.isHorizontal
                if (state.isHorizontal) { // Horizontal Ancestor Layout (Parent right of child)
                    // n1 (child) connects from right side, n2 (parent) connects to left side
                    if (type === 'from') return { x: nx + config.nodeWidth, y: ny + config.nodeHeight/2 }; // Right side
                    if (type === 'to') return { x: nx, y: ny + config.nodeHeight/2 }; // Left side
                } else { // Vertical Ancestor Layout (Parent above child)
                    // n1 (child) connects from top side, n2 (parent) connects to bottom side
                    if (type === 'from') return { x: nx + config.nodeWidth/2, y: ny }; // Top side
                    if (type === 'to') return { x: nx + config.nodeWidth/2, y: ny + config.nodeHeight }; // Bottom side
                }
            } else {
                 // Standard Tree View (Parent top, Child bottom)
                 if (state.isHorizontal) {
                    if(type==='bottom') return {x: nx+config.nodeWidth, y: ny+config.nodeHeight/2}; 
                    if(type==='top') return {x: nx, y: ny+config.nodeHeight/2}; 
                 } else {
                    if(type==='bottom') return {x: nx+config.nodeWidth/2, y: ny+config.nodeHeight};
                    if(type==='top') return {x: nx+config.nodeWidth/2, y: ny};
                 }
            }
            return {x: nx, y: ny};
        };

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        // Updated: Use different class for spouse and child connections for themed coloring
        path.setAttribute("class", `connector ${isSpouse ? 'connector-spouse' : 'connector-child'}`);
        
        if (state.highlightIds.includes(n1.data.id) && state.highlightIds.includes(n2.data.id)) {
            path.style.stroke = "#ef4444";
            path.style.strokeWidth = "3px";
            path.style.strokeDasharray = "5,5";
        }

        let p1, p2, d;
        
        if (state.treeViewType === 'ancestors') {
            p1 = getC(n1, 'from'); // Child (Lower Generation)
            p2 = getC(n2, 'to');   // Parent (Higher Generation)
            
            if (state.isHorizontal) {
                // Horizontal Ancestor Layout: Left-to-Right curve
                const midX = (p1.x + p2.x)/2;
                d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`;
            } else {
                 // Vertical Ancestor Layout: Bottom-to-Top curve
                const midY = (p1.y + p2.y)/2;
                d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`;
            }
            
        } else {
            if(isSpouse) {
                p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
                if(state.isHorizontal) { 
                    const midX = (p1.x + p2.x)/2; 
                    d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; 
                } else { 
                    const midY = (p1.y + p2.y)/2; 
                    d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; 
                }
                
                // Draw heart icon for spouse connection
                const mx = (p1.x + p2.x)/2; const my = (p1.y + p2.y)/2;
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("class", "heart-icon"); txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle"); txt.textContent = "‚ù§";
                txt.setAttribute("x", mx); txt.setAttribute("y", my);
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", mx); circle.setAttribute("cy", my); circle.setAttribute("r", 8); circle.setAttribute("fill", "#fff");
                container.appendChild(circle); container.appendChild(txt);
            } else {
                p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
                if(state.isHorizontal) { 
                    const midX = (p1.x + p2.x)/2; 
                    d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; 
                } else { 
                    const midY = (p1.y + p2.y)/2; 
                    d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; 
                }
            }
        }
        path.setAttribute("d", d); container.appendChild(path);
    }

    // ================= UTILS & HELPERS =================
    function toThaiNumerals(num) {
        if(num === null || num === undefined) return '';
        const thai = ['‡πê','‡πë','‡πí','‡πì','‡πî','‡πï','‡πñ','‡πó','‡πò','‡πô'];
        return num.toString().split('').map(d => thai[d]||d).join('');
    }
    function getReignNameRank(p) {
        if(!p.isMonarch || !p.useReignName || !p.reignNameBase) return null;
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•" (Global Reign Number)
        const sameName = state.members
            .filter(m => m.isMonarch && m.useReignName && m.reignNameBase === p.reignNameBase)
            .sort((a,b) => (parseInt(a.globalReignNumber)||0) - (parseInt(b.globalReignNumber)||0));
        
        const rank = sameName.findIndex(m => m.id === p.id) + 1;
        return rank > 0 ? rank : null;
    }
    function getDisplayRank(rank) {
        if(!rank) return '';
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
            return rank.split(' ')[0]; 
        }
        return rank;
    }
    
    function isCommonerDescendant(p) {
        if (!p.royalRank) return true;
        return p.royalRank.includes('‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') || p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') || p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á');
    }

    /**
     * UPDATED LOGIC: Implements all name display rules as requested, including surname.
     */
    /**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏é‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ "‡∏ì"
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï/‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥) 
 * ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..." ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° 
 * ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ:
 * 1. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô attachedPrefixList ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô "‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
 * 2. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞" ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô List ‡∏à‡∏∞ "‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ" ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
 */
function getFullDisplayTitle(p) {
    if (!p) return "";

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î "‡∏ì" ‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
    const shouldSkipNa = (person) => {
        const noNaTitles = ['‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'];
        const rank = person.royalRank || '';
        const prefix = person.titlePrefix || '';
        return noNaTitles.some(t => rank.includes(t)) || noNaTitles.includes(prefix);
    };

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢: ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
    const isConsort = p.relationship === '‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤';

    // ==================================================================
    // [1] ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4 ‡∏ó‡πâ‡∏≤‡∏ß‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤)
    // ==================================================================
    const specialTaoTitles = ["‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ"];

    if (specialTaoTitles.includes(p.titlePrefix)) {
        let namePart = p.name || "";

        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏¢‡∏® ‡∏°.‡∏£.‡∏ß. / ‡∏°.‡∏•. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4 ‡∏ó‡πâ‡∏≤‡∏ß‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏≠‡∏Å)
        if (p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') {
            namePart = p.royalRank + namePart;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤
        let surnamePart = "";
        if (!isConsort) {
            if (p.royalSurname) {
                surnamePart = shouldSkipNa(p) ? ` ${p.royalSurname}` : ` ${p.royalSurname} ‡∏ì ${state.kingdomName}`;
            } else if (p.surname) {
                surnamePart = ` ${p.surname}`;
            }
        }

        let context = "";
        if (p.monarchSpouseContext) {
            context = p.monarchSpouseContext.includes("‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà") ?
                " " + p.monarchSpouseContext :
                ` ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.monarchSpouseContext)}`;
        }

        return `${p.titlePrefix} (${namePart}${surnamePart})${context}`.trim();
    }
    // ==================================================================


    // --- [2] ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
    if (p.isTao && p.taoTitle) {
        let prefix = p.titlePrefix || "";

        // ++++++ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ã‡πà‡∏≠‡∏ô ‡∏ô‡∏≤‡∏á/‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö ++++++
        if (prefix === '‡∏ô‡∏≤‡∏á' || prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß') {
            prefix = "";
        }
        // +++++++++++++++++++++++++++++++++++++++++++++++

        let name = p.name || "";

        // =============================================================
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‡∏°.‡∏£.‡∏ß. / ‡∏°.‡∏•.
        // =============================================================
        if (p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') {
            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°" ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏¢‡∏®
            if (prefix === '‡∏´‡∏°‡πà‡∏≠‡∏°') {
                prefix = "";
            }
            // ‡πÅ‡∏ó‡∏£‡∏Å‡∏¢‡∏®‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤(‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠
            prefix = prefix + p.royalRank;
        }
        // =============================================================

        // ++++++ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏ä‡πá‡∏Ñ hideSurname (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•) ++++++
        let surnameText = "";
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç !p.hideSurname ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
        if (!isConsort && !p.hideSurname) {
            if (p.royalSurname) {
                surnameText = shouldSkipNa(p) ? ` ${p.royalSurname}` : ` ${p.royalSurname} ‡∏ì ${state.kingdomName}`;
            } else if (p.surname) {
                surnameText = ` ${p.surname}`;
            }
        }
        // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++

        let innerName = prefix + name + surnameText;

        let context = "";
        if (p.monarchSpouseContext) {
            context = p.monarchSpouseContext.includes("‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà") ?
                " " + p.monarchSpouseContext :
                ` ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.monarchSpouseContext)}`;
        }

        return `‡∏ó‡πâ‡∏≤‡∏ß${p.taoTitle} (${innerName}${context})`.trim();
    }
    // ---------------------------------------

    // [3] ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)
    if (p.isResigned) {
        let prefix = (p.titlePrefix === "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á") ? "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á" :
            (p.gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : (p.spouseIds && p.spouseIds.length > 0 ? '‡∏ô‡∏≤‡∏á' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß'));
        let name = p.name || "";

        let surname = "";
        if (p.royalSurname) {
            surname = `${p.royalSurname} ‡∏ì ${state.kingdomName}`;
        } else if (p.surname) {
            surname = p.surname;
        }

        return `${prefix}${name} ${surname}`.trim();
    }

    const attachedPrefixList = [
        "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏®‡∏£‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤",
        "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è",
        "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏®‡∏£‡∏µ",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", "‡∏ó‡πâ‡∏≤‡∏ß", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°", "‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå", "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡∏ô‡∏≤‡∏¢",
        "‡∏ô‡∏≤‡∏á", "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß", "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á", "‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á", "‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á", "‡∏Ñ‡∏∏‡∏ì", "‡∏Ç‡∏£‡∏±‡∏ß‡∏ï‡∏≤", "‡∏Ç‡∏£‡∏±‡∏ß‡∏¢‡∏≤‡∏¢",
        "‡∏à‡πà‡∏≤", "‡∏´‡∏°‡∏π‡πà", "‡∏û‡∏±‡∏ô", "‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡∏Ç‡∏∏‡∏ô", "‡∏û‡∏£‡∏∞", "‡∏à‡∏°‡∏∑‡πà‡∏ô", "‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤"
    ];

    let prefix = p.titlePrefix || "";
    let displayName = p.name || "";
    let suffix = p.titleSuffix || "";

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏° "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å" ‡πÅ‡∏•‡∏∞ "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á"
    if ((prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤" && (suffix === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å" || suffix === "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å")) ||
        (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ" && (suffix === "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ" || suffix === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ" || suffix === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á" || suffix === "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á"))) {
        return (prefix + displayName + suffix).trim();
    }

    const isKingRole = p.isMonarch || p.isExMonarch || (!p.isAlive && p.royalRank && p.royalRank.includes('‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå'));

    if (isKingRole) {
        let mainTitle = "";
        if ((prefix === "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞" || prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞") && suffix === "‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß") {
            mainTitle = prefix + displayName + suffix;
        } else if (attachedPrefixList.includes(prefix)) {
            mainTitle = prefix + displayName + suffix;
        } else {
            mainTitle = (prefix ? prefix + " " : "") + displayName + suffix;
        }

        let extraParts = [];
        if (p.isExMonarch || !p.isAlive) {
            const reignLabel = p.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.globalReignNumber)}` : '';
            if (p.isExMonarch && p.isAlive) {
                extraParts.push(`‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå${reignLabel}`);
            } else if (reignLabel) {
                extraParts.push(reignLabel);
            }
        } else {
            if (p.useReignName && p.reignNameBase) {
                let reignPart = p.reignNameBase;
                const autoNum = getReignNameRank(p);
                if (autoNum) reignPart += "‡∏ó‡∏µ‡πà " + toThaiNumerals(autoNum);
                extraParts.push(reignPart);
            }
        }
        return (mainTitle + (extraParts.length > 0 ? " " + extraParts.join(" ") : "")).trim();
    }

    if (p.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") {
        const rank = (p.royalRank && p.royalRank !== '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && !p.hideRoyalRank) ?
            p.royalRank.split(' ')[0] :
            "";

        const kromInfo = (p.kromRank && p.kromRank !== "‡πÑ‡∏°‡πà‡∏°‡∏µ") ?
            ` ${p.kromRank}${p.kromTitle || p.kromName || ""}` :
            "";

        const suffixStr = p.titleSuffix ? ` ${p.titleSuffix}` : "";
        let contextStr = "";
        if (p.monarchSpouseContext) {
            contextStr = p.monarchSpouseContext.includes("‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà") ?
                ` ${p.monarchSpouseContext}` :
                ` ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.monarchSpouseContext)}`;
        }

        return `${p.titlePrefix || ""} ${rank}${p.name}${kromInfo}${suffixStr}${contextStr}`.replace(/\s+/g, ' ').trim();
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3.5: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á ---
    if (p.relationship === '‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á') {
        let pre = p.titlePrefix || "";
        let nob = p.nobilityTitle || "";
        let n = p.name || "";

        let s = "";
        if (!p.hideSurname) {
            if (p.royalSurname) s = ` ${p.royalSurname} ‡∏ì ${state.kingdomName}`;
            else if (p.surname) s = ` ${p.surname}`;
        }

        let header = (pre + nob).trim();
        let fullName = (n + s).trim();
        if (header && fullName) return `${header} (${fullName})`;
        return header || fullName;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ---
    let finalNameParts = [];
    let currentDisplayName = displayName;

    // ==========================================================
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏°‡πà‡∏≠‡∏° + ‡∏°.‡∏£.‡∏ß./‡∏°.‡∏•. ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏´‡∏°‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏Å
    // ==========================================================
    if (prefix === '‡∏´‡∏°‡πà‡∏≠‡∏°' && (p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') || p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'))) {
        prefix = "";
    }
    // ==========================================================

    if (!p.hideRoyalRank && p.royalRank && p.royalRank !== '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
        const simpleRank = p.royalRank.split(' ')[0];
        const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
        const isRegisteredSpouse = activeMonarch && activeMonarch.registeredSpouseId === p.id;
        const skipRankPrefixes = [
            "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ",
            "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤"
        ];
        const shouldSkipRank = isRegisteredSpouse || skipRankPrefixes.includes(prefix);

        if (!shouldSkipRank && !prefix.includes(simpleRank) && simpleRank !== '‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á') {
            currentDisplayName = simpleRank + displayName;
        }
    }

    if (attachedPrefixList.includes(prefix)) {
        finalNameParts.push(prefix + currentDisplayName);
    } else {
        if (prefix) finalNameParts.push(prefix);
        finalNameParts.push(currentDisplayName);
    }

    if (!p.hideSurname && !isConsort) {
        const isHighRoyal = p.royalRank && (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || p.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤'));

        if (!isHighRoyal) {
            if (p.surname && p.surname.trim() !== '') {
                finalNameParts.push(p.surname);
            } else if (p.royalSurname && p.royalSurname.trim() !== '') {
                if (shouldSkipNa(p)) {
                    finalNameParts.push(p.royalSurname);
                } else if (['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡∏Ñ‡∏∏‡∏ì', '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á', '‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á'].includes(p.titlePrefix) || p.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
                    finalNameParts.push(`${p.royalSurname} ‡∏ì ${state.kingdomName}`);
                }
            }
        }
    }

    if (p.kromRank && p.kromRank !== "‡πÑ‡∏°‡πà‡∏°‡∏µ") {
        finalNameParts.push(p.kromRank + (p.kromTitle || p.kromName || ""));
    }
    if (p.titleSuffix && p.titleSuffix !== "") {
        finalNameParts.push(p.titleSuffix);
    }
    if (p.monarchSpouseContext) {
        const context = p.monarchSpouseContext.includes("‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà") ?
            p.monarchSpouseContext :
            `‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.monarchSpouseContext)}`;
        finalNameParts.push(context);
    }

    return finalNameParts.join(" ").trim();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getNicknameWithPrefix ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
function getNicknameWithPrefix(p) {
    if (!p.nickname) return '-';
    let prefix = '';
    const r = p.royalRank || '';
    const tp = p.titlePrefix || '';
    const isMale = p.gender === 'M';

    // 1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢
    if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) {
        prefix = '‡∏ó‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°';
    } else if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
        prefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à';
    } else if (r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) {
        prefix = '‡πÄ‡∏™‡∏î‡πá‡∏à';
    } else if (r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
        prefix = isMale ? '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏ä‡∏≤‡∏¢' : '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) {
        prefix = isMale ? '‡∏ó‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢' : '‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå')) {
        prefix = isMale ? '‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢' : '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì';
    } 

    // 2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á
    else if (tp === '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤') {
        prefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (tp === '‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤') {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (tp === '‡∏û‡∏£‡∏∞‡∏¢‡∏≤') {
        prefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (tp === '‡∏û‡∏£‡∏∞' || tp === '‡∏à‡∏°‡∏∑‡πà‡∏ô') {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞';
    } else if (tp === '‡∏´‡∏•‡∏ß‡∏á') {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏ß‡∏á';
    } else if (tp === '‡∏Ç‡∏∏‡∏ô') {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡∏Ç‡∏∏‡∏ô';
        
    } else if (tp === '‡∏´‡∏°‡∏∑‡πà‡∏ô') {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏∑‡πà‡∏ô';
    }

    // 3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ù‡πà‡∏≤‡∏¢‡πÉ‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©
    else if (tp.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞') || tp.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°')) {
        prefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } 
    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß" ---
    else if (p.isTao || tp.startsWith('‡∏ó‡πâ‡∏≤‡∏ß')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß';
    }
    // -------------------------------------------------------------
    else if (tp.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì';
    } else if (tp === '‡∏´‡∏°‡πà‡∏≠‡∏°') { 
        prefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
    }

    return prefix + p.nickname;
}
    /**
     * Retrieves the name displayed inside the tree node box.
     * Per user request, M.R.W. and M.L. (and high royal prefixes) are NOT shown here, only the name.
     */
    function getTreeNodeName(p) { 
        // Per user request: Do not show M.R.W. or M.L. or any other rank/prefix in the tree node itself.
        // It should only show the name. The full rank is available in the popup.
        return p.name || "-"; 
    }
    
    function getGlobalReignLabel(p) {
        if(p.globalReignNumber) return `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.globalReignNumber)}`;
        return '';
    }
    function getDeathTerm(p) {
        if(p.hasUmbrella) {
            if(p.umbrellaType.includes('‡∏ô‡∏û‡∏î‡∏•') || p.umbrellaType.includes('‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•')) return "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï";
            if(p.umbrellaType.includes('‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•')) return "‡∏ó‡∏¥‡∏ß‡∏á‡∏Ñ‡∏ï"; 
        }
        // MODIFICATION: Use p.isMonarch (historical) instead of p.isMonarch || p.isQueenConsort || p.isExMonarch
        if(p.isMonarch || p.isQueenConsort || p.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ") return "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï";
        const rank = p.royalRank || '';
        if((p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) return "‡∏≠‡∏™‡∏±‡∏ç‡∏Å‡∏£‡∏£‡∏°";
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) return "‡∏ó‡∏¥‡∏ß‡∏á‡∏Ñ‡∏ï";
        if(rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) return "‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå";
        if(rank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) return "‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏µ‡∏û‡∏¥‡∏ï‡∏±‡∏Å‡∏©‡∏±‡∏¢";
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä')) return "‡∏û‡∏¥‡∏•‡∏≤‡∏•‡∏±‡∏¢";
        return "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï";
    }
    function generateRoyalId(gender, rankName) {
        const d1 = gender === 'M' ? '1' : '2';
        const d2 = RANK_CODES[rankName] || 'A';
        const d3 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
        const d4 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
        return `${d1}${d2}${d3}${d4}${Math.floor(Math.random()*1000000)}`;
    }


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
 * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
 */
function updateRoyalRelationshipByGender() {
    // 1. ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const fatherId = document.getElementById('p_fatherId').value;
    const motherId = document.getElementById('p_motherId').value;
    const genderElement = document.querySelector('input[name="gender"]:checked');
    if (!genderElement) return; // ‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®
    const gender = genderElement.value;
    
    const father = state.members.find(m => m.id === fatherId);
    const mother = state.members.find(m => m.id === motherId);
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ---
    const currentMonarch = getCurrentMonarch();
    const mFatherId = currentMonarch?.fatherId;
    const mMotherId = currentMonarch?.motherId;

    const isParentMonarch = (father && father.isMonarch) || (mother && mother.isMonarch);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    const isParentSibling = (father && (father.fatherId && father.fatherId === mFatherId)) || 
                            (mother && (mother.motherId && mother.motherId === mMotherId));

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    const isParentOfMonarch = (fatherId && mFatherId && fatherId === mFatherId) || 
                              (motherId && mMotherId && motherId === mMotherId);

    // ==========================================================
// 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á (‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á)
// ==========================================================
const isPalace = father && (father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤" || father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á");

// ==========================================================
// 2. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// ==========================================================
if (isParentMonarch || isParentOfMonarch || isParentSibling || isPalace) {
    
    const birthYear = document.getElementById('p_birthYear').value;
    let auto = null;

    // --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 1: ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á] ---
    if (isPalace) {
        // ‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6 ‡∏Ç‡∏≠‡∏á calculateChildRankGeneric
        auto = calculateChildRankGeneric(fatherId, motherId, gender, birthYear);
    } 
    
    // --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 2: ‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤] ---
    else if (isParentMonarch || isParentOfMonarch) {
        auto = calculateChildRank(fatherId, motherId, gender, birthYear);
    } 
    
    // --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 3: ‡∏™‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)] ---
    else if (isParentSibling) {
        const currentRank = document.getElementById('p_royalRank').value;
        
        auto = {
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
            royalRank: currentRank || "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)",
            titlePrefix: "" // ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏¢‡∏® (Title Prefix Logic)
        if (auto.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)")) {
            auto.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        } else if (auto.royalRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)")) {
            auto.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        } else if (auto.royalRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") {
            auto.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
        }
    }
        
        // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô Pop-up
        if (auto) {
            if (auto.relationship) {
                document.getElementById('p_relationship').value = auto.relationship;
            }
            
            updatePrefixOptions(); 
            
            if (auto.titlePrefix) {
                const prefixSelect = document.getElementById('p_titlePrefix');
                let exists = Array.from(prefixSelect.options).some(opt => opt.value === auto.titlePrefix);
                if (!exists) {
                    const opt = document.createElement('option');
                    opt.value = auto.titlePrefix;
                    opt.text = auto.titlePrefix;
                    prefixSelect.add(opt);
                }
                prefixSelect.value = auto.titlePrefix;
            }
            
            if (auto.royalRank) {
                document.getElementById('p_royalRank').value = auto.royalRank;
            }
            
            updateSuffixOptions();
        }
    }
}



    function updateAutoId() {
        try {
            if (document.getElementById('p_isEditMode').value === 'true') return;
            const gEl = document.querySelector('input[name="gender"]:checked');
            const gender = gEl ? gEl.value : 'M';
            const rank = document.getElementById('p_royalRank').value || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            document.getElementById('p_id').value = generateRoyalId(gender, rank);
        } catch(e) { }
    }

    // New: Function to check and update consort prefix
function checkConsortMotherhood(person) {
    if (person.gender !== 'F') return person;

    const rel = person.relationship || '';
    let prefix = person.titlePrefix || '';
    
    // ---------------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏ß‡∏á (‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° -> ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤)
    // ---------------------------------------------------------
    if (rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
        if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') {
            const hasChildren = state.members.some(m => m.motherId === person.id);
            
            if (hasChildren) {
                if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤';
                else if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°') person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤';
                
                if (prefix !== person.titlePrefix) {
                    showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${person.name} ‡πÄ‡∏õ‡πá‡∏ô ${person.titlePrefix}`);
                }
            } else {
                if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°';
                else if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°';
            }
        }
    }

    // ---------------------------------------------------------
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏´‡∏°‡πà‡∏≠‡∏° -> ‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤)
    // ---------------------------------------------------------
    // ‡πÉ‡∏ä‡πâ .includes ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏°‡πà‡∏≠‡∏° (‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤)"
    if (rel.includes('‡∏´‡∏°‡πà‡∏≠‡∏°')) {
        const children = state.members.filter(m => m.motherId === person.id);
        
        if (children.length > 0) {
            // ‡∏´‡∏≤‡∏û‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
            const fatherId = children[0].fatherId;
            const husband = state.members.find(m => m.id === fatherId);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡∏°‡∏µ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            // **‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô data ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ 'relationType' ‡∏´‡∏£‡∏∑‡∏≠ 'relationship'**
            if (husband && (husband.relationType === '‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤' || husband.relationship?.includes('‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤'))) {
                
                if (person.titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°') {
                    person.titlePrefix = '‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤';
                    showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${person.name} ‡πÄ‡∏õ‡πá‡∏ô ‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤`);
                }
            }
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤)
            if (person.titlePrefix === '‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') {
                person.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
            }
        }
    }

    return person;
}

    /**
     * Calculates the appropriate default Royal Rank and Title Prefix for a child
     * of the current reigning monarch, based on the mother's status/lineage.
     */
  function calculateChildRank(fatherId, motherId, gender, bYear) {
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: Sticky Rank (‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏®‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ---
    const self = state.members.find(m => m.id === window.currentEditingId);

    
    if (self && self.isMonarch) {
        return {
            royalRank: self.royalRank,
            titlePrefix: self.titlePrefix,
            relationship: self.relationship,
            royalSurname: self.royalSurname || '',
            surname: self.surname || ''
        };
    }
    
    const defaultRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
    const defaultRel = gender === 'M' ? '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™' : '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤';
    
    const monarchParent = state.members.find(m => m.id === fatherId);
    const otherParent = state.members.find(m => m.id === motherId);

// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Generic ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (!monarchParent) {
        return calculateChildRankGeneric(fatherId, motherId, gender, bYear);
    }


    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
    const currentMonarch = state.members.find(m => m.isMonarch);
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ö‡∏¥‡∏î‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    if (currentMonarch && fatherId === currentMonarch.fatherId && currentMonarch.id !== (window.currentEditingId)) {
        const isMale = gender === 'M';
        const isSameMother = motherId === currentMonarch.motherId;
        const monarchBirthYear = parseInt(currentMonarch.birthYear) || 0;
        const inputBirthYear = parseInt(bYear) || 0;

        // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≠‡∏á
        let ageLabel = "";
        if (inputBirthYear > 0 && monarchBirthYear > 0) {
            if (inputBirthYear < monarchBirthYear) {
                ageLabel = isMale ? "‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
            } else {
                ageLabel = isMale ? "‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
            }
        } else {
            ageLabel = isMale ? "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
        }

        // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏¢‡∏®‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤ = ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ / ‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤ = ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤)
        if (isSameMother) {
            return {
                royalRank: '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)',
                titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤" + ageLabel,
                relationship: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤",
                royalSurname: monarchParent.royalSurname || '',
                surname: ''
            };
        } else {
            return {
                royalRank: '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)',
                titlePrefix: "‡∏û‡∏£‡∏∞" + ageLabel,
                relationship: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤",
                royalSurname: monarchParent.royalSurname || '',
                surname: ''
            };
        }
    }
    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ---

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏ö‡∏∏‡∏ï‡∏£ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    let royalSurname = '';
    if (monarchParent) {
        royalSurname = monarchParent.royalSurname || otherParent?.royalSurname || monarchParent.surname || otherParent?.surname || ''; 
    }

    // ‡∏´‡∏≤‡∏Å‡∏ö‡∏¥‡∏î‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    if (!monarchParent || !monarchParent.isMonarch) {
        return { royalRank: defaultRank, titlePrefix: '', relationship: defaultRel, royalSurname, surname: '' };
    }

    // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏¢‡∏®‡∏•‡∏π‡∏Å (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
    let finalRank = defaultRank;
    let finalPrefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';

    if (otherParent) {
        const fullTitle = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(otherParent) : (otherParent.name || "");
        const rankEkKeywords = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
        const isEkByTitle = rankEkKeywords.some(key => fullTitle.includes(key)) || fullTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ");

        let motherRankLevel = 0; 
        let mFather = state.members.find(m => m.id === otherParent.fatherId);
        let mMother = state.members.find(m => m.id === otherParent.motherId);
        
        if (mFather?.isMonarch || mMother?.isMonarch) { motherRankLevel = 1; }
        if (motherRankLevel === 0) {
            const grandparents = [mFather, mMother].filter(p => p);
            for (const gp of grandparents) {
                const ggf = state.members.find(m => m.id === gp.fatherId);
                const ggm = state.members.find(m => m.id === gp.motherId);
                if (ggf?.isMonarch || ggm?.isMonarch) {
                    motherRankLevel = 2;
                    break;
                }
            }
        }

        if (motherRankLevel === 1 || isEkByTitle) {
            finalRank = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
            finalPrefix = gender === 'M' ? '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        } 
        else if (motherRankLevel === 2 || otherParent.relationship === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
            finalRank = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)';
            finalPrefix = gender === 'M' ? '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        }
        else if ((otherParent.relationship || '').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
            finalRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
            finalPrefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        }
    }

    return { royalRank: finalRank, titlePrefix: finalPrefix, relationship: defaultRel, royalSurname, surname: '' };
}



    /**
     * Calculates the appropriate Royal Rank, Title Prefix, and Surname for a child
     * who is NOT a direct child of the current reigning monarch.
     * Implements rules for commoner marriage and MR/ML generation.
     */
function calculateChildRankGeneric(fatherId, motherId, gender, bYear) {

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: Sticky Rank (‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏®‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ---
    const self = state.members.find(m => m.id === window.currentEditingId);
    if (self && self.isMonarch) {
        return {
            royalRank: self.royalRank,
            titlePrefix: self.titlePrefix,
            relationship: self.relationship,
            royalSurname: self.royalSurname || '',
            surname: self.surname || ''
        };
    }
    const defaultCommonerRank = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
    const defaultCommonerRel = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
    
    const father = state.members.find(m => m.id === fatherId);
    const mother = state.members.find(m => m.id === motherId);

    // ==========================================================
    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏é‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ---
    // ==========================================================
    const monarch = state.members.find(m => m.isMonarch);
    const monarchFatherId = monarch ? monarch.fatherId : null;
    const monarchMotherId = monarch ? monarch.motherId : null;
    const monarchBirthYear = monarch ? parseInt(monarch.birthYear) : 0;
    const inputBirthYear = parseInt(bYear) || 0;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏ö‡∏¥‡∏î‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    if (monarch && fatherId === monarchFatherId && monarch.id !== window.currentEditingId) {
        const isSameMother = motherId === monarchMotherId;
        const isMale = gender === 'M';

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏®‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà: ‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏Å‡πá‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡πÅ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏®‡∏™‡∏π‡∏á (‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤)
        let motherIsHighRank = false;
        if (mother) {
            const mf = state.members.find(m => m.id === mother.fatherId);
            const mm = state.members.find(m => m.id === mother.motherId);
            if (mf?.isMonarch || mm?.isMonarch || (mother.royalRank && !mother.royalRank.includes('‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô')) || mother.relationship === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
                motherIsHighRank = true;
            }
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≥‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ (‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ / ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠ / ‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ / ‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠) ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        let ageLabel = "";
        if (inputBirthYear > 0 && monarchBirthYear > 0) {
            ageLabel = (inputBirthYear < monarchBirthYear) ? (isMale ? "‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") : (isMale ? "‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠");
        } else {
            ageLabel = isMale ? "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
        }

        // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏¢‡∏®: ‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÅ‡∏ï‡πà‡πÅ‡∏°‡πà‡∏¢‡∏®‡∏™‡∏π‡∏á -> ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)
        if (isSameMother || motherIsHighRank) {
            return {
                royalRank: '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)',
                titlePrefix: (isSameMother ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞") + ageLabel,
                relationship: isSameMother ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤",
                royalSurname: monarch.royalSurname || '',
                surname: ''
            };
        } else {
            // ‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤ -> ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)
            return {
                royalRank: '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)',
                titlePrefix: "‡∏û‡∏£‡∏∞" + ageLabel,
                relationship: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤",
                royalSurname: monarch.royalSurname || '',
                surname: ''
            };
        }
    }
    // ==========================================================
    // --- [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏é‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á] ---
    // ==========================================================
    
    // --- ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏´‡∏°‡πà‡∏≠‡∏°) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
    const isMotherCommoner = mother && (mother.relationship === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || !mother.royalRank || mother.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô');
    
    // Default to commoner status
    let royalRank = defaultCommonerRank;
    let titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
    let relationship = defaultCommonerRel;
    let royalSurname = '';
    let surname = '';

    // ==========================================================
    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1 ---
    // ==========================================================
    const isMotherHeir1 = mother && mother.isHeir && parseInt(mother.heirOrder) === 1;
    
    if (isMotherHeir1) {
        const fRank = father ? (father.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') : '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const fPrefix = father ? (father.titlePrefix || '') : '';

        // 1. ‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" 
        // -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
        if (fRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
            return {
                royalRank: '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)',
                titlePrefix: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                relationship: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        } 
        // 2. ‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ" (‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
        // -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
        else if (fRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
            return {
                royalRank: '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)',
                titlePrefix: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                relationship: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        }
        // 3. ‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏±‡∏ö "‡∏ä‡∏≤‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á ‡∏°.‡∏£.‡∏ß. ‡πÅ‡∏•‡∏∞ ‡∏°.‡∏´‡∏•‡∏ß‡∏á ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡πÉ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏¢‡∏®)
        // -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        else {
            return {
                royalRank: '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤',
                titlePrefix: '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤',
                relationship: '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        }
    }
    // ==========================================================
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó ---
    // ==========================================================








    

    // --- 1. Check for Royal Male Bloodline (Father is Royal) ---
    if (father && !isCommonerDescendant(father)) {
        const fatherRank = father.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const fatherPrefix = father.titlePrefix || '';
        const motherRank = mother ? (mother.royalRank || '') : '';

        // Royal descent: Inherit the Royal Surname from Father
        royalSurname = father.royalSurname || father.surname || '';
        surname = ''; 

        // ==========================================================
        // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏é‡∏™‡∏≤‡∏¢ ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤] ---
        // ==========================================================
      
if (father && father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") {
    // 1. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤) + ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤"
    if (fatherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") && motherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        return { 
            royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", 
            titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", 
            relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå",           
            royalSurname: royalSurname, 
            surname: "" 
        };
    }
    
    // 2. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤/‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤/‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤"
    const fatherIsHigh = fatherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || fatherRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤");
    const motherIsMid = motherRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") || motherRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
    if (fatherIsHigh && motherIsMid) {
        return { 
            royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", 
            titlePrefix: "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",       
            relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå",           
            royalSurname: royalSurname, 
            surname: "" 
        };
    }

    // 3. ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"
    if (isMotherCommoner) {
        return { 
            royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
            titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",           
            royalSurname: royalSurname, 
            surname: "" 
        };
    }
}

// ==========================================================
// --- [‡∏Å‡∏é‡∏™‡∏≤‡∏¢ ‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á] ---
// ==========================================================
if (father && father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á") {
    // 1. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"
    if (fatherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") && motherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        return { 
            royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", 
            titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", 
            relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå",           
            royalSurname: royalSurname, 
            surname: "" 
        };
    }

    // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)"
    if (!isMotherCommoner) {
        return { 
            royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", 
            titlePrefix: "‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",     
            relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå",           
            royalSurname: royalSurname, 
            surname: "" 
        };
    }
    
    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"
    if (isMotherCommoner) {
        return { 
            royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
            titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",          
            royalSurname: royalSurname, 
            surname: "" 
        };
    }
}

// ==========================================================
// --- [‡∏Å‡∏é‡∏´‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤) ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤+‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤] ---
// ==========================================================

// 1. ‡∏Å‡∏é‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏û‡πà‡∏≠)
const isPalaceLineFather = father && (
    fatherTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || 
    fatherTitle.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
    fatherTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå") ||
    fatherTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
    fatherTitle.includes("‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
    fatherTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")
);

if (isPalaceLineFather) {
    if (!isMotherCommoner) {
        // ‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢ -> ‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
        return {
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
            titlePrefix: "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
            royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)",
            royalSurname: royalSurname,
            surname: ""
        };
    } else {
        // ‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô -> ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        return {
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
            titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤",
            royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤",
            royalSurname: royalSurname,
            surname: ""
        };
    }
}





// 2. ‡∏Å‡∏é‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏°‡∏´‡∏≤)
// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
const isFatherChaoFa = fatherTitle.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || fatherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
const isMotherChaoFa = motherTitle.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || motherRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");

if (isFatherChaoFa && isMotherChaoFa) {
    // ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏¢‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠
    if (father.relationship !== "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") {
        return {
            relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
            titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
            royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)",
            royalSurname: royalSurname,
            surname: ""
        };
    }
}
// ==========================================================

        
        // A. Father is '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'
        if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) {
            royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå';
            titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå'; 
            relationship = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        } 
        // B. Father is '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå'
        else if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå')) {
            royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á';
            titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'; 
            relationship = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        } 
        // C. ‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
        else if (fatherRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || fatherRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
            
            // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß) ---

            // 1. ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
            if (fatherPrefix === '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠' && fatherRank === '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)') {
                if (motherRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                    royalRank = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)';
                    titlePrefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠';
                    relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
                } else if (motherRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || motherRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') {
                    royalRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)';
                    titlePrefix = '‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠';
                    relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
                } else if (isMotherCommoner) {
                    royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                    titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                    relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
                }
            } 
            // 2. ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó/‡∏ï‡∏£‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
            else if ((fatherPrefix === '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠' && (fatherRank === '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)' || fatherRank === '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)')) || 
                     (fatherPrefix === '‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠' && fatherRank === '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)')) {
                if (motherRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || isMotherCommoner) {
                    royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                    titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                    relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
                } else if (motherRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || motherRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') {
                    royalRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)';
                    titlePrefix = '‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠';
                    relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
                }
            }
            // --- ‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
            else if (fatherRank === '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)' && isMotherCommoner) {
                royalRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)';
                titlePrefix = '‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠';
                relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
            } 
            else if (fatherRank === '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)' && isMotherCommoner) {
                royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
            } 
            else {
                // ‡∏Å‡∏é‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
            }
            // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏© ---
            
        }
        // D. Father is ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á or lower (Child is commoner)
        else if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') || isCommonerDescendant(father)) {
            royalRank = defaultCommonerRank;
            titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
            relationship = defaultCommonerRel;
        }
    }
    
 // --- 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®‡πÅ‡∏•‡πâ‡∏ß) + ‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ---
else if ((!father || isCommonerDescendant(father))) {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
    surname = father ? (father.surname || father.royalSurname || "") : "";

    if (mother && !isCommonerDescendant(mother)) {
        // ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ï‡∏≤‡∏°‡∏ö‡∏¥‡∏î‡∏≤
        royalRank = defaultCommonerRank; // '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô'
        titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
        relationship = '‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        
        // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ---
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isMotherHeir1 = mother.isHeir && parseInt(mother.heirOrder) === 1;
        const isMotherMonarch = mother.isMonarch; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå

        if (isMotherHeir1 || isMotherMonarch) {
            // ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1 ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏°‡πà‡πÑ‡∏î‡πâ
            royalSurname = mother.royalSurname || (mother.originalRoyalSurname || "");
            surname = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏ó‡∏ô
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (royalSurname ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
            royalSurname = ''; 
            
            if (typeof showToast === 'function') {
                showToast(`‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ${mother.name} ‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏¥‡∏î‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô`);
            }
        }
    }
}

// ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
if (royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
    if (!titlePrefix || titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') {
         titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
    }
} else if (royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') || royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á')) {
     titlePrefix = royalRank.split(' ')[0];
}

return { royalRank, titlePrefix, relationship, royalSurname, surname };
}



    // Helper to check if someone is a direct descendant of the Monarch (child or grandchild)
    function isDirectDescendant(ancestorId, descendantId) {
        const d = state.members.find(m => m.id === descendantId);
        if (!d) return { isChild: false, isGrandchild: false };
        
        // Check Child
        const isChild = (d.fatherId === ancestorId || d.motherId === ancestorId);
        if (isChild) return { isChild: true, isGrandchild: false };

        // Check Grandchild (Child of the Monarch's child)
        const father = state.members.find(m => m.id === d.fatherId);
        const mother = state.members.find(m => m.id === d.motherId);
        
        const isGrandchild = (father && (father.fatherId === ancestorId || father.motherId === ancestorId)) ||
                             (mother && (mother.fatherId === ancestorId || mother.motherId === ancestorId));
        
        return { isChild: false, isGrandchild: isGrandchild };
    }

    // ================= NEW SURNAME FIELD LOGIC =================
    
    function toggleSurnameFields() {
        const isFounder = document.getElementById('p_isSurnameFounder').checked;
        const rank = document.getElementById('p_royalRank').value;
        const isCommonerRank = rank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';

        document.getElementById('royalSurnameFounderPanel').classList.toggle('hidden', !isFounder);
        
        // Commoner surname input appears only if rank is commoner AND they are NOT a founder
        document.getElementById('commonerSurnamePanel').classList.toggle('hidden', !isCommonerRank || isFounder);
    }
    
    // ================= PRECEDENCE LOGIC (‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏° Micro Scale) =================

    // ============================================================
// THE SUPREME POJIAM LOGIC 2025 (Unified Version)
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏£‡∏ß‡∏°‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå, ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó, ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á
// ============================================================
function calculatePojiamScore(person) {
    if (!person) return 0;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Code ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ---
    const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
    const isCurrentSpouse = activeMonarch && activeMonarch.spouseIds && activeMonarch.spouseIds.includes(person.id);

    // [‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°] ‡∏ï‡∏±‡∏ß‡∏î‡∏µ‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    const isChaoFa = (person.royalRank || "").includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
    const isSomdejPhraOngChao = !isChaoFa && (person.titlePrefix || "").includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à") && (person.royalRank || "").includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤");
    const rankElevator = isChaoFa ? 100000000 : (isSomdejPhraOngChao ? 50000000 : 0);

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
    const getReignPriorityScore = (p) => {
        const partner = state.members.find(m => m.isMonarch && m.spouseIds && m.spouseIds.includes(p.id));
        const reignNum = partner ? (parseInt(partner.globalReignNumber) || 0) : (parseInt(p.globalReignNumber) || 0);
        return (100 - reignNum); 
    };

    const getSuffixScore = (p) => {
        const fullText = (p.titlePrefix || "") + (p.name || "") + (p.titleSuffix || "");
        if (!fullText) return 0;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ")) return 80000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 70000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 60000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ") || fullText.includes("‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 50000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 40000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ")) return 30000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 20000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 10000;
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ")) return 100000; 
        if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ")) return 100000; 
        return 0;
    };

    const genNum = (typeof getGenerationNumber === 'function') ? getGenerationNumber(person.id) : 0;
    const heir1 = state.members.find(m => m.isHeir && parseInt(m.heirOrder) === 1);
    const isConsortOfHeir1 = heir1 && heir1.spouseIds && heir1.spouseIds.includes(person.id);
    const isWoraConsort = (person.relationship || "").includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ") || (person.relationship || "").includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤");

    const father = state.members.find(m => m.id === person.fatherId);
    const getFatherBaseScore = (f) => {
        if (!f) return 0;
        const fWall = { "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 900, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 800, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 700, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 600, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 500, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 400, "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 100 };
        return (fWall[f.royalRank] || 0) + (100 - (parseInt(f.globalReignNumber) || 0)) + ((100 - (parseInt(f.age) || 0)) * 0.1);
    };
    const pPrecedence = getFatherBaseScore(father) * 1000;

    // --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏® ---
    const rankWall = {
        "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)": 9000000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 9000000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 8000000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 7000000,
        "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 6000000, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 5000000, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 4000000, "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 1000000
    };
     
    // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏°
    const kromScoreMap = { "‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": 60000, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤": 50000, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞": 40000, "‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á": 30000, "‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô": 20000, "‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô": 10000 };

    const applySpecialKromRule = (currentScore) => {
        if (person.kromRank === "‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞") {
            const isHighTier = person.isHighKrom || 
                ["‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏Å", "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤", "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤"].includes(person.relationship) || 
                (person.titlePrefix || "").includes("‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤") || 
                (person.titlePrefix || "").includes("‡∏†‡∏Ñ‡∏¥‡∏ô‡∏µ");
            
            if (isHighTier) {
                return Math.max(currentScore, 958000000); 
            } else {
                return 949999000;
            }
        }
        return currentScore;
    };

    // --- 1. ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô ---
    if (!person.isQueenConsort) {
        if ((person.relationship || '').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || person.relationship === '‡∏´‡∏°‡πà‡∏≠‡∏°') return 0; 
        if (person.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || person.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || person.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') return 0; 
    }

    // --- 2. ZONE A ---
    if (person.isMonarch && person.isAlive && !person.isExMonarch) return 1000000000; 

    if (isCurrentSpouse && person.isAlive) {
        if (person.isQueenConsort || person.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ") return 999000000 + getSuffixScore(person);
    }

    if ((person.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ" || person.titlePrefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤") && isCurrentSpouse && person.isAlive) {
        return 998000000 + getSuffixScore(person);
    }

    if (person.isExMonarch && person.isAlive) return 997000000;

    // --- [Logic Update: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå] ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏î‡∏µ‡∏ï‡∏Ñ‡∏π‡πà‡∏Ñ‡∏£‡∏≠‡∏á ---
    const isExSpouseCandidate = !isCurrentSpouse && person.isAlive && (
        person.isQueenConsort ||
        (person.relationship || "").includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ") ||
        (person.relationship || "").includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ")
    );

    if (isExSpouseCandidate) {
        const isSahayathibodi = (person.relationship || "").includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ");
         
        let groupBase = isSahayathibodi ? 970000000 : 980000000;
        const reignBonus = (getReignPriorityScore(person) * 50000);

        return groupBase + reignBonus + getSuffixScore(person);
    }

    if ((person.relationship === "‡∏û‡∏£‡∏∞‡∏õ‡∏±‡∏¢‡∏Å‡∏≤" || person.relationship === "‡∏û‡∏£‡∏∞‡∏õ‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤") && person.isAlive) return applySpecialKromRule(966000000 + (kromScoreMap[person.kromRank] || 0));
    if ((person.relationship === "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏Å‡∏≤" || person.relationship === "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤") && person.isAlive) return applySpecialKromRule(965000000 + (kromScoreMap[person.kromRank] || 0));

    if ((person.relationship === "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏Å" || person.relationship === "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ") && person.isAlive) {
        const isParentOfCurrent = activeMonarch && (person.id === activeMonarch.fatherId || person.id === activeMonarch.motherId);
        let parentScore = isParentOfCurrent ? 960000000 : 959000000 + (getReignPriorityScore(person) * 1000);
        return applySpecialKromRule(parentScore + (kromScoreMap[person.kromRank] || 0));
    }

    const heirOrder = parseInt(person.heirOrder) || 999;
    if (person.isHeir && heirOrder === 1) return 958999999 + (kromScoreMap[person.kromRank] || 0); 

    if (person.relationship === "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤" && person.isAlive) {
        let pitulaScore = 958000000 + (parseInt(person.age) || 0) * 1000;
        if ((person.titlePrefix || "").includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä")) pitulaScore += 1000000; 
        return applySpecialKromRule(pitulaScore + (kromScoreMap[person.kromRank] || 0) + (pPrecedence / 100));
    }

    if (person.relationship === "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤" && person.isAlive) {
        let pituchaScore = 957000000 + (parseInt(person.age) || 0) * 1000;
        return applySpecialKromRule(pituchaScore + (kromScoreMap[person.kromRank] || 0) + (pPrecedence / 100));
    }

    const highSiblingPrefixes = ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏†‡∏Ñ‡∏¥‡∏ô‡∏µ‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏Å‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏Å‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏ô‡∏¥‡∏©‡∏ê‡∏≤"];
    if (highSiblingPrefixes.includes(person.titlePrefix)) {
        let highSibScore = 955000000 + (parseInt(person.age) || 0) * 1000;
        return applySpecialKromRule(highSibScore + (kromScoreMap[person.kromRank] || 0));
    }

    const monarch1 = state.members.find(m => m.isMonarch && parseInt(m.globalReignNumber) === 1);
    const isSiblingOfRama1 = monarch1 && person.fatherId === monarch1.fatherId && person.id !== monarch1.id;
    if (isSiblingOfRama1) return applySpecialKromRule(954000000 + (parseInt(person.age) || 0) * 1000 + (kromScoreMap[person.kromRank] || 0));

    if ((person.name || "").includes("‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•") || person.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") return 949999900; 
    if ((person.name || "").includes("‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç") || person.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á") return 949999800; 

    const highPrefixes = ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è"];
    if (highPrefixes.includes(person.titlePrefix)) {
        let somdejScore = 949700000; 
        const sroiScore = getSuffixScore(person);
        const reignPriority = getReignPriorityScore(person);
        let addOn = (sroiScore * 10) + (isCurrentSpouse ? 500 : 0) + (reignPriority / 100) + (kromScoreMap[person.kromRank] || 0);
        return applySpecialKromRule(somdejScore + addOn);
    }
     
    // --- [Logic Update] ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ---
    const isBawromGroup = person.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" || 
                                person.titlePrefix?.includes("‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || 
                                person.titlePrefix?.includes("‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠");

    if (isBawromGroup && !person.titlePrefix?.includes("‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå") && !person.titlePrefix?.includes("‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå") && !person.titlePrefix?.includes("‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) {
        let bwBase = 800000000; 
        let bwScore = bwBase;

        if (person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à") && isChaoFa && person.kromRank) {
            bwScore += ((kromScoreMap[person.kromRank] || 0) * 200) + (rankWall[person.royalRank] || 0);
        } else {
            bwScore += (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        }

        if (person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) {
            if (person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠")) {
                bwScore += 450000; 
            } else {
                bwScore += 500000; 
            }
        } 
        else {
            bwScore += 100000; 
        }
        return applySpecialKromRule(bwScore + (pPrecedence / 100)); 
    }

    // --- [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á] ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏±‡∏ö Base Score ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ Offset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞ ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤ ---
    const secondaryQueens = { 
        "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": 7000000, 
        "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è": 6500000, 
        "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠": 6000000, 
        "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": 3000000, 
        "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": 2500000, 
        "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": 2000000, 
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": 1500000, 
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": 1000000 
    };

    if (secondaryQueens[person.titlePrefix]) {
        let base;
        const topTier = ["‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"];
        
        if (topTier.includes(person.titlePrefix)) { base = 812000000; } else { base = 780000000; }
        
        let sqScore = base + secondaryQueens[person.titlePrefix] + (kromScoreMap[person.kromRank] || 0);
        const rNum = parseInt(person.globalReignNumber) || 0;
        if (isCurrentSpouse && person.isAlive) { sqScore += 900000; } else if (rNum > 0) { sqScore += (800000 - rNum); }
        return applySpecialKromRule(sqScore);
    }

    const isMonarchSibling = activeMonarch && person.fatherId === activeMonarch.fatherId && person.id !== activeMonarch.id;
    const isPhakhini = person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ");

    if (isMonarchSibling || isPhakhini) {
        if (isChaoFa || isPhakhini) {
            if ((isMonarchSibling && person.motherId === activeMonarch.motherId) || isPhakhini) {
                let sibScore = 930000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
                return applySpecialKromRule(sibScore + (parseInt(person.age) || 0) * 1000 + (pPrecedence / 100));
            } else {
                let sibScore = 850000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
                return applySpecialKromRule(sibScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
            }
        } else if ((person.royalRank || "").includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) {
            let sibScore = 800150000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0); 
            return applySpecialKromRule(sibScore + (parseInt(person.age) || 0) * 10 + (pPrecedence / 1000));
        }
    }

    // --- [Logic Update] ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠/‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ---
    const isCurrentChild = activeMonarch && (person.fatherId === activeMonarch.id || person.relationship?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™") || person.relationship?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤"));
    if (isCurrentChild) {
        let childScore = 900000000;
        if (person.kromRank) {
            childScore += ((kromScoreMap[person.kromRank] || 0) * 200) + (rankWall[person.royalRank] || 0);
        } else {
            childScore += (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        }

        const mother = state.members.find(m => m.id === person.motherId);
        if (mother) {
            if (mother.royalRank?.includes("‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) childScore += 500000;
            else if (mother.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤")) childScore += 300000;
            else if (mother.relationship?.includes("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤")) childScore += 100000;
        }
        return applySpecialKromRule(childScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    if (isMonarchSibling && person.motherId !== activeMonarch.motherId) {
        let sibScore = 850000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        return applySpecialKromRule(sibScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    if ((person.titlePrefix || "").includes("‡∏†‡∏≤‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ò‡∏≠")) {
        let phatikaScore = 840000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) phatikaScore += 5000000; 
        return applySpecialKromRule(phatikaScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || person.relationship === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") {
        let glScore = 720000000 + (rankWall[person.royalRank] || 0) + rankElevator + (kromScoreMap[person.kromRank] || 0); 
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) glScore += 5000000;
        return applySpecialKromRule(glScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    if (person.titlePrefix?.includes("‡∏†‡∏≤‡∏ï‡∏¥‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠")) {
        let phatiyaScore = 700000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) phatiyaScore += 5000000;
        return applySpecialKromRule(phatiyaScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    if (person.titlePrefix?.includes("‡∏†‡∏≤‡∏Ñ‡∏¥‡πÑ‡∏ô‡∏¢‡πÄ‡∏ò‡∏≠") || person.titlePrefix?.includes("‡∏†‡∏Ñ‡∏¥‡πÑ‡∏ô‡∏¢‡πÄ‡∏ò‡∏≠")) {
        let phakhinaiScore = 680000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) phakhinaiScore += 5000000;
        return applySpecialKromRule(phakhinaiScore + (pPrecedence / 100) + (100 - (parseInt(person.age) || 0)));
    }

    let lineageScore = (typeof getLineageBaseScore === 'function') ? getLineageBaseScore(person) : 0;
    if (lineageScore > 0) return applySpecialKromRule(lineageScore + (kromScoreMap[person.kromRank] || 0) + (pPrecedence / 1000));

    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå / ‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå / ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå ---
    if (person.titlePrefix?.includes("‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå") || 
        person.titlePrefix?.includes("‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå") || 
        person.titlePrefix?.includes("‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) {
        
        let subBase = 630000000; 
        
        if (person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à") && isChaoFa) {
            let specialSubScore = 800000000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
            
            if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå")) specialSubScore += 500000;
            else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå")) specialSubScore += 480000;
            else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) specialSubScore += 450000; 
            else if (person.titlePrefix?.includes("‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) specialSubScore += 400000;
            
            return applySpecialKromRule(specialSubScore + (pPrecedence / 100));
        }

        let subScore = subBase + (rankWall[person.royalRank] || 0) + rankElevator + (kromScoreMap[person.kromRank] || 0);
        
        if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå")) subScore += 500000;
        else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) subScore += 300000; 
        else if (person.titlePrefix?.includes("‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) subScore += 100000;

        if (person.titlePrefix?.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) subScore += 500000;
        return applySpecialKromRule(subScore + (pPrecedence / 100));
    }

    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3] ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå/‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå/‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå) ---
    // 1. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
    if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && isChaoFa) {
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) {
            return applySpecialKromRule(800300000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0));
        }
    }
     
    // 2. [New] ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏Å‡∏•‡∏≤‡∏á)
    if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && isChaoFa) {
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) {
            return applySpecialKromRule(800250000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0));
        }
    }

    // 3. ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠)
    if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && isChaoFa) {
        if (person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) {
            return applySpecialKromRule(800200000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0));
        }
    }

    // --- 3. ZONE B/C ---
    let score = applySpecialKromRule(0);
     
    const rankScoreMapAnu = {
        "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)": 70000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 70000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 60000, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 50000,
        "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 40000, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 30000, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 20000, "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 10000
    };

    // --- [UPDATED Logic] ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô ---
    if (person.royalRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") {
        let mcScore = 1000000; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        
        // --- 1. [New Rule] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏´‡∏•‡∏≤‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ---
        const isGrandchildOfActive = father && activeMonarch && father.fatherId === activeMonarch.id;
        const isSameRajsakul = activeMonarch && (
            (person.rajsakul && person.rajsakul === activeMonarch.rajsakul) || 
            (person.lastName && person.lastName === activeMonarch.lastName)
        );

        if (isGrandchildOfActive) {
            // [Tier ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î] ‡∏´‡∏•‡∏≤‡∏ô‡πÉ‡∏ô‡πÑ‡∏™‡πâ‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ MC ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á)
            // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÅ‡∏ï‡∏∞‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 4,000,000)
            mcScore = 3900000;
            if (person.age) mcScore += (parseInt(person.age) * 1000);

        } else if (isSameRajsakul) {
            // [Tier ‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤] ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ MC ‡∏™‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô)
            mcScore = 3500000;
            if (person.age) mcScore += (parseInt(person.age) * 1000);

        } else {
            // --- [Original Logic] ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏¢‡∏®‡∏û‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ ---
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á Tier (‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å vs ‡∏´‡∏•‡∏≤‡∏ô vs ‡πÄ‡∏´‡∏•‡∏ô)
            if (father) {
                const fPrefix = father.titlePrefix || "";
                const fRank = father.royalRank || "";

                // --- Tier 1: ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å (‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ---
                const isClassChild = [
                    "‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠", "‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
                    "‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
                    "‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏†‡∏Ñ‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏Å‡∏ô‡∏¥‡∏©‡∏ê‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤",
                    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á",
                    "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á" 
                ].some(kw => fPrefix.includes(kw));

                // --- Tier 2: ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏ô (‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤) ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ---
                const isClassGrandchild = [
                    "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", 
                    "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
                    "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
                    "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
                ].some(kw => fPrefix.includes(kw));

                if (isClassChild) {
                    mcScore += 500000; // Bonus ‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å
                } else if (isClassGrandchild) {
                    mcScore += 300000; // Bonus ‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏ô
                } else {
                    mcScore += 100000; // Bonus ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏ô/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                }

                // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Tier: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡πà‡∏≠
                mcScore += (getFatherBaseScore(father) * 100); 

            } else {
                // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠ -> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
                mcScore += 50000;
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            if (person.age) mcScore += (parseInt(person.age) * 0.1);
        }

        score += mcScore;

    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô Zone C)
        score += (rankScoreMapAnu[person.royalRank] || 0) + rankElevator; 
    }

    const kromScoreMapAnu = { 
        "‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": 50000, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤": 40000, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞": 30000, "‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á": 20000, "‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô": 10000, "‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô": 5000 
    };

    if (person.kromRank && kromScoreMapAnu[person.kromRank]) {
        score += 100000; 
        score += kromScoreMapAnu[person.kromRank]; 
    }

    // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå / ‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå / ‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå / ‡∏ß‡∏á‡∏®‡πå ---
    // 1. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (30M)
    if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        const isSomdejChaoFaWora = person.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à") && isChaoFa;
        if (isSomdejChaoFaWora) {
            score = 800300000 + (rankWall[person.royalRank] || 0) + (kromScoreMap[person.kromRank] || 0);
        } else {
            score += 30000000 + (kromScoreMap[person.kromRank] || 0); 
            const isSpecialWora = (person.relationship === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" && 
                              ((person.titleSuffix || "").includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤") || 
                               (person.titleSuffix || "").includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ")));
            if (isSpecialWora) score += 650000000;
        }
    } 
    // 2. [New] ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (28M) - ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 28000000 + (kromScoreMap[person.kromRank] || 0);
    }
    // 3. [New] ‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ / ‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (25M)
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 25000000 + (kromScoreMap[person.kromRank] || 0);
    }
    // 4. ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (20M)
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 20000000 + (kromScoreMap[person.kromRank] || 0); 
    } 
    // 5. [New] ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (17M) - ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 17000000 + (kromScoreMap[person.kromRank] || 0);
    }
    // 6. [New] ‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (14M) - ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 14000000 + (kromScoreMap[person.kromRank] || 0);
    }
    // 7. ‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (10M) - ‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    else if (person.titlePrefix?.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
        score += 10000000 + (kromScoreMap[person.kromRank] || 0); 
    }

    if (person.royalRank === "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)" && isConsortOfHeir1 && isWoraConsort) score += 5000; 
    score += (pPrecedence / 1000000) + (100 - genNum);
    if (person.age) score += (parseInt(person.age) * 0.001);
    const idSuffix = person.id.length >= 6 ? person.id.substring(person.id.length - 6) : person.id;
    score -= (parseInt(idSuffix.replace(/\D/g, '')) || 0) / 1000000;

    return score;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á
function movePrecedence(id, direction) {

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    const filterStatus = document.getElementById('tableFilterStatus').value;

    // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
    let list = state.members.filter(m => m.isAlive && calculatePojiamScore(m) > 0);
    
    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Manual + Auto)
   list.sort((a, b) => {
    if (filterStatus === 'precedence') {
        const valA = a.customPrecedence !== undefined ? a.customPrecedence : calculatePojiamScore(a);
        const valB = b.customPrecedence !== undefined ? b.customPrecedence : calculatePojiamScore(b);
        return valB - valA;
    }
    return (parseInt(a.birthYear) || Infinity) - (parseInt(b.birthYear) || Infinity);
});

    const index = list.findIndex(m => m.id === id);
    if (index === -1) return;

    const targetIndex = index + direction; // direction: -1 ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô, 1 ‡∏Ñ‡∏∑‡∏≠‡∏•‡∏á
    if (targetIndex < 0 || targetIndex >= list.length) return;

    const currentPerson = list[index];
    const targetPerson = list[targetIndex];

    // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ customPrecedence ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (currentPerson.customPrecedence === undefined) currentPerson.customPrecedence = calculatePojiamScore(currentPerson);
    if (targetPerson.customPrecedence === undefined) targetPerson.customPrecedence = calculatePojiamScore(targetPerson);

    // 4. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö (Swap) ‡∏Ñ‡πà‡∏≤ customPrecedence
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏±‡∏ô
    const temp = currentPerson.customPrecedence;
    currentPerson.customPrecedence = targetPerson.customPrecedence;
    targetPerson.customPrecedence = temp;

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    if (currentPerson.customPrecedence === targetPerson.customPrecedence) {
        currentPerson.customPrecedence += (direction * -0.01);
    }

    saveState();
    renderTable();
    showToast(`‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ${currentPerson.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
}

function resetPrecedence() {
    state.members.forEach(m => delete m.customPrecedence); //
    saveState(); //
    renderTable(); //
    showToast("‡∏£‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); //
}

// ================= RANK MANAGER (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) =================
let selR = null, selP = null;
let editingItem = { type: null, value: null }; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ñ‡∏ß‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà

function openRankManagementModal() { 
    editingItem = { type: null, value: null }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    renderRM(); 
    document.getElementById('rankManagementModal').classList.add('active'); 
    setTimeout(initSortableColumns, 100); 
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
function editData(type, value) {
    editingItem = { type: type, value: value };
    renderRM();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function cancelInlineEdit() {
    editingItem = { type: null, value: null };
    renderRM();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
function saveInlineEdit(type, oldVal) {
    const nameInput = document.getElementById('inline_edit_name');
    const scoreInput = document.getElementById('inline_edit_score');
    
    const newVal = nameInput ? nameInput.value.trim() : oldVal;
    const newScore = scoreInput ? parseInt(scoreInput.value) || 0 : 0;

    if (!newVal) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

    if (type === 'rel') {
        state.hierarchy[newVal] = state.hierarchy[oldVal];
        if (newVal !== oldVal) delete state.hierarchy[oldVal];
        if (selR === oldVal) selR = newVal;
    } 
    else if (type === 'pre') {
        const idx = state.hierarchy[selR].prefixes.indexOf(oldVal);
        if (idx !== -1) state.hierarchy[selR].prefixes[idx] = newVal;
        if (newVal !== oldVal) {
            state.hierarchy[selR].suffixes[newVal] = state.hierarchy[selR].suffixes[oldVal];
            delete state.hierarchy[selR].suffixes[oldVal];
            if (selP === oldVal) selP = newVal;
        }
        state.prefixScores[newVal] = newScore;
        if (newVal !== oldVal) delete state.prefixScores[oldVal];
    } 
    else if (type === 'suf') {
        const idx = state.hierarchy[selR].suffixes[selP].indexOf(oldVal);
        if (idx !== -1) state.hierarchy[selR].suffixes[selP][idx] = newVal;
        state.suffixScores[newVal] = newScore;
        if (newVal !== oldVal) delete state.suffixScores[oldVal];
    }
    else if (type === 'reign') {
        const idx = state.reignNames.indexOf(oldVal);
        if (idx !== -1) state.reignNames[idx] = newVal;
    }

    editingItem = { type: null, value: null };
    saveState();
    renderRM();
    refreshAllDisplays();
    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®");
}

function renderRM() {
    if(!state.prefixScores) state.prefixScores = {};
    if(!state.suffixScores) state.suffixScores = {};

    // 1. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
    const rl = document.getElementById('rl'); rl.innerHTML = '';
    Object.keys(state.hierarchy).forEach(k => {
        if (editingItem.type === 'rel' && editingItem.value === k) {
            rl.innerHTML += inlineEditHTML('rel', k);
        } else {
            rl.innerHTML += itemHTML('rel', k, `delData('rel','${k}')`, `selectRel('${k}')`, null, selR === k);
        }
    });

    // 2. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
    const pl = document.getElementById('pl');
    pl.innerHTML = selR ? '' : '<div class="text-center py-10 text-slate-300 text-[10px] italic">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô</div>';
    if(selR) {
        state.hierarchy[selR].prefixes.forEach(p => {
            const score = state.prefixScores[p] || 0;
            if (editingItem.type === 'pre' && editingItem.value === p) {
                pl.innerHTML += inlineEditHTML('pre', p, score);
            } else {
                pl.innerHTML += itemHTML('pre', p, `delData('pre','${p}')`, `selectPre('${p}')`, score, selP === p);
            }
        });
    }

    // 3. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
    const sl = document.getElementById('sl');
    sl.innerHTML = (selR && selP) ? '' : '<div class="text-center py-10 text-slate-300 text-[10px] italic">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div>';
    if(selR && selP) {
        (state.hierarchy[selR].suffixes[selP] || []).forEach(s => {
            const score = state.suffixScores[s] || 0;
            if (editingItem.type === 'suf' && editingItem.value === s) {
                sl.innerHTML += inlineEditHTML('suf', s, score);
            } else {
                sl.innerHTML += itemHTML('suf', s, `delData('suf','${s}')`, "", score);
            }
        });
    }

    // 4. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
    const gl = document.getElementById('reignl'); gl.innerHTML = '';
    state.reignNames.forEach(n => { 
        if (editingItem.type === 'reign' && editingItem.value === n) {
            gl.innerHTML += inlineEditHTML('reign', n);
        } else {
            gl.innerHTML += itemHTML('reign', n, `delData('reign','${n}')`); 
        }
    });
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÅ‡∏ô‡∏ö‡∏°‡∏≤)
function inlineEditHTML(type, value, score = 0) {
    const showScore = (type === 'pre' || type === 'suf');
    return `
        <div class="p-3 bg-white rounded-2xl border-2 border-blue-100 shadow-sm mb-2 space-y-2 animate-fade-in">
            <div class="flex gap-2">
                <input id="inline_edit_name" class="flex-1 px-3 py-2 rounded-xl border-2 border-sky-400 outline-none text-sm font-bold" value="${value}">
                ${showScore ? `<input id="inline_edit_score" type="number" class="w-16 px-1 py-2 rounded-xl border-2 border-slate-100 outline-none text-sm text-center" value="${score}">` : ''}
            </div>
            <div class="flex gap-2">
                <button onclick="saveInlineEdit('${type}', '${value}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl text-[11px] font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="cancelInlineEdit()" class="px-4 bg-slate-400 hover:bg-slate-500 text-white py-2 rounded-xl text-[11px] font-bold transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>`;
}

function itemHTML(type, value, deleteFn, clickFn = "", score = null, isSelected = false) {
    const scoreBadge = score !== null ? `<div class="text-[10px] text-slate-400 font-mono">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}</div>` : '';
    const activeClass = isSelected ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-50';
    return `
        <li data-id="${value}" data-type="${type}" class="flex justify-between items-center p-3 border rounded-2xl transition group ${activeClass} mb-1" onclick="${clickFn}">
            <div class="flex items-center gap-3 overflow-hidden">
                <i class="fa-solid fa-grip-vertical text-slate-200 text-xs shrink-0 cursor-grab"></i>
                <div class="truncate">
                    <div class="text-sm font-bold ${isSelected ? 'text-indigo-600' : 'text-slate-700'} truncate">${value}</div>
                    ${scoreBadge}
                </div>
            </div>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                <button onclick="event.stopPropagation(); editData('${type}', '${value}')" class="p-1.5 text-blue-400 hover:bg-blue-50 rounded-lg">
                    <i class="fa-solid fa-pen-to-square text-xs"></i>
                </button>
                <button onclick="event.stopPropagation(); ${deleteFn}" class="p-1.5 text-red-300 hover:text-red-500">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
            </div>
        </li>`;
}

function selectRel(k){ selR=k; selP=null; renderRM(); }
function selectPre(p){ selP=p; renderRM(); }

function addData(type) {
    if (type === 'rel') {
        const val = document.getElementById('nr').value.trim();
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå");
        state.hierarchy[val] = { prefixes: [], suffixes: {} };
        document.getElementById('nr').value = '';
    } 
    else if (type === 'pre') {
        if (!selR) return showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô");
        const val = document.getElementById('np').value.trim();
        const score = parseInt(document.getElementById('np_score').value) || 0;
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤");
        state.hierarchy[selR].prefixes.push(val);
        state.hierarchy[selR].suffixes[val] = [];
        state.prefixScores[val] = score;
        document.getElementById('np').value = ''; document.getElementById('np_score').value = '';
    } 
    else if (type === 'suf') {
        if (!selR || !selP) return showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
        const val = document.getElementById('ns').value.trim();
        const score = parseInt(document.getElementById('ns_score').value) || 0;
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°");
        state.hierarchy[selR].suffixes[selP].push(val);
        state.suffixScores[val] = score;
        document.getElementById('ns').value = ''; document.getElementById('ns_score').value = '0';
    } 
    else if (type === 'reign') {
        const val = document.getElementById('nreign').value.trim();
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô");
        state.reignNames.push(val);
        document.getElementById('nreign').value = '';
    }
   saveState(); renderRM(); updateApp(); showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®"); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
}

function delData(type, val) {
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
    if(type==='rel') delete state.hierarchy[val];
    else if(type==='pre') {
        state.hierarchy[selR].prefixes = state.hierarchy[selR].prefixes.filter(x=>x!==val);
        if(state.prefixScores) delete state.prefixScores[val];
    }
    else if(type==='suf') {
        state.hierarchy[selR].suffixes[selP] = state.hierarchy[selR].suffixes[selP].filter(x=>x!==val);
        if(state.suffixScores) delete state.suffixScores[val];
    }
    else if(type==='reign') state.reignNames = state.reignNames.filter(x=>x!==val);
    saveState(); renderRM(); updateApp(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
}

function initSortableColumns() {
    const config = {
        animation: 150, handle: '.fa-grip-vertical',
        onEnd: function(evt) {
            const type = evt.item.getAttribute('data-type');
            reorderState(type, evt.from);
        }
    };
    if (document.getElementById('rl')) new Sortable(document.getElementById('rl'), config);
    if (document.getElementById('pl')) new Sortable(document.getElementById('pl'), config);
    if (document.getElementById('sl')) new Sortable(document.getElementById('sl'), config);
    if (document.getElementById('reignl')) new Sortable(document.getElementById('reignl'), config);
}

function reorderState(type, parentEl) {
    const newOrder = Array.from(parentEl.children).map(li => li.getAttribute('data-id')).filter(id => id);
    if (type === 'rel') {
        const newHierarchy = {};
        newOrder.forEach(key => { if(state.hierarchy[key]) newHierarchy[key] = state.hierarchy[key]; });
        state.hierarchy = newHierarchy;
    } else if (type === 'pre' && selR) {
        state.hierarchy[selR].prefixes = newOrder;
    } else if (type === 'suf' && selR && selP) {
        state.hierarchy[selR].suffixes[selP] = newOrder;
    } else if (type === 'reign') {
        state.reignNames = newOrder;
    }
    saveState(); updateApp(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
}
    

    function selectRel(k){ selR=k; renderRM(); }
    function selectPre(p){ selP=p; renderRM(); }

    // ================= TABLE RENDER =================

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î
function onTableFilterChange() {
    const filterStatus = document.getElementById('tableFilterStatus').value;
    const monarchContainer = document.getElementById('monarchFilterContainer');
    const surnameContainer = document.getElementById('surnameFilterContainer'); 
    const kingsContainer = document.getElementById('kingsFilterContainer'); 
    const spouseContainer = document.getElementById('spouseFilterContainer'); 
    const kulachetContainer = document.getElementById('kulachetFilterContainer');
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Container ‡πÉ‡∏´‡∏°‡πà
    const affiliationContainer = document.getElementById('affiliationFilterContainer'); 
    const royalHeader = document.getElementById('royalChildrenHeader');
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ SortableJS (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    if (filterStatus !== 'precedence' && typeof tableSortableInstance !== 'undefined' && tableSortableInstance) {
        tableSortableInstance.destroy();
        tableSortableInstance = null;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Reset Precedence (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    const btnReset = document.getElementById('btnResetPrecedence');
    if (btnReset) btnReset.classList.toggle('hidden', filterStatus !== 'precedence');

    // --- ‡∏™‡πà‡∏ß‡∏ô Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
    if (filterStatus === 'royal_children') {
        monarchContainer.classList.remove('hidden');
        monarchContainer.classList.add('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden'); 
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden');
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        populateMonarchFilterSelect();
    } 
    else if (filterStatus === 'royal_surnames') { 
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden'); 
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        
        if (surnameContainer) {
            surnameContainer.classList.remove('hidden');
            surnameContainer.classList.add('flex');
            
            if (typeof populateSurnameLineageFilter === 'function') {
                populateSurnameLineageFilter(); 
            }
            populateSurnameTableSelect(); 
        }
    }
    else if (filterStatus === 'kings') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (spouseContainer) spouseContainer.classList.add('hidden'); 
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        
        if (kingsContainer) {
            kingsContainer.classList.remove('hidden');
            kingsContainer.classList.add('flex');
            populateKingsReignNameSelect(); 
        }
    }
    else if (filterStatus === 'royal_spouses') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        
        if (spouseContainer) {
            spouseContainer.classList.remove('hidden');
            spouseContainer.classList.add('flex');
            populateSpouseKingSelect(); 
        }
    }
    else if (filterStatus === 'kulachet') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        if (royalHeader) royalHeader.classList.add('hidden');
        
        if (kulachetContainer) {
            kulachetContainer.classList.remove('hidden');
            kulachetContainer.classList.add('flex');
            populateKulachetFilterSelect();
        }
    }
    else if (filterStatus === 'palace_law') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden');
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        
        if (royalHeader) {
            const activeKing = (typeof state !== 'undefined' && state.members) 
                ? state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch) 
                : null;
            
            const kingName = activeKing 
                ? (typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(activeKing) : activeKing.name_th) 
                : "";

            royalHeader.innerText = `‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÉ‡∏ô ${kingName}`;
            royalHeader.classList.remove('hidden');
        }
    }
    // +++++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô Precedence (‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°) +++++
    else if (filterStatus === 'precedence') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden');
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation

        if (royalHeader) {
            const activeKing = (typeof state !== 'undefined' && state.members) 
                ? state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch) 
                : null;
            
            const kingName = activeKing 
                ? (typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(activeKing) : activeKing.name_th) 
                : "";

            royalHeader.innerText = `‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏≤‡∏¢‡∏®‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡∏≤‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå (‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°) ‡πÉ‡∏ô ${kingName}`;
            royalHeader.classList.remove('hidden');
        }
    }
    // +++++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô Affiliation (‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏ô‡∏≤‡∏á‡πÉ‡∏ô) +++++
    else if (filterStatus === 'affiliation') {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden');
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden');
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        
        if (affiliationContainer) {
            affiliationContainer.classList.remove('hidden');
            affiliationContainer.classList.add('flex');
            populateAffiliationSelect(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢
        }
    }
    // +++++++++++++++++++++++++++++++++++++++++++++++
    else {
        // ‡∏Å‡∏£‡∏ì‡∏µ Default (All, Alive, Dead)
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (surnameContainer) surnameContainer.classList.add('hidden'); 
        if (kingsContainer) kingsContainer.classList.add('hidden'); 
        if (spouseContainer) spouseContainer.classList.add('hidden'); 
        if (kulachetContainer) kulachetContainer.classList.add('hidden');
        if (affiliationContainer) affiliationContainer.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô affiliation
        if (royalHeader) royalHeader.classList.add('hidden');
    }
    
    renderTable();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Dropdown)
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)
function populateKingsReignNameSelect() {
    const sel = document.getElementById('kingsReignNameSelect');
    if (!sel) return;
    const currentVal = sel.value;
    sel.innerHTML = '<option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô --</option>';
    
    const monarchList = state.members.filter(m => m.isMonarch && m.reignNameBase);
    const uniqueNames = [...new Set(monarchList.map(m => m.reignNameBase))].sort();
    
    uniqueNames.forEach(name => {
        sel.add(new Option(name, name));
    });
    
    if (currentVal) sel.value = currentVal;
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)
function populateSpouseKingSelect() {
    const sel = document.getElementById('spouseKingSelect');
    if (!sel) return;
    const currentVal = sel.value;
    sel.innerHTML = '<option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå --</option>';
    
    const monarchs = state.members.filter(m => m.isMonarch && m.spouseIds && m.spouseIds.length > 0)
        .sort((a,b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));
        
    monarchs.forEach(m => {
        const reignText = m.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : '';
        sel.add(new Option(`${reignText} ${m.name}`, m.id));
    });
    sel.value = currentVal || "all";
}





// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 1 - ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 3")
function parseReignCoverage(text) {
    if (!text) return [];
    
    // 1. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
    let cleanText = text.replace(/‡πë/g, '1').replace(/‡πí/g, '2').replace(/‡πì/g, '3')
                        .replace(/‡πî/g, '4').replace(/‡πï/g, '5').replace(/‡πñ/g, '6')
                        .replace(/‡πó/g, '7').replace(/‡πò/g, '8').replace(/‡πô/g, '9').replace(/‡πê/g, '0');
    
    // 2. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ü‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "1-3" 
    // ‡∏•‡∏ö "‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•", "‡∏ó‡∏µ‡πà", "‡∏£.", "‡∏£", "‡∏•‡∏≥‡∏î‡∏±‡∏ö", ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    cleanText = cleanText.replace(/‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•/g, '').replace(/‡∏ó‡∏µ‡πà/g, '').replace(/‡∏£\./g, '').replace(/‡∏£/g, '').trim();
    
    // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "1-3" ‡∏´‡∏£‡∏∑‡∏≠ "1 - 3" ‡πÅ‡∏°‡πâ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 1 - ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 3"

    let covered = new Set();

    // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡πÄ‡∏•‡∏Ç - ‡πÄ‡∏•‡∏Ç" (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡∏µ‡∏î‡∏™‡∏±‡πâ‡∏ô -, ‡∏Ç‡∏µ‡∏î‡∏¢‡∏≤‡∏ß ‚Äì, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ñ‡∏∂‡∏á")
    const rangeRegex = /(\d+)\s*[-‚Äì]|‡∏ñ‡∏∂‡∏á\s*(\d+)/g; 
    
    // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Regex ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà "1-3" ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏µ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ split ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏µ‡∏î‡∏à‡∏∞‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏µ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏µ‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á
    const parts = cleanText.split(/[-‚Äì]|‡∏ñ‡∏∂‡∏á/);
    
    if (parts.length === 2) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "1" ‡∏Å‡∏±‡∏ö "3"
        const start = parseInt(parts[0].replace(/\D/g, '')); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const end = parseInt(parts[1].replace(/\D/g, ''));   // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        
        if (!isNaN(start) && !isNaN(end) && start <= end) {
            for (let i = start; i <= end; i++) covered.add(i);
        }
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏ä‡πà‡∏ô 1, 3-5) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Regex ‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏Å
        const rangeRegex2 = /(\d+)\s*[-‚Äì]\s*(\d+)/g;
        let match;
        while ((match = rangeRegex2.exec(cleanText)) !== null) {
            const s = parseInt(match[1]);
            const e = parseInt(match[2]);
            if (s <= e) {
                for (let i = s; i <= e; i++) covered.add(i);
            }
        }
    }

    // 4. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 1, 3, 5)
    const numRegex = /(\d+)/g;
    let matchNum;
    while ((matchNum = numRegex.exec(cleanText)) !== null) {
        covered.add(parseInt(matchNum[1]));
    }

    return Array.from(covered);
}

function populateKulachetFilterSelect() {
    const sel = document.getElementById('kulachetFilterSelect');
    if (!sel) return;
    const currentVal = sel.value;
    sel.innerHTML = `
        <option value="all">üìú ‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="current">‚ú® ‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</option>
    `;
    const monarchs = state.members
        .filter(m => m.isMonarch && m.globalReignNumber)
        .sort((a, b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));

    monarchs.forEach(m => {
        const rNum = parseInt(m.globalReignNumber);
        const rNumText = typeof toThaiNumerals === 'function' ? toThaiNumerals(rNum) : rNum;
        sel.add(new Option(`‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${rNumText}`, `reign_${rNum}`));
    });
    if (currentVal && currentVal !== 'all') sel.value = currentVal;
}


// --- ‡∏ä‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ (Affiliation) ---

// ==========================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
// ==========================================

function populateAffiliationSelect() {
    const listContainer = document.getElementById('affiliationDropdownList');
    const searchInput = document.getElementById('affiliationSearchInput');
    const hiddenInput = document.getElementById('affiliationSelect');
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    if (!listContainer || !searchInput || !hiddenInput) return;
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤
    listContainer.innerHTML = '';
    searchInput.value = '';
    hiddenInput.value = '';

    // 1. ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏á‡πÉ‡∏ô (‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°/‡∏ó‡πâ‡∏≤‡∏ß) ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
    const patronIds = new Set();
    if (typeof state !== 'undefined' && state.members) {
        state.members.forEach(m => {
            // [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç]: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á ‡∏¢‡∏® ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
            const rank = m.royalRank || '';
            const prefix = m.titlePrefix || ''; 
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°, ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤, ‡∏ó‡πâ‡∏≤‡∏ß, ‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏¢‡∏®‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
            const isLadyInWaiting = rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') || rank.includes('‡∏ó‡πâ‡∏≤‡∏ß') || 
                                    prefix.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') || prefix.includes('‡∏ó‡πâ‡∏≤‡∏ß');
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏ß‡∏°: ‡∏°‡∏µ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î + ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏á‡πÉ‡∏ô + ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà
            if (m.affiliationId && isLadyInWaiting && m.isAlive) { 
                patronIds.add(m.affiliationId);
            }
        });
    }

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢
    const patrons = [];
    patronIds.forEach(id => {
        const p = state.members.find(m => m.id === id);
        if (p) patrons.push(p);
    });

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏® (‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°)
    patrons.sort((a, b) => (b.pojiamScore || 0) - (a.pojiamScore || 0));

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
    if (patrons.length === 0) {
        listContainer.innerHTML = '<div class="p-3 text-center text-slate-400 text-xs italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</div>';
        // ‡πÑ‡∏°‡πà return ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Dropdown ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    }

    patrons.forEach(p => {
        const nameDisplay = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(p) : p.name;
        // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ)
        const imgUrl = p.image || (p.gender==='M' ? 'https://cdn-icons-png.flaticon.com/512/4128/4128176.png' : 'https://cdn-icons-png.flaticon.com/512/4128/4128253.png');
        const rankText = p.royalRank || '';

        const div = document.createElement('div');
        div.className = "affiliation-option flex items-center gap-3 p-2 rounded-lg hover:bg-pink-50 cursor-pointer transition-colors border-b border-slate-50 last:border-0";
        
        div.innerHTML = `
            <img src="${imgUrl}" class="w-8 h-8 rounded-full object-cover border border-slate-200 shadow-sm flex-shrink-0">
            <div class="flex flex-col text-left">
                <span class="text-sm text-slate-700 leading-tight">${nameDisplay}</span> 
                <span class="text-[10px] text-slate-400">${rankText}</span>
            </div>
        `;
        
        div.dataset.name = nameDisplay.toLowerCase();
        div.onclick = () => selectAffiliationPatron(p.id, nameDisplay);
        
        listContainer.appendChild(div);
    });

    // Event ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    document.removeEventListener('click', closeAffiliationDropdown);
    document.addEventListener('click', closeAffiliationDropdown);
}

function closeAffiliationDropdown(e) {
    const container = document.getElementById('affiliationFilterContainer');
    if (container && !container.contains(e.target)) {
        const list = document.getElementById('affiliationDropdownList');
        if (list) list.classList.add('hidden');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå)
function filterAffiliationList() {
    const inputVal = document.getElementById('affiliationSearchInput').value.toLowerCase().trim();
    const list = document.getElementById('affiliationDropdownList');
    
    if (!list) return;

    // 1. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
    list.classList.remove('hidden'); 

    // 2. ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà -> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ ID ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á
    if (inputVal !== '') {
        const hiddenInput = document.getElementById('affiliationSelect');
        if (hiddenInput) hiddenInput.value = '';
    }

    // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const items = list.querySelectorAll('.affiliation-option');
    let foundCount = 0;
    
    items.forEach(item => {
        const name = item.dataset.name || "";
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏â‡∏¢‡πÜ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -> ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
        if (inputVal === '' || name.includes(inputVal)) {
            item.classList.remove('hidden');
            item.classList.add('flex');
            foundCount++;
        } else {
            item.classList.add('hidden');
            item.classList.remove('flex');
        }
    });
}

function selectAffiliationPatron(id, name) {
    document.getElementById('affiliationSelect').value = id;
    document.getElementById('affiliationSearchInput').value = name;
    document.getElementById('affiliationDropdownList').classList.add('hidden'); // ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if (typeof renderTable === 'function') renderTable();
}


// [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏•‡∏á‡πÉ‡∏ô Dropdown ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•
function populateSurnameLineageFilter() {
    const sel = document.getElementById('surnameLineageFilterSelect');
    if (!sel) return;
    const currentVal = sel.value;
    
    sel.innerHTML = '<option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• --</option>';
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•
    const monarchs = state.members
        .filter(m => m.isMonarch)
        .sort((a, b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));

    monarchs.forEach(m => {
        const reignText = m.globalReignNumber ? `‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : '‡∏™‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå';
        sel.add(new Option(`${reignText} (${m.name})`, m.id));
    });

    if (currentVal) sel.value = currentVal;
}

// [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö onchange ‡πÉ‡∏ô HTML)
function filterSurnameOptions() {
    const lineageId = document.getElementById('surnameLineageFilterSelect')?.value || 'all';
    populateSurnameTableSelect(lineageId); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ ID ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏á
}

// [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ lineageFilterId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ö‡∏ö "‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á" (Closest Monarch) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function populateSurnameTableSelect(lineageFilterId = 'all') {
    const sel = document.getElementById('surnameFilterSelect');
    if (!sel) return;
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const currentVal = sel.value; 
    
    sel.innerHTML = '<option value="overview">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• --</option>';

    let founders = getRoyalSurnameFounders();

    // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
    if (lineageFilterId !== 'all') {
        founders = founders.filter(f => {
            let curr = f;
            let guard = 0;
            // ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
            while(curr && guard < 50) {
                if (curr.isMonarch) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    return curr.id === lineageFilterId;
                }
                curr = state.members.find(m => m.id === curr.fatherId);
                guard++;
            }
            return false;
        });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å-‡∏Æ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢
    founders.sort((a, b) => a.royalSurname.localeCompare(b.royalSurname, 'th'));

    founders.forEach(f => {
        const op = new Option(`‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• ${f.royalSurname} (${f.name})`, f.id);
        sel.add(op);
    });

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
    if (currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
        sel.value = currentVal;
    } else {
        sel.value = 'overview';
    }
}



// ============================================================

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö)
function getFounderReignNumber(founder) {
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
    if (!founder.fatherId) return 999;
    const father = state.members.find(m => m.id === founder.fatherId);
    if (father && father.isMonarch && father.globalReignNumber) {
        return parseInt(father.globalReignNumber) || 999;
    }
    return 999;
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)
function populateMonarchFilterSelect() {
    const sel = document.getElementById('monarchFilterSelect');
    const currentVal = sel.value;
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà...) --</option>';
    
    const monarchs = state.members
        .filter(m => m.isMonarch)
        .sort((a, b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));
        
    monarchs.forEach(m => {
        const reignText = m.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : '';
        const op = new Option(`${reignText} ${m.name}`, m.id);
        sel.add(op);
    });
    if (currentVal) sel.value = currentVal;
}
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á 2 ‡πÅ‡∏ö‡∏ö)
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)
function getMotherRankScore(p) {
    if (!p) return 0;
    const pre = p.titlePrefix || "";
    const suf = p.titleSuffix || "";
    const full = pre + suf;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1-15 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ/‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ")) return 1000;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 990;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 980;
    if (pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ") return 970;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 960;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 950;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ")) return 940;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 930;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 920;
    if (pre.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 910;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 900;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤") && suf.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 890;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤") && suf.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 880;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 870;
    if (pre === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") return 860;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 16-20 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤/‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞)
    if (pre === "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 850;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤")) return 840;
    if (pre === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 830;
     if (pre === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤") return 825;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞") return 820;
    if (pre === "‡∏û‡∏£‡∏∞") return 810;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 21-24 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏ß/‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å)
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå")) return 800;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ")) return 790;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå")) return 780;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå")) return 770;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 25-28 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤)
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 760;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 750;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°") return 740;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°") return 730;

    return calculatePojiamScore(p); // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
}


// ============================================================================
// üè∞ PALACE LAW ALGORITHM (ULTIMATE STRICT & CLEAN EDITION)
// ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: 
// 1. ‡∏ï‡∏±‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏´‡πâ‡∏≤‡∏°)
// 2. ‡∏ï‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á/‡∏•‡∏∏‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡πâ‡∏á (‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠/‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠/‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤)
// 3. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
// 4. Safety Sweep ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô
// 5. [NEW] ‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
// ============================================================================

// 1. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤
const MOTHER_RANK_PRIORITY = {
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ": 1,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ": 2,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ": 3,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ": 4,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 5,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 6,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ": 7,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 8,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 9,
    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è ‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 10,
    "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è ‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 11,
    "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 12,
    "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 13,
    "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è ‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ": 14,
    "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠": 15,
    "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": 16,
    "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": 17,
    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": 18
};

// --- HELPER FUNCTIONS ---

function hasRoyalRank(p) {
    if (!p || p.isResigned) return false;
    const rank = p.royalRank || "";
    const validRanks = ["‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤", "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á"];
    const excluded = ["‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå", "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô", "‡∏ô‡∏≤‡∏¢", "‡∏ô‡∏≤‡∏á", "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß"];
    if (excluded.some(k => rank.includes(k))) return false;
    return validRanks.some(k => rank.includes(k));
}

function isKing(p) {
    if (!p) return false;
    const rank = p.royalRank || "";
    const prefix = p.titlePrefix || "";
    const name = p.name || "";
    const suffix = p.titleSuffix || "";
    const fullText = `${rank} ${prefix} ${name} ${suffix}`;

    if (fullText.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à")) return true;
    if (fullText.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞") && fullText.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß")) return true;
    return false;
}

// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
function isStrictChaoFa(p) {
    if (!p) return false;
    const rank = p.royalRank || "";
    const prefix = p.titlePrefix || "";
    const fullText = `${rank} ${prefix}`;

    const mustHave = ["‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£"];
    return mustHave.some(k => fullText.includes(k));
}

function isWangNaOrWangLang(p) {
    if (!p) return false;
    const rank = p.royalRank || "";
    const prefix = p.titlePrefix || "";
    const name = p.name || "";
    const fullText = `${rank} ${prefix} ${name}`; 
    const keywords = [
        "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", 
        "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤", "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç", 
        "‡∏û‡∏£‡∏∞‡∏ö‡∏±‡∏ì‡∏ë‡∏π‡∏£‡∏ô‡πâ‡∏≠‡∏¢", "‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤", "‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á"
    ];
    return keywords.some(k => fullText.includes(k));
}

// [UPDATED] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° ‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠)
function isBlacklistedRank(p) {
    if (!p) return false;
    const rank = p.royalRank || "";
    const prefix = p.titlePrefix || "";
    const fullText = `${rank} ${prefix}`;
    
    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏
    const blacklist = [
        "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
        "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠",
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
    ];
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" -> ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô (return true)
    return blacklist.some(k => fullText.includes(k)) && !fullText.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
}

function isEligibleToDisplay(p) {
    return hasRoyalRank(p) && p.isAlive && p.gender === 'M' && !isKing(p) && !isBlacklistedRank(p);
}

function getBranchLabelName(p) {
    if (isKing(p)) return null;

    let rawPrefix = (p.titlePrefix || "").trim();
    let target = ""; 
    let hasKrom = false; 
    
    // 1. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏° (Krom)
    let krom = "";
    if (p.kromRank || p.kromTitle) {
        krom = `${p.kromRank || ""}${p.kromTitle || ""}`.trim();
    } else if (p.titleSuffix && p.titleSuffix.trim().startsWith("‡∏Å‡∏£‡∏°")) {
        krom = p.titleSuffix.trim();
    }

    if (krom) {
        target = krom; 
        hasKrom = true;
    } else {
        const name = p.name || "";
        const suffix = (p.titleSuffix && !p.titleSuffix.startsWith("‡∏Å‡∏£‡∏°")) ? p.titleSuffix : "";
        target = `${name} ${suffix}`.trim();
    }

    const chaoFaKeyword = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
    
    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤
    if (isStrictChaoFa(p)) {
        let cleanPrefix = rawPrefix.split(chaoFaKeyword)[0].trim(); 
        if (rawPrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤") || rawPrefix.includes("‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£")) {
            return `${rawPrefix} ${target}`.trim();
        }
        return `${cleanPrefix} ${chaoFaKeyword}${target}`;
    } 
    
    // 3. [NEW] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ / ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ / ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠
    const groupPrefixes = ["‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠"];
    const foundPrefix = groupPrefixes.find(pre => rawPrefix.includes(pre));

    if (foundPrefix) {
        // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å prefix ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
        let basePrefix = rawPrefix.replace("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤", "").trim();
        
        if (hasKrom) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏°: "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô..." (‡∏ï‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏≠‡∏Å)
            return `${basePrefix} ${target}`.trim();
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏°: "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥‡∏î‡∏¥‡∏•‡∏Å" (‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠)
            return `${basePrefix} ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤${target}`.trim();
        }
    } 
    
    // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    return `${rawPrefix} ${target}`.trim();
}

function getMotherPriorityScore(person, father) {
    const isRegisteredChild = father && father.registeredSpouseId === person.motherId;
    const mother = state.members.find(m => m.id === person.motherId);
    let rankScore = 99; 
    if (mother) {
        const fullTitle = ((mother.titlePrefix||"") + " " + (mother.titleSuffix||"")).trim();
        for (const [key, score] of Object.entries(MOTHER_RANK_PRIORITY)) {
            if (fullTitle.includes(key)) {
                rankScore = score;
                break;
            }
        }
    }
    return isRegisteredChild ? 1000 + rankScore : 2000 + rankScore;
}

// ============================================================================
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô)
// ============================================================================
function getPalaceSuccessionLine(parentId, labelText) {
    const parent = state.members.find(m => m.id === parentId);
    if (!parent) return [];

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á
    if (isWangNaOrWangLang(parent)) return [];

    let sons = state.members.filter(m => m.fatherId === parentId && m.gender === 'M' && hasRoyalRank(m));

    sons.sort((a, b) => {
        const scoreA = getMotherPriorityScore(a, parent);
        const scoreB = getMotherPriorityScore(b, parent);
        if (scoreA !== scoreB) return scoreA - scoreB;
        return (parseInt(a.birthYear)||9999) - (parseInt(b.birthYear)||9999);
    });

    let line = [];
    sons.forEach(son => {
        // ‡∏Å‡∏é: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡πÄ‡∏Ç‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤
        let currentSonLabel = labelText;
        if (isStrictChaoFa(son)) {
            const sonName = getBranchLabelName(son);
            currentSonLabel = sonName ? ("‡∏™‡∏≤‡∏¢ " + sonName) : labelText;
        }

        if (isEligibleToDisplay(son)) {
            const entry = { ...son };
            
            // --- [‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢] ---
            if (isStrictChaoFa(entry)) {
                // ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢
                delete entry._branchLabel;
            } else if (currentSonLabel) {
                // ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ / ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡πÄ‡∏™‡∏°‡∏≠
                entry._branchLabel = currentSonLabel;
            }
            
            line.push(entry);
        }
        
        // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢ (labelText) ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡∏ô‡πÇ‡∏´‡∏•‡∏ô
        const descendants = getPalaceSuccessionLine(son.id, currentSonLabel);
        line = line.concat(descendants);
    });
    return line;
}

// ----------------------------------------------------------------------------
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏Å (MAIN CALCULATION)
// ----------------------------------------------------------------------------
function calculatePalaceSuccessionList() {
    const king = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
    if (!king) return [];

    let list = [];
    const MAX_LIMIT = 100;

    const addBatch = (candidates, labelText, ancestorId = null) => {
        for (const person of candidates) {
            if (list.length >= MAX_LIMIT) return;
            
            if (!list.find(x => x.id === person.id) && person.id !== king.id && !isBlacklistedRank(person)) {
                const entry = { ...person }; 
                
                // ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß (‡∏à‡∏≤‡∏Å recursive) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å batch
                let finalLabel = entry._branchLabel || labelText;

                if (finalLabel && finalLabel.trim() !== "" && finalLabel !== "‡∏™‡∏≤‡∏¢ null") {
                    entry._branchLabel = finalLabel;
                    if (ancestorId && !entry._branchAncestorId) entry._branchAncestorId = ancestorId;
                }

                // ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î (Clean UI)
                if (isStrictChaoFa(entry)) {
                   delete entry._branchLabel; 
                   delete entry._branchAncestorId;
                }

                list.push(entry);
            }
        }
    };

    // --- 1. ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ---
    const designatedHeir = state.members.find(m => m.isHeir && m.isAlive && parseInt(m.heirOrder) === 1);
    if (designatedHeir) {
        const heirLabel = "‡∏™‡∏≤‡∏¢‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó";
        addBatch([designatedHeir], heirLabel, designatedHeir.id);
        addBatch(getPalaceSuccessionLine(designatedHeir.id, heirLabel), heirLabel, designatedHeir.id);
    }

    // --- 2. ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á (‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ---
    const kingsSons = state.members.filter(m => 
        m.fatherId === king.id && 
        m.gender === 'M' && 
        hasRoyalRank(m) &&
        isStrictChaoFa(m) && 
        !isWangNaOrWangLang(m) &&
        !isBlacklistedRank(m)
    );
    kingsSons.sort((a, b) => {
        const scoreA = getMotherPriorityScore(a, king);
        const scoreB = getMotherPriorityScore(b, king);
        if (scoreA !== scoreB) return scoreA - scoreB;
        return (parseInt(a.birthYear)||9999) - (parseInt(b.birthYear)||9999);
    });

    for (const son of kingsSons) {
        if (list.length >= MAX_LIMIT) break;
        const rawLabel = getBranchLabelName(son); 
        const branchName = rawLabel ? ("‡∏™‡∏≤‡∏¢ " + rawLabel) : ""; 
        
        if (isEligibleToDisplay(son)) addBatch([son], branchName, son.id);
        // ‡∏•‡∏π‡∏Å‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏ô‡∏µ‡πâ (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏°‡πà‡∏¢‡∏®‡∏™‡∏π‡∏á) ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡πâ‡∏≤‡∏¢ branchName
        addBatch(getPalaceSuccessionLine(son.id, branchName), branchName, son.id);
    }

    // --- 3. ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á/‡∏•‡∏∏‡∏á‡∏≠‡∏≤ (‡∏¢‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ) ---
    let currentGenerationChildId = king.id; 
    let currentAncestorId = king.fatherId;  
    let loopCount = 0;

    while (currentAncestorId && list.length < MAX_LIMIT && loopCount < 20) {
        const ancestor = state.members.find(m => m.id === currentAncestorId);
        if (!ancestor) break;

        const maleSiblings = state.members.filter(m => 
            m.fatherId === currentAncestorId &&     
            m.id !== currentGenerationChildId &&    
            m.gender === 'M' &&
            hasRoyalRank(m) &&
            (isStrictChaoFa(m) || isKing(m)) &&
            !isBlacklistedRank(m)
        );
        
        maleSiblings.sort((a, b) => {
            const scoreA = getMotherPriorityScore(a, ancestor);
            const scoreB = getMotherPriorityScore(b, ancestor);
            if (scoreA !== scoreB) return scoreA - scoreB;
            return (parseInt(a.birthYear)||0) - (parseInt(b.birthYear)||0);
        });

        for (const royalRelative of maleSiblings) {
            if (list.length >= MAX_LIMIT) break;

            if (isKing(royalRelative)) {
                const kingChaoFaSons = state.members.filter(son => 
                    son.fatherId === royalRelative.id && 
                    son.gender === 'M' && 
                    hasRoyalRank(son) && 
                    isStrictChaoFa(son) && 
                    !isBlacklistedRank(son) &&
                    !isWangNaOrWangLang(son) 
                );
                kingChaoFaSons.sort((a, b) => (parseInt(a.birthYear)||0) - (parseInt(b.birthYear)||0));

                for (const kSon of kingChaoFaSons) {
                    const rawLabel = getBranchLabelName(kSon); 
                    if (rawLabel) {
                        const sonBranchName = "‡∏™‡∏≤‡∏¢ " + rawLabel;
                        if (isEligibleToDisplay(kSon)) addBatch([kSon], sonBranchName, kSon.id);
                        addBatch(getPalaceSuccessionLine(kSon.id, sonBranchName), sonBranchName, kSon.id);
                    }
                }
            } else {
                const isWangNa = isWangNaOrWangLang(royalRelative);
                const rawLabel = getBranchLabelName(royalRelative);
                
                if (rawLabel) {
                    const branchName = "‡∏™‡∏≤‡∏¢ " + rawLabel;
                    if (isEligibleToDisplay(royalRelative)) {
                        addBatch([royalRelative], branchName, royalRelative.id);
                    }
                    if (!isWangNa) {
                        addBatch(getPalaceSuccessionLine(royalRelative.id, branchName), branchName, royalRelative.id);
                    }
                }
            }
        }
        currentGenerationChildId = currentAncestorId;
        currentAncestorId = ancestor.fatherId;
        loopCount++;
    }

    // --- 4. SAFETY SWEEP (‡∏Å‡∏ß‡∏≤‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤) ---
    if (list.length < MAX_LIMIT) {
        const allMembers = state.members;
        const missedPrinces = allMembers.filter(m => {
            if (list.find(x => x.id === m.id) || m.id === king.id) return false;
            if (m.gender !== 'M' || !hasRoyalRank(m)) return false;
            if (!isStrictChaoFa(m)) return false; 
            if (isBlacklistedRank(m)) return false; 
            
            const father = allMembers.find(f => f.id === m.fatherId);
            if (!father || !isKing(father)) return false; 
            return true;
        });

        missedPrinces.sort((a, b) => (parseInt(a.birthYear)||9999) - (parseInt(b.birthYear)||9999));

        for (const prince of missedPrinces) {
            if (list.length >= MAX_LIMIT) break;
            const rawLabel = getBranchLabelName(prince);
            const branchName = rawLabel ? ("‡∏™‡∏≤‡∏¢ " + rawLabel) : "";
            
            const isWangNa = isWangNaOrWangLang(prince);
            if (isEligibleToDisplay(prince)) {
                addBatch([prince], branchName, prince.id);
            }
            if (!isWangNa) {
                addBatch(getPalaceSuccessionLine(prince.id, branchName), branchName, prince.id);
            }
        }
    }

    // --- 5. Fallback (‡∏´‡∏ç‡∏¥‡∏á) ---
    if (list.length === 0) {
         const daughters = state.members.filter(m => 
            m.fatherId === king.id && m.gender === 'F' && m.isAlive && !m.isResigned &&
            m.motherId === king.registeredSpouseId 
        );
        daughters.sort((a, b) => (parseInt(a.birthYear)||0) - (parseInt(b.birthYear)||0));
        if (daughters.length > 0) {
            const dEntry = { ...daughters[0] };
            dEntry._isFemaleFallback = true;
            dEntry._branchLabel = "‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤)";
            dEntry._branchAncestorId = dEntry.id;
            list.push(dEntry);
        }
    }

    return list;
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const q = document.getElementById('tableSearch').value.toLowerCase();
    const filterStatus = document.getElementById('tableFilterStatus').value;
    const royalHeader = document.getElementById('royalChildrenHeader');
    const subFilter = document.getElementById('royalSubFilter') ? document.getElementById('royalSubFilter').value : 'mother_rank';
    const tableHead = document.querySelector('#tableView table thead tr'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
   
    const activeMonarchData = state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch);
    let list = [...state.members];


// ==========================================
    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Reset Header)
    // ==========================================
   if (tableHead) {
        if (filterStatus === 'kings') {
            tableHead.innerHTML = `
                <th class="text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th> <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                <th class="text-center">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà</th>
                <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô / ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</th>
                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        } 
        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
        else if (filterStatus === 'royal_spouses') {
            tableHead.innerHTML = `
                <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ô‡∏≤‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        } 
        // -----------------------
        else if (filterStatus === 'royal_surnames' && document.getElementById('surnameFilterSelect')?.value === 'overview') {
            // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏∏‡∏ì)
            tableHead.innerHTML = `
                <th class="text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</th>
                <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        } else {
            tableHead.innerHTML = `
                <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        }
    }
// ==========================================
    // 2. ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (Kings)
    // ==========================================
    if (filterStatus === 'kings') {
        // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ---
        if (tableHead) {
            tableHead.innerHTML = `
                <th class="text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                <th class="text-center">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà</th>
                <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô / ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</th>
                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        }

        if (royalHeader) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            royalHeader.innerText = `‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå${state.dynastyName} ‡πÅ‡∏´‡πà‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£${state.kingdomName}`;
            royalHeader.classList.remove('hidden');
        }
        // -----------------------------------------------------

        const reignNameFilter = document.getElementById('kingsReignNameSelect').value;
        let monarchs = state.members.filter(m => m.isMonarch);
        
        if (reignNameFilter !== 'all') monarchs = monarchs.filter(m => m.reignNameBase === reignNameFilter);
        if (q) monarchs = monarchs.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• (‡πë, ‡πí, ‡πì...)
        monarchs.sort((a, b) => (parseInt(a.globalReignNumber) || 999) - (parseInt(b.globalReignNumber) || 999));

        monarchs.forEach((m, i) => {
            const row = document.createElement('tr');
            row.className = "data-row border-b border-slate-100 hover:bg-slate-50 transition";
            const reignLabel = m.globalReignNumber ? toThaiNumerals(m.globalReignNumber) : '-';
            const reignPeriod = (m.reignStart || '-') + ' - ' + (m.reignEnd || (m.isAlive ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : '-'));
            
            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠ ---
            const prefix = m.titlePrefix || "";
            const name = m.name || "";
            const suffix = m.titleSuffix || "";
            
            let reignNameFull = "";
            if (m.reignNameBase) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getReignNameRank ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)
                const rank = (typeof getReignNameRank === 'function') ? getReignNameRank(m) : null;
                
                if (rank) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡πÅ‡∏™‡∏î‡∏á " ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏ó‡∏µ‡πà ‡πë"
                    reignNameFull = " " + m.reignNameBase + "‡∏ó‡∏µ‡πà " + toThaiNumerals(rank);
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß): ‡πÅ‡∏™‡∏î‡∏á " ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" ‡πÄ‡∏â‡∏¢‡πÜ
                    reignNameFull = " " + m.reignNameBase;
                }
            }
            
            const fullNameDisplay = `${prefix}${name}${suffix}${reignNameFull}`;
            // ---------------------

            row.innerHTML = `
                <td class="text-center py-3 font-bold text-slate-400">${toThaiNumerals(i + 1)}</td> 
                <td class="text-center py-3">
                    <img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full mx-auto object-cover border shadow-sm">
                </td>
                <td class="text-center py-3 font-bold text-amber-700">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${reignLabel}</td>
                <td class="py-3 text-sm font-bold text-slate-700" onclick="showDetail('${m.id}')">
                    <div class="text-indigo-600">${fullNameDisplay}</div>
                </td>
                <td class="py-3 text-sm text-slate-600">‡∏û.‡∏®. ${toThaiNumerals(reignPeriod)}</td>
                <td class="text-center py-3">
                    <button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
        return; 
    }


// ==========================================
// 3. ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏é‡∏°‡∏ì‡πÄ‡∏ë‡∏µ‡∏¢‡∏£‡∏ö‡∏≤‡∏• (Palace Law - RENDER ONLY)
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• (‡πÇ‡∏≠‡∏£‡∏™/‡∏ô‡∏±‡∏î‡∏î‡∏≤/‡∏õ‡∏ô‡∏±‡∏î‡∏î‡∏≤)
// ==========================================
if (filterStatus === 'palace_law') {
    
    // 1. ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    if (tableHead) {
        tableHead.innerHTML = `
            <th class="px-6 py-4 text-center w-28 text-slate-500 font-extrabold text-sm uppercase tracking-wider bg-slate-50">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th class="px-6 py-4 text-left text-slate-500 font-extrabold text-sm uppercase tracking-wider bg-slate-50">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</th>
            <th class="px-6 py-4 text-left text-slate-500 font-extrabold text-sm uppercase tracking-wider bg-slate-50">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</th>
            <th class="px-6 py-4 text-left text-slate-500 font-extrabold text-sm uppercase tracking-wider bg-slate-50 w-[35%]">‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
            <th class="px-6 py-4 text-center text-slate-500 font-extrabold text-sm uppercase tracking-wider bg-slate-50">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        `;
    }

    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    const palaceList = calculatePalaceSuccessionList();
    const king = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);

    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö
    if (palaceList.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-slate-400 font-light text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏°‡∏ì‡πÄ‡∏ë‡∏µ‡∏¢‡∏£‡∏ö‡∏≤‡∏•</td></tr>`;
        return;
    }

    // --- Helper ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• + ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ---
const getRoyalRelationship = (person, king) => {
    if (!king) return "-";

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Subject)
    const pFather = state.members.find(m => m.id === person.fatherId);
    const pGrandFather = pFather ? state.members.find(m => m.id === pFather.fatherId) : null;
    const pGreatGrandFather = pGrandFather ? state.members.find(m => m.id === pGrandFather.fatherId) : null;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Reference)
    const kFather = state.members.find(m => m.id === king.fatherId);
    const kGrandFather = kFather ? state.members.find(m => m.id === kFather.fatherId) : null;

    const pYear = parseInt(person.birthYear) || 9999;
    const kYear = parseInt(king.birthYear) || 9999;

    // 1. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ (‡∏•‡∏π‡∏Å‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
    if (person.fatherId === king.id) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™";

    // 2. ‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏≤ / ‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ (‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    if (pFather && kFather && pFather.id === kFather.id) {
        return pYear < kYear ? "‡∏û‡∏£‡∏∞‡πÄ‡∏ä‡∏©‡∏ê‡∏≤ (‡∏û‡∏µ‡πà‡∏ä‡∏≤‡∏¢)" : "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤ (‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏¢)";
    }

 // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏£‡∏ì‡∏µ "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" (‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà) -> ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
const kMother = state.members.find(m => m.id === king.motherId);
if (pFather && kMother) {
    const isFullSiblingMaternal = pFather.fatherId === kMother.fatherId && 
                                 pFather.motherId === kMother.motherId && 
                                 pFather.fatherId && pFather.motherId;
    if (isFullSiblingMaternal) {
        const pFYear = parseInt(pFather.birthYear) || 9999;
        const kMYear = parseInt(kMother.birthYear) || 9999;
        return pFYear < kMYear ? "‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤ (‡∏•‡∏∏‡∏á)" : "‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤ (‡∏ô‡πâ‡∏≤)";
    }
}

// 2. ‡∏ù‡∏±‡πà‡∏á‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤ (‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤ - ‡∏•‡∏∏‡∏á/‡∏≠‡∏≤) -> Priority ‡∏ï‡πà‡∏≠‡∏°‡∏≤ (‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏û‡πà‡∏≠)
if (pFather && kFather && pFather.id !== kFather.id) {
    const shareFather = pFather.fatherId && pFather.fatherId === kFather.fatherId;
    const shareMother = pFather.motherId && pFather.motherId === kFather.motherId;
    
    if (shareFather || shareMother) {
        const pFYear = parseInt(pFather.birthYear) || 9999;
        const kFYear = parseInt(kFather.birthYear) || 9999;
        return pFYear < kFYear ? "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤ (‡∏•‡∏∏‡∏á)" : "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏•‡∏≤ (‡∏≠‡∏≤)";
    }
}

// 3. ‡∏ù‡∏±‡πà‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤ - ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏£‡∏î‡∏≤)
if (pFather && kMother) {
    const shareFather = pFather.fatherId && pFather.fatherId === kMother.fatherId;
    const shareMother = pFather.motherId && pFather.motherId === kMother.motherId;
    
    if (shareFather || shareMother) {
        const pFYear = parseInt(pFather.birthYear) || 9999;
        const kMYear = parseInt(kMother.birthYear) || 9999;
        return pFYear < kMYear ? "‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤ (‡∏•‡∏∏‡∏á)" : "‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏ï‡∏∏‡∏•‡∏≤ (‡∏ô‡πâ‡∏≤)";
    }
}

    // 4. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏´‡∏•‡∏≤‡∏ô‡∏õ‡∏π‡πà - ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏≠‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    if (pGrandFather && pGrandFather.id === king.id) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏´‡∏•‡∏≤‡∏ô‡∏õ‡∏π‡πà)";

    // 5. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ - ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    if (pGrandFather && kFather && pGrandFather.id === kFather.id) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠)";

    // 6. ‡∏û‡∏£‡∏∞‡∏†‡∏≤‡∏î‡∏≤ (‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á - ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏û‡πà‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
    if (pGrandFather && kGrandFather && pGrandFather.id === kGrandFather.id) return "‡∏û‡∏£‡∏∞‡∏†‡∏≤‡∏î‡∏≤ (‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á)";

    // 7. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡πÄ‡∏´‡∏•‡∏ô - ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏ô‡∏õ‡∏π‡πà)
    if (pGrandFather && pGrandFather.fatherId === king.id) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡πÄ‡∏´‡∏•‡∏ô)";

    // --- FALLBACK: ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏≠‡∏£‡∏™/‡∏ô‡∏±‡∏î‡∏î‡∏≤ ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÜ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•) ---
    
    // 1. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ (‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô)
    if (pFather && isKing(pFather)) {
        // ‡πÉ‡∏ä‡πâ globalReignNumber ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const reignNum = pFather.globalReignNumber || pFather.reignNumber || "?";
        return `‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(reignNum)}`;
    }

    // 2. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô)
    if (pGrandFather && isKing(pGrandFather)) {
        const reignNum = pGrandFather.globalReignNumber || pGrandFather.reignNumber || "?";
        return `‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏î‡∏î‡∏≤‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(reignNum)}`;
    }

    // 3. ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏ô‡∏±‡∏î‡∏î‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô)
    if (pGreatGrandFather && isKing(pGreatGrandFather)) {
        const reignNum = pGreatGrandFather.globalReignNumber || pGreatGrandFather.reignNumber || "?";
        return `‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏õ‡∏ô‡∏±‡∏î‡∏î‡∏≤‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(reignNum)}`;
    }

    return "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡∏≤‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
};

    // 4. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    let renderIndex = 0; 

    palaceList.forEach((p) => {
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (Double Filter) ---
        const fullTitleCheck = `${p.royalRank || ""} ${p.titlePrefix || ""}`;
        const hiddenPrefixes = [
            "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠",
            "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", 
            "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" 
        ];
        
        if (hiddenPrefixes.some(k => fullTitleCheck.includes(k)) && !fullTitleCheck.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
            return; 
        }
        
        const wangKeywords = ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤", "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£", "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤", "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç", "‡∏û‡∏£‡∏∞‡∏ö‡∏±‡∏ì‡∏ë‡∏π‡∏£‡∏ô‡πâ‡∏≠‡∏¢", "‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤", "‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á"];
        const fullWangCheck = `${p.royalRank || ""} ${p.titlePrefix || ""} ${p.name || ""}`;
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏û‡πà‡∏≠) -> ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
        const fatherObj = state.members.find(m => m.id === p.fatherId);
        if (fatherObj) {
             const fatherFullText = `${fatherObj.royalRank || ""} ${fatherObj.titlePrefix || ""} ${fatherObj.name || ""}`;
             if (wangKeywords.some(k => fatherFullText.includes(k))) return;
        }
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á) -> ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // ‡πÅ‡∏ï‡πà‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Logic ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß

        // ------------------------------------

        const idx = renderIndex++;

        // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏û‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏°‡πà ---
        const father = state.members.find(m => m.id === p.fatherId);
        const mother = state.members.find(m => m.id === p.motherId);
        
        let fatherName = father ? ((typeof getFullDisplayTitle === 'function') ? getFullDisplayTitle(father) : father.name) : "-";
        let motherName = mother ? ((typeof getFullDisplayTitle === 'function') ? getFullDisplayTitle(mother) : mother.name) : "-";
        
        let fatherHtml = father ? `<span class="text-sm text-slate-700 font-medium hover:text-blue-600 hover:underline cursor-pointer transition-colors leading-snug" onclick="event.stopPropagation(); showDetail('${father.id}')">${fatherName}</span>` : `<span class="text-sm text-slate-400 select-none">-</span>`;
        let motherHtml = mother ? `<span class="text-sm text-slate-700 font-medium hover:text-rose-600 hover:underline cursor-pointer transition-colors leading-snug" onclick="event.stopPropagation(); showDetail('${mother.id}')">${motherName}</span>` : `<span class="text-sm text-slate-400 select-none">-</span>`;
        const isRegistered = father && father.registeredSpouseId === p.motherId;

        // --- ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÉ‡∏´‡∏°‡πà ---
        let relText = getRoyalRelationship(p, king);
        
        if (p._isFemaleFallback) relText = '<span class="text-rose-600 font-bold flex items-center gap-1"><i class="fa-solid fa-star"></i> ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©)</span>';

        // ‡∏à‡∏±‡∏î Format ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
        let fullNameDisplay = "";
        const isMomChao = (p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤' || (p.titlePrefix || "").includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'));

        if (isMomChao) {
            fullNameDisplay = `‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤${p.name.trim()}`;
            const surname = p.royalSurname || (p.titleSuffix && !p.titleSuffix.trim().startsWith("‡∏Å‡∏£‡∏°") ? p.titleSuffix : "");
            if (surname) fullNameDisplay += ` ${surname.trim()}`;
        } else {
            if (typeof getBranchLabelName === 'function') {
                 const labelName = getBranchLabelName(p);
                 fullNameDisplay = labelName ? labelName : p.name;
            } else {
                 fullNameDisplay = `${p.titlePrefix || ""} ${p.name}`;
            }
            if (p.titleSuffix && !p.titleSuffix.trim().startsWith("‡∏Å‡∏£‡∏°") && !fullNameDisplay.includes(p.titleSuffix.trim())) {
                fullNameDisplay += ` ${p.titleSuffix.trim()}`;
            }
        }

        // ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢
        let branchLabelHtml = '';
        if (p._branchLabel) {
            if (p._branchAncestorId) {
                branchLabelHtml = `<div class="w-fit flex items-center gap-1 px-2 py-0.5 rounded-md bg-sky-50 text-sky-700 text-[10px] font-bold border border-sky-100 cursor-pointer hover:bg-sky-100 hover:text-sky-800 transition-colors shadow-sm" onclick="event.stopPropagation(); showDetail('${p._branchAncestorId}')"><i class="fa-solid fa-sitemap text-[9px]"></i> ${p._branchLabel}</div>`;
            } else {
                branchLabelHtml = `<div class="w-fit flex items-center gap-1 px-2 py-0.5 rounded-md bg-sky-50 text-sky-700 text-[10px] font-bold border border-sky-100 cursor-default opacity-80"><i class="fa-solid fa-sitemap text-[9px]"></i> ${p._branchLabel}</div>`;
            }
        }

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let statusBadgeHtml = '<span class="text-slate-300 text-2xl">‚Ä¢</span>'; 
        let specialHeirBadgeName = ''; 
        if (p.isHeir) {
            if (parseInt(p.heirOrder) === 1) {
                statusBadgeHtml = `<span class="inline-flex items-center gap-1 bg-red-100 text-red-700 text-xs font-bold px-3 py-1.5 rounded-full border border-red-200 shadow-sm whitespace-nowrap"><i class="fa-solid fa-dragon"></i> ‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</span>`;
                specialHeirBadgeName = `<div class="w-fit inline-flex items-center gap-1 bg-red-50 text-red-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-red-100 shadow-sm whitespace-nowrap"><i class="fa-solid fa-crown text-[8px]"></i> ‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</div>`;
            } else {
                statusBadgeHtml = `<span class="inline-flex items-center gap-1 bg-purple-100 text-purple-700 text-xs font-bold px-3 py-1.5 rounded-full border border-purple-200 shadow-sm whitespace-nowrap"><i class="fa-solid fa-chess-king"></i> ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
            }
        }

        // Row Styling
        const isFirst = (idx === 0);
        const row = document.createElement('tr');
        let rowClass = isFirst ? "group border-b-4 border-amber-500 bg-gradient-to-r from-[#FFFBE6] via-[#FFFDF5] to-white hover:from-amber-100 transition-all duration-200 cursor-pointer shadow-sm relative z-10" : "group border-b border-slate-100 hover:bg-gradient-to-r hover:from-slate-50 hover:to-white transition-all duration-200 cursor-pointer";
        let nameTextClass = isFirst ? "font-extrabold text-amber-900 text-lg group-hover:text-amber-700 transition-colors drop-shadow-sm" : "font-bold text-slate-800 text-base group-hover:text-amber-700 transition-colors";
        
        let rankBadgeHtml = isFirst ? 
            `<div class="relative w-16 h-16 mx-auto flex items-center justify-center">
                <div class="absolute inset-0 rounded-full bg-amber-400 blur-xl opacity-20 animate-pulse"></div>
                <div class="relative w-14 h-14 rounded-full flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform duration-300" style="background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 50%, #B45309 100%); border: 2px solid #FFF;">
                    <div class="w-[90%] h-[90%] rounded-full flex flex-col items-center justify-center border border-[#FDE047]" style="background: linear-gradient(to bottom, #FFFBEB 0%, #FEF3C7 100%);">
                        <i class="fa-solid fa-crown text-[#D97706] text-[10px] mb-0.5 drop-shadow-sm"></i>
                        <span class="text-[#B45309] font-black text-2xl font-mono leading-none drop-shadow-sm" style="text-shadow: 0px 1px 0px rgba(255,255,255,0.8);">${idx + 1}</span>
                    </div>
                </div>
            </div>` : 
            `<div class="w-10 h-10 mx-auto flex items-center justify-center rounded-full bg-slate-800 text-amber-400 font-bold font-mono text-lg shadow-md border-2 border-amber-500 group-hover:scale-110 transition-transform">${idx + 1}</div>`;

        row.className = rowClass;
        row.onclick = () => showDetail(p.id);

        row.innerHTML = `
            <td class="py-5 text-center align-middle relative">${rankBadgeHtml}${isFirst ? '<div class="absolute top-2 right-4 text-amber-400 text-[8px] animate-ping opacity-75">‚ú¶</div>' : ''}</td>
            <td class="py-5 px-6 align-middle">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <img src="${p.image || DEFAULT_IMG_MALE}" class="w-14 h-14 rounded-full object-cover border-2 border-slate-200 shadow-sm group-hover:border-amber-400 transition-colors ${isFirst ? 'ring-2 ring-amber-300 ring-offset-2' : ''}">
                        ${p.isHeir ? '<div class="absolute -bottom-1 -right-1 bg-purple-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-white"><i class="fa-solid fa-crown"></i></div>' : ''}
                    </div>
                    <div>
                        <div class="${nameTextClass}">${fullNameDisplay}</div>
                        <div class="flex flex-wrap gap-1 items-center mt-1">
                            <div class="text-xs text-indigo-500 font-bold uppercase tracking-wide bg-indigo-50 px-2 py-0.5 rounded-full w-fit border border-indigo-100">${p.royalRank || '-'}</div>
                            ${specialHeirBadgeName}
                            ${branchLabelHtml}
                        </div>
                    </div>
                </div>
            </td>
            <td class="py-5 px-6 align-middle text-sm text-slate-600 font-medium">${relText}</td>
            <td class="py-5 px-6 align-middle">
                <div class="flex flex-col gap-3">
                    <div class="flex items-start gap-2 group/father"><div class="mt-0.5 w-6 h-6 min-w-[24px] rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px] border border-blue-200"><i class="fa-solid fa-mars"></i></div>${fatherHtml}</div>
                    <div class="flex items-start gap-2 group/mother"><div class="mt-0.5 w-6 h-6 min-w-[24px] rounded-full bg-rose-100 text-rose-600 flex items-center justify-center text-[10px] border border-rose-200"><i class="fa-solid fa-venus"></i></div><div class="flex flex-wrap items-center gap-x-2 gap-y-1">${motherHtml}${isRegistered ? '<span class="text-[9px] text-green-700 bg-green-50 px-1.5 py-0.5 rounded border border-green-200 w-fit flex items-center gap-1 font-bold whitespace-nowrap"><i class="fa-solid fa-check-circle"></i> ‡∏†‡∏£‡∏£‡∏¢‡∏≤‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>' : ''}</div></div>
                </div>
            </td>
            <td class="py-5 px-6 align-middle text-center">${statusBadgeHtml}</td>
        `;
        tbody.appendChild(row);
    });
    return;
}


// ==========================================
    // [‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå] ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡πÑ‡∏î‡πâ + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• 1-3)
    // ==========================================
    else if (filterStatus === 'kulachet') {
        // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡πä‡∏Å "‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏¢‡∏∏"
        const isHideAge = document.getElementById('toggleHideAge')?.checked;
        const filterVal = document.getElementById('kulachetFilterSelect')?.value || 'all'; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á

        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏)
        if (tableHead) {
            tableHead.innerHTML = `
                <th class="text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</th>
                <th class="text-center">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                <th class="text-center">‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢</th>
                ${!isHideAge ? '<th class="text-center">‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡πâ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</th>' : ''}
                <th class="text-center w-24">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            `;
        }

        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å state
        if (!state.kulachetHistory) state.kulachetHistory = [];
        let history = [...state.kulachetHistory]; // clone array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö master data

        // --- [Logic: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á] --- (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤)
        const currentKula = state.members.find(m => m.isPhraKulachet && m.status !== 'dead');
        const lastEntry = state.kulachetHistory.length > 0 ? state.kulachetHistory[state.kulachetHistory.length - 1] : null;

        if (currentKula) {
            if (!lastEntry) {
                state.kulachetHistory.push({
                    memberId: currentKula.id,
                    start: state.worldTime.year,
                    end: state.worldTime.year,
                    isCurrent: true,
                    manualReign: "" 
                });
                if (typeof saveState === 'function') saveState();
            }
            else if (lastEntry.memberId !== currentKula.id) {
                lastEntry.isCurrent = false;
                lastEntry.end = state.worldTime.year; 
                state.kulachetHistory.push({
                    memberId: currentKula.id,
                    start: state.worldTime.year,
                    end: state.worldTime.year,
                    isCurrent: true,
                    manualReign: "" 
                });
                if (typeof saveState === 'function') saveState();
            }
            else {
                lastEntry.isCurrent = true;
                lastEntry.end = state.worldTime.year;
            }
        } 
        else if (lastEntry && lastEntry.isCurrent) {
            lastEntry.isCurrent = false;
            lastEntry.end = state.worldTime.year;
            if (typeof saveState === 'function') saveState();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ history ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å update state ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        history = [...state.kulachetHistory];

        // ++++++ [Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á "1-3"] ++++++
        if (filterVal === 'current') {
            history = history.filter(h => h.isCurrent);
        } 
        else if (filterVal.startsWith('reign_')) {
            const targetReign = parseInt(filterVal.split('_')[1]); // ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Time Overlap)
            const monarch = state.members.find(m => m.isMonarch && parseInt(m.globalReignNumber) === targetReign);
            const rStart = monarch ? (parseInt(monarch.reignStartYear || monarch.reignStart) || 0) : 0;
            const rEnd = monarch ? ((monarch.isAlive && !monarch.isExMonarch) ? (state.worldTime.year || 9999) : (parseInt(monarch.reignEndYear || monarch.reignEnd) || 9999)) : 0;

            history = history.filter(h => {
                // A. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢ (Manual ‡∏´‡∏£‡∏∑‡∏≠ Auto)
                const textToCheck = h.manualReign || (typeof getReignPeriod === 'function' ? getReignPeriod(h.start, h.end) : "");
                
                // B. ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parseReignCoverage ‡πÅ‡∏Å‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
                const coveredReigns = typeof parseReignCoverage === 'function' ? parseReignCoverage(textToCheck) : [];

                // C. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (targetReign) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (coveredReigns.includes(targetReign)) return true;

                // D. (‡∏™‡∏≥‡∏£‡∏≠‡∏á) ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Time Overlap
                if (monarch && coveredReigns.length === 0) {
                    const kStart = h.start;
                    const kEnd = h.isCurrent ? state.worldTime.year : h.end;
                    return (kStart <= rEnd) && (kEnd >= rStart);
                }
                return false;
            });
        }
        // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++

        // 3. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Render)
        tbody.innerHTML = '';

        if (history.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${isHideAge ? 6 : 7}" class="text-center py-10 text-slate-400 italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</td></tr>`;
            return;
        }

        history.forEach((h, i) => {
            const m = state.members.find(mem => mem.id === h.memberId);
            if (!m) return; 

            const isPresent = h.isCurrent;
            const row = document.createElement('tr');
            row.className = `data-row border-b border-slate-100 hover:bg-slate-50 transition ${isPresent ? 'bg-orange-50/60' : ''}`;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢)
            const birthY = parseInt(m.birthYear) || 0;
            let ageLabel = "-";
            if (birthY > 0) {
                const targetYear = isPresent ? state.worldTime.year : h.end;
                const ageCalc = targetYear - birthY;
                ageLabel = typeof toThaiNumerals === 'function' ? toThaiNumerals(ageCalc > 0 ? ageCalc : 0) : ageCalc;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢
            const reignText = h.manualReign || (typeof getReignPeriod === 'function' ? getReignPeriod(h.start, h.end) : '-');

            const statusBadge = isPresent
                ? `<span class="bg-amber-100 text-amber-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2 shadow-sm border border-amber-200">
                     <i class="fa-solid fa-circle-check mr-1 text-[8px]"></i>‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                   </span>`
                : `<span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2 border border-slate-200">‡∏≠‡∏î‡∏µ‡∏ï</span>`;

            row.innerHTML = `
                <td class="text-center py-4 font-bold text-slate-400 text-lg">${typeof toThaiNumerals === 'function' ? toThaiNumerals(i + 1) : (i + 1)}</td>
                <td class="text-center py-4">
                    <div class="relative w-12 h-12 mx-auto">
                        <img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" 
                             class="w-full h-full rounded-full object-cover border shadow-sm ${!isPresent ? 'grayscale opacity-80' : 'ring-2 ring-amber-200'}">
                        ${isPresent ? '<div class="absolute -bottom-1 -right-1 text-xs">üëë</div>' : ''}
                    </div>
                </td>
                <td class="py-4 text-sm font-bold text-slate-700 cursor-pointer group" onclick="showDetail('${m.id}')">
                    <div class="text-indigo-600 text-base mb-1 group-hover:text-indigo-800 transition">${typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(m) : m.name}</div>
                    <div class="flex items-center flex-wrap gap-1">
                        <span class="badge-kulachet">‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå</span>
                        ${statusBadge}
                    </div>
                </td>
                <td class="py-4 text-center text-sm text-slate-600 font-mono">
                    <span class="bg-white border border-slate-200 px-3 py-1 rounded-lg shadow-sm whitespace-nowrap">
                        ‡∏û.‡∏®. ${typeof toThaiNumerals === 'function' ? toThaiNumerals(h.start) : h.start} - ${isPresent ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : (typeof toThaiNumerals === 'function' ? toThaiNumerals(h.end) : h.end)}
                    </span>
                </td>
                <td class="py-4 text-center text-sm">
                    <span onclick="editKulachetReign(${i})" class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold ${isPresent ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-600'} border border-transparent shadow-sm cursor-pointer hover:ring-2 hover:ring-amber-300 transition" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢">
                        <i class="fa-solid fa-crown mr-1.5 opacity-70 text-[10px]"></i>
                        ${reignText}
                    </span>
                </td>
                ${!isHideAge ? `
                <td class="py-4 text-center font-bold text-rose-600 text-sm">
                    ${ageLabel} ‡∏õ‡∏µ
                </td>` : ''}
                <td class="text-center py-4">
                    <div class="flex items-center justify-center gap-1">
                        <button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-amber-500 p-2 rounded-full hover:bg-amber-50 transition" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•">
                            <i class="fa-solid fa-user-pen"></i>
                        </button>
                        <button onclick="deleteKulachetEntry(${i})" class="text-slate-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition" title="‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        return;
    }

 
    



//// ==========================================
    // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° (Affiliation)
    // ==========================================
// ... (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô renderTable) ...
else if (filterStatus === 'affiliation') {
    const selectedPatronId = document.getElementById('affiliationSelect').value;
    const patron = state.members.find(m => m.id === selectedPatronId);

    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    if (tableHead) {
         tableHead.innerHTML = `
            <th class="text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
            <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡∏¢‡∏®</th>
            <th>‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        `;
    }

    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Header ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    if (royalHeader) {
        if (patron) {
            const patronName = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(patron) : patron.name;
            royalHeader.innerText = `‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏ß‡∏ô‡∏≤‡∏á ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏ô‡∏±‡∏Å ${patronName}`;
            royalHeader.classList.remove('hidden');
        } else {
            royalHeader.classList.add('hidden');
        }
    }

    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢
    if (!selectedPatronId) {
         tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-slate-400 italic">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π</td></tr>`;
         return;
    }

    // 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    let subordinates = state.members.filter(m => m.affiliationId === selectedPatronId);
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏¢‡∏® -> ‡∏≠‡∏≤‡∏¢‡∏∏
    subordinates.sort((a, b) => (b.pojiamScore || 0) - (a.pojiamScore || 0) || (parseInt(a.birthYear)||9999) - (parseInt(b.birthYear)||9999));

    subordinates.forEach((m, idx) => {
        const row = document.createElement('tr');
        row.className = "data-row border-b border-slate-100 hover:bg-slate-50 transition cursor-pointer";
        row.onclick = () => showDetail(m.id);

        const fullName = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(m) : m.name;
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà
        const father = state.members.find(x => x.id === m.fatherId);
        const mother = state.members.find(x => x.id === m.motherId);
        const fatherName = father ? father.name : "-";
        const motherName = mother ? mother.name : "-";

        // --- Logic ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏® (‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå) ---
        let rankDisplay = "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°"; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        const hasChildren = state.members.some(c => c.motherId === m.id);
        const currentRank = m.royalRank || "";

        if (currentRank.includes("‡∏ó‡πâ‡∏≤‡∏ß") || fullName.startsWith("‡∏ó‡πâ‡∏≤‡∏ß")) {
            rankDisplay = "‡∏ó‡πâ‡∏≤‡∏ß‡∏ô‡∏≤‡∏á";
        } else if (hasChildren) {
            rankDisplay = "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤";
        }
        // -------------------------------------

        row.innerHTML = `
            <td class="text-center py-4 text-slate-400 font-bold">${toThaiNumerals(idx + 1)}</td>
            <td class="text-center py-4">
                <img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full mx-auto object-cover border shadow-sm">
            </td>
            <td class="py-4">
                <div class="text-sm font-bold text-slate-700">${fullName}</div>
            </td>
            <td class="py-4 text-sm text-indigo-600 font-medium">${rankDisplay}</td>
            <td class="py-4 text-sm text-slate-500">
                <div class="flex flex-col text-[11px]">
                    <span>‡∏ö‡∏¥‡∏î‡∏≤: ${fatherName}</span>
                    <span>‡∏°‡∏≤‡∏£‡∏î‡∏≤: ${motherName}</span>
                </div>
            </td>
            <td class="text-center py-4">
                <button onclick="event.stopPropagation(); editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pen-to-square"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
    return;
}









    // ================= ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á (Royal Children) =================
   if (filterStatus === 'royal_children') {
        const selectedMonarchId = document.getElementById('monarchFilterSelect').value;
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏® ---
        const genderFilter = document.getElementById('royalGenderFilter')?.value || 'all';
        // --------------------------------------

        if (!selectedMonarchId) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400 italic">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</td></tr>`;
            if (royalHeader) royalHeader.classList.add('hidden');
            return;
        }
        
        const monarch = state.members.find(m => m.id === selectedMonarchId);
        if (monarch && royalHeader) {
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
            let titleText = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤";
            if (genderFilter === 'M') titleText = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™";
            else if (genderFilter === 'F') titleText = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤";
            
            royalHeader.innerText = `${titleText}‡πÉ‡∏ô ${getFullDisplayTitle(monarch)}`;
            royalHeader.classList.remove('hidden');
            // ----------------------------------------------
        }

        let children = state.members.filter(m => m.fatherId === selectedMonarchId || m.motherId === selectedMonarchId);

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏® ---
        if (genderFilter !== 'all') {
            children = children.filter(m => m.gender === genderFilter);
        }
        // ----------------------------------

        if (subFilter === 'age_all') {
            children.sort((a, b) => (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999) || a.id.localeCompare(b.id));
            if (q) children = children.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));

            children.forEach((m, idx) => {
                const otherParentId = (m.fatherId === selectedMonarchId) ? m.motherId : m.fatherId;
                const mother = state.members.find(p => p.id === otherParentId);
                renderRoyalRow(tbody, m, idx + 1, mother, true);
            });
        } else {
            children.sort((a, b) => {
                const mIdA = (a.fatherId === selectedMonarchId) ? a.motherId : a.fatherId;
                const mIdB = (b.fatherId === selectedMonarchId) ? b.motherId : b.fatherId;
                const motherA = state.members.find(p => p.id === mIdA);
                const motherB = state.members.find(p => p.id === mIdB);
                const scoreA = getMotherRankScore(motherA);
                const scoreB = getMotherRankScore(motherB);
                if (scoreB !== scoreA) return scoreB - scoreA;
                if (mIdA !== mIdB) return mIdA.localeCompare(mIdB);
                return (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999);
            });

            if (q) children = children.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));
            let currentMotherId = null;
            let localIdx = 0;

            children.forEach((m) => {
                const motherId = (m.fatherId === selectedMonarchId) ? m.motherId : m.fatherId;
                const mother = state.members.find(p => p.id === motherId);
                if (motherId !== currentMotherId) {
                    currentMotherId = motherId;
                    localIdx = 1; 
                    const hRow = document.createElement('tr');
                    hRow.className = "mother-group-header";
                    hRow.innerHTML = `<td colspan="5"><i class="fa-solid fa-crown mr-2 text-amber-500"></i> ‡πÉ‡∏ô ${mother ? getFullDisplayTitle(mother) : '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ô‡∏≤‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤'}</td>`;
                    tbody.appendChild(hRow);
                } else {
                    localIdx++;
                }
                renderRoyalRow(tbody, m, localIdx, mother, false);
            });
        }
        return; 
    }



// ================= ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (Royal Spouses) =================

// ================= ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (Royal Spouses) =================

if (filterStatus === 'royal_spouses') {
    const kingId = document.getElementById('spouseKingSelect')?.value || 'all';
    const typeFilter = document.getElementById('spouseTypeSelect')?.value || 'all';
    let spouses = [];


// --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Royal Header) ---
        if (royalHeader) {
            if (kingId !== 'all') {
                const king = state.members.find(k => k.id === kingId);
                if (king) {
                    const kingName = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(king) : king.name;
                    royalHeader.innerText = `‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÉ‡∏ô ${kingName}`;
                    royalHeader.classList.remove('hidden');
                }
            } else {
                royalHeader.innerText = `‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå`;
                royalHeader.classList.remove('hidden');
            }
        }
        // -----------------------------------------------------------




    // --- 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ---
    if (kingId === 'all') {
        const allSpouseIds = new Set();
        state.members.filter(m => m.isMonarch).forEach(k => {
            if(k.spouseIds) k.spouseIds.forEach(id => allSpouseIds.add(id));
        });
        spouses = state.members.filter(m => allSpouseIds.has(m.id));
    } else {
        const king = state.members.find(k => k.id === kingId);
        if (king && king.spouseIds) spouses = state.members.filter(m => king.spouseIds.includes(m.id));
    }
    if (q) spouses = spouses.filter(s => getFullDisplayTitle(s).toLowerCase().includes(q.toLowerCase()));

    // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Thead) ---
    if (tableHead) {
        tableHead.className = "bg-slate-100 border-b-2 border-slate-200";
        tableHead.innerHTML = `
            <th class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest w-28">‡∏£‡∏π‡∏õ</th>
            <th class="py-5 text-left text-xs font-black text-slate-500 uppercase tracking-widest">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
            <th class="py-5 text-left text-xs font-black text-slate-500 uppercase tracking-widest">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="py-5 text-left text-xs font-black text-slate-500 uppercase tracking-widest">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
            <th class="py-5 text-center text-xs font-black text-slate-500 uppercase tracking-widest w-24">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        `;
    }

    // --- 3. ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏® ---
    const displayCategories = [
        { name: "‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "pink" },
        { name: "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "amber" },
        { name: "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "purple" },
        { name: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "high_consort", color: "stone" },
        { name: "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "blue" },
        { name: "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "emerald" },
        { name: "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", unit: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", fGroup: "royal_consort", color: "teal" },
        { name: "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å", unit: "‡∏Ñ‡∏ô", fGroup: "concubine", color: "orange" },
        { name: "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°", unit: "‡∏Ñ‡∏ô", fGroup: "concubine", color: "sky" },
        { name: "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", unit: "‡∏Ñ‡∏ô", fGroup: "concubine", color: "slate" }
    ];

    // --- 4. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ---
    displayCategories.forEach(cat => {
        let membersInCat = spouses.filter(s => {
            const rel = (s.relationship || "").trim();
            const prefix = (s.titlePrefix || "").trim();
            const marriedKings = state.members.filter(m => m.isMonarch && m.spouseIds && m.spouseIds.includes(s.id));
            const isMarriedToFemale = marriedKings.some(k => k.gender === 'F');
            const isTao = s.isTao === true; 

            let targetCategory = "";

            const ekList = ["‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ"]; 
            const sanomList = ["‡∏ó‡πâ‡∏≤‡∏ß", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°", "‡∏´‡∏°‡πà‡∏≠‡∏°", "‡∏ô‡∏≤‡∏á", "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß"];

            // ==================================================================================
            // 4.1 [Priority 1] ‡πÄ‡∏ä‡πá‡∏Ñ "‡∏õ‡πâ‡∏≤‡∏¢‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå" (isQueenConsort) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
            // ‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ/‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå
            // ‡∏ï‡∏Å‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°" (‡∏Ç‡πâ‡∏≠ 4.2) ‡πÅ‡∏ó‡∏ô ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            // ==================================================================================
            if (
                s.isQueenConsort === true || // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å Queen ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                rel === "‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå" ||
                rel === "‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ" ||
                rel === "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ" // (‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
            ) {
                targetCategory = "‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ";
            }
            // ==================================================================================
            // 4.2 [Priority 2] ‡πÄ‡∏ä‡πá‡∏Ñ "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°" (Original Royal Rank)
            // ‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡πä‡∏Å Queen ‡∏à‡∏∞‡∏ï‡∏Å‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô
            // ==================================================================================
            else if (s.originalRoyalRank) {
                targetCategory = s.originalRoyalRank;
            }
            // 4.3 ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
            else if (isTao || prefix.startsWith("‡∏ó‡πâ‡∏≤‡∏ß") || ekList.includes(prefix) || sanomList.includes(prefix)) {
                if (ekList.includes(prefix)) targetCategory = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å";
                else if (isTao || prefix.startsWith("‡∏ó‡πâ‡∏≤‡∏ß") || sanomList.includes(prefix)) targetCategory = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°";
                else targetCategory = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
            }
            // 4.4 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)
            else if (rel === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") targetCategory = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
            else if (isMarriedToFemale && (rel === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ" || rel === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤" || rel === "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ" || rel === "‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤")) {
                targetCategory = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
            }
            else if (rel === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤" || rel === "‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤" || rel === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" || ["‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ","‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ","‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"].includes(rel)) {
                targetCategory = getConsortCategoryLabel(s) || "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤";
            }
            else { 
                targetCategory = rel; 
            }

            return targetCategory === cat.name;
        });

        if (typeFilter !== 'all' && typeFilter !== cat.fGroup) return;

        if (membersInCat.length > 0) {
            
            // Logic ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
            membersInCat.sort((a, b) => {
                const getRankScore = (p) => {
                    const prefix = (p.titlePrefix || "").trim();
                    const isTao = p.isTao === true;
                    
                    if (isTao || prefix.startsWith("‡∏ó‡πâ‡∏≤‡∏ß")) return 100;
                    if (prefix === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 90;
                    if (prefix === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 80;
                    if (prefix === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°") return 70;
                    if (prefix === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°") return 60;
                    return 0; 
                };
                return getRankScore(b) - getRankScore(a);
            });

            // Header Row
            const headerRow = document.createElement('tr');
            const c = cat.color;
            headerRow.className = `bg-gradient-to-r from-${c}-50 via-${c}-50/30 to-transparent border-y border-${c}-100`;
            headerRow.innerHTML = `
                <td colspan="5" class="py-5 px-8">
                    <div class="flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full bg-${c}-400 shadow-md"></div>
                        <span class="text-base font-bold text-${c}-900 tracking-wide">${cat.name}</span>
                        <div class="flex items-baseline gap-1 bg-white border border-${c}-200 px-4 py-1 rounded-full shadow-sm ml-2">
                            <span class="text-base font-black text-${c}-700">${toThaiNumerals(membersInCat.length)}</span>
                            <span class="text-[11px] font-bold text-${c}-400 uppercase tracking-tighter">${cat.unit}</span>
                        </div>
                        <div class="flex-grow h-[2px] bg-gradient-to-r from-${c}-200 to-transparent ml-4"></div>
                    </div>
                </td>
            `;
            tbody.appendChild(headerRow);

            // Data Rows
            membersInCat.forEach(s => {
                const marriedKings = state.members.filter(m => m.isMonarch && m.spouseIds && m.spouseIds.includes(s.id));
                const marriedTo = marriedKings.map(k => getFullDisplayTitle(k)).join(', ');
                
                const fullTitle = getFullDisplayTitle(s);
                const cleanName = fullTitle.replace(/\s+‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà.*?(?=\)|$)/, '').trim();

                const royalCategories = ["‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ", "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ", "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"];
                const concubineCategories = ["‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å", "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤"];
                
                let displayRel = ""; 

                if (royalCategories.includes(cat.name)) {
                    displayRel = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
                } else if (concubineCategories.includes(cat.name)) {
                    displayRel = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
                } else if (cat.name === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ") {
                    displayRel = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
                } else if (cat.name === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") {
                    displayRel = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
                } else {
                    displayRel = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤"; 
                }

                const row = document.createElement('tr');
                row.className = `data-row border-b border-slate-100 hover:bg-${c}-50/40 transition-all duration-300 group`;
                row.innerHTML = `
                    <td class="text-center py-6">
                        <img src="${s.image || (s.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" 
                             class="w-16 h-16 rounded-full mx-auto object-cover border-4 border-white shadow-md group-hover:scale-110 transition-transform duration-500">
                    </td>
                    <td class="py-6 cursor-pointer" onclick="showDetail('${s.id}')">
                        <div class="text-base font-bold text-slate-800 group-hover:text-${c}-700 transition-colors">${cleanName}</div>
                        <div class="text-xs text-slate-400 mt-1.5 flex items-center gap-2 opacity-80 italic">
                             <i class="fa-solid fa-link text-${c}-300"></i>‡πÉ‡∏ô${marriedTo || '-'}
                        </div>
                    </td>
                    <td class="py-6">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-black tracking-tight ${s.isAlive ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-slate-100 text-slate-400 border border-slate-200'}">
                            <span class="w-1.5 h-1.5 rounded-full ${s.isAlive ? 'bg-emerald-400' : 'bg-slate-300'} mr-2"></span>
                            ${s.isAlive ? '‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï' : getDeathTerm(s)}
                        </span>
                    </td>
                    <td class="py-6">
                        <span class="text-xs font-bold text-${c}-600 bg-white px-4 py-1.5 rounded-xl border border-${c}-100 shadow-sm group-hover:border-${c}-300 transition-all whitespace-nowrap">
                            ${displayRel || '-'}
                        </span>
                    </td>
                    <td class="text-center py-6">
                        <button onclick="editPersonDirect('${s.id}')" class="w-10 h-10 rounded-full text-slate-300 hover:bg-${c}-100 hover:text-${c}-600 transition-all flex items-center justify-center mx-auto shadow-sm">
                            <i class="fa-solid fa-pen-to-square text-sm"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    });
    return;
}


// ================= ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (Royal Surnames) =================
// ================= ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (Royal Surnames - Sort by Reign) =================
if (filterStatus === 'royal_surnames') {
    const selectedMode = document.getElementById('surnameFilterSelect')?.value || 'overview';
    const lineageFilter = document.getElementById('surnameLineageFilterSelect')?.value || 'all';


    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Royal Header) ---
        if (royalHeader) {
            if (selectedMode === 'overview') {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                royalHeader.innerText = `‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå${state.dynastyName}`;
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á -> ‡πÅ‡∏™‡∏î‡∏á "‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•{‡∏ä‡∏∑‡πà‡∏≠}"
                const founder = state.members.find(m => m.id === selectedMode);
                const surnameText = founder ? founder.royalSurname : "";
                royalHeader.innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•${surnameText}`;
            }
            royalHeader.classList.remove('hidden');
        }
        // --------------------------------------------------------
    
    // ‡∏õ‡∏£‡∏±‡∏ö Header ‡∏´‡∏•‡∏±‡∏Å
    const tableHeadSelect = document.querySelector('#tableView table thead');
    if(tableHeadSelect) tableHeadSelect.className = "bg-white/95 backdrop-blur-md sticky top-0 z-20 shadow-sm border-b border-indigo-100";
    const tableHead = tableHeadSelect.querySelector('tr');

    // --- 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏î‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏ô‡∏∂‡πà‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (Tree View) ---
    if (selectedMode !== 'overview') {
        tableHead.innerHTML = `
            <th class="px-6 py-5 text-xs font-bold text-slate-600 uppercase tracking-widest w-24 text-center first:rounded-tl-lg">‡∏£‡∏π‡∏õ</th>
            <th class="px-6 py-5 text-xs font-bold text-slate-600 uppercase tracking-widest">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
            <th class="px-6 py-5 text-xs font-bold text-slate-600 uppercase tracking-widest w-32">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-6 py-5 text-xs font-bold text-slate-600 uppercase tracking-widest">‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
            <th class="px-6 py-5 text-xs font-bold text-slate-600 uppercase tracking-widest text-center w-24 last:rounded-tr-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        `;

        let surnameMembers = getRoyalSurnameMembers(selectedMode);
        const founder = state.members.find(m => m.id === selectedMode);
        const surnameText = founder?.royalSurname || "-";

        let generations = {};
        let queue = [{ id: selectedMode, gen: 1 }];
        let visited = new Set([selectedMode]);
        if (founder) generations[1] = [founder];

        const childMap = {};
        surnameMembers.forEach(m => {
            if (m.fatherId) {
                if (!childMap[m.fatherId]) childMap[m.fatherId] = [];
                childMap[m.fatherId].push(m);
            }
            if (m.motherId) {
                 if (!childMap[m.motherId]) childMap[m.motherId] = [];
                 if (!childMap[m.motherId].find(x => x.id === m.id)) {
                     childMap[m.motherId].push(m);
                 }
            }
        });

        // =========================================================================
        // [FIXED] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡∏® (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ titlePrefix/royalRank ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        // =========================================================================
        const getRankScore = (person) => {
            if (!person) return 0;
            
            // ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ + ‡∏¢‡∏® + ‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            const fullString = (
                (person.titlePrefix || "") + " " + 
                (person.royalRank || "") + " " + 
                (person.name || "") + " " +
                (person.titleSuffix || "")
            ).trim();

            // 1. ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠)
            if (person.isMonarch) return 1000000;
            if (person.isQueen) return 900000;

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡πÄ‡∏≠‡∏Å/‡πÇ‡∏ó) ---
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 200000;
            
            // ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠/‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 195000;
            // ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠/‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 190000;
            
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 185000;

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ï‡∏£‡∏µ) ---
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 180000;
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 175000;
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 170000;
            if (fullString.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 165000;
            if (fullString.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) return 160000; // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÄ‡∏≠‡∏Å) ---
            if (fullString.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 150000;
            if (fullString.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 145000;

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÇ‡∏ó) ---
            if (fullString.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 140000;
            if (fullString.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 135000;

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÇ‡∏ó/‡∏ï‡∏£‡∏µ) ---
            if (fullString.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 130000;
            if (fullString.includes("‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 125000;
            if (fullString.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 120000;

            // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ï‡∏£‡∏µ) ---
            if (fullString.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 115000;
            if (fullString.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) return 110000; // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

            // --- ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ---
            if (fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤")) return 100000;

            // --- ‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤ / ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏) ---
            if (fullString.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") || fullString.includes("‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤")) return 90000;
            if (fullString.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°")) return 85000;

            // --- ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå / ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á (‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ) ---
            if (fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå")) return 80000;
            if (fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á")) return 70000;

            // --- ‡∏´‡∏°‡πà‡∏≠‡∏° (‡∏†‡∏£‡∏£‡∏¢‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô) ---
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏°‡πà‡∏≠‡∏°" ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤/‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå/‡∏´‡∏•‡∏ß‡∏á"
            if (fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°") && 
                !fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") && 
                !fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå") && 
                !fullString.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á")) {
                return 10000;
            }

            return 0;
        };

        let maxGen = 1;
        let headIndex = 0;
        
        while(headIndex < queue.length){
            let curr = queue[headIndex++];
            let children = childMap[curr.id] || [];

            children.sort((a, b) => {
                const rankA = getRankScore(a);
                const rankB = getRankScore(b);
                if (rankA !== rankB) return rankB - rankA;
                const yearA = parseInt(a.birthYear) || 9999;
                const yearB = parseInt(b.birthYear) || 9999;
                return yearA - yearB;
            });

            children.forEach(child => {
                if (!visited.has(child.id)) {
                    visited.add(child.id);
                    let nextGen = curr.gen + 1;
                    queue.push({ id: child.id, gen: nextGen });
                    if (!generations[nextGen]) generations[nextGen] = [];
                    
                    if (!q || getFullDisplayTitle(child).toLowerCase().includes(q)) {
                         generations[nextGen].push(child);
                    }
                    if(nextGen > maxGen) maxGen = nextGen;
                }
            });
        }
        
        if (q && founder && !getFullDisplayTitle(founder).toLowerCase().includes(q)) {
             generations[1] = []; 
        }

        for (let g = 1; g <= maxGen; g++) {
            const genMembers = generations[g];
            if (!genMembers || genMembers.length === 0) continue;

            let desc = "";
            if (g === 1) desc = "‡∏ú‡∏π‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•";
            else if (g === 2) desc = "‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å";
            else if (g === 3) desc = "‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏ô";
            else if (g === 4) desc = "‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏ô";
            else if (g === 5) desc = "‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏∑‡πà‡∏≠";
            else if (g >= 6) desc = "‡∏ú‡∏π‡πâ‡∏™‡∏∑‡∏ö‡∏™‡∏Å‡∏∏‡∏•";

            const headerRow = document.createElement('tr');
            headerRow.className = "bg-slate-50 border-b border-indigo-100";
            headerRow.innerHTML = `
                <td colspan="6" class="py-3 px-6">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white text-sm font-bold shadow-md shadow-indigo-200">
                            ${toThaiNumerals(g)}
                        </span>
                        <div class="flex flex-col">
                            <span class="text-indigo-900 font-bold text-base">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•${surnameText} ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${toThaiNumerals(g)}</span>
                            <span class="text-xs text-indigo-500 font-medium">${desc}</span>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(headerRow);

            genMembers.forEach((m, idx) => {
                const dTerm = m.isAlive ? "" : getDeathTerm(m);
                let spouseList = [];
                const isExceptionalFemale = (m.gender === 'F') && (m.isMonarch || (m.isHeir && parseInt(m.heirOrder) === 1));

                let spouseSet = new Set();
                if (m.spouseId) spouseSet.add(m.spouseId);
                if (Array.isArray(m.spouseIds)) m.spouseIds.forEach(id => spouseSet.add(id));
                
                const spousesInSystem = state.members.filter(x => 
                    (x.spouseId === m.id || x.husbandId === m.id || x.registeredSpouseId === m.id ||
                    (Array.isArray(x.spouseIds) && x.spouseIds.includes(m.id)))
                );
                spousesInSystem.forEach(w => spouseSet.add(w.id));
                
                state.members.filter(c => (m.gender === 'M' ? c.fatherId === m.id : c.motherId === m.id)).forEach(child => {
                    const partnerId = (m.gender === 'M' ? child.motherId : child.fatherId);
                    if (partnerId) spouseSet.add(partnerId);
                });

                spouseList = Array.from(spouseSet)
                    .filter(id => id !== m.id)
                    .map(id => state.members.find(x => x.id === id))
                    .filter(x => x); 

                if (m.isMonarch && m.gender === 'M') {
                    if (m.registeredSpouseId) {
                        spouseList = spouseList.filter(s => s.id === m.registeredSpouseId);
                    } else {
                        spouseList = [];
                    }
                }
                else if (m.gender === 'F' && !isExceptionalFemale) {
                     spouseList = [];
                }

                // =========================================================================
                // [SORT] ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô -> ‡∏¢‡∏® -> ‡∏≠‡∏≤‡∏¢‡∏∏)
                // =========================================================================
                spouseList.sort((a, b) => {
                    const isRegA = (m.registeredSpouseId === a.id);
                    const isRegB = (m.registeredSpouseId === b.id);
                    // 1. ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                    if (isRegA && !isRegB) return -1; 
                    if (!isRegA && isRegB) return 1; 
                    
                    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏® (Score)
                    const rankA = getRankScore(a);
                    const rankB = getRankScore(b);
                    if (rankA !== rankB) return rankB - rankA; 
                    
                    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏
                    return (parseInt(a.birthYear)||0) - (parseInt(b.birthYear)||0);
                });

                const hasSpouse = spouseList.length > 0;

                const row = document.createElement('tr');
                row.className = `group bg-white hover:bg-slate-50 border-l-[4px] border-l-indigo-500 transition-all duration-200 ${hasSpouse ? '' : 'border-b border-slate-200'}`;
                row.innerHTML = `
                    <td class="py-4 px-6 align-top">
                        <div class="relative w-12 h-12 mx-auto">
                            <img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" 
                                 class="w-12 h-12 rounded-full object-cover border-[3px] border-white shadow-md group-hover:scale-105 transition-transform duration-300">
                             ${m.isMonarch ? '<div class="absolute -top-2 -right-2 text-yellow-500 text-sm"><i class="fa-solid fa-crown"></i></div>' : ''}
                        </div>
                    </td>
                    <td class="py-4 px-6 align-top">
                         <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2 cursor-pointer" onclick="showDetail('${m.id}')">
                                <span class="font-bold text-black text-base group-hover:text-indigo-700 transition-colors">
                                    ${getFullDisplayTitle(m)}
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-0.5 rounded border border-indigo-100 font-medium">
                                    ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${toThaiNumerals(idx + 1)}
                                </span>
                            </div>
                         </div>
                    </td>
                    <td class="py-4 px-6 align-top">
                        ${m.isAlive 
                            ? '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>' 
                            : `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500">${dTerm}</span>`}
                    </td>
                    <td class="py-4 px-6 align-top">
                        <div class="flex flex-col gap-1.5 text-xs text-slate-500">
                            ${m.fatherId ? `<div class="flex items-center gap-2"><i class="fa-solid fa-mars text-indigo-300 w-4"></i> <span>${state.members.find(x=>x.id===m.fatherId)?.name || '-'}</span></div>` : ''}
                            ${m.motherId ? `<div class="flex items-center gap-2"><i class="fa-solid fa-venus text-rose-300 w-4"></i> <span>${state.members.find(x=>x.id===m.motherId)?.name || '-'}</span></div>` : ''}
                        </div>
                    </td>
                    <td class="py-4 px-6 align-top text-center">
                        <button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 w-8 h-8 rounded-full transition-all">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                if (hasSpouse) {
                    spouseList.forEach((sp, spIdx) => {
                        const spRow = document.createElement('tr');
                        const isLastSpouse = spIdx === spouseList.length - 1;
                        const isRegistered = (m.registeredSpouseId === sp.id);

                        spRow.className = `bg-pink-50/60 hover:bg-pink-100/80 border-l-[4px] border-l-rose-300 transition-colors ${isLastSpouse ? 'border-b border-slate-200' : ''}`;
                        const spStatus = sp.isAlive 
                            ? '<span class="text-emerald-600 text-[11px] font-medium"><i class="fa-solid fa-check-circle text-[10px] mr-1"></i>‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>'
                            : `<span class="text-slate-400 text-[11px]">${getDeathTerm(sp)}</span>`;

                        spRow.innerHTML = `
                            <td class="py-2 px-6 text-right align-middle relative">
                                <div class="absolute right-6 top-0 h-1/2 w-4 border-r border-rose-200"></div>
                                <div class="absolute right-6 bottom-0 h-1/2 w-4 border-r border-rose-200 ${isLastSpouse ? 'hidden' : ''}"></div>
                                <div class="absolute right-0 top-1/2 w-6 h-[1px] bg-rose-200"></div>
                            </td>
                            <td class="py-2 px-6 align-middle pl-0">
                                <div class="flex items-center gap-3 p-2 ml-4">
                                    <div class="relative shrink-0">
                                         <i class="fa-solid fa-heart text-[10px] absolute -left-3 top-3 ${isRegistered ? 'text-red-500' : 'text-rose-300'}"></i>
                                         <img src="${sp.image || (sp.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-8 h-8 rounded-full object-cover border border-rose-200 shadow-sm">
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-pink-700 hover:text-pink-900 cursor-pointer transition-colors" onclick="showDetail('${sp.id}')">
                                            ${getFullDisplayTitle(sp)}
                                        </span>
                                        <div class="flex items-center gap-1">
                                            <span class="text-[10px] text-rose-500 font-medium">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</span>
                                            ${isRegistered ? '<span class="bg-rose-100 text-rose-600 text-[9px] px-1 rounded border border-rose-200 ml-1">‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-2 px-6 align-middle">${spStatus}</td>
                            <td class="py-2 px-6 align-middle text-center text-slate-300 text-xs">-</td>
                            <td class="py-2 px-6 align-middle"></td>
                        `;
                        tbody.appendChild(spRow);
                    });
                }
            });
        }
        return;
    } 

    // --- 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (Overview) ---
    tableHead.innerHTML = `
        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-center w-20">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</th>
        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</th>
        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏™‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</th>
        <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-center">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
    `;
    
    let founders = getRoyalSurnameFounders();

    // =========================================================================
    // [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] Logic ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/Queen Regnant)
    // =========================================================================
    const findMonarchAncestor = (person) => {
        let curr = person;
        let guard = 0;
        while (curr && guard < 50) {
            if (curr.isMonarch) return curr;
            
            const father = state.members.find(m => m.id === curr.fatherId);
            const mother = state.members.find(m => m.id === curr.motherId);

            if (father && father.isMonarch) return father;
            if (mother && mother.isMonarch) return mother;

            if (father) {
                curr = father;
            } else if (mother) {
                curr = mother;
            } else {
                return null; // ‡∏ï‡∏±‡∏ô
            }
            guard++;
        }
        return null;
    };

    if (lineageFilter !== 'all') {
        founders = founders.filter(f => {
            const monarch = findMonarchAncestor(f);
            return monarch && monarch.id === lineageFilter;
        });
    }

    const getReignNumber = (person) => {
        const monarch = findMonarchAncestor(person);
        return (monarch && monarch.globalReignNumber) ? parseInt(monarch.globalReignNumber) : 999;
    };

    founders.sort((a, b) => {
        const reignA = getReignNumber(a);
        const reignB = getReignNumber(b);
        if (reignA !== reignB) return reignA - reignB;
        return a.royalSurname.localeCompare(b.royalSurname, 'th');
    });

    if (founders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ô‡∏µ‡πâ</td></tr>`;
        return;
    }

    founders.forEach((f, idx) => {
        const count = getRoyalSurnameMembers(f.id).length;
        
        let monarchLine = "-";
        const monarch = findMonarchAncestor(f);
        if (monarch && monarch.globalReignNumber) {
            monarchLine = `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(monarch.globalReignNumber)}`;
        }
        
        const row = document.createElement('tr');
        row.className = "group border-b border-slate-100 hover:bg-indigo-50/40 cursor-pointer transition-all duration-200";
        row.onclick = () => {
            const select = document.getElementById('surnameFilterSelect');
            if(select) {
                select.value = f.id;
                if (typeof renderTable === 'function') renderTable();
            }
        };

        row.innerHTML = `
            <td class="py-5 px-6 text-center text-slate-400 font-medium group-hover:text-indigo-500">${toThaiNumerals(idx + 1)}</td>
            <td class="py-5 px-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg shadow-sm">
                        <i class="fa-solid fa-feather-pointed"></i>
                    </div>
                    <div>
                        <div class="font-bold text-lg text-indigo-900 group-hover:text-indigo-600 transition-colors">${f.royalSurname}</div>
                        <div class="text-xs text-slate-400 font-light">Royal Surname</div>
                    </div>
                </div>
            </td>
            <td class="py-5 px-6">
                <div class="flex items-center gap-3">
                    <img src="${f.image || DEFAULT_IMG_MALE}" class="w-8 h-8 rounded-full border border-slate-200 object-cover">
                    <span class="text-sm font-medium text-slate-700">${getFullDisplayTitle(f)}</span>
                </div>
            </td>
            <td class="py-5 px-6">
                ${monarchLine !== '-' 
                    ? `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-yellow-50 text-yellow-700 text-xs font-bold border border-yellow-100"><i class="fa-solid fa-crown text-[10px]"></i> ${monarchLine}</span>` 
                    : '<span class="text-slate-400 text-sm">-</span>'}
            </td>
            <td class="py-5 px-6 text-center">
                <span class="bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all">
                    ${toThaiNumerals(count)} ‡∏ó‡πà‡∏≤‡∏ô
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
    return;
}

  // ================= ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°) =================
    if (filterStatus === 'alive') list = list.filter(m => m.isAlive);
    else if (filterStatus === 'dead') list = list.filter(m => !m.isAlive);
    else if (filterStatus === 'precedence') list = list.filter(m => m.isAlive && calculatePojiamScore(m) > 0);
    
    if (q) list = list.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));

    // Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    list.sort((a,b) => {
        if (filterStatus === 'precedence') {
            const scoreA = a.customPrecedence !== undefined ? a.customPrecedence : calculatePojiamScore(a);
            const scoreB = b.customPrecedence !== undefined ? b.customPrecedence : calculatePojiamScore(b);
            return scoreB - scoreA;
        }
        return ((parseInt(a.birthYear)||Infinity) - (parseInt(b.birthYear)||Infinity));
    });

    list.forEach((m, index) => {
        // 1. STATUS BADGE: ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        const dTerm = m.isAlive ? "" : getDeathTerm(m);
        const statusHTML = m.isAlive 
            ? '<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-600 text-xs font-bold">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>'
            : `<span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-500 text-xs font-bold">${dTerm}</span>`;
    
        // 2. NAME & TAGS Logic: ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Class ‡πÄ‡∏î‡∏¥‡∏° (monarch-tag-table ‡∏Ø‡∏•‡∏Ø)
        let fullName = `<span class="text-sm font-semibold text-slate-800 tracking-wide group-hover:text-indigo-700 transition-colors">${getFullDisplayTitle(m)}</span>`;
        let postNameTag = '';
        const reignLabel = m.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : ''; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÄ‡∏ï‡πá‡∏° "‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà" ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    
        const activeMonarchData = getCurrentMonarch(); 
        const isKing = m.isMonarch && m.isAlive && !m.isExMonarch;
        const isConsort = (m.isQueenConsort || m.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ" || m.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") && activeMonarchData && (activeMonarchData.spouseIds||[]).includes(m.id);
        const isCrownPrince = m.isHeir && parseInt(m.heirOrder) === 1;
    
        // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tag
        if (m.isMonarch) {
            if (isKing) {
                postNameTag = `<span class="monarch-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignLabel}</span>`;
            } else if (m.isExMonarch && m.isAlive) {
                postNameTag = `<span class="monarch-tag-table bg-purple-50 text-purple-600 border-purple-200">${reignLabel}</span>`;
            } else {
                postNameTag = `<span class="monarch-tag-table opacity-70 border-slate-300 text-slate-600 bg-slate-50">${reignLabel}</span>`;
            }
        } else if (m.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ" && isConsort) {
            postNameTag = `<span class="queen-consort-tag-table bg-indigo-50 text-indigo-600 border-indigo-200">‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ</span>`;
        } else if (m.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ" && isConsort) {
            postNameTag = `<span class="queen-consort-tag-table">‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤</span>`;
        } else if (m.isQueenConsort && isConsort) {
            postNameTag = `<span class="queen-consort-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå</span>`;
        } else if (isCrownPrince) {
            postNameTag = `<span class="heir-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</span>`;
        }

       else if (m.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") {
            // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏° 
            postNameTag = `<span class="monarch-tag-table" style="background-color: #e0f2fe; color: #0369a1; border-color: #7dd3fc; box-shadow: 0 0 5px rgba(125, 211, 252, 0.4);">‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>`;
        } 
        else if (m.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á") {
            // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡∏¥‡∏ê 
            postNameTag = `<span class="monarch-tag-table" style="background-color: #ffedd5; color: #c2410c; border-color: #fdba74; box-shadow: 0 0 5px rgba(253, 186, 116, 0.4);">‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á</span>`;
        }

    if (m.isPhraKulachet) {
        postNameTag += `<span class="badge-kulachet"><i class="fa-solid fa-star"></i> ‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå</span>`;
    }



        // 3. RANK COLUMN (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢)
        let rankColumnHTML = '';
        const isPrecedenceMode = filterStatus === 'precedence';
        
        if (isPrecedenceMode) {
            if (isKing || isConsort || isCrownPrince || index < 3) {
                rankColumnHTML = `
                    <div class="relative inline-flex items-center justify-center w-8 h-8 mr-3 shrink-0 group-hover:scale-110 transition-transform duration-200">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-200 via-amber-400 to-yellow-600 rounded-full shadow-md"></div>
                        <div class="absolute inset-[2px] bg-white rounded-full"></div>
                        <span class="relative text-xs font-black text-amber-700 z-10 font-mono">${toThaiNumerals(index + 1)}</span>
                    </div>`;
            } else {
                rankColumnHTML = `
                    <div class="w-8 mr-3 text-center shrink-0">
                        <span class="inline-block w-6 text-xs font-mono font-bold text-slate-400 bg-slate-100 py-0.5 rounded border border-slate-200">${toThaiNumerals(index + 1)}</span>
                    </div>`;
            }
        }
    
        // 4. CONTROLS
        const dragHandle = isPrecedenceMode ? `
            <div class="drag-handle text-slate-300 hover:text-indigo-500 cursor-grab active:cursor-grabbing p-1 transition-colors mr-1">
                <i class="fa-solid fa-grip-vertical"></i>
            </div>` : '';
    
        const moveControls = isPrecedenceMode ? `
            <div class="flex flex-col gap-1 mr-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <button onclick="movePrecedence('${m.id}', -1)" class="w-5 h-5 flex items-center justify-center text-[10px] text-slate-500 hover:text-white hover:bg-indigo-500 rounded bg-white border border-slate-200 shadow-sm"><i class="fa-solid fa-chevron-up"></i></button>
                <button onclick="movePrecedence('${m.id}', 1)" class="w-5 h-5 flex items-center justify-center text-[10px] text-slate-500 hover:text-white hover:bg-indigo-500 rounded bg-white border border-slate-200 shadow-sm"><i class="fa-solid fa-chevron-down"></i></button>
            </div>` : '';
        
        const row = document.createElement('tr');
        row.className = "group bg-white border-b border-slate-100 hover:bg-indigo-50/40 transition-all duration-200 ease-in-out";
        row.setAttribute('data-id', m.id);
    
        const fatherName = state.members.find(x=>x.id===m.fatherId)?.name || '<span class="text-slate-300">-</span>';
        const motherName = state.members.find(x=>x.id===m.motherId)?.name || '<span class="text-slate-300">-</span>';
    
        row.innerHTML = `
            <td class="py-3 pl-2 w-[70px]">
                <div class="flex items-center justify-center">
                    ${dragHandle}
                    <div class="relative">
                        <img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" 
                             class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-md group-hover:shadow-lg transition-shadow">
                        ${m.isAlive ? '<div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-white rounded-full"></div>' : ''}
                    </div>
                </div>
            </td>
            
            <td class="py-3 pr-4 cursor-pointer" onclick="showDetail('${m.id}')">
                <div class="flex items-center justify-between w-full">
                    
                    <div class="flex items-center min-w-0">
                        ${rankColumnHTML}
                        <div class="flex flex-col justify-center">
                            <div class="flex items-center flex-wrap gap-1">
                                ${fullName}
                                ${postNameTag}
                            </div>
                             ${isPrecedenceMode && m.customPrecedence !== undefined ? 
                                `<div class="mt-0.5"><span class="text-[9px] text-amber-600 bg-amber-50 px-1 rounded border border-amber-100"><i class="fa-solid fa-thumbtack mr-0.5"></i>‡∏ï‡∏£‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</span></div>` : ''}
                        </div>
                    </div>

                    <div class="shrink-0 ml-4">
                        <span class="badge-rank ${getRankBadgeClass(m.royalRank)}">
                            ${m.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô'}
                        </span>
                    </div>

                </div>
            </td>
    
            <td class="py-3 text-center w-[120px]">${statusHTML}</td>
            
            <td class="py-3 w-[25%] hidden sm:table-cell">
                <div class="flex flex-col text-xs space-y-1">
                    <div class="flex items-center gap-2 truncate text-slate-600">
                        <i class="fa-solid fa-mars text-blue-400 w-3 text-center"></i>
                        <span class="truncate hover:text-indigo-600 transition-colors cursor-help" title="‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤">${fatherName}</span>
                    </div>
                    <div class="flex items-center gap-2 truncate text-slate-600">
                        <i class="fa-solid fa-venus text-pink-400 w-3 text-center"></i>
                        <span class="truncate hover:text-indigo-600 transition-colors cursor-help" title="‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤">${motherName}</span>
                    </div>
                </div>
            </td>
    
            <td class="py-3 pr-2 w-[100px]">
                <div class="flex items-center justify-end">
                    ${moveControls}
                    <button onclick="editPersonDirect('${m.id}')" 
                            class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-all opacity-0 group-hover:opacity-100" 
                            title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (filterStatus === 'precedence') {
        initTableSortable();
    }
}
    



function movePrecedence(id, direction) {

 // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    const filterStatus = document.getElementById('tableFilterStatus').value;
       
    // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    let list = state.members.filter(m => m.isAlive && calculatePojiamScore(m) > 0);
    
    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ index ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
    list.sort((a, b) => {
        const scoreA = a.customPrecedence !== undefined ? a.customPrecedence : calculatePojiamScore(a);
        const scoreB = b.customPrecedence !== undefined ? b.customPrecedence : calculatePojiamScore(b);
        return scoreB - scoreA;
    });

    const index = list.findIndex(m => m.id === id);
    if (index === -1) return;

    const targetIndex = index + direction; 
    if (targetIndex < 0 || targetIndex >= list.length) return;

    const currentPerson = list[index];
    const targetPerson = list[targetIndex];

    // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ customPrecedence ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠)
    if (currentPerson.customPrecedence === undefined) currentPerson.customPrecedence = calculatePojiamScore(currentPerson);
    if (targetPerson.customPrecedence === undefined) targetPerson.customPrecedence = calculatePojiamScore(targetPerson);

    // 4. ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    const temp = currentPerson.customPrecedence;
    currentPerson.customPrecedence = targetPerson.customPrecedence;
    targetPerson.customPrecedence = temp;

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ã‡πâ‡∏≠‡∏ô
    if (currentPerson.customPrecedence === targetPerson.customPrecedence) {
        currentPerson.customPrecedence += (direction * -0.01);
    }

    saveState();
    renderTable();
    showToast(`‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ${currentPerson.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
}

function renderRoyalRow(tbody, m, displayIdx, mother, showMotherTag) {
    let fullName = getFullDisplayTitle(m);
    if (m.monarchSpouseContext) fullName = fullName.replace(m.monarchSpouseContext, "").trim();

    const row = document.createElement('tr');
    row.className = "data-row border-b border-slate-100 hover:bg-slate-50 transition";
    
    let motherTagHTML = "";
    if (showMotherTag) {
       const parentLabel = (mother && mother.gender === 'M') ? '‡∏ö‡∏¥‡∏î‡∏≤:' : '‡∏°‡∏≤‡∏£‡∏î‡∏≤:';
        motherTagHTML = `
            <div class="mother-tag-container">
                <span class="mother-tag-label">${parentLabel}</span>
                <span class="mother-tag-value">${mother ? getFullDisplayTitle(mother).replace(/‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà\s*\d+/, "").trim() : '-'}</span>
            </div>
        `;
    }

    row.innerHTML = `
        <td class="text-center py-3"><img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full mx-auto object-cover border shadow-sm"></td>
        <td class="py-3 text-sm font-bold text-slate-700" onclick="showDetail('${m.id}')">
            <div class="flex items-center">
                <span class="child-index-circle">${toThaiNumerals(displayIdx)}</span>
                <div class="ml-3">
                    <div class="flex items-center flex-wrap gap-y-1">
                        ${fullName}
                        ${motherTagHTML}
                    </div>
                </div>
            </div>
        </td>
        <td class="py-3">${m.isAlive ? '<span class="text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded-full text-[11px]">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>' : '<span class="text-slate-400 bg-slate-50 px-2 py-1 rounded-full text-[11px]">'+getDeathTerm(m)+'</span>'}</td>
        <td class="py-3 text-xs text-slate-500">‡∏û.‡∏®. ${m.birthYear ? toThaiNumerals(m.birthYear) : '-'}</td>
        <td class="text-center py-3"><button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button></td>
    `;
    tbody.appendChild(row);
}

    // ================= MONARCH & MODAL HELPERS (RESTORED) =================

    function renderMonarchBanner() {
        try {
            const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
            const banner = document.getElementById('monarchBanner');
            const vacant = document.getElementById('monarchVacant');
            if(activeMonarch) {
                banner.classList.remove('hidden'); banner.classList.add('flex'); vacant.classList.add('hidden'); vacant.classList.remove('flex');
                document.getElementById('monarchImg').src = activeMonarch.image || (activeMonarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
                document.getElementById('monarchName').innerText = getFullDisplayTitle(activeMonarch) + " " + getGlobalReignLabel(activeMonarch);
            } else {
                banner.classList.add('hidden'); banner.classList.remove('flex');
                if(state.members.length > 0) { vacant.classList.remove('hidden'); vacant.classList.add('flex'); } 
                else { vacant.classList.add('hidden'); vacant.classList.remove('flex'); }
            }
        } catch(e) { console.error("Banner Render Error:", e); }
    }

    // ================= MONARCH & QUEEN CONSORT HELPERS (FIXED ORDERING) =================

    function checkQueenConsortEligible() { 
        const g = document.querySelector('input[name="gender"]:checked').value; 
        const r = document.getElementById('p_relationship').value; 
        const ok = g === 'F' && (r === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || r === '‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤' || (r||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || r === '‡∏´‡∏°‡πà‡∏≠‡∏°'); 
        document.getElementById('queenConsortOption').classList.toggle('hidden', !ok); 
    }

    function updateQueenConsortSelector(d) {
    const selDiv = document.getElementById('maleMonarchQueenSelect');
    const sel = document.getElementById('p_queenSelectForKing');
    const label = selDiv.querySelector('label');
    const genderVal = document.querySelector('input[name="gender"]:checked')?.value;
    const isMonarch = document.getElementById('p_isMonarch').checked;

    if (isMonarch) {
        selDiv.classList.remove('hidden');
        
        // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Label ‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        if (genderVal === 'F') {
            label.innerText = "‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ (‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ó‡πà‡∏≤‡∏ô)";
        } else {
            label.innerText = "‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)";
        }

        // 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Select (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏≤‡∏Å‡∏è)
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
        const spouseIds = [];
        document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));
        
        let currentConsortId = null;
        spouseIds.forEach(sid => {
            const s = state.members.find(m => m.id === sid);
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
            const targetGender = (genderVal === 'F') ? 'M' : 'F';
            
            if(s && s.gender === targetGender) {
                const op = document.createElement('option');
                op.value = s.id; 
                op.innerText = s.name;
                sel.appendChild(op);
                if(s.isQueenConsort) currentConsortId = s.id;
            }
        });
        if(currentConsortId) sel.value = currentConsortId;
    } else {
        selDiv.classList.add('hidden');
    }
}

 function toggleMonarch(prefixVal = null, suffixVal = null) { // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤
    const isM = document.getElementById('p_isMonarch').checked; 
    const monarchPanel = document.getElementById('monarchPanel');
    const relSelect = document.getElementById('p_relationship'); 

    if (monarchPanel) monarchPanel.classList.toggle('hidden', !isM); 

    if (isM) {
        if (relSelect) {
            relSelect.value = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            updatePrefixOptions(prefixVal, suffixVal); 
        }
    }
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateQueenConsortSelector();
}
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå (1-15)
 * ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå (1-15)
 */
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô 15 ‡∏•‡∏≥‡∏î‡∏±‡∏ö ---
function getSuccessionPriority(p, monarch) {

// ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÉ‡∏´‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)
    if (!p || !p.isAlive || p.isResigned) return 999;

    if (!p || !p.isAlive) return 999;
    const isMale = p.gender === 'M';
    const isFemale = p.gender === 'F';
    const rel = p.relationship || '';
    const pre = p.titlePrefix || '';
    const rank = p.royalRank || '';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà "‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™" ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    // ‡πÇ‡∏î‡∏¢‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤ motherId ‡∏´‡∏£‡∏∑‡∏≠ fatherId ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö registeredSpouseId ‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const isChildOfRegistered = monarch && (p.motherId === monarch.registeredSpouseId || p.fatherId === monarch.registeredSpouseId);

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ (‡∏ä‡∏≤‡∏¢) - ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™" && pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" && isChildOfRegistered) return 1;
    
    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ (‡∏ä‡∏≤‡∏¢) - ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™" && pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 2;
    
    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ (‡∏´‡∏ç‡∏¥‡∏á) - ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô << ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    if (isFemale && (rel === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤" || rel === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠") && 
        (pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠" || pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") && isChildOfRegistered) return 3;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠" && pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") return 4;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™" && pre === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 5;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠" && pre === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") return 6;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 7;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 8;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 9;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 10;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 11;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 12;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 13;
    if (isMale && rel === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" && pre.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) return 14;
    if (isMale && rank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") return 15;
    return 999;
}

let selectedAppointId = null; 

function openAppointModal() {
    const container = document.getElementById('appointSelectModal');
    if (!container) return;
    container.innerHTML = '';
    selectedAppointId = null; 

    

    const lastMonarch = state.members.find(m => m.isMonarch && !m.isExMonarch) || 
                   state.members.filter(m => m.isMonarch).sort((a,b) => (b.globalReignNumber||0) - (a.globalReignNumber||0))[0];

    let eligible = state.members.filter(m => {
        const priority = getSuccessionPriority(m, lastMonarch);
        return m.isAlive && priority <= 15;
    });

    if (eligible.length === 0) {
        showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î");
        return;
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô -> ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤ -> ‡∏≠‡∏≤‡∏¢‡∏∏
    eligible.sort((a, b) => {
        const priA = getSuccessionPriority(a, lastMonarch);
        const priB = getSuccessionPriority(b, lastMonarch);
        if (priA !== priB) return priA - priB;
        const mScoreA = getMotherRankScore(state.members.find(m => m.id === a.motherId));
        const mScoreB = getMotherRankScore(state.members.find(m => m.id === b.motherId));
        if (mScoreB !== mScoreA) return mScoreB - mScoreA;
        return (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999);
    });

    eligible.forEach((m, idx) => {
        const pri = getSuccessionPriority(m, lastMonarch);
        const item = document.createElement('div');
        item.className = 'appoint-item';
        item.onclick = () => {
            document.querySelectorAll('.appoint-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedAppointId = m.id;
        };
        
        let icon = (idx < 3) ? "üëë" : "‚ú®";
        let heirTagHTML = (idx < 3) ? `<span class="tag-heir">‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÇ‡∏î‡∏¢‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${idx + 1}</span>` : "";
        
        item.innerHTML = `
            <div class="mr-4 text-2xl">${icon}</div>
            <div class="flex-1">
                <div class="flex items-center gap-1 mb-1">
                    <span class="tag-order">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${idx + 1}</span>
                    <span class="text-[9px] text-slate-400 font-bold">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${pri}</span>
                </div>
                <div class="text-sm font-bold text-slate-700 leading-tight">
                    ${getFullDisplayTitle(m)}${heirTagHTML}
                </div>
            </div>
        `;
        container.appendChild(item);
    });
    document.getElementById('appointModal').classList.add('active');
}

function appointFromModal() {
    if (!selectedAppointId) {
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚ú®");
        return;
    }
    const targetId = selectedAppointId;
    closeModal('appointModal');
    openReignNameSelectionModal(targetId);
}

    function openReignNameSelectionModal(id) {
        tempAppointId = id;
        const s = document.getElementById('reignSelectionInput');
        s.innerHTML = '';
        state.reignNames.forEach(n => {
            const op = document.createElement('option');
            op.value = n; op.innerText = n;
            s.appendChild(op);
        });
        document.getElementById('reignSelectionModal').classList.add('active');
    }

    function confirmReignSelection() {
        const rName = document.getElementById('reignSelectionInput').value;
        if(tempAppointId && rName) {
            performSuccession(tempAppointId, rName);
            closeModal('reignSelectionModal');
        }
    }


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏© (‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà ‡∏õ‡∏π‡πà‡∏¢‡πà‡∏≤ ‡∏ó‡∏ß‡∏î...) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏à‡∏ô‡∏™‡∏∏‡∏î‡∏ú‡∏±‡∏á
 */

function isAnyAncestor(checkId, startId) {
    if (!checkId || !startId) return false;
    let stack = [startId];
    let seen = new Set();
    while (stack.length > 0) {
        let currId = stack.pop();
        if (seen.has(currId)) continue;
        seen.add(currId);
        let curr = state.members.find(m => m.id === currId);
        if (curr) {
            if (curr.fatherId === checkId || curr.motherId === checkId) return true;
            if (curr.fatherId) stack.push(curr.fatherId);
            if (curr.motherId) stack.push(curr.motherId);
        }
    }
    return false;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isDirectGrandchild(person, monarchId) {
    if (person.fatherId) {
        const f = state.members.find(m => m.id === person.fatherId);
        if (f && (f.fatherId === monarchId || f.motherId === monarchId)) return true;
    }
    if (person.motherId) {
        const m = state.members.find(m => m.id === person.motherId);
        if (m && (m.fatherId === monarchId || m.motherId === monarchId)) return true;
    }
    return false;
}

 // ================= SUCCESSION & LIFE EVENTS LOGIC =================

function performSuccession(newMonarchId, reignNameBase) {
    const newMonarch = state.members.find(m => m.id === newMonarchId);
    if (!newMonarch) return;

  // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
  state.members.forEach(p => {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ---
        if (p.isHeir && p.id !== newMonarchId) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡πâ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÑ‡∏õ (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå 1 ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå)
            if (p.heirOrder && parseInt(p.heirOrder) > 1) {
                const oldOrder = p.heirOrder;
                p.heirOrder = (parseInt(p.heirOrder) - 1).toString(); // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô 2->1, 3->2, 4->3)
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
                if (typeof recordTitleHistory === 'function') {
                    const message = `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${oldOrder} ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${p.heirOrder} (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)`;
                    recordTitleHistory(p, message);
                }
            }
        } else if (p.id === newMonarchId) {
            // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            p.isHeir = false;
            p.heirOrder = null;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        if (p.id !== newMonarchId && p.isMonarch && !p.isExMonarch) {
            if (!p.reignEnd) p.reignEnd = new Date().getFullYear() + 543;
            p.isExMonarch = p.isAlive;
            p.isMonarch = true; 
            p.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; 
        }
    });

    // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏ö Loop ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Real-time
    if (typeof updateApp === 'function') updateApp();
    if (typeof saveState === 'function') saveState();
    // ============================================================
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
    // ============================================================
    newMonarch.kromRank = "";    
    newMonarch.kromTitle = "";   
    newMonarch.surname = "";     
    newMonarch.isHeir = false;   
    newMonarch.isQueenConsort = false; 

    newMonarch.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)"; 
    newMonarch.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; 
    newMonarch.isMonarch = true; 
    newMonarch.isExMonarch = false; 
    newMonarch.titleSuffix = "‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"; 

    if (newMonarch.gender === 'F') {
        newMonarch.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ"; 
    } else {
        newMonarch.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞"; 
    }

    newMonarch.hasUmbrella = true;
    newMonarch.umbrellaType = "‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£";

    newMonarch.reignStart = new Date().getFullYear() + 543;
    newMonarch.reignNameBase = reignNameBase;
    newMonarch.useReignName = true;
    const monarchs = state.members.filter(x => x.isMonarch);
    const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber || 0)));
    if (!newMonarch.globalReignNumber) newMonarch.globalReignNumber = maxGlobal + 1;
    
    recordTitleHistory(newMonarch);

    // ============================================================
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Triple-Pass Engine)
    // ============================================================

    // --- PASS 0: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®) ---
    (newMonarch.spouseIds || []).forEach(sid => {
        const spouse = state.members.find(s => s.id === sid);
        if (!spouse || !spouse.isAlive) return;

        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å Bypass ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏®‡∏°‡πÄ‡∏´‡∏™‡∏µ/‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤
        const isRegistered = (sid === newMonarch.registeredSpouseId);

        if (newMonarch.gender === 'M' && isRegistered && spouse.gender === 'F') {
            spouse.relationship = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
            spouse.isQueenConsort = true;
            spouse.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)"; 
            spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ";
            spouse.titleSuffix = ""; 
            spouse.surname = "";
            spouse.hideRoyalRank = false;
        } else if (newMonarch.gender === 'M' && spouse.gender === 'M') {
            spouse.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
            spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤";
            spouse.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
        } else if (newMonarch.gender === 'F') {
            spouse.relationship = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
            spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤";
            spouse.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
        } else {
            const sFather = state.members.find(f => f.id === spouse.fatherId);
            const sMother = state.members.find(m => m.id === spouse.motherId);
            const isDaughterOfKing = (sFather?.isMonarch || sMother?.isMonarch);
            const isRoyal = spouse.royalRank && (spouse.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || spouse.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || spouse.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'));
            if (isRoyal) {
                spouse.relationship = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
                spouse.titlePrefix = isDaughterOfKing ? "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" : "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠";
            } else {
                spouse.relationship = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
                const hasChildren = state.members.some(m => (m.fatherId === newMonarchId && m.motherId === sid) || (m.motherId === newMonarchId && m.fatherId === sid));
                spouse.titlePrefix = hasChildren ? "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°";
            }
        }
        recordTitleHistory(spouse);
    });

    // --- PASS 1: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ "‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®) ---
    state.members.forEach(p => {
        if (p.id === newMonarchId || !p.isAlive) return;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        if (p.gender === 'F') {
            // 1. ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏® ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ
            if (p.isResigned && !p.isRestored) {
                p.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
                p.titlePrefix = "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á";
                p.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏•‡∏≤‡∏≠‡∏≠‡∏Å)";
                return; 
            }
            // 2. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà
            if (p.isRestored) { p.isResigned = false; }
        }
        // ---------------------------------------------

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isChild = (p.fatherId === newMonarchId || p.motherId === newMonarchId);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å ‡πÉ‡∏´‡πâ Bypass Lock ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà)
        if (p.isRankLocked && !isChild) return; 

        // ‡∏Å‡∏é‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
        const excludedRoles = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°"];
        if (excludedRoles.includes(p.relationship) || p.titlePrefix?.includes("‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠")) return;

        if (isChild) {
            const isMale = p.gender === 'M';
            const mother = state.members.find(mo => mo.id === p.motherId);
            const father = state.members.find(f => f.id === p.fatherId);
            const otherParent = (p.fatherId === newMonarchId) ? mother : father;
            const isOtherParentHighRoyal = otherParent && (otherParent.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || otherParent.isQueenConsort);

            p.relationship = isMale ? "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™" : "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤";
            if (isOtherParentHighRoyal) {
                p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                p.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
            } else {
                p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                p.titlePrefix = isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
            }
            p.surname = ""; 
            p.hideRoyalRank = false;
            recordTitleHistory(p);
        }
    });

    // --- PASS 2: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ "‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" / "‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå" / "‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠" / "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á" ---
    state.members.forEach(p => {
        if (p.id === newMonarchId || !p.isAlive || p.isExMonarch) return;
        if (p.fatherId === newMonarchId || p.motherId === newMonarchId) return; // ‡∏ó‡∏≥‡πÉ‡∏ô Pass 1 ‡πÅ‡∏•‡πâ‡∏ß

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        if (p.gender === 'F') {
            // 1. ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏® ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ
            if (p.isResigned && !p.isRestored) {
                p.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
                p.titlePrefix = "‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á";
                p.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏•‡∏≤‡∏≠‡∏≠‡∏Å)";
                return; 
            }
            // 2. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà
            if (p.isRestored) { p.isResigned = false; }
        }
        // ---------------------------------------------
        

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£ Bypass Lock
        const father = state.members.find(f => f.id === p.fatherId);
        const mother = state.members.find(mo => mo.id === p.motherId);
        const isMale = p.gender === 'M';
        const mBirthYear = parseInt(newMonarch.birthYear) || 0;
        const pBirthYear = parseInt(p.birthYear) || 0;

        const isSameFather = (p.fatherId === newMonarch.fatherId && p.fatherId);
        const isSameMother = (p.motherId === newMonarch.motherId && p.motherId);
        const isSibling = isSameFather || isSameMother; // ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°/‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤
        
        const isDirectGrandchildVar = (father && (father.fatherId === newMonarchId || father.motherId === newMonarchId)) || 
                                      (mother && (mother.fatherId === newMonarchId || mother.motherId === newMonarchId)); // ‡∏´‡∏•‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å)
        
        const isMomChao = (p.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤');

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏∞‡∏ö‡∏ö Bypass Lock ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ---
        // ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏® ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç return ‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢)
        const canBypassInPass2 = isSibling || (isDirectGrandchildVar && !isMomChao);
        if (p.isRankLocked && !canBypassInPass2) return;

        // 2. [‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏°] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
        const isAncestor = isAnyAncestor(p.id, newMonarchId);
        if (isAncestor) {
            recordTitleHistory(p);
            return; 
        }

        // ‡∏Å‡∏é‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
        const excludedRoles = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°"];
        if (excludedRoles.includes(p.relationship) || p.titlePrefix?.includes("‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠")) {
            recordTitleHistory(p);
            return;
        }

        const isHighRoyal = p.royalRank && (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || p.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || isMomChao);
        if (!isHighRoyal) return;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
        const exMonarchs = state.members.filter(m => m.isExMonarch);
        const isSiblingOfExMonarch = exMonarchs.some(ex => 
            (p.fatherId === ex.fatherId && p.fatherId) || (p.motherId === ex.motherId && p.motherId)
        );
        const isChildOfAnyMonarch = (father && father.isMonarch) || (mother && mother.isMonarch);

        // A. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏ò‡∏≠ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏°‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®)
        if (isSibling) {
            const isFullSibling = isSameFather && isSameMother;
            const ageSuffix = pBirthYear < mBirthYear ? (isMale ? '‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠') : (isMale ? '‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠');
            if (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                p.titlePrefix = isFullSibling ? `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤${ageSuffix}` : `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞${ageSuffix}`;
            } else if (p.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
                p.titlePrefix = isFullSibling ? `‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤${ageSuffix}` : `‡∏û‡∏£‡∏∞${ageSuffix}`;
            }
            p.relationship = isFullSibling ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤";
        } 
        
        // B. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö]
        else if (isChildOfAnyMonarch || isSiblingOfExMonarch) {
            p.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå"; 
            if (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            } else if (p.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
                p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            } else {
                p.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            }
        }

        // C. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®)
        else if (isDirectGrandchildVar) {
            p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            if (isMomChao) {
                p.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"; // ‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
            } else {
                if (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                    p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                    p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
                } else {
                    p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                    p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
                }
            }
        }

        // D. ‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î]
        else {
            const wasLanThoe = p.titlePrefix && p.titlePrefix.includes("‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠");
            const grandfather = father ? state.members.find(g => g.id === father.fatherId) : null;
            const isGrandchildOfMonarch = grandfather && grandfather.isMonarch;
            const isFatherNotMonarch = father && !father.isMonarch;

            if (wasLanThoe || (isGrandchildOfMonarch && isFatherNotMonarch)) {
                p.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå"; 
                if (p.titlePrefix && p.titlePrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠")) {
                    p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                } 
                else if (p.titlePrefix && p.titlePrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠")) {
                    p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                }
                else if (isMomChao) {
                    p.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
            }
        }

        recordTitleHistory(p);
        const currentFullTitle = getFullDisplayTitle(p);
        triggerHierarchyPromotion(p.id, p.royalRank, currentFullTitle); 
    });

    saveState();
    updateApp();
    closeModal('reignSelectionModal');
    showFantasyPopup(newMonarch);
}

function handleMonarchDeath(monarch) {
    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï
    monarch.isMonarch = true; 
    monarch.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; 
    monarch.isExMonarch = false; 
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    monarch.reignEnd = state.worldTime.year; 

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
    if(monarch.spouseIds && monarch.spouseIds.length > 0) {
        const reignNum = getGlobalReignLabel(monarch);
        monarch.spouseIds.forEach(sid => {
            const sp = state.members.find(x => x.id === sid);
            if(sp && sp.isAlive) {
                const rel = sp.relationship || '';
                if (sp.isQueenConsort || rel === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || rel === '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ' || rel === '‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ' || rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
                    sp.monarchSpouseContext = `‡πÉ‡∏ô${reignNum}`;
                    recordTitleHistory(sp);
                }
            }
        });
    }

    // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë
    const heirs = state.members.filter(m => m.isHeir && m.isAlive).sort((a,b) => (a.heirOrder||99) - (b.heirOrder||99));
    
    if(heirs.length > 0 && parseInt(heirs[0].heirOrder) === 1) {
        const successor = heirs[0];

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
        if (state.worldTime && state.worldTime.isRunning) {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            const randomReignName = state.reignNames[Math.floor(Math.random() * state.reignNames.length)] || "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô";
            
            addHistoryLog(`‡∏ú‡∏•‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô: ${successor.name} ‡πÄ‡∏™‡∏ß‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô: ${randomReignName})`);
            showToast(`‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà! ${successor.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå (‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏≤‡∏°: ${randomReignName})`);
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤
            performSuccession(successor.id, randomReignName);
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
            state.members.filter(m => m.isHeir && m.isAlive && m.id !== successor.id).forEach(h => {
                if(h.heirOrder > 1) h.heirOrder--;
            });
            saveState();
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤): ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${successor.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå...`);
            setTimeout(() => {
                openReignNameSelectionModal(successor.id);
                state.members.filter(m => m.isHeir && m.isAlive && m.id !== successor.id).forEach(h => {
                    if(h.heirOrder > 1) h.heirOrder--;
                });
                saveState();
            }, 2000);
        }
    } else {
        addHistoryLog(`‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏™‡∏∑‡∏ö‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå`);
        showToast(`‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë`);
        saveState();
    }
}

function showFantasyPopup(monarch) {
    const modal = document.getElementById('fantasyModal');
    if(!modal) return; // ‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ Modal ‡πÉ‡∏ô HTML
    document.getElementById('fan_name').innerText = getFullDisplayTitle(monarch);
    document.getElementById('fan_rama').innerText = getGlobalReignLabel(monarch);
    document.getElementById('fan_img').src = monarch.image || (monarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
    document.getElementById('fan_dynasty').innerText = state.dynastyName || '-';
    document.getElementById('fan_kingdom').innerText = state.kingdomName || '-';
    const pc = document.getElementById('fantasyParticles'); pc.innerHTML = '';
    for(let i=0; i<30; i++) {
        const p = document.createElement('div'); p.className = 'particle';
        p.style.left = Math.random()*100 + '%'; p.style.width = Math.random()*6 + 2 + 'px'; p.style.height = p.style.width; p.style.animationDelay = Math.random()*2 + 's';
        p.style.background = Math.random() > 0.5 ? '#ffd700' : '#fff'; pc.appendChild(p);
    }
    modal.classList.add('active');
}

function abdicateCurrent() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏à‡∏≤‡∏Å ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà
    const monarch = state.members.find(m => m.id === window.curPID); 

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç **‡∏Å‡πà‡∏≠‡∏ô** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡πÜ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic Error ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    if (!monarch || !monarch.isMonarch || monarch.isExMonarch) {
        showToast("‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå");
        return;
    }

    // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë)')) return;
    
    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const currentReignNum = monarch.globalReignNumber;
    monarch.isExMonarch = true; 
    monarch.reignEnd = new Date().getFullYear() + 543;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
    recordTitleHistory(monarch);
    
    // 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà...")
    if(monarch.spouseIds && monarch.spouseIds.length > 0) {
        const reignLabel = `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(currentReignNum)}`; 
        monarch.spouseIds.forEach(sid => {
            const sp = state.members.find(x => x.id === sid);
            if(sp && sp.isAlive) {
                const rel = sp.relationship || '';
                if (rel === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || rel === '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ' || rel === '‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ' || rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || sp.isQueenConsort) {
                    sp.isQueenConsort = false;
                    sp.monarchSpouseContext = `‡πÉ‡∏ô${reignLabel}`;
                    recordTitleHistory(sp);
                }
            }
        });
    }
    
    // 6. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤
    const heirs = state.members.filter(m => m.isHeir && m.isAlive)
                               .sort((a,b) => (a.heirOrder||99) - (b.heirOrder||99));
    
    saveState(); 
    closeModal('detailModal'); 
    
    // 7. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Pop-up ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
    if(heirs.length > 0 && parseInt(heirs[0].heirOrder) === 1) {
        const successor = heirs[0];
        showToast(`‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${successor.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå`);
        setTimeout(() => {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
            openReignNameSelectionModal(successor.id); 
        }, 800);
    } else {
        showToast(`‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë`);
        updateApp(); 
    }
}
    // ================= END ABDICATION LOGIC =================
    
    // ================= NEW SPOUSE SELECTION MODAL LOGIC =================
    
    // 1. New function to open the selection modal (replaces the old openAddSpouseModal(id))
    function openSpouseSelectionModal(id) {
        closeModal('detailModal');

        
        
        targetOriginIdForSpouse = id;
        const originPerson = state.members.find(m => m.id === id);

        // ‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    if (originPerson.isMonarch && originPerson.gender === 'F' && (originPerson.spouseIds || []).length >= 1) {
        showToast("‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏°‡∏ì‡πÄ‡∏ë‡∏µ‡∏¢‡∏£‡∏ö‡∏≤‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
    }
        
    // ‡∏Å‡∏é‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)
    if (originPerson.isMonarch && originPerson.gender === 'M') {
        const hasMaleSpouse = (originPerson.spouseIds || []).some(sid => {
            const s = state.members.find(m => m.id === sid);
            return s && s.gender === 'M';
        });
        if (hasMaleSpouse) {
            showToast("‡∏ï‡∏≤‡∏°‡∏Å‡∏è‡∏°‡∏ì‡πÄ‡∏ë‡∏µ‡∏¢‡∏£‡∏ö‡∏≤‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß");
        }
    }

        // Prepare list of eligible spouses (not self, not current spouse)
        const currentSpouseIds = originPerson.spouseIds || [];
        const eligible = state.members.filter(m => 
            m.id !== id && 
            !currentSpouseIds.includes(m.id) &&
            m.isAlive // Only suggest living people
        );

        const dl = document.getElementById('eligibleSpouseList');
        dl.innerHTML = '';
        eligible.forEach(m => {
            const op = document.createElement('option');
            // Format: ID : Full Name
            op.value = `${m.id} : ${getFullDisplayTitle(m)}`; 
            dl.appendChild(op);
        });

        // Reset inputs
        document.getElementById('existingSpouseSearch').value = '';
        document.getElementById('selectedExistingSpouseId').value = '';

        document.getElementById('spouseSelectionModal').classList.add('active');
    }

    // 2. Validate input against datalist options
    function validateExistingSpouseInput() {
        const input = document.getElementById('existingSpouseSearch').value.trim();
        const hiddenId = document.getElementById('selectedExistingSpouseId');
        
        hiddenId.value = ''; // Reset ID

        // Try matching the whole string (ID : Name)
        const eligibleOptions = document.getElementById('eligibleSpouseList').options;
        for (let i = 0; i < eligibleOptions.length; i++) {
            if (eligibleOptions[i].value === input) {
                // Extract ID from "ID : Name" format
                const id = input.split(' : ')[0].trim();
                hiddenId.value = id;
                return;
            }
        }

        // Try matching just the ID or Name
        const parts = input.split(' : ');
        const searchVal = parts.length > 1 ? parts[0].trim() : input; // If split, use ID part, otherwise use full input
        
        const exists = state.members.find(m => m.id === searchVal || m.name === searchVal);
        
        if (exists) {
            hiddenId.value = exists.id;
            // Optionally, update the input value to the full format for clarity
            document.getElementById('existingSpouseSearch').value = `${exists.id} : ${getFullDisplayTitle(exists)}`;
        }
    }

    // 3. Link the selected existing spouse
   function confirmLinkExistingSpouse() {
    const spouseId = document.getElementById('selectedExistingSpouseId').value;
    if (!spouseId || !targetOriginIdForSpouse) {
        showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
    }

    const p1 = state.members.find(m => m.id === targetOriginIdForSpouse); // ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏á
    const p2 = state.members.find(m => m.id === spouseId); // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ä‡∏≤‡∏¢
    if (p1.isMonarch && p1.gender === 'M' && p2.gender === 'M') {
        const alreadyHasMaleSpouse = (p1.spouseIds || []).some(sid => {
            const s = state.members.find(m => m.id === sid);
            return s && s.gender === 'M';
        });
        if (alreadyHasMaleSpouse) {
            alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ: ${p1.name} ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏°‡∏ì‡πÄ‡∏ë‡∏µ‡∏¢‡∏£‡∏ö‡∏≤‡∏•`);
            return;
        }
    }

    if (p1 && p2) {
        // Add ID to spouseIds of both parties
        if (!p1.spouseIds) p1.spouseIds = [];
        if (!p2.spouseIds) p2.spouseIds = [];

        if (!p1.spouseIds.includes(p2.id)) p1.spouseIds.push(p2.id);
        if (!p2.spouseIds.includes(p1.id)) p2.spouseIds.push(p1.id);

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (Real-time) ---
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        if (p1.gender === 'M' && p2.gender === 'F') {
            applyRoyalMarriageRules(p2, p1);
        } else if (p2.gender === 'M' && p1.gender === 'F') {
            applyRoyalMarriageRules(p1, p2);
        }
        // -----------------------------------------------------------

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
        
        if (activeMonarch && (p1.id === activeMonarch.id || p2.id === activeMonarch.id)) {
            const monarch = (p1.id === activeMonarch.id) ? p1 : p2;
            const spouse = (p1.id === activeMonarch.id) ? p2 : p1;

            if (monarch.gender === 'M') {
                if (spouse.gender === 'F') {
                    const isRoyal = spouse.royalRank && (spouse.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || spouse.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || spouse.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'));
                    const isDaughterOfKing = state.members.some(m => m.isMonarch && (spouse.fatherId === m.id || spouse.motherId === m.id));

                    if (isRoyal) {
                        spouse.relationship = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
                        spouse.titlePrefix = isDaughterOfKing ? "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" : "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠";
                        spouse.isQueenConsort = false;
                        spouse.surname = ""; 
                        spouse.hideRoyalRank = false;
                        showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤: ${spouse.name} ‡πÄ‡∏õ‡πá‡∏ô ${spouse.titlePrefix}`);
                    } else {
                        spouse.relationship = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
                        spouse.titlePrefix = "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°";
                        spouse.surname = "";
                        spouse.hideRoyalRank = false;
                        showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤: ${spouse.name} ‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°`);
                    }
                } else if (spouse.gender === 'M') {
                    spouse.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
                    spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤";
                    spouse.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)"; 
                    spouse.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
                    spouse.surname = "";
                    spouse.hideRoyalRank = false;
                    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ: ${spouse.name}`);
                }
            } else {
               if (spouse.gender === 'M') {
                    spouse.relationship = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
                    spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤";
                    spouse.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)"; 
                    spouse.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
                    spouse.surname = "";
                    spouse.hideRoyalRank = false;
                    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ: ${spouse.name}`);
                }
            }
            if (typeof recordTitleHistory === 'function') recordTitleHistory(spouse);
        }

        // Re-run checkConsortMotherhood
        [p1, p2].forEach(p => {
            if (p.gender === 'F' && (p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
                checkConsortMotherhood(p);
            }
        });
        
        saveState();
        closeModal('spouseSelectionModal');
        showToast(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á ${p1.name} ‡πÅ‡∏•‡∏∞ ${p2.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        refreshAllDisplays();
        
        showDetail(targetOriginIdForSpouse);
    } else {
         showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á");
    }
}


    // 4. Proceed to the normal Add New Person form
   function proceedToNewSpouse() {
    closeModal('spouseSelectionModal');
    
    const m = state.members.find(x => x.id === targetOriginIdForSpouse);
    
    if (m) {
        // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á
        const recommendedGender = m.gender === 'M' ? 'F' : 'M';
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        let defaultRel = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        let defaultPrefix = recommendedGender === 'F' ? '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' : '‡∏ô‡∏≤‡∏¢';

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ï‡∏£‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
        if (m.gender === 'M' && m.isMonarch) {
            // ‡∏´‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤ (‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°)
            defaultRel = '‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤';
            defaultPrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°';
        } 
        else if (m.gender === 'M' && !isCommonerDescendant(m)) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°"
            defaultRel = '‡∏´‡∏°‡πà‡∏≠‡∏°';
            defaultPrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
        }
        // ------------------------------

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏´‡∏°‡πà‡∏≠‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
        // ‡∏´‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏°.‡∏£.‡∏ß./‡∏°.‡∏•./‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)
        if (m.gender === 'M' && !isCommonerDescendant(m)) {
            if (m.isMonarch) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏†‡∏£‡∏£‡∏¢‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤" (‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤: ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°)
                defaultRel = '‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤';
                defaultPrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°';
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏†‡∏£‡∏£‡∏¢‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤, ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤, ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°" (‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤: ‡∏´‡∏°‡πà‡∏≠‡∏°)
                defaultRel = '‡∏´‡∏°‡πà‡∏≠‡∏°';
                defaultPrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
            }
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
        openModal({ 
            spouseIds: [m.id], 
            gender: recommendedGender,
            relationship: defaultRel,
            titlePrefix: defaultPrefix,
            royalRank: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' // ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
        }, false, `‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á ${m.name}`);
    } else {
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á");
    }
}
     const actionsContainer = document.querySelector('#detailModal .flex.gap-2.justify-center.border-t');
  
     
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ä‡∏±‡πâ‡∏ô (‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà)
 * ‡πÇ‡∏î‡∏¢‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢‡∏ö‡∏¥‡∏î‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏à‡∏ô‡πÄ‡∏à‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ä‡∏±‡πâ‡∏ô (Generation Number) 
 * ‡πÇ‡∏î‡∏¢‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢‡∏ö‡∏¥‡∏î‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏à‡∏ô‡πÄ‡∏à‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
 */
/**
 * [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ä‡∏±‡πâ‡∏ô (Generation Number) 
 * ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏à‡∏ô‡πÄ‡∏à‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
 */
function getGenerationNumber(id) {
    let curr = state.members.find(m => m.id === id);
    if (!curr) return null;

    let guard = 0;
    while (curr && guard < 100) {
        const father = state.members.find(m => m.id === curr.fatherId);
        const mother = state.members.find(m => m.id === curr.motherId);

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏û‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (father && father.isMonarch && father.globalReignNumber) return father.globalReignNumber;
        if (mother && mother.isMonarch && mother.globalReignNumber) return mother.globalReignNumber;

        // 2. ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏™‡∏≤‡∏¢ (Logic: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏µ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏¢‡∏® ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
        const isFatherRoyal = father && (
            (father.royalRank && father.royalRank !== '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') || 
            father.fatherId || 
            father.motherId
        );

        if (isFatherRoyal) {
            curr = father; // ‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢‡∏û‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        } else if (mother) {
            curr = mother; // ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏∑‡∏ö‡∏™‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á)
        } else {
            break;
        }
        guard++;
    }
    return null;
}

/**
 * [‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Pop-up
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏´‡πâ "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
 */
function formatRoyalRankWithGen(m) {
    // 1. ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const isBaromwong = (m.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå");
    const isAnuwong = (m.relationship === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå");

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô null (‡∏ã‡πà‡∏≠‡∏ô) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (!isBaromwong && !isAnuwong) return null;

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å)
    if (m.isMonarch) return null;
    
    const isRestored = (m.isRestored === true);
    if (m.isResigned && !isAnuwong && !isRestored) return null;

    // 3. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    const genNum = getGenerationNumber(m.id);
    if (!genNum) return null;

    const thaiGen = toThaiNumerals(genNum);
    // ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏¢‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    let baseRank = (m.royalRank || "").replace(/\s?\(|\)/g, ""); 
    let title = m.titlePrefix || "";
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
    if (baseRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤") {
        return `‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏ä‡∏±‡πâ‡∏ô ${thaiGen}`;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: [‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤] ‡∏ä‡∏±‡πâ‡∏ô [‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢] [‡∏¢‡∏®]
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏ä‡∏±‡πâ‡∏ô ‡πë‡πë ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ title ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏ó‡∏ô
    const displayTitle = title || (isBaromwong ? "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå" : "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå");
    
    return `${displayTitle} ‡∏ä‡∏±‡πâ‡∏ô ${thaiGen} ${baseRank}`.trim();
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö
 */
function getConsortCategoryLabel(p) {
    if (!p) return null;
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÑ‡∏î‡πâ
    const validRels = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤", "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ"];
    if (!validRels.includes(p.relationship)) return null;

    // ‡πÉ‡∏ä‡πâ .trim() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const prefix = (p.titlePrefix || "").trim();
    const suffix = (p.titleSuffix || "").trim();

    // 1. {‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ}
    const akkhraSuffixes = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
    if (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ" || (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && akkhraSuffixes.includes(suffix))) {
        return "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    }

    // 2. {‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ} - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏£‡πâ‡∏≠‡∏¢
    if (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" || prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" ) {
        return "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    }

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
    const mahesiSuffixes = ["‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
    if (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && mahesiSuffixes.includes(suffix)) return "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    if (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" && suffix === "‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ") return "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    if (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" && (suffix === "‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ" || suffix === "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    if (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && (suffix === "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ" || suffix === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";

    // 3. {‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠}
    if (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") return "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";

    // 4. {‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤}
    const chayaPrefixes = ["‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠"];
    if (chayaPrefixes.includes(prefix)) return "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤";

    return null;
}




    // 5. Update showDetail to call the new function
  function showDetail(id) {
    const m = state.members.find(x => x.id === id);
    if(!m) return;
    window.curPID = id;




    


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ---
const originalRankRow = document.getElementById('d_originalRankRow');
const originalRankEl = document.getElementById('d_originalRank');

if (m.isResigned && m.originalRoyalRank) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏à‡∏≥‡∏•‡∏≠‡∏á (Mock) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏°
    const mockPerson = {
        ...m,
        royalRank: m.originalRoyalRank,
        relationship: m.originalRelationship,
        titlePrefix: m.originalTitlePrefix,
        
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        titleSuffix: m.originalTitleSuffix || m.titleSuffix || "", 

        // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏¢‡∏®‡∏Å‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á) ‡∏î‡πâ‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏°‡πÉ‡∏´‡πâ
        kromRank: m.originalKromRank || "", 
        kromTitle: m.originalKromTitle || "",

        royalSurname: "", // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô/‡∏ì ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤
        surname: "",      // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        isResigned: false // ‡∏õ‡∏¥‡∏î flag ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢
    };
    
    // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getFullDisplayTitle ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤...)
    originalRankEl.innerText = getFullDisplayTitle(mockPerson);
    originalRankRow.classList.remove('hidden');
} else {
    originalRankRow.classList.add('hidden');
}

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô + ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏°) ---
const spouseTagEl = document.getElementById('d_spouse_tag');
const kromTagEl = document.getElementById('d_krom'); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î

if (spouseTagEl) {
    spouseTagEl.classList.add('hidden');
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà
    spouseTagEl.classList.remove('block', 'inline-block', 'mt-1', 'mt-2', 'text-[10px]', 'mx-auto', 'w-fit'); 
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î Font ‡πÉ‡∏´‡∏°‡πà (text-[12px])
    spouseTagEl.classList.add('text-[12px]');

    if (state.showSpouseLabel && m.gender === 'F') {
        const rel = m.relationship || "";
        const isConsort = rel.includes("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤") || rel.includes("‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤");

        if (!isConsort) {
            let husband = null;
            if (m.registeredSpouseId) {
                husband = state.members.find(x => x.id === m.registeredSpouseId);
            } else if (m.spouseIds && m.spouseIds.length > 0) {
                husband = m.spouseIds.map(sid => state.members.find(x => x.id === sid))
                                     .find(s => s && s.gender === 'M');
            }

            if (husband && husband.royalRank && !husband.isMonarch) {
                const hRank = husband.royalRank;
                const isRoyalHusband = hRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || 
                                       hRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || 
                                       hRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤');

                if (isRoyalHusband) {
                    const husbandName = getFullDisplayTitle(husband).split(' ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà')[0].trim();
                    
                    let prefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏ô";
                    const royalKeywords = ["‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤"];
                    
                    if (m.royalRank && royalKeywords.some(kw => m.royalRank.includes(kw))) {
                        prefix = "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤‡πÉ‡∏ô";
                    }

                    spouseTagEl.innerText = `${prefix} ${husbandName}`;

                    // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ---
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å royalRank ‡πÅ‡∏•‡∏∞ kromRank (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                    const hasKrom = (m.royalRank && (m.royalRank.includes("‡∏Å‡∏£‡∏°") || m.royalRank.includes("‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏°"))) || (m.kromRank && m.kromRank !== "");

                    if (hasKrom) {
                        // 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏°‡πÄ‡∏õ‡πá‡∏ô block ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á
                        if (kromTagEl) {
                            kromTagEl.classList.remove('inline-block');
                            kromTagEl.classList.add('block', 'mx-auto', 'w-fit');
                        }
                        // 2. ‡∏õ‡πâ‡∏≤‡∏¢‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (block) + ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (mt-2) + ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á (mx-auto)
                        spouseTagEl.classList.add('block', 'mt-2', 'w-fit', 'mx-auto');
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏° ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô inline-block ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
                        spouseTagEl.classList.add('inline-block', 'mt-1');
                    }

                    spouseTagEl.classList.remove('hidden'); 
                }
            }
        }
    }
}


// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showDetail(id)
const informalRow = document.getElementById('d_informalNameRow');
const informalDisplay = document.getElementById('d_informalNamesDisplay');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏≥‡∏•‡∏≠‡∏á (Informal Names) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if (m.informalNames && m.informalNames.trim() !== "") {
    let prefix = "";
    const r = m.royalRank || m.rank || ''; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®
    const rel = m.relationship || '';      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤)
    const tp = m.titlePrefix || '';        // (‡πÄ‡∏û‡∏¥‡πà‡∏°) ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ '‡∏ó‡πâ‡∏≤‡∏ß'
    const isMale = m.gender === 'M';

    // --- 1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (Royal Ranks) ---
    if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) {
        prefix = '‡∏ó‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°';
    } else if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
        prefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à';
    } else if (r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) {
        prefix = '‡πÄ‡∏™‡∏î‡πá‡∏à';
    } else if (r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
        prefix = isMale ? '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏ä‡∏≤‡∏¢' : '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) {
        prefix = isMale ? '‡∏ó‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢' : '‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå')) {
        prefix = isMale ? '‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢' : '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì';

    // --- 2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á (Noble Titles) ---
    } else if (r.includes('‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤')) {
        prefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤')) {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (r.includes('‡∏û‡∏£‡∏∞‡∏¢‡∏≤')) {
        prefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    } else if (r.includes('‡∏û‡∏£‡∏∞') || r.includes('‡∏à‡∏°‡∏∑‡πà‡∏ô')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞';
    } else if (r.includes('‡∏´‡∏•‡∏ß‡∏á')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏ß‡∏á';
    } else if (r.includes('‡∏Ç‡∏∏‡∏ô')) {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡∏Ç‡∏∏‡∏ô';
    } else if (r.includes('‡∏´‡∏°‡∏∑‡πà‡∏ô')) {
        prefix = '‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏∑‡πà‡∏ô';

    // --- 3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ù‡πà‡∏≤‡∏¢‡πÉ‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤) ---
    } else if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞') || r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°') || rel.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì')) {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì" ‡πÉ‡∏ô‡∏¢‡∏®‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ prefix ‡∏ô‡∏µ‡πâ
        prefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì';
    
    // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡∏ó‡πâ‡∏≤‡∏ß
    } else if (m.isTao || tp.startsWith('‡∏ó‡πâ‡∏≤‡∏ß')) {
        prefix = '‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß';

    } else if (r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') || rel.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') || rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°, ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤
        prefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°';
    } else if (r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°') || rel.includes('‡∏´‡∏°‡πà‡∏≠‡∏°')) { 
        prefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
    }

    // --- 4. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Badge ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô ---
    informalRow.classList.remove('hidden');
    informalDisplay.innerHTML = m.informalNames.split(',')
        .map(name => name.trim())
        .filter(name => name !== "")
        .map(name => `<span class="badge-informal">${prefix}${name}</span>`)
        .join('');
} else {
    informalRow.classList.add('hidden');
}


// === ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•) ===
const rowOrig = document.getElementById('row_original_surname');
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ID ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ HTML ‡πÄ‡∏õ‡πá‡∏ô div ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà table)
const labelOrig = document.getElementById('label_original_surname'); 
const displayOrig = document.getElementById('d_originalSurname');
const restoreBtn = document.getElementById('restoreRankArea');

const rowMarried = document.getElementById('row_married_surname');
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ID ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
const labelMarried = document.getElementById('label_married_surname'); 
const displayMarried = document.getElementById('d_marriedSurname');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
const currentRank = (m.royalRank || "").toString();
const relationType = (m.relationship || "").toString();
// (isCommoner ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö logic ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ)
const isCommoner = !m.royalRank || m.royalRank === "" || m.royalRank === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";

// ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤
const isForbidden = currentRank.includes("‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") || 
                    currentRank.includes("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤") ||
                    relationType.includes("‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") || 
                    relationType.includes("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤");

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏£‡∏™
const hasSpouse = (m.spouseIds && m.spouseIds.length > 0) || m.registeredSpouseId;

// --- 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏û‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà) ---
let originalSurnameText = "";
let isOriginalRoyal = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

// ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á, ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™, ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° ‡πÅ‡∏•‡∏∞ "‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠"
if (m.gender === 'F' && hasSpouse && !isForbidden && m.fatherId) {
    const father = state.members.find(x => x.id === m.fatherId);
    if (father) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ priority: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ royalSurname ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•
        if (father.royalSurname && father.royalSurname.trim() !== "") {
            originalSurnameText = father.royalSurname;
            isOriginalRoyal = true;
        } else {
            originalSurnameText = father.surname;
            isOriginalRoyal = false;
        }
    }
}

// ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°
if (originalSurnameText && originalSurnameText.trim() !== "") {
    // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (rowOrig) rowOrig.classList.remove('hidden');
    if (displayOrig) displayOrig.innerText = originalSurnameText;

    if (labelOrig) {
        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ isOriginalRoyal ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏ó‡∏ô isCommoner
        labelOrig.innerText = isOriginalRoyal ? "‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°" : "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°";
    }
} else {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (rowOrig) rowOrig.classList.add('hidden');
}

// --- 2. ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏® (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
if (m.gender === 'F' && m.isResigned) {
    if (restoreBtn) {
        restoreBtn.classList.remove('hidden');
        const b = restoreBtn.querySelector('button');
        if (b) b.setAttribute('data-id', m.id);
    }
} else {
    if (restoreBtn) restoreBtn.classList.add('hidden');
}

// --- 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà) ---
let shouldShowMarried = false;
let husbandSurnameText = "";
let isMarriedRoyal = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà

if (m.gender === 'F' && rowMarried && !isForbidden) {
    // ‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏à‡∏≤‡∏Å registeredSpouseId ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å)
    let spouseId = m.registeredSpouseId;
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ registeredSpouseId ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å spouseIds ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢
    if (!spouseId && m.spouseIds && m.spouseIds.length > 0) {
        const maleSpouse = m.spouseIds
            .map(id => state.members.find(x => x.id === id))
            .find(s => s && s.gender === 'M'); // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢
        if (maleSpouse) spouseId = maleSpouse.id;
    }

    if (spouseId) {
        const husband = state.members.find(x => x.id === spouseId);
        if (husband) {
             // ‡πÄ‡∏ä‡πá‡∏Ñ priority: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ royalSurname ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•
            if (husband.royalSurname && husband.royalSurname.trim() !== "") {
                husbandSurnameText = husband.royalSurname;
                isMarriedRoyal = true;
                shouldShowMarried = true;
            } else if (husband.surname && husband.surname.trim() !== "") {
                husbandSurnameText = husband.surname;
                isMarriedRoyal = false;
                shouldShowMarried = true;
            }
        }
    }
}

// ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™
if (shouldShowMarried) {
    if (rowMarried) rowMarried.classList.remove('hidden');
    if (displayMarried) displayMarried.innerText = husbandSurnameText;
    if (labelMarried) {
         // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ isMarriedRoyal ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏ó‡∏ô isCommoner
        labelMarried.innerText = isMarriedRoyal ? "‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™" : "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏°‡∏£‡∏™";
    }
} else {
    if (rowMarried) rowMarried.classList.add('hidden');
    if (displayMarried) displayMarried.innerText = "";
}
    
// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡∏Å‡∏£‡∏° (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢) ---
const kromNameRow = document.getElementById('d_kromFullNameRow');
const kromFullNameEl = document.getElementById('d_kromFullName');

if (m.kromRank && m.kromTitle) {
    let prefix = m.titlePrefix || "";
    let isariyayot = "";
    let suffix = m.titleSuffix || ""; 
    
    if (m.royalRank && m.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        isariyayot = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
    }

    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Row: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å '‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤' ‡πÄ‡∏õ‡πá‡∏ô '‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á'
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
    kromNameRow.classList.remove('justify-between', 'items-center');
    kromNameRow.classList.add('flex-col', 'items-start');

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: ‡∏•‡∏ö‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢
    kromFullNameEl.classList.remove('text-right');
    kromFullNameEl.classList.add('text-left', 'w-full', 'mt-1', 'leading-normal');

    // 3. ‡∏£‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Single String)
    // ‡πÉ‡∏ä‡πâ .trim().replace(/\s+/g, ' ') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    let fullNameByKrom = `${prefix} ${isariyayot}${m.kromRank}${m.kromTitle} ${suffix}`.trim().replace(/\s+/g, ' ');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô
    kromFullNameEl.innerText = fullNameByKrom;
    
    kromNameRow.classList.remove('hidden');
} else {
    kromNameRow.classList.add('hidden');
}
// -------------------------------------------


// --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏¢‡∏®‡∏™‡∏π‡∏á + ‡∏ä‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏ç‡∏¥‡∏á‡πÇ‡∏™‡∏î) ---
    const rowRoyalSurname = document.getElementById('row_royal_surname'); 
    const displayRoyalSurname = document.getElementById('d_royalSurname');
    
    if (rowRoyalSurname && displayRoyalSurname) {
        const r = m.royalRank || "";
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏®: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤, ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        const isHighRank = r.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || r.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") || r.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤");

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏£‡∏™ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
        const hasSpouse = (Array.isArray(m.spouseIds) && m.spouseIds.length > 0) || (m.spouseId && m.spouseId !== "");

        // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        let shouldShow = false;

        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏®‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÅ‡∏•‡∏∞ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏®
        if (isHighRank && m.royalSurname && m.royalSurname.trim() !== "") {
            if (m.gender === 'M' && !m.isMonarch) {
                // ‡∏ä‡∏≤‡∏¢: ‡∏°‡∏µ‡∏¢‡∏® + ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå -> ‡πÅ‡∏™‡∏î‡∏á
                shouldShow = true;
            } else if (m.gender === 'F' && !hasSpouse) {
                // ‡∏´‡∏ç‡∏¥‡∏á: ‡∏°‡∏µ‡∏¢‡∏® + ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô -> ‡πÅ‡∏™‡∏î‡∏á
                shouldShow = true;
            }
        }

        // 4. ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô
        if (shouldShow) {
             displayRoyalSurname.innerText = m.royalSurname;
             rowRoyalSurname.classList.remove('hidden');
        } else {
             rowRoyalSurname.classList.add('hidden');
        }
    }





    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® actionsContainer ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ---
    const actionsContainer = document.querySelector('#detailModal .flex.gap-2.justify-center.border-t');
    
    const btnPromote = document.getElementById('btnPromoteNobility');
    if (btnPromote) {
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å p ‡πÄ‡∏õ‡πá‡∏ô m ---
        if (m.relationship === '‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á') { 
            btnPromote.classList.remove('hidden');
        } else {
            btnPromote.classList.add('hidden');
        }
    }
        

      const nicknameDisplay = getNicknameWithPrefix(m);
document.getElementById('d_nickname_display').innerText = nicknameDisplay;
document.getElementById('d_nickname_container').classList.toggle('hidden', !m.nickname);


        
// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏® ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)" ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    document.getElementById('d_royalRankDetail').innerText = m.royalRank || "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";

   // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï) ---
    const btnPromoteMC = document.getElementById('btnPromoteMC');
    if (m.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') {
        btnPromoteMC.classList.remove('hidden');
    } else {
        btnPromoteMC.classList.add('hidden');
    }

    // --- ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3846 ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
const oldCoronationBtn = document.getElementById('btnCoronation');
if (oldCoronationBtn) oldCoronationBtn.remove(); // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

// ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå, ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï, ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å (isCoronated ‡πÄ‡∏õ‡πá‡∏ô false)
if (m.isMonarch && m.isAlive && !m.isExMonarch && !m.isCoronated) {
    const crownBtn = document.createElement('button');
    crownBtn.id = 'btnCoronation';
    crownBtn.onclick = performCoronation; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å
    // ‡πÉ‡∏ä‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ó‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô bounce ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ
    crownBtn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-amber-500 border-2 border-amber-300 bg-amber-50 animate-bounce";
    crownBtn.title = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏¥‡∏ò‡∏µ‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å";
    crownBtn.innerHTML = '<i class="fa-solid fa-crown"></i>'; // ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏°‡∏á‡∏Å‡∏∏‡∏é
    actionsContainer.prepend(crownBtn); // ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏°
}
    // ------------------------------------------------------------------

// ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡πÉ‡∏ô showDetail(id) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (actionsContainer)
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

const currentPerson = m; // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
const registeredSpouse = state.members.find(s => s.id === currentPerson.registeredSpouseId);

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡πä‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥ ---
// ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
const oldWorachayaBtn = document.getElementById('btnPromoteWorachaya');
if (oldWorachayaBtn) oldWorachayaBtn.remove();
const oldWorasamiBtn = document.getElementById('btnPromoteWorasami');
if (oldWorasamiBtn) oldWorasamiBtn.remove();

if (currentPerson.royalRank === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" && registeredSpouse) {
    // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á "‡∏°‡∏´‡∏≤‡∏°‡∏Å‡∏∏‡∏è‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£" (‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢)
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ gender === 'M' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏∏‡∏ì
    const isCrownPrince = registeredSpouse.isHeir && parseInt(registeredSpouse.heirOrder) === 1 && registeredSpouse.gender === 'M';
    
    // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤"
    const isRoyalDaughter = registeredSpouse.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤";

    if (isCrownPrince) {
        const btn = document.createElement('button');
        btn.id = 'btnPromoteWorachaya'; // ‡πÉ‡∏™‡πà ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°
        btn.onclick = () => {
            promoteToPhraWorachaya(currentPerson.id);
            btn.remove(); // ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        };
        btn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-amber-600 border-2 border-amber-200 bg-amber-50 rounded-full hover:bg-amber-100 transition-colors";
        btn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤";
        btn.innerHTML = '<i class="fa-solid fa-crown"></i>';
        actionsContainer.append(btn);
    } 
    else if (isRoyalDaughter) {
        const btn = document.createElement('button');
        btn.id = 'btnPromoteWorasami'; // ‡πÉ‡∏™‡πà ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°
        btn.onclick = () => {
            promoteToPhraWorasami(currentPerson.id);
            btn.remove(); // ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        };
        btn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-blue-600 border-2 border-blue-200 bg-blue-50 rounded-full hover:bg-blue-100 transition-colors";
        btn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ";
        btn.innerHTML = '<i class="fa-solid fa-user-shield"></i>';
        actionsContainer.append(btn);
    }
}

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å (‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ) ---
    const oldPrabBtn = document.getElementById('btnPrabdaphisek');
    if (oldPrabBtn) oldPrabBtn.remove();
    
    const isFirstPerson = state.members.length > 0 && m.id === state.members[0].id;
    const noMonarchYet = !state.members.some(p => p.isMonarch);

    if (isFirstPerson && noMonarchYet && m.isAlive) {
        const prabBtn = document.createElement('button');
        prabBtn.id = 'btnPrabdaphisek';
        prabBtn.onclick = () => {
            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏≤‡∏ö‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å ${m.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏ê‡∏°‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå?`)) {
                openReignNameSelectionModal(m.id);
            }
        };
        prabBtn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-red-600 border-2 border-red-200 bg-red-50 animate-pulse";
        prabBtn.title = "‡∏õ‡∏£‡∏≤‡∏ö‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå";
        prabBtn.innerHTML = '<i class="fa-solid fa-bolt-lightning"></i>';
        actionsContainer.prepend(prabBtn);
    }
    // ------------------------------------------------------------------
        
        // Find and replace the onclick handler for the "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" button
        const addSpouseButton = document.querySelector('#detailModal button[onclick^="openSpouseSelectionModal"]');
        if (addSpouseButton) {
             addSpouseButton.onclick = () => openSpouseSelectionModal(window.curPID);
        } else {
             // Fallback/Safety Check: Ensure the button uses the correct function in the HTML
        }
        
        // Control Abdicate Button
        const btnAbdicate = document.getElementById('btnAbdicate');
        const btnDeath = document.getElementById('btnDeath');
        const activeMonarch = state.members.find(p => p.isMonarch && p.isAlive && !p.isExMonarch);

        // --- ‡πÅ‡∏ó‡∏£‡∏Å Code ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ---
const oldLanTherBtn = document.getElementById('btnPromoteLanTher');
if (oldLanTherBtn) oldLanTherBtn.remove(); // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤

if (m && activeMonarch) {
    // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    const checkRel = isDirectDescendant(activeMonarch.id, m.id);
    
    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á + ‡∏°‡∏µ‡∏¢‡∏®‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
    if (checkRel.isGrandchild && m.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') {
        const promoteBtn = document.createElement('button');
        promoteBtn.id = 'btnPromoteLanTher';
        promoteBtn.onclick = promoteToPhraOngChaoLanTher;
        promoteBtn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-blue-600 border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition-all";
        promoteBtn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤";
        promoteBtn.innerHTML = '<i class="fa-solid fa-award"></i>';
        
        // ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≤‡∏¢
        const btnDeath = document.getElementById('btnDeath');
        actionsContainer.insertBefore(promoteBtn, btnDeath);
    }
}
// -----------------------

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ç‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 1 (‡∏û‡πà‡∏≠ ‡πÅ‡∏°‡πà ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á) ---
    const oldFoundingBtn = document.getElementById('btnPromoteFoundingFamily');
    if (oldFoundingBtn) oldFoundingBtn.remove();
    const oldSiblingSpouseBtn = document.getElementById('btnPromoteSiblingSpouse');
    if (oldSiblingSpouseBtn) oldSiblingSpouseBtn.remove();
    const oldSiblingChildBtn = document.getElementById('btnPromoteSiblingChild');
    if (oldSiblingChildBtn) oldSiblingChildBtn.remove();

    if (activeMonarch && activeMonarch.globalReignNumber == 1 && m.id !== activeMonarch.id && m.isAlive) {
        // ‡∏Å. ‡∏û‡πà‡∏≠ ‡πÅ‡∏°‡πà ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)
        const isParent = (m.id === activeMonarch.fatherId || m.id === activeMonarch.motherId);
        const isSibling = (m.fatherId === activeMonarch.fatherId || m.motherId === activeMonarch.motherId);
        
        if ((isParent || isSibling) && m.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
            const fBtn = document.createElement('button');
            fBtn.id = 'btnPromoteFoundingFamily';
            fBtn.onclick = () => promoteFoundingFamily(m.id, activeMonarch.id);
            fBtn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-amber-600 border-2 border-amber-300 bg-amber-50";
            fBtn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÅ‡∏£‡∏Å)";
            fBtn.innerHTML = '<i class="fa-solid fa-crown"></i>';
            actionsContainer.append(fBtn);
        }

       

        // ‡∏Ñ. ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á (‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤)
        const father = state.members.find(f => f.id === m.fatherId);
        const mother = state.members.find(mo => mo.id === m.motherId);
        const isChildOfSibling = (father && (father.fatherId === activeMonarch.fatherId || father.motherId === activeMonarch.motherId)) || 
                                 (mother && (mother.fatherId === activeMonarch.fatherId || mother.motherId === activeMonarch.motherId));
        
        if (isChildOfSibling && m.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
            const scBtn = document.createElement('button');
            scBtn.id = 'btnPromoteSiblingChild';
            scBtn.onclick = () => promoteSiblingChild(m.id, activeMonarch.id);
            scBtn.className = "btn-icon w-10 h-10 flex items-center justify-center text-blue-500 border-2 border-blue-200 bg-blue-50";
            scBtn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á";
            scBtn.innerHTML = '<i class="fa-solid fa-star"></i>';
            actionsContainer.append(scBtn);
        }
    }
    // ------------------------------------------------------------------

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô actionsContainer ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showDetail
const oldPhakkhaniBtn = document.getElementById('btnPromotePhakkhani');
if (oldPhakkhaniBtn) oldPhakkhaniBtn.remove();

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á/‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 1 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const spouses = (m.spouseIds || []).map(sid => state.members.find(s => s.id === sid));
const isRoyalSisterSpouse = m.gender === 'M' && m.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && spouses.some(s => 
    s && (s.titlePrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") || s.titlePrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"))
);

if (isRoyalSisterSpouse) {
    const btn = document.createElement('button');
    btn.id = 'btnPromotePhakkhani';
    btn.onclick = () => { promoteToPhakkhaniPati(m.id); };
    btn.className = "btn-icon w-10 h-10 flex items-center justify-center text-lg text-indigo-600 border-2 border-indigo-200 bg-indigo-50 rounded-full hover:bg-indigo-100 transition-colors";
    btn.title = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠";
    btn.innerHTML = '<i class="fa-solid fa-user-tie"></i>';
    actionsContainer.append(btn);
}



        // MODIFICATION (Rule 1 & 2): Show 4 buttons for active monarch
        const isActiveMonarch = m.isMonarch && m.isAlive && !m.isExMonarch && m.id === activeMonarch?.id;

        if (isActiveMonarch) {
            btnAbdicate.classList.remove('hidden');
            btnDeath.classList.remove('hidden'); // <-- Keep Death button visible
        } else {
            btnAbdicate.classList.add('hidden');
            btnDeath.classList.remove('hidden');
        }
        
        document.getElementById('d_img').src = m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
        document.getElementById('d_name').innerText = getFullDisplayTitle(m);
        document.getElementById('d_id').innerText = m.id;
        const kromEl = document.getElementById('d_krom');
        
        const isHighRoyalTitle = isActiveMonarch || (m.isHeir && parseInt(m.heirOrder) === 1);
        if(m.kromRank && m.kromTitle && !isHighRoyalTitle) { 
            kromEl.innerText = `${m.kromRank}${m.kromTitle}`; 
            kromEl.classList.remove('hidden'); 
        } else { 
            kromEl.classList.add('hidden'); 
        }
        
     const badgesContainer = document.getElementById('d_badges'); 
   badgesContainer.innerHTML = '';
        
  // --- 1. ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á) ---
    if (m.isMonarch && m.isExMonarch && m.isAlive) { 
         const reignNum = m.globalReignNumber ? `‡∏£. ${toThaiNumerals(m.globalReignNumber)}` : '';
         const b = document.createElement('div');
         b.className = "bg-purple-100 text-purple-800 border border-purple-300 px-3 py-1 rounded-full text-xs font-bold";
         b.innerText = `‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignNum}`; 
         badgesContainer.appendChild(b);
    }

    // --- 7. ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà.. (‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ ---
    if (m.isMonarch && m.globalReignNumber) {
        const b = document.createElement('div');
        b.className = "bg-sky-100 text-sky-800 border border-sky-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}`;
        badgesContainer.appendChild(b);
    }

    // --- 2. ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) ---
    if (m.isMonarch && m.useReignName && m.reignNameBase) {
        let reignTxt = m.reignNameBase;
        const autoNum = getReignNameRank(m);
        if(autoNum) reignTxt += `‡∏ó‡∏µ‡πà ${toThaiNumerals(autoNum)}`;
        
        const b = document.createElement('div');
        b.className = "bg-yellow-100 text-yellow-800 border border-yellow-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = reignTxt; 
        badgesContainer.appendChild(b);
    }
    
    // --- 3. ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ / ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤ ---
    if (m.relationship === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ") {
        const b = document.createElement('div');
        b.className = "bg-indigo-100 text-indigo-800 border border-indigo-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ"; 
        badgesContainer.appendChild(b);
    }
    else if (m.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") {
        const b = document.createElement('div');
        b.className = "bg-pink-100 text-pink-800 border border-pink-300 px-3 py-1 rounded-full text-xs font-bold shadow-[0_0_10px_rgba(244,114,182,0.5)]";
        b.innerText = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤"; 
        badgesContainer.appendChild(b);
    }


    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 5: ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå ---
    if (m.isPhraKulachet) {
        const b = document.createElement('div');
        b.className = "badge-kulachet"; 
        b.innerHTML = `<i class="fa-solid fa-star"></i> ‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå `;
        badgesContainer.appendChild(b);
    }

    // --- 8. ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ / ‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ ---
    if (m.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") {
        const b = document.createElement('div');
        b.className = "bg-emerald-100 text-emerald-800 border border-emerald-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏• (‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤)";
        badgesContainer.appendChild(b);
    } else if (m.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á") {
        const b = document.createElement('div');
        b.className = "bg-orange-100 text-orange-800 border border-orange-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç (‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á)";
        badgesContainer.appendChild(b);
    }

    // --- 4. ‡∏õ‡πâ‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå / ‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå (‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π) ---
    if (m.isThroneConsort || m.isQueenConsort) {
        const b = document.createElement('div');
        b.className = "bg-pink-100 text-pink-800 border border-pink-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = "‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå"; 
        badgesContainer.appendChild(b);
    }

   // --- 5. ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤ (‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô) ---
    const prefix = m.titlePrefix || "";
    const suffix = m.titleSuffix || "";
    const isQueenConsort = m.isQueenConsort || false; 
    let consortGroup = "";

    const akkhraSuffixes = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
    const mahesiSuffixes = ["‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];

    if (isQueenConsort) {
        consortGroup = "‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    } 
    else if (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ" || (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && akkhraSuffixes.includes(suffix))) {
        consortGroup = "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    } 
    else if (
        prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" || 
        prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" || 
        (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && mahesiSuffixes.includes(suffix)) ||
        (prefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" && suffix === "‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ") ||
        (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è" && (suffix === "‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ" || suffix === "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) ||
        (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤" && (suffix === "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ" || suffix === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"))
    ) {
        consortGroup = "‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ";
    } 
    else if (prefix === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") {
        consortGroup = "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
    } 
    else if (["‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"].includes(prefix)) {
        consortGroup = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤";
    }
        
    if (m.relationship === "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤") {
        if (["‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞", "‡∏ó‡πâ‡∏≤‡∏ß", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå"].includes(prefix)) {
            consortGroup = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å";
        }
        else if (["‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°"].includes(prefix)) {
            consortGroup = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°";
        }
    }

    if (consortGroup) {
        const b = document.createElement('div');
        b.className = "bg-purple-50 text-purple-600 border border-purple-200 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = consortGroup;
        badgesContainer.appendChild(b);
    }

// --- 6. ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞ ‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ (‡∏™‡∏µ‡∏ü‡πâ‡∏≤) ---
    let parentGroup = "";

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏£‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á")
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ m.titleSuffix ‡πÅ‡∏ó‡∏ô m.suffix
    const fullTitleToCheck = (prefix + (m.name || "") + (m.titleSuffix || "")).toString();
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏£‡∏°" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasBorom = fullTitleToCheck.includes("‡∏ö‡∏£‡∏°");

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasPhanPi = fullTitleToCheck.includes("‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á");

    if (m.relationship === "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏Å") {
        if (hasBorom) {
            parentGroup = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å";
        } else {
            parentGroup = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å";
        }
    } 
    else if (m.relationship === "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ") {
        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (prefix.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤‡πÄ‡∏ò‡∏≠")) {
            parentGroup = "‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤";
        } 
        // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ flag ‡πÄ‡∏î‡∏¥‡∏°)
        else if (hasPhanPi || m.isThroneConsort || m.isQueenConsort) {
            if (hasBorom) {
                parentGroup = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á";
            } else {
                parentGroup = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á";
            }
        } 
        // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        else {
            if (hasBorom) {
                parentGroup = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ";
            } else {
                parentGroup = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ";
            }
        }
    }

    if (parentGroup) {
        const b = document.createElement('div');
        b.className = "bg-blue-100 text-blue-800 border border-blue-300 px-3 py-1 rounded-full text-xs font-bold shadow-sm";
        b.innerText = parentGroup;
        badgesContainer.appendChild(b);
    }

    // --- 6. ‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó (‡∏™‡∏µ‡πÅ‡∏î‡∏á) ---
    if (m.isHeir) {
        const b = document.createElement('div');
        b.className = "bg-red-100 text-red-800 border border-red-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = `‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${toThaiNumerals(m.heirOrder)}`; 
        badgesContainer.appendChild(b);
    }
        
    // --- 9. DETAIL MODAL: Show Surname ONLY for the Founder (Per user request) ---
    if (m.isRoyalSurnameFounder && m.royalSurname) {
        const b = document.createElement('div');
        b.className = "bg-indigo-100 text-indigo-800 border border-indigo-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = `‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• ${m.royalSurname}`; 
        badgesContainer.appendChild(b);
    }
        // --- END DETAIL MODAL SURNAME ---

        const dTerm = m.isAlive ? "‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" : getDeathTerm(m);
        document.getElementById('d_status').innerHTML = m.isAlive ? `<span class="text-emerald-600">${dTerm}</span>` : `<span class="text-slate-500">${dTerm}</span>`;
        
       // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ---
const thaiMonthsFull = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
let fullBirthDate = "-";

if (m.birthYear) {
    const dowPart = m.birthDayOfWeek ? `‡∏ß‡∏±‡∏ô${m.birthDayOfWeek} ` : "";
    const dayPart = m.birthDay ? `‡∏ó‡∏µ‡πà ${toThaiNumerals(m.birthDay)} ` : "";
    const monthPart = m.birthMonth ? `${thaiMonthsFull[parseInt(m.birthMonth) - 1]} ` : "";
    const yearPart = toThaiNumerals(m.birthYear);
    
    fullBirthDate = `${dowPart}${dayPart}${monthPart}${yearPart}`;
}


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤/‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏°‡πÄ‡∏™‡∏°‡∏≠) ---
const rowAffiliation = document.getElementById('row_affiliation');
const dAffiliationName = document.getElementById('d_affiliationName');

if (rowAffiliation && dAffiliationName) {
    if (m.affiliationId) {
        const master = state.members.find(x => x.id === m.affiliationId);
        if (master) {
            let affiliationText = "";
            const isHideRank = master.hideRank === true;

            // [1] ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
            if (master.relationship === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
                affiliationText = getFullDisplayTitle(master);
            } 
            else {
                // [2] ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
                let prefix = (master.titlePrefix || "").trim();
                const rank = (master.royalRank || "").trim();
                const name = (master.name || "").trim();
                const suffix = (master.titleSuffix || "").trim();
                const kRank = (master.kromRank && master.kromRank !== "‡πÑ‡∏°‡πà‡∏°‡∏µ") ? master.kromRank : "";
                const kTitle = (master.kromTitle || "").trim();
                const hasKrom = kRank !== "" && kTitle !== "";

                // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏î (Attached Prefix)
                const attachedPrefixList = [
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏®‡∏£‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤",
                    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è",
                    "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏®‡∏£‡∏µ"
                ];

                const isAttached = attachedPrefixList.includes(prefix);
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°)
                let targetContent = hasKrom ? (kRank + kTitle) : name;

                if (isAttached) {
                    // ‡∏Å‡∏é: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Ç‡πâ‡∏≤‡∏°‡∏¢‡∏®‡∏Å‡∏•‡∏≤‡∏á)
                    affiliationText = prefix + targetContent;
                } else {
                    // ‡∏Å‡∏é: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©
                    let rankPart = "";
                    if (!isHideRank) {
                        if (rank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                            rankPart = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤"; // ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô)
                        } else if (rank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") && !hasKrom) {
                            rankPart = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤"; // ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏°)
                        }
                    }
                    
                    // ‡∏ï‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ + (‡∏¢‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠/‡∏Å‡∏£‡∏°)
                    // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏®‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏¢‡∏®‡∏Å‡∏£‡∏°" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                    affiliationText = (prefix ? prefix + " " : "") + rankPart + targetContent;
                }

                // ‡∏ï‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
                if (suffix) {
                    affiliationText += " " + suffix;
                }
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• HTML: ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ, ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏°‡πà‡∏ß‡∏á, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ
            dAffiliationName.innerHTML = `
                <span class="text-purple-700 hover:text-purple-900 hover:bg-purple-100 px-1.5 py-0.5 rounded-md cursor-pointer transition-all duration-200 inline-block" 
                      onclick="showDetail('${master.id}')">
                    ${affiliationText.trim()}
                </span>`;
            
            rowAffiliation.classList.remove('hidden');
        } else {
            rowAffiliation.classList.add('hidden');
        }
    } else {
        rowAffiliation.classList.add('hidden');
    }
}


document.getElementById('d_birthYear').innerText = fullBirthDate;
// ---------------------------------------



// --- 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô "‡∏â‡∏±‡∏ï‡∏£" (‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß) ---
const rowUmbrella = document.getElementById('row_umbrella');
const dUmbrella = document.getElementById('d_umbrella');

if (rowUmbrella && dUmbrella) {
    if (m.hasUmbrella && m.umbrellaType && m.umbrellaType !== "-") {
        dUmbrella.innerText = m.umbrellaType;
        rowUmbrella.classList.remove('hidden');
    } else {
        rowUmbrella.classList.add('hidden');
    }
}

       // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏ô‡∏≤‡∏° ---
      // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ---
// --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏ô‡∏≤‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ---
let spouseHTML = ""; 
const spouseList = (m.spouseIds || []).map(sid => state.members.find(x => x.id === sid)).filter(s => s);

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢)
const blueNum = (num) => `<span class="text-blue-600 font-bold">${toThaiNumerals(num)}</span>`;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
const createSpouseRow = (label, count, unit, categoryKey) => {
    const labelSpan = label ? `<span class="text-gray-600 font-semibold text-sm">${label} </span>` : '';
    const modalLabel = label || "‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™";

    return `<div class="cursor-pointer hover:bg-indigo-50 px-2 py-0.5 rounded transition-all text-right group border-b border-slate-50 last:border-0" 
                  onclick="openSpouseListModal('${m.id}', '${categoryKey}', '${modalLabel}')">
                ${labelSpan}
                ${blueNum(count)} 
                <span class="text-gray-600 font-semibold text-sm">${unit}</span>
            </div>`;
};

if (spouseList.length > 0) {
    let parts = [];
    
    // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
    if (m.isMonarch) {
        if (m.gender === 'F') {
            parts.push(createSpouseRow("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", spouseList.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ"));
        } else {
            const titledFemales = spouseList.filter(s => s.gender === 'F' && (s.isMonarch || (s.royalRank && !['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(s.royalRank))));
            const commonFemales = spouseList.filter(s => s.gender === 'F' && !titledFemales.includes(s));
            const maleSpouses = spouseList.filter(s => s.gender === 'M');
            
            if (maleSpouses.length > 0) parts.push(createSpouseRow("‡∏û‡∏£‡∏∞‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", maleSpouses.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "‡∏û‡∏£‡∏∞‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ"));
            if (titledFemales.length > 0) parts.push(createSpouseRow("‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", titledFemales.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤"));
            if (commonFemales.length > 0) parts.push(createSpouseRow("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", commonFemales.length, "‡∏Ñ‡∏ô", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤"));
        }
    } 
    // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤, ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏≤‡∏¢)
    else if (m.gender === 'M' && m.royalRank && (m.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || m.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || m.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) {
        const titledF = spouseList.filter(s => s.gender === 'F' && s.royalRank && !['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(s.royalRank));
        const commonF = spouseList.filter(s => s.gender === 'F' && !titledF.includes(s));
        const labelT = (m.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') ? "‡∏ä‡∏≤‡∏¢‡∏≤" : "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤";
        
        if (titledF.length > 0) parts.push(createSpouseRow(labelT, titledF.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "royal_wife")); 
        if (commonF.length > 0) parts.push(createSpouseRow("‡∏´‡∏°‡πà‡∏≠‡∏°", commonF.length, "‡∏Ñ‡∏ô", "common_wife")); 
    } 
    // 3. ‡∏Å‡∏£‡∏ì‡∏µ ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå ‡∏•‡∏á‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏ä‡∏≤‡∏¢)
    else if (m.gender === 'M') {
        parts.push(createSpouseRow("‡∏†‡∏£‡∏£‡∏¢‡∏≤", spouseList.length, "‡∏Ñ‡∏ô", "wife"));
    }
    // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    else {
        const titledAny = spouseList.filter(s => s.isMonarch || (s.royalRank && !['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(s.royalRank)));
        const commonAny = spouseList.filter(s => !titledAny.includes(s));
        
        if (m.gender === 'F') {
            if (titledAny.length > 0) parts.push(createSpouseRow("‡∏û‡∏£‡∏∞‡∏†‡∏±‡∏™‡∏î‡∏≤", titledAny.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "titled_husband"));
            if (commonAny.length > 0) parts.push(createSpouseRow("‡∏†‡∏±‡∏™‡∏î‡∏≤", commonAny.length, "‡∏Ñ‡∏ô", "common_husband"));
        } else {
            if (titledAny.length > 0) parts.push(createSpouseRow("", titledAny.length, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå", "titled_any"));
            if (commonAny.length > 0) parts.push(createSpouseRow("", commonAny.length, "‡∏Ñ‡∏ô", "common_any"));
        }
    }
    
    spouseHTML = parts.length > 0 ? parts.join("") : "-"; 
} else {
    spouseHTML = "-";
}

const spouseEl = document.getElementById('d_spouses_count');
spouseEl.innerHTML = spouseHTML; 
spouseEl.className = "font-bold text-right text-slate-700 leading-tight text-sm py-1";

const spouseRow = spouseEl.parentElement;
if (spouseRow) {
    spouseRow.classList.remove('items-center');
    spouseRow.classList.add('items-start');
}
// -------------------------------------------------------------------------
// --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏Ç‡∏ä‡∏±‡πâ‡∏ô (‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∏) ---
    const genRankText = formatRoyalRankWithGen(m);
    const rowEl = document.getElementById('d_generationRankRow');
    const textEl = document.getElementById('d_generationRank');

    if (genRankText) {
        textEl.innerText = genRankText; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        rowEl.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤
    } else {
        rowEl.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏°.‡∏£.‡∏ß., ‡∏°.‡∏´‡∏•‡∏ß‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    }
        


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡∏ö‡∏∏‡∏ï‡∏£/‡∏ò‡∏¥‡∏î‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ) ---
const children = state.members.filter(c => c.fatherId === m.id || c.motherId === m.id);
const childrenRow = document.getElementById('d_children_row');
const childrenList = document.getElementById('d_children_list');

if (children.length > 0) {
    const sons = children.filter(c => c.gender === 'M').length;
    const daughters = children.filter(c => c.gender === 'F').length;
    const total = children.length;

    let sonTerm = "‡∏ö‡∏∏‡∏ï‡∏£", daughterTerm = "‡∏ò‡∏¥‡∏î‡∏≤", unitTerm = "‡∏Ñ‡∏ô";

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
    const hasMonarchSpouse = (m.spouseIds || []).some(sid => {
        const spouse = state.members.find(x => x.id === sid);
        return spouse && spouse.isMonarch;
    });

    // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™/‡∏ò‡∏¥‡∏î‡∏≤"
    if (m.isMonarch || hasMonarchSpouse) {
        sonTerm = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™"; 
        daughterTerm = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤"; 
        unitTerm = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå";
    } else if (m.royalRank && (m.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || m.royalRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤"))) {
        sonTerm = "‡∏û‡∏£‡∏∞‡πÇ‡∏≠‡∏£‡∏™"; 
        daughterTerm = "‡∏û‡∏£‡∏∞‡∏ò‡∏¥‡∏î‡∏≤"; 
        unitTerm = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå";
    }

    let childHtml = "";
    const bNum = (n) => `<span class="text-indigo-600 font-bold">${toThaiNumerals(n)}</span>`;

    // 1. ‡πÅ‡∏ñ‡∏ß‡∏û‡∏£‡∏∞‡πÇ‡∏≠‡∏£‡∏™/‡∏û‡∏£‡∏∞‡∏ò‡∏¥‡∏î‡∏≤: ‡πÄ‡∏û‡∏¥‡πà‡∏° onclick ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Pop-up ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
    if (sons > 0) {
        childHtml += `
            <div class="text-sm font-bold text-slate-700 cursor-pointer hover:bg-indigo-50 p-1 rounded transition-all" 
                 onclick="openChildrenListModal('${m.id}', 'M', '${sonTerm}')">
                ${sonTerm} ${bNum(sons)} ${unitTerm} 
                <i class="fa-solid fa-chevron-right text-[10px] text-slate-300 ml-1"></i>
            </div>`;
    }
    if (daughters > 0) {
        childHtml += `
            <div class="text-sm font-bold text-slate-700 cursor-pointer hover:bg-indigo-50 p-1 rounded transition-all" 
                 onclick="openChildrenListModal('${m.id}', 'F', '${daughterTerm}')">
                ${daughterTerm} ${bNum(daughters)} ${unitTerm}
                <i class="fa-solid fa-chevron-right text-[10px] text-slate-300 ml-1"></i>
            </div>`;
    }
    
    // 2. ‡πÅ‡∏ñ‡∏ß‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô
    childHtml += `<div class="text-[11px] font-medium text-slate-500 border-t border-slate-100 pt-1 mt-1">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${bNum(total)} ${unitTerm}</div>`;

    childrenList.innerHTML = childHtml;
    childrenRow.classList.remove('hidden');
} else {
    childrenRow.classList.add('hidden');
}


      // ‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
        updateLiveAgeDisplay();  
        

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÄ‡∏õ‡πá‡∏ô ‡∏î‡∏π) ---
    const btnParents = document.getElementById('btnManageParents');
    if (btnParents) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡πà‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (m.fatherId || m.motherId) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π" (‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô) ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà
            btnParents.innerHTML = '<i class="fa-solid fa-users"></i> ‡∏î‡∏π‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤';
            btnParents.className = "w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2";
            btnParents.onclick = () => viewParents(m.id);
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°" (‡∏™‡∏µ‡∏™‡πâ‡∏°/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            btnParents.innerHTML = '<i class="fa-solid fa-arrow-up"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤/‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤';
            btnParents.className = "w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2";
            btnParents.onclick = () => openAddParentModal(m.id);
        }
    }
    // -------------------------------------------------------------



        state.viewRootId = id; 
        document.getElementById('detailModal').classList.add('active');
    }
    

    // ================= END NEW SPOUSE SELECTION MODAL LOGIC =================
   // ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <script>
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ç‡∏ì‡∏∞‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ê‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏µ‡∏û
 */

if (m.destiny) {
    const b = document.createElement('div');
    b.className = `mt-2 p-2 rounded-xl bg-white border text-[10px] ${m.destiny.color}`;
    b.innerHTML = `<b>${m.destiny.icon} ‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï: ${m.destiny.label}</b>`;
    badgesContainer.appendChild(b);



    
}



function recordTitleHistory(p) {
    if (!p.titleHistory) p.titleHistory = [];
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤) ---
    
    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
    let activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);

    // 2. [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (p) ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? 
    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å p ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Å‡∏£‡∏≠‡∏Å) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô state
    if (p.isMonarch && p.isAlive && !p.isExMonarch) {
        activeMonarch = p;
    }

    const currentReign = activeMonarch && activeMonarch.globalReignNumber 
        ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(activeMonarch.globalReignNumber)}` 
        : "‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•/‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå";
    
    // --------------------------------

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    const currentDataSignature = [
        p.relationship,
        p.titlePrefix,
        p.royalRank,
        p.name,
        p.titleSuffix,
        p.kromRank,
        p.kromTitle,
        p.isExMonarch,        
        p.monarchSpouseContext,
        // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß ---
        p.isTao,
        p.taoTitle
        // ------------------------------------------------
    ].join('|');
    
    const lastEntry = p.titleHistory[p.titleHistory.length - 1];
    const lastSignature = lastEntry ? lastEntry.signature : null;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    if (currentDataSignature !== lastSignature) {
        const fullTitle = getFullDisplayTitle(p);
        p.titleHistory.push({ 
            title: fullTitle, 
            rank: p.royalRank, 
            reign: currentReign, // ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            year: new Date().getFullYear() + 543,
            signature: currentDataSignature
        });
    }
}


// --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÅ‡∏£‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ---
function promoteFoundingFamily(memberId, monarchId) {
    const p = state.members.find(m => m.id === memberId);
    const monarch = state.members.find(m => m.id === monarchId);
    if (!p || !monarch) return;

    const isMale = p.gender === 'M';
    const isOlder = (parseInt(p.birthYear) || 9999) < (parseInt(monarch.birthYear) || 0);

    p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)";
    p.surname = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°

    // --- 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å (‡∏û‡πà‡∏≠) ---
    if (p.id === monarch.fatherId) {
        p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤";
        p.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏Å";
        p.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
    } 
    // --- 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ (‡πÅ‡∏°‡πà) ---
    else if (p.id === monarch.motherId) {
        p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏®‡∏£‡∏µ";
        p.titleSuffix = "‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ";
        p.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
    }
    // --- 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á (‡∏û‡∏µ‡πà‡∏¢‡∏≤/‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤/‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á/‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á) ---
    else {
        const type = isOlder ? "‡∏û‡∏µ‡πà" : "‡∏ô‡πâ‡∏≠‡∏á";
        const genderSuffix = isMale ? "‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Full Sibling)
        const isFullSibling = (p.motherId === monarch.motherId && p.motherId != null);
        
        if (isFullSibling) {
            // ‡∏£‡πà‡∏ß‡∏°‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠)
            p.titlePrefix = `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤${type}${genderSuffix}`;
        } else {
            // ‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏ö‡∏¥‡∏î‡∏≤‡πÅ‡∏ï‡πà‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠)
            p.titlePrefix = `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞${type}${genderSuffix}`;
        }
        
        p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤";
    }

    recordTitleHistory(p);
    saveState(); 
    updateApp(); 
    showDetail(p.id);
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®`);
}

function promoteSiblingSpouse(memberId) {
    const p = state.members.find(m => m.id === memberId);
    if (!p) return;
    p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
    p.surname = "";
    recordTitleHistory(p);
    saveState(); updateApp(); showDetail(p.id);
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó‡πÅ‡∏•‡πâ‡∏ß`);
}

function promoteSiblingChild(memberId, monarchId) {
    const p = state.members.find(m => m.id === memberId);
    if (!p) return;
    const father = state.members.find(f => f.id === p.fatherId);
    const mother = state.members.find(mo => mo.id === p.motherId);
    
    const fRank = father?.royalRank || "";
    const mRank = mother?.royalRank || "";

    if (fRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") && mRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
        p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
    } else {
        p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
        p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
    }
    p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
    p.surname = "";
    recordTitleHistory(p);
    
    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏¢‡∏±‡∏ö‡∏¢‡∏®‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏°.‡∏à. -> ‡∏°.‡∏£.‡∏ß.)
    triggerHierarchyPromotion(p.id, p.royalRank, getFullDisplayTitle(p));

    saveState(); updateApp(); showDetail(p.id);
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
}
    
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö Recursive (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏™‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤-‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö Recursive (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)
 */

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
 * ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤
 */
function promoteMomChao() {
    const p = state.members.find(m => m.id === window.curPID);
    if (!p || p.royalRank !== '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') return;

    const father = state.members.find(m => m.id === p.fatherId);
    let newPrefix = "";
    let newRel = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå"; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

    if (father) {
        // 1. ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤
        if (father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤") {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            newRel = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
        } 
        else if (father.titlePrefix === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"; 
            newRel = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        }
        // 2. ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á
        else if (father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á") {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            newRel = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
        } 
        else if (father.titlePrefix === "‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"; 
            newRel = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        }
        
        // ====================================================
        // 3. ‡∏™‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå - ‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå - ‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå
        // ====================================================
        
        // 3.1 ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
        else if ((father.titlePrefix || "").includes("‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            newRel = "‡∏û‡∏£‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå";
        }
        // 3.2 ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
        else if ((father.titlePrefix || "").includes("‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            newRel = "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå"; 
        }
        // 3.3 ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
        else if ((father.titlePrefix || "").includes("‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            newPrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            newRel = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        }

        // ====================================================
        // ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©
        // ====================================================

        // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
        else {
            const mother = state.members.find(m => m.id === p.motherId);
            const isMotherChaoFa = mother && (mother.royalRank || "").includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
            newPrefix = isMotherChaoFa ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠
        const mother = state.members.find(m => m.id === p.motherId);
        const isMotherChaoFa = mother && (mother.royalRank || "").includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
        newPrefix = isMotherChaoFa ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
    }

    const newRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
    
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "${newPrefix} ${newRank}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    p.royalRank = newRank;
    p.titlePrefix = newPrefix;
    p.relationship = newRel;

    recordTitleHistory(p); 
    saveState(); 
    showDetail(p.id); 
    updateApp();      
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡πÄ‡∏õ‡πá‡∏ô${newPrefix} ${newRank} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`); 
}
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤"
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡πÇ‡∏•‡∏´‡∏¥‡∏ï)
 * 1. ‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) -> ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠
 * 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -> ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠
 */
function promoteToPhraOngChaoLanTher() {
    const p = state.members.find(m => m.id === window.curPID);
    const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);

    if (!p || p.royalRank !== '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') return;

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏î‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£
    const father = state.members.find(f => f.id === p.fatherId);
    const mother = state.members.find(m => m.id === p.motherId);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const checkRel = isDirectDescendant(activeMonarch?.id, p.id);
    const isDirectGrandchild = checkRel.isGrandchild;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏¥‡∏ò‡∏µ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÅ‡∏Å‡πà ${p.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    if (isDirectGrandchild) {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠) ---
        const fRank = father?.royalRank || "";
        const mRank = mother?.royalRank || "";

        // 1. ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ -> ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
        if (fRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") && mRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
            p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)`);
        } 
        // 2. ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤/‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏•‡∏á‡πÑ‡∏õ -> ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
        else {
            p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)`);
        }
    } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) -> ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ---
        p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
        p.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        p.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤`);
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    recordTitleHistory(p);
    saveState();
    showDetail(p.id); 
    updateApp();      
}
function triggerHierarchyPromotion(personId, newRank, fullTitle) {
    const person = state.members.find(m => m.id === personId); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö
    
    if (!person || person.isRankLocked) return; //


// --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
    const consortRoles = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°"];
    const activeMonarch = getCurrentMonarch();
    const isSpouseOfCurrentMonarch = activeMonarch && (activeMonarch.spouseIds || []).includes(person.id);

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏î) ‡πÉ‡∏´‡πâ "Return" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤
    if (consortRoles.includes(person.relationship) || person.monarchSpouseContext || isSpouseOfCurrentMonarch) {
        return; 
    }
    // ----------------------------

    

// ============================================================
    // ‡∏Å‡∏é‡πÄ‡∏â‡∏û‡∏≤‡∏∞: ‡∏´‡∏≤‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó" (Heir) 
    // ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (isMonarch) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏¢‡∏®‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    // ============================================================
    if (person.isHeir && !person.isMonarch) {
        return; 
    }
    

// ============================================================
    // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    // ============================================================
    const isMalePrince = person.gender === 'M' && 
        (person.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || 
         person.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') || 
         person.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'));

    if (isMalePrince && person.spouseIds) {
        person.spouseIds.forEach(sid => {
            const spouse = state.members.find(s => s.id === sid);
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ô‡∏≤‡∏á/‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (spouse && spouse.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && 
                (spouse.titlePrefix === '‡∏ô‡∏≤‡∏á' || spouse.titlePrefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß')) {
                
                spouse.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°';
                spouse.relationship = '‡∏´‡∏°‡πà‡∏≠‡∏°'; // ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°
                
                recordTitleHistory(spouse); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡∏∞‡∏¢‡∏®
                showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${spouse.name} ‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏°‡πà‡∏≠‡∏° (‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™${person.name})`);
            }
        });
    }
    // ============================================================


const children = state.members.filter(m => m.motherId === personId || m.fatherId === personId);

children.forEach(child => {
    // üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏®
    if (child.isRankLocked) {
        // ‡πÅ‡∏°‡πâ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏¢‡∏® (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á) 
        // ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤" (‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏≤‡∏ô) ‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢
        triggerHierarchyPromotion(child.id, child.royalRank, getFullDisplayTitle(child));
        return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    }

    // ‚ö™ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Ñ
    const auto = calculateChildRank(child.fatherId, child.motherId, child.gender, child.birthYear);
    if (child.royalRank !== auto.royalRank) {
        child.royalRank = auto.royalRank;
        child.titlePrefix = auto.titlePrefix;
        child.relationship = auto.relationship;
        recordTitleHistory(child);
        
        // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        triggerHierarchyPromotion(child.id, child.royalRank, getFullDisplayTitle(child));
    }

 
        // ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏•‡∏á: ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô (Descendants) 
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ MR/ML ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Prefix ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå
        
        const isMRorML = child.royalRank.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå") || child.royalRank.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á");
        
        if (isMRorML) {
            // ‡∏°.‡∏£.‡∏ß. ‡πÅ‡∏•‡∏∞ ‡∏°.‡∏•. ‡∏à‡∏∞‡∏Ñ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ Prefix "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤..." ‡∏°‡∏≤‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
            child.titlePrefix = child.royalRank; 
            child.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            return; 
        }

        const activeMonarch = getCurrentMonarch(); 
        const isMale = child.gender === 'M';
        let updated = false;
        let oldRank = child.royalRank;
        
        // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≤‡∏¢‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        const isDirectChild = (child.fatherId === activeMonarch?.id || child.motherId === activeMonarch?.id);
        if (isDirectChild) return; // ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å

// --- // --- 2. ‡∏Å‡∏é‡πÅ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å (‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå) (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
        const isSpouseOfCurrentKing = activeMonarch && (activeMonarch.spouseIds || []).includes(personId);
        if (isSpouseOfCurrentKing) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ person ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            let motherRankLevel = 0; 
            let mFather = state.members.find(m => m.id === person.fatherId);
            let mMother = state.members.find(m => m.id === person.motherId);
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î: ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á (1) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á (2)
            if (mFather?.isMonarch || mMother?.isMonarch) motherRankLevel = 1;
            else {
                const grandparents = [mFather, mMother].filter(p => p);
                for (const gp of grandparents) {
                    const ggf = state.members.find(m => m.id === gp.fatherId);
                    const ggm = state.members.find(m => m.id === gp.motherId);
                    if (ggf?.isMonarch || ggm?.isMonarch) { motherRankLevel = 2; break; }
                }
            }

            // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
            const rankEkKeywords = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
            const rankThoKeywords = ["‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"];

            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å (‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á OR ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏π‡∏á OR ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ)
            const isRankEk = (motherRankLevel === 1) || rankEkKeywords.some(key => fullTitle.includes(key)) || fullTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ");
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó (‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á OR ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
            const isRankTho = (motherRankLevel === 2) || rankThoKeywords.some(key => fullTitle.includes(key));

            if (isRankEk) {
                child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
                updated = true;
            } else if (isRankTho) {
                child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
                updated = true;
            }
        }

// ============================================================
// ‡∏Å‡∏é‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡πà‡∏≠ (Patrilineal Logic) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏¢‡∏®
// ============================================================
const isFather = (child.fatherId === personId);

if (isFather) {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Crash ‡∏î‡πâ‡∏ß‡∏¢ Find)
    const father = state.members.find(m => m.id === personId);
    const mother = state.members.find(m => m.id === child.motherId);
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏®‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏°/‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏•‡∏π‡∏Å)
    const isRankChanged = father && father.royalRank !== newRank;
    const isPromotion = fullTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || isRankChanged;

    if (!isPromotion) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏°‡πà (‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á ‡∏°.‡∏à. ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)
    const isMotherRoyal = mother && 
                         mother.royalRank && 
                         mother.royalRank !== "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" && 
                         mother.royalRank !== "";

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏£‡∏ì‡∏µ ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏à‡∏≤‡∏Å ‡∏°.‡∏à. (‡∏•‡∏π‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)
    const isPersonalElevation = fullTitle.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && 
                                !fullTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && 
                                !fullTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") &&
                                (!father || father.initialRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤");

    // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let updated = false;

    // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1: ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ---
    if (fullTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) {
        if (isMotherRoyal) {
            child.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            child.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            child.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        } else {
            child.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            child.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            child.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        }
        updated = true;
    } 
    // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2: ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠(‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î) ---
    else if (fullTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") || 
             (fullTitle.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") && !isPersonalElevation)) {
        if (isMotherRoyal) {
            child.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            child.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            child.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        } else {
            child.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            child.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            child.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        }
        updated = true;
    }
    // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3: ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ---
    else if (newRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        const isMotherChaoFa = mother?.royalRank?.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤");
        if (isMotherChaoFa) {
            child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            child.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        } else {
            child.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            child.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        }
        child.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        updated = true;
    }

    // --- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 4: ‡∏Å‡∏é‡∏™‡∏∑‡∏ö‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏°.‡∏£.‡∏ß. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°.‡∏•. ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ---
    if (!updated) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ‡∏°.‡∏à. ‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (‡∏•‡∏π‡∏Å‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏°.‡∏£.‡∏ß. ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏û‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏°.‡∏à.)
        if (isPersonalElevation || newRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤" || fullTitle.startsWith("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤")) {
            child.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
            child.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
            child.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            updated = true;
        } else if (newRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå" || fullTitle.startsWith("‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå")) {
            child.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á";
            child.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á";
            child.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            updated = true;
        }
    }
}
        // ============================================================
        // ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞ Recursive Call (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
        // ============================================================
        if (updated && oldRank !== child.royalRank) {
            recordTitleHistory(child); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏£‡∏∞‡∏¢‡∏®
            showToast(`‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${child.name} ‡πÄ‡∏õ‡πá‡∏ô ${child.royalRank}`);
            const childFullTitle = getFullDisplayTitle(child);
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Recursive ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ï‡∏≤‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏≤‡∏¢
            triggerHierarchyPromotion(child.id, child.royalRank, childFullTitle); 
        }
    });
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÅ‡∏ö‡∏ö Recursive
 * @param {string} parentId - ID ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢
 * @param {string} surname - ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
 */
function propagateRoyalSurname(parentId, surname) {
    if (!surname) return;

    // 1. ‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
    const person = state.members.find(m => m.id === parentId);
    if (person && person.spouseIds) {
        person.spouseIds.forEach(sid => {
            const spouse = state.members.find(s => s.id === sid);
            if (spouse && !spouse.isRoyalSurnameFounder) {
                spouse.royalSurname = surname;
            }
        });
    }

    // 2. ‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
    const children = state.members.filter(m => m.fatherId === parentId || m.motherId === parentId);

    children.forEach(child => {
        
        // ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏≠‡∏á" ‡πÉ‡∏´‡πâ‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏≤‡∏Å‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà
        if (!child.isRoyalSurnameFounder) {
            child.royalSurname = surname;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (Title History)
            recordTitleHistory(child);

            // 3. ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ (Recursive) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏ô ‡πÄ‡∏´‡∏•‡∏ô ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            propagateRoyalSurname(child.id, surname);
        }
    });
}







   function handleSavePerson(e) {
    try {
        e.preventDefault();
        const id = document.getElementById('p_id').value || Date.now().toString();
        const isEdit = document.getElementById('p_isEditMode').value === 'true';

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ ---
        const deathAge = document.getElementById('p_deathAge') ? document.getElementById('p_deathAge').value : '';
        // -----------------------
            
        const spouseIds = [];
        document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));

        const oldP = isEdit ? state.members.find(x => x.id === id) : null;

        const isFounder = document.getElementById('p_isSurnameFounder').checked;
        const rank = document.getElementById('p_royalRank').value;
        const commonerInput = document.getElementById('p_commonerSurnameInput').value;
        const royalInput = document.getElementById('p_royalSurnameInput').value;
        // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° Radio ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        const regRadio = document.querySelector('input[name="registeredSpouse"]:checked');
        const registeredSpouseId = regRadio ? regRadio.value : null;

        // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏Å‡πà‡∏≤: ‡πÉ‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô null ‡∏Å‡πà‡∏≠‡∏ô
        state.members.forEach(m => {
            if (m.registeredSpouseId === id) m.registeredSpouseId = null;
        });

        // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏£‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏î‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ p ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ registeredSpouseId ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (registeredSpouseId) {
            const spouse = state.members.find(s => s.id === registeredSpouseId);
            if (spouse) spouse.registeredSpouseId = id; 
        }
            
        let p = {
            id: id,
            name: document.getElementById('p_name').value || '-',
            deathAge: deathAge,
            nickname: document.getElementById('p_nickname').value || '',
            informalNames: document.getElementById('p_informalName').value || '',
            gender: document.querySelector('input[name="gender"]:checked').value,
            isAlive: document.getElementById('p_isAlive').checked,
            relationship: document.getElementById('p_relationship').value,
            isTao: document.getElementById('p_isTao').checked,
            taoTitle: document.getElementById('p_taoTitle').value,

            titlePrefix: document.getElementById('p_titlePrefix').value || '',
            titleSuffix: document.getElementById('p_titleSuffix').value || '',
            royalRank: document.getElementById('p_royalRank').value,
            kromRank: document.getElementById('p_kromRank').value || '',
            kromTitle: document.getElementById('p_kromTitle').value || '',
            isMonarch: document.getElementById('p_isMonarch').checked,
            isHeir: document.getElementById('p_isHeir').checked,
            heirOrder: document.getElementById('p_heirOrder').value || null,
            isQueenConsort: document.getElementById('p_isQueenConsort').checked,
            useReignName: document.getElementById('p_useReignName').checked,
            reignNameBase: document.getElementById('p_reignNameSelect').value || '',
            globalReignNumber: document.getElementById('p_globalReignNumber').value || null,
            reignStart: document.getElementById('p_reignStart').value || '',
            reignEnd: document.getElementById('p_reignEnd').value || '',
            eraName: document.getElementById('p_eraName').value || '',
            hasUmbrella: document.getElementById('p_hasUmbrella').checked,
            umbrellaType: document.getElementById('p_umbrellaType').value,
            image: document.getElementById('p_imageFinal').value,
            fatherId: document.getElementById('p_fatherId').value || null,
            motherId: document.getElementById('p_motherId').value || null,
            spouseIds: spouseIds,
            hideRoyalRank: document.getElementById('p_hideRoyalRank').checked,
            isRankLocked: document.getElementById('p_isRankLocked').checked, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            birthYear: document.getElementById('p_birthYear').value || null,
            isCoronated: oldP?.isCoronated || false,
            registeredSpouseId: registeredSpouseId, // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô

            birthDayOfWeek: document.getElementById('p_birthDayOfWeek').value,
            birthDay: document.getElementById('p_birthDay').value,
            birthMonth: document.getElementById('p_birthMonth').value,
            birthYear: document.getElementById('p_birthYear').value,
            deathDayOfWeek: document.getElementById('p_deathDayOfWeek').value,
            deathDay: document.getElementById('p_deathDay').value,
            deathMonth: document.getElementById('p_deathMonth').value,
            deathYear: document.getElementById('p_deathYear').value,
            nobilityTitle: document.getElementById('p_nobilityTitle').value,


// +++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ +++
        affiliationId: document.getElementById('p_affiliationId').value || null, 
        // ------------------

            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
            titleHistory: oldP?.titleHistory || [], 
            // ----------------------------






            

            // --- ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏° 4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏° ---
            customPrecedence: oldP?.customPrecedence, // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡πÄ‡∏î‡∏¥‡∏°
            destiny: oldP?.destiny,                   // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            isResigned: oldP?.isResigned || false,   // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
            isCoronated: oldP?.isCoronated || false, // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å
            // --------------------------------------------------

            isRoyalSurnameFounder: isFounder,
            // --- Surname Logic Mapping ---
            // isRoyalSurnameFounder: Use checkbox state if checked, otherwise default to false (or keep old if editing)
            isRoyalSurnameFounder: isFounder,

            // royalSurname: Set only if this person is a founder OR inherit from old value for non-founders
            royalSurname: isFounder ? royalInput : (oldP?.royalSurname || ''),
            
            // surname: Set only if rank is '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' and they are NOT a founder (used for *non-royal* commoner lineage display)
            surname: (rank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && !isFounder) ? commonerInput : '', 
            
            // NEW: Hide Surname State
            hideSurname: document.getElementById('p_hideSurname').checked,

            // NEW: Ex-Monarch Flag (Retain old state if editing and Monarch status hasn't changed drastically)
            // MODIFICATION: Preserve old Ex-Monarch state only if isMonarch is still true, otherwise clear it.
            isExMonarch: (oldP?.isExMonarch || false) && (document.getElementById('p_isMonarch').checked || false),

            // --- ‚ú® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡πâ‡∏≠‡∏¢ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..." ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
            monarchSpouseContext: (() => {
                const rel = document.getElementById('p_relationship').value;
                const allowed = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ"];
                if (!allowed.includes(rel)) return null;

                let mId = null;
                if (!isEdit && window.targetOriginIdForSpouse) {
                    mId = window.targetOriginIdForSpouse;
                } else {
                    const mSpouse = state.members.find(m => spouseIds.includes(m.id) && m.isMonarch);
                    if (mSpouse) mId = mSpouse.id;
                }

                if (mId) {
                    const monarch = state.members.find(m => m.id === mId);
                    const currentM = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏™‡∏£‡πâ‡∏≠‡∏¢
                    if (monarch && (!currentM || monarch.id !== currentM.id)) {
                        return monarch.globalReignNumber ? `‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(monarch.globalReignNumber)}` : (oldP?.monarchSpouseContext || null);
                    }
                }
                return (oldP && oldP.monarchSpouseContext && oldP.relationship === rel) ? oldP.monarchSpouseContext : null;
            })()
            // -------------------------------------------------------
        };
        
        // --- NEW: Auto-inherit Royal Surname if not explicitly set and parent has one ---
        // If the person is NOT an explicit founder, inherit the name from the parent lineage
       // -------------------------------------------------------
          // -------------------------------------------------------
           // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (Surname & Royal Surname Logic)
            // -------------------------------------------------------
            const father = state.members.find(m => m.id === p.fatherId);
            const mother = state.members.find(m => m.id === p.motherId);

            // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• + ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô(‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
            const isChildRoyal = p.royalRank && p.royalRank !== '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            const motherHasRoyalSurname = mother && mother.royalSurname;
            const fatherIsCommoner = !father || (!father.royalSurname); // ‡∏û‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•

            // ===============================================================
            // 1. [THE FIX] ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏•‡∏π‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏°‡πà
            // ===============================================================
            // ‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
            // ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            if (!p.isRoyalSurnameFounder && motherHasRoyalSurname && isChildRoyal && fatherIsCommoner) {
                p.royalSurname = mother.royalSurname;
                p.surname = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }

            // ===============================================================
            // 2. Logic ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠ 1 ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)
            // ===============================================================
            else if (!p.isRoyalSurnameFounder && !p.surname && !p.royalSurname) { 
                
                // Priority 1: Father (‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠)
                if (father?.royalSurname) {
                    p.royalSurname = father.royalSurname;
                } 
                // Priority 2: Mother (‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏°‡πà ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢)
                else if (mother?.royalSurname && !father?.surname) {
                    p.royalSurname = mother.royalSurname;
                }
                // Priority 3: Spouse (‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)
                else if (!isEdit && spouseIds.length > 0) {
                     const primarySpouse = state.members.find(s => s.id === spouseIds[0]);
                     if (primarySpouse) {
                         if (primarySpouse.royalSurname) {
                             p.royalSurname = primarySpouse.royalSurname;
                         } else if (primarySpouse.surname && p.gender === 'F' && primarySpouse.gender === 'M') {
                             p.surname = primarySpouse.surname;
                         }
                     }
                }
            }

            // =======================================================
            // [‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©] ‡∏´‡∏ç‡∏¥‡∏á (MC, MR, ML, Commoner) - ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            // =======================================================
            const autoChangeRanks = ['MC', 'MR', 'ML', 'Commoner'];
            
            if (p.gender === 'F' && (autoChangeRanks.includes(p.rank) || !p.rank) && spouseIds.length > 0) {
                 const primarySpouse = state.members.find(s => s.id === spouseIds[0]);
                 
                 // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•
                 if (primarySpouse?.royalSurname) {
                     p.royalSurname = primarySpouse.royalSurname;
                     p.surname = ''; 
                 }
            }

            // =======================================================
            // [‡∏Å‡∏é‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡πà‡∏≠]
            // =======================================================
            // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• + ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• + ‡∏û‡πà‡∏≠‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            if (!p.royalSurname && !p.surname && father && father.surname) {
                p.surname = father.surname;
            }



            if (p.isMonarch) {
                p.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
                p.kromRank = '';
                p.kromTitle = '';
                p.isExMonarch = false; // Cannot edit to be Ex-Monarch while setting as Monarch
            } else if (oldP?.isMonarch) {
                 // If changing from Monarch (isMonarch=true) to non-Monarch (isMonarch=false) during edit, it should probably be an abdication or a death process, not a simple form edit.
                 // We preserve oldExMonarch state here to allow a deceased Ex-Monarch to be edited.
                 p.isExMonarch = oldP.isExMonarch; 
                 // --- ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏° ---
    p.customPrecedence = oldP.customPrecedence; // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
    p.isResigned = oldP.isResigned;             // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    p.isCoronated = oldP.isCoronated;           // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å
    p.monarchSpouseContext = oldP.monarchSpouseContext; // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏£‡πâ‡∏≠‡∏¢ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..."
    // ---------------------------------------------------------  

            }
            
            p = checkConsortMotherhood(p);
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î Save ---
        recordTitleHistory(p); 
        // -----------------------------------------------------------



// >>> ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ <<<
    if (isEdit && oldP) {
        const consortRoles = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°"];
        const motherRoles = ["‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ß‡∏¥‡∏°‡∏≤‡∏î‡∏≤"];
        
        const wasConsort = consortRoles.includes(oldP.relationship);
        const becomingMother = motherRoles.includes(p.relationship);

        if (wasConsort && becomingMother) {
            if (!p.originalRoyalRank) {
                let currentRankLabel = getConsortCategoryLabel(oldP);
                if (!currentRankLabel) {
                    const pref = (oldP.titlePrefix || "").trim();
                    if (["‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞"].includes(pref)) currentRankLabel = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å";
                    else if (pref.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤","‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤")) currentRankLabel = "‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°";
                    else currentRankLabel = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
                }
                p.originalRoyalRank = currentRankLabel;
            }
        }
    } else if (oldP && oldP.originalRoyalRank) {
        p.originalRoyalRank = oldP.originalRoyalRank;
    }
    // >>> ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà <<<




          if(isEdit) {
                const idx = state.members.findIndex(m => m.id === id);
                if(idx !== -1) {
                    const old = state.members[idx];
                    old.spouseIds.forEach(sid => { if(!spouseIds.includes(sid)) { const s = state.members.find(x => x.id === sid); if(s) s.spouseIds = s.spouseIds.filter(x => x !== id); } });
                    state.members[idx] = p;
                }
            } else {
                // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏® (‡∏ä‡∏≤‡∏¢ 50 / ‡∏´‡∏ç‡∏¥‡∏á 50) ---
                const currentGender = p.gender; // 'M' ‡∏´‡∏£‡∏∑‡∏≠ 'F'
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏®‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
                const filteredDestinies = DESTINY_TRAITS.filter(d => d.gender === currentGender);
                
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏±‡∏ô Error)
                const pool = filteredDestinies.length > 0 ? filteredDestinies : DESTINY_TRAITS;
                
                // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏î‡∏ß‡∏á‡∏à‡∏≤‡∏Å 50 ‡∏î‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏®‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                const randomDestiny = pool[Math.floor(Math.random() * pool.length)];
                
                p.destiny = randomDestiny; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£

              state.members.push(p);

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏ó‡∏£‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏° ---
                const hasManualSort = state.members.some(m => m.customPrecedence !== undefined);
                
                if (hasManualSort) {
                    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pojiam ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                    state.members.forEach(m => {
                        m.pojiamScore = calculatePojiamScore(m);
                    });

                    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° (Hybrid Sort)
                    state.members.sort((a, b) => {
                        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠ (customPrecedence) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pojiam
                        const valA = a.customPrecedence !== undefined ? a.customPrecedence : a.pojiamScore;
                        const valB = b.customPrecedence !== undefined ? b.customPrecedence : b.pojiamScore;
                        return valB - valA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                    });

                    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠ (customPrecedence) ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏•‡πá‡∏≠‡∏Ñ" ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á (2,000 ‡∏•‡πâ‡∏≤‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ Pojiam ‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏≤‡πÅ‡∏ó‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                    let baseScore = 2000000000; 
                    state.members.forEach((m, idx) => {
                        m.customPrecedence = baseScore - idx;
                    });
                }
                // --------------------------------------------------

                // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤
                if (!window.parentStepFlow || window.parentStepFlow.step === 0) {
                    setTimeout(() => showCreationPopup(p), 500);
                }
            }

            spouseIds.forEach(sid => { const s = state.members.find(x => x.id === sid); if(s && !s.spouseIds.includes(id)) s.spouseIds.push(id); });

// --- ‡πÅ‡∏ó‡∏£‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô handleSavePerson ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ p ‡∏•‡∏á state.members ‡πÅ‡∏•‡πâ‡∏ß ---








if (window.parentStepFlow && window.parentStepFlow.step === 1) {
    // ‡∏à‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    window.parentStepFlow.fatherId = p.id; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏û‡πà‡∏≠‡πÑ‡∏ß‡πâ
    window.parentStepFlow.step = 2; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏°‡πà

    const child = state.members.find(m => m.id === window.parentStepFlow.childId);
    
    // ‡∏õ‡∏¥‡∏î Modal ‡∏û‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á Modal ‡πÅ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    closeModal('personModal');
    setTimeout(() => {
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á..." 
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏®‡∏´‡∏ç‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà ID ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
        openModal({ 
            gender: 'F', 
            spouseIds: [window.parentStepFlow.fatherId],
            relationship: '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏µ‡∏¢‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡πÄ‡∏à‡πâ‡∏≤
        }, false, `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á ${child.name}`);
        
        showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ï‡πà‡∏≠");
    }, 500);
    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Save ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏≥ Modal ‡πÅ‡∏°‡πà
}

if (window.parentStepFlow && window.parentStepFlow.step === 2) {
    // ‡∏à‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    const child = state.members.find(m => m.id === window.parentStepFlow.childId);
    const father = state.members.find(m => m.id === window.parentStepFlow.fatherId);
    const mother = p; // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ã‡∏ü‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏°‡πà

    if (child && father && mother) {
        // 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏´‡∏≤ ‡∏û‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏°‡πà
        child.fatherId = father.id;
        child.motherId = mother.id;

        // 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á ‡∏û‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        if (!father.spouseIds.includes(mother.id)) father.spouseIds.push(mother.id);
        if (!mother.spouseIds.includes(father.id)) mother.spouseIds.push(father.id);
        
        // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Registered Spouse) ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        father.registeredSpouseId = mother.id;
        mother.registeredSpouseId = father.id;

        showToast(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á ${child.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`);
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Flow
    window.parentStepFlow = { childId: null, fatherId: null, step: 0 };
}


            if(p.isMonarch && p.gender === 'M') {
                const selectedQueenId = document.getElementById('p_queenSelectForKing').value;
                p.spouseIds.forEach(sid => {
                    const s = state.members.find(m => m.id === sid);
                    if(s) s.isQueenConsort = false;
                });
                if(selectedQueenId) {
                    const q = state.members.find(m => m.id === selectedQueenId);
                    if(q) q.isQueenConsort = true;
                }
            }
            




            
            // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 1750 ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleSavePerson ---

if (!isEdit && (p.fatherId || p.motherId)) {
    [p.fatherId, p.motherId].forEach(parentId => {
        if (parentId) {
            const parent = state.members.find(m => m.id === parentId);
            if (parent) {
                const updatedParent = checkConsortMotherhood(parent);
                
                // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏®‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏•‡∏π‡∏Å]
                recordTitleHistory(updatedParent); 
                // ----------------------------------------------------

                const idx = state.members.findIndex(x => x.id === parentId);
                if(idx !== -1) state.members[idx] = updatedParent;
            }
        }
    });
}
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏¢ (‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏ô)
           // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏® (‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏®‡∏Å‡∏£‡∏°) ---
let skipPromotion = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô

if (isEdit && oldP) {
    // ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà "‡πÄ‡∏â‡∏û‡∏≤‡∏∞" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
    // 1. ‡∏¢‡∏®‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤)
    // 2. ‡∏û‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•)
    // 3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    if (
        oldP.royalRank !== p.royalRank || 
        oldP.fatherId !== p.fatherId || 
        oldP.motherId !== p.motherId ||
        oldP.relationship !== p.relationship
    ) {
        skipPromotion = false; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    }
} else if (!isEdit) {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    skipPromotion = false;
}

// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏° (‡∏Ñ‡∏∑‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
if (!skipPromotion) {
    const currentFullTitle = getFullDisplayTitle(p);
    triggerHierarchyPromotion(p.id, p.royalRank, currentFullTitle);
    console.log("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î");
} else {
    console.log("‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏®‡∏Å‡∏£‡∏°)");
}
// -----------------------------------------------------------------------

 // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ---
// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡∏°‡πÄ‡∏´‡∏™‡∏µ (‡πÅ‡∏ö‡∏ö‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ) ---
const currentMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);

if (currentMonarch && currentMonarch.gender === 'M') {
    // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü ‡∏Ñ‡∏∑‡∏≠ "‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    if (p.id !== currentMonarch.id && (currentMonarch.spouseIds || []).includes(p.id)) {
        if (currentMonarch.registeredSpouseId === p.id) {
            p.isQueenConsort = true;
          
            // ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô"
            // ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏®‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö
            if (!p.relationship || p.relationship === "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤" || p.relationship === "‡∏´‡∏°‡πà‡∏≠‡∏°" || p.relationship === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô") {
                p.relationship = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
                p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ";
                p.hideRoyalRank = false;
            }
        }
    }
    // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü ‡∏Ñ‡∏∑‡∏≠ "‡∏ï‡∏±‡∏ß‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏≠‡∏á" ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    if (p.id === currentMonarch.id && p.registeredSpouseId) {
        const spouse = state.members.find(s => s.id === p.registeredSpouseId);
        if (spouse && spouse.isAlive) {
            spouse.isQueenConsort = true;
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (!spouse.relationship || spouse.relationship === "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤" || spouse.relationship === "‡∏´‡∏°‡πà‡∏≠‡∏°") {
                spouse.relationship = "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤";
                spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ";
                recordTitleHistory(spouse);
            }
        }
    }
}
// -------------------------------------------------------------------------  
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î saveState() ‡πÉ‡∏ô handleSavePerson
if (p.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") {
    const currentMonarch = getCurrentMonarch();
    if (currentMonarch && currentMonarch.gender === 'M') {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const existingConsort = state.members.find(m => 
            m.id !== p.id && 
            m.relationship === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ" && 
            (m.spouseIds || []).includes(currentMonarch.id) &&
            m.isAlive
        );
        if (existingConsort) {
            alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ ${existingConsort.name})`);
            return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        }
    }
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤";
    p.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
if (p.isMonarch && p.gender === 'M') {
    const maleSpouses = p.spouseIds.filter(sid => {
        const s = state.members.find(m => m.id === sid);
        return s && s.gender === 'M';
    });
    if (maleSpouses.length > 1) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ä‡∏≤‡∏¢‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
    }
}





const hasMonarchSpouseCheck = p.spouseIds.some(sid => {
    const s = state.members.find(m => m.id === sid);
    return s && s.isMonarch && s.gender === 'M' && s.isAlive;
});

if (hasMonarchSpouseCheck) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç && p.relationship !== "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏®‡∏ô‡∏µ‡πâ
    if (p.relationship !== "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤" && !p.relationship.includes("‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤") && p.relationship !== "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ") {
        p.relationship = (p.royalRank !== "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô") ? "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤" : "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
        showToast(`‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á ${p.name} ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå`);
    }
}


// --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô handleSavePerson ---
spouseIds.forEach(sid => {
    const s = state.members.find(m => m.id === sid);
    if (s) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü (p) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (s) ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢
        if (p.gender === 'F' && s.gender === 'M') {
            applyRoyalMarriageRules(p, s);
        }
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü (p) ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (s) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡∏°‡πà)
        else if (p.gender === 'M' && s.gender === 'F') {
            applyRoyalMarriageRules(s, p);
        }
    }
});
// --------------------------------------------------




try {
    // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const monarchPartner = (p.spouseIds || [])
        .map(sid => state.members.find(m => m.id === sid))
        .find(s => s && s.isMonarch && s.isAlive && !s.isExMonarch);

    // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢
    if (monarchPartner && p.gender === 'M') {
        
        let autoRel = "";
        let autoPrefix = "";
        let autoSuffix = "";

        if (monarchPartner.gender === 'M') {
            autoRel = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
            autoPrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏£‡∏≤";
            autoSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ";
        } else if (monarchPartner.gender === 'F') {
            autoRel = "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
            autoPrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤";
            autoSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ";
        }

        // 3. ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏ô‡∏≤‡∏¢)
        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤:
        // - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô"
        // - ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏ô‡∏≤‡∏¢"
        if (!p.relationship || 
            p.relationship === "‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" || 
            p.relationship === "" || 
            p.relationship === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" || 
            p.titlePrefix === "‡∏ô‡∏≤‡∏¢") {
            
            p.relationship = autoRel;
            p.titlePrefix = autoPrefix;
            p.titleSuffix = autoSuffix;
            p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)";
            p.surname = ""; 
            p.hideRoyalRank = false;
        }
    }
} catch (e) {
    console.error("Auto-rank error:", e);
}


// ++++++++++ [‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î] ++++++++++
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ "‡∏ï‡∏≤‡∏¢" (!p.isAlive)
    if (!p.isAlive) {
        // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á state ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(() => {
            if (typeof processDeathAffiliationReassignment === 'function') {
                processDeathAffiliationReassignment(p);
                
                // ** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateApp() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ú‡∏±‡∏á/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ **
                if (typeof updateApp === 'function') updateApp();
            }
        }, 200); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô 200ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
    }
    // ++++++++++++++++++++++++++++++++++++++++++++++




saveState();
            closeModal('personModal');
            
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ú‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÑ‡∏õ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
            if (!isEdit) { 
                state.viewRootId = id; 
            }
            // -----------------------------------------------------------

            if(p.isMonarch && !isEdit && p.isAlive) showFantasyPopup(p);
            
            updateApp(); // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ú‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà
            
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } catch (err) {
            console.error(err);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);
        }
    }
  
    
    function openModal(d={}, edit=false, contextTitle=null) {
        try {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        window.currentMonarchSpouseContext = d.monarchSpouseContext || null;
            const f = document.getElementById('personForm'); f.reset();
            document.getElementById('p_isEditMode').value = edit;
            const titleEl = document.getElementById('modalTitle');
            let gender = d.gender; 
        if (!gender) {
            const genderRadio = document.querySelector('input[name="gender"]:checked');
            gender = genderRadio ? genderRadio.value : 'M'; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
        }
            if(contextTitle) { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (${contextTitle})`; } 
            else { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•`; }
            if (!edit && !d.gender) { const mRadio = document.querySelector('input[name="gender"][value="M"]'); if(mRadio) mRadio.checked = true; } 
            else if(d.gender) { document.querySelector(`input[name="gender"][value="${d.gender}"]`).checked = true; }
            
            
            // --- NEW RANK CALCULATION LOGIC ---
        let calculatedRank = { royalRank: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', titlePrefix: '', relationship: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' };
        if (!edit && (d.fatherId || d.motherId)) {
            const currentMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏® ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á ID ‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            calculatedRank = calculateChildRank(d.fatherId, d.motherId, gender);
            
            d.royalRank = calculatedRank.royalRank;
            d.titlePrefix = calculatedRank.titlePrefix;
            d.relationship = calculatedRank.relationship;
        }
            if (!edit && (d.fatherId || d.motherId)) {
                const currentMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
                const gender = d.gender || document.querySelector('input[name="gender"]:checked').value;
                
               if (currentMonarch && (d.fatherId === currentMonarch.id || d.motherId === currentMonarch.id)) {
    // ‡∏™‡πà‡∏á d.fatherId ‡πÅ‡∏•‡∏∞ d.motherId ‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏®‡πÄ‡∏≠‡∏á
    calculatedRank = calculateChildRank(d.fatherId, d.motherId, gender);
} else {
                    calculatedRank = calculateChildRankGeneric(d.fatherId, d.motherId, gender);
                }
                
                // Apply calculated rank and names
                d.royalRank = calculatedRank.royalRank;
                d.titlePrefix = calculatedRank.titlePrefix;
                d.relationship = calculatedRank.relationship;
                // If it's a new person, use the calculated surname for display
                d.royalSurname = d.royalSurname || calculatedRank.royalSurname; 
                d.surname = d.surname || calculatedRank.surname;
            }


document.getElementById('p_birthDayOfWeek').value = d.birthDayOfWeek || '';
document.getElementById('p_birthDay').value = d.birthDay || '';
document.getElementById('p_birthMonth').value = d.birthMonth || '';
document.getElementById('p_birthYear').value = d.birthYear || '';
document.getElementById('p_deathDayOfWeek').value = d.deathDayOfWeek || '';
document.getElementById('p_deathDay').value = d.deathDay || '';
document.getElementById('p_deathMonth').value = d.deathMonth || '';
document.getElementById('p_deathYear').value = d.deathYear || '';
calculateLivingAge(); // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Modal



// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openModal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
document.getElementById('p_informalName').value = d.informalNames || "";



            // --- END NEW RANK CALCULATION LOGIC ---
            
            document.getElementById('p_royalRank').value = d.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            document.getElementById('p_hideRoyalRank').checked = !!d.hideRoyalRank;
            document.getElementById('p_isRankLocked').checked = !!d.isRankLocked; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            if(!edit) { updateAutoId(); } else { document.getElementById('p_id').value = d.id || ''; }
            document.getElementById('p_name').value = d.name || '';
            document.getElementById('p_nobilityTitle').value = d.nobilityTitle || '';


// +++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ +++
    document.getElementById('p_affiliationId').value = d.affiliationId || '';
    if (d.affiliationId) {
        const affPerson = state.members.find(m => m.id === d.affiliationId);
        if (affPerson) {
            const title = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(affPerson) : affPerson.name;
            document.getElementById('p_affiliationSearch').value = `${affPerson.id} : ${title}`;
        } else {
            document.getElementById('p_affiliationSearch').value = d.affiliationId;
        }
    } else {
        document.getElementById('p_affiliationSearch').value = '';
    }
    // ------------------

            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å ---
           document.getElementById('p_deathAge').value = d.deathAge || '';
        // -------------------------------------------------

            document.getElementById('p_nickname').value = d.nickname || '';
            document.getElementById('p_isAlive').checked = d.isAlive !== false;
            
            document.getElementById('p_birthYear').value = d.birthYear || ''; 
            
            // NEW: Load surname fields and toggles
            // A person is marked as founder ONLY if their saved data explicitly says so (d.isRoyalSurnameFounder).
            // This prevents descendants/spouses who auto-inherit the name from being marked as founders.
            const isFounder = !!d.isRoyalSurnameFounder;
            document.getElementById('p_isSurnameFounder').checked = isFounder;
            document.getElementById('p_royalSurnameInput').value = d.royalSurname || ''; // Shows inherited royal surname
            document.getElementById('p_commonerSurnameInput').value = d.surname || '';
            // NEW: Hide Surname Checkbox
            document.getElementById('p_hideSurname').checked = !!d.hideSurname;
            
            populateRelSelect(d.relationship);

            // [++++ ‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ++++]
document.getElementById('p_isTao').checked = d.isTao || false;
document.getElementById('p_taoTitle').value = d.taoTitle || '';
if (typeof toggleTaoVisibility === 'function') toggleTaoVisibility();
if (typeof toggleTaoInput === 'function') toggleTaoInput();
// -----------------------
            updatePrefixOptions(d.titlePrefix);
            updateSuffixOptions(d.titleSuffix);
            document.getElementById('p_fatherId').value = d.fatherId || '';
            document.getElementById('p_fatherSearch').value = d.fatherId ? (state.members.find(x=>x.id==d.fatherId)?.name || d.fatherId) : '';
            document.getElementById('p_motherId').value = d.motherId || '';
            document.getElementById('p_motherSearch').value = d.motherId ? (state.members.find(x=>x.id==d.motherId)?.name || d.motherId) : '';
            
            // MODIFICATION: The checkbox value is based directly on the historical data (d.isMonarch)
            document.getElementById('p_isMonarch').checked = !!d.isMonarch;
            
            document.getElementById('p_useReignName').checked = !!d.useReignName;
            populateReignSelect(d.reignNameBase);
            if(!edit && d.isMonarch === undefined) {
                 const monarchs = state.members.filter(x => x.isMonarch);
                 const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
                 document.getElementById('p_globalReignNumber').value = maxGlobal + 1;
            } else { document.getElementById('p_globalReignNumber').value = d.globalReignNumber || ''; }
            document.getElementById('p_reignStart').value = d.reignStart || '';
            document.getElementById('p_reignEnd').value = d.reignEnd || '';
            document.getElementById('p_eraName').value = d.eraName || '';
            toggleMonarch(d.titlePrefix, d.titleSuffix);
            document.getElementById('p_isHeir').checked = !!d.isHeir;
            document.getElementById('p_heirOrder').value = d.heirOrder || '';
            toggleHeirOrder();
            document.getElementById('p_isQueenConsort').checked = !!d.isQueenConsort;
            document.getElementById('p_hasUmbrella').checked = !!d.hasUmbrella;
            document.getElementById('p_umbrellaType').value = d.umbrellaType || '‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£';
            toggleUmbrella();
            document.getElementById('p_kromRank').value = d.kromRank || '';
            document.getElementById('p_kromTitle').value = d.kromTitle || '';
            toggleKrom();
            const ul = document.getElementById('p_spouseList'); 
            ul.innerHTML = '';
            (d.spouseIds || []).forEach(sid => { 
                const s = state.members.find(x => x.id === sid); 
                if(s) {
                    const isRegistered = (d.registeredSpouseId === s.id);
                    addSpouseLi(s, isRegistered); 
                }
            });
            if (d.fatherOptions || d.motherOptions) {
                updateDatalists(d.id, d.fatherOptions, d.motherOptions);
            } else {
                updateDatalists(d.id);
            }

            updateQueenConsortSelector(d);
            setTimeout(checkQueenConsortEligible, 100);
            toggleSurnameFields(); // Initialize visibility of new fields
            document.getElementById('personModal').classList.add('active');
        } catch(e) { console.error(e); }
    }

    function openAddRootModal() { openModal({}); }
    function editCurrent() { closeModal('detailModal'); openModal(state.members.find(m=>m.id===window.curPID), true); }
    
function toggleDeath() { 
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ window.curPID ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const p = state.members.find(m => m.id === window.curPID); 
    if (!p) return;

    const wasActiveMonarch = p.isMonarch && p.isAlive && !p.isExMonarch;
    const wasKulachet = !!p.isPhraKulachet;

    p.isAlive = !p.isAlive; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏õ‡πá‡∏ô/‡∏ï‡∏≤‡∏¢

    if (!p.isAlive) { 
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ---

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        p.deathDay = state.worldTime.day;
        p.deathMonth = state.worldTime.month;
        p.deathYear = state.worldTime.year;

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ï‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (wasKulachet) {
            p.wasPhraKulachet = true;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏¢ ---
        if (p.isHeir) {
            const deadOrder = parseInt(p.heirOrder); // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡πÑ‡∏ß‡πâ
            
            state.members.forEach(m => {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢
                if (m.isHeir && m.isAlive && m.heirOrder) {
                    const currentOrder = parseInt(m.heirOrder);
                    if (currentOrder > deadOrder) {
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        m.heirOrder = (currentOrder - 1).toString();
                    }
                }
            });

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢
            p.isHeir = false;
            p.heirOrder = null;
        }
        // ------------------------------------------

        if (wasActiveMonarch) {
            handleMonarchDeath(p); 
        }

        // üëâ [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Pop-up ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Auto Reassignment)
        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 300ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏ï‡∏≤‡∏¢" (‡∏™‡∏µ‡πÄ‡∏ó‡∏≤) ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏î‡πâ‡∏á Pop-up
        setTimeout(() => {
             if (typeof processDeathAffiliationReassignment === 'function') {
                 processDeathAffiliationReassignment(p);
             }
        }, 300);

    } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û ---
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
        p.deathDay = null;
        p.deathMonth = null;
        p.deathYear = null;
        p.monarchSpouseContext = null; 
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏®‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠)
    if (p.gender === 'F' && (p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
        const updatedP = checkConsortMotherhood(p);
        p.titlePrefix = updatedP.titlePrefix; 
    }

    saveState(); 
    showDetail(p.id); 
    updateApp(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏ú‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
}
    

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
function toggleResignation(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;

    if (!p.isResigned) {
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î/‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡∏Ç‡∏≠‡∏á ${p.name}?\n*‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏™‡∏±‡∏ô‡∏ï‡∏ï‡∏¥‡∏ß‡∏á‡∏®‡πå (‡πÅ‡∏ï‡πà‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏¢‡∏®‡πÄ‡∏î‡∏¥‡∏°)`)) return;
        
        p.isResigned = true;

        // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• + ‡∏ì + ‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ---
        if (p.royalSurname && p.royalSurname.trim() !== "") {
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
            if (p.originalSurname === undefined) {
                p.originalSurname = p.surname || "";
            }
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà
            p.surname = `${p.royalSurname} ‡∏ì ${state.kingdomName}`;
        }
        // -------------------------------------------------------

        showToast(`‡∏ñ‡∏≠‡∏î ${p.name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);

    } else {
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÉ‡∏´‡πâ ${p.name}?`)) return;
        
        p.isResigned = false;

        // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå ---
        if (p.originalSurname !== undefined) {
            p.surname = p.originalSurname;
            delete p.originalSurname; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ
        }
        // -------------------------------------------------------

        showToast(`‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÉ‡∏´‡πâ ${p.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    saveState();
    updateApp();
    showDetail(id);
}



    function deleteCurrent() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
        const id = window.curPID;
        state.members = state.members.filter(m => m.id !== id);
        state.members.forEach(m => {
            if(m.fatherId === id) m.fatherId = null;
            if(m.motherId === id) m.motherId = null;
            m.spouseIds = m.spouseIds.filter(sid => sid !== id);
        });
        const possibleMothers = state.members.filter(m => (m.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') && m.gender === 'F');
        possibleMothers.forEach(m => {
            const updatedM = checkConsortMotherhood(m);
            if (updatedM.titlePrefix !== m.titlePrefix) {
                const idx = state.members.findIndex(x => x.id === m.id);
                if(idx !== -1) state.members[idx] = updatedM;
            }
        });
        
        saveState(); closeModal('detailModal'); refreshAllDisplays();
    }

    function openRelationshipModal() {
        document.getElementById('rel_input_a').value = '';
        document.getElementById('rel_input_b').value = '';
        document.getElementById('rel_id_a').value = '';
        document.getElementById('rel_id_b').value = '';
        document.getElementById('rel_img_a').src = '';
        document.getElementById('rel_img_b').src = '';
        
        const dl = document.getElementById('relOptions');
        dl.innerHTML = '';
        state.members.forEach(m => {
            const op = document.createElement('option');
            op.value = `${m.id} : ${m.name}`;
            dl.appendChild(op);
        });
        
        document.getElementById('relationshipModal').classList.add('active');
    }

    function updateRelPreview(side) {
        const input = document.getElementById(`rel_input_${side}`).value;
        const match = input.match(/^(.*?)\s*:\s*(.*)$/);
        let id = null;
        if(match) {
            id = match[1].trim();
        } else {
             const m = state.members.find(x => x.name === input.trim());
             if (m) id = m.id;
        }

        if(id) {
            const m = state.members.find(x => x.id === id);
            if(m) {
                document.getElementById(`rel_id_${side}`).value = id;
                document.getElementById(`rel_img_${side}`).src = m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
                document.getElementById(`rel_img_${side}`).classList.remove('opacity-50');
                return;
            }
        }
        document.getElementById(`rel_id_${side}`).value = '';
        document.getElementById(`rel_img_${side}`).src = '';
        document.getElementById(`rel_img_${side}`).classList.add('opacity-50');
    }

    function calculateRelationship() {
        const idA = document.getElementById('rel_id_a').value;
        const idB = document.getElementById('rel_id_b').value;
        
        if(!idA || !idB) { showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô"); return; }
        if(idA === idB) { showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô"); return; }
        
        const path = findRelationshipPath(idA, idB);
        
        if(!path) {
            showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ");
            return;
        }

        closeModal('relationshipModal');
        state.highlightIds = [idA, idB];
        const midId = path[Math.floor(path.length/2)];
        state.viewRootId = midId; 
        state.treeViewType = 'all'; 
        
        saveState();
        renderTree();
        resetView();
        showToast("‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡πâ‡∏ß");
        setTimeout(() => { state.highlightIds = []; renderTree(); }, 5000);
    }

    function findRelationshipPath(startId, endId) {
        const queue = [[startId]];
        const visited = new Set();
        visited.add(startId);
        
        while (queue.length > 0) {
            const path = queue.shift();
            const node = path[path.length - 1];
            
            if (node === endId) return path;
            
            const neighbors = [];
            const m = state.members.find(x => x.id === node);
            if(m) {
                if(m.fatherId) neighbors.push(m.fatherId);
                if(m.motherId) neighbors.push(m.motherId);
                if(m.spouseIds) neighbors.push(...m.spouseIds);
                state.members.filter(c => c.fatherId === node || c.motherId === node).forEach(c => neighbors.push(c.id));
            }
            
            for (const neighbor of neighbors) {
                if (!visited.has(neighbor)) {
                    visited.add(neighbor);
                    const newPath = [...path, neighbor];
                    queue.push(newPath);
                }
            }
        }
        return null;
    }

    function setAsRoot(id) { 
        state.viewRootId = id; 
        
        // NEW LOGIC: Auto-switch to Royal Surname View if the person belongs to one
        const founderId = getSurnameFounderForPerson(id);
        
        if (founderId) {
            state.treeViewType = 'royalSurname';
            state.currentSurnameRootId = founderId;
            // Update the dropdown immediately for visual feedback
            document.getElementById('treeViewMode').value = 'royalSurname';
        } else if (state.treeViewType === 'royalSurname') {
            // If they don't have a surname, but we were in surname view, reset to 'all'
             state.treeViewType = 'all';
             document.getElementById('treeViewMode').value = 'all';
        }
        
        saveState(); 
        closeModal('detailModal'); 
        renderTree(); 
        resetView(); 
    }
    function focusOnPerson(val) { 
        const id = val.split(':')[0].trim(); 
        if(state.members.find(m => m.id === id)) { 
            state.viewRootId = id; 
            renderTree(); 
        } 
    }
    function focusOnMonarch() { const m = state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch); if(m) { state.viewRootId = m.id; renderTree(); resetView(); } }
    function populateSearchLists() { const dl = document.getElementById('focusOptions'); dl.innerHTML = ''; state.members.forEach(m => { const op = document.createElement('option'); op.value = `${m.id} : ${m.name}`; dl.appendChild(op); }); }
    // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà
window.parentStepFlow = {
    childId: null,
    fatherId: null,
    step: 0 // 0: ‡∏õ‡∏Å‡∏ï‡∏¥, 1: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡πà‡∏≠, 2: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏°‡πà
};

function openAddParentModal(childId) {
    closeModal('detailModal');
    const child = state.members.find(m => m.id === childId);
    if (!child) return;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡πà‡∏≠
    window.parentStepFlow = {
        childId: childId,
        fatherId: null,
        step: 1
    };

    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏î‡∏≤‡∏Ç‡∏≠‡∏á..." ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏®‡∏ä‡∏≤‡∏¢
    openModal({ gender: 'M' }, false, `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏î‡∏≤‡∏Ç‡∏≠‡∏á ${child.name}`);
}
    // NOTE: openAddSpouseModal is now openSpouseSelectionModal
    // function openAddSpouseModal(id) { closeModal('detailModal'); const m = state.members.find(x => x.id === id); openModal({ spouseIds: [id], gender: m.gender==='M'?'F':'M' }, false, `‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á ${m.name}`); }
    
    function openAddChildModal(id) {
    closeModal('detailModal');
    const m = state.members.find(x => x.id === id);
    
    const defaults = m.gender === 'M' ? { fatherId: id } : { motherId: id };
    
    const spouseObjects = (m.spouseIds || [])
        .map(sid => state.members.find(x => x.id === sid))
        .filter(s => s);
        
    let otherParentId = null;
    let filteredParentList = []; 
    
    if (spouseObjects.length > 0) {
        const requiredGender = m.gender === 'M' ? 'F' : 'M';
        filteredParentList = spouseObjects.filter(s => s.gender === requiredGender);

        if (filteredParentList.length === 1) {
            otherParentId = filteredParentList[0].id;
        }
    }
    
    if (otherParentId) {
        if (m.gender === 'M') {
            defaults.motherId = otherParentId;
        } else {
            defaults.fatherId = otherParentId;
        }
    }

    if (m.gender === 'M') {
         defaults.motherOptions = filteredParentList;
    } else {
         defaults.fatherOptions = filteredParentList;
    }

    // 1. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    openModal(defaults, false, `‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ${m.name}`); 
    
    const otherInputId = m.gender === 'M' ? 'p_motherSearch' : 'p_fatherSearch';
    const type = m.gender === 'M' ? 'mother' : 'father';
    const inputEl = document.getElementById(otherInputId);
    
    if(inputEl) {
    const updateRealtimeInfo = () => {
        validateParent(type); // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á ID ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á autoFillRank ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        
        // ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Modal (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const targetHiddenId = document.getElementById(type === 'mother' ? 'p_motherId' : 'p_fatherId').value;
        const otherParent = state.members.find(x => x.id === targetHiddenId);
        const baseTitle = `‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ${m.name}`;
        const modalTitleEl = document.getElementById('modalTitle');
        if(modalTitleEl && otherParent) {
            modalTitleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (${baseTitle} ‡∏Å‡∏±‡∏ö ${otherParent.name})`;
        }
    };

    // ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á oninput ‡πÅ‡∏•‡∏∞ onchange ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Datalist
    inputEl.oninput = updateRealtimeInfo;
    inputEl.onchange = updateRealtimeInfo;

        // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        if (otherParentId) {
            const autoSelectedParent = state.members.find(x => x.id === otherParentId);
            if (autoSelectedParent) {
                inputEl.value = autoSelectedParent.name;
                // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ value ‡∏ú‡πà‡∏≤‡∏ô script ‡∏à‡∏∞‡πÑ‡∏°‡πà trigger oninput
                setTimeout(updateRealtimeInfo, 50); 
            }
        } else {
            // ‡πÅ‡∏°‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ ‡∏Å‡πá‡∏™‡∏±‡πà‡∏á autoFillRank ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            autoFillRank();
        }
    }
}
    
    function toggleReignName() { const u = document.getElementById('p_useReignName').checked; document.getElementById('p_reignNameSelect').classList.toggle('hidden', !u); document.getElementById('p_autoReignNameNumber').classList.toggle('hidden', !u); }
    function toggleHeirOrder() { const h = document.getElementById('p_isHeir').checked; document.getElementById('p_heirOrder').classList.toggle('hidden', !h); }
    function toggleUmbrella() { const h = document.getElementById('p_hasUmbrella').checked; document.getElementById('p_umbrellaType').classList.toggle('hidden', !h); }
  function toggleKrom() {
    const kromRankEl = document.getElementById('p_kromRank');
    const kromTitleEl = document.getElementById('p_kromTitle');
    const royalRank = document.getElementById('p_royalRank').value;
    
    // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÉ‡∏™‡πà ID ‡πÉ‡∏´‡πâ
    const kromFullWrapper = document.getElementById('kromFullWrapper');

    const restrictedRanks = ["‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå", "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á", "‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä", "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô"]; 

    if (restrictedRanks.includes(royalRank)) {
        // --- ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏á‡πÑ‡∏õ: ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß (‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Label) ---
        if (kromFullWrapper) kromFullWrapper.classList.add('hidden');
        
        kromRankEl.value = "";
        kromTitleEl.value = "";
        return; 
    } else {
        // --- ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ---
        if (kromFullWrapper) kromFullWrapper.classList.remove('hidden');
    }

    // ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á "‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°" (‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤)
    if (kromRankEl.value) {
        kromTitleEl.classList.remove('hidden');
    } else {
        kromTitleEl.classList.add('hidden');
        kromTitleEl.value = "";
    }

    // =================================================================
    // ‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ï‡∏¥‡∏° "‡∏û‡∏¥‡∏®‡∏ì‡∏∏‡πÇ‡∏•‡∏Å‡∏ò‡∏¥‡∏ß‡∏£‡πÄ‡∏®‡∏£‡∏©‡∏ê" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö 1 + ‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞
    // =================================================================
    const isHeir = document.getElementById('p_isHeir').checked;
    const heirOrder = document.getElementById('p_heirOrder').value;
    
    // 1. ‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ state)
    let activeMonarch = null;
    if (typeof getCurrentMonarch === 'function') {
        activeMonarch = getCurrentMonarch();
    } else if (typeof state !== 'undefined' && state.members) {
        activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
    }

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let isChildOfKing = false;
    if (activeMonarch) {
        const fId = document.getElementById('p_fatherId').value;
        const mId = document.getElementById('p_motherId').value;
        if (activeMonarch.id === fId || activeMonarch.id === mId) {
            isChildOfKing = true;
        }
    }

    // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥
    if (isChildOfKing && isHeir && heirOrder == '1' && kromRankEl.value === '‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞') {
        kromTitleEl.value = "‡∏û‡∏¥‡∏®‡∏ì‡∏∏‡πÇ‡∏•‡∏Å‡∏ò‡∏¥‡∏ß‡∏£‡πÄ‡∏®‡∏£‡∏©‡∏ê";
    }
    // =================================================================

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏à‡πâ‡∏á) ---
    const prefixEl = document.getElementById('p_titlePrefix');
    const currentPrefix = prefixEl.value;
    const highKromRanks = ["‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞", "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞"];
    const normalKromRanks = ["‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô", "‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á", ""];
    
    if (royalRank === "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)") {
        if (highKromRanks.includes(kromRankEl.value)) {
            if (currentPrefix === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") {
                prefixEl.value = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                if(typeof showToast === 'function') showToast("‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô: ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‚ú®");
            }
        } else if (normalKromRanks.includes(kromRankEl.value)) {
            if (currentPrefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") {
                prefixEl.value = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                if(typeof showToast === 'function') showToast("‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô: ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‚ú®");
            }
        }
    }
}



    function populateReignSelect(selVal) { const s = document.getElementById('p_reignNameSelect'); s.innerHTML = ''; state.reignNames.forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); if(selVal) s.value = selVal; }
  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏î‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®)
function populateRelSelect(v) { 
    const s = document.getElementById('p_relationship'); 
    s.innerHTML = '<option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå -</option>'; 
    
    // ‡∏î‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    Object.keys(state.hierarchy).forEach(rel => {
        const op = new Option(rel, rel);
        s.add(op);
    });

    if(v) s.value = v; 
    s.onchange = () => updatePrefixOptions();
}


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡πâ‡∏≠‡∏¢ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..." ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
 * ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
function autoUpdateMonarchSpouseContext() {
    const rel = document.getElementById('p_relationship').value;
    const allowedRoles = ["‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ"];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!allowedRoles.includes(rel)) {
        window.currentMonarchSpouseContext = null;
        return;
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°
    let monarchId = null;
    const isEdit = document.getElementById('p_isEditMode').value === 'true';
    const currentId = document.getElementById('p_id').value;

    if (!isEdit && window.targetOriginIdForSpouse) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Add Spouse)
        monarchId = window.targetOriginIdForSpouse;
    } else if (isEdit) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        const spouseIds = [];
        document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));
        const monarchSpouse = state.members.find(m => spouseIds.includes(m.id) && m.isMonarch);
        if (monarchSpouse) monarchId = monarchSpouse.id;
    }

    if (monarchId) {
        const monarch = state.members.find(m => m.id === monarchId);
        const currentMonarch = getCurrentMonarch(); // ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
        if (monarch && monarch.isMonarch && (!currentMonarch || monarch.id !== currentMonarch.id)) {
            if (monarch.globalReignNumber) {
                window.currentMonarchSpouseContext = `‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(monarch.globalReignNumber)}`;
            }
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢
            window.currentMonarchSpouseContext = null;
        }
    } else {
        window.currentMonarchSpouseContext = null;
    }
}




function updatePrefixOptions(v, suffixV = null) { 
    const rel = document.getElementById('p_relationship').value; 
    const s = document.getElementById('p_titlePrefix'); 
    const nobilityContainer = document.getElementById('nobilityTitleContainer'); // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á DIV ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á) ---
    if (nobilityContainer) {
        if (rel === '‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á') {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå
            nobilityContainer.classList.remove('hidden');
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏≠‡∏≠‡∏Å
            nobilityContainer.classList.add('hidden');
            const nobilityInput = document.getElementById('p_nobilityTitle');
            if (nobilityInput) nobilityInput.value = "";
        }
    }
    // -------------------------

    s.innerHTML = '<option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ -</option>'; 
    
    if(rel && state.hierarchy[rel]) {
        state.hierarchy[rel].prefixes.forEach(p => {
            s.add(new Option(p, p));
        });
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
    autoUpdateMonarchSpouseContext();

    if(v) s.value = v; 
    s.onchange = () => {
        updateSuffixOptions();
        checkQueenConsortEligible(); 
    };
    
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á suffixV ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    updateSuffixOptions(suffixV); 

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß ---
    if (typeof toggleTaoVisibility === 'function') {
        toggleTaoVisibility();
    }
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß
function toggleTaoVisibility() {
    const rel = document.getElementById('p_relationship').value;
    const rank = document.getElementById('p_royalRank').value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®
    const gender = document.querySelector('input[name="gender"]:checked')?.value;
    const container = document.getElementById('taoCheckboxContainer');

    // 1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤, ‡∏´‡∏°‡πà‡∏≠‡∏° ‡∏Ø‡∏•‡∏Ø)
    const isSpecialRole = rel && (rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || rel === '‡∏´‡∏°‡πà‡∏≠‡∏°' || rel === '‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô');
    
    // 2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡∏ä‡∏±‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏´‡∏ç‡∏¥‡∏á)
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' ‡πÅ‡∏•‡∏∞ '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
    const allowedRanks = ['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'];
    const isEligibleRank = allowedRanks.includes(rank); 
    
    const isCommonerWoman = (rel === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && isEligibleRank && gender === 'F');

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏ô‡∏∂‡πà‡∏á
    if (isSpecialRole || isCommonerWoman) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
        document.getElementById('p_isTao').checked = false; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏ô
        toggleTaoInput();
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏ß (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
function toggleTaoInput() {
    const isTao = document.getElementById('p_isTao').checked;
    const inputSec = document.getElementById('taoInputSection');
    if (isTao) {
        inputSec.classList.remove('hidden');
        // (‡πÄ‡∏™‡∏£‡∏¥‡∏°) ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        setTimeout(() => document.getElementById('p_taoTitle').focus(), 100);
    } else {
        inputSec.classList.add('hidden');
        document.getElementById('p_taoTitle').value = '';
    }
}



// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° (‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
function updateSuffixOptions(v) { 
    const rel = document.getElementById('p_relationship').value; 
    const pre = document.getElementById('p_titlePrefix').value; 
    const s = document.getElementById('p_titleSuffix'); 
    s.innerHTML = '<option value="">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢ -</option>'; 
    
    if(rel && pre && state.hierarchy[rel] && state.hierarchy[rel].suffixes[pre]) {
        state.hierarchy[rel].suffixes[pre].forEach(x => {
            s.add(new Option(x, x));
        });
    }
    
    if(v) s.value = v; 

    // +++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ +++
    toggleAffiliationInput();
}





    function updateDatalists(selfId, filteredFatherList, filteredMotherList) { 
        const fo = document.getElementById('fatherOptions'); fo.innerHTML=''; 
        const mo = document.getElementById('motherOptions'); mo.innerHTML=''; 
        const so = document.getElementById('spouseOptions'); so.innerHTML=''; 
        
        let fatherCandidates = filteredFatherList || state.members.filter(m => m.gender === 'M');
        let motherCandidates = filteredMotherList || state.members.filter(m => m.gender === 'F');

        fatherCandidates.forEach(m => {
            if(m.id === selfId) return; 
            const op = document.createElement('option'); 
            op.value = m.id; 
            op.innerText = m.name; 
            fo.appendChild(op);
        });

        motherCandidates.forEach(m => {
            if(m.id === selfId) return; 
            const op = document.createElement('option'); 
            op.value = m.id; 
            op.innerText = m.name; 
            mo.appendChild(op);
        });
        
        state.members.forEach(m => { 
            if(m.id === selfId) return; 
            const op = `<option value="${m.id}">${m.name}</option>`;
            so.innerHTML += op; 
        });
    }

   // 1. ‡∏ã‡πà‡∏≠‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡∏à‡∏≥ ID ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ (Real-time Fix)
function validateParent(role) {
    const searchInput = document.getElementById(`p_${role}Search`);
    const idInput = document.getElementById(`p_${role}Id`);
    const val = searchInput.value.trim();

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å ID ‡∏ï‡∏£‡∏á‡πÜ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Datalist) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠
    const found = state.members.find(m => 
        m.id === val || 
        m.name === val || 
        `${m.id} : ${m.name}` === val
    );

    if (found) {
        idInput.value = found.id;
        searchInput.value = found.name; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏•‡∏π‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        autoFillRank(); 
    } else {
        idInput.value = '';
    }

    // ==========================================================
    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö] ---
    // ==========================================================
    updateRoyalRelationshipByGender();
}


  function addSpouseLi(m, isRegistered = false) {
    const ul = document.getElementById('p_spouseList');
    const currentPersonId = document.getElementById('p_id').value;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö "‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isOccupied = m.registeredSpouseId && m.registeredSpouseId !== currentPersonId;
    
    const li = document.createElement('li');
    li.className = `px-3 py-1.5 rounded-full flex items-center gap-2 border shadow-sm mb-1 ${isOccupied ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-rose-50 text-rose-600 border-rose-100'}`;
    li.dataset.id = m.id;
    
    li.innerHTML = `
        <input type="radio" name="registeredSpouse" value="${m.id}" 
            ${isRegistered ? 'checked' : ''} 
            ${isOccupied ? 'disabled' : ''}
            data-checked="${isRegistered ? 'true' : 'false'}"
            onclick="toggleRadio(this)"
            class="w-3.5 h-3.5 accent-rose-500 ${isOccupied ? 'cursor-not-allowed' : 'cursor-pointer'}" 
            title="${isOccupied ? '‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™'}">
        <span class="text-xs font-bold leading-none">${m.name} ${isOccupied ? '(‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)' : ''}</span>
        <button type="button" onclick="this.parentElement.remove(); updateQueenConsortSelector()" class="ml-1 text-rose-300 hover:text-red-500 transition-colors">
            <i class="fa-solid fa-circle-xmark text-xs"></i>
        </button>
    `;
    ul.appendChild(li);
}
    function handleImageUpload(i){ const r=new FileReader(); r.onload=e=>{ document.getElementById('p_imagePreview').src=e.target.result; document.getElementById('p_imageFinal').value=e.target.result; }; if(i.files[0]) r.readAsDataURL(i.files[0]); }
    function updateDefaultImage(){ if(!document.getElementById('p_imageFinal').value) document.getElementById('p_imagePreview').src = document.querySelector('input[name="gender"]:checked').value==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = msg; c.appendChild(t); setTimeout(()=>t.remove(), 3000); }
    function copyToClipboard(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÅ‡∏•‡πâ‡∏ß'); }
    function setTheme(t) { document.body.setAttribute('data-theme', t); state.currentTheme=t; saveState(); }

    // ================= PAN & ZOOM FIXES (VERIFIED SMOOTH DRAGGING) =================
    function setupPanZoom() { 
        const c = document.getElementById('canvas-container'); 
        
        // MOUSE DOWN: Start Dragging, prevent default browser behavior (e.g., text selection)
        c.addEventListener('mousedown',e=>{ 
            // Only start drag if clicking on the main SVG or the viewport group (not a node or control)
            if(e.target.id!=='main-svg' && e.target.id!=='viewport-group') return; 
            e.preventDefault(); 
            state.isDragging=true; 
            state.startX=e.clientX-state.panX; 
            state.startY=e.clientY-state.panY; 
        }); 
        
        // MOUSE UP: Stop Dragging
        window.addEventListener('mouseup',()=>{
            state.isDragging=false;
        }); 
        
        // MOUSE MOVE: Dragging action
        window.addEventListener('mousemove',e=>{ 
            if(!state.isDragging)return; 
            e.preventDefault(); // Prevents cursor change/jerkiness during drag (fixes lag/bug)
            state.panX=e.clientX-state.startX; 
            state.panY=e.clientY-state.startY; 
            updateTrans(); 
        }); 
        
        // WHEEL: Zooming
        c.addEventListener('wheel',e=>{ 
            e.preventDefault(); 
            state.zoom = Math.min(Math.max(0.1, state.zoom + (-e.deltaY*0.001)), 5); 
            updateTrans(); 
        }, {passive:false}); 
    }

    function updateTrans(){ document.getElementById('viewport-group').setAttribute("transform", `translate(${state.panX},${state.panY}) scale(${state.zoom})`); }
    function zoomIn(){ state.zoom *= 1.2; updateTrans(); }
    function zoomOut(){ state.zoom /= 1.2; updateTrans(); }
    function resetView(){ 
        // Get viewport size
        const canvas = document.getElementById('canvas-container');
        const vw = canvas.clientWidth;
        
        state.zoom=1; 
        state.panX=vw/2 - BASE_CONFIG.nodeWidth/2; 
        state.panY=50; 
        updateTrans(); 
    }
    function toggleOrientation(){ state.isHorizontal=!state.isHorizontal; renderTree(); resetView(); }
   function showHistoryModal(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;
    if (!p.titleHistory || p.titleHistory.length === 0) recordTitleHistory(p);
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    p.titleHistory.forEach((h, index) => {
        const item = document.createElement('div');
        item.className = "relative pl-8 border-l-2 border-slate-100 pb-4 last:pb-0 group";
        item.innerHTML = `
            <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-200 border-2 border-white"></div>
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-500 inline-block mb-1">‡∏™‡∏°‡∏±‡∏¢${h.reign}</div>
                    <div class="text-sm font-bold text-slate-700 leading-snug">${h.title}</div>
                </div>
                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                    <button onclick="openGazetteModal('${p.id}', ${index})" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded-lg" title="‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®">
                        <i class="fa-solid fa-file-signature text-xs"></i>
                    </button>
                    <button onclick="deleteHistoryEntry('${p.id}', ${index})" class="p-1.5 text-red-300 hover:text-red-500" title="‡∏•‡∏ö">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                </div>
            </div>
        `;
        list.appendChild(item);
    });
    document.getElementById('historyModal').classList.add('active');
}
function deleteHistoryEntry(personId, index) {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

    const p = state.members.find(m => m.id === personId);
    if (p && p.titleHistory) {
        p.titleHistory.splice(index, 1);
        saveState();
        showHistoryModal(personId); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö
        showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }
}
// ============================================================
// THE SUPREME ROYAL ENGINE 2025 - FINAL INTEGRATED (V27)
// ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏é: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå | ‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå | ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á | ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°/‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà | ‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ | ‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå
// ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: HYBRID COMMAND MODE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©: SMART SPOUSE SELECTION + AUTO-TRANSITION (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
// ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° | ‡∏¢‡∏®‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£ (Sticky Rank) | ‡πÅ‡∏°‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏û‡πà‡∏≠ | Dropdown Guard
// ============================================================

/**
 * 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
/**
 * 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
 */
function getCurrentMonarch() {
    return state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
}

/**
 * 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏® (Rank), ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (Prefix) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Supreme Royal Engine V27)
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° | ‡∏¢‡∏∂‡∏î‡∏™‡∏≤‡∏¢‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (Patrilineal) | ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏®‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ (Sticky Rank)
 */
function calculateChildRank(fatherId, motherId, gender, birthYearInput) {
    // === ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===
    const mother = state.members.find(m => m.id === motherId);
    const father = state.members.find(m => m.id === fatherId);
    const isMale = gender === 'M';
    const bYear = birthYearInput ? parseInt(birthYearInput) : null;
    const currentPersonId = document.getElementById('p_id')?.value;
    const currentPerson = state.members.find(m => m.id === currentPersonId);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 0: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏¢‡∏® ---
    const rankWeight = {
        "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©)": 10, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 10, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 9, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 8,
        "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 7, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 6, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 5,
        "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 4, "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå": 3, "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á": 2, "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô": 1
    };

    let result = {
        royalRank: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô',
        titlePrefix: isMale ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß',
        relationship: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô',
        royalSurname: father?.royalSurname || '',
        surname: father ? (father.surname || "") : ""
    };

    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
    if (mother && mother.isResigned) {
        return result; 
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: Sticky Rank (‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏®‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ---
    const isMonarchChecked = document.getElementById('p_isMonarch')?.checked;
    if (isMonarchChecked || (currentPerson && currentPerson.isMonarch)) {
        return {
            royalRank: document.getElementById('p_royalRank').value,
            titlePrefix: document.getElementById('p_titlePrefix').value,
            relationship: "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå",
            royalSurname: document.getElementById('p_royalSurnameInput')?.value || '',
            surname: document.getElementById('p_commonerSurnameInput')?.value || ''
        };
    }

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    const currentMonarch = getCurrentMonarch();
    const monarchId = currentMonarch?.id;
    const monarchFatherId = currentMonarch?.fatherId;
    const monarchMotherId = currentMonarch?.motherId;
    const monarchBirthYear = currentMonarch?.birthYear ? parseInt(currentMonarch.birthYear) : 0;
    const isMotherSovereign = mother && mother.isMonarch;

    const fW = father ? (rankWeight[father.royalRank] || 1) : 1;
    const mW = mother ? (rankWeight[mother.royalRank] || 1) : 1;
    const fPrefix = father?.titlePrefix || "";

    // =========================================================================
    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• ‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå / ‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå / ‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå] ---
    // --- (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏é‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ Sticky Rank) ---
    // =========================================================================
    if (father) {
        const fPre = father.titlePrefix || "";
        const fRank = father.royalRank || "";
        const mIsRoyal = mother && (mW >= 4); // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)
        const isMotherCommoner = !mIsRoyal;

        // 1. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" (‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤... ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤...)
        if (fPre.includes("‡∏õ‡∏£‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            if (mIsRoyal) {
                // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" (‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå)
                if (fRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                    return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                } else {
                    return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                }
            } else {
                // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
                return { royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
            }
        }

        // 2. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
        else if (fPre.includes("‡∏™‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            if (mIsRoyal) {
                // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" (‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå)
                if (fRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                    return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                } else {
                    return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                }
            } else {
                return { royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
            }
        }

        // 3. ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
        else if (fPre.includes("‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
            if (mIsRoyal) {
                // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" (‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå)
                if (fRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                    return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                } else {
                    return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
                }
            } else {
                return { royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", royalSurname: result.royalSurname, surname: "" };
            }
        }
    }

    // =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó/‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ---
    // =========================================================================
    const isChildOfMonarch = (fatherId && fatherId === monarchId) || (motherId && motherId === monarchId);
    
    if (isChildOfMonarch || isMotherSovereign) {
        result.relationship = isMale ? '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™' : '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤';
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å/‡πÇ‡∏ó ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
        const otherParent = (fatherId === monarchId || (motherId === monarchId && mother.isMonarch)) ? mother : father;
        const otherRankScore = otherParent ? (rankWeight[otherParent.royalRank] || 1) : 1;
        
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏¢‡∏®‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (score >= 5) ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ -> ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤
        if (otherRankScore >= 5) { 
            const spouseName = otherParent?.name || "";
            const spouseFullTitle = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(otherParent) : "";
            const combinedName = (spouseName + spouseFullTitle);
            const ekKeywords = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
            const isEk = ekKeywords.some(kw => combinedName.includes(kw)) || combinedName.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ");

            if (isEk) {
                result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            } else {
                result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            }
            result.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
        } else {
            // ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á)
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
        }
        return result;
    }

    // =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏£‡∏∞‡∏ö‡∏ö AUTO-TRANSITION (‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå) ---
    // =========================================================================
    // [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà: ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà ‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á
    const isFatherMatch = father && monarchFatherId && String(father.id) === String(monarchFatherId);
    const isMotherMatch = mother && monarchMotherId && String(mother.id) === String(monarchMotherId);
    const isSiblingOfMonarch = (isFatherMatch || isMotherMatch);

    if (isSiblingOfMonarch && monarchId && currentPersonId !== monarchId) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
        const isSameMother = mother && monarchMotherId && String(mother.id) === String(monarchMotherId);
        
        // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå -> ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤
        const isMotherHighRoyal = mother && (mW >= 8);
        
        result.relationship = isSameMother ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤";
        let ageLabel = (bYear && monarchBirthYear > 0) ? (bYear < monarchBirthYear ? (isMale ? "‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") : (isMale ? "‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠")) : (isMale ? "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠");

        if (isMotherHighRoyal || isSameMother) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = (isSameMother ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞") + ageLabel;
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = (isSameMother ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤" : "‡∏û‡∏£‡∏∞") + ageLabel; 
        }
        return result;
    }

// =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: Logic ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á ---
    // =========================================================================
    // [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡∏ô‡∏¥‡∏¢‡∏≤‡∏° isPastMonarch ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÅ‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢
    const isPastMonarchFather = father && father.isMonarch && (father.id !== monarchId);
    const isPastMonarchMother = mother && mother.isMonarch && (mother.id !== monarchId);
    const isPastMonarch = isPastMonarchFather || isPastMonarchMother;

    if (father && (father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤" || father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á")) {
        // ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏î‡∏µ‡∏ï (‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7)
        if (!isPastMonarch) {
            const isWangNa = father.relationship === "‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤";
            const royalSurname = father.royalSurname || "";
            
            const isMotherCommoner = !mother || 
                                     mother.royalRank === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" || 
                                     mother.relationship === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" ||
                                     mother.royalRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå" ||
                                     mother.royalRank === "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á";

            if (isMotherCommoner) {
                 return { 
                    royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
                    titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤", 
                    relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", 
                    royalSurname, 
                    surname: "" 
                };
            } else {
                // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤
                if (isWangNa) {
                    const has7Tier = father.hasUmbrella && (father.umbrellaType === "‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£");
                    const isChaoFa = (fW >= 8 && mW >= 8); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤+‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

                    if (isChaoFa) {
                        // === ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ) ===
                        if (has7Tier) {
                             // [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡πÑ‡∏î‡πâ‡∏â‡∏±‡∏ï‡∏£ 7 ‡∏ä‡∏±‡πâ‡∏ô ‡∏•‡∏π‡∏Å‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤+‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
                             return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                        } else {
                             // [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏â‡∏±‡∏ï‡∏£ 7 ‡∏ä‡∏±‡πâ‡∏ô ‡∏•‡∏π‡∏Å‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤+‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
                             return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                        }
                    } else {
                        // === ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó) ===
                        if (has7Tier) {
                             return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                        }
                        return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                    }
                } else { // ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á
                    if (fW >= 8 && mW >= 8) {
                        return { royalRank: "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)", titlePrefix: "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                    }
                    return { royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)", titlePrefix: "‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", relationship: "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå", royalSurname, surname: "" };
                }
            }
        }
    }

    // =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7: Logic ‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï (‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå) ---
    // =========================================================================
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤
    if (isPastMonarch) {
        result.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
        
        let isChaoFa = false;
        let isSpecialChaoFa = false; // ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å

        if (isPastMonarchFather) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡πÄ‡∏î‡∏¥‡∏°)
            const motherName = mother?.name || "";
            const motherFullTitle = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(mother) : "";
            const combinedName = (motherName + motherFullTitle);

            const ekKeywords = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
            const isEk = ekKeywords.some(kw => combinedName.includes(kw)) || combinedName.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ");
            const isPhraPanayaChao = (mW >= 5); // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)

            if (isEk) isSpecialChaoFa = true;
            else if (isPhraPanayaChao) isChaoFa = true;

        } else if (isPastMonarchMother) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡πÄ‡∏î‡∏¥‡∏°) -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏®‡∏û‡πà‡∏≠
            // ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ) -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤
            // ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå+‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)
            const isFatherRoyal = (fW >= 5); // ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            if (isFatherRoyal) {
                isChaoFa = true; 
                // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô isSpecialChaoFa ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            }
        }

        if (isSpecialChaoFa) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        } else if (isChaoFa) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
        return result;
    }

    // =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1.5: ‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå) ---
    // =========================================================================
    const isFatherSibling = father && (
        (monarchFatherId && father.fatherId === monarchFatherId) || 
        (monarchMotherId && father.motherId === monarchMotherId)
    );
    const isMotherSibling = mother && (
        (monarchFatherId && mother.fatherId === monarchFatherId) || 
        (monarchMotherId && mother.motherId === monarchMotherId)
    );

    if ((isFatherSibling || isMotherSibling) && !isChildOfMonarch) {
        result.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        
        if (isFatherSibling) {
            // === ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ===
            if (father.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                if (mother && mother.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
                    result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                    result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                } else if (mW >= 4) { // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤
                    result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                    result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                } else { // ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
            } else if (father.royalRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) {
                if (mW >= 4) { 
                    result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                    result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                } else { 
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
            }
        } else if (isMotherSibling) {
             // === ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ===
             if (father && father.titlePrefix === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠") {
                result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            } else {
                result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            }
        }
        return result; 
    }

    // =========================================================================
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠) ---
    // =========================================================================
    const isGrandchildOfMonarch = (father && (father.fatherId === monarchId || father.motherId === monarchId)) ||
                                  (mother && (mother.fatherId === monarchId || mother.motherId === monarchId));

    if (isGrandchildOfMonarch) {
        const fRank = father ? father.royalRank : '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const mRank = mother ? mother.royalRank : '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const fScore = rankWeight[fRank] || 1;
        const mScore = rankWeight[mRank] || 1;

        if (fRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') && mRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            result.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            return result;
        }
        if (fScore >= 5 && (mScore >= 4 && mScore <= 7)) {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
            result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            result.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            return result;
        }
        if (fScore >= 5 && mScore === 1) {
            result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            result.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
            return result;
        }
        if (fScore === 4) {
            result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
            result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
            result.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            return result;
        }
    }

    let isAlreadyPromoted = false;
    if (currentPerson && (currentPerson.royalRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") || currentPerson.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || currentPerson.royalRank.includes("‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå"))) {
        isAlreadyPromoted = true;
        result.royalRank = currentPerson.royalRank;
        result.titlePrefix = currentPerson.titlePrefix;
        result.relationship = currentPerson.relationship;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏Å‡∏é‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ---
    const isFatherCommoner = !father || (father.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || father.titlePrefix === '‡∏ô‡∏≤‡∏¢');
    const isMotherRoyal = mother && (mW > 1);

    if (isFatherCommoner && isMotherRoyal && !isAlreadyPromoted) {
        // [‡∏£‡∏∞‡∏ß‡∏±‡∏á] ‡∏ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (Past/Current) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏π‡∏Å return ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
        result.relationship = '‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ó‡∏£‡∏á‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå)';
        return result; 
    }

    if (!father && !mother) return result;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 8: ‡∏Å‡∏é‡∏•‡∏π‡∏Å‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á) ---
    // (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
    if (father && !isChildOfMonarch && !isSiblingOfMonarch && !isGrandchildOfMonarch && !isPastMonarch) {
        const fTitle = father.titlePrefix || "";
        const isMotherCommoner = !mother || (mother.royalRank === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" || mother.relationship === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô");

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á ‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isPalaceLineFather = (
            fTitle.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || 
            fTitle.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
            fTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå") ||
            fTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
            fTitle.includes("‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") ||
            fTitle.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")
        );

         // ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á (‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤)
        if (isPalaceLineFather) {
            if (isMotherCommoner) {
                return {
                    royalRank: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤",
                    titlePrefix: "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤",
                    relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
                    royalSurname: father.royalSurname || "",
                    surname: ""
                };
            } else {
                 return {
                    royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)",
                    titlePrefix: "‡∏û‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
                    relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå",
                    royalSurname: father.royalSurname || "",
                    surname: ""
                };
            }
        }
        
        // ‡∏™‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå‡∏õ‡∏Å‡∏ï‡∏¥
        if (fW >= 4 && !isAlreadyPromoted) {
            result.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
             const isFatherPromotedFromMC = father.titleHistory && father.titleHistory.some(h => h.rank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') && father.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)');

            if (isFatherPromotedFromMC) {
                result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
                result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
                result.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
                return result;
            }

            if (father.royalRank === '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)') {
                result.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
                if (mW >= 8 || mW === 1) { 
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                } 
                else if (mW >= 4) { 
                    result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                    result.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                }
                return result;
            }

            if (fW >= 8 && (fPrefix.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤"))) {
                if (mW >= 8) { 
                    result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                    if (fPrefix.includes("‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")|| fPrefix.includes("‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠")) {
                        result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                    } else {
                        result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                    }
                }
                else if (mW >= 4) { 
                    if (fPrefix.includes("‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠")) {
                        result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                        result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                    } else {
                        result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                        result.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                    }
                } 
                else { 
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
                return result;
            }

            if (fW >= 5 && (fPrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"))) {
                if (mW >= 8) { 
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
                else if (mW >= 5) { 
                    if (fPrefix.includes("‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠") || fPrefix.includes("‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠")) {
                        result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                        result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                    } else { 
                        result.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
                        result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"; 
                    }
                }
                else { 
                    result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                    result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                }
                return result;
            }

            if (fPrefix.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠") && !fPrefix.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) { 
                result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
                result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
                result.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            }
            else if (fW === 4) { 
                result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
                result.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå';
                result.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
            }
            else { 
                result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
                result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            }
            return result;
        }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 9: Default ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏™‡∏∑‡∏ö‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• ---
    if (father && !isAlreadyPromoted) {
        if (father.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || fW === 3) {
            result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á";
            result.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á';
            result.relationship = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô";
        }
    }

    return result;
}
 
function handleParentSelection() {
    const type = document.getElementById('modalType').value;
    const otherSearchInput = document.getElementById('p_otherSearch');
    const otherIdInput = document.getElementById('p_otherId');

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    validateParent('other');

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (ID) ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏®‡∏•‡∏π‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (otherIdInput.value) {
        autoFillRank(); 
        
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô Dropdown ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏®‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
        updatePrefixOptions();
        updateSuffixOptions();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ "‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á... ‡∏Å‡∏±‡∏ö..."
        updateChildModalTitle(); 
    }
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î otherSearchInput.value = ''; ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ
}
/**
 * 5. HYBRID UI LOGIC - AUTO FILL
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 */
/**
 * 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô UI (Pop-up ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å)
 */
function autoFillRank() {
    const relSelect = document.getElementById('p_relationship');
    // --- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
    if (relSelect.value === '‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á') return;

    const fId = document.getElementById('p_fatherId').value;
    const mId = document.getElementById('p_motherId').value;
    const gender = document.querySelector('input[name="gender"]:checked')?.value || 'M';
    const isMonarchChecked = document.getElementById('p_isMonarch').checked; 

    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏≠‡∏á
    if (isMonarchChecked) {
        document.getElementById('p_royalRank').value = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
        document.getElementById('p_relationship').value = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå";
        
        const prefix = (gender === 'F') ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞";
        const prefixDropdown = document.getElementById('p_titlePrefix');
        
        if (!Array.from(prefixDropdown.options).some(opt => opt.value === prefix)) {
            prefixDropdown.add(new Option(prefix, prefix));
        }
        prefixDropdown.value = prefix;
        
        updateSuffixOptions();
        return; 
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏® (‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏é‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    const auto = calculateChildRankGeneric(fId, mId, gender);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô UI
    document.getElementById('p_relationship').value = auto.relationship;
    updatePrefixOptions();
    
    const prefixDropdown = document.getElementById('p_titlePrefix');
    if (!Array.from(prefixDropdown.options).some(opt => opt.value === auto.titlePrefix)) {
        const newOpt = new Option(auto.titlePrefix, auto.titlePrefix);
        prefixDropdown.add(newOpt);
    }
    prefixDropdown.value = auto.titlePrefix;
    document.getElementById('p_royalRank').value = auto.royalRank;
    document.getElementById('p_royalSurnameInput').value = auto.royalSurname || '';
    
    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ---
    const surnameInput = document.getElementById('p_surnameInput');
    if (surnameInput) {
        // ‡∏´‡∏≤‡∏Å auto.surname ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ (‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì) ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
        surnameInput.value = auto.surname || '';
    }
    // ---------------------------------------------------------

    updateSuffixOptions();
}
/**
 * 7. CORE LOGIC ENGINE (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1)
 */
function calculateChildRankGeneric(fatherId, motherId, gender) {
    const father = state.members.find(m => m.id === fatherId);
    const mother = state.members.find(m => m.id === motherId);
    const bYear = document.getElementById('p_birthYear')?.value || null;

    // --- [‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°] ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏´‡∏ç‡∏¥‡∏á ---
    const isMotherHeir1 = mother && mother.isHeir && parseInt(mother.heirOrder) === 1;

    if (isMotherHeir1) {
        const fRank = father ? (father.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') : '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const fPrefix = father ? (father.titlePrefix || '') : '';

        if (fRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
            return {
                royalRank: '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)',
                titlePrefix: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                relationship: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        } 
        else if (fRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
            return {
                royalRank: '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)',
                titlePrefix: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                relationship: '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        }
        else {
            return {
                royalRank: '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤',
                titlePrefix: '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤',
                relationship: '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå',
                royalSurname: mother.royalSurname || '',
                surname: ''
            };
        }
    }

    // =========================================================================
    // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ] ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå) + ‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô + ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    // =========================================================================
    if (father && father.royalRank === "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)" && !father.isMonarch) {
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á ‡∏°.‡∏£.‡∏ß. / ‡∏°.‡∏•. / ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
        const isMomCommoner = !mother || 
                              mother.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || 
                              mother.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || 
                              mother.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (ID ‡πÅ‡∏°‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏û‡πà‡∏≠‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        const isRegistered = (father.registeredSpouseId === motherId);

        if (isMomCommoner && isRegistered) {
            return {
                royalRank: "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)",
                titlePrefix: "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠",
                relationship: "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå", 
                royalSurname: father.royalSurname || "",
                surname: ""
            };
        }
    }
    // =========================================================================

    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏é‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏é‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    return calculateChildRank(fatherId, motherId, gender, bYear);
}

// ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì - ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
document.getElementById('p_isMonarch').addEventListener('change', autoFillRank);
document.getElementById('p_fatherSearch').addEventListener('input', () => handleParentSelection('father'));
document.getElementById('p_motherSearch').addEventListener('input', () => handleParentSelection('mother'));
document.querySelectorAll('input[name="gender"]').forEach(el => el.addEventListener('change', autoFillRank));
document.getElementById('p_birthYear').addEventListener('input', autoFillRank);
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á
 * @param {string} id - ID ‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
 */
function editPersonDirect(id) {
    const person = state.members.find(m => m.id === id);
    if (person) {
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PID ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
        window.curPID = id;
        
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Edit ‡πÄ‡∏õ‡πá‡∏ô true
        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        openModal(person, true, `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${person.name}`);
    } else {
        showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
    }
}
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏¥‡∏ò‡∏µ‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å
 * 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞..."
 * 2. ‡∏ï‡∏¥‡πä‡∏Å‡∏â‡∏±‡∏ï‡∏£ 9 ‡∏ä‡∏±‡πâ‡∏ô (‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å
 */
function performCoronation() {
    const p = state.members.find(m => m.id === window.curPID);
    if (!p || !p.isMonarch) return;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏¥‡∏ò‡∏µ‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å ${p.name}?`)) return;

    // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó" ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
    if (p.titlePrefix.startsWith("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞")) {
        p.titlePrefix = p.titlePrefix.replace("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞", "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞");
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏Å‡∏é
        p.titlePrefix = (p.gender === 'F') ? "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ" : "‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞";
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏¢‡∏®/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å ---
    p.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå"; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)"; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)
    p.titleSuffix = "‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß";      // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    p.kromRank = "";                // ‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏®‡∏Å‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    p.kromTitle = "";               // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    p.surname = "";                 // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)
    p.isHeir = false;               // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó
    p.isQueenConsort = false;       // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á)
    // ------------------------------------------------------

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏â‡∏±‡∏ï‡∏£ 9 ‡∏ä‡∏±‡πâ‡∏ô (‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£)
    p.hasUmbrella = true;
    p.umbrellaType = "‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 7 ‡∏ä‡∏±‡πâ‡∏ô ‡πÄ‡∏õ‡πá‡∏ô 9 ‡∏ä‡∏±‡πâ‡∏ô
    p.isCoronated = true;

    // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏®‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏®)
    if (p.registeredSpouseId) {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å queen ‡πÄ‡∏õ‡πá‡∏ô spouse ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏ç‡∏¥‡∏á
        const spouse = state.members.find(s => s.id === p.registeredSpouseId);
        if (spouse && spouse.isAlive) {
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ç‡∏¥‡∏á" (Queen) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (spouse.gender === 'F') {
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ -> ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤... ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ
                spouse.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤";
                spouse.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ";
                spouse.isQueenConsort = true;
                
                recordTitleHistory(spouse); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                triggerHierarchyPromotion(spouse.id, spouse.royalRank, getFullDisplayTitle(spouse));
            }
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÄ‡∏õ‡πá‡∏ô "‡∏ä‡∏≤‡∏¢" (‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç if ‡∏ô‡∏µ‡πâ 
            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏®‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        }
    }

    recordTitleHistory(p);
    saveState();
    showDetail(p.id);
    updateApp();
}

function toggleRadio(radio) {
    const targetSpouseId = radio.value;
    const currentPersonId = document.getElementById('p_id').value;
    
    // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" (Uncheck) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (radio.getAttribute('data-checked') === 'true') {
        radio.checked = false;
        radio.setAttribute('data-checked', 'false');
        return;
    }

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ (Target) ‡πÑ‡∏õ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const targetSpouse = state.members.find(m => m.id === targetSpouseId);
    if (targetSpouse && targetSpouse.registeredSpouseId && targetSpouse.registeredSpouseId !== currentPersonId) {
        const otherPerson = state.members.find(m => m.id === targetSpouse.registeredSpouseId);
        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${targetSpouse.name} ‡πÑ‡∏î‡πâ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö ${otherPerson ? otherPerson.name : '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏∑‡πà‡∏ô'} ‡πÅ‡∏•‡πâ‡∏ß`);
        radio.checked = false;
        return;
    }

    // 3. ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Radio ‡∏õ‡∏Å‡∏ï‡∏¥
    const name = radio.getAttribute('name');
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.setAttribute('data-checked', 'false'));
    
    radio.setAttribute('data-checked', 'true');
    radio.checked = true;
}

function getGazettePhrasing(rankTitle) {
    const p = {
        intro: "‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡∏£‡∏¥‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤",
        action: "‡∏à‡∏∂‡∏á‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏®",
        naming: "‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏±‡∏è‡∏ß‡πà‡∏≤",
        blessing: "‡∏Ç‡∏≠‡∏à‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏≤‡∏¢‡∏∏ ‡∏û‡∏£‡∏£‡∏ì ‡∏™‡∏∏‡∏Ç ‡∏û‡∏• ‡∏õ‡∏è‡∏¥‡∏†‡∏≤‡∏ì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏£‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ ‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏£‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡∏°‡∏á‡∏Ñ‡∏• ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏ô‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•‡∏ô‡∏≤‡∏ô ‡πÄ‡∏ó‡∏≠‡∏ç"
    };
    if (rankTitle.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
        p.intro = "‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏™‡∏∑‡∏ö‡∏°‡∏≤‡πÅ‡∏ï‡πà‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏î‡πá‡∏à‡πÄ‡∏ñ‡∏•‡∏¥‡∏á‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡πà‡∏≠‡∏°‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡∏≤‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå ‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡∏£‡∏¥‡∏ß‡πà‡∏≤";
        p.action = "‡∏à‡∏∂‡∏á‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°";
        p.naming = "‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏±‡∏è‡∏ß‡πà‡∏≤";
        p.blessing = "‡∏Ç‡∏≠‡∏à‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏≤‡∏¢‡∏∏ ‡∏û‡∏£‡∏£‡∏ì ‡∏™‡∏∏‡∏Ç ‡∏û‡∏• ‡∏õ‡∏è‡∏¥‡∏†‡∏≤‡∏ì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏£‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ ‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏£‡∏¥‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡∏°‡∏á‡∏Ñ‡∏• ‡∏ß‡∏¥‡∏ö‡∏∏‡∏•‡∏®‡∏∏‡∏†‡∏ú‡∏• ‡∏™‡∏Å‡∏•‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏® ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏ô‡∏≤‡∏ô ‡∏ï‡∏•‡∏≠‡∏î‡∏à‡∏¥‡∏£‡∏±‡∏è‡∏ê‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏• ‡πÄ‡∏ó‡∏≠‡∏ç";
    } else if (rankTitle.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤")) {
        p.intro = "‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡∏£‡∏¥‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ‡πÅ‡∏ï‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤ ‡∏ó‡∏£‡∏á‡πÄ‡∏Å‡∏∑‡πâ‡∏≠‡∏Å‡∏π‡∏•‡πÅ‡∏Å‡πà‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡∏≤‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏á‡∏£‡∏±‡∏Å‡∏†‡∏±‡∏Å‡∏î‡∏µ ‡∏™‡∏ô‡∏≠‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏î‡∏ä‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå";
        p.action = "‡∏à‡∏∂‡∏á‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏®";
        p.naming = "‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏±‡∏è‡∏ß‡πà‡∏≤";
    } else if (rankTitle.includes("‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤")) {
        p.intro = "‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡∏£‡∏¥‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤";
        p.action = "‡∏à‡∏∂‡∏á‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÄ‡∏õ‡πá‡∏ô";
        p.naming = "‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤";
        p.blessing = "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏∑‡∏ö‡πÑ‡∏õ";
    }
    return p;
}

function openGazetteModal(personId, index) {
    const p = state.members.find(m => m.id === personId);
    if (!p || !p.titleHistory[index]) return;
    const entry = p.titleHistory[index];

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    const historyMonarch = state.members.find(m => 
        m.isMonarch && `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` === entry.reign
    );

    const phrasing = getGazettePhrasing(entry.title);
    const monarchHead = historyMonarch ? getFullDisplayTitle(historyMonarch).replace("‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß", "").trim() : "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå";

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ
    document.getElementById('gz_monarch_head').innerText = monarchHead;
    document.getElementById('gz_monarch_body').innerText = monarchHead;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
    document.getElementById('gz_subject_name_header').innerText = entry.title;

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®
    const promotionText = entry.rank ? `‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏≥‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏® ‡πÄ‡∏õ‡πá‡∏ô ${entry.rank}` : "";
    
    // ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
    const topRankEl = document.getElementById('gz_rank_line_top');
    if(topRankEl) topRankEl.innerText = promotionText;

    // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
    const centerRankEl = document.getElementById('gz_new_rank');
    if(centerRankEl) centerRankEl.innerText = entry.title; 
    
    const rankLineEl = document.getElementById('gz_rank_line');
    if(rankLineEl) rankLineEl.innerText = promotionText;

    // ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (INTRO, ACTION, Naming, Blessing)
    document.getElementById('gz_intro_text').innerText = phrasing.intro;
    document.getElementById('gz_action_text').innerText = phrasing.action;
    document.getElementById('gz_naming_text').innerText = phrasing.naming;
    document.getElementById('gz_blessing_text').innerText = phrasing.blessing;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    document.getElementById('gz_day_num').innerText = toThaiNumerals(new Date().getDate());
    document.getElementById('gz_month').innerText = thaiMonths[new Date().getMonth()];
    document.getElementById('gz_year').innerText = toThaiNumerals(entry.year);
    document.getElementById('gz_full_date').innerText = `${toThaiNumerals(new Date().getDate())} ${thaiMonths[new Date().getMonth()]} ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä ${toThaiNumerals(entry.year)}`;
    
    const reignYear = historyMonarch ? (entry.year - parseInt(historyMonarch.reignStart) + 1) : 1;
    document.getElementById('gz_reign_year').innerText = toThaiNumerals(reignYear);
    
    document.getElementById('gz_volume').innerText = toThaiNumerals(136);
    document.getElementById('gz_part').innerText = toThaiNumerals(15 + index);
    document.getElementById('gazetteModal').classList.add('active');
}

function downloadGazettePNG() {
    const area = document.getElementById('gazettePrintArea');
    html2canvas(area, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Gazette_${document.getElementById('gz_subject_name_header').innerText}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showToast("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏≤‡∏ä‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏ô‡∏∏‡∏Å‡∏¥‡∏à‡∏à‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®");
    });
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (BE -> AD -> DayOfWeek)
 */
/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡∏û.‡∏®. 1)
 */
function autoCalcDayOfWeek(type) {
    const q = parseInt(document.getElementById(`p_${type}Day`).value);
    const mInput = parseInt(document.getElementById(`p_${type}Month`).value);
    const yearBE = parseInt(document.getElementById(`p_${type}Year`).value);

    if (q && mInput && yearBE >= 1) {
        let y = yearBE - 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
        let m = mInput;

        // ‡∏™‡∏π‡∏ï‡∏£ Zeller's Congruence
        if (m < 3) {
            m += 12;
            y -= 1;
        }
        const K = y % 100;
        const J = Math.floor(y / 100);
        let h = (q + Math.floor((13 * (m + 1)) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) - (2 * J)) % 7;
        
        if (h < 0) h = (h + 7) % 7;

        // 0=‡πÄ‡∏™‡∏≤‡∏£‡πå, 1=‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå, ...
        const daysTh = ['‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå'];
        document.getElementById(`p_${type}DayOfWeek`).value = daysTh[h];
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà
    calculateLivingAge();
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏°‡∏£‡∏ì‡∏∞ - ‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥)
 */
function calculateLivingAge() {
    const bYear = parseInt(document.getElementById('p_birthYear').value);
    const dYear = parseInt(document.getElementById('p_deathYear').value);
    const isAlive = document.getElementById('p_isAlive').checked; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å checkbox "‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà"
    const display = document.getElementById('p_calc_age_display');

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà OR ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î/‡∏ï‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏á (-)
    if (isAlive || !bYear || !dYear) {
        display.innerText = "-"; 
        return;
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß
    let age = dYear - bYear;
    const result = age >= 0 ? age : 0;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toThaiNumerals)
    display.innerText = (typeof toThaiNumerals === 'function') ? toThaiNumerals(result) : result;
}

document.getElementById('p_isAlive').addEventListener('change', function() {
    if (!this.checked) {
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å (‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï) ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏µ‡∏°‡∏£‡∏ì‡∏∞‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£
        if (!document.getElementById('p_deathYear').value) {
            document.getElementById('p_deathDay').value = state.worldTime.day;
            document.getElementById('p_deathMonth').value = state.worldTime.month;
            document.getElementById('p_deathYear').value = state.worldTime.year;
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (typeof autoCalcDayOfWeek === 'function') autoCalcDayOfWeek('death');
        }
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
        document.getElementById('p_deathDay').value = '';
        document.getElementById('p_deathMonth').value = '';
        document.getElementById('p_deathYear').value = '';
        document.getElementById('p_deathDayOfWeek').value = '';
    }
    // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal ‡πÉ‡∏´‡∏°‡πà
    calculateLivingAge();
});






function setTimeMultiplier(m) {
    state.worldTime.multiplier = m;
    [1, 10, 100].forEach(s => {
        const btn = document.getElementById('speed' + s);
        if(btn) btn.className = `text-[8px] px-1.5 py-0.5 rounded font-bold ${m === s ? 'bg-indigo-500' : 'bg-slate-700'}`;
    });
}

function toggleTimePlay() {
    // 1. ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô state
    state.worldTime.isRunning = !state.worldTime.isRunning;
    
    const btn = document.getElementById('btnTimePlay');

    if (state.worldTime.isRunning) {
        // --- ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô ---
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° Pause (‡∏´‡∏¢‡∏∏‡∏î)
        btn.innerHTML = '<i class="fa-solid fa-pause text-[9px]"></i>';
        
        // ‡∏•‡πâ‡∏≤‡∏á Interval ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
        if (timeTicker) clearInterval(timeTicker);
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô tick ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
        timeTicker = setInterval(tick, state.worldTime.baseTickMs);
        
        showToast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ‚ú®");
    } else {
        // --- ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á: ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î ---
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° Play (‡πÄ‡∏•‡πà‡∏ô)
        btn.innerHTML = '<i class="fa-solid fa-play text-[9px]"></i>';
        
        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á tick
        clearInterval(timeTicker);
        timeTicker = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£

        saveState();
        
        showToast("‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß");
    }
saveState(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ isRunning

}

function tick() {
    const secondsToAdd = 360 * state.worldTime.multiplier; // 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏£‡∏¥‡∏á = 1 ‡∏ä‡∏°. ‡∏£‡∏∞‡∏ö‡∏ö
    let t = state.worldTime;
    t.second += secondsToAdd;

    // ‡∏£‡∏∞‡∏ö‡∏ö Cascade ‡πÄ‡∏ß‡∏•‡∏≤
    if (t.second >= 60) { t.minute += Math.floor(t.second / 60); t.second %= 60; }
    if (t.minute >= 60) { t.hour += Math.floor(t.minute / 60); t.minute %= 60; }
    if (t.hour >= 24) { t.day += Math.floor(t.hour / 24); t.hour %= 24; checkDailyEvents(); 

     saveState();          

    }

    if (t.day > 30) { t.month += 1; t.day = 1; }
    if (t.month > 12) { t.year += 1; t.month = 1; addHistoryLog(`‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà ‡∏û.‡∏®. ${toThaiNumerals(t.year)}`); 

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Detail ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        updateLiveAgeDisplay();
        
    }


    updateTimeUI();
}

function updateTimeUI() {
    const t = state.worldTime;
    const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    document.getElementById('displayYear').innerText = toThaiNumerals(t.year);
    document.getElementById('displayMonth').innerText = months[t.month - 1];
    document.getElementById('displayDay').innerText = toThaiNumerals(t.day);
    const pad = (n) => toThaiNumerals(n.toString().padStart(2, '0'));
    document.getElementById('displayHour').innerText = pad(t.hour);
    document.getElementById('displayMinute').innerText = pad(t.minute);
    document.getElementById('displaySecond').innerText = pad(t.second);
}

function checkDailyEvents() {
    state.members.forEach(m => {
        if (!m.isAlive) return;
        const currentAge = state.worldTime.year - parseInt(m.birthYear);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢
        if (m.deathAge && currentAge >= m.deathAge) {
            m.isAlive = false;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏°‡∏£‡∏ì‡∏∞‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ---
            m.deathDay = state.worldTime.day;
            m.deathMonth = state.worldTime.month;
            m.deathYear = state.worldTime.year;

            addHistoryLog(`${getFullDisplayTitle(m)} ‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢ (${toThaiNumerals(m.deathAge)} ‡∏õ‡∏µ)`);
            if (m.isMonarch) handleMonarchDeath(m);
            updateApp();
        }

        // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï (0.1% ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)
        if (Math.random() < 0.001) triggerDestinyEvent(m);
    });
}

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï 100 ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
 * ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£
 */
function triggerDestinyEvent(p) {
    if (!p.destiny || !p.isAlive) return;

    const label = p.destiny.label;
    const effect = p.destiny.effect;
    let eventMsg = "";
    let isFatal = false; // ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

    // === ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏° "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï" ===
    const eventTable = {
        // --- ‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏≤‡∏¢ ---
        "‡∏û‡∏ç‡∏≤‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏´‡πå‡∏Ñ‡∏≥‡∏£‡∏≤‡∏°": "‡πÅ‡∏ú‡πà‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡∏à‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä‡∏ï‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏ö‡∏£‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏ß‡∏≤‡∏°‡∏¥‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå",
        "‡∏î‡∏≤‡∏ß‡∏ï‡∏Å‡∏≠‡∏±‡∏ö": "‡∏ñ‡∏π‡∏Å‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏Å‡∏±‡∏á‡∏â‡∏¥‡∏ô‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏©‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏±‡πà‡∏ô‡∏ó‡∏≠‡∏ô‡∏ß‡∏≤‡∏™‡∏ô‡∏≤",
        "‡∏Ç‡∏∏‡∏ô‡∏®‡∏∂‡∏Å‡πÑ‡∏£‡πâ‡∏û‡πà‡∏≤‡∏¢": "‡∏ô‡∏≥‡∏ó‡∏±‡∏û‡∏õ‡∏£‡∏≤‡∏ö‡πÇ‡∏à‡∏£‡∏õ‡πà‡∏≤‡∏£‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏ö‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ã‡πà‡∏ã‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏©‡∏é‡∏£",
        "‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏ú‡∏π‡πâ‡∏ô‡∏¥‡∏£‡∏≤‡∏®": "‡∏ô‡∏¥‡∏û‡∏ô‡∏ò‡πå‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏≠‡∏Å‡∏Ç‡∏ì‡∏∞‡∏û‡∏≥‡∏ô‡∏±‡∏Å‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏•‡∏∂‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏©‡∏à‡∏±‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£",
        "‡∏°‡∏´‡∏≤‡πÄ‡∏™‡∏ô‡∏≤‡∏ö‡∏î‡∏µ": "‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á",
        "‡∏ä‡∏≤‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏£‡∏±‡∏Å": "‡πÇ‡∏®‡∏Å‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏î‡∏û‡∏£‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏à‡∏ô‡∏õ‡∏•‡∏µ‡∏Å‡∏ß‡∏¥‡πÄ‡∏ß‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô",
        "‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤": "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏á‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏ö‡∏∏‡∏ç‡∏Å‡∏∏‡∏®‡∏•‡∏´‡∏ô‡∏∏‡∏ô‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô",
        "‡∏Ç‡∏∏‡∏ô‡∏®‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏≤‡∏£": "‡πÅ‡∏°‡πâ‡∏Å‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡∏£‡∏≤‡∏û‡∏¥‡∏ä‡∏±‡∏¢‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡∏™‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ó‡∏´‡∏≤‡∏£‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ô‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á": "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡πÉ‡∏´‡∏°‡πà ‡∏ô‡∏≥‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏´‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•",
        "‡∏Ç‡∏≠‡∏ó‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ö‡∏∏‡∏ç": "‡∏û‡∏ö‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ ‡∏ä‡∏∞‡∏ï‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏•‡∏¥‡∏Å‡∏ú‡∏±‡∏ô‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå",
        "‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏´‡∏•‡∏ß‡∏á": "‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏à‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏ç‡πà",
        "‡∏ô‡∏±‡∏Å‡πÇ‡∏ó‡∏©‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á": "‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏±‡∏á‡πÉ‡∏ô‡∏ï‡∏£‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏î‡∏°‡∏¥‡∏î ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°",
        "‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÄ‡∏≠‡∏Å‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô": "‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ù‡∏≤‡∏ú‡∏ô‡∏±‡∏á‡∏ß‡∏±‡∏î‡∏´‡∏•‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏á‡∏î‡∏á‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå",
        "‡∏Ñ‡∏ô‡∏Ç‡∏µ‡πâ‡πÇ‡∏£‡∏Ñ": "‡∏•‡πâ‡∏°‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏ô‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏Å‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡πà‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢",
        "‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤": "‡∏™‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏∏‡πà‡∏ô‡∏ß‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏¢‡πÅ‡∏î‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏∏‡∏ó‡∏ò‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î",
        "‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡∏∞": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏û‡∏£‡∏ï ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏õ‡∏£‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡∏£‡πà‡∏≤",
        "‡∏à‡∏≠‡∏°‡πÇ‡∏à‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°": "‡πÅ‡∏≠‡∏ö‡∏ô‡∏≥‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏Ç‡∏µ‡πâ‡πÇ‡∏Å‡∏á‡πÑ‡∏õ‡πÅ‡∏à‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏á",
        "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏µ‡πâ‡∏Ç‡∏•‡∏≤‡∏î": "‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏Å‡∏ï‡∏Å‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏•‡∏∏‡∏â‡∏•‡∏≠‡∏á ‡∏à‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏¥‡∏¢‡∏≤‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏ò‡∏µ‡∏´‡∏•‡∏ß‡∏á",
        "‡∏û‡∏ç‡∏≤‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏ó‡∏≠‡∏á": "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏î‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏∞‡∏ö‡∏∑‡∏≠‡πÑ‡∏Å‡∏•",
        "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏ï‡∏Å‡∏¢‡∏≤‡∏Å": "‡∏ñ‡∏π‡∏Å‡πÇ‡∏Å‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏à‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ",
        "‡∏û‡∏ç‡∏≤‡∏ô‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ": "‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡πà‡∏´‡πå‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡∏π‡∏•‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏Ø ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡πà‡∏ß‡∏á‡∏ó‡∏µ",
        "‡∏û‡∏ç‡∏≤‡∏Ñ‡∏ä‡∏™‡∏≤‡∏£": "‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏±‡∏ö‡∏¢‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏û‡∏£‡∏∞‡∏®‡∏û‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°",
        "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏≤‡πÄ‡∏õ‡πã‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ": "‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πâ‡∏û‡∏•‡∏≠‡∏á‡∏à‡∏ô‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡∏°‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡∏¢‡∏≤‡∏Å",
        "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏à‡∏≠‡∏°‡∏Å‡∏∞‡∏•‡πà‡∏≠‡∏ô": "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡∏£‡∏°‡πÇ‡∏ô‡πâ‡∏°‡∏ô‡πâ‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏®‡∏≤‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        "‡∏ï‡∏∏‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ò‡∏£‡∏£‡∏°": "‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏° ‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÄ‡∏Å‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•",
        "‡∏ó‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡∏ó‡∏±‡∏û": "‡∏´‡∏•‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡∏ó‡∏´‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏•‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏î‡∏£‡∏∞‡πÅ‡∏ß‡∏á",
        "‡∏Å‡∏ß‡∏µ‡πÄ‡∏≠‡∏Å‡∏£‡∏±‡∏ï‡∏ô‡πÇ‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡πå": "‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏ó‡πÄ‡∏û‡∏•‡∏á‡∏¢‡∏≤‡∏ß‡∏ñ‡∏ß‡∏≤‡∏¢‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏´‡∏µ‡∏ö‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥",
        "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÄ‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏†‡∏≤": "‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏•‡∏∑‡πà‡∏ô‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å",
        "‡∏à‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏ô‡πÑ‡∏ñ": "‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏©‡∏é‡∏£‡∏°‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏¥‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ",
        "‡∏ä‡∏≤‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô‡∏≠‡∏≤‡∏†‡∏±‡∏û": "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏£‡∏∏‡∏î‡πÇ‡∏ó‡∏£‡∏°‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÇ‡∏î‡∏¢‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
        "‡∏ä‡∏≤‡∏¢‡∏û‡πÄ‡∏ô‡∏à‡∏£‡∏ï‡∏≤‡∏ö‡∏≠‡∏î": "‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏™‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á ‡πÄ‡∏î‡∏¥‡∏ô‡∏ò‡∏∏‡∏î‡∏á‡∏Ñ‡πå‡πÅ‡∏ú‡πà‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏´‡∏¢‡πà‡∏≠‡∏°‡∏´‡∏ç‡πâ‡∏≤",
        "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤": "‡∏™‡∏Å‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏û‡∏¥‡∏©‡∏á‡∏π‡∏ñ‡∏ß‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏à‡∏ô‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏¢",
        "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÉ‡∏´‡∏°‡πà": "‡∏û‡∏ö‡∏ñ‡πâ‡∏≥‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•",
        "‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏≤‡∏•": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏Å‡∏±‡∏î‡πÇ‡∏à‡∏£‡∏•‡∏≠‡∏ö‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏á‡∏≤‡∏°‡∏∑‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏ä‡∏µ‡∏¢‡∏ö",
        "‡∏Å‡∏ß‡∏µ‡∏û‡πÄ‡∏ô‡∏à‡∏£": "‡∏Ç‡∏±‡∏ö‡∏•‡∏≥‡∏ô‡∏≥‡∏ö‡∏ó‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏©‡∏é‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÉ‡∏à",
        "‡∏ô‡∏±‡∏Å‡∏û‡∏£‡∏ï‡∏ú‡∏π‡πâ‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©": "‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏à‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
        "‡∏ä‡∏≤‡∏¢‡∏Ç‡∏µ‡πâ‡πÇ‡∏£‡∏Ñ‡πÅ‡∏ï‡πà‡πÉ‡∏à‡πÅ‡∏Å‡∏£‡πà‡∏á": "‡∏ù‡∏∑‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏•‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢",
        "‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡∏á‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πâ": "‡∏Å‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏®‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
        "‡πÄ‡∏ó‡∏û‡∏ö‡∏∏‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡∏£‡∏±‡∏Å‡∏≠‡∏≤‡∏†‡∏±‡∏û": "‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏π‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏à‡∏ô‡∏ï‡∏£‡∏≠‡∏°‡πÉ‡∏à‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏™‡∏µ": "‡πÉ‡∏à‡∏î‡∏µ‡πÅ‡∏à‡∏Å‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏¢‡∏≤‡∏Å‡πÑ‡∏£‡πâ‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡∏Ç‡∏≤‡∏î‡πÅ‡∏Ñ‡∏•‡∏ô ‡∏ö‡∏∏‡∏ç‡∏´‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏£‡∏¥‡∏ç",
        "‡∏ô‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢": "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡πà‡∏≤‡∏•‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏≤",
        "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π": "‡∏î‡∏π‡πÅ‡∏•‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ ‡∏à‡∏ô‡πÄ‡∏ó‡∏ß‡∏î‡∏≤‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏°‡∏≤‡πÉ‡∏´‡πâ",
        "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ß‡∏≤‡∏à‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå": "‡πÄ‡∏≠‡πà‡∏¢‡∏õ‡∏≤‡∏Å‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÉ‡∏Ñ‡∏£ ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πá‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ",
        "‡∏¢‡∏≠‡∏î‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏´‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å",
        "‡∏Ñ‡∏ô‡πÇ‡∏á‡πà‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ": "‡∏Ç‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏û‡∏ö‡πÑ‡∏´‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÇ‡∏ö‡∏£‡∏≤‡∏ì",
        "‡∏Ñ‡∏ô‡∏ö‡∏≤‡∏õ‡∏ú‡∏π‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏à": "‡∏•‡∏≤‡∏ö‡∏ß‡∏ä‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ó‡∏¥‡∏®‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏∏‡∏®‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏≤‡∏¢‡πÄ‡∏ß‡∏£",
        "‡∏ä‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏µ‡∏¢": "‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å‡∏ç‡∏≤‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•",
        "‡∏à‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏£‡πâ‡∏≤‡∏¢": "‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏ô‡∏Ñ‡∏ô‡∏ú‡∏¥‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡πÇ‡∏ó‡∏©‡∏ó‡∏±‡∏ì‡∏ë‡πå",
        "‡∏û‡∏ç‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ß": "‡πÅ‡∏≠‡∏ö‡∏™‡∏∑‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡∏ß‡∏¥‡∏Å‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        "‡∏î‡∏ß‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©",

        // --- ‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á ---
        "‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á": "‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏≠‡∏°‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏≠‡∏û‡∏£‡∏∞‡∏ó‡∏±‡∏¢‡∏¢‡∏¥‡πà‡∏á",
        "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á‡πÇ‡∏£‡∏¢": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏ß‡∏£‡∏Å‡∏≥‡πÄ‡∏£‡∏¥‡∏ö‡∏´‡∏ô‡∏±‡∏Å ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß‡∏¢‡∏≤‡∏ß",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πà‡∏°‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏µ‡πà‡∏Ñ‡∏•‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏á‡∏ö",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ": "‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡πÄ‡∏û‡∏®‡∏ü‡πâ‡∏≤‡∏ú‡πà‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏≥‡∏ô‡∏±‡∏Å ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡∏±‡∏ß‡πÉ‡∏ô‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤",
        "‡πÄ‡∏ó‡∏û‡∏ò‡∏¥‡∏î‡∏≤‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå": "‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∏‡∏ó‡∏Å‡∏†‡∏±‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡πà‡∏ß‡∏á‡∏ó‡∏µ",
        "‡∏´‡∏á‡∏™‡πå‡∏õ‡∏µ‡∏Å‡∏´‡∏±‡∏Å": "‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏ß‡∏±‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô",
        "‡πÅ‡∏°‡πà‡∏°‡∏ì‡∏µ‡∏®‡∏£‡∏µ‡∏™‡∏¢‡∏≤‡∏°": "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏•‡∏≤‡∏¢‡∏ú‡πâ‡∏≤‡∏ó‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡∏à‡∏¥‡∏ï‡∏£‡∏ö‡∏£‡∏£‡∏à‡∏á‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏õ‡∏ó‡∏±‡πà‡∏ß‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏°‡πâ‡∏≤‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û": "‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ñ‡∏∞ ‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡∏≠‡∏∏‡∏ó‡∏¥‡∏®‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏∏‡∏®‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏•‡πà‡∏ß‡∏á‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î",
        "‡∏ô‡∏≤‡∏á‡∏û‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤": "‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡∏Å‡∏≥‡∏û‡∏£‡πâ‡∏≤",
        "‡∏ô‡∏≤‡∏á‡∏ó‡∏≤‡∏™‡∏ú‡∏π‡πâ‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π": "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®",
        "‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏∏‡∏ç": "‡∏ñ‡∏ß‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÅ‡∏Å‡πà‡∏™‡∏ß‡∏≤‡∏°‡∏µ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πâ‡∏≠‡∏¥‡∏à‡∏â‡∏≤": "‡πÅ‡∏≠‡∏ö‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏î‡∏á‡∏ñ‡∏∂‡∏á‡∏´‡∏π‡∏Å‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏ö",
        "‡πÅ‡∏°‡πà‡∏û‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô": "‡∏≠‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ô‡∏¢‡∏≤‡∏Å‡πÑ‡∏£‡πâ‡πÉ‡∏ô‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏∏‡∏£‡∏Å‡∏±‡∏ô‡∏î‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏ï‡∏¥‡∏ü‡∏±‡πà‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏ô": "‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏á‡∏£‡∏≥‡∏ó‡∏≥‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏Å‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏û‡∏ö‡πÄ‡∏´‡πá‡∏ô",
        "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á": "‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏õ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏á‡∏≤‡∏°": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏á",
        "‡∏´‡∏á‡∏™‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏±‡∏á‡∏Å‡∏£": "‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏ä‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏≠‡∏°‡∏™‡∏¢‡∏ö",
        "‡∏ò‡∏¥‡∏î‡∏≤‡∏à‡∏≠‡∏°‡πÅ‡∏Å‡πà‡∏ô": "‡πÅ‡∏≠‡∏ö‡∏õ‡∏•‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏ß‡∏±‡∏á‡∏à‡∏ô‡∏û‡∏ö‡∏£‡∏±‡∏Å‡πÅ‡∏ó‡πâ",
        "‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥": "‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏£‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ß‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏£‡∏±‡∏Å‡∏Å‡∏±‡∏ô",
        "‡∏ô‡∏≤‡∏á‡∏ü‡πâ‡∏≤‡∏û‡∏•‡∏±‡∏î‡∏ñ‡∏¥‡πà‡∏ô": "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ß‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏´‡∏¢‡πâ‡∏≤",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏ó‡∏∞‡πÄ‡∏•": "‡∏û‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏î‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡∏≠‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ñ‡∏ß‡∏≤‡∏¢",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏≤‡∏†‡∏±‡∏û‡∏Ñ‡∏π‡πà": "‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏™‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏á‡πà‡∏≤‡∏á‡∏≤‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏á‡∏ö",
        "‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏®‡∏≤‡∏™‡∏ô‡∏≤": "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏ö‡∏π‡∏£‡∏ì‡∏∞‡∏ß‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏à‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°‡∏™‡∏¢‡∏≤‡∏°": "‡πÉ‡∏ä‡πâ‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏™‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
        "‡∏î‡∏≤‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡∏ü‡πâ‡∏≤": "‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ß‡∏±‡∏¢‡∏ä‡∏£‡∏≤‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏á‡πà‡∏≤‡∏£‡∏≤‡∏®‡∏µ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏©‡∏à‡∏±‡∏ô",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏Ç‡∏µ‡πâ‡πÅ‡∏¢‡∏≠‡∏≤‡∏†‡∏±‡∏û": "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏à‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≥‡πÅ‡∏¢‡πà",
        "‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏±‡∏Å‡∏£‡∏ö": "‡∏ù‡∏∂‡∏Å‡∏™‡∏≠‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏ö‡∏£‡∏¥‡∏û‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡πÉ‡∏ô",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö": "‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ‡∏à‡∏ô‡∏†‡∏±‡∏¢‡∏£‡πâ‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏û‡πâ‡∏ô‡πÑ‡∏õ",
        "‡∏Å‡∏±‡∏•‡∏¢‡∏≤‡∏ì‡∏µ‡∏®‡∏£‡∏µ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤": "‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô": "‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏•‡∏≠‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏ì‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á",
        "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏Å‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏•‡∏ß‡∏á": "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
        "‡∏ô‡∏≤‡∏á‡∏£‡∏≥‡∏≠‡∏≤‡∏†‡∏±‡∏û": "‡∏ù‡∏∂‡∏Å‡∏ã‡πâ‡∏≠‡∏°‡∏£‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏£‡∏¥‡∏á",
        "‡πÄ‡∏ó‡∏û‡∏ò‡∏¥‡∏î‡∏≤‡∏™‡∏≤‡∏¢‡∏ù‡∏ô": "‡∏™‡∏ß‡∏î‡∏°‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏ù‡∏ô‡∏à‡∏ô‡∏ù‡∏ô‡∏ï‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏£‡πâ‡∏≠‡∏ô",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏π‡∏´‡∏ô‡∏ß‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á": "‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏õ‡∏£‡∏±‡∏ä‡∏ç‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå",
        "‡∏´‡∏á‡∏™‡πå‡∏ü‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏°‡∏á‡∏Ñ‡∏•": "‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏≤‡∏™‡∏ô‡∏≤‡∏™‡∏π‡∏á ‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏°‡∏≤‡∏™‡∏π‡πà‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå",
        "‡∏ò‡∏¥‡∏î‡∏≤‡∏à‡∏≠‡∏°‡∏õ‡∏•‡∏≠‡∏°": "‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß",
        "‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û‡∏´‡∏ç‡∏¥‡∏á‡∏ú‡∏π‡πâ‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà": "‡∏ß‡∏≤‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏Å‡∏£‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏à‡∏£‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏≥‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•",
        "‡∏ò‡∏¥‡∏î‡∏≤‡∏û‡∏ç‡∏≤‡∏ô‡∏≤‡∏Ñ": "‡∏ù‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏ï‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÑ‡∏õ‡∏Ç‡∏∏‡∏î‡∏û‡∏ö",
        "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏∑‡∏°": "‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏á‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏û‡∏±‡∏á ‡πÇ‡∏î‡∏¢‡πÑ‡∏£‡πâ‡∏Ñ‡∏ô‡∏°‡∏≤‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏¢‡∏µ‡∏¢‡∏ô",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå": "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏¥‡∏ö‡πÄ‡∏ó‡πà‡∏≤",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô": "‡∏≠‡∏∏‡∏ó‡∏¥‡∏®‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏à‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á‡πÑ‡∏û‡∏£‡∏£‡∏±‡∏Å‡∏©‡πå": "‡∏£‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡πà‡∏≤‡∏•‡∏µ‡πâ‡∏•‡∏±‡∏ö‡∏à‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
        "‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏ú‡∏π‡πâ‡πÇ‡∏®‡∏Å‡πÄ‡∏®‡∏£‡πâ‡∏≤": "‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ã‡∏π‡∏ö‡∏ú‡∏≠‡∏°",
        "‡πÅ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏±‡∏ß‡∏õ‡πà‡∏≤‡∏Å‡πå": "‡∏ä‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏¢‡πÅ‡∏Ç‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏ß‡∏≤‡∏à‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå": "‡∏ó‡∏±‡∏Å‡∏ó‡πâ‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á ‡∏à‡∏ô‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏†‡∏±‡∏¢",
        "‡∏ò‡∏¥‡∏î‡∏≤‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏ú‡∏∑‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏ç‡∏≤‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å",
        "‡∏™‡∏ï‡∏£‡∏µ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå": "‡∏ä‡πà‡∏ß‡∏¢‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏®‡∏¥‡∏•‡∏≤‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        "‡∏ô‡∏≤‡∏£‡∏µ‡∏û‡∏¥‡∏ì‡∏ó‡∏¥‡∏û‡∏¢‡πå": "‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡∏Ç‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏ô‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏ß‡∏£‡∏à‡∏ô‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô",
        "‡∏î‡∏ß‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏≤‡∏£‡∏µ": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå"
    };

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (Fatal Logic) ---
    // ‡∏î‡∏ß‡∏á‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ "‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå/‡∏ï‡∏≤‡∏¢" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5-10%)
    const riskyTraits = ["‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á‡πÇ‡∏£‡∏¢", "‡∏ä‡∏≤‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô‡∏≠‡∏≤‡∏†‡∏±‡∏û", "‡∏ô‡∏≤‡∏£‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ", "‡∏î‡∏≤‡∏ß‡∏ï‡∏Å‡∏≠‡∏±‡∏ö", "‡∏Ñ‡∏ô‡∏Ç‡∏µ‡πâ‡πÇ‡∏£‡∏Ñ", "‡∏Ç‡∏∏‡∏ô‡∏®‡∏∂‡∏Å‡πÑ‡∏£‡πâ‡∏û‡πà‡∏≤‡∏¢"];
    if (riskyTraits.includes(label) && Math.random() < 0.08) {
        isFatal = true;
        eventMsg = "‡πÇ‡∏ä‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢! " + (eventTable[label] || "‡∏ß‡∏¥‡∏ö‡∏≤‡∏Å‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô") + " ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï";
    } else {
        eventMsg = eventTable[label] || "‡∏ó‡∏£‡∏á‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÄ‡∏´‡πá‡∏ô‡∏•‡∏≤‡∏á‡∏ö‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á";
    }

    // === ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ===
    if (eventMsg) {
        if (isFatal) {
            p.isAlive = false;

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï ---
            p.deathDay = state.worldTime.day;
            p.deathMonth = state.worldTime.month;
            p.deathYear = state.worldTime.year;

            addHistoryLog(`‡∏≠‡∏≤‡πÄ‡∏û‡∏®: ${p.name} ${eventMsg}`);
            showToast(`‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${p.name} ‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡πÅ‡∏•‡πâ‡∏ß`);
            if (p.isMonarch) handleMonarchDeath(p);
        } else {
            addHistoryLog(`‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï‡∏ü‡πâ‡∏≤: ${p.name} ${eventMsg}`);
            showToast(`‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï: ${p.name} ${eventMsg}`);
        }
        updateApp(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    }
}

function addHistoryLog(text) {
    const t = state.worldTime;
    const stamp = `${toThaiNumerals(t.day)}/${toThaiNumerals(t.month)}/${toThaiNumerals(t.year)} ${t.hour}:${t.minute}`;
    state.worldTime.historyLog.unshift({ time: stamp, event: text });
}

function openChronicleModal() {
    const list = document.getElementById('chronicleList');
    list.innerHTML = '';
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter 'index' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
    state.worldTime.historyLog.forEach((log, index) => {
        list.innerHTML += `
            <div class="p-3 bg-white rounded-xl border mb-2 text-xs flex justify-between items-start group transition-all hover:border-red-100">
                <div class="flex-1">
                    <span class="text-indigo-500 font-bold">[${log.time}]</span> ${log.event}
                </div>
                <button onclick="deleteChronicleEntry(${index})" 
                        class="ml-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" 
                        title="‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>`;
    });
    document.getElementById('chronicleModal').classList.add('active');
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
 * @param {number} index - ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô historyLog
 */
function deleteChronicleEntry(index) {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Array ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á index
    state.worldTime.historyLog.splice(index, 1);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏á LocalStorage
    saveState();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    openChronicleModal();

    showToast("‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
window.addEventListener('beforeunload', () => {
    saveState();
});


// === ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Script ‡πÄ‡∏î‡∏¥‡∏° ===

// ‡πë. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
function updateLiveAgeDisplay() {
    const modal = document.getElementById('detailModal');
    if (!modal || !window.curPID) return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏≠‡∏≤‡∏¢‡∏∏ ---
    const ageRow = document.getElementById('d_ageRow');
    if (state.hideAgePopUp) {
        if (ageRow) ageRow.classList.add('hidden');
        return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠
    } else {
        if (ageRow) ageRow.classList.remove('hidden');
    }
    // ------------------------------------------

    const p = state.members.find(m => m.id === window.curPID);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    if (!p || !p.birthYear || p.birthYear === "") {
        document.getElementById('d_currentAge').innerText = "-";
        return;
    }

    let age = 0;
    const birthYearBE = parseInt(p.birthYear);
    const currentYearBE = state.worldTime.year;
    const deathYearBE = parseInt(p.deathYear);

    if (p.isAlive) {
        age = currentYearBE - birthYearBE;
    } else {
        const endYear = (!isNaN(deathYearBE)) ? deathYearBE : currentYearBE;
        age = endYear - birthYearBE;
    }

    if (age < 0) age = 0;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    document.getElementById('d_currentAge').innerText = toThaiNumerals(age) + " ‡∏õ‡∏µ";
}

// ‡πì. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á showDetail (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤)
const originalShowDetail = showDetail;
showDetail = function(id) {
    if (typeof originalShowDetail === 'function') originalShowDetail(id);
    
    setTimeout(() => {
        updateLiveAgeDisplay();
    }, 50); 
};



function showCreationPopup(p) {
    if (!p) return;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏¢‡∏®
    document.getElementById('cp_img').src = p.image || (p.gender === 'M' ? DEFAULT_IMG_MALE : DEFAULT_IMG_FEMALE);
    document.getElementById('cp_rank').innerText = p.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° (‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
    document.getElementById('cp_name').innerText = getFullDisplayTitle(p);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ
    if (p.destiny) {
        document.getElementById('cp_icon').innerText = p.destiny.icon;
        document.getElementById('cp_destiny_label').innerText = p.destiny.label;
        document.getElementById('cp_destiny_desc').innerText = p.destiny.description;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    document.getElementById('cp_destiny_poem').innerText = p.destiny.poem;
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
        const labelEl = document.getElementById('cp_destiny_label');
        labelEl.className = `font-bold mb-1 ${p.destiny.color}`;
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Modal
    document.getElementById('creationPopupModal').classList.add('active');
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£
    addHistoryLog(`‡∏à‡∏∏‡∏ï‡∏¥: ${p.name} ‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï "${p.destiny.label}"`);
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î 'month' ‡πÅ‡∏•‡∏∞ 'year'
 */
function setTimeMultiplier(m) {
    state.worldTime.multiplier = m;
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° (Highlitight)
    const speeds = [1, 10, 100, 'Month', 'Year'];
    speeds.forEach(s => {
        const btn = document.getElementById('speed' + s);
        if(btn) {
            const isSelected = (m.toString().toLowerCase() === s.toString().toLowerCase());
            btn.className = `text-[8px] px-1.5 py-0.5 rounded font-bold ${isSelected ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-300'}`;
        }
    });
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Tick) ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
 */
function tick() {
    let t = state.worldTime;

    if (t.multiplier === 'month') {
        // --- ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
        t.month += 1;
        if (t.month > 12) {
            t.month = 1;
            t.year += 1;
            addHistoryLog(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä‡πÉ‡∏´‡∏°‡πà ${toThaiNumerals(t.year)}`);
        }
        checkDailyEvents(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏±‡∏¢)
    } 
    else if (t.multiplier === 'year') {
        // --- ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏õ‡∏µ ---
        t.year += 1;
        addHistoryLog(`‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡πà‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä ${toThaiNumerals(t.year)}`);
        checkDailyEvents();
    } 
    else {
        // --- ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ---
        const secondsToAdd = 360 * t.multiplier; 
        t.second += secondsToAdd;
        
        if (t.second >= 60) { t.minute += Math.floor(t.second / 60); t.second %= 60; }
        if (t.minute >= 60) { t.hour += Math.floor(t.minute / 60); t.minute %= 60; }
        if (t.hour >= 24) { 
            t.day += Math.floor(t.hour / 24); 
            t.hour %= 24; 
            checkDailyEvents(); 
            saveState(); 
        }
        if (t.day > 30) { t.month += 1; t.day = 1; }
        if (t.month > 12) { 
            t.year += 1; 
            t.month = 1; 
            addHistoryLog(`‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà ‡∏û.‡∏®. ${toThaiNumerals(t.year)}`); 
        }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    updateTimeUI();
    updateLiveAgeDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (t.multiplier === 'month' || t.multiplier === 'year') {
        updateApp(); // ‡∏´‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πá‡∏ß ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ú‡∏±‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    }
}


// ================= FULLSCREEN LOGIC =================
// ================= FULLSCREEN LOGIC (UPDATED) =================
function toggleFullScreen() {
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô documentElement ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Pop-up ‡∏î‡πâ‡∏ß‡∏¢
    const elem = document.documentElement; 
    const fsIcon = document.getElementById('fs-icon');

    if (!document.fullscreenElement) {
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
        }
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠
        if(fsIcon) fsIcon.classList.replace('fa-expand', 'fa-compress');
        showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Pop-up)");
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        if(fsIcon) fsIcon.classList.replace('fa-compress', 'fa-expand');
    }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î Esc)
document.addEventListener('fullscreenchange', () => {
    const fsIcon = document.getElementById('fs-icon');
    if (!document.fullscreenElement) {
        if(fsIcon) fsIcon.classList.replace('fa-compress', 'fa-expand');
    }
});


// --- ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î 

// 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏¢‡∏®
const NOBILITY_RANKS = ["‡∏´‡∏°‡∏π‡πà", "‡∏à‡πà‡∏≤", "‡∏û‡∏±‡∏ô", "‡∏´‡∏°‡∏∑‡πà‡∏ô", "‡∏Ç‡∏∏‡∏ô", "‡∏´‡∏•‡∏ß‡∏á", "‡∏û‡∏£‡∏∞", "‡∏à‡∏°‡∏∑‡πà‡∏ô", "‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤"];

function promoteNobilityRank() {
    const p = state.members.find(m => m.id == window.curPID);
    if (!p) return;

    const currentTitle = (p.titlePrefix || "").trim();
    let nextRank = "";

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    const progression = {
        "": "‡∏´‡∏°‡∏π‡πà",
        "‡∏´‡∏°‡∏π‡πà": "‡∏à‡πà‡∏≤",
        "‡∏à‡πà‡∏≤": "‡∏û‡∏±‡∏ô",
        "‡∏û‡∏±‡∏ô": "‡∏´‡∏°‡∏∑‡πà‡∏ô",
        "‡∏´‡∏°‡∏∑‡πà‡∏ô": "‡∏Ç‡∏∏‡∏ô",
        "‡∏Ç‡∏∏‡∏ô": "‡∏´‡∏•‡∏ß‡∏á",
        "‡∏û‡∏£‡∏∞": "‡∏û‡∏£‡∏∞‡∏¢‡∏≤",
        "‡∏à‡∏°‡∏∑‡πà‡∏ô": "‡∏û‡∏£‡∏∞‡∏¢‡∏≤",
        "‡∏û‡∏£‡∏∞‡∏¢‡∏≤": "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤",
        "‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤": "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤"
    };

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏® "‡∏´‡∏•‡∏ß‡∏á"
    if (currentTitle === "‡∏´‡∏•‡∏ß‡∏á") {
        // ‡πÉ‡∏ä‡πâ prompt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå
        const choice = prompt("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏à‡∏≤‡∏Å '‡∏´‡∏•‡∏ß‡∏á' ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?\n‡∏Å‡∏î 1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '‡∏û‡∏£‡∏∞'\n‡∏Å‡∏î 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '‡∏à‡∏°‡∏∑‡πà‡∏ô'", "1");
        if (choice === "1") {
            nextRank = "‡∏û‡∏£‡∏∞";
        } else if (choice === "2") {
            nextRank = "‡∏à‡∏°‡∏∑‡πà‡∏ô";
        } else {
            return; // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        }
    } else if (currentTitle === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤") {
        showToast("‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
        return;
    } else {
        // ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå progression
        nextRank = progression[currentTitle] || "‡∏´‡∏°‡∏π‡πà";
    }

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏£‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏≠‡∏á ${p.name} ‡πÄ‡∏õ‡πá‡∏ô "${nextRank}"?`)) {
        p.titlePrefix = nextRank;
        p.relationship = "‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á";
        p.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô"; // ‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
        if (typeof recordTitleHistory === 'function') recordTitleHistory(p);
        
        saveState();
        updateApp();
        showDetail(p.id); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "${nextRank}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`);
    }
}

function updateChildrenRankByMother(motherId) {
    const mother = state.members.find(m => m.id === motherId);
    if (!mother) return;

    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏®‡πÅ‡∏°‡πà‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å (‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)
    const queenTiers = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ"];
    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏®‡πÅ‡∏°‡πà‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó (‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ ‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)
    const royalWifeTiers = ["‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"];
    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏®‡πÅ‡∏°‡πà‡∏ä‡∏±‡πâ‡∏ô‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤ (‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)
    const consortTiers = ["‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°", "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤"];

    const children = state.members.filter(m => m.motherId === mother.id);

    children.forEach(child => {
        const father = state.members.find(m => m.id === child.fatherId);
        if (!father || !father.isMonarch) return; // ‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

        const isMale = child.gender === 'M';
        const fullTitleMother = (mother.titlePrefix || "") + (mother.titleSuffix || "");

        if (queenTiers.some(t => fullTitleMother.includes(t))) {
            child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
            child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
        } 
        else if (royalWifeTiers.some(t => fullTitleMother.includes(t))) {
            child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
            child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
        }
        else if (consortTiers.some(t => fullTitleMother.includes(t))) {
            child.titlePrefix = isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤";
            child.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            
            // ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ñ‡πâ‡∏≤‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏µ‡∏•‡∏π‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤
            if (mother.titlePrefix === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°") {
                mother.titlePrefix = "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤";
            }
        }
        child.hideRoyalRank = false;
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤
function promoteToPhraWorachaya(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;
    p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
    p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
    p.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤";
    
    saveState();
    updateApp();
    showDetail(p.id); // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà currentPerson.royalRank ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ${p.name} ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ä‡∏≤‡∏¢‡∏≤ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®`);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ
function promoteToPhraWorasami(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;
    p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
    p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
    p.titleSuffix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ";

    saveState();
    updateApp();
    showDetail(p.id); // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà currentPerson.royalRank ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ${p.name} ‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏™‡∏≤‡∏°‡∏µ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®`);
}


function promoteToPhakkhaniPati(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;
    
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"?`)) return;

    p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠";
    p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
    p.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
    p.surname = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

    recordTitleHistory(p); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    saveState();
    updateApp();
    showDetail(p.id);
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏Ñ‡∏ô‡∏µ‡∏õ‡∏ï‡∏¥‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`);
}


function openSpouseListModal(personId, categoryKey, label) {
    const person = state.members.find(m => m.id === personId);
    if (!person) return;

    let spouses = (person.spouseIds || []).map(sid => state.members.find(x => x.id === sid)).filter(s => s);

   // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Category Key ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ---
    const royalKeys = ['‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤', '‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤', 'royal_wife', 'titled_husband', '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡∏≤‡∏°‡∏µ', '‡∏û‡∏£‡∏∞‡∏™‡∏´‡∏¢‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ'];
    const commonerKeys = ['‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤', '‡∏´‡∏°‡πà‡∏≠‡∏°', 'common_wife', 'common_husband', 'wife', '‡∏†‡∏±‡∏™‡∏î‡∏≤'];

    if (royalKeys.includes(categoryKey)) {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏à‡πâ‡∏≤" (‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤/‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤)
        spouses = spouses.filter(s => (s.royalRank && !['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(s.royalRank)) || s.isMonarch);
    } 
    else if (commonerKeys.includes(categoryKey)) {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" (‡∏´‡∏°‡πà‡∏≠‡∏°/‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤)
        spouses = spouses.filter(s => !s.isMonarch && (!s.royalRank || ['‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(s.royalRank)));
    }
    // --------------------------------------------------------------------------

    // 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™ > ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î > ‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
    spouses.sort((a, b) => {
        const isRegA = (person.registeredSpouseId === a.id) ? 1 : 0;
        const isRegB = (person.registeredSpouseId === b.id) ? 1 : 0;
        if (isRegA !== isRegB) return isRegB - isRegA;

        const rankA = parseInt(RANK_CODES[a.royalRank] || '99', 36);
        const rankB = parseInt(RANK_CODES[b.royalRank] || '99', 36);
        if (rankA !== rankB) return rankA - rankB;

        return (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999);
    });

    // 3. ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Pop-up (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏î‡∏µ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏∂‡∏ö ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
    const titleEl = document.getElementById('sl_title');
    // label (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏∞‡∏™‡∏ß‡∏≤‡∏°‡∏µ) ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô | ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏∂‡∏ö amber-800
    titleEl.innerHTML = `
        <span class="text-indigo-800 font-bold text-lg">${label}‡πÉ‡∏ô</span>
        <span class="text-amber-800 font-bold text-lg">${getFullDisplayTitle(person)}</span>
    `;
    titleEl.className = "font-royal leading-tight p-1 block";
    
    const body = document.getElementById('sl_body');
    body.innerHTML = "";

    spouses.forEach(s => {
        const isReg = (person.registeredSpouseId === s.id);
        const div = document.createElement('div');
        div.className = "flex items-start gap-3 p-3 bg-slate-50 rounded-2xl hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-200 transition-all group relative";
        div.onclick = () => { closeModal('spouseListModal'); showDetail(s.id); };
        
        div.innerHTML = `
            <div class="relative shrink-0">
                <img src="${s.image || (s.gender === 'M' ? DEFAULT_IMG_MALE : DEFAULT_IMG_FEMALE)}" 
                     class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm">
                ${isReg ? '<div class="absolute -top-1 -right-1 bg-amber-400 text-white text-[9px] px-1.5 py-0.5 rounded-full border border-white font-bold shadow-sm">‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>' : ''}
            </div>
            <div class="flex-1 pt-0.5">
                <div class="text-[10px] text-indigo-500 font-bold uppercase tracking-wider mb-0.5">${s.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô'}</div>
                
                <div class="text-sm font-normal text-black leading-snug group-hover:text-indigo-600 transition-colors">
                    ${getFullDisplayTitle(s)}
                </div>
            </div>
            <i class="fa-solid fa-chevron-right text-[10px] text-slate-300 group-hover:text-indigo-400 mt-5"></i>
        `;
        body.appendChild(div);
    });

    document.getElementById('spouseListModal').classList.add('active');
}

function openChildrenListModal(parentId, gender, label) {
    const parent = state.members.find(m => m.id === parentId);
    if (!parent) return;

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏ï‡∏£/‡∏ò‡∏¥‡∏î‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
    let children = state.members.filter(c => 
        (c.fatherId === parentId || c.motherId === parentId) && 
        c.gender === gender
    );

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°: ‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏® > ‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î)
    children.sort((a, b) => {
        const rankA = parseInt(RANK_CODES[a.royalRank] || '99', 36);
        const rankB = parseInt(RANK_CODES[b.royalRank] || '99', 36);
        if (rankA !== rankB) return rankA - rankB;
        return (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999);
    });

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Pop-up (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)
    const titleEl = document.getElementById('sl_title');
    titleEl.innerHTML = `
        <span class="text-indigo-800 font-bold text-lg">${label}‡πÉ‡∏ô</span>
        <span class="text-amber-800 font-bold text-lg">${getFullDisplayTitle(parent)}</span>
    `;

    const body = document.getElementById('sl_body');
    body.innerHTML = "";
    
    children.forEach(c => {
        // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á
        const otherParentId = (c.fatherId === parentId) ? c.motherId : c.fatherId;
        const otherParent = state.members.find(m => m.id === otherParentId);
        const otherParentLabel = (parent.gender === 'M') ? "‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏ö‡∏¥‡∏î‡∏≤";
        const otherParentName = otherParent ? getFullDisplayTitle(otherParent) : "‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è";

        const div = document.createElement('div');
        div.className = "flex items-start gap-3 p-3 bg-slate-50 rounded-2xl hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-200 transition-all group relative mb-2";
        div.onclick = () => { 
            closeModal('spouseListModal'); 
            showDetail(c.id); 
        };
        
        div.innerHTML = `
            <div class="relative shrink-0">
                <img src="${c.image || (c.gender === 'M' ? DEFAULT_IMG_MALE : DEFAULT_IMG_FEMALE)}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm">
            </div>
            <div class="flex-1 pt-0.5">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                    <div class="text-[10px] text-indigo-500 font-bold uppercase tracking-wider">${c.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô'}</div>
                    <div class="mother-tag-container">
                        <span class="mother-tag-label">${otherParentLabel}</span>
                        <span class="mother-tag-value">${otherParentName}</span>
                    </div>
                </div>
                <div class="text-sm font-normal text-black leading-snug group-hover:text-indigo-600 transition-colors">
                    ${getFullDisplayTitle(c)}
                </div>
            </div>
            <i class="fa-solid fa-chevron-right text-[10px] text-slate-300 group-hover:text-indigo-400 mt-5"></i>
        `;
        body.appendChild(div);
    });
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal (‡πÉ‡∏ä‡πâ ID spouseListModal ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÇ‡∏Ñ‡πâ‡∏î)
    document.getElementById('spouseListModal').classList.add('active');
}

function restoreRoyalRankAction() {
    const id = window.curPID;
    const m = state.members.find(x => x.id === id);
    
    if (!m || !m.isResigned) return;

    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÅ‡∏Å‡πà ${m.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        // --- 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á Flag ‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®‡∏ñ‡∏≤‡∏ß‡∏£ ---
        m.isResigned = false;
        m.isRestored = true; // ‡πÄ‡∏û‡∏¥‡πà‡∏° Flag ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏®‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•)

        // --- 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ ---
        if (m.originalRoyalRank) m.royalRank = m.originalRoyalRank;
        if (m.originalRelationship) m.relationship = m.originalRelationship;
        if (m.originalTitlePrefix) m.titlePrefix = m.originalTitlePrefix;
        if (m.originalRoyalSurname) m.royalSurname = m.originalRoyalSurname;

        // --- 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏¢‡∏®‡πÉ‡∏ô‡∏Å‡∏£‡∏° ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏≠‡∏≠‡∏Å ---
        m.kromRank = m.originalKromRank || ""; 
        m.kromTitle = m.originalKromTitle || ""; 
        m.surname = ""; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡∏ö‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å

        // --- 4. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏®‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß) ---
        m.originalRoyalRank = null;
        m.originalRelationship = null;
        m.originalTitlePrefix = null;
        m.originalRoyalSurname = null;
        m.originalKromRank = null;
        m.originalKromTitle = null;

        // --- 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ---
        // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ saveState
        if (typeof recordTitleHistory === 'function') {
            recordTitleHistory(m);
        }

        saveState();
        updateApp();
        showDetail(m.id);
        showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏û‡∏£‡∏∞‡∏¢‡∏®‡πÅ‡∏Å‡πà ${m.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`);
    }
}



// ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î 
function refreshAllDisplays() {
    updateApp(); // ‡∏ß‡∏≤‡∏î‡∏ú‡∏±‡∏á/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if (typeof showDetail === 'function' && window.curPID) {
        showDetail(window.curPID); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    }
}

function updateHideAgeToggle(checked) {
    state.hideAgePopUp = checked; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏á‡πÉ‡∏ô state
    saveState();
    // ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Pop-up ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
    updateLiveAgeDisplay();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏´‡∏≤‡∏¢‡πÑ‡∏õ/‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    renderTable();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Pop-up ‡∏î‡∏π‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà (Updated)
function viewParents(childId) {
    const child = state.members.find(m => m.id === childId);
    if (!child) return;

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Pop-up ‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏¥‡∏î‡∏≤-‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á {‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å}"
    const headerEl = document.getElementById('parent_view_title');
    if (headerEl) {
        headerEl.innerHTML = `‡∏ö‡∏¥‡∏î‡∏≤-‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏Ç‡∏≠‡∏á<br><span class="text-base text-slate-600 font-normal">${getFullDisplayTitle(child)}</span>`;
    }

    const father = state.members.find(m => m.id === child.fatherId);
    const mother = state.members.find(m => m.id === child.motherId);

    // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡πà‡∏≠ ---
    const fCard = document.getElementById('view_father_card');
    const fImg = document.getElementById('view_father_img');
    const fName = document.getElementById('view_father_name');

    if (father) {
        fImg.src = father.image || DEFAULT_IMG_MALE;
        fName.innerText = getFullDisplayTitle(father); // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î)
        fName.classList.remove('text-slate-400', 'italic');
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° onclick ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡πà‡∏≠
        fCard.onclick = function() {
            closeModal('parentViewModal'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô
            setTimeout(() => showDetail(father.id), 100); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡πà‡∏≠
        };
        fCard.classList.remove('opacity-50', 'pointer-events-none'); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    } else {
        fImg.src = DEFAULT_IMG_MALE;
        fName.innerText = "- ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ô‡∏≤‡∏° -";
        fName.classList.add('text-slate-400', 'italic');
        fCard.onclick = null; // ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
        fCard.classList.add('opacity-50', 'pointer-events-none'); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á
    }

    // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πà ---
    const mCard = document.getElementById('view_mother_card');
    const mImg = document.getElementById('view_mother_img');
    const mName = document.getElementById('view_mother_name');

    if (mother) {
        mImg.src = mother.image || DEFAULT_IMG_FEMALE;
        mName.innerText = getFullDisplayTitle(mother); // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î)
        mName.classList.remove('text-slate-400', 'italic');
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° onclick ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏°‡πà
        mCard.onclick = function() {
            closeModal('parentViewModal'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô
            setTimeout(() => showDetail(mother.id), 100); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏°‡πà
        };
        mCard.classList.remove('opacity-50', 'pointer-events-none'); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    } else {
        mImg.src = DEFAULT_IMG_FEMALE;
        mName.innerText = "- ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ô‡∏≤‡∏° -";
        mName.classList.add('text-slate-400', 'italic');
        mCard.onclick = null; // ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
        mCard.classList.add('opacity-50', 'pointer-events-none'); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á
    }

    document.getElementById('parentViewModal').classList.add('active');
}

function getReignPeriod(periodStart, periodEnd) {
    if (!state.members || !periodStart) return "-";
    
    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const monarchs = state.members
        .filter(m => m.isMonarch && m.globalReignNumber)
        .sort((a, b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));

    if (monarchs.length === 0) return "-";

    const involvedReigns = [];

    monarchs.forEach((m, index) => {
        // --- ‡∏´‡∏≤‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå (rStart) ---
        let rStart = parseInt(m.reignStartYear) || 0;
        if (rStart === 0 && index > 0) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            rStart = parseInt(monarchs[index - 1].deathYear) || parseInt(monarchs[index - 1].reignStartYear) || 0;
        }

        // --- ‡∏´‡∏≤‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå (rEnd) ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏¢ ---
        let rEnd;
        if (m.status !== 'dead') {
            // *** ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢ (status !== 'dead') ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ***
            rEnd = state.worldTime?.year || 2569;
        } else {
            // *** ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (status === 'dead') ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏ï‡∏≤‡∏¢ (deathYear) ***
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏õ‡∏µ‡∏ï‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏ö‡πÉ‡∏ô‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
            rEnd = parseInt(m.deathYear) || rStart; 
        }

        // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ---
        // ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå (periodStart ‡∏ñ‡∏∂‡∏á periodEnd) ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• (rStart ‡∏ñ‡∏∂‡∏á rEnd)
        const isOverlap = (periodStart <= rEnd) && (periodEnd >= rStart);

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏à‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
        if (isOverlap && (rEnd > 0 || m.status !== 'dead')) {
            involvedReigns.push(parseInt(m.globalReignNumber));
        }
    });

    if (involvedReigns.length === 0) return "-";
    
    const min = Math.min(...involvedReigns);
    const max = Math.max(...involvedReigns);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    if (min === max) {
        return `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(min)}`;
    } else {
        return `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(min)} - ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(max)}`;
    }
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ ---
function toThaiNumerals(num) {
    if (num === null || num === undefined || num === "-") return "-";
    const thaiDigits = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
    return num.toString().replace(/\d/g, (d) => thaiDigits[d]);
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö
function deleteKulachetEntry(index) {
    if (!confirm('üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    
    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å array ‡πÉ‡∏ô state ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    state.kulachetHistory.splice(index, 1);
    
    saveState();
    renderTable();
    showToast("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
}

function editKulachetReign(index) {
    const entry = state.kulachetHistory[index];
    if (!entry) {
        console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Index:", index);
        return;
    }

    // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    const currentVal = entry.manualReign || "";
    const nums = currentVal.match(/\d+/g) || []; 
    
    // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á Input
    document.getElementById('reign_start_num').value = nums[0] || "";
    document.getElementById('reign_end_num').value = nums[1] || "";
    document.getElementById('edit_kulachet_index').value = index;
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà Error
    if (typeof updateReignPreview === 'function') {
        updateReignPreview();
    }
    
    // ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á Pop-up
    const modal = document.getElementById('editKulachetModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        console.error("‡∏´‡∏≤ Element ID 'editKulachetModal' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠");
    }
} 


// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢
function saveKulachetReignEdit() {
    const index = document.getElementById('edit_kulachet_index').value;
    const start = document.getElementById('reign_start_num').value;
    const end = document.getElementById('reign_end_num').value;
    
    if (!start) {
        showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let finalReignText = `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(start)}`;
    if (end) {
        finalReignText += ` ‡∏ñ‡∏∂‡∏á ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(end)}`;
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô state
    state.kulachetHistory[index].manualReign = finalReignText;

    saveState();
    renderTable();
    closeModal('editKulachetModal');
    showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®");
}





// ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
document.getElementById('reign_start_num')?.addEventListener('input', updateReignPreview);
document.getElementById('reign_end_num')?.addEventListener('input', updateReignPreview);




// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á)
// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° ‡∏£.X ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡∏£.1 ‡∏ñ‡∏∂‡∏á ‡∏£.X ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á)
// ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° ‡∏£.X ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡∏£.1 ‡∏ñ‡∏∂‡∏á ‡∏£.X ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..." ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function extractReignNum(member) {
    if (!member) return 0;
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ
    const text = (member.monarchSpouseContext || "") + (typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(member) : member.name);
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà" ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
    const match = text.match(/‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà\s*([‡πë-‡πô‡πê\d]+)/);
    if (!match) return 0;

    let numStr = match[1];
    const thaiDigits = {'‡πê':'0','‡πë':'1','‡πí':'2','‡πì':'3','‡πî':'4','‡πï':'5','‡πñ':'6','‡πó':'7','‡πò':'8','‡πô':'9'};
    const arabicStr = numStr.replace(/[‡πê-‡πô]/g, (d) => thaiDigits[d]);
    
    return parseInt(arabicStr) || 0;
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
function updateAffiliationList() {
    const dl = document.getElementById('affiliationOptions');
    if (!dl) return;
    dl.innerHTML = '';
    
    // --- ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Ç‡∏≠‡∏á "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°" ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    const currentId = document.getElementById('p_id').value;
    const currentMember = state.members.find(m => m.id === currentId);
    const subjectReign = extractReignNum(currentMember); 
    
    console.log("‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà:", subjectReign === 0 ? "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢" : subjectReign);

    const allowedBoromPrefixes = ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"];
    const allowedRelationships = ["‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ‡πë", "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤"];

    const eligible = state.members.filter(m => {
        if (m.gender !== 'F') return false;
        if (!m.isAlive) return false;

        const rel = m.relationship;
        const prefix = (m.titlePrefix || "").trim();

        // ==========================================
        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞: ‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤
        // ==========================================
        if (rel === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
            const candidateReign = extractReignNum(m);

            if (subjectReign > 0) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà X"
                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏™‡∏≤‡∏°‡∏µ <= X ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                // (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏£.1 ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô ‡∏£.2, 3, 4...)
                return candidateReign > 0 && candidateReign <= subjectReign;
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏° "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢" (‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
                // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á "‡∏ó‡∏∏‡∏Å‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•"
                return true;
            }
        }

        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        if (rel === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå") return allowedBoromPrefixes.includes(prefix);
        if (allowedRelationships.includes(rel)) return true;

        return false;
    });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    eligible.forEach(m => {
        const op = document.createElement('option');
        const title = typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(m) : m.name;
        op.value = `${m.id} : ${title}`;
        dl.appendChild(op);
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Show/Hide) - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°, ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß
function toggleAffiliationInput() {
    const prefix = document.getElementById('p_titlePrefix').value;
    const isTao = document.getElementById('p_isTao').checked; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß
    const container = document.getElementById('consortAffiliationContainer');
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
    const targetPrefixes = ["‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°", "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå", "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ"];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ (‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î) ‡∏´‡∏£‡∏∑‡∏≠ (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if ((prefix && targetPrefixes.includes(prefix.trim())) || isTao) {
        container.classList.remove('hidden');
        if (typeof updateAffiliationList === 'function') updateAffiliationList(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á
    } else {
        container.classList.add('hidden');
        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏ó‡πâ‡∏≤‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°) ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.getElementById('p_affiliationSearch').value = '';
        document.getElementById('p_affiliationId').value = '';
    }
}
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Datalist (‡∏î‡∏∂‡∏á ID ‡πÉ‡∏™‡πà Hidden Input)
function handleAffiliationSelect(input) {
    const val = input.value;
    const hiddenId = document.getElementById('p_affiliationId');
    
    // ‡πÅ‡∏¢‡∏Å ID ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å string "ID : Name"
    const parts = val.split(' : ');
    if (parts.length > 1) {
        hiddenId.value = parts[0].trim();
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ ID ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
        const found = state.members.find(m => m.name === val.trim() || m.id === val.trim());
        if (found) {
             hiddenId.value = found.id;
             // ‡∏à‡∏±‡∏î Format ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
             input.value = `${found.id} : ${typeof getFullDisplayTitle === 'function' ? getFullDisplayTitle(found) : found.name}`;
        } else {
             hiddenId.value = ''; // ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå ID
        }
    }
}
// ============================================================
//  AUTO REASSIGNMENT SYSTEM (‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏≤‡∏¢‡∏ï‡∏≤‡∏¢)
// ============================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î

// ============================================================
// ü§ñ AUTO REASSIGNMENT SYSTEM (‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
// ============================================================

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Updated with .hidden logic)
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°)
function processDeathAffiliationReassignment(deceasedPerson) {
    // 1. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    if (deceasedPerson.gender !== 'F') return;

    // 2. ‡∏´‡∏≤ "‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á" ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà (‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)
    const subordinates = state.members.filter(m => 
        m.affiliationId === deceasedPerson.id && m.isAlive
    );

    if (subordinates.length === 0) return; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á ‡∏à‡∏ö‡∏Ç‡πà‡∏≤‡∏ß

    let movedCount = 0;
    
    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ---
    const listContainer = document.getElementById('reas_list_container');
    if(listContainer) listContainer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

    // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
    subordinates.forEach(sub => {
        // ‡∏´‡∏≤ Candidate ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
        const candidates = getValidAffiliationCandidatesFor(sub);
        
        let newItemHtml = '';
        // Placeholder ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const subImg = sub.image || (sub.gender==='M' ? 'https://via.placeholder.com/50/3b82f6/ffffff?text=M' : 'https://via.placeholder.com/50/ec4899/ffffff?text=F');

        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏î‡∏∂‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏¢‡πâ‡∏≤‡∏¢
        const subFullName = typeof getFullDisplayTitle === 'function' 
            ? getFullDisplayTitle(sub) 
            : ((sub.titlePrefix || '') + ' ' + sub.name).trim();

        if (candidates.length > 0) {
            // --- ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà ---
            const randomIndex = Math.floor(Math.random() * candidates.length);
            const newBoss = candidates[randomIndex];

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
            sub.affiliationId = newBoss.id;
            movedCount++;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏ß‡∏¢‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢
            const newBossImg = newBoss.image || (newBoss.gender==='M' ? 'https://via.placeholder.com/50/3b82f6/ffffff?text=M' : 'https://via.placeholder.com/50/ec4899/ffffff?text=F');
            
            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏î‡∏∂‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
            const bossFullName = typeof getFullDisplayTitle === 'function' 
                ? getFullDisplayTitle(newBoss) 
                : ((newBoss.titlePrefix || '') + ' ' + newBoss.name).trim();
            
            newItemHtml = `
                <div class="flex items-start justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 mb-2">
                    <div class="flex flex-col items-center w-[40%] text-center gap-1">
                        <img src="${subImg}" class="w-10 h-10 rounded-full border border-slate-200 object-cover bg-slate-50">
                        <div class="w-full">
                            <div class="text-[10px] leading-tight font-bold text-slate-700 break-words">${subFullName}</div>
                            <div class="text-[8px] text-slate-400 mt-0.5">‡∏ú‡∏π‡πâ‡∏¢‡πâ‡∏≤‡∏¢</div>
                        </div>
                    </div>
                    
                    <div class="w-[20%] flex flex-col items-center justify-center pt-3 text-indigo-300 animate-pulse">
                        <i class="fa-solid fa-arrow-right-long"></i>
                    </div>
                    
                    <div class="flex flex-col items-center w-[40%] text-center gap-1">
                        <img src="${newBossImg}" class="w-10 h-10 rounded-full border border-indigo-200 object-cover bg-indigo-50">
                        <div class="w-full">
                            <div class="text-[10px] leading-tight font-bold text-indigo-700 break-words">${bossFullName}</div>
                            <div class="text-[8px] text-indigo-400 mt-0.5">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</div>
                        </div>
                    </div>
                </div>`;

        } else {
            // ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏õ‡∏•‡∏î‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î)
            sub.affiliationId = null;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏£‡πâ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
            newItemHtml = `
                <div class="flex items-center justify-between p-3 bg-red-50 border border-red-100 rounded-xl mb-2">
                    <div class="flex items-center gap-3 w-full">
                        <img src="${subImg}" class="w-10 h-10 rounded-full border border-red-200 grayscale opacity-80 object-cover shrink-0">
                        <div class="min-w-0 flex-1">
                            <div class="text-[10px] font-bold text-slate-700 leading-tight break-words">${subFullName}</div>
                            <div class="text-[9px] text-red-500 mt-1">
                                <i class="fa-solid fa-link-slash mr-1"></i> ‡∏õ‡∏•‡∏î‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // ‡∏¢‡∏±‡∏î HTML ‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á
        if(listContainer) listContainer.innerHTML += newItemHtml;
    });

    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Modal (‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏ö class hidden)
    if (movedCount > 0 || subordinates.length > 0) {
        saveState(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á LocalStorage
        
        // ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Modal
        const deceasedNameEl = document.getElementById('reas_deceased_name');
        if(deceasedNameEl) {
            deceasedNameEl.innerHTML = typeof getFullDisplayTitle === 'function' 
                ? getFullDisplayTitle(deceasedPerson) 
                : ((deceasedPerson.titlePrefix || '') + ' ' + deceasedPerson.name).trim();
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏ö class hidden
        const modal = document.getElementById('reassignmentModal');
        if(modal) {
            modal.classList.remove('hidden');
        }

        // ‡∏™‡∏±‡πà‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (typeof updateApp === 'function') updateApp();
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal (‡πÄ‡∏û‡∏¥‡πà‡∏° class hidden ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
function closeReassignmentModal() {
    const modal = document.getElementById('reassignmentModal');
    if(modal) {
        modal.classList.add('hidden');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö)
function getValidAffiliationCandidatesFor(subject) {
    let subjectKingReign = 0;
    if (subject.spouseIds && subject.spouseIds.length > 0) {
        subject.spouseIds.forEach(sId => {
            const s = state.members.find(x => x.id === sId);
            if (s && s.isMonarch && s.globalReignNumber) {
                subjectKingReign = parseInt(s.globalReignNumber) || 0;
            }
        });
    }

    const allowedBoromPrefixes = [
        "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"
    ];
    const allowedRelationships = [
        "‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤", 
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ‡πë",
        "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏¢‡∏¢‡∏¥‡∏Å‡∏≤", "‡∏û‡∏£‡∏∞‡∏õ‡∏¥‡∏ï‡∏∏‡∏â‡∏≤"
    ];

    return state.members.filter(m => {
        if (m.id === subject.id) return false;
        if (m.gender !== 'F') return false;
        if (!m.isAlive) return false;

        const rel = m.relationship;
        const prefix = m.titlePrefix ? m.titlePrefix.trim() : "";

        if (rel === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
            let candidateKingReign = 0;
            if (m.spouseIds) {
                m.spouseIds.forEach(sId => {
                    const s = state.members.find(x => x.id === sId);
                    if (s && s.isMonarch && s.globalReignNumber) {
                        candidateKingReign = parseInt(s.globalReignNumber) || 0;
                    }
                });
            }
            if (subjectKingReign > 0 && candidateKingReign > 0) {
                return candidateKingReign <= subjectKingReign;
            }
            return true;
        }

        if (rel === "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå") {
            return allowedBoromPrefixes.includes(prefix);
        }

        if (allowedRelationships.includes(rel)) {
            return true;
        }

        return false;
    });
}

function getAffiliationTitle(p) {
    if (!p) return "";

    // ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤" ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    if (p.relationship === "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤") {
        return getFullDisplayTitle(p);
    }

    const prefix = (p.titlePrefix || "").trim();
    const rank = (p.royalRank || "").trim();
    const name = (p.name || "").trim();
    const suffix = (p.titleSuffix || "").trim();
    const kromRank = (p.kromRank && p.kromRank !== "‡πÑ‡∏°‡πà‡∏°‡∏µ") ? p.kromRank : "";
    const kromTitle = (p.kromTitle || "").trim();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasKrom = kromRank !== "" && kromTitle !== "";

    if (!hasKrom) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ + ‡∏≠‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏¢‡∏® + ‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° + ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
        return [prefix, rank, name, suffix].filter(Boolean).join(" ");
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏£‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ + ‡∏≠‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏¢‡∏®(‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) + ‡∏¢‡∏®‡∏Å‡∏£‡∏° + ‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏° + ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°)
        let parts = [];
        if (prefix) parts.push(prefix);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏¢‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤"
        if (rank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
            parts.push(rank);
        }
        
        parts.push(kromRank + kromTitle);
        if (suffix) parts.push(suffix);
        
        return parts.filter(Boolean).join(" ");
    }
}



</script>

<div id="gazetteModal" class="modal">
    <div class="modal-content w-full max-w-2xl bg-white p-0 overflow-hidden flex flex-col">
        <div class="p-4 bg-slate-100 border-b flex justify-between items-center">
            <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏ä‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏ô‡∏∏‡∏Å‡∏¥‡∏à‡∏à‡πå (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)</h3>
            <button onclick="closeModal('gazetteModal')" class="text-slate-400 hover:text-red-500">‚úï</button>
        </div>
        
        <div id="gazettePrintArea" class="bg-white p-16 mx-auto" style="width: 595px; min-height: 842px; color: black; font-family: 'Sarabun', sans-serif; border: 1px solid #eee;">
            <div class="flex justify-between text-[11px] mb-1 font-bold">
                <span>‡πÄ‡∏•‡πà‡∏° <span id="gz_volume"></span> ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="gz_part"></span> ‡∏á</span>
                <span class="text-center flex-1">‡∏£‡∏≤‡∏ä‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏ô‡∏∏‡∏Å‡∏¥‡∏à‡∏à‡πå</span>
                <span><span id="gz_day_num"></span> <span id="gz_month"></span> <span id="gz_year"></span></span>
            </div>
            <div class="border-t border-black mb-10"></div>

          <div class="text-center mb-8">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Garuda_Trai_Phum_Symbol_%28Black%29.svg/512px-Garuda_Trai_Phum_Symbol_%28Black%29.svg.png" class="w-24 mx-auto mb-4">
    <h1 class="text-[16px] font-bold">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</h1>
    <h2 class="text-[14px] font-bold mt-1" id="gz_subject_name_header"></h2>
    <p id="gz_rank_line_top" class="text-[13px] mt-1"></p> 
</div>

<div class="text-center font-bold text-[18px] mb-8 leading-tight">
    <span id="gz_monarch_head"></span>
</div>
            <div class="px-8 text-justify leading-loose" style="font-size: 13.5px;">
                <p class="indent-10">
                    <span id="gz_monarch_body" class="font-bold"></span> 
                    <span id="gz_monarch_suffix_body" class="font-bold"></span> 
                    <span id="gz_intro_text"></span>
                </p>
                <p class="indent-10 mt-3">
                    <span id="gz_action_text"></span> <span id="gz_naming_text"></span>
                </p>

                <div class="text-center font-bold text-[16px] my-6 leading-relaxed">
                    <span id="gz_new_rank"></span>
                </div>

                <p class="indent-10 mt-4">
                    <span id="gz_blessing_text"></span>
                </p>

                <div class="mt-12 text-center" style="margin-left: 30%;">
                    <p>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="gz_full_date"></span></p>
                    <p class="mt-1">‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà <span id="gz_reign_year"></span> ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    
                    <div class="mt-10">
                        <p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                        <p class="font-bold mt-4">‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏£‡∏±‡∏ê‡∏°‡∏ô‡∏ï‡∏£‡∏µ‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-slate-50 border-t flex gap-3">
            <button onclick="downloadGazettePNG()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (PNG)
            </button>
            <button onclick="closeModal('gazetteModal')" class="px-6 py-2 bg-slate-200 text-slate-600 rounded-xl font-bold">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="chronicleModal" class="modal">
        <div class="modal-content w-full max-w-lg p-0 overflow-hidden flex flex-col h-[70vh]">
            <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h3 class="font-cute text-lg"><i class="fa-solid fa-book-bookmark mr-2"></i>‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£</h3>
                <button onclick="closeModal('chronicleModal')" class="text-white">‚úï</button>
            </div>
            <div id="chronicleList" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50"></div>
        </div>
    </div>


<div id="creationPopupModal" class="modal">
    <div class="modal-content w-full max-w-sm p-0 overflow-hidden shadow-2xl border-none">
        <div class="bg-indigo-600 p-4 text-white text-center">
            <h3 class="font-royal text-lg tracking-widest">‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</h3>
        </div>
        <div class="p-8 text-center destiny-card">
            <div class="destiny-shimmer"></div>
            
            <div class="relative z-10">
                <div class="w-24 h-24 mx-auto mb-4 relative">
                    <img id="cp_img" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-md">
                    <div id="cp_icon" class="absolute -bottom-2 -right-2 bg-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg text-2xl"></div>
                </div>

                <div class="mb-6">
                    <div id="cp_rank" class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mb-1"></div>
                    <h2 id="cp_name" class="font-royal text-xl text-slate-800 font-bold leading-tight"></h2>
                </div>

                <div class="bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-indigo-100 shadow-inner">
                    <div id="cp_destiny_label" class="font-bold text-indigo-600 mb-1"></div>
                    <p id="cp_destiny_desc" class="text-xs text-slate-500 italic leading-relaxed"></p>
                    <div id="cp_destiny_poem" class="text-[10px] text-slate-400 italic mt-4 whitespace-pre-line leading-relaxed border-t pt-4 border-indigo-50"></div>
                </div>

                <button onclick="closeModal('creationPopupModal')" class="mt-8 w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-indigo-200">
                    ‡∏ô‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
                </button>
            </div>
        </div>
    </div>
</div>    
<div id="parentViewModal" class="modal">
    <div class="modal-content w-full max-w-sm p-6 relative overflow-hidden bg-white/95 backdrop-blur rounded-3xl border border-white shadow-2xl">
        <button onclick="closeModal('parentViewModal')" class="absolute top-3 right-3 text-slate-300 hover:text-slate-500 transition"><i class="fa-solid fa-times text-lg"></i></button>
        
        <div class="text-center mb-6">
            <h3 id="parent_view_title" class="font-royal text-lg font-bold text-indigo-800 leading-tight px-2">
                ‡∏ö‡∏¥‡∏î‡∏≤-‡∏°‡∏≤‡∏£‡∏î‡∏≤
            </h3>
            <div class="h-1 w-16 bg-indigo-200 mx-auto mt-2 rounded-full"></div>
        </div>

        <div class="space-y-4">
            <div id="view_father_card" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex items-center gap-3 cursor-pointer hover:bg-blue-100 hover:shadow-md transition group">
                <div class="relative flex-shrink-0">
                    <img id="view_father_img" src="" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm bg-blue-100 group-hover:scale-105 transition">
                    <div class="absolute -bottom-1 -right-1 bg-blue-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold shadow-sm">‡∏ö‡∏¥‡∏î‡∏≤</div>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-0.5">‡∏ö‡∏¥‡∏î‡∏≤</div>
                    <div id="view_father_name" class="text-sm font-bold text-slate-700 leading-snug break-words"></div>
                    <div class="text-[10px] text-slate-400 mt-1 hidden group-hover:block"><i class="fa-solid fa-eye mr-1"></i>‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                </div>
            </div>

            <div id="view_mother_card" class="bg-pink-50 p-4 rounded-2xl border border-pink-100 flex items-center gap-3 cursor-pointer hover:bg-pink-100 hover:shadow-md transition group">
                <div class="relative flex-shrink-0">
                    <img id="view_mother_img" src="" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm bg-pink-100 group-hover:scale-105 transition">
                    <div class="absolute -bottom-1 -right-1 bg-pink-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold shadow-sm">‡∏°‡∏≤‡∏£‡∏î‡∏≤</div>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-[10px] text-pink-400 font-bold uppercase tracking-wider mb-0.5">‡∏°‡∏≤‡∏£‡∏î‡∏≤</div>
                    <div id="view_mother_name" class="text-sm font-bold text-slate-700 leading-snug break-words"></div>
                    <div class="text-[10px] text-slate-400 mt-1 hidden group-hover:block"><i class="fa-solid fa-eye mr-1"></i>‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                </div>
            </div>
        </div>
        </div>
</div>

<div id="editKulachetModal" class="modal">
    <div class="modal-content w-full max-w-md p-0 overflow-hidden border-4 border-purple-100 rounded-[32px]">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-center text-white relative">
            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2 border-2 border-white/30 shadow-inner">
                <i class="fa-solid fa-crown text-2xl"></i>
            </div>
            <h3 class="font-royal font-bold text-2xl tracking-wide">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢</h3>
            <p class="text-[11px] opacity-80 italic">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏£‡∏∞‡∏Å‡∏∏‡∏•‡πÄ‡∏ä‡∏©‡∏ê‡πå</p>
        </div>

        <div class="p-8 bg-white space-y-6">
            <div class="flex items-center justify-between gap-4">
                <div class="flex-1 space-y-2">
                    <label class="text-[11px] font-bold text-purple-600 uppercase tracking-widest ml-1">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà</label>
                    <input type="number" id="reign_start_num" 
                           class="w-full bg-slate-50 border-2 border-slate-100 focus:border-purple-400 focus:bg-white rounded-2xl px-4 py-4 text-center text-xl font-bold text-slate-700 outline-none transition-all shadow-sm" 
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πô">
                </div>
                
                <div class="pt-6 font-bold text-slate-300">‡∏ñ‡∏∂‡∏á</div>
                
                <div class="flex-1 space-y-2">
                    <label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="number" id="reign_end_num" 
                           class="w-full bg-slate-50 border-2 border-slate-100 focus:border-purple-300 focus:bg-white rounded-2xl px-4 py-4 text-center text-xl font-bold text-slate-700 outline-none transition-all shadow-sm" 
                           placeholder="...">
                </div>
            </div>

            <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100 min-h-[50px] flex items-center justify-center">
                <div id="reign_preview_text" class="text-center font-bold text-purple-800 text-sm italic">
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•
                </div>
            </div>

            <input type="hidden" id="edit_kulachet_index">

            <div class="flex flex-col gap-3">
                <button onclick="saveKulachetReignEdit()" 
                        class="w-full py-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold rounded-2xl text-lg shadow-lg shadow-purple-200 hover:scale-[1.02] active:scale-95 transition-all">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="closeModal('editKulachetModal')" 
                        class="w-full py-2 text-sm text-slate-400 hover:text-purple-600 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
</div>

<div id="reassignmentModal" class="hidden fixed inset-0 z-[9999] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300">
    <div class="modal-content w-full max-w-md bg-white rounded-[2rem] shadow-2xl overflow-hidden border-4 border-white/50 modal-pop-spring mx-4">
        
        <div class="bg-slate-800 p-5 text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div class="relative z-10">
                <div class="w-10 h-10 mx-auto bg-amber-400 rounded-full flex items-center justify-center shadow-lg mb-2 text-slate-900">
                    <i class="fa-solid fa-scroll text-xl"></i>
                </div>
                <h3 class="font-royal text-xl text-amber-100 tracking-wider">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</h3>
                <p class="text-[10px] text-slate-400 font-light mt-1">ROYAL REASSIGNMENT ORDER</p>
            </div>
        </div>

        <div class="p-6 bg-[#fcfcfc]">
            <div class="text-center mb-6">
                <p class="text-slate-500 text-xs font-bold mb-2">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå‡∏Ç‡∏≠‡∏á</p>
                <div class="inline-block relative">
                    <div class="absolute -inset-1 bg-gradient-to-r from-red-100 to-slate-100 rounded-lg blur opacity-50"></div>
                    <h4 id="reas_deceased_name" class="relative text-lg font-bold text-slate-800 border-b-2 border-red-200 pb-1 px-4">
                        </h4>
                </div>
            </div>
            
            <div class="flex items-center gap-3 mb-4">
                <div class="h-px bg-slate-200 flex-1"></div>
                <p class="text-indigo-800 text-[10px] font-bold bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                    ‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢
                </p>
                <div class="h-px bg-slate-200 flex-1"></div>
            </div>

            <div id="reas_list_container" class="max-h-[250px] overflow-y-auto custom-scrollbar space-y-2 pr-1">
                </div>
        </div>

        <div class="p-4 bg-white border-t border-slate-100 text-center">
            <button onclick="closeReassignmentModal()" 
                    class="w-full py-3 bg-gradient-to-r from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white rounded-xl font-bold shadow-lg shadow-slate-200 transform transition hover:-translate-y-0.5">
                ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            </button>
        </div>
    </div>
</div>




</body>
</html>
