<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Family Tree (Succession & Polygamy Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Mali:wght@400;600&family=Chakra+Petch:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* ================= THEME VARIABLES ================= */
        :root {
            --bg-main: #f8fafc;
            --bg-dots: #e2e8f0;
            --text-main: #334155;
            --text-sub: #64748b;
            --primary: #475569;
            --primary-light: #94a3b8;
            --accent-bg: #ffffff;
            --accent-border: #e2e8f0;
            --card-shadow: rgba(0, 0, 0, 0.05);
            --line-color: #cbd5e1;
            --line-width: 1.5px;
        }

        /* Themes */
        [data-theme="pink"] { --bg-main: #fff0f5; --bg-dots: #fbcfe8; --text-main: #831843; --text-sub: #be185d; --primary: #ec4899; --primary-light: #f9a8d4; --accent-bg: #fff; --accent-border: #fbcfe8; --line-color: #f472b6; }
        [data-theme="purple"] { --bg-main: #faf5ff; --bg-dots: #e9d5ff; --text-main: #581c87; --text-sub: #7e22ce; --primary: #a855f7; --primary-light: #d8b4fe; --accent-bg: #fff; --accent-border: #e9d5ff; --line-color: #c084fc; }
        [data-theme="yellow"] { --bg-main: #fffbeb; --bg-dots: #fde68a; --text-main: #78350f; --text-sub: #b45309; --primary: #f59e0b; --primary-light: #fcd34d; --accent-bg: #fff; --accent-border: #fde68a; --line-color: #fbbf24; }
        [data-theme="blue"] { --bg-main: #f0f9ff; --bg-dots: #bae6fd; --text-main: #0c4a6e; --text-sub: #0284c7; --primary: #0ea5e9; --primary-light: #7dd3fc; --accent-bg: #fff; --accent-border: #bae6fd; --line-color: #38bdf8; }

        /* ================= GENERAL STYLES ================= */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        h1, h2, h3, .font-cute { font-family: 'Mali', cursive; }
        .font-royal { font-family: 'Chakra Petch', sans-serif; }

        /* ================= CANVAS AREA (SVG) ================= */
        #canvas-container {
            flex: 1;
            position: relative;
            cursor: grab;
            background-color: var(--bg-main);
            background-image: radial-gradient(var(--bg-dots) 1px, transparent 1px);
            background-size: 24px 24px;
            overflow: hidden;
        }
        #canvas-container:active { cursor: grabbing; }

        #main-svg { width: 100%; height: 100%; display: block; }

        /* Nodes inside SVG */
        .node-box {
            width: 100%; height: 100%;
            background: var(--accent-bg);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 8px 6px;
            box-shadow: 0 4px 15px -3px var(--card-shadow);
            border-width: 2px;
            border-style: solid;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-sizing: border-box;
            position: relative;
        }
        .node-box:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.15); z-index: 10; border-color: var(--primary); }
        .node-box.focused { box-shadow: 0 0 0 4px var(--primary-light); animation: pulse-border 2s infinite; }

        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0px var(--primary-light); } 100% { box-shadow: 0 0 0 8px rgba(0,0,0,0); } }

        /* Status Borders */
        .border-male { border-color: #38bdf8; } 
        .border-female { border-color: #c084fc; } 
        .border-king { border-color: #fbbf24; background: linear-gradient(to bottom, #fff, #fffbeb); } 
        .border-queen { border-color: #f472b6; background: linear-gradient(to bottom, #fff, #fff0f5); }
        
        /* Death Visuals */
        .border-dead { filter: grayscale(1) opacity(0.8); border-style: dashed !important; border-color: #64748b !important; }
        
        /* Monarch Death: Black Border, Normal Image */
        .border-dead-royal { 
            border-color: #000000 !important; 
            border-width: 3px !important;
            background: #f8f8f8;
            /* No grayscale filter here, handled on image */
        }
        
        .img-grayscale { filter: grayscale(1); }
        .img-normal { filter: none; }

        /* Connectors */
        .connector { fill: none; stroke: var(--line-color); stroke-width: var(--line-width); transition: stroke 0.3s; }
        .connector:hover { stroke: var(--primary); stroke-width: 2.5px; }
        .heart-icon { font-size: 14px; fill: #ef4444; filter: drop-shadow(0px 1px 2px rgba(255, 255, 255, 0.8)); }

        /* ================= TABLE VIEW ================= */
        .table-view-container {
            background-color: var(--bg-main);
            overflow-y: auto;
            flex: 1;
            padding: 2rem;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { color: var(--text-sub); font-weight: 600; padding: 12px; font-size: 14px; border-bottom: 2px solid var(--accent-border); white-space: nowrap; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--accent-border); background: var(--accent-bg); color: var(--text-main); font-size: 14px; vertical-align: middle; }
        tr.data-row:hover td { background-color: var(--bg-dots); cursor: pointer; }
        tr.data-row:first-child td:first-child { border-top-left-radius: 16px; }
        tr.data-row:first-child td:last-child { border-top-right-radius: 16px; }
        tr.data-row:last-child td:first-child { border-bottom-left-radius: 16px; }
        tr.data-row:last-child td:last-child { border-bottom-right-radius: 16px; }

        /* ================= UI CONTROLS ================= */
        .floating-controls {
            position: absolute; bottom: 24px; right: 24px;
            display: flex; flex-direction: column; gap: 8px; z-index: 50;
        }
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-bg); border: 1px solid var(--accent-border);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .ctrl-btn:hover { transform: scale(1.1); background: var(--bg-dots); }

        .btn-theme { background-color: var(--primary); color: white; border-radius: 50px; font-weight: 600; padding: 6px 16px; font-size: 12px; transition: all 0.2s; }
        .btn-theme:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-icon { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--primary); border-radius: 50%; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-dots); transform: scale(1.1); }

        .input-theme { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--text-main); border-radius: 12px; padding: 8px; outline: none; }
        .input-theme:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--bg-dots); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 24px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2); }

        /* Fantasy Celebration Modal */
        #fantasyModal .modal-content {
            background: linear-gradient(135deg, #1a0b00 0%, #4a2c0a 100%);
            border: 2px solid #d4af37;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3), inset 0 0 30px rgba(0,0,0,0.8);
            color: #f3e5ab;
            max-width: 500px;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 40px 20px;
        }
        .golden-frame {
            border: 3px double #d4af37;
            padding: 4px;
            display: inline-block;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            background: #000;
        }
        .shimmer-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            animation: shimmer 3s infinite linear;
            background-size: 200% auto;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        .particle { position: absolute; background: #ffd700; border-radius: 50%; opacity: 0; animation: rise 4s infinite ease-in; }
        @keyframes rise { 0% { bottom: -10px; opacity: 0; transform: scale(0); } 50% { opacity: 1; } 100% { bottom: 100%; opacity: 0; transform: scale(1); } }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; }
        .toast { background: #334155; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideUp 0.3s ease-out; opacity: 0.9; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 0.9; } }

        /* Monarch Banner */
        .monarch-frame { border: 2px solid #fbbf24; background: linear-gradient(to right, #fffbeb, #fff); box-shadow: 0 4px 6px rgba(251, 191, 36, 0.2); }
        
        /* Badges for Tree */
        .badge-monarch { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-krom { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-heir { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="sticky top-0 z-40 px-4 py-3" style="background-color: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--accent-border);">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center shadow-md text-white" style="background: var(--primary);">
                    <i class="fa-solid fa-chess-king"></i>
                </div>
                <div>
                    <h1 class="text-xl font-cute font-bold tracking-wide" style="color: var(--text-main);">Royal Family Tree</h1>
                    <p class="text-[10px] text-slate-400">Succession & Polygamy Edition</p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 items-center justify-center">
                <!-- Theme Switcher -->
                <div class="flex gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100 mr-2">
                    <button onclick="setTheme('white')" class="w-4 h-4 rounded-full border border-gray-300 bg-gray-50"></button>
                    <button onclick="setTheme('pink')" class="w-4 h-4 rounded-full border border-pink-300 bg-pink-400"></button>
                    <button onclick="setTheme('purple')" class="w-4 h-4 rounded-full border border-purple-300 bg-purple-400"></button>
                    <button onclick="setTheme('yellow')" class="w-4 h-4 rounded-full border border-yellow-300 bg-yellow-400"></button>
                    <button onclick="setTheme('blue')" class="w-4 h-4 rounded-full border border-blue-300 bg-blue-400"></button>
                </div>

                <!-- View Switcher -->
                <div class="flex bg-white/50 p-1 rounded-full border border-slate-200 mr-2">
                    <button onclick="switchView('tree')" id="btn-view-tree" class="px-3 py-1 text-xs rounded-full transition font-bold" style="background: var(--primary); color: white;">
                        <i class="fa-solid fa-sitemap mr-1"></i> ผัง
                    </button>
                    <button onclick="switchView('table')" id="btn-view-table" class="px-3 py-1 text-xs rounded-full transition text-slate-500 hover:text-slate-700">
                        <i class="fa-solid fa-table mr-1"></i> ตาราง
                    </button>
                </div>

                <!-- Focus Search -->
                <div class="relative">
                    <input type="text" id="focusSearch" list="focusOptions" placeholder="ค้นหาบุคคล..." class="pl-8 pr-3 py-1.5 text-xs rounded-full border border-slate-200 focus:border-primary focus:ring-1 focus:ring-primary outline-none bg-white/80 w-32 transition-all focus:w-48" onchange="focusOnPerson(this.value)">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <datalist id="focusOptions"></datalist>
                </div>

                <!-- Actions -->
                <button onclick="openCreateKingdomModal()" class="btn-icon w-9 h-9 flex items-center justify-center shadow-sm ml-2" title="สร้างอาณาจักร"><i class="fa-solid fa-plus"></i></button>
                <button onclick="openRankManagementModal()" class="btn-icon w-9 h-9 flex items-center justify-center shadow-sm" title="จัดการยศ"><i class="fa-solid fa-sliders"></i></button>
                <button onclick="resetData()" class="btn-icon w-9 h-9 flex items-center justify-center shadow-sm text-red-400" title="รีเซต"><i class="fa-solid fa-rotate-right"></i></button>
                
                <button onclick="openAddRootModal()" class="btn-theme flex items-center space-x-2"><i class="fa-solid fa-user-plus"></i><span>เพิ่มคนแรก</span></button>

                <!-- Monarch Banner (Fixed Visibility) -->
                <div id="monarchBannerContainer" class="ml-2 flex items-center">
                    <!-- Active Monarch -->
                    <div id="monarchBanner" class="hidden monarch-frame rounded-full pl-1 pr-4 py-1 flex items-center gap-2 transition-all duration-500 cursor-pointer hover:scale-105" onclick="focusOnMonarch()">
                        <div class="relative">
                            <img id="monarchImg" src="" class="w-9 h-9 rounded-full border-2 border-white shadow-sm object-cover">
                            <i class="fa-solid fa-crown text-[10px] text-yellow-500 absolute -top-1 -right-1 bg-white rounded-full p-0.5 shadow-sm"></i>
                        </div>
                        <div class="text-xs text-left">
                            <div class="text-[9px] text-amber-600 font-bold uppercase tracking-wide">พระมหากษัตริย์</div>
                            <div id="monarchName" class="font-bold leading-none text-slate-800 text-[11px]">-</div>
                        </div>
                    </div>
                    <!-- Vacant Throne -->
                    <div id="monarchVacant" class="hidden bg-red-50 border border-red-200 text-red-600 rounded-full px-3 py-1 flex items-center gap-2 text-xs shadow-sm animate-pulse">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <span class="font-bold hidden md:inline">บัลลังก์ว่าง</span>
                        <button onclick="openAppointModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full font-bold shadow-sm transition text-[10px]">สถาปนา</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- Tree View -->
        <div id="canvas-container" class="flex-1">
            <svg id="main-svg">
                <g id="viewport-group">
                    <g id="links-layer"></g>
                    <g id="nodes-layer"></g>
                </g>
            </svg>
            
            <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div class="bg-white/80 backdrop-blur p-6 rounded-2xl shadow-xl text-center max-w-sm pointer-events-auto border-2 border-dashed border-slate-300">
                    <div class="text-4xl mb-4 text-slate-300"><i class="fa-solid fa-sitemap"></i></div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2">ยังไม่มีข้อมูลในราชวงศ์นี้</h3>
                    <button onclick="openAddRootModal()" class="btn-theme w-full">สร้างบุคคลแรก</button>
                </div>
            </div>

            <div class="floating-controls">
                <button class="ctrl-btn" onclick="toggleOrientation()" title="สลับแนว"><i class="fa-solid fa-rotate"></i></button>
                <div class="h-px w-6 bg-slate-300 mx-auto my-1"></div>
                <button class="ctrl-btn" onclick="zoomIn()"><i class="fa-solid fa-plus"></i></button>
                <button class="ctrl-btn" onclick="zoomOut()"><i class="fa-solid fa-minus"></i></button>
                <button class="ctrl-btn" onclick="resetView()"><i class="fa-solid fa-crosshairs"></i></button>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="table-view-container hidden">
            <div class="container mx-auto max-w-5xl">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="font-cute text-2xl" style="color: var(--primary);">รายชื่อสมาชิก</h2>
                    <div class="flex gap-2 items-center flex-wrap justify-center">
                        <select id="tableFilterStatus" class="bg-white px-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition cursor-pointer" onchange="renderTable()">
                            <option value="all">แสดงทั้งหมด</option>
                            <option value="alive" selected>เฉพาะผู้มีชีวิต</option>
                            <option value="dead">เฉพาะผู้เสียชีวิต</option>
                        </select>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-search text-slate-400 group-focus-within:text-primary transition"></i>
                            </div>
                            <input type="text" id="tableSearch" oninput="renderTable()" placeholder="ค้นหาชื่อ, ฉายา..." class="pl-10 pr-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary focus:ring-2 focus:ring-blue-100 outline-none transition w-64 bg-white shadow-sm">
                        </div>
                    </div>
                </div>
                <div class="rounded-[20px] shadow-sm border overflow-hidden" style="background: var(--accent-bg); border-color: var(--accent-border);">
                    <table class="w-full text-left">
                        <thead>
                            <tr style="background: var(--bg-dots);">
                                <th class="text-center w-20">รูป</th>
                                <th>พระนาม / นาม</th>
                                <th>สถานะ</th>
                                <th>บิดา / มารดา</th>
                                <th class="text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content w-full max-w-sm overflow-hidden relative border-4 border-white">
            <button onclick="closeModal('detailModal')" class="absolute top-3 right-3 text-white bg-black/10 rounded-full w-8 h-8 z-20 hover:bg-black/20 backdrop-blur-sm flex items-center justify-center transition">✕</button>
            
            <div class="h-48 relative overflow-hidden" style="background: linear-gradient(to top right, var(--bg-dots), var(--primary-light));">
                <div class="absolute inset-0 opacity-30 mix-blend-overlay bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="absolute -bottom-10 left-1/2 -translate-x-1/2 flex flex-col items-center">
                    <div class="relative">
                        <img id="d_img" class="w-28 h-28 rounded-full border-[4px] border-white bg-white object-cover shadow-lg aspect-square">
                        <i id="d_crown" class="fa-solid fa-crown absolute -top-6 left-1/2 -translate-x-1/2 text-3xl text-yellow-400 drop-shadow-md hidden filter saturate-150 animate-pulse"></i>
                    </div>
                </div>
            </div>

            <div class="pt-14 pb-8 px-6 text-center" style="background: var(--accent-bg);">
                <h3 id="d_name" class="text-lg font-royal font-bold leading-tight mb-1" style="color: var(--text-main);"></h3>
                <div class="flex justify-center items-center gap-2 mb-3">
                    <div class="text-[10px] font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-500 flex items-center gap-1 cursor-pointer hover:bg-gray-200 transition" onclick="copyToClipboard(window.curPID)">
                        <span id="d_id"></span> <i class="fa-regular fa-copy"></i>
                    </div>
                </div>
                
                <!-- Added back the missing d_krom element -->
                <p id="d_krom" class="text-xs font-bold text-amber-600 bg-amber-50 inline-block px-4 py-1.5 rounded-xl mb-4 border border-amber-200 shadow-sm hidden"></p>

                <div id="d_badges" class="flex flex-wrap justify-center gap-2 mb-4"></div>

                <div class="grid grid-cols-1 gap-2 mb-4">
                    <button onclick="setAsRoot(window.curPID)" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-sitemap"></i> ดูผังพงศาวลีของคนนี้
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openAddSpouseModal(window.curPID)" class="py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-heart"></i> เพิ่มคู่สมรส
                        </button>
                        <button onclick="openAddChildModal(window.curPID)" class="py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-baby"></i> เพิ่มลูก
                        </button>
                    </div>
                    <button onclick="openAddParentModal(window.curPID)" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-up"></i> เพิ่มพระบิดา/พระมารดา
                    </button>
                </div>

                <div id="d_statusBox" class="text-left text-sm space-y-2 p-4 rounded-3xl border shadow-inner mb-4" style="background: var(--bg-main); border-color: var(--accent-border);">
                    <div class="flex justify-between"><span class="text-xs text-slate-400">สถานะ</span><span id="d_status" class="font-bold"></span></div>
                    <div class="flex justify-between"><span class="text-xs text-slate-400">คู่สมรส</span><span id="d_spouses_count"></span></div>
                    <div class="flex justify-between"><span class="text-xs text-slate-400">ฉัตร</span><span id="d_umbrella"></span></div>
                </div>

                <div class="flex gap-2 justify-center border-t pt-4 border-slate-100">
                    <button onclick="editCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="แก้ไข"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="toggleDeath()" id="btnDeath" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="แจ้งตาย/คืนชีพ"><i class="fa-solid fa-skull"></i></button>
                    <button onclick="deleteCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-red-400" title="ลบ"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Person Form Modal -->
    <div id="personModal" class="modal">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b" style="background: var(--bg-dots);">
                <h2 id="modalTitle" class="font-cute font-bold text-lg"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ข้อมูลบุคคล</h2>
                <button onclick="closeModal('personModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1" style="background: var(--accent-bg);">
                <form id="personForm" onsubmit="handleSavePerson(event)" class="space-y-6">
                    <input type="hidden" id="p_isEditMode">
                    
                    <div class="flex gap-8 flex-col md:flex-row">
                        <!-- Image Upload -->
                        <div class="flex-shrink-0 flex flex-col items-center gap-3">
                            <div class="w-36 h-36 rounded-full border-4 flex items-center justify-center overflow-hidden relative group cursor-pointer transition shadow-sm" style="background: var(--bg-dots);" onclick="document.getElementById('p_imageFile').click()">
                                <img id="p_imagePreview" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white transition backdrop-blur-sm"><i class="fa-solid fa-camera text-2xl"></i></div>
                            </div>
                            <input type="file" id="p_imageFile" accept="image/*" class="hidden" onchange="handleImageUpload(this)"><input type="hidden" id="p_imageFinal">
                            <div class="flex gap-2">
                                <label class="cursor-pointer bg-blue-50 text-blue-500 px-4 py-1.5 rounded-full text-xs font-bold border border-blue-100 peer-checked:bg-blue-400 peer-checked:text-white transition"><input type="radio" name="gender" value="M" checked class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();"> ชาย</label>
                                <label class="cursor-pointer bg-pink-50 text-pink-500 px-4 py-1.5 rounded-full text-xs font-bold border border-pink-100 peer-checked:bg-pink-400 peer-checked:text-white transition"><input type="radio" name="gender" value="F" class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();"> หญิง</label>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                                <input type="checkbox" id="p_isAlive" checked class="accent-emerald-500 rounded"> <span class="text-xs text-emerald-600 font-bold">มีชีวิตอยู่</span>
                            </label>
                        </div>

                        <!-- Info Fields -->
                        <div class="flex-1 space-y-4">
                            <!-- ID Row -->
                            <div class="flex gap-2 items-end bg-slate-50 p-2 rounded-lg border border-slate-100">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-slate-500">ID (อัตโนมัติ)</label>
                                    <input type="text" id="p_id" readonly class="w-full text-sm font-mono bg-transparent border-none focus:ring-0 text-slate-600">
                                </div>
                                <button type="button" onclick="copyToClipboard(document.getElementById('p_id').value)" class="p-1.5 text-xs bg-white border rounded shadow-sm hover:bg-slate-50">คัดลอก</button>
                            </div>

                            <!-- Parents -->
                            <div class="p-4 rounded-[25px] border grid grid-cols-1 md:grid-cols-2 gap-4" style="background: var(--bg-dots);">
                                <div>
                                    <label class="text-xs font-bold text-indigo-400 mb-1 block ml-2">พระบิดา</label>
                                    <div class="flex gap-1 relative">
                                        <input type="text" id="p_fatherSearch" list="fatherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="ค้นหา ID/ชื่อ..." onchange="validateParent('father')">
                                        <datalist id="fatherOptions"></datalist><input type="hidden" id="p_fatherId">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-pink-400 mb-1 block ml-2">พระมารดา</label>
                                    <div class="flex gap-1 relative">
                                        <input type="text" id="p_motherSearch" list="motherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="ค้นหา ID/ชื่อ..." onchange="validateParent('mother')">
                                        <datalist id="motherOptions"></datalist><input type="hidden" id="p_motherId">
                                    </div>
                                </div>
                            </div>

                            <!-- Name Info -->
                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-12 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">ความสัมพันธ์</label>
                                    <select id="p_relationship" class="w-full text-sm input-theme" onchange="updatePrefixOptions(); checkQueenConsortEligible()"></select>
                                </div>
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">คำนำหน้า</label>
                                    <select id="p_titlePrefix" class="w-full text-sm input-theme" onchange="updateSuffixOptions()"></select>
                                </div>
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">อิสริยยศ</label>
                                    <select id="p_royalRank" class="w-full text-sm input-theme" onchange="updateAutoId()">
                                        <option value="เจ้าฟ้า (ชั้นเอก)">เจ้าฟ้า (ชั้นเอก)</option>
                                        <option value="เจ้าฟ้า (ชั้นโท)">เจ้าฟ้า (ชั้นโท)</option>
                                        <option value="เจ้าฟ้า (ชั้นตรี)">เจ้าฟ้า (ชั้นตรี)</option>
                                        <option value="พระองค์เจ้า (ชั้นเอก)">พระองค์เจ้า (ชั้นเอก)</option>
                                        <option value="พระองค์เจ้า (ชั้นโท)">พระองค์เจ้า (ชั้นโท)</option>
                                        <option value="หม่อมเจ้า">หม่อมเจ้า</option>
                                        <option value="เจ้าประเทศราช">เจ้าประเทศราช</option>
                                        <option value="สามัญชน">สามัญชน</option>
                                    </select>
                                </div>
                                
                                <div class="col-span-12">
                                     <label class="flex items-center gap-2 cursor-pointer ml-2">
                                        <input type="checkbox" id="p_hideRoyalRank" class="accent-slate-500 rounded">
                                        <span class="text-xs text-slate-500">ไม่แสดงอิสริยยศ</span>
                                    </label>
                                </div>     

                                <div class="col-span-8">
                                    <label class="text-xs font-bold ml-2 text-primary">พระนาม *</label>
                                    <input type="text" id="p_name" required class="w-full font-bold input-theme">
                                </div>
                                <div class="col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">ชื่อเล่น</label>
                                    <input type="text" id="p_nickname" class="w-full text-sm input-theme">
                                </div>
                                
                                

                                <div class="col-span-12 md:col-span-6"><label class="text-xs ml-2 text-slate-400">สร้อยพระนาม</label><select id="p_titleSuffix" class="w-full text-sm input-theme"></select></div>
                                <div class="col-span-6 md:col-span-3"><label class="text-xs ml-2 text-slate-400">ยศกรม</label><select id="p_kromRank" class="w-full text-sm input-theme" onchange="toggleKrom()"><option value="">-</option><option value="กรมหมื่น">กรมหมื่น</option><option value="กรมขุน">กรมขุน</option><option value="กรมหลวง">กรมหลวง</option><option value="กรมพระ">กรมพระ</option><option value="กรมพระยา">กรมพระยา</option><option value="สมเด็จกรมพระ">สมเด็จกรมพระ</option></select></div>
                                <div class="col-span-6 md:col-span-3"><label class="text-xs ml-2 text-slate-400">ราชทินนามกรม</label><input type="text" id="p_kromTitle" class="w-full text-sm hidden input-theme"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Extra: Umbrella & Spouses -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="p_hasUmbrella" class="accent-amber-500 w-4 h-4" onchange="toggleUmbrella()">
                                <label class="text-sm font-bold text-amber-700">ได้รับพระราชทานฉัตร</label>
                            </div>
                            <select id="p_umbrellaType" class="w-full text-sm input-theme hidden">
                                <option value="ตรีดลเศวตฉัตร">ตรีดลเศวตฉัตร (3 ชั้น)</option>
                                <option value="เบญจดลเศวตฉัตร">เบญจดลเศวตฉัตร (5 ชั้น)</option>
                                <option value="สัปตดลเศวตฉัตร">สัปตดลเศวตฉัตร (7 ชั้น)</option>
                                <option value="นพดลมหาเศวตฉัตร">นพดลมหาเศวตฉัตร (9 ชั้น)</option>
                            </select>
                        </div>
                        <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-sm font-bold text-rose-400">คู่สมรส</h3>
                                <div class="flex gap-1">
                                    <input type="text" id="p_spouseSearch" list="spouseOptions" class="text-xs w-28 rounded-full input-theme" placeholder="ค้นหา...">
                                    <datalist id="spouseOptions"></datalist>
                                    <button type="button" onclick="addSpouse()" class="bg-rose-300 text-white w-6 h-6 rounded-full text-xs hover:bg-rose-400">+</button>
                                </div>
                            </div>
                            <ul id="p_spouseList" class="flex flex-wrap gap-2 text-xs"></ul>
                        </div>
                    </div>

                    <!-- Roles -->
                    <div class="flex flex-wrap gap-4 pt-2 items-center">
                        <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-amber-50 border-amber-100">
                            <input type="checkbox" id="p_isMonarch" class="accent-amber-400 w-4 h-4" onchange="toggleMonarch()">
                            <span class="text-sm font-bold text-amber-600">กษัตริย์/ราชินีนาถ</span>
                        </label>
                        <div class="flex items-center gap-2 px-4 py-2 rounded-2xl border transition bg-blue-50 border-blue-100">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="p_isHeir" class="accent-blue-400 w-4 h-4" onchange="toggleHeirOrder()">
                                <span class="text-sm font-bold text-blue-600">รัชทายาท</span>
                            </label>
                            <input type="number" id="p_heirOrder" min="1" placeholder="ลำดับ" class="w-16 text-xs input-theme hidden border-blue-200 text-blue-800 font-bold text-center">
                        </div>
                         <label id="queenConsortOption" class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-pink-50 border-pink-100 hidden">
                            <input type="checkbox" id="p_isQueenConsort" class="accent-pink-400 w-4 h-4">
                            <span class="text-sm font-bold text-pink-600">พระมเหสีคู่บัลลังก์</span>
                        </label>
                    </div>

                    <!-- Monarch Panel -->
                    <div id="monarchPanel" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-200 grid grid-cols-4 gap-3 animate-fade-in">
                        <div class="col-span-4 flex flex-col md:flex-row gap-2 mb-2 bg-white/50 p-2 rounded-xl">
                            <!-- Reign Name Section -->
                            <div class="flex items-center gap-2 flex-1">
                                <input type="checkbox" id="p_useReignName" class="accent-amber-600" onchange="toggleReignName()">
                                <span class="text-xs font-bold text-amber-800">ใช้นามแผ่นดิน</span>
                                <select id="p_reignNameSelect" class="text-xs input-theme hidden flex-1"></select>
                                <span id="p_autoReignNameNumber" class="text-xs font-bold text-amber-600 hidden bg-amber-100 px-2 py-1 rounded"></span>
                            </div>
                            
                            <!-- Global Reign Number Section -->
                            <div class="flex items-center gap-2 border-l pl-2 border-amber-200">
                                <span class="text-xs font-bold text-amber-800">รัชกาลที่ :</span>
                                <input type="number" id="p_globalReignNumber" class="w-16 text-xs font-bold text-center input-theme border-amber-300 text-amber-900" min="1">
                            </div>
                        </div>
                        
                        <input type="text" id="p_reignStart" placeholder="เริ่มครองราชย์ (พ.ศ.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                        <input type="text" id="p_reignEnd" placeholder="สิ้นสุด (พ.ศ.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                        <input type="text" id="p_eraName" placeholder="ชื่อยุคสมัย" class="col-span-2 text-sm bg-white border-amber-100 rounded-lg p-1">
                        
                        <!-- Queen Selector for King -->
                        <div id="maleMonarchQueenSelect" class="col-span-4 mt-2 pt-2 border-t border-amber-200/50 hidden">
                            <label class="text-xs font-bold text-amber-700 block mb-1">แต่งตั้งพระมเหสีคู่บัลลังก์ (จากคู่สมรส)</label>
                            <select id="p_queenSelectForKing" class="text-xs input-theme w-full bg-white/80 border-amber-200 text-pink-700 font-bold">
                                <option value="">-- เลือก --</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="hidden"></button>
                </form>
            </div>
            <div class="p-4 flex justify-end gap-3 border-t" style="background: var(--accent-bg);">
                <button onclick="closeModal('personModal')" class="px-5 py-2 rounded-full transition text-sm font-bold bg-gray-100 text-gray-500 hover:bg-gray-200">ยกเลิก</button>
                <button type="submit" form="personForm" class="px-8 py-2 btn-theme text-sm">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>

    <!-- Initial Setup Modal -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content w-full max-w-sm p-8 text-center relative">
            <button onclick="closeModal('initialSetupModal')" class="absolute top-4 right-4 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-2xl font-cute font-bold mb-2" style="color: var(--text-main);">ยินดีต้อนรับ</h2>
            <p class="text-sm mb-6" style="color: var(--text-sub);">เริ่มต้นสร้างราชวงศ์ของคุณ</p>
            <div class="space-y-3">
                <input type="text" id="setupKingdomName" class="w-full input-theme text-center" placeholder="ชื่ออาณาจักร">
                <input type="text" id="setupDynastyName" class="w-full input-theme text-center" placeholder="ชื่อราชวงศ์">
            </div>
            <button onclick="completeInitialSetup()" class="btn-theme w-full mt-6 py-3 text-lg">เริ่มใช้งาน ✨</button>
        </div>
    </div>

    <!-- Rank & Data Management Modal -->
    <div id="rankManagementModal" class="modal">
        <div class="modal-content rounded-3xl p-0 w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden bg-[#f8fafc]">
            <div class="p-5 bg-white border-b flex justify-between items-center shadow-sm z-10">
                <h2 class="font-cute font-bold text-xl text-slate-800">จัดการข้อมูลและยศ</h2>
                <button onclick="closeModal('rankManagementModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden p-6 gap-4">
                <div class="flex-1 flex flex-col bg-white rounded-2xl border p-4"><h3 class="font-bold mb-2 text-indigo-600">1. ความสัมพันธ์</h3><div class="flex gap-2 mb-2"><input id="nr" class="input-theme w-full text-xs"><button onclick="addData('rel')" class="btn-theme text-xs">+</button></div><ul id="rl" class="overflow-y-auto flex-1 text-sm space-y-1"></ul></div>
                <div class="flex-1 flex flex-col bg-white rounded-2xl border p-4"><h3 class="font-bold mb-2 text-pink-600">2. คำนำหน้า</h3><div class="flex gap-2 mb-2"><input id="np" class="input-theme w-full text-xs"><button onclick="addData('pre')" class="btn-theme text-xs">+</button></div><ul id="pl" class="overflow-y-auto flex-1 text-sm space-y-1"></ul></div>
                <div class="flex-1 flex flex-col bg-white rounded-2xl border p-4"><h3 class="font-bold mb-2 text-emerald-600">3. สร้อยพระนาม</h3><div class="flex gap-2 mb-2"><input id="ns" class="input-theme w-full text-xs"><button onclick="addData('suf')" class="btn-theme text-xs">+</button></div><ul id="sl" class="overflow-y-auto flex-1 text-sm space-y-1"></ul></div>
                <div class="flex-1 flex flex-col bg-white rounded-2xl border p-4 border-amber-200 bg-amber-50/30"><h3 class="font-bold mb-2 text-amber-600">4. นามแผ่นดิน</h3><div class="flex gap-2 mb-2"><input id="nreign" class="input-theme w-full text-xs"><button onclick="addData('reign')" class="btn-theme text-xs">+</button></div><ul id="reignl" class="overflow-y-auto flex-1 text-sm space-y-1"></ul></div>
            </div>
        </div>
    </div>

    <!-- Appoint Modal -->
    <div id="appointModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-lg mb-4 text-red-600">สถาปนาพระมหากษัตริย์</h3>
            <p class="text-xs text-slate-500 mb-4">เลือกผู้สืบราชสมบัติ (ยกเว้น: บาทบริจาริกา, สามัญชน, หม่อมเจ้า)</p>
            <select id="appointSelectModal" class="input-theme w-full mb-4"></select>
            <button onclick="appointFromModal()" class="btn-theme w-full">ยืนยันการสถาปนา</button>
            <button onclick="closeModal('appointModal')" class="mt-2 text-xs text-slate-400">ยกเลิก</button>
        </div>
    </div>

    <!-- Reign Name Selection Modal (NEW) -->
    <div id="reignSelectionModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-lg mb-4 text-amber-600">เลือกพระนามแผ่นดิน</h3>
            <p class="text-xs text-slate-500 mb-4">โปรดเลือกพระนามสำหรับรัชกาลใหม่</p>
            <select id="reignSelectionInput" class="input-theme w-full mb-4"></select>
            <button onclick="confirmReignSelection()" class="btn-theme w-full">ยืนยัน</button>
        </div>
    </div>

    <!-- Fantasy Celebration Modal -->
    <div id="fantasyModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('fantasyModal')" class="absolute top-2 right-2 text-amber-200 hover:text-white z-20">✕</button>
            <div id="fantasyParticles"></div>
            
            <div class="golden-frame">
                <img id="fan_img" src="" class="w-32 h-32 rounded-full object-cover border-4 border-black">
            </div>
            
            <div class="space-y-4 relative z-10">
                <div class="font-royal text-sm text-amber-200 tracking-widest uppercase">ขอถวายพระพร</div>
                <h2 id="fan_name" class="font-royal text-2xl md:text-3xl shimmer-text leading-tight px-4"></h2>
                
                <div class="text-xs text-amber-100/80 font-light mt-4">
                    ราชวงศ์ <span id="fan_dynasty" class="font-bold text-white"></span> แห่งอาณาจักร <span id="fan_kingdom" class="font-bold text-white"></span><br>
                    ทรงได้รับการราชาภิเษกเสวยถวัลยราชสมบัติ<br>
                    เป็น <span id="fan_rama" class="font-bold text-lg text-white"></span>
                </div>

                <div class="my-6 h-px w-3/4 mx-auto bg-gradient-to-r from-transparent via-[#d4af37] to-transparent"></div>

                <p class="text-xs md:text-sm text-amber-100 italic leading-relaxed px-4">
                    "ด้วยพระปรีชาสามารถและพระบรมเดชานุภาพ<br>
                    ขอให้ใต้ฝ่าละอองธุลีพระบาททรงนำพาอาณาประชาราษฎร์สู่ความร่มเย็นผาสุก<br>
                    บ้านเมืองไพบูลย์ เจริญรุ่งเรืองตลอดกาลนาน"
                </p>

                <div class="font-royal text-xl text-[#ffd700] mt-6 animate-pulse">
                    ขอองค์พระมหากษัตริย์รัชกาลใหม่ทรงพระเจริญ
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

<script>
// ================= CORE CONFIG & STATE =================
const DEFAULT_IMG_MALE = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
const DEFAULT_IMG_FEMALE = "https://cdn-icons-png.flaticon.com/512/4128/4128253.png";

const BASE_CONFIG = { nodeWidth: 180, nodeHeight: 100, gapX: 40, gapY: 150, spouseGap: 50 };
let state = {
    kingdomName: "อาณาจักร",
    dynastyName: "ราชวงศ์",
    members: [],
    reignNames: ["พระรามาธิบดี", "พระปรเมนทร", "พระปรมินทร", "พระมหาธรรมราชา", "พระร่วงเจ้า", "พระบรมราชา", "พระมหาจักรพรรดิ"], 
    hierarchy: {
        "พระมหากษัตริย์": { prefixes: ["สมเด็จพระ"], suffixes: { "สมเด็จพระ": ["เจ้าอยู่หัว"] } },
        "พระราชินีนาถ": { prefixes: ["สมเด็จพระนางเจ้า"], suffixes: { "สมเด็จพระนางเจ้า": ["พระบรมราชินีนาถ"] } },
        "พระภรรยาเจ้า": { prefixes: ["สมเด็จพระนางเจ้า"], suffixes: { "สมเด็จพระนางเจ้า": ["พระบรมราชินี", "พระบรมราชเทวี"] } },
        "พระราชโอรส": { prefixes: ["สมเด็จพระเจ้าลูกยาเธอ", "พระเจ้าลูกยาเธอ"], suffixes: { "สมเด็จพระเจ้าลูกยาเธอ": ["บรมราชกุมาร"], "พระเจ้าลูกยาเธอ": ["บวรราชกุมาร"] } },
        "รัชทายาท": { prefixes: ["สมเด็จพระบรมโอรสาธิราช"], suffixes: { "สมเด็จพระบรมโอรสาธิราช": ["สยามมกุฎราชกุมาร"] } },
        "สามัญชน": { prefixes: ["หม่อมราชวงศ์", "หม่อมหลวง", "คุณ"], suffixes: {} }
    },
    currentTheme: 'white',
    zoom: 1, panX: window.innerWidth/2, panY: 50, isDragging: false, isHorizontal: false,
    viewRootId: null, 
    viewMode: 'tree'
};

const RANK_CODES = { "เจ้าฟ้า (ชั้นเอก)":'1', "เจ้าฟ้า (ชั้นโท)":'2', "เจ้าฟ้า (ชั้นตรี)":'3', "พระองค์เจ้า (ชั้นเอก)":'4', "พระองค์เจ้า (ชั้นโท)":'5', "หม่อมเจ้า":'6', "เจ้าประเทศราช":'6', "สามัญชน":'7' };

// ================= INIT =================
window.onload = () => {
    const s = localStorage.getItem('royal_tree_v2');
    if(s) { state = {...state, ...JSON.parse(s)}; }
    else { document.getElementById('initialSetupModal').classList.add('active'); }
    
    setTheme(state.currentTheme || 'white');
    setupPanZoom();
    switchView(state.viewMode || 'tree');
    updateApp();
    populateSearchLists();
};

function saveState() { localStorage.setItem('royal_tree_v2', JSON.stringify(state)); }

function updateApp() {
    if(state.viewMode === 'tree') renderTree();
    else renderTable();
    renderMonarchBanner();
    populateSearchLists();
}

function switchView(mode) {
    state.viewMode = mode;
    saveState();
    const treeBtn = document.getElementById('btn-view-tree');
    const tableBtn = document.getElementById('btn-view-table');
    const canvas = document.getElementById('canvas-container');
    const table = document.getElementById('tableView');

    if(mode === 'tree') {
        canvas.classList.remove('hidden'); table.classList.add('hidden');
        treeBtn.style.background = "var(--primary)"; treeBtn.style.color = "white";
        tableBtn.style.background = "transparent"; tableBtn.style.color = "#64748b";
        renderTree();
    } else {
        canvas.classList.add('hidden'); table.classList.remove('hidden');
        tableBtn.style.background = "var(--primary)"; tableBtn.style.color = "white";
        treeBtn.style.background = "transparent"; treeBtn.style.color = "#64748b";
        renderTable();
    }
}

// ================= LOGIC: NAMING & DISPLAY =================
function toThaiNumerals(num) {
    if(num === null || num === undefined) return '';
    const thai = ['๐','๑','๒','๓','๔','๕','๖','๗','๘','๙'];
    return num.toString().split('').map(d => thai[d]||d).join('');
}

function getReignNameRank(p) {
    if(!p.isMonarch || !p.useReignName || !p.reignNameBase) return null;
    const sameName = state.members
        .filter(m => m.isMonarch && m.useReignName && m.reignNameBase === p.reignNameBase)
        .sort((a,b) => (parseInt(a.reignStart)||0) - (parseInt(b.reignStart)||0) || a.id.localeCompare(b.id));
    return sameName.findIndex(m => m.id === p.id) + 1;
}

function getDisplayRank(rank) {
    if(!rank) return '';
    if(rank.includes('เจ้าฟ้า') || rank.includes('พระองค์เจ้า')) {
        return rank.split(' ')[0]; 
    }
    return rank;
}

function getFullDisplayTitle(p) {
    if (!p) return "";
    let parts = [];
    parts.push(p.titlePrefix || "");
    
    let rankName = "";
    if (!p.hideRoyalRank && p.royalRank && !p.royalRank.includes('สามัญชน')) {
        rankName += getDisplayRank(p.royalRank);
    }
    rankName += p.name;
    parts.push(rankName);
    
    if (p.titleSuffix) parts.push(p.titleSuffix);
    if (p.monarchSpouseContext) parts.push(p.monarchSpouseContext);

    if (p.kromRank) {
        parts.push(p.kromRank + (p.kromTitle || ""));
    }

    if (p.isMonarch && p.useReignName && p.reignNameBase) {
        let reignStr = p.reignNameBase;
        if(p.eraName) reignStr += " " + p.eraName;
        const autoNum = getReignNameRank(p);
        if(autoNum) reignStr += "ที่ " + toThaiNumerals(autoNum);
        parts.push(reignStr);
    }
    
    return parts.filter(s => s && s.trim() !== "").join(" ");
}

function getNicknameWithPrefix(p) {
    if(!p.nickname) return '-';
    let prefix = '';
    const r = p.royalRank || '';
    if(r.includes('เจ้าฟ้า (ชั้นเอก)')) prefix = 'ทูลกระหม่อม';
    else if(r.includes('เจ้าฟ้า')) prefix = 'สมเด็จ'; 
    else if(r.includes('พระองค์เจ้า (ชั้นเอก)') || r.includes('พระองค์เจ้า (ชั้นโท)')) prefix = 'เสด็จ';
    else if(r.includes('หม่อมเจ้า')) prefix = p.gender === 'M' ? 'ท่านชาย' : 'ท่านหญิง';
    return prefix + p.nickname;
}

function getTreeNodeName(p) { return p.name || "-"; }

function getGlobalReignLabel(p) {
    if(p.globalReignNumber) return `รัชกาลที่ ${toThaiNumerals(p.globalReignNumber)}`;
    return '';
}

function getDeathTerm(p) {
    if(p.hasUmbrella) {
        if(p.umbrellaType.includes('นพดล') || p.umbrellaType.includes('สัปตดล')) return "สวรรคต";
        if(p.umbrellaType.includes('เบญจดล')) return "ทิวงคต"; 
    }
    if(p.isMonarch || p.isQueenConsort) return "สวรรคต";
    if(p.isHeir) return "สวรรคต"; 
    const rank = p.royalRank || '';
    if((p.relationship||'').includes('บาทบริจาริกา')) return "อสัญกรรม";
    if(rank.includes('เจ้าฟ้า')) return "ทิวงคต";
    if(rank.includes('พระองค์เจ้า')) return "สิ้นพระชนม์";
    if(rank.includes('หม่อมเจ้า')) return "สิ้นชีพิตักษัย";
    if(rank.includes('เจ้าประเทศราช')) return "พิลาลัย";
    return "เสียชีวิต";
}

function generateRoyalId(gender, rankName) {
    const d1 = gender === 'M' ? '1' : '2';
    const d2 = RANK_CODES[rankName] || '7';
    const d3 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
    const d4 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
    return `${d1}${d2}${d3}${d4}${Math.floor(Math.random()*1000000)}`;
}

function updateAutoId() {
    try {
        if (document.getElementById('p_isEditMode').value === 'true') return;
        const gEl = document.querySelector('input[name="gender"]:checked');
        const gender = gEl ? gEl.value : 'M';
        const rank = document.getElementById('p_royalRank').value || 'สามัญชน';
        document.getElementById('p_id').value = generateRoyalId(gender, rank);
    } catch(e) { }
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    const q = document.getElementById('tableSearch').value.toLowerCase();
    const filterStatus = document.getElementById('tableFilterStatus').value;
    
    let list = state.members;
    if(filterStatus === 'alive') list = list.filter(m => m.isAlive);
    else if(filterStatus === 'dead') list = list.filter(m => !m.isAlive);
    if(q) list = list.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q) || (m.nickname||'').toLowerCase().includes(q));

    list.sort((a,b) => {
        if(a.isMonarch && !b.isMonarch) return -1;
        if(!a.isMonarch && b.isMonarch) return 1;
        if(a.isMonarch && b.isMonarch) return (parseInt(a.reignStart)||0) - (parseInt(b.reignStart)||0);
        return 0;
    });

    if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-slate-400">ไม่พบข้อมูล</td></tr>`; return; }

    list.forEach(m => {
        const dTerm = m.isAlive ? "" : getDeathTerm(m);
        const statusHTML = m.isAlive 
            ? '<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-600 text-xs font-bold">มีชีวิต</span>'
            : `<span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-500 text-xs font-bold">${dTerm}</span>`;
        const fName = state.members.find(x => x.id === m.fatherId)?.name || '-';
        const mName = state.members.find(x => x.id === m.motherId)?.name || '-';
        let fullName = getFullDisplayTitle(m);
        if(m.isMonarch) { fullName += ` <span class="text-xs text-amber-600 font-bold bg-amber-50 px-1 rounded border border-amber-200 ml-1">${getGlobalReignLabel(m)}</span>`; }
        const nn = getNicknameWithPrefix(m);
        const nnHTML = nn !== '-' ? `<div class="text-xs text-slate-400 font-normal mt-0.5">(${nn})</div>` : '';

        const row = document.createElement('tr');
        row.className = "data-row transition border-b border-slate-100 hover:bg-slate-50";
        row.innerHTML = `
            <td class="text-center py-2"><img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-8 h-8 rounded-full mx-auto object-cover border"></td>
            <td class="py-2 text-sm font-bold text-slate-700 cursor-pointer hover:text-blue-500" onclick="showDetail('${m.id}')">${fullName}${nnHTML}</td>
            <td class="py-2">${statusHTML}</td>
            <td class="py-2"><span class="text-xs text-slate-500">${fName} / ${mName}</span></td>
            <td class="text-center py-2">
                <button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function editPersonDirect(id) { const m = state.members.find(x => x.id === id); if(m) openModal(m, true); }

function findRootForDisplay(focusId) {
    if(!focusId) {
        const active = state.members.find(x => x.isMonarch && x.isAlive);
        if(active) return active.id;
        const anyMonarch = state.members.find(x => x.isMonarch);
        return anyMonarch ? anyMonarch.id : (state.members[0]?.id || null);
    }
    let curr = state.members.find(m => m.id === focusId);
    if(!curr) return null;
    let safeGuard = 0;
    while((curr.fatherId || curr.motherId) && safeGuard < 10) {
        const dad = state.members.find(m => m.id === curr.fatherId);
        const mom = state.members.find(m => m.id === curr.motherId);
        if(dad) curr = dad; else if(mom) curr = mom; else break;
        safeGuard++;
    }
    return curr.id;
}

function calculateTreeLayout(rootId) {
    if(!rootId) return { nodes:[], connections:[] };
    const config = state.isHorizontal ? {...BASE_CONFIG, gapX: 40, gapY: 250} : BASE_CONFIG;
    const nodes = []; const connections = [];
    const getP = (id) => state.members.find(m => m.id === id);

    function build(pid, level) {
        const p = getP(pid);
        if(!p) return { width: config.nodeWidth, nodes: [] };

        // 1. Identify Spouses
        let spouses = (p.spouseIds || []).map(id => getP(id)).filter(s => s);
        
        // 2. Identify ALL Children
        const allChildren = state.members.filter(m => m.fatherId === pid || m.motherId === pid)
                                         .sort((a,b) => (parseInt(a.birthYear)||0) - (parseInt(b.birthYear)||0));

        // 3. Group Children
        const groups = [];
        
        // 3a. Group by existing spouses
        spouses.forEach(s => {
            const kids = allChildren.filter(c => c.fatherId === s.id || c.motherId === s.id);
            groups.push({ spouse: s, children: kids });
        });

        // 3b. Find "Lone" children
        const accountedChildrenIds = new Set(groups.flatMap(g => g.children.map(c => c.id)));
        const loneChildren = allChildren.filter(c => !accountedChildrenIds.has(c.id));
        
        if (loneChildren.length > 0) {
            groups.push({ spouse: null, children: loneChildren });
        }

        if (groups.length === 0) {
            return { width: config.nodeWidth, nodes: [{ data: p, x: 0, y: 0, type: 'root' }] };
        }

        // 4. Calculate Dimensions for each group
        let totalSubtreeWidth = 0;
        const groupLayouts = groups.map(g => {
            let childrenBlockWidth = 0;
            const childResults = [];
            
            if (g.children.length > 0) {
                g.children.forEach(child => {
                    const res = build(child.id, level + 1);
                    childResults.push({ ...res, childId: child.id });
                    childrenBlockWidth += res.width + config.gapX;
                });
                childrenBlockWidth -= config.gapX; 
            } else {
                childrenBlockWidth = 0; 
            }
            
            const groupWidth = Math.max(g.spouse ? config.nodeWidth : 0, childrenBlockWidth);
            return { group: g, width: groupWidth, childResults };
        });

        totalSubtreeWidth = groupLayouts.reduce((acc, gl) => acc + gl.width + config.spouseGap, 0);
        if (groupLayouts.length > 0) totalSubtreeWidth -= config.spouseGap;
        totalSubtreeWidth = Math.max(totalSubtreeWidth, config.nodeWidth); 

        const localNodes = [];
        const rootX = totalSubtreeWidth / 2 - config.nodeWidth / 2;
        localNodes.push({ data: p, x: rootX, y: 0, type: 'root' });

        let currentX = 0;
        
        groupLayouts.forEach(gl => {
            const g = gl.group;
            const groupCenterX = currentX + gl.width / 2;
            
            // 1. Place Spouse (if exists)
            if (g.spouse) {
                const spouseX = groupCenterX - config.nodeWidth / 2;
                localNodes.push({ data: g.spouse, x: spouseX, y: config.gapY, type: 'spouse', partnerId: pid });
                connections.push({ from: pid, to: g.spouse.id, isSpouse: true });
                
                let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                if (gl.childResults.length === 0) childX = currentX; 

                gl.childResults.forEach(res => {
                    res.nodes.forEach(n => {
                        localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                    });
                    const childRoot = res.nodes.find(n => n.type === 'root');
                    if (childRoot) {
                        connections.push({ from: g.spouse.id, to: childRoot.data.id, isChild: true });
                    }
                    childX += res.width + config.gapX;
                });

            } else {
                // No Spouse (Lone Children)
                let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                
                gl.childResults.forEach(res => {
                    res.nodes.forEach(n => {
                        localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                    });
                    
                    const childRoot = res.nodes.find(n => n.type === 'root');
                    if (childRoot) {
                        // Connect Root directly to Child
                        connections.push({ from: pid, to: childRoot.data.id, isChild: false });
                    }
                    childX += res.width + config.gapX;
                });
            }
            currentX += gl.width + config.spouseGap;
        });

        return { width: totalSubtreeWidth, nodes: localNodes };
    }

    const treeData = build(rootId, 0);
    return { nodes: treeData.nodes, connections };
}

function renderTree() {
    const root = findRootForDisplay(state.viewRootId);
    const layout = calculateTreeLayout(root);
    const svgL = document.getElementById('links-layer');
    const svgN = document.getElementById('nodes-layer');
    svgL.innerHTML = ''; svgN.innerHTML = '';
    if(layout.nodes.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); return; }
    document.getElementById('empty-state').classList.add('hidden');
    layout.connections.forEach(c => {
        const f = layout.nodes.find(n => n.data.id === c.from);
        const t = layout.nodes.find(n => n.data.id === c.to);
        if(f && t) drawLink(f, t, c.isSpouse, svgL);
    });
    layout.nodes.forEach(n => drawNode(n, svgN));
}

function drawNode(node, container) {
    const config = state.isHorizontal ? {...BASE_CONFIG, gapX: 40, gapY: 250} : BASE_CONFIG;
    const {x, y} = state.isHorizontal ? {x: node.y, y: node.x} : {x: node.x, y: node.y}; 
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("transform", `translate(${x},${y})`);
    g.style.cursor = "pointer";
    g.onclick = (e) => { e.stopPropagation(); showDetail(node.data.id); };
    const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
    fo.setAttribute("width", config.nodeWidth); fo.setAttribute("height", config.nodeHeight);
    const p = node.data;
    const isDead = !p.isAlive;
    const deathTerm = isDead ? getDeathTerm(p) : "";
    let borderClass = p.gender === 'M' ? "border-male" : "border-female";
    if(p.isMonarch) borderClass = "border-king";
    else if(p.isQueenConsort) borderClass = "border-queen";
    let imgClass = "";
    if(isDead) {
        if(p.isMonarch) { borderClass = "border-dead-royal"; imgClass = "img-normal"; } 
        else { borderClass = "border-dead"; imgClass = "img-grayscale"; }
    }
    const treeName = getTreeNodeName(p); 
    const showCrown = (p.isMonarch || p.isQueenConsort);
    let badgeHTML = "";
    if (p.isMonarch && p.useReignName && p.reignNameBase) {
        let reignTxt = p.reignNameBase;
        const autoNum = getReignNameRank(p);
        if(autoNum) reignTxt += `ที่ ${toThaiNumerals(autoNum)}`;
        if(p.globalReignNumber) reignTxt += ` (ร.${toThaiNumerals(p.globalReignNumber)})`;
        badgeHTML = `<div class="badge-monarch truncate w-full text-center">${reignTxt}</div>`;
    } else if (p.isHeir) {
         badgeHTML = `<div class="badge-heir truncate w-full text-center">รัชทายาทลำดับที่ ${toThaiNumerals(p.heirOrder)}</div>`;
    } else if (!p.isMonarch && p.kromRank) {
        badgeHTML = `<div class="badge-krom truncate w-full text-center">${p.kromRank}${p.kromTitle||''}</div>`;
    }
    const div = document.createElement("div");
    div.className = `node-box ${borderClass} ${state.viewRootId === p.id ? 'focused' : ''}`;
    div.innerHTML = `
        <div class="relative mb-1">
            <img src="${p.image || (p.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full border border-white shadow-sm object-cover bg-slate-100 ${imgClass}">
            ${showCrown ? `<i class="fa-solid fa-crown absolute -top-1 -right-1 text-xs ${p.isAlive?'text-yellow-500':'text-slate-600'} bg-white rounded-full p-0.5 shadow-sm"></i>` : ''}
        </div>
        <div class="text-[11px] font-bold text-center leading-tight truncate w-full px-1 ${p.isMonarch?'text-amber-700':'text-slate-700'}">${treeName}</div>
        ${badgeHTML}
        ${isDead ? `<div class="absolute top-1 left-1 text-[8px] bg-slate-800 text-white px-1.5 py-0.5 rounded shadow-sm opacity-90">${deathTerm}</div>` : ''}
    `;
    fo.appendChild(div); g.appendChild(fo); container.appendChild(g);
}

function drawLink(n1, n2, isSpouse, container) {
    const config = state.isHorizontal ? {...BASE_CONFIG, gapX: 40, gapY: 250} : BASE_CONFIG;
    const getC = (n, point) => {
        let x = n.x, y = n.y;
        if(state.isHorizontal) { x = n.y; y = n.x; }
        if(state.isHorizontal) {
            if(point==='bottom') return {x: x+config.nodeWidth, y: y+config.nodeHeight/2}; 
            if(point==='top') return {x: x, y: y+config.nodeHeight/2}; 
        } else {
            if(point==='bottom') return {x: x+config.nodeWidth/2, y: y+config.nodeHeight};
            if(point==='top') return {x: x+config.nodeWidth/2, y: y};
        }
        return {x,y};
    };
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("class", "connector");
    let p1, p2, d;
    if(isSpouse) {
        p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
        if(state.isHorizontal) { const midX = (p1.x + p2.x)/2; d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; } 
        else { const midY = (p1.y + p2.y)/2; d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; }
        path.setAttribute("d", d); container.appendChild(path);
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.setAttribute("class", "heart-icon"); txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle"); txt.textContent = "❤";
        const mx = (p1.x + p2.x)/2; const my = (p1.y + p2.y)/2;
        txt.setAttribute("x", mx); txt.setAttribute("y", my);
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", mx); circle.setAttribute("cy", my); circle.setAttribute("r", 8); circle.setAttribute("fill", "#fff");
        container.appendChild(circle); container.appendChild(txt);
    } else {
        p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
        if(state.isHorizontal) { const midX = (p1.x + p2.x)/2; d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; } 
        else { const midY = (p1.y + p2.y)/2; d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; }
        path.setAttribute("d", d); container.appendChild(path);
    }
}

// ================= MONARCH & SUCCESSION =================
function renderMonarchBanner() {
    try {
        const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive);
        const banner = document.getElementById('monarchBanner');
        const vacant = document.getElementById('monarchVacant');
        if(activeMonarch) {
            banner.classList.remove('hidden'); banner.classList.add('flex'); vacant.classList.add('hidden'); vacant.classList.remove('flex');
            document.getElementById('monarchImg').src = activeMonarch.image || (activeMonarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
            document.getElementById('monarchName').innerText = getFullDisplayTitle(activeMonarch) + " " + getGlobalReignLabel(activeMonarch);
        } else {
            banner.classList.add('hidden'); banner.classList.remove('flex');
            if(state.members.length > 0) { vacant.classList.remove('hidden'); vacant.classList.add('flex'); } 
            else { vacant.classList.add('hidden'); vacant.classList.remove('flex'); }
        }
    } catch(e) { console.error("Banner Render Error:", e); }
}

function openAppointModal() {
    const s = document.getElementById('appointSelectModal'); s.innerHTML = '';
    const eligible = state.members.filter(m => m.isAlive && !m.royalRank.includes('หม่อมเจ้า') && !m.royalRank.includes('สามัญชน') && !(m.relationship||'').includes('บาทบริจาริกา'));
    if(eligible.length === 0) { showToast("ไม่พบผู้มีสิทธิ์สืบราชสมบัติ"); return; }
    eligible.forEach(m => { const op = document.createElement('option'); op.value = m.id; op.innerText = `${m.royalRank} ${m.name}`; s.appendChild(op); });
    document.getElementById('appointModal').classList.add('active');
}

let tempAppointId = null;
function appointFromModal() {
    const id = document.getElementById('appointSelectModal').value;
    closeModal('appointModal');
    openReignNameSelectionModal(id);
}

function openReignNameSelectionModal(id) {
    tempAppointId = id;
    const s = document.getElementById('reignSelectionInput');
    s.innerHTML = '';
    state.reignNames.forEach(n => {
        const op = document.createElement('option');
        op.value = n; op.innerText = n;
        s.appendChild(op);
    });
    document.getElementById('reignSelectionModal').classList.add('active');
}

function confirmReignSelection() {
    const rName = document.getElementById('reignSelectionInput').value;
    if(tempAppointId && rName) {
        performSuccession(tempAppointId, rName);
        closeModal('reignSelectionModal');
    }
}

function performSuccession(newMonarchId, reignNameBase) {
    const m = state.members.find(x => x.id === newMonarchId);
    if(m) { 
        m.relationship = "พระมหากษัตริย์"; // Auto update relationship
        
        // Auto set titles from hierarchy
        if(state.hierarchy["พระมหากษัตริย์"]) {
            const defaults = state.hierarchy["พระมหากษัตริย์"];
            if(defaults.prefixes && defaults.prefixes.length > 0) {
                m.titlePrefix = defaults.prefixes[0];
                if(defaults.suffixes && defaults.suffixes[m.titlePrefix] && defaults.suffixes[m.titlePrefix].length > 0) {
                    m.titleSuffix = defaults.suffixes[m.titlePrefix][0];
                }
            }
        }

        m.isMonarch = true; 
        m.isHeir = false; 
        m.heirOrder = null;
        m.reignStart = new Date().getFullYear() + 543; 
        
        // Auto set Reign Name
        m.useReignName = true;
        m.reignNameBase = reignNameBase;

        // Auto-run Global Reign Number
        const monarchs = state.members.filter(x => x.isMonarch);
        const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
        m.globalReignNumber = maxGlobal + 1;

        saveState(); 
        updateApp(); 
        showFantasyPopup(m); 
    }
}

function handleMonarchDeath(monarch) {
    if(monarch.spouseIds && monarch.spouseIds.length > 0) {
        const reignNum = getGlobalReignLabel(monarch); 
        monarch.spouseIds.forEach(sid => {
            const sp = state.members.find(x => x.id === sid);
            if(sp && sp.isAlive && ((sp.relationship || '').includes('ภรรยา') || (sp.relationship || '').includes('บาทบริจาริกา'))) {
    sp.monarchSpouseContext = `ใน${reignNum}`;
}
        });
    }
    const heirs = state.members.filter(m => m.isHeir && m.isAlive).sort((a,b) => (a.heirOrder||99) - (b.heirOrder||99));
    if(heirs.length > 0) {
        const successor = heirs[0];
        showToast(`กำลังสถาปนา ${successor.name} ขึ้นครองราชย์...`);
        setTimeout(() => {
            // Trigger flow: Open modal to pick reign name for successor
            openReignNameSelectionModal(successor.id);
            // Shift other heirs
            state.members.filter(m => m.isHeir && m.isAlive).forEach(h => {
                if(h.heirOrder > 1) h.heirOrder--;
            });
            saveState();
        }, 2000);
    }
}

function handleHeirDeath(p) {
    if (!p.heirOrder) return;
    const deadOrder = parseInt(p.heirOrder);
    p.heirOrder = null; 
    state.members.forEach(m => {
        if (m.isAlive && m.isHeir && m.heirOrder && parseInt(m.heirOrder) > deadOrder) {
            m.heirOrder = parseInt(m.heirOrder) - 1;
        }
    });
}

function showFantasyPopup(monarch) {
    const modal = document.getElementById('fantasyModal');
    document.getElementById('fan_name').innerText = getFullDisplayTitle(monarch);
    document.getElementById('fan_rama').innerText = getGlobalReignLabel(monarch);
    document.getElementById('fan_img').src = monarch.image || (monarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
    
    // Set Dynasty and Kingdom
    document.getElementById('fan_dynasty').innerText = state.dynastyName || '-';
    document.getElementById('fan_kingdom').innerText = state.kingdomName || '-';

    const pc = document.getElementById('fantasyParticles'); pc.innerHTML = '';
    for(let i=0; i<30; i++) {
        const p = document.createElement('div'); p.className = 'particle';
        p.style.left = Math.random()*100 + '%'; p.style.width = Math.random()*6 + 2 + 'px'; p.style.height = p.style.width; p.style.animationDelay = Math.random()*2 + 's';
        p.style.background = Math.random() > 0.5 ? '#ffd700' : '#fff'; pc.appendChild(p);
    }
    modal.classList.add('active');
}

// ================= DATA MANAGEMENT =================
function handleSavePerson(e) {
    try {
        e.preventDefault();
        const id = document.getElementById('p_id').value || Date.now().toString();
        const isEdit = document.getElementById('p_isEditMode').value === 'true';
        
        const spouseIds = [];
        document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));

        const oldP = isEdit ? state.members.find(x => x.id === id) : null;

        const p = {
            id: id,
            name: document.getElementById('p_name').value || '-',
            nickname: document.getElementById('p_nickname').value || '',
            gender: document.querySelector('input[name="gender"]:checked').value,
            isAlive: document.getElementById('p_isAlive').checked,
            relationship: document.getElementById('p_relationship').value,
            titlePrefix: document.getElementById('p_titlePrefix').value || '',
            titleSuffix: document.getElementById('p_titleSuffix').value || '',
            royalRank: document.getElementById('p_royalRank').value,
            kromRank: document.getElementById('p_kromRank').value || '',
            kromTitle: document.getElementById('p_kromTitle').value || '',
            isMonarch: document.getElementById('p_isMonarch').checked,
            isHeir: document.getElementById('p_isHeir').checked,
            heirOrder: document.getElementById('p_heirOrder').value || null,
            isQueenConsort: document.getElementById('p_isQueenConsort').checked,
            useReignName: document.getElementById('p_useReignName').checked,
            reignNameBase: document.getElementById('p_reignNameSelect').value || '',
            globalReignNumber: document.getElementById('p_globalReignNumber').value || null,
            reignStart: document.getElementById('p_reignStart').value || '',
            reignEnd: document.getElementById('p_reignEnd').value || '',
            eraName: document.getElementById('p_eraName').value || '',
            hasUmbrella: document.getElementById('p_hasUmbrella').checked,
            umbrellaType: document.getElementById('p_umbrellaType').value,
            image: document.getElementById('p_imageFinal').value,
            fatherId: document.getElementById('p_fatherId').value || null,
            motherId: document.getElementById('p_motherId').value || null,
            spouseIds: spouseIds,
            hideRoyalRank: document.getElementById('p_hideRoyalRank').checked,
            monarchSpouseContext: (oldP && oldP.relationship === document.getElementById('p_relationship').value) ? oldP.monarchSpouseContext : null
        };

        const queenSelect = document.getElementById('p_queenSelectForKing');
        
        if(isEdit) {
            const idx = state.members.findIndex(m => m.id === id);
            if(idx !== -1) {
                const old = state.members[idx];
                old.spouseIds.forEach(sid => { if(!spouseIds.includes(sid)) { const s = state.members.find(x => x.id === sid); if(s) s.spouseIds = s.spouseIds.filter(x => x !== id); } });
                state.members[idx] = p;
            }
        } else {
            state.members.push(p);
        }

        spouseIds.forEach(sid => { const s = state.members.find(x => x.id === sid); if(s && !s.spouseIds.includes(id)) s.spouseIds.push(id); });

        if(p.isMonarch && p.gender === 'M') {
            const selectedQueenId = document.getElementById('p_queenSelectForKing').value;
            p.spouseIds.forEach(sid => {
                const s = state.members.find(m => m.id === sid);
                if(s) s.isQueenConsort = false;
            });
            if(selectedQueenId) {
                const q = state.members.find(m => m.id === selectedQueenId);
                if(q) q.isQueenConsort = true;
            }
        }

        saveState();
        closeModal('personModal');
        if(p.isMonarch && !isEdit) showFantasyPopup(p);
        updateApp();
        showToast('บันทึกข้อมูลเรียบร้อย');
    } catch (err) {
        console.error(err);
        alert('เกิดข้อผิดพลาดในการบันทึก: ' + err.message);
    }
}

// ================= MODAL OPENERS =================
function openModal(d={}, edit=false, contextTitle=null) {
    try {
        const f = document.getElementById('personForm'); f.reset();
        document.getElementById('p_isEditMode').value = edit;
        
        const titleEl = document.getElementById('modalTitle');
        if(contextTitle) { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>เพิ่มข้อมูลบุคคล (${contextTitle})`; } 
        else { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ข้อมูลบุคคล`; }
        
        if (!edit && !d.gender) { const mRadio = document.querySelector('input[name="gender"][value="M"]'); if(mRadio) mRadio.checked = true; } 
        else if(d.gender) { document.querySelector(`input[name="gender"][value="${d.gender}"]`).checked = true; }

        document.getElementById('p_royalRank').value = d.royalRank || 'สามัญชน';
        document.getElementById('p_hideRoyalRank').checked = !!d.hideRoyalRank;

        if(!edit) { updateAutoId(); } else { document.getElementById('p_id').value = d.id || ''; }

        document.getElementById('p_name').value = d.name || '';
        document.getElementById('p_nickname').value = d.nickname || '';
        document.getElementById('p_isAlive').checked = d.isAlive !== false;
        
        populateRelSelect(d.relationship);
        updatePrefixOptions(d.titlePrefix);
        updateSuffixOptions(d.titleSuffix);
        document.getElementById('p_fatherId').value = d.fatherId || '';
        document.getElementById('p_fatherSearch').value = d.fatherId ? (state.members.find(x=>x.id==d.fatherId)?.name || d.fatherId) : '';
        document.getElementById('p_motherId').value = d.motherId || '';
        document.getElementById('p_motherSearch').value = d.motherId ? (state.members.find(x=>x.id==d.motherId)?.name || d.motherId) : '';
        document.getElementById('p_isMonarch').checked = !!d.isMonarch;
        document.getElementById('p_useReignName').checked = !!d.useReignName;
        populateReignSelect(d.reignNameBase);
        
        if(!edit && d.isMonarch === undefined) {
             const monarchs = state.members.filter(x => x.isMonarch);
             const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
             document.getElementById('p_globalReignNumber').value = maxGlobal + 1;
        } else { document.getElementById('p_globalReignNumber').value = d.globalReignNumber || ''; }
        
        document.getElementById('p_reignStart').value = d.reignStart || '';
        document.getElementById('p_reignEnd').value = d.reignEnd || '';
        document.getElementById('p_eraName').value = d.eraName || '';
        toggleMonarch();
        
        document.getElementById('p_isHeir').checked = !!d.isHeir;
        document.getElementById('p_heirOrder').value = d.heirOrder || '';
        toggleHeirOrder();

        document.getElementById('p_isQueenConsort').checked = !!d.isQueenConsort;
        document.getElementById('p_hasUmbrella').checked = !!d.hasUmbrella;
        document.getElementById('p_umbrellaType').value = d.umbrellaType || 'ตรีดลเศวตฉัตร';
        toggleUmbrella();
        document.getElementById('p_kromRank').value = d.kromRank || '';
        document.getElementById('p_kromTitle').value = d.kromTitle || '';
        toggleKrom();
        const ul = document.getElementById('p_spouseList'); ul.innerHTML = '';
        (d.spouseIds || []).forEach(sid => { const s = state.members.find(x => x.id === sid); if(s) addSpouseLi(s); });
        document.getElementById('p_imagePreview').src = d.image || (d.gender==='F'?DEFAULT_IMG_FEMALE:DEFAULT_IMG_MALE);
        document.getElementById('p_imageFinal').value = d.image || '';
        updateDatalists(d.id);
        updateQueenConsortSelector(d);
        setTimeout(checkQueenConsortEligible, 100);
        document.getElementById('personModal').classList.add('active');
    } catch(e) { console.error(e); }
}

function updateQueenConsortSelector(d) {
    const selDiv = document.getElementById('maleMonarchQueenSelect');
    const sel = document.getElementById('p_queenSelectForKing');
    const genderEl = document.querySelector('input[name="gender"]:checked');
    const genderVal = genderEl ? genderEl.value : 'M';
    const isKing = document.getElementById('p_isMonarch').checked && genderVal === 'M';
    if(isKing) {
        selDiv.classList.remove('hidden');
        sel.innerHTML = '<option value="">-- เลือก --</option>';
        const spouseIds = [];
        document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));
        let currentQueenId = null;
        spouseIds.forEach(sid => {
            const s = state.members.find(m => m.id === sid);
            if(s && s.gender === 'F' && (s.relationship||'').includes('พระภรรยาเจ้า')) {
                const op = document.createElement('option');
                op.value = s.id; op.innerText = s.name;
                sel.appendChild(op);
                if(s.isQueenConsort) currentQueenId = s.id;
            }
        });
        if(currentQueenId) sel.value = currentQueenId;
    } else { selDiv.classList.add('hidden'); }
}

function openAddRootModal() { openModal({}); }
function editCurrent() { closeModal('detailModal'); openModal(state.members.find(m=>m.id===window.curPID), true); }
function toggleDeath() { 
    const p = state.members.find(m=>m.id===window.curPID); 
    p.isAlive = !p.isAlive;
    if(!p.isAlive) { if (p.isMonarch) handleMonarchDeath(p); if (p.isHeir) handleHeirDeath(p); }
    saveState(); showDetail(p.id); updateApp(); 
}
function deleteCurrent() {
    if(!confirm('ยืนยันการลบ?')) return;
    const id = window.curPID;
    state.members = state.members.filter(m => m.id !== id);
    state.members.forEach(m => {
        if(m.fatherId === id) m.fatherId = null;
        if(m.motherId === id) m.motherId = null;
        m.spouseIds = m.spouseIds.filter(sid => sid !== id);
    });
    saveState(); closeModal('detailModal'); updateApp();
}

// ================= RANK MANAGER =================
let selR=null, selP=null;
function openRankManagementModal() { renderRM(); document.getElementById('rankManagementModal').classList.add('active'); }
function renderRM() {
    const rl = document.getElementById('rl'); rl.innerHTML='';
    Object.keys(state.hierarchy).forEach(k => rl.innerHTML += itemHTML(k, `delData('rel','${k}')`, `selectRel('${k}')`));
    const gl = document.getElementById('reignl'); gl.innerHTML='';
    state.reignNames.forEach(n => gl.innerHTML += itemHTML(n, `delData('reign','${n}')`));
    document.getElementById('pl').innerHTML = '<li class="text-slate-400 text-xs italic p-2">เลือกความสัมพันธ์ก่อน...</li>';
    document.getElementById('sl').innerHTML = '<li class="text-slate-400 text-xs italic p-2">เลือกคำนำหน้าก่อน...</li>';
}
function itemHTML(txt, delFn, clickFn="") {
    return `<li class="flex justify-between items-center p-2 border-b hover:bg-slate-50 rounded cursor-pointer group" onclick="${clickFn}"><span>${txt}</span><button onclick="event.stopPropagation(); ${delFn}" class="text-red-300 hover:text-red-500 hidden group-hover:block"><i class="fa-solid fa-trash"></i></button></li>`;
}
function addData(type) {
    const v = document.getElementById(type==='rel'?'nr':(type==='pre'?'np':(type==='suf'?'ns':'nreign'))).value;
    if(!v) return;
    if(type==='rel') state.hierarchy[v] = {prefixes:[], suffixes:{}};
    else if(type==='pre' && selR) { state.hierarchy[selR].prefixes.push(v); state.hierarchy[selR].suffixes[v]=[]; }
    else if(type==='suf' && selR && selP) state.hierarchy[selR].suffixes[selP].push(v);
    else if(type==='reign') state.reignNames.push(v);
    saveState(); renderRM(); 
    if(type==='pre') selectRel(selR); if(type==='suf') selectPre(selP);
}
function delData(type, val) {
    if(!confirm('ลบ?')) return;
    if(type==='rel') delete state.hierarchy[val];
    else if(type==='pre') state.hierarchy[selR].prefixes = state.hierarchy[selR].prefixes.filter(x=>x!==val);
    else if(type==='suf') state.hierarchy[selR].suffixes[selP] = state.hierarchy[selR].suffixes[selP].filter(x=>x!==val);
    else if(type==='reign') state.reignNames = state.reignNames.filter(x=>x!==val);
    saveState(); renderRM();
    if(type==='pre') selectRel(selR); if(type==='suf') selectPre(selP);
}
function selectRel(k){ selR=k; const l=document.getElementById('pl'); l.innerHTML=''; state.hierarchy[k].prefixes.forEach(p=>l.innerHTML+=itemHTML(p,`delData('pre','${p}')`,`selectPre('${p}')`)); }
function selectPre(p){ selP=p; const l=document.getElementById('sl'); l.innerHTML=''; (state.hierarchy[selR].suffixes[p]||[]).forEach(s=>l.innerHTML+=itemHTML(s,`delData('suf','${s}')`)); }

// ================= HELPERS & UI =================
function showDetail(id) {
    window.curPID = id;
    const m = state.members.find(x => x.id === id);
    if(!m) return;
    document.getElementById('d_img').src = m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
    document.getElementById('d_name').innerText = getFullDisplayTitle(m);
    document.getElementById('d_id').innerText = m.id;
    const kromEl = document.getElementById('d_krom');
    if(m.kromRank && m.kromTitle) { kromEl.innerText = `${m.kromRank}${m.kromTitle}`; kromEl.classList.remove('hidden'); } else { kromEl.classList.add('hidden'); }
    const badgesContainer = document.getElementById('d_badges'); badgesContainer.innerHTML = '';
    if (m.isMonarch && m.useReignName && m.reignNameBase) {
        let reignTxt = m.reignNameBase;
        const autoNum = getReignNameRank(m);
        if(autoNum) reignTxt += `ที่ ${toThaiNumerals(autoNum)}`;
        const b = document.createElement('div');
        b.className = "bg-yellow-100 text-yellow-800 border border-yellow-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = reignTxt; badgesContainer.appendChild(b);
    }
    if (m.isQueenConsort) {
        const b = document.createElement('div');
        b.className = "bg-pink-100 text-pink-800 border border-pink-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = "มเหสีคู่บัลลังก์"; badgesContainer.appendChild(b);
    }
    if (m.isHeir) {
        const b = document.createElement('div');
        b.className = "bg-red-100 text-red-800 border border-red-300 px-3 py-1 rounded-full text-xs font-bold";
        b.innerText = `รัชทายาทลำดับที่ ${toThaiNumerals(m.heirOrder)}`; badgesContainer.appendChild(b);
    }
    const dTerm = m.isAlive ? "มีชีวิต" : getDeathTerm(m);
    document.getElementById('d_status').innerHTML = m.isAlive ? `<span class="text-emerald-600">${dTerm}</span>` : `<span class="text-slate-500">${dTerm}</span>`;
    document.getElementById('d_spouses_count').innerText = (m.spouseIds||[]).length + " คน";
    document.getElementById('d_umbrella').innerText = m.hasUmbrella ? m.umbrellaType : "-";
    const cr = document.getElementById('d_crown');
    if(m.isMonarch || m.isQueenConsort) { cr.classList.remove('hidden'); cr.className = `fa-solid fa-crown absolute -top-6 left-1/2 -translate-x-1/2 text-3xl drop-shadow-md ${m.isAlive?'text-yellow-400 animate-pulse':'text-slate-500'}`; } else { cr.classList.add('hidden'); }
    document.getElementById('detailModal').classList.add('active');
}
function setAsRoot(id) { state.viewRootId = id; saveState(); closeModal('detailModal'); renderTree(); resetView(); }
function focusOnPerson(val) { const id = val.split(':')[0].trim(); if(state.members.find(m => m.id === id)) { state.viewRootId = id; renderTree(); } }
function focusOnMonarch() { const m = state.members.find(x => x.isMonarch && x.isAlive); if(m) { state.viewRootId = m.id; renderTree(); resetView(); } }
function populateSearchLists() { const dl = document.getElementById('focusOptions'); dl.innerHTML = ''; state.members.forEach(m => { const op = document.createElement('option'); op.value = `${m.id} : ${m.name}`; dl.appendChild(op); }); }
function openAddParentModal(childId) { closeModal('detailModal'); openModal({}, false); showToast("สร้างบุคคลใหม่ แล้วนำ ID ไปใส่ในช่อง พระบิดา/พระมารดา ของลูก"); }
function openAddSpouseModal(id) { closeModal('detailModal'); const m = state.members.find(x => x.id === id); openModal({ spouseIds: [id], gender: m.gender==='M'?'F':'M' }, false, `คู่สมรสของ ${m.name}`); }
function openAddChildModal(id) { 
    closeModal('detailModal'); 
    const m = state.members.find(x => x.id === id); 
    const defaults = m.gender === 'M' ? { fatherId: id } : { motherId: id }; 
    openModal(defaults, false, `ลูกของ ${m.name}`); 
    
    const otherInputId = m.gender === 'M' ? 'p_motherSearch' : 'p_fatherSearch';
    const type = m.gender === 'M' ? 'mother' : 'father';
    const inputEl = document.getElementById(otherInputId);

    if(inputEl) {
        // Fix: Use addEventListener to avoid overwriting inline handlers, but since we need both...
        // The cleanest way is to attach a function that does BOTH
        inputEl.onchange = function() {
            // 1. Run Validation (Critical Fix)
            validateParent(type);
            
            // 2. Update Title
            setTimeout(() => {
                const val = this.value.trim();
                // The value might be name now if validation succeeded
                const baseTitle = `ลูกของ ${m.name}`;
                const newTitle = val ? `${baseTitle} กับ ${val}` : baseTitle;
                document.getElementById('modalTitle').innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>เพิ่มข้อมูลบุคคล (${newTitle})`;
            }, 100);
        };
    }
}
function toggleMonarch() { 
    const isM = document.getElementById('p_isMonarch').checked; 
    document.getElementById('monarchPanel').classList.toggle('hidden', !isM); 
    checkQueenConsortEligible(); updateQueenConsortSelector(); 
    if(isM && document.getElementById('p_isEditMode').value !== 'true') {
         const monarchs = state.members.filter(x => x.isMonarch);
         const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
         document.getElementById('p_globalReignNumber').value = maxGlobal + 1;
    }
}
function toggleReignName() { const u = document.getElementById('p_useReignName').checked; document.getElementById('p_reignNameSelect').classList.toggle('hidden', !u); document.getElementById('p_autoReignNameNumber').classList.toggle('hidden', !u); }
function toggleHeirOrder() { const h = document.getElementById('p_isHeir').checked; document.getElementById('p_heirOrder').classList.toggle('hidden', !h); }
function toggleUmbrella() { const h = document.getElementById('p_hasUmbrella').checked; document.getElementById('p_umbrellaType').classList.toggle('hidden', !h); }
function toggleKrom() { const v = document.getElementById('p_kromRank').value; document.getElementById('p_kromTitle').classList.toggle('hidden', !v); }
function checkQueenConsortEligible() { const g = document.querySelector('input[name="gender"]:checked').value; const r = document.getElementById('p_relationship').value; const ok = g === 'F' && (r === 'พระภรรยาเจ้า' || (r||'').includes('พระภรรยาเจ้า')); document.getElementById('queenConsortOption').classList.toggle('hidden', !ok); }
function populateReignSelect(selVal) { const s = document.getElementById('p_reignNameSelect'); s.innerHTML = ''; state.reignNames.forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); if(selVal) s.value = selVal; }
function populateRelSelect(v) { const s = document.getElementById('p_relationship'); s.innerHTML='<option value="">-</option>'; Object.keys(state.hierarchy).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`); if(v) s.value = v; }
function updatePrefixOptions(v) { const r = document.getElementById('p_relationship').value; const s = document.getElementById('p_titlePrefix'); s.innerHTML = ''; if(state.hierarchy[r]) state.hierarchy[r].prefixes.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`); if(v) s.value = v; updateSuffixOptions(); }
function updateSuffixOptions(v) { const r = document.getElementById('p_relationship').value; const p = document.getElementById('p_titlePrefix').value; const s = document.getElementById('p_titleSuffix'); s.innerHTML = ''; if(state.hierarchy[r] && state.hierarchy[r].suffixes[p]) state.hierarchy[r].suffixes[p].forEach(x => s.innerHTML += `<option value="${x}">${x}</option>`); if(v) s.value = v; }
function updateDatalists(selfId) { const fo = document.getElementById('fatherOptions'); fo.innerHTML=''; const mo = document.getElementById('motherOptions'); mo.innerHTML=''; const so = document.getElementById('spouseOptions'); so.innerHTML=''; state.members.forEach(m => { if(m.id === selfId) return; const op = `<option value="${m.id}">${m.name}</option>`; if(m.gender==='M') fo.innerHTML += op; else mo.innerHTML += op; so.innerHTML += op; }); }
function validateParent(type) { const i = document.getElementById(type==='father'?'p_fatherSearch':'p_motherSearch'); const h = document.getElementById(type==='father'?'p_fatherId':'p_motherId'); const val = i.value.trim(); const found = state.members.find(m => m.id === val || m.name === val); if(found) { h.value = found.id; i.value = found.name; } else { h.value = ''; } }
function addSpouse() { 
    const val = document.getElementById('p_spouseSearch').value; 
    const m = state.members.find(x => x.id === val || x.name === val); 
    if(m) { 
        const ul = document.getElementById('p_spouseList'); 
        // Check for duplicates
        if([...ul.children].some(li => li.dataset.id === m.id)) {
            showToast("มีรายชื่อนี้อยู่แล้ว");
            return;
        }
        addSpouseLi(m); 
        document.getElementById('p_spouseSearch').value = ''; 
        updateQueenConsortSelector(); 
    } 
}
function addSpouseLi(m) { const ul = document.getElementById('p_spouseList'); const li = document.createElement('li'); li.className = "bg-rose-50 text-rose-600 px-2 py-1 rounded-lg flex items-center gap-2 border border-rose-100"; li.dataset.id = m.id; li.innerHTML = `<span>${m.name}</span> <button type="button" onclick="this.parentElement.remove(); updateQueenConsortSelector()" class="text-rose-300 hover:text-red-500">×</button>`; ul.appendChild(li); }
function handleImageUpload(i){ const r=new FileReader(); r.onload=e=>{ document.getElementById('p_imagePreview').src=e.target.result; document.getElementById('p_imageFinal').value=e.target.result; }; if(i.files[0]) r.readAsDataURL(i.files[0]); }
function updateDefaultImage(){ if(!document.getElementById('p_imageFinal').value) document.getElementById('p_imagePreview').src = document.querySelector('input[name="gender"]:checked').value==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE; }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function showToast(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = msg; c.appendChild(t); setTimeout(()=>t.remove(), 3000); }
function copyToClipboard(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('คัดลอก ID แล้ว'); }
function resetData() { if(confirm('รีเซตข้อมูลทั้งหมด?')) { localStorage.removeItem('royal_tree_v2'); location.reload(); } }
function setTheme(t) { document.body.setAttribute('data-theme', t); state.currentTheme=t; saveState(); }
function completeInitialSetup() { state.kingdomName = document.getElementById('setupKingdomName').value || "อาณาจักร"; state.dynastyName = document.getElementById('setupDynastyName').value || "ราชวงศ์"; saveState(); closeModal('initialSetupModal'); }
function openCreateKingdomModal() { document.getElementById('initialSetupModal').classList.add('active'); }
function setupPanZoom() { const c = document.getElementById('canvas-container'); c.addEventListener('mousedown',e=>{ if(e.target.id!=='main-svg' && e.target.id!=='viewport-group') return; state.isDragging=true; state.startX=e.clientX-state.panX; state.startY=e.clientY-state.panY; }); window.addEventListener('mouseup',()=>{state.isDragging=false;}); window.addEventListener('mousemove',e=>{ if(!state.isDragging)return; e.preventDefault(); state.panX=e.clientX-state.startX; state.panY=e.clientY-state.startY; updateTrans(); }); c.addEventListener('wheel',e=>{ e.preventDefault(); state.zoom = Math.min(Math.max(0.1, state.zoom + (-e.deltaY*0.001)), 5); updateTrans(); }, {passive:false}); }
function updateTrans(){ document.getElementById('viewport-group').setAttribute("transform", `translate(${state.panX},${state.panY}) scale(${state.zoom})`); }
function zoomIn(){ state.zoom *= 1.2; updateTrans(); }
function zoomOut(){ state.zoom /= 1.2; updateTrans(); }
function resetView(){ state.zoom=1; state.panX=window.innerWidth/2 - BASE_CONFIG.nodeWidth/2; state.panY=50; updateTrans(); }
function toggleOrientation(){ state.isHorizontal=!state.isHorizontal; renderTree(); resetView(); }
</script>
</body>
</html>
