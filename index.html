<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Family Tree (Enhanced Lineage & Surnames)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Mali:wght@400;600&family=Chakra+Petch:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* ================= THEME VARIABLES ================= */
        :root {
            --bg-main: #f8fafc;
            --bg-dots: #e2e8f0;
            --text-main: #334155;
            --text-sub: #64748b;
            --primary: #475569;
            --primary-light: #94a3b8;
            --accent-bg: #ffffff;
            --accent-border: #e2e8f0;
            --card-shadow: rgba(0, 0, 0, 0.05);
            /* New Themed Line Colors */
            --line-color-child: #94a3b8; /* Slate */
            --line-color-spouse: #fca5a5; /* Red (light) */
            --line-width: 1.5px;
            --heart-color: #ef4444;
        }

        /* Themes */
        [data-theme="pink"] { 
            --bg-main: #fff0f5; --bg-dots: #fbcfe8; --text-main: #831843; --text-sub: #be185d; 
            --primary: #ec4899; --primary-light: #f9a8d4; --accent-bg: #fff; 
            --accent-border: #fbcfe8; 
            --line-color-child: #f472b6; /* Pink */
            --line-color-spouse: #34d399; /* Green for contrast */
        }
        [data-theme="purple"] { 
            --bg-main: #faf5ff; --bg-dots: #e9d5ff; --text-main: #581c87; --text-sub: #7e22ce; 
            --primary: #a855f7; --primary-light: #d8b4fe; --accent-bg: #fff; 
            --accent-border: #e9d5ff; 
            --line-color-child: #c084fc; /* Purple */
            --line-color-spouse: #fcd34d; /* Yellow for contrast */
        }
        [data-theme="yellow"] { 
            --bg-main: #fffbeb; --bg-dots: #fde68a; --text-main: #78350f; --text-sub: #b45309; 
            --primary: #f59e0b; --primary-light: #fcd34d; --accent-bg: #fff; 
            --accent-border: #fde68a; 
            --line-color-child: #fbbf24; /* Amber */
            --line-color-spouse: #38bdf8; /* Blue for contrast */
        }
        [data-theme="blue"] { 
            --bg-main: #f0f9ff; --bg-dots: #bae6fd; --text-main: #0c4a6e; --text-sub: #0284c7; 
            --primary: #0ea5e9; --primary-light: #7dd3fc; --accent-bg: #fff; 
            --accent-border: #bae6fd; 
            --line-color-child: #38bdf8; /* Blue */
            --line-color-spouse: #f472b6; /* Pink for contrast */
        }

        /* ================= GENERAL STYLES ================= */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        h1, h2, h3, .font-cute { font-family: 'Mali', cursive; }
        .font-royal { font-family: 'Chakra Petch', sans-serif; }

        
        /* ================= CANVAS AREA (SVG) ================= */
        #canvas-container {
            flex: 1;
            position: relative;
            cursor: grab;
            background-color: var(--bg-main);
            background-image: radial-gradient(var(--bg-dots) 1px, transparent 1px);
            background-size: 24px 24px;
            overflow: hidden;
        }
        #canvas-container:active { cursor: grabbing; }

        #main-svg { width: 100%; height: 100%; display: block; }

        /* Nodes inside SVG */
        .node-box {
            width: 100%; height: 100%;
            background: var(--accent-bg);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 8px 6px;
            box-shadow: 0 4px 15px -3px var(--card-shadow);
            border-width: 2px;
            border-style: solid;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-sizing: border-box;
            position: relative;
        }
        .node-box:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.15); z-index: 10; border-color: var(--primary); }
        
        /* Focused & Highlight Animation */
        .node-box.focused { box-shadow: 0 0 0 4px var(--primary-light); }
        
        .node-flash {
            animation: flash-highlight 1.5s infinite ease-in-out;
            border-color: #ef4444 !important;
            border-width: 3px !important;
            z-index: 50;
        }

        @keyframes flash-highlight {
            0% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0); transform: scale(1); }
        }

        /* Status Borders */
        .border-male { border-color: #38bdf8; } 
        .border-female { border-color: #c084fc; } 
        .border-king { border-color: #fbbf24; background: linear-gradient(to bottom, #fff, #fffbeb); } 
        .border-queen { border-color: #f472b6; background: linear-gradient(to bottom, #fff, #fff0f5); } 
        
        /* Death Visuals */
        .border-dead { filter: grayscale(1) opacity(0.8); border-style: dashed !important; border-color: #64748b !important; }
        
        /* Monarch Death: Black Border, Normal Image */
        .border-dead-royal { 
            border-color: #000000 !important; 
            border-width: 3px !important;
            background: #f8f8f8;
        }
        
        .img-grayscale { filter: grayscale(1); }
        .img-normal { filter: none; }

        /* Connectors (Updated for Themed Lines) */
        .connector { fill: none; stroke-width: var(--line-width); transition: stroke 0.3s; }
        .connector-child { stroke: var(--line-color-child); } /* New: Color for parent-child connection */
        .connector-spouse { stroke: var(--line-color-spouse); } /* New: Color for spouse connection */
        .connector:hover { stroke: var(--primary); stroke-width: 2.5px; }
        .heart-icon { font-size: 14px; fill: var(--heart-color); filter: drop-shadow(0px 1px 2px rgba(255, 255, 255, 0.8)); }

        /* Ancestor Label */
        .ancestor-label {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: bold;
            z-index: 5;
        }

        /* ================= TABLE VIEW ================= */
        .table-view-container {
            background-color: var(--bg-main);
            overflow-y: auto;
            flex: 1;
            padding: 2rem;
        }
        .table-wrapper {
             overflow-x: auto; /* Ensure horizontal scrolling for table */
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { color: var(--text-sub); font-weight: 600; padding: 12px; font-size: 14px; border-bottom: 2px solid var(--accent-border); white-space: nowrap; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--accent-border); background: var(--accent-bg); color: var(--text-main); font-size: 14px; vertical-align: middle; }
        tr.data-row:hover td { background-color: var(--bg-dots); cursor: pointer; }
        tr.data-row:first-child td:first-child { border-top-left-radius: 16px; }
        tr.data-row:first-child td:last-child { border-top-right-radius: 16px; }
        tr.data-row:last-child td:first-child { border-bottom-left-radius: 16px; }
        tr.data-row:last-child td:last-child { border-bottom-right-radius: 16px; }

        /* NEW: Glowing tags for table view */
        .monarch-tag-table { 
            background-color: #fffbeb; 
            color: #a16207; 
            border: 1px solid #fcd34d; 
            padding: 1px 6px; 
            border-radius: 6px; 
            font-size: 10px; 
            font-weight: bold; 
            box-shadow: 0 0 8px rgba(253, 211, 77, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        .queen-consort-tag-table {
            background-color: #fce7f3; /* Light pink */
            color: #be185d; /* Darker pink */
            border: 1px solid #fbcfe8;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(251, 207, 232, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        .heir-tag-table {
            background-color: #fee2e2; /* Light red */
            color: #991b1b; /* Darker red */
            border: 1px solid #fecaca;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(254, 202, 202, 0.6); 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px;
            white-space: nowrap;
        }
        /* ================= UI CONTROLS ================= */
        .floating-controls {
            position: absolute; bottom: 24px; right: 24px;
            display: flex; flex-direction: column; gap: 8px; z-index: 50;
        }
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-bg); border: 1px solid var(--accent-border);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .ctrl-btn:hover { transform: scale(1.1); background: var(--bg-dots); }

        .btn-theme { background-color: var(--primary); color: white; border-radius: 50px; font-weight: 600; padding: 6px 16px; font-size: 12px; transition: all 0.2s; }
        .btn-theme:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-icon { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--primary); border-radius: 50%; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-dots); transform: scale(1.1); }

        .input-theme { background: var(--accent-bg); border: 1px solid var(--accent-border); color: var(--text-main); border-radius: 12px; padding: 8px; outline: none; }
        .input-theme:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--bg-dots); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--accent-bg); border: 1px solid var(--accent-border); border-radius: 24px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2); }

        /* Fantasy Celebration Modal */
        #fantasyModal .modal-content {
            background: linear-gradient(135deg, #1a0b00 0%, #4a2c0a 100%);
            border: 2px solid #d4af37;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3), inset 0 0 30px rgba(0,0,0,0.8);
            color: #f3e5ab;
            max-width: 500px;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 40px 20px;
        }
        .golden-frame {
            border: 3px double #d4af37;
            padding: 4px;
            display: inline-block;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            background: #000;
        }
        .shimmer-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            animation: shimmer 3s infinite linear;
            background-size: 200% auto;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        .particle { position: absolute; background: #ffd700; border-radius: 50%; opacity: 0; animation: rise 4s infinite ease-in; }
        @keyframes rise { 0% { bottom: -10px; opacity: 0; transform: scale(0); } 50% { opacity: 1; } 100% { bottom: 100%; opacity: 0; transform: scale(1); } }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; }
        .toast { background: #334155; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideUp 0.3s ease-out; opacity: 0.9; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 0.9; } }

        /* Monarch Banner */
        .monarch-frame { border: 2px solid #fbbf24; background: linear-gradient(to right, #fffbeb, #fff); box-shadow: 0 4px 6px rgba(251, 191, 36, 0.2); }
        
        /* Badges for Tree */
        .badge-monarch { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-krom { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }
        .badge-heir { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 1px 4px; border-radius: 4px; font-size: 8px; font-weight: bold; margin-top: 2px; }

        /* Kingdom Selector */
        .kingdom-selector {
            background: white;
            border: 1px solid var(--accent-border);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 14px;
            outline: none;
            color: var(--text-main);
            max-width: 200px;
            font-weight: bold;
        }

        /* View Mode Selector */
        .view-mode-selector {
            background: var(--accent-bg);
            color: var(--primary);
            border: 1px solid var(--accent-border);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            outline: none;
            cursor: pointer;
            text-align: center;
            appearance: none;
        }
        .view-mode-wrapper { position: relative; }
        .view-mode-wrapper::after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            pointer-events: none;
            font-size: 10px;
        }
    /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà --- */
.mother-tag-container {
    display: inline-flex;
    align-items: center;
    margin-left: 10px;
    font-size: 11px;
    font-weight: bold;
    border: 1px solid #dbeafe;
    border-radius: 6px;
    overflow: hidden;
    vertical-align: middle;
}

.mother-tag-label {
    background-color: #eff6ff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    color: #1e40af; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    padding: 2px 6px;
}

.mother-tag-value {
    background-color: #eff6ff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    color: #92400e; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏ß‡πà‡∏≤‡∏á (Amber/Brown) */
    padding: 2px 8px;
    border-left: 1px solid #dbeafe;
}

.mother-group-header {
    background-color: #f8fafc;
    border-left: 4px solid #3b82f6;
}

.mother-group-header td {
    padding: 12px 20px;
    font-weight: bold;
    color: #1e40af;
    font-size: 14px;
    border-bottom: 1px solid #e2e8f0;
}

.child-index-circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background-color: #eff6ff;
    color: #3b82f6;
    border-radius: 50%;
    font-weight: bold;
    font-size: 12px;
    border: 1px solid #dbeafe;
}
/* -------------------------------------- */

    </style>
</head>
<body>

    <!-- Header -->
    <header class="sticky top-0 z-40 px-4 py-3" style="background-color: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--accent-border);">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center space-x-3 w-full md:w-auto">
                <div class="w-10 h-10 rounded-full flex items-center justify-center shadow-md text-white flex-shrink-0" style="background: var(--primary);">
                    <i class="fa-solid fa-chess-king"></i>
                </div>
                <div class="flex flex-col min-w-0 flex-1">
                    <!-- Multi-Kingdom Selector -->
                    <div class="flex items-center gap-2">
                        <select id="kingdomSelector" class="kingdom-selector" onchange="switchKingdom(this.value)"></select>
                        <button onclick="deleteCurrentKingdom()" class="w-6 h-6 flex items-center justify-center rounded-full text-red-400 hover:bg-red-50" title="‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏ô‡∏µ‡πâ"><i class="fa-solid fa-trash text-xs"></i></button>
                        <button onclick="openCreateKingdomModal()" class="w-6 h-6 flex items-center justify-center rounded-full text-emerald-500 hover:bg-emerald-50" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà"><i class="fa-solid fa-plus text-xs"></i></button>
                    </div>
                    <p id="dynastyLabel" class="text-[10px] text-slate-400 truncate"></p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 items-center justify-center md:justify-end w-full">
                <!-- Theme Switcher -->
                <div class="flex gap-1.5 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
                    <button onclick="setTheme('white')" class="w-4 h-4 rounded-full border border-gray-300 bg-gray-50"></button>
                    <button onclick="setTheme('pink')" class="w-4 h-4 rounded-full border border-pink-300 bg-pink-400"></button>
                    <button onclick="setTheme('purple')" class="w-4 h-4 rounded-full border border-purple-300 bg-purple-400"></button>
                    <button onclick="setTheme('yellow')" class="w-4 h-4 rounded-full border border-yellow-300 bg-yellow-400"></button>
                    <button onclick="setTheme('blue')" class="w-4 h-4 rounded-full border border-blue-300 bg-blue-400"></button>
                </div>

                <!-- View Switcher -->
                <div class="flex bg-white/50 p-1 rounded-full border border-slate-200">
                    <button onclick="switchView('tree')" id="btn-view-tree" class="px-3 py-1 text-xs rounded-full transition font-bold" style="background: var(--primary); color: white;">
                        <i class="fa-solid fa-sitemap mr-1"></i> ‡∏ú‡∏±‡∏á
                    </button>
                    <button onclick="switchView('table')" id="btn-view-table" class="px-3 py-1 text-xs rounded-full transition text-slate-500 hover:text-slate-700">
                        <i class="fa-solid fa-table mr-1"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    </button>
                </div>

                <!-- Find Relationship -->
                <button onclick="openRelationshipModal()" class="btn-theme flex items-center space-x-2" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå">
                    <i class="fa-solid fa-users-rays"></i> <span class="hidden lg:inline">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span>
                </button>

                <!-- Focus Search -->
                <div class="relative">
                    <input type="text" id="focusSearch" list="focusOptions" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•..." class="pl-8 pr-3 py-1.5 text-xs rounded-full border border-slate-200 focus:border-primary focus:ring-1 focus:ring-primary outline-none bg-white/80 w-32 transition-all focus:w-48" onchange="focusOnPerson(this.value)">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <datalist id="focusOptions"></datalist>
                </div>

                <!-- Actions -->
                <button onclick="openRankManagementModal()" class="btn-icon w-9 h-9 flex items-center justify-center shadow-sm" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®"><i class="fa-solid fa-sliders"></i></button>
                
                <button onclick="openAddRootModal()" class="btn-theme flex items-center space-x-2"><i class="fa-solid fa-user-plus"></i><span class="hidden sm:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å</span></button>

                <!-- Monarch Banner (Fixed Visibility) -->
                <div id="monarchBannerContainer" class="flex items-center">
                    <!-- Active Monarch -->
                    <div id="monarchBanner" class="hidden monarch-frame rounded-full pl-1 pr-4 py-1 flex items-center gap-2 transition-all duration-500 cursor-pointer hover:scale-105" onclick="focusOnMonarch()">
                        <div class="relative">
                            <img id="monarchImg" src="" class="w-9 h-9 rounded-full border-2 border-white shadow-sm object-cover">
                            <i class="fa-solid fa-crown text-[10px] text-yellow-500 absolute -top-1 -right-1 bg-white rounded-full p-0.5 shadow-sm"></i>
                        </div>
                        <div class="text-xs text-left hidden lg:block">
                            <div class="text-[9px] text-amber-600 font-bold uppercase tracking-wide">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</div>
                            <div id="monarchName" class="font-bold leading-none text-slate-800 text-[11px]">-</div>
                        </div>
                    </div>
                    <!-- Vacant Throne -->
                    <div id="monarchVacant" class="hidden bg-red-50 border border-red-200 text-red-600 rounded-full px-3 py-1 flex items-center gap-2 text-xs shadow-sm animate-pulse">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <span class="font-bold hidden md:inline">‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á</span>
                        <button onclick="openAppointModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full font-bold shadow-sm transition text-[10px]">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- Tree View -->
        <div id="canvas-container" class="flex-1">
            <svg id="main-svg">
                <g id="viewport-group">
                    <g id="links-layer"></g>
                    <g id="nodes-layer"></g>
                </g>
            </svg>
            
            <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div class="bg-white/80 backdrop-blur p-6 rounded-2xl shadow-xl text-center max-w-sm pointer-events-auto border-2 border-dashed border-slate-300">
                    <div class="text-4xl mb-4 text-slate-300"><i class="fa-solid fa-sitemap"></i></div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡∏ô‡∏µ‡πâ</h3>
                    <button onclick="openAddRootModal()" class="btn-theme w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏£‡∏Å</button>
                </div>
            </div>

            <div class="floating-controls">
                <div class="view-mode-wrapper">
                    <select id="treeViewMode" class="view-mode-selector" onchange="changeViewMode(this.value)">
                        <option value="all">1. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="all_v2">2. ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏±‡∏á‡∏£‡∏ß‡∏° (v2)</option> 
                        <option value="descendants">3. ‡∏™‡∏≤‡∏¢‡∏™‡∏Å‡∏∏‡∏• (‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô)</option>
                        <option value="direct">4. ‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏©+‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô)</option>
                        <option value="ancestors">5. ‡∏™‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏© (Ancestors)</option>
                        <option value="royalSurname">6. ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</option>
                        
                    </select>
                </div>

                <!-- NEW: Reign Filter Dropdown for Royal Surname View -->
                <select id="reignFilterSelector" class="view-mode-selector hidden" onchange="changeRoyalSurnameFilter(this.value)">
                    <option value="all">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•... (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                    <!-- Options populated by JS -->
                </select>

                <!-- Royal Surname Selector/Header -->
                <select id="royalSurnameSelector" class="view-mode-selector hidden" onchange="changeRoyalSurnameRoot(this.value)">
                    <!-- Options populated by JS -->
                </select>
                
                <div id="surnameViewHeader" class="bg-white/90 p-2 rounded-xl text-center shadow-md hidden">
                     <div class="text-[10px] text-slate-500">‡∏´‡∏±‡∏ß‡∏ú‡∏±‡∏á‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•</div>
                     <div id="surnameHeaderName" class="font-bold text-sm text-indigo-600">‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.</div>
                </div>

                <div class="h-px w-20 bg-slate-300 mx-auto my-1"></div>
                <button class="ctrl-btn" onclick="toggleOrientation()" title="‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ô‡∏ß (‡∏ï‡∏±‡πâ‡∏á/‡∏ô‡∏≠‡∏ô)"><i class="fa-solid fa-rotate"></i></button>
                <button class="ctrl-btn" onclick="zoomIn()"><i class="fa-solid fa-plus"></i></button>
                <button class="ctrl-btn" onclick="zoomOut()"><i class="fa-solid fa-minus"></i></button>
                <button class="ctrl-btn" onclick="resetView()"><i class="fa-solid fa-crosshairs"></i></button>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="table-view-container hidden">
            <div class="container mx-auto max-w-5xl">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="font-cute text-2xl" style="color: var(--primary);">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
                    <div class="flex gap-2 items-center flex-wrap justify-center">
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
                        <button id="btnResetPrecedence" onclick="resetPrecedence()" class="hidden bg-red-50 hover:bg-red-100 text-red-500 px-3 py-1.5 rounded-full text-xs font-bold transition border border-red-100" title="‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏õ‡∏Å‡∏ï‡∏¥">
                            <i class="fa-solid fa-rotate-left mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏≥‡∏î‡∏±‡∏ö
                        </button>
                    
                     <div id="monarchFilterContainer" class="hidden flex gap-2">
            <select id="monarchFilterSelect" class="bg-amber-50 px-4 py-1.5 rounded-full border border-amber-200 text-sm font-bold text-amber-700 outline-none shadow-sm" onchange="renderTable()">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå --</option>
            </select>
            
            <select id="royalSubFilter" class="bg-blue-50 px-4 py-1.5 rounded-full border border-blue-200 text-sm font-bold text-blue-700 outline-none shadow-sm" onchange="renderTable()">
                <option value="mother_rank">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤</option>
                <option value="age_all">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</option>
            </select>
        </div>

        <select id="tableFilterStatus" class="bg-white px-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition cursor-pointer shadow-sm" onchange="onTableFilterChange()">
            <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="alive" selected>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
            <option value="dead">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
            <option value="precedence">‚ú® ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°</option>
            <option value="royal_children">üëë ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á</option>
        </select>

        <div class="relative group">
            <input type="text" id="tableSearch" oninput="renderTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="pl-10 pr-4 py-1.5 rounded-full border border-slate-200 text-sm focus:border-primary outline-none transition w-64 bg-white shadow-sm">
            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
        </div>
    </div>
</div>
                    <!-- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->

                </div>
                <div class="rounded-[20px] shadow-sm border overflow-hidden" style="background: var(--accent-bg); border-color: var(--accent-border);">
                    <div class="table-wrapper"> <!-- ADDED WRAPPER FOR SCROLL -->
                        <table class="w-full text-left">
                            <thead>
                                <tr style="background: var(--bg-dots);">
                                    <th class="text-center w-20">‡∏£‡∏π‡∏õ</th>
                                    <th>‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ô‡∏≤‡∏°</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ö‡∏¥‡∏î‡∏≤ / ‡∏°‡∏≤‡∏£‡∏î‡∏≤</th>
                                    <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div> <!-- END WRAPPER -->
                </div>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content w-full max-w-sm overflow-hidden relative border-4 border-white">
            <button onclick="closeModal('detailModal')" class="absolute top-3 right-3 text-white bg-black/10 rounded-full w-8 h-8 z-20 hover:bg-black/20 backdrop-blur-sm flex items-center justify-center transition">‚úï</button>
            
            <div class="h-48 relative overflow-hidden" style="background: linear-gradient(to top right, var(--bg-dots), var(--primary-light));">
                <div class="absolute inset-0 opacity-30 mix-blend-overlay bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="absolute -bottom-10 left-1/2 -translate-x-1/2 flex flex-col items-center">
                    <div class="relative">
                        <img id="d_img" class="w-28 h-28 rounded-full border-[4px] border-white bg-white object-cover shadow-lg aspect-square">
                        <i id="d_crown" class="fa-solid fa-crown absolute -top-6 left-1/2 -translate-x-1/2 text-3xl text-yellow-400 drop-shadow-md hidden filter saturate-150 animate-pulse"></i>
                    </div>
                </div>
            </div>

            <div class="pt-14 pb-8 px-6 text-center" style="background: var(--accent-bg);">
                <h3 id="d_name" class="text-lg font-royal font-bold leading-tight mb-1" style="color: var(--text-main);"></h3>
                <div class="flex justify-center items-center gap-2 mb-3">
                    <div class="text-[10px] font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-500 flex items-center gap-1 cursor-pointer hover:bg-gray-200 transition" onclick="copyToClipboard(window.curPID)">
                        <span id="d_id"></span> <i class="fa-regular fa-copy"></i>
                    </div>
                </div>
                
                <p id="d_krom" class="text-xs font-bold text-amber-600 bg-amber-50 inline-block px-4 py-1.5 rounded-xl mb-4 border border-amber-200 shadow-sm hidden"></p>

                <div id="d_badges" class="flex flex-wrap justify-center gap-2 mb-4"></div>

                <div class="grid grid-cols-1 gap-2 mb-4">
                    <button onclick="setAsRoot(window.curPID)" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-sitemap"></i> ‡∏î‡∏π‡∏ú‡∏±‡∏á‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏•‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openSpouseSelectionModal(window.curPID)" class="py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-heart"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™
                        </button>
                        <button onclick="openAddChildModal(window.curPID)" class="py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-baby"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å
                        </button>
                    </div>
                    <button onclick="showHistoryModal(window.curPID)" class="w-full py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2 mb-2">
    <i class="fa-solid fa-scroll"></i> ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
</button>
                    <button onclick="openAddParentModal(window.curPID)" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-up"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤/‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤
                    </button>
                </div>

                <div id="d_statusBox" class="text-left text-sm space-y-2 p-4 rounded-3xl border shadow-inner mb-4" style="background: var(--bg-main); border-color: var(--accent-border);">
                    <div class="flex justify-between"><span class="text-xs text-slate-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span id="d_status" class="font-bold"></span></div>
                    <!-- NEW: Display Birth Year -->
                    <div class="flex justify-between"><span class="text-xs text-slate-400">‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥ (‡∏û.‡∏®.)</span><span id="d_birthYear"></span></div>
                    <div class="flex justify-between"><span class="text-xs text-slate-400">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</span><span id="d_spouses_count"></span></div>
                    <div class="flex justify-between"><span class="text-xs text-slate-400">‡∏â‡∏±‡∏ï‡∏£</span><span id="d_umbrella"></span></div>
                </div>

                <!-- UPDATED BUTTONS BLOCK: King will always have 4 buttons (Edit, Abdicate, Death, Delete) -->
                <div class="flex gap-2 justify-center border-t pt-4 border-slate-100">
    <button onclick="editCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fa-solid fa-pen"></i></button>
    
    <button onclick="promoteMomChao()" id="btnPromoteMC" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-amber-500 hidden" title="‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤">
        <i class="fa-solid fa-medal"></i>
    </button>

    <button onclick="abdicateCurrent()" id="btnAbdicate" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-purple-600 hover:text-purple-700 hidden" title="‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥">
        <i class="fa-solid fa-person-walking-arrow-right"></i>
    </button>
    <button onclick="toggleDeath()" id="btnDeath" class="btn-icon w-10 h-10 flex items-center justify-center text-lg" title="‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏≤‡∏¢/‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏û"><i class="fa-solid fa-skull"></i></button>
    <button onclick="deleteCurrent()" class="btn-icon w-10 h-10 flex items-center justify-center text-lg text-red-400" title="‡∏•‡∏ö"><i class="fa-solid fa-trash"></i></button>
</div>
            </div>
        </div>
    </div>

    <!-- Person Form Modal -->
    <div id="personModal" class="modal">
         <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b" style="background: var(--bg-dots);">
                <h2 id="modalTitle" class="font-cute font-bold text-lg"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                <button onclick="closeModal('personModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1" style="background: var(--accent-bg);">
                <form id="personForm" onsubmit="handleSavePerson(event)" class="space-y-6">
                    <input type="hidden" id="p_isEditMode">
                    <div class="flex gap-8 flex-col md:flex-row">
                        <!-- Image Upload -->
                        <div class="flex-shrink-0 flex flex-col items-center gap-3">
                            <div class="w-36 h-36 rounded-full border-4 flex items-center justify-center overflow-hidden relative group cursor-pointer transition shadow-sm" style="background: var(--bg-dots);" onclick="document.getElementById('p_imageFile').click()">
                                <img id="p_imagePreview" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white transition backdrop-blur-sm"><i class="fa-solid fa-camera text-2xl"></i></div>
                            </div>
                            <input type="file" id="p_imageFile" accept="image/*" class="hidden" onchange="handleImageUpload(this)"><input type="hidden" id="p_imageFinal">
                            <div class="flex gap-2">
                                <label class="cursor-pointer bg-blue-50 text-blue-500 px-4 py-1.5 rounded-full text-xs font-bold border border-blue-100 peer-checked:bg-blue-400 peer-checked:text-white transition"><input type="radio" name="gender" value="M" checked class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();"> ‡∏ä‡∏≤‡∏¢</label>
                                <label class="cursor-pointer bg-pink-50 text-pink-500 px-4 py-1.5 rounded-full text-xs font-bold border border-pink-100 peer-checked:bg-pink-400 peer-checked:text-white transition"><input type="radio" name="gender" value="F" class="hidden" onchange="updateDefaultImage(); checkQueenConsortEligible(); updateAutoId();"> ‡∏´‡∏ç‡∏¥‡∏á</label>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                                <input type="checkbox" id="p_isAlive" checked class="accent-emerald-500 rounded"> <span class="text-xs text-emerald-600 font-bold">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà</span>
                            </label>
                        </div>
                        <!-- Info Fields -->
                        <div class="flex-1 space-y-4">
                            <div class="flex gap-2 items-end bg-slate-50 p-2 rounded-lg border border-slate-100">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-slate-500">ID (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                                    <input type="text" id="p_id" readonly class="w-full text-sm font-mono bg-transparent border-none focus:ring-0 text-slate-600">
                                </div>
                                <button type="button" onclick="copyToClipboard(document.getElementById('p_id').value)" class="p-1.5 text-xs bg-white border rounded shadow-sm hover:bg-slate-50">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                            </div>
                            <div class="p-4 rounded-[25px] border grid grid-cols-1 md:grid-cols-2 gap-4" style="background: var(--bg-dots);">
                                <div>
                                    <label class="text-xs font-bold text-indigo-400 mb-1 block ml-2">‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤</label>
                                    <div class="flex gap-1 relative">
                                        <input type="text" id="p_fatherSearch" list="fatherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID/‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateParent('father')">
                                        <datalist id="fatherOptions"></datalist><input type="hidden" id="p_fatherId">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-pink-400 mb-1 block ml-2">‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤</label>
                                    <div class="flex gap-1 relative">
                                        <input type="text" id="p_motherSearch" list="motherOptions" class="w-full text-xs rounded-full px-3 input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID/‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateParent('mother')">
                                        <datalist id="motherOptions"></datalist><input type="hidden" id="p_motherId">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-12 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label>
                                    <select id="p_relationship" class="w-full text-sm input-theme" onchange="updatePrefixOptions(); checkQueenConsortEligible()"></select>
                                </div>
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                                    <select id="p_titlePrefix" class="w-full text-sm input-theme" onchange="updateSuffixOptions()"></select>
                                </div>
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®</label>
                                    <select id="p_royalRank" class="w-full text-sm input-theme" onchange="updateAutoId(); toggleSurnameFields();">
                                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)</option>
                                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)</option>
                                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)">‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)</option>
                                        <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)</option>
                                        <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)</option>
                                        <option value="‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)">‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)</option>
                                        <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤">‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤</option>
                                        <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå">‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå</option>
                                        <option value="‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á">‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á</option>
                                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä">‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</option>
                                        <option value="‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô">‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô</option>
                                    </select>
                                </div>
                                <div class="col-span-12">
                                     <label class="flex items-center gap-2 cursor-pointer ml-2">
                                        <input type="checkbox" id="p_hideRoyalRank" class="accent-slate-500 rounded">
                                        <span class="text-xs text-slate-500">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏¥‡∏¢‡∏¢‡∏®</span>
                                    </label>
                                </div>     
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs font-bold ml-2 text-primary">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ä‡∏∑‡πà‡∏≠ *</label>
                                    <input type="text" id="p_name" required class="w-full font-bold input-theme">
                                </div>
                                <div class="col-span-6 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</label>
                                    <select id="p_titleSuffix" class="w-full text-sm input-theme"></select>
                                </div>
                                <div class="col-span-12 md:col-span-4">
                                    <label class="text-xs ml-2 text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                    <input type="text" id="p_nickname" class="w-full text-sm input-theme">
                                </div>
                                
                                <!-- START NEW SURNAME INPUTS -->
                                <div class="col-span-12 space-y-3 p-3 rounded-xl border border-slate-100 bg-white shadow-sm">
                                    <div class="flex justify-between items-center">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="p_isSurnameFounder" class="accent-indigo-500 rounded" onchange="toggleSurnameFields()">
                                            <span class="text-sm font-bold text-indigo-600">‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•?</span>
                                        </label>
                                        <!-- NEW: Hide Surname Toggle -->
                                        <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-500">
                                            <input type="checkbox" id="p_hideSurname" class="accent-slate-500 rounded">
                                            ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                                        </label>
                                        <!-- END NEW: Hide Surname Toggle -->
                                    </div>
                                    <!-- Field for Royal Surname Founder -->
                                    <div id="royalSurnameFounderPanel" class="hidden">
                                        <label class="text-xs ml-2 text-slate-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠)</label>
                                        <input type="text" id="p_royalSurnameInput" class="w-full text-sm input-theme font-bold" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•">
                                    </div>
                                    <!-- Field for Commoner Surname -->
                                    <div id="commonerSurnamePanel" class="hidden">
                                        <label class="text-xs ml-2 text-slate-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô)</label>
                                        <input type="text" id="p_commonerSurnameInput" class="w-full text-sm input-theme" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ)">
                                    </div>
                                </div>
                                <!-- END NEW SURNAME INPUTS -->
                                
                                <div class="col-span-6 md:col-span-3">
                                    <label class="text-xs ml-2 text-slate-400">‡∏¢‡∏®‡∏Å‡∏£‡∏°</label>
                                    <select id="p_kromRank" class="w-full text-sm input-theme" onchange="toggleKrom()">
                                        <option value="">-</option><option value="‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô">‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô</option><option value="‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô">‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô</option><option value="‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á">‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á</option><option value="‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞">‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞</option><option value="‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤">‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤</option><option value="‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞">‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞</option>
                                    </select>
                                </div>
                                <div class="col-span-6 md:col-span-3">
                                    <label class="text-xs ml-2 text-slate-400">‡∏£‡∏≤‡∏ä‡∏ó‡∏¥‡∏ô‡∏ô‡∏≤‡∏°‡∏Å‡∏£‡∏°</label>
                                    <input type="text" id="p_kromTitle" class="w-full text-sm hidden input-theme">
                                </div>
                                
                                <!-- Birth Year Input (Moved to the end of the logical group) -->
                                <div class="col-span-12 md:col-span-6">
                                    <label class="text-xs ml-2 text-slate-400">‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥ (‡∏û.‡∏®.)</label>
                                    <input type="number" id="p_birthYear" class="w-full text-sm input-theme" placeholder="‡∏û.‡∏®.">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="p_hasUmbrella" class="accent-amber-500 w-4 h-4" onchange="toggleUmbrella()">
                                <label class="text-sm font-bold text-amber-700">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡∏â‡∏±‡∏ï‡∏£</label>
                            </div>
                            <select id="p_umbrellaType" class="w-full text-sm input-theme hidden">
                                <option value="‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (3 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                                <option value="‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (5 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                                <option value="‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (7 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                                <option value="‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£">‡∏ô‡∏û‡∏î‡∏•‡∏°‡∏´‡∏≤‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£ (9 ‡∏ä‡∏±‡πâ‡∏ô)</option>
                            </select>
                        </div>
                        <div class="p-4 rounded-[20px] border" style="background: var(--bg-dots);">
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-sm font-bold text-rose-400">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</h3>
                                <div class="flex gap-1">
                                    <input type="text" id="p_spouseSearch" list="spouseOptions" class="text-xs w-28 rounded-full input-theme" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                                    <datalist id="spouseOptions"></datalist>
                                    <button type="button" onclick="addSpouse()" class="bg-rose-300 text-white w-6 h-6 rounded-full text-xs hover:bg-rose-400">+</button>
                                </div>
                            </div>
                            <ul id="p_spouseList" class="flex flex-wrap gap-2 text-xs"></ul>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 pt-2 items-center">
                        <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-amber-50 border-amber-100">
                            <input type="checkbox" id="p_isMonarch" class="accent-amber-400 w-4 h-4" onchange="toggleMonarch()">
                            <span class="text-sm font-bold text-amber-600">‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ</span>
                        </label>
                        <div class="flex items-center gap-2 px-4 py-2 rounded-2xl border transition bg-blue-50 border-blue-100">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="p_isHeir" class="accent-blue-400 w-4 h-4" onchange="toggleHeirOrder()">
                                <span class="text-sm font-bold text-blue-600">‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</span>
                            </label>
                            <input type="number" id="p_heirOrder" min="1" placeholder="‡∏•‡∏≥‡∏î‡∏±‡∏ö" class="w-16 text-xs input-theme hidden border-blue-200 text-blue-800 font-bold text-center">
                        </div>
                         <label id="queenConsortOption" class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-2xl border transition bg-pink-50 border-pink-100 hidden">
                            <input type="checkbox" id="p_isQueenConsort" class="accent-pink-400 w-4 h-4">
                            <span class="text-sm font-bold text-pink-600">‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå</span>
                        </label>
                    </div>
                    <div id="monarchPanel" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-3xl border border-amber-200 grid grid-cols-4 gap-3 animate-fade-in">
                        <div class="col-span-4 flex flex-col md:flex-row gap-2 mb-2 bg-white/50 p-2 rounded-xl">
                            <div class="flex items-center gap-2 flex-1">
                                <input type="checkbox" id="p_useReignName" class="accent-amber-600" onchange="toggleReignName()">
                                <span class="text-xs font-bold text-amber-800">‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</span>
                                <select id="p_reignNameSelect" class="text-xs input-theme hidden flex-1"></select>
                                <span id="p_autoReignNameNumber" class="text-xs font-bold text-amber-600 hidden bg-amber-100 px-2 py-1 rounded"></span>
                            </div>
                            <div class="flex items-center gap-2 border-l pl-2 border-amber-200">
                                <span class="text-xs font-bold text-amber-800">‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà :</span>
                                <input type="number" id="p_globalReignNumber" class="w-16 text-xs font-bold text-center input-theme border-amber-300 text-amber-900" min="1">
                            </div>
                        </div>
                        <input type="text" id="p_reignStart" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå (‡∏û.‡∏®.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                        <input type="text" id="p_reignEnd" placeholder="‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û.‡∏®.)" class="col-span-1 text-sm bg-white border-amber-100 rounded-lg p-1 text-center">
                        <input type="text" id="p_eraName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢" class="col-span-2 text-sm bg-white border-amber-100 rounded-lg p-1">
                        <div id="maleMonarchQueenSelect" class="col-span-4 mt-2 pt-2 border-t border-amber-200/50 hidden">
                            <label class="text-xs font-bold text-amber-700 block mb-1">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)</label>
                            <select id="p_queenSelectForKing" class="text-xs input-theme w-full bg-white/80 border-amber-200 text-pink-700 font-bold">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="hidden"></button>
                </form>
            </div>
            <div class="p-4 flex justify-end gap-3 border-t" style="background: var(--accent-bg);">
                <button onclick="closeModal('personModal')" class="px-5 py-2 rounded-full transition text-sm font-bold bg-gray-100 text-gray-500 hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" form="personForm" class="px-8 py-2 btn-theme text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    
    <!-- Initial Setup Modal -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content w-full max-w-sm p-8 text-center relative">
            <button onclick="closeModal('initialSetupModal')" class="absolute top-4 right-4 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h2 class="text-2xl font-cute font-bold mb-2" style="color: var(--text-main);">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£</h2>
            <p class="text-sm mb-6" style="color: var(--text-sub);">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="space-y-3">
                <input type="text" id="setupKingdomName" class="w-full input-theme text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£">
                <input type="text" id="setupDynastyName" class="w-full input-theme text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå">
            </div>
            <button onclick="completeInitialSetup()" class="btn-theme w-full mt-6 py-3 text-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢ ‚ú®</button>
        </div>
    </div>

    <!-- Rank & Data Management Modal (Updated HTML with Scores) -->
    <div id="rankManagementModal" class="modal">
    <div class="modal-content rounded-3xl p-0 w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden bg-[#f8fafc]">
        <div class="p-5 bg-white border-b flex justify-between items-center shadow-sm z-10">
            <h2 class="font-cute font-bold text-xl text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏¢‡∏® (‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°)</h2>
            <button onclick="closeModal('rankManagementModal')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100">‚úï</button>
        </div>

        <div class="flex flex-1 overflow-hidden p-6 gap-4 flex-col lg:flex-row bg-[#f8fafc]">
            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-indigo-600 font-bold"><i class="fa-solid fa-layer-group"></i> 1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="flex gap-2">
                        <input id="nr" class="flex-1 min-w-0 px-3 py-2 rounded-xl border text-sm outline-none focus:ring-2 focus:ring-indigo-400" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addData('rel')" class="bg-indigo-500 text-white w-10 h-10 rounded-xl hover:bg-indigo-600 transition flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <ul id="rl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-pink-600 font-bold"><i class="fa-solid fa-tag"></i> 2. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="space-y-2">
                        <div class="flex gap-1">
                            <input id="np" class="flex-grow min-w-0 px-2 py-2 rounded-xl border text-xs outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠..">
                            <input id="np_score" type="number" class="w-16 shrink-0 px-1 py-2 rounded-xl border text-xs text-center outline-none" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                        </div>
                        <button onclick="addData('pre')" class="w-full bg-pink-500 text-white py-2 rounded-xl font-bold text-xs hover:bg-pink-600 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>
                <ul id="pl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-emerald-600 font-bold"><i class="fa-solid fa-medal"></i> 3. ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°</div>
                <div class="p-4 bg-slate-50/50 border-b">
                    <div class="space-y-2">
                        <div class="flex gap-1">
                            <input id="ns" class="flex-grow min-w-0 px-2 py-2 rounded-xl border text-xs outline-none" placeholder="‡∏™‡∏£‡πâ‡∏≠‡∏¢..">
                            <input id="ns_score" type="number" class="w-16 shrink-0 px-1 py-2 rounded-xl border text-xs text-center outline-none" value="0">
                        </div>
                        <button onclick="addData('suf')" class="w-full bg-emerald-500 text-white py-2 rounded-xl font-bold text-xs hover:bg-emerald-600 transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>
                <ul id="sl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>

            <div class="flex-1 min-w-0 bg-amber-50/30 rounded-[2rem] border border-amber-200 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b flex items-center gap-2 text-amber-600 font-bold"><i class="fa-solid fa-crown"></i> 4. ‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</div>
                <div class="p-4 bg-white/50 border-b">
                    <div class="flex gap-2">
                        <input id="nreign" class="flex-1 min-w-0 px-3 py-2 rounded-xl border border-amber-100 outline-none text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô...">
                        <button onclick="addData('reign')" class="bg-amber-500 text-white w-10 h-10 rounded-xl hover:bg-amber-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <ul id="reignl" class="flex-1 overflow-y-auto p-2 space-y-1"></ul>
            </div>
        </div>
    </div>
</div>

    <!-- Appoint Modal -->
    <div id="appointModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-lg mb-4 text-red-600">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</h3>
            <p class="text-xs text-slate-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤, ‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô, ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤)</p>
            <select id="appointSelectModal" class="input-theme w-full mb-4"></select>
            <button onclick="appointFromModal()" class="btn-theme w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</button>
            <button onclick="closeModal('appointModal')" class="mt-2 text-xs text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <!-- Reign Name Selection Modal -->
    <div id="reignSelectionModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-lg mb-4 text-amber-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</h3>
            <p class="text-xs text-slate-500 mb-4">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà</p>
            <select id="reignSelectionInput" class="input-theme w-full mb-4"></select>
            <button onclick="confirmReignSelection()" class="btn-theme w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>
    
    <!-- Relationship Finder Modal -->
    <div id="relationshipModal" class="modal">
        <div class="modal-content w-full max-w-md p-6 relative">
            <button onclick="closeModal('relationshipModal')" class="absolute top-4 right-4 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-cute font-bold text-xl mb-6 text-center text-primary"><i class="fa-solid fa-users-rays mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h3>
            
            <div class="space-y-4">
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <label class="text-xs font-bold text-indigo-500 mb-1 block">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà 1 (A)</label>
                    <div class="flex gap-2">
                        <div class="w-10 h-10 rounded-full bg-white border-2 border-indigo-200 flex items-center justify-center overflow-hidden">
                            <img id="rel_img_a" src="" class="w-full h-full object-cover opacity-50">
                        </div>
                        <input type="text" id="rel_input_a" list="relOptions" class="flex-1 input-theme text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." onchange="updateRelPreview('a')">
                    </div>
                    <input type="hidden" id="rel_id_a">
                </div>
                
                <div class="flex justify-center -my-2 relative z-10">
                    <div class="bg-white p-2 rounded-full shadow-sm border text-slate-400 text-xs">
                        <i class="fa-solid fa-arrow-down-up"></i>
                    </div>
                </div>

                <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100">
                    <label class="text-xs font-bold text-pink-500 mb-1 block">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà 2 (B)</label>
                    <div class="flex gap-2">
                         <div class="w-10 h-10 rounded-full bg-white border-2 border-pink-200 flex items-center justify-center overflow-hidden">
                            <img id="rel_img_b" src="" class="w-full h-full object-cover opacity-50">
                        </div>
                        <input type="text" id="rel_input_b" list="relOptions" class="flex-1 input-theme text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." onchange="updateRelPreview('b')">
                    </div>
                    <input type="hidden" id="rel_id_b">
                </div>
                
                <datalist id="relOptions"></datalist>
                
                <button onclick="calculateRelationship()" class="btn-theme w-full py-3 mt-2 shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-search mr-2"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Fantasy Celebration Modal -->
    <div id="fantasyModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('fantasyModal')" class="absolute top-2 right-2 text-amber-200 hover:text-white z-20">‚úï</button>
            <div id="fantasyParticles"></div>
            
            <div class="golden-frame">
                <img id="fan_img" src="" class="w-32 h-32 rounded-full object-cover border-4 border-black">
            </div>
            
            <div class="space-y-4 relative z-10">
                <div class="font-royal text-sm text-amber-200 tracking-widest uppercase">‡∏Ç‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£</div>
                <h2 id="fan_name" class="font-royal text-2xl md:text-3xl shimmer-text leading-tight px-4"></h2>
                
                <div class="text-xs text-amber-100/80 font-light mt-4">
                    ‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå <span id="fan_dynasty" class="font-bold text-white"></span> ‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ <span id="fan_kingdom" class="font-bold text-white"></span><br>
                    ‡∏ó‡∏£‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å‡πÄ‡∏™‡∏ß‡∏¢‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥<br>
                    ‡πÄ‡∏õ‡πá‡∏ô <span id="fan_rama" class="font-bold text-lg text-white"></span>
                </div>

                <div class="my-6 h-px w-3/4 mx-auto bg-gradient-to-r from-transparent via-[#d4af37] to-transparent"></div>

                <p class="text-xs md:text-sm text-amber-100 italic leading-relaxed px-4">
                    "‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÄ‡∏î‡∏ä‡∏≤‡∏ô‡∏∏‡∏†‡∏≤‡∏û<br>
                    ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ï‡πâ‡∏ù‡πà‡∏≤‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ò‡∏∏‡∏•‡∏µ‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏ó‡∏£‡∏á‡∏ô‡∏≥‡∏û‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏ú‡∏≤‡∏™‡∏∏‡∏Å<br>
                    ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏û‡∏ö‡∏π‡∏•‡∏¢‡πå ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•‡∏ô‡∏≤‡∏ô"
                </p>

                <div class="font-royal text-xl text-[#ffd700] mt-6 animate-pulse">
                    ‡∏Ç‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏à‡∏£‡∏¥‡∏ç
                </div>
            </div>
        </div>
    </div>
    
    <!-- Spouse Selection Method Modal (NEW) -->
    <div id="spouseSelectionModal" class="modal">
        <div class="modal-content w-full max-w-sm p-6 relative overflow-hidden">
            <button onclick="closeModal('spouseSelectionModal')" class="absolute top-3 right-3 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-3 text-pink-500 text-2xl border-2 border-pink-200">
                    <i class="fa-solid fa-heart"></i>
                </div>
                <h3 class="font-cute font-bold text-xl text-slate-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</h3>
                <p class="text-xs text-slate-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>

            <div class="space-y-4">
                <!-- Option 1: Existing Person -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <label class="text-xs font-bold text-slate-500 mb-2 block"><i class="fa-solid fa-users mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <!-- Note: list attribute is bound to eligibleSpouseList -->
                            <input type="text" id="existingSpouseSearch" list="eligibleSpouseList" class="w-full input-theme text-sm pl-8" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠..." onchange="validateExistingSpouseInput()">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        </div>
                        <input type="hidden" id="selectedExistingSpouseId">
                    </div>
                    <datalist id="eligibleSpouseList"></datalist>
                    <button onclick="confirmLinkExistingSpouse()" class="w-full mt-2 py-2 bg-white border border-pink-200 text-pink-600 font-bold rounded-xl text-xs hover:bg-pink-50 transition shadow-sm">
                        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™
                    </button>
                </div>

                <div class="relative flex py-1 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-300 text-[10px]">‡∏´‡∏£‡∏∑‡∏≠</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <!-- Option 2: New Person -->
                <button onclick="proceedToNewSpouse()" class="w-full py-3 btn-theme flex items-center justify-center gap-2 shadow-lg shadow-pink-100">
                    <i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>
    <!-- End Spouse Selection Method Modal -->

    <div id="historyModal" class="modal">
    <div class="modal-content w-full max-w-md p-6 relative">
        <button onclick="closeModal('historyModal')" class="absolute top-4 right-4 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
        <h3 class="font-cute font-bold text-xl mb-4 text-center text-slate-700">
            <i class="fa-solid fa-history mr-2"></i>‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏®
        </h3>
        <div id="historyList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
            </div>
    </div>
</div>
    <!-- Toast Container -->
    <div id="toast-container"></div>

<script>
// ================= CONFIG & CONSTANTS =================
const DEFAULT_IMG_MALE = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
const DEFAULT_IMG_FEMALE = "https://cdn-icons-png.flaticon.com/512/4128/4128253.png";

const BASE_CONFIG = { nodeWidth: 180, nodeHeight: 100, gapX: 40, gapY: 150, spouseGap: 50 };
const ANCESTOR_CONFIG = { nodeWidth: 160, nodeHeight: 90, gapX: 100, gapY: 150 };
// Added new ranks for MR/ML
const RANK_CODES = { "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)":'1', "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)":'2', "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)":'3', "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)":'4', "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)":'5',"‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)":'B', "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤":'6', "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå":'7', "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á":'8', "‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä":'9', "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô":'A' };

// ================= GLOBAL STATE =================
let appIndex = []; // List of all kingdoms [{id, kingdomName, dynastyName}]
let currentKingdomId = null;

let state = {
    kingdomName: "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£",
    dynastyName: "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå",
    members: [],
    reignNames: ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡πÄ‡∏°‡∏ô‡∏ó‡∏£", "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏°‡∏¥‡∏ô‡∏ó‡∏£", "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡πà‡∏ß‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤", "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥"], 
   hierarchy: {
        "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": ["‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß"] } },
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ"] } },
        "‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤": { 
            prefixes: [
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", 
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", 
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", 
                "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"
            ], 
            suffixes: { 
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": [
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", 
                    "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"
                ],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è": ["‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è": ["‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤": ["‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"],
                "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ": [""],
                "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": [""],
                "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": [""],
                "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤": [""]
            } 
        },
        "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤": { 
            prefixes: [
                "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞", 
                "‡∏û‡∏£‡∏∞", 
                "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå", 
                "‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", 
                "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", 
                "‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", 
                "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", 
                "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤", 
                "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°", 
                "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°"
            ], 
            suffixes: {} 
        },
        
        // Non-Monarch Consorts (NEW)
        "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤": { prefixes: ["‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"], suffixes: {} }, // Royal Consort of a Prince
        "‡∏´‡∏°‡πà‡∏≠‡∏°": { prefixes: ["‡∏´‡∏°‡πà‡∏≠‡∏°", "‡∏Ñ‡∏∏‡∏ì"], suffixes: {} }, // Commoner Consort of a Prince
        
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"], "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"] } },
        "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠": ["‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£‡∏µ", "‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡πÉ‡∏ô"], "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠": ["‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡πÉ‡∏ô"] } },
        
        // NEW SUCCESSION RANKS
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"], suffixes: {} },
        "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠", "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"], suffixes: {} },
        
        "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠"], suffixes: {} }, // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        "‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó": { prefixes: ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä"], suffixes: { "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÇ‡∏≠‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä": ["‡∏™‡∏¢‡∏≤‡∏°‡∏°‡∏Å‡∏∏‡∏é‡∏£‡∏≤‡∏ä‡∏Å‡∏∏‡∏°‡∏≤‡∏£"] } },
        // UPDATED: Prefixes for commoners
        "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô": { prefixes: ["‡∏ô‡∏≤‡∏¢", "‡∏ô‡∏≤‡∏á", "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß", "‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á", "‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á"], suffixes: {} }
    },
    prefixScores: {}, // New: ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
    suffixScores: {}, // New: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏£‡πâ‡∏≠‡∏¢
    currentTheme: 'white',
    zoom: 1, panX: window.innerWidth/2, panY: 50, isDragging: false, isHorizontal: false,
    viewRootId: null, 
    viewMode: 'tree',
    treeViewType: 'all', // all, descendants, direct, ancestors, royalSurname (NEW)
    currentSurnameRootId: null, // NEW
    currentReignFilter: 'all', // NEW: Added for filtering surname founders
    highlightIds: [] // IDs to flash
};

// ================= INITIALIZATION & KINGDOM MANAGEMENT =================
let targetOriginIdForSpouse = null; // NEW: Global state to hold the person ID requesting a spouse

window.onload = () => {
    loadAppIndex();
    
    // Check if we have any kingdoms
    if(appIndex.length === 0) {
        // Try to migrate from old single-save version
        const oldSave = localStorage.getItem('royal_tree_v2');
        if(oldSave) {
            const oldData = JSON.parse(oldSave);
            createNewKingdom(oldData.kingdomName || "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏î‡∏¥‡∏°", oldData.dynastyName || "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏î‡∏¥‡∏°", oldData);
            localStorage.removeItem('royal_tree_v2'); // Clean up old save
        } else {
            document.getElementById('initialSetupModal').classList.add('active');
        }
    } else {
        // Load the last used kingdom or the first one
        const lastId = localStorage.getItem('royal_tree_last_id');
        if(lastId && appIndex.find(k => k.id === lastId)) {
            switchKingdom(lastId);
        } else {
            switchKingdom(appIndex[0].id);
        }
    }
    
    setupPanZoom();
};

function loadAppIndex() {
    const raw = localStorage.getItem('royal_tree_index');
    appIndex = raw ? JSON.parse(raw) : [];
    renderKingdomSelector();
}

function saveAppIndex() {
    localStorage.setItem('royal_tree_index', JSON.stringify(appIndex));
    renderKingdomSelector();
}

function renderKingdomSelector() {
    const sel = document.getElementById('kingdomSelector');
    sel.innerHTML = '';
    appIndex.forEach(k => {
        const op = document.createElement('option');
        op.value = k.id;
        op.innerText = k.kingdomName + " (" + k.dynastyName + ")";
        if(k.id === currentKingdomId) op.selected = true;
        sel.appendChild(op);
    });
}

function createNewKingdom(kName, dName, initialData = null) {
    const newId = 'kingdom_' + Date.now();
    const meta = { id: newId, kingdomName: kName, dynastyName: dName };
    appIndex.push(meta);
    saveAppIndex();

    // Init state for new kingdom
    let newState = JSON.parse(JSON.stringify(state)); // Clone default
    if(initialData) newState = {...newState, ...initialData};
    newState.kingdomName = kName;
    newState.dynastyName = dName;
    newState.members = initialData ? initialData.members : [];
    
    // Save new kingdom data
    localStorage.setItem('royal_tree_data_' + newId, JSON.stringify(newState));
    
    switchKingdom(newId);
}

function switchKingdom(id) {
    currentKingdomId = id;
    localStorage.setItem('royal_tree_last_id', id);
    
    const dataRaw = localStorage.getItem('royal_tree_data_' + id);
    if(dataRaw) {
        state = JSON.parse(dataRaw);
    } else {
        // Fallback should not happen normally
        state.members = [];
    }

    // Init scores if missing from old save
    if(!state.prefixScores) state.prefixScores = {};
    if(!state.suffixScores) state.suffixScores = {};
    
    // Init new surname state if missing
    if(!state.currentSurnameRootId) state.currentSurnameRootId = null;
    if(!state.currentReignFilter) state.currentReignFilter = 'all';

    // Update UI
    document.getElementById('kingdomSelector').value = id;
    document.getElementById('dynastyLabel').innerText = state.dynastyName;
    setTheme(state.currentTheme || 'white');
    
    // Restore View Settings
    document.getElementById('treeViewMode').value = state.treeViewType || 'all';
    
    updateApp();
}

function deleteCurrentKingdom() {
    if(appIndex.length <= 1) {
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ");
        return;
    }
    if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ "${state.kingdomName}" ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£`)) return;

    localStorage.removeItem('royal_tree_data_' + currentKingdomId);
    appIndex = appIndex.filter(k => k.id !== currentKingdomId);
    saveAppIndex();
    
    switchKingdom(appIndex[0].id);
    showToast("‡∏•‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

function completeInitialSetup() { 
    const kName = document.getElementById('setupKingdomName').value || "‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£"; 
    const dName = document.getElementById('setupDynastyName').value || "‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå"; 
    createNewKingdom(kName, dName);
    closeModal('initialSetupModal'); 
}

function openCreateKingdomModal() {
    document.getElementById('setupKingdomName').value = "";
    document.getElementById('setupDynastyName').value = "";
    document.getElementById('initialSetupModal').classList.add('active');
}

function saveState() { 
    if(!currentKingdomId) return;
    localStorage.setItem('royal_tree_data_' + currentKingdomId, JSON.stringify(state)); 
    
    // Update index name if changed
    const idx = appIndex.findIndex(k => k.id === currentKingdomId);
    if(idx !== -1) {
        if(appIndex[idx].kingdomName !== state.kingdomName || appIndex[idx].dynastyName !== state.dynastyName) {
            appIndex[idx].kingdomName = state.kingdomName;
            appIndex[idx].dynastyName = state.dynastyName;
            saveAppIndex();
        }
    }
}

function updateApp() {
    if(state.viewMode === 'tree') renderTree();
    else renderTable();
    renderMonarchBanner();
    populateSearchLists();
}

// ================= VIEW LOGIC =================

function switchView(mode) {
    state.viewMode = mode;
    saveState();
    const treeBtn = document.getElementById('btn-view-tree');
    const tableBtn = document.getElementById('btn-view-table');
    const canvas = document.getElementById('canvas-container');
    const table = document.getElementById('tableView');

    if(mode === 'tree') {
        canvas.classList.remove('hidden'); table.classList.add('hidden');
        treeBtn.style.background = "var(--primary)"; treeBtn.style.color = "white";
        tableBtn.style.background = "transparent"; tableBtn.style.color = "#64748b";
        renderTree();
    } else {
        canvas.classList.add('hidden'); table.classList.remove('hidden');
        tableBtn.style.background = "var(--primary)"; tableBtn.style.color = "white";
        treeBtn.style.background = "transparent"; treeBtn.style.color = "#64748b";
        renderTable();
    }
}

function changeRoyalSurnameRoot(founderId) {
    state.currentSurnameRootId = founderId;
    saveState();
    renderTree();
    resetView();
}

function changeRoyalSurnameFilter(reignId = null) {
    const selectedReignId = reignId || document.getElementById('reignFilterSelector').value;
    state.currentReignFilter = selectedReignId;
    
    let founders = getRoyalSurnameFounders(); // Get all founders

    // Filter founders based on selected Reign (Monarch's descendant)
    if (selectedReignId !== 'all') {
        const descendantIds = getMonarchDescendants(selectedReignId);
        // A founder is included if they are a descendant of the selected monarch OR if they *are* the monarch.
        // NOTE: A Monarch can also be a founder of a Royal Surname.
        founders = founders.filter(f => descendantIds.has(f.id) || f.id === selectedReignId);
    }

    // Update the Royal Surname Selector dropdown with the filtered list
    populateRoyalSurnameSelector(founders); 

    // Reset current root if the previous one is filtered out
    if (state.currentSurnameRootId && !founders.some(f => f.id === state.currentSurnameRootId)) {
        state.currentSurnameRootId = founders.length > 0 ? founders[0].id : null;
    } else if (!state.currentSurnameRootId && founders.length > 0) {
        state.currentSurnameRootId = founders[0].id;
    }
    
    saveState();
    renderTree(); // Re-render with the new root/filters
    updateSurnameHeader();
}

function changeViewMode(mode) {
    state.treeViewType = mode;
    const surnameSelector = document.getElementById('royalSurnameSelector');
    const surnameHeader = document.getElementById('surnameViewHeader');
    const reignFilterSelector = document.getElementById('reignFilterSelector');

    if (mode === 'royalSurname') {
        populateReignFilterSelector();
        reignFilterSelector.classList.remove('hidden');
        
        // This will now call changeRoyalSurnameFilter, which populates the surname selector
        changeRoyalSurnameFilter(state.currentReignFilter); 

        surnameSelector.classList.remove('hidden');
        surnameHeader.classList.remove('hidden');
        updateSurnameHeader();
    } else {
        surnameSelector.classList.add('hidden');
        surnameHeader.classList.add('hidden');
        reignFilterSelector.classList.add('hidden');
    }

    saveState();
    renderTree();
    resetView();
    showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: ${document.querySelector('#treeViewMode option[value="'+mode+'"]').text}`);
}

function findAbsoluteRoot(startId) {
    if(!startId) return null;
    let curr = state.members.find(m => m.id === startId);
    if(!curr) return null;
    let guard = 0;
    while((curr.fatherId || curr.motherId) && guard < 50) {
        let parent = null;
        if(curr.fatherId) parent = state.members.find(m => m.id === curr.fatherId);
        if(!parent && curr.motherId) parent = state.members.find(m => m.id === curr.motherId);
        
        if(parent) curr = parent;
        else break;
        guard++;
    }
    return curr.id;
}

function getDirectLineMembers(focusId) {
    const directIds = new Set();
    const spousesToAdd = new Set();
    
    let curr = state.members.find(m => m.id === focusId);
    while(curr) {
        directIds.add(curr.id);
        if(curr.spouseIds) curr.spouseIds.forEach(s => spousesToAdd.add(s));
        if(curr.fatherId) curr = state.members.find(m => m.id === curr.fatherId);
        else if(curr.motherId) curr = state.members.find(m => m.id === curr.motherId);
        else curr = null;
    }

    function addDescendants(pid) {
        const children = state.members.filter(m => m.fatherId === pid || m.motherId === pid);
        children.forEach(c => {
            directIds.add(c.id);
            if(c.spouseIds) c.spouseIds.forEach(s => spousesToAdd.add(s));
            addDescendants(c.id);
        });
    }
    addDescendants(focusId);

    spousesToAdd.forEach(s => directIds.add(s));
    return state.members.filter(m => directIds.has(m.id));
}

function getRoyalSurnameFounders() {
    // Note: Use isRoyalSurnameFounder flag to correctly identify the designated founder, 
    // even if other people have the same surname property (due to inheritance).
    return state.members.filter(m => m.isRoyalSurnameFounder && m.royalSurname && m.royalSurname.trim() !== '')
                        .sort((a, b) => a.royalSurname.localeCompare(b.royalSurname, 'th'));
}

// NEW HELPER: Find the founder ID of the royal surname a person belongs to.
function getSurnameFounderForPerson(id) {
    const p = state.members.find(m => m.id === id);
    if (!p || !p.royalSurname) return null;

    // Find the member who is designated as the founder and has the same royalSurname
    const founder = state.members.find(m => m.isRoyalSurnameFounder && m.royalSurname === p.royalSurname);
    
    // Fallback: If no designated founder found, but the person themselves is the founder, use them.
    if (p.isRoyalSurnameFounder && p.royalSurname && !founder) return p.id;
    
    return founder ? founder.id : null;
}
// END NEW HELPER

function getMonarchsByReign() {
    return state.members.filter(m => m.isMonarch && m.globalReignNumber)
                        .sort((a, b) => parseInt(a.globalReignNumber) - parseInt(b.globalReignNumber));
}

function getMonarchDescendants(monarchId) {
    const descendantIds = new Set();
    function traverse(id) {
        if (descendantIds.has(id)) return;
        descendantIds.add(id);
        state.members.filter(m => m.fatherId === id || m.motherId === id)
                     .forEach(c => traverse(c.id));
    }
    traverse(monarchId);
    return descendantIds;
}

function populateReignFilterSelector() {
    const sel = document.getElementById('reignFilterSelector');
    sel.innerHTML = '<option value="all">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•... (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>';
    
    const monarchs = getMonarchsByReign();
    monarchs.forEach(m => {
        const rNum = toThaiNumerals(m.globalReignNumber);
        const op = document.createElement('option');
        op.value = m.id; // Filter by the Monarch's ID
        op.innerText = `‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${rNum} (${m.name})`;
        if (m.id === state.currentReignFilter) op.selected = true;
        sel.appendChild(op);
    });
}

function populateRoyalSurnameSelector(founders) {
    const sel = document.getElementById('royalSurnameSelector');
    sel.innerHTML = '';
    
    if (founders.length === 0) {
        sel.innerHTML = '<option value="">(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</option>';
        return;
    }

    founders.forEach(f => {
        const op = document.createElement('option');
        op.value = f.id;
        op.innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.${f.royalSurname} (${f.name})`;
        if (f.id === state.currentSurnameRootId) op.selected = true;
        sel.appendChild(op);
    });
}

function updateSurnameHeader() {
    const founder = state.members.find(m => m.id === state.currentSurnameRootId);
    if (founder) {
        document.getElementById('surnameHeaderName').innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•.${founder.royalSurname}`;
    } else {
         document.getElementById('surnameHeaderName').innerText = `‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•. (‡πÑ‡∏°‡πà‡∏û‡∏ö)`;
    }
}

function getRoyalSurnameMembers(founderId) {
    const founder = state.members.find(m => m.id === founderId);
    if (!founder || !founder.royalSurname) return [];

    const lineageIds = new Set();
    const currentSurname = founder.royalSurname;
    
    // 1. Traverse descendants (including spouses)
    function addDescendants(id, currentSurnameRoot) {
        const p = state.members.find(m => m.id === id);
        if (!p) return;

        // Stop traversal if a descendant establishes a new surname (and it's not the current root)
        if (p.id !== founderId && p.isRoyalSurnameFounder && p.royalSurname && p.royalSurname !== currentSurnameRoot) {
             return;
        }
        
        if (lineageIds.has(id)) return;
        lineageIds.add(id);

        // Add spouses
        (p.spouseIds || []).forEach(sid => lineageIds.add(sid));

        // Recurse children
        state.members.filter(c => c.fatherId === id || c.motherId === id)
                     .forEach(c => addDescendants(c.id, currentSurnameRoot));
    }

    // 2. Traverse ancestors (and spouses) up to the founder
    function addAncestorsToFounder(id) {
        const p = state.members.find(m => m.id === id);
        if (!p || lineageIds.has(id)) return;
        
        lineageIds.add(id);
        // Add spouses
        (p.spouseIds || []).forEach(sid => lineageIds.add(sid));

        if (p.id === founderId) return; // Stop at the founder

        // Only trace direct, bloodline ancestors
        if (p.fatherId) addAncestorsToFounder(p.fatherId);
        if (p.motherId) addAncestorsToFounder(p.motherId);
    }

    // Start traversal from founder
    addDescendants(founderId, currentSurname);
    // Add ancestors up to the original founder (this implicitly includes the founder itself)
    addAncestorsToFounder(founderId);

    return state.members.filter(m => lineageIds.has(m.id));
}

function renderTree() {
    const focusId = state.viewRootId || (state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch)?.id) || (state.members[0]?.id);
    
    // Toggle surname controls visibility (for persistence on reload)
    const surnameSelector = document.getElementById('royalSurnameSelector');
    const surnameHeader = document.getElementById('surnameViewHeader');
    const reignFilterSelector = document.getElementById('reignFilterSelector');
    const isSurnameView = state.treeViewType === 'royalSurname';
    
    surnameSelector.classList.toggle('hidden', !isSurnameView);
    surnameHeader.classList.toggle('hidden', !isSurnameView);
    reignFilterSelector.classList.toggle('hidden', !isSurnameView);

    if(!focusId) { document.getElementById('empty-state').classList.remove('hidden'); return; }
    document.getElementById('empty-state').classList.add('hidden');

    const svgL = document.getElementById('links-layer');
    const svgN = document.getElementById('nodes-layer');
    svgL.innerHTML = ''; svgN.innerHTML = '';

    let renderRootId = focusId;
    let membersToRender = state.members;
    

    if (state.treeViewType === 'all' || state.treeViewType === 'all_v2') { 
    renderRootId = findAbsoluteRoot(focusId);
    membersToRender = state.members;
} else if (state.treeViewType === 'descendants') {
        renderRootId = focusId;
        membersToRender = state.members;
    } else if (state.treeViewType === 'direct') {
        renderRootId = findAbsoluteRoot(focusId);
        membersToRender = getDirectLineMembers(focusId);
    } else if (state.treeViewType === 'ancestors') {
        const layout = calculateAncestryLayout(focusId);
        // FIX: Use c.fromUUID and c.toUUID to find nodes based on layoutId
        layout.connections.forEach(c => {
            const f = layout.nodes.find(n => n.layoutId === c.fromUUID);
            const t = layout.nodes.find(n => n.layoutId === c.toUUID);
            // In Ancestor View, isSpouse is always false
            if(f && t) drawLink(f, t, false, svgL); 
        });
        layout.nodes.forEach(n => drawNode(n, svgN));
        return;
    } else if (isSurnameView) {
        // Handle Royal Surname View
        
        // This is necessary to ensure the selectors are correctly populated on direct load/rerender
        // if changeViewMode wasn't called (e.g., after focus change).
        if (!document.getElementById('reignFilterSelector').options.length > 1) {
             populateReignFilterSelector();
        }
        
        if (reignFilterSelector.value !== state.currentReignFilter || surnameSelector.options.length === 0) {
             changeRoyalSurnameFilter(state.currentReignFilter);
        }

        if (!state.currentSurnameRootId) {
             surnameHeader.classList.add('hidden');
             document.getElementById('empty-state').classList.remove('hidden');
             return;
        }
        updateSurnameHeader();
        
        membersToRender = getRoyalSurnameMembers(state.currentSurnameRootId);
        if (membersToRender.length === 0) {
            const founder = state.members.find(m => m.id === state.currentSurnameRootId);
            if (founder) membersToRender.push(founder);
        }
        
        if (membersToRender.length === 0) {
             document.getElementById('empty-state').classList.remove('hidden');
             return;
        }

        // Use the founder ID as the root for layout calculation
        renderRootId = state.currentSurnameRootId; 
    }


    const layout = calculateTreeLayout(renderRootId, membersToRender);
    
    layout.connections.forEach(c => {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Node ‡∏à‡∏≤‡∏Å layoutId (UUID) ‡πÅ‡∏ó‡∏ô ID ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        const f = layout.nodes.find(n => n.layoutId === c.fromUUID);
        const t = layout.nodes.find(n => n.layoutId === c.toUUID);
        if(f && t) drawLink(f, t, c.isSpouse, svgL);
    });
    layout.nodes.forEach(n => drawNode(n, svgN));
}

 function calculateAncestryLayout(rootId) {
    const nodes = [];
    const connections = [];
    
    // --- [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    const maxGen = 5; // ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏´‡∏£‡∏∑‡∏≠ 6 ‡∏£‡∏∏‡πà‡∏ô ‡∏ú‡∏±‡∏á‡∏à‡∏∞‡∏Å‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    
    const config = ANCESTOR_CONFIG;

    function getRelName(path) {
        if(path === "") return "‡∏ï‡∏ô‡πÄ‡∏≠‡∏á";
        const p = path.toLowerCase();
        if(p === "f") return "‡∏û‡πà‡∏≠";
        if(p === "m") return "‡πÅ‡∏°‡πà";
        if(p === "ff") return "‡∏õ‡∏π‡πà";
        if(p === "fm") return "‡∏¢‡πà‡∏≤";
        if(p === "mf") return "‡∏ï‡∏≤";
        if(p === "mm") return "‡∏¢‡∏≤‡∏¢";
        if(p.length >= 3) {
             const prefix = "‡∏ó‡∏ß‡∏î".repeat(p.length - 2); // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏ó‡∏ß‡∏î, ‡πÄ‡∏ó‡∏µ‡∏¢‡∏î, ‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
             return prefix;
        }
        return "";
    }

    function addAncestor(id, gen, path, spreadOffset, currentRange) {
        if (gen > maxGen) return;
        const p = state.members.find(m => m.id === id);
        if (!p) return;
        
        const ancestorLayoutId = `ancestor_${id}_${gen}_${path}`;
        let x, y;

        if(state.isHorizontal) {
            x = gen * (config.nodeWidth + config.gapX);
            y = spreadOffset;
        } else {
            x = spreadOffset;
            y = -(gen * (config.nodeHeight + config.gapY));
        }

        nodes.push({ data: p, x, y, type: 'ancestor', ancestorLabel: getRelName(path), layoutId: ancestorLayoutId });

        const nextRange = currentRange / 2;
        
        if (p.fatherId) {
            const fOffset = spreadOffset - nextRange;
            addAncestor(p.fatherId, gen + 1, path + "f", fOffset, nextRange);
            connections.push({ fromUUID: ancestorLayoutId, toUUID: `ancestor_${p.fatherId}_${gen + 1}_${path}f`, isSpouse: false });
        }
        
        if (p.motherId) {
            const mOffset = spreadOffset + nextRange;
            addAncestor(p.motherId, gen + 1, path + "m", mOffset, nextRange);
            connections.push({ fromUUID: ancestorLayoutId, toUUID: `ancestor_${p.motherId}_${gen + 1}_${path}m`, isSpouse: false });
        }
    }

    // --- [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Dynamic ---
    // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á + ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü
    const safeSpace = state.isHorizontal ? (config.nodeHeight + 50) : (config.nodeWidth + 80);
    
    // ‡∏™‡∏π‡∏ï‡∏£: 2^(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô - 1) * ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    const initialRange = Math.pow(2, maxGen - 1) * safeSpace;
    
    addAncestor(rootId, 0, "", 0, initialRange);
    
    return { nodes, connections };
}
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏Ç‡∏ß‡πâ]
  function calculateTreeLayout(rootId, memberList) {
        if(!rootId) return { nodes:[], connections:[] };
        
        // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ "‡∏Å‡∏•‡πà‡∏≠‡∏á" ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const uuid = () => 'layout_' + Math.random().toString(36).substr(2, 9);
        
        // Priority 1: Use Birth Year for children sorting (oldest first)
        const childSortFn = (a, b) => {
            const aYear = parseInt(a.birthYear) || Infinity;
            const bYear = parseInt(b.birthYear) || Infinity;
            if (aYear !== bYear) return aYear - bYear;
            return a.id.localeCompare(b.id); 
        };
        
        const config = state.isHorizontal ? {...BASE_CONFIG, gapX: 40, gapY: 250} : BASE_CONFIG;
        const nodes = []; 
        const connections = []; 

        function build(pid, level) {
            const p = getP(pid);
            if(!p) return { width: config.nodeWidth, nodes: [] };

            const myLayoutId = uuid();

            let spouses = (p.spouseIds || []).map(id => getP(id)).filter(s => s);
            
            // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏∏‡∏ï‡∏£‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î All View (v2) ---
            const children = memberList.filter(m => {
                const isChild = m.fatherId === pid || m.motherId === pid;
                if (!isChild) return false;

                // ‡∏Å‡∏é‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î All View (v2): ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏ç‡∏≤‡∏ï‡∏¥
                if (state.treeViewType === 'all_v2') {
                    // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏°‡πà" (F) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ "‡∏û‡πà‡∏≠" ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ú‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
                    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                    if (p.gender === 'F' && m.fatherId && memberList.some(x => x.id === m.fatherId)) {
                        return false;
                    }
                }
                return true;
            }).sort(childSortFn); 
            // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

            const groups = [];
            spouses.forEach(s => {
                const kids = children.filter(c => c.fatherId === s.id || c.motherId === s.id);
                groups.push({ spouse: s, children: kids });
            });

            const accountedChildrenIds = new Set(groups.flatMap(g => g.children.map(c => c.id)));
            const loneChildren = children.filter(c => !accountedChildrenIds.has(c.id));
            if (loneChildren.length > 0) { groups.push({ spouse: null, children: loneChildren }); }
            
            if (groups.length === 0) { 
                return { 
                    width: config.nodeWidth, 
                    nodes: [{ data: p, x: 0, y: 0, type: 'root', layoutId: myLayoutId }] 
                }; 
            }

            let totalSubtreeWidth = 0;
            const groupLayouts = groups.map(g => {
                let childrenBlockWidth = 0;
                const childResults = [];
                if (g.children.length > 0) {
                    g.children.forEach(child => {
                        const res = build(child.id, level + 1);
                        const childRootNode = res.nodes.find(n => n.type === 'root' && n.data.id === child.id); 
                        childResults.push({ ...res, childRootLayoutId: childRootNode ? childRootNode.layoutId : null });
                        childrenBlockWidth += res.width + config.gapX;
                    });
                    childrenBlockWidth -= config.gapX; 
                }
                const groupWidth = Math.max(g.spouse ? config.nodeWidth : 0, childrenBlockWidth);
                return { group: g, width: groupWidth, childResults };
            });

            totalSubtreeWidth = groupLayouts.reduce((acc, gl) => acc + gl.width + config.spouseGap, 0);
            if (groupLayouts.length > 0) totalSubtreeWidth -= config.spouseGap;
            totalSubtreeWidth = Math.max(totalSubtreeWidth, config.nodeWidth); 

            const localNodes = [];
            const rootX = totalSubtreeWidth / 2 - config.nodeWidth / 2;
            
            localNodes.push({ data: p, x: rootX, y: 0, type: 'root', layoutId: myLayoutId });

            let currentX = 0;
            groupLayouts.forEach(gl => {
                const g = gl.group;
                const groupCenterX = currentX + gl.width / 2;
                
                if (g.spouse) {
                    const spouseX = groupCenterX - config.nodeWidth / 2;
                    const spouseLayoutId = uuid(); 

                    localNodes.push({ 
                        data: g.spouse, 
                        x: spouseX, 
                        y: config.gapY, 
                        type: 'spouse', 
                        partnerId: pid,
                        layoutId: spouseLayoutId 
                    });

                    connections.push({ fromUUID: myLayoutId, toUUID: spouseLayoutId, isSpouse: true });
                    
                    let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                    if (gl.childResults.length === 0) childX = currentX; 

                    gl.childResults.forEach(res => {
                        res.nodes.forEach(n => {
                            localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                        });
                        
                        if (res.childRootLayoutId) { 
                            connections.push({ fromUUID: spouseLayoutId, toUUID: res.childRootLayoutId, isSpouse: false }); 
                        } 
                        childX += res.width + config.gapX;
                    });

                } else {
                    let childX = currentX + (gl.width - (gl.childResults.reduce((a,c)=>a+c.width+config.gapX,0) - config.gapX))/2;
                    gl.childResults.forEach(res => {
                        res.nodes.forEach(n => {
                            localNodes.push({ ...n, x: n.x + childX, y: n.y + config.gapY * 2 });
                        });
                        
                        if (res.childRootLayoutId) { 
                            connections.push({ fromUUID: myLayoutId, toUUID: res.childRootLayoutId, isSpouse: false }); 
                        }
                        childX += res.width + config.gapX;
                    });
                }
                currentX += gl.width + config.spouseGap;
            });
            return { width: totalSubtreeWidth, nodes: localNodes };
        }
        
        const getP = (id) => memberList.find(m => m.id === id);
        const treeData = build(rootId, 0);
        return { nodes: treeData.nodes, connections };
    }

    // ================= DRAWING =================
    function drawNode(node, container) {
        let config = BASE_CONFIG;
        if (state.treeViewType === 'ancestors') config = ANCESTOR_CONFIG;
        else if (state.isHorizontal) config = {...BASE_CONFIG, gapX: 40, gapY: 250};

        let x = node.x, y = node.y;
        
        // MODIFICATION: Only apply coordinate swap for NON-ANCESTOR view
        if (state.isHorizontal && state.treeViewType !== 'ancestors') { x = node.y; y = node.x; }

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${x},${y})`);
        g.style.cursor = "pointer";
        g.onclick = (e) => { e.stopPropagation(); showDetail(node.data.id); };
        
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("width", config.nodeWidth); fo.setAttribute("height", config.nodeHeight);
        
        const p = node.data;
        const isDead = !p.isAlive;
        const isExMonarchAlive = p.isMonarch && p.isExMonarch && p.isAlive; // NEW: Ex-Monarch
        const deathTerm = isDead ? getDeathTerm(p) : "";
        let borderClass = p.gender === 'M' ? "border-male" : "border-female";
        // MODIFICATION: Check isMonarch: true to apply King/Queen border
        if(p.isMonarch) borderClass = "border-king"; 
        else if(p.isQueenConsort) borderClass = "border-queen";
        
        let imgClass = "";
        if(isDead) {
            // Note: The isMonarch flag is now intentionally kept true even if the King is deceased, 
            // per user request. We rely on isAlive for the display of death status.
            if(p.isMonarch) { borderClass = "border-dead-royal"; imgClass = "img-grayscale"; } 
            else { borderClass = "border-dead"; imgClass = "img-grayscale"; }
        } else if (isExMonarchAlive) { 
             // NEW: Apply King death border but keep image color
             borderClass = "border-dead-royal"; 
             imgClass = "img-normal"; 
        }
        
        const treeName = getTreeNodeName(p); 
        const showCrown = (p.isMonarch || p.isQueenConsort);
        
        const isFlash = state.highlightIds.includes(p.id);
        const flashClass = isFlash ? "node-flash" : "";
        
        let badgeHTML = "";
        if (state.treeViewType === 'ancestors' && node.ancestorLabel) {
            badgeHTML += `<div class="ancestor-label">${node.ancestorLabel}</div>`;
        }
        
        if (p.isMonarch && p.useReignName && p.reignNameBase && !p.isExMonarch) { // Only show reign name badge for active monarch
            let reignTxt = p.reignNameBase;
            const autoNum = getReignNameRank(p);
            if(autoNum) reignTxt += `‡∏ó‡∏µ‡πà ${toThaiNumerals(autoNum)}`;
            if(p.globalReignNumber) reignTxt += ` (‡∏£.${toThaiNumerals(p.globalReignNumber)})`;
            badgeHTML += `<div class="badge-monarch truncate w-full text-center mt-1">${reignTxt}</div>`;
        } else if (p.isExMonarch && p.isAlive) { // NEW: Show Ex-Monarch badge
            const reignNum = p.globalReignNumber ? `‡∏£. ${toThaiNumerals(p.globalReignNumber)}` : '';
            badgeHTML += `<div class="badge-krom bg-purple-100 text-purple-700 border-purple-300 truncate w-full text-center mt-1">‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignNum}</div>`;
        } else if (p.isHeir) {
             badgeHTML += `<div class="badge-heir truncate w-full text-center mt-1">‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${toThaiNumerals(p.heirOrder)}</div>`;
        } else if (!p.isMonarch && p.kromRank) {
            // NOTE: Krom Rank is kept in node badge, but removed from full name display (per request)
            badgeHTML += `<div class="badge-krom truncate w-full text-center mt-1">${p.kromRank}${p.kromTitle||''}</div>`;
            
        }
        
        // --- MODIFICATION FOR RULE 2: Royal Surname Badge (Removed from Node) ---
        // Per user request, the Royal Surname badge is REMOVED from the node to fulfill: 
        // "‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ú‡∏±‡∏á(‡∏ó‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢)"
        // --- END MODIFICATION ---

        const div = document.createElement("div");
        div.className = `node-box ${borderClass} ${flashClass} ${state.viewRootId === p.id ? 'focused' : ''}`;
        div.innerHTML = `
            <div class="relative mb-1">
                <img src="${p.image || (p.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full border border-white shadow-sm object-cover bg-slate-100 ${imgClass}">
                ${showCrown ? `<i class="fa-solid fa-crown absolute -top-1 -right-1 text-xs ${p.isAlive && !p.isExMonarch ?'text-yellow-500':'text-slate-600'} bg-white rounded-full p-0.5 shadow-sm"></i>` : ''}
            </div>
            <div class="text-[11px] font-bold text-center leading-tight truncate w-full px-1 ${p.isMonarch?'text-amber-700':'text-slate-700'}">${treeName}</div>
            ${badgeHTML}
            ${isDead ? `<div class="absolute top-1 left-1 text-[8px] bg-slate-800 text-white px-1.5 py-0.5 rounded shadow-sm opacity-90">${deathTerm}</div>` : ''}
        `;
        fo.appendChild(div); g.appendChild(fo); container.appendChild(g);
    }

    function drawLink(n1, n2, isSpouse, container) {
        let config = BASE_CONFIG;
        if (state.treeViewType === 'ancestors') config = ANCESTOR_CONFIG;
        else if (state.isHorizontal) config = {...BASE_CONFIG, gapX: 40, gapY: 250};

        const getC = (n, type) => {
            let nx = n.x, ny = n.y;
            
            // Fix: In ancestor view, use raw calculated coordinates (no swap)
            if (state.treeViewType !== 'ancestors' && state.isHorizontal) { nx = n.y; ny = n.x; }

            if (state.treeViewType === 'ancestors') {
                 // For ancestor view, we determine connection points based on state.isHorizontal
                if (state.isHorizontal) { // Horizontal Ancestor Layout (Parent right of child)
                    // n1 (child) connects from right side, n2 (parent) connects to left side
                    if (type === 'from') return { x: nx + config.nodeWidth, y: ny + config.nodeHeight/2 }; // Right side
                    if (type === 'to') return { x: nx, y: ny + config.nodeHeight/2 }; // Left side
                } else { // Vertical Ancestor Layout (Parent above child)
                    // n1 (child) connects from top side, n2 (parent) connects to bottom side
                    if (type === 'from') return { x: nx + config.nodeWidth/2, y: ny }; // Top side
                    if (type === 'to') return { x: nx + config.nodeWidth/2, y: ny + config.nodeHeight }; // Bottom side
                }
            } else {
                 // Standard Tree View (Parent top, Child bottom)
                 if (state.isHorizontal) {
                    if(type==='bottom') return {x: nx+config.nodeWidth, y: ny+config.nodeHeight/2}; 
                    if(type==='top') return {x: nx, y: ny+config.nodeHeight/2}; 
                 } else {
                    if(type==='bottom') return {x: nx+config.nodeWidth/2, y: ny+config.nodeHeight};
                    if(type==='top') return {x: nx+config.nodeWidth/2, y: ny};
                 }
            }
            return {x: nx, y: ny};
        };

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        // Updated: Use different class for spouse and child connections for themed coloring
        path.setAttribute("class", `connector ${isSpouse ? 'connector-spouse' : 'connector-child'}`);
        
        if (state.highlightIds.includes(n1.data.id) && state.highlightIds.includes(n2.data.id)) {
            path.style.stroke = "#ef4444";
            path.style.strokeWidth = "3px";
            path.style.strokeDasharray = "5,5";
        }

        let p1, p2, d;
        
        if (state.treeViewType === 'ancestors') {
            p1 = getC(n1, 'from'); // Child (Lower Generation)
            p2 = getC(n2, 'to');   // Parent (Higher Generation)
            
            if (state.isHorizontal) {
                // Horizontal Ancestor Layout: Left-to-Right curve
                const midX = (p1.x + p2.x)/2;
                d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`;
            } else {
                 // Vertical Ancestor Layout: Bottom-to-Top curve
                const midY = (p1.y + p2.y)/2;
                d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`;
            }
            
        } else {
            if(isSpouse) {
                p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
                if(state.isHorizontal) { 
                    const midX = (p1.x + p2.x)/2; 
                    d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; 
                } else { 
                    const midY = (p1.y + p2.y)/2; 
                    d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; 
                }
                
                // Draw heart icon for spouse connection
                const mx = (p1.x + p2.x)/2; const my = (p1.y + p2.y)/2;
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("class", "heart-icon"); txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle"); txt.textContent = "‚ù§";
                txt.setAttribute("x", mx); txt.setAttribute("y", my);
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", mx); circle.setAttribute("cy", my); circle.setAttribute("r", 8); circle.setAttribute("fill", "#fff");
                container.appendChild(circle); container.appendChild(txt);
            } else {
                p1 = getC(n1, 'bottom'); p2 = getC(n2, 'top');
                if(state.isHorizontal) { 
                    const midX = (p1.x + p2.x)/2; 
                    d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`; 
                } else { 
                    const midY = (p1.y + p2.y)/2; 
                    d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`; 
                }
            }
        }
        path.setAttribute("d", d); container.appendChild(path);
    }

    // ================= UTILS & HELPERS =================
    function toThaiNumerals(num) {
        if(num === null || num === undefined) return '';
        const thai = ['‡πê','‡πë','‡πí','‡πì','‡πî','‡πï','‡πñ','‡πó','‡πò','‡πô'];
        return num.toString().split('').map(d => thai[d]||d).join('');
    }
    function getReignNameRank(p) {
        if(!p.isMonarch || !p.useReignName || !p.reignNameBase) return null;
        const sameName = state.members
            .filter(m => m.isMonarch && m.useReignName && m.reignNameBase === p.reignNameBase)
            .sort((a,b) => (parseInt(a.reignStart)||0) - (parseInt(b.reignStart)||0) || a.id.localeCompare(b.id));
        return sameName.findIndex(m => m.id === p.id) + 1;
    }
    function getDisplayRank(rank) {
        if(!rank) return '';
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
            return rank.split(' ')[0]; 
        }
        return rank;
    }
    
    function isCommonerDescendant(p) {
        if (!p.royalRank) return true;
        return p.royalRank.includes('‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') || p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') || p.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á');
    }

    /**
     * UPDATED LOGIC: Implements all name display rules as requested, including surname.
     */
    /**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏é‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ "‡∏ì"
 */
function getFullDisplayTitle(p) {
    if (!p) return "";

    // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ô‡πâ‡∏ô‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô)
    if (p.isMonarch && p.isAlive && !p.isExMonarch) {
        let mainTitle = (p.titlePrefix || "") + p.name + (p.titleSuffix || "");
        let reignPart = "";
        if (p.useReignName && p.reignNameBase) {
            reignPart = p.reignNameBase;
            const autoNum = getReignNameRank(p);
            if (autoNum) reignPart += "‡∏ó‡∏µ‡πà " + toThaiNumerals(autoNum);
        }
        return (mainTitle + (reignPart ? " " + reignPart : "")).trim();
    }

    let finalNameParts = [];
    
    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞, ‡∏ô‡∏≤‡∏¢, ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á)
    if (p.titlePrefix) {
        finalNameParts.push(p.titlePrefix);
    }

    /// 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏¢‡∏®" ‡πÅ‡∏•‡∏∞ "‡∏ä‡∏∑‡πà‡∏≠" (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤)
    let displayName = p.name || "";
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
    if (!p.hideRoyalRank && p.royalRank && p.royalRank !== '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && !p.isMonarch) {
        // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏® ‡πÄ‡∏ä‡πà‡∏ô "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" (‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏≠‡∏≠‡∏Å)
        const simpleRank = p.royalRank.split(' ')[0]; 
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (Prefix) ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏®‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥
        // ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πâ‡∏≤ Prefix ‡∏Ñ‡∏∑‡∏≠ "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á" ‡πÅ‡∏•‡∏∞ Rank ‡∏Ñ‡∏∑‡∏≠ "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á" ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥
        if (!p.titlePrefix.includes(simpleRank)) {
            displayName = simpleRank + displayName;
        }
    }
    
    
    finalNameParts.push(displayName);

    // 4. ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ "‡∏ì {‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£}" (‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà)
    if (!p.hideSurname) {
        const isRoyalLineageSurname = !!p.royalSurname && p.royalSurname.trim() !== '';
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏°.‡∏à., ‡∏°.‡∏£.‡∏ß. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°.‡∏•. ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isMRWMLPrefix = ['‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå', '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'].includes(p.titlePrefix);
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ô‡∏≤‡∏¢, ‡∏ô‡∏≤‡∏á, ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß, ‡∏Ñ‡∏∏‡∏ì ‡∏Ø‡∏•‡∏Ø)
        const isCommonerPrefix = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡∏Ñ‡∏∏‡∏ì', '‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ç‡∏¥‡∏á', '‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á'].includes(p.titlePrefix);

        if (isRoyalLineageSurname) {
            if (isMRWMLPrefix) {
                // ‡∏Å‡∏é: ‡∏°.‡∏à. / ‡∏°.‡∏£.‡∏ß. / ‡∏°.‡∏•. ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏ì)
                finalNameParts.push(p.royalSurname);
            } 
            else if (isCommonerPrefix || p.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
                // ‡∏Å‡∏é: ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á ‡∏°.‡∏£.‡∏ß./‡∏°.‡∏•. ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [‡∏ô‡∏≤‡∏°‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏•] [‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ] ‡∏ì [‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ] [‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£]
                finalNameParts.push(`${p.royalSurname} ‡∏ì ${state.kingdomName}`);
            }
        } 
        else if (p.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && p.surname) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏ì)
            finalNameParts.push(p.surname);
        }
    }

    // 5. ‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (p.titleSuffix) {
        finalNameParts.push(p.titleSuffix);
    }

    // 6. ‡∏¢‡∏®‡∏Å‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1)
    const isHighRoyalTitle = p.isMonarch || (p.isHeir && parseInt(p.heirOrder) === 1);
    if (p.kromRank && !isHighRoyalTitle) {
        finalNameParts.push(p.kromRank + (p.kromTitle || ""));
    }

    // 7. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà...)
    if (p.monarchSpouseContext) {
        finalNameParts.push(p.monarchSpouseContext);
    }

    // 8. ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå (‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥)
    if (p.isMonarch && p.isExMonarch && p.isAlive) {
        const reignLabel = p.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.globalReignNumber)}` : '';
        finalNameParts.push(`‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå${reignLabel}`);
    }

    // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ 1 ‡πÄ‡∏Ñ‡∏≤‡∏∞ ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏)
    return finalNameParts.join(" ").trim();
}

    function getNicknameWithPrefix(p) {
        if(!p.nickname) return '-';
        let prefix = '';
        const r = p.royalRank || '';
        if(r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)')) prefix = '‡∏ó‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≠‡∏°';
        else if(r.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) prefix = '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à'; 
        else if(r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)') || r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)') || r.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)')) prefix = '‡πÄ‡∏™‡∏î‡πá‡∏à';
        else if(r.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) prefix = p.gender === 'M' ? '‡∏ó‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢' : '‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏ç‡∏¥‡∏á';
        return prefix + p.nickname;
    }

    /**
     * Retrieves the name displayed inside the tree node box.
     * Per user request, M.R.W. and M.L. (and high royal prefixes) are NOT shown here, only the name.
     */
    function getTreeNodeName(p) { 
        // Per user request: Do not show M.R.W. or M.L. or any other rank/prefix in the tree node itself.
        // It should only show the name. The full rank is available in the popup.
        return p.name || "-"; 
    }
    
    function getGlobalReignLabel(p) {
        if(p.globalReignNumber) return `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(p.globalReignNumber)}`;
        return '';
    }
    function getDeathTerm(p) {
        if(p.hasUmbrella) {
            if(p.umbrellaType.includes('‡∏ô‡∏û‡∏î‡∏•') || p.umbrellaType.includes('‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•')) return "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï";
            if(p.umbrellaType.includes('‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•')) return "‡∏ó‡∏¥‡∏ß‡∏á‡∏Ñ‡∏ï"; 
        }
        // MODIFICATION: Use p.isMonarch (historical) instead of p.isMonarch || p.isQueenConsort || p.isExMonarch
        if(p.isMonarch || p.isQueenConsort) return "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï"; 
        const rank = p.royalRank || '';
        if((p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) return "‡∏≠‡∏™‡∏±‡∏ç‡∏Å‡∏£‡∏£‡∏°";
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) return "‡∏ó‡∏¥‡∏ß‡∏á‡∏Ñ‡∏ï";
        if(rank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) return "‡∏™‡∏¥‡πâ‡∏ô‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå";
        if(rank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) return "‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏µ‡∏û‡∏¥‡∏ï‡∏±‡∏Å‡∏©‡∏±‡∏¢";
        if(rank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä')) return "‡∏û‡∏¥‡∏•‡∏≤‡∏•‡∏±‡∏¢";
        return "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï";
    }
    function generateRoyalId(gender, rankName) {
        const d1 = gender === 'M' ? '1' : '2';
        const d2 = RANK_CODES[rankName] || 'A';
        const d3 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
        const d4 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*26));
        return `${d1}${d2}${d3}${d4}${Math.floor(Math.random()*1000000)}`;
    }
    function updateAutoId() {
        try {
            if (document.getElementById('p_isEditMode').value === 'true') return;
            const gEl = document.querySelector('input[name="gender"]:checked');
            const gender = gEl ? gEl.value : 'M';
            const rank = document.getElementById('p_royalRank').value || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            document.getElementById('p_id').value = generateRoyalId(gender, rank);
        } catch(e) { }
    }

    // New: Function to check and update consort prefix
    function checkConsortMotherhood(person) {
        if (person.gender !== 'F') return person;

        const rel = person.relationship || '';
        let prefix = person.titlePrefix || '';
        
        // 1. Check if the person is a royal consort (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤)
        if (rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
            
            // 2. Check if the current prefix is ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°, ‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°, ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤, or ‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤
            if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤' || prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') {
                
                // 3. Check for children (motherId matches this person)
                const hasChildren = state.members.some(m => m.motherId === person.id);
                
                if (hasChildren) {
                    if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°') {
                        person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤';
                        showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${person.name} ‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤`);
                    } else if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°') {
                        person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤';
                        showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${person.name} ‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤`);
                    }
                } else {
                    // Ensure correct default if no children (demote if needed)
                    if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') {
                         person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°';
                    } else if (prefix === '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤') {
                         person.titlePrefix = '‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°';
                    }
                }
            }
        }
        return person;
    }

    /**
     * Calculates the appropriate default Royal Rank and Title Prefix for a child
     * of the current reigning monarch, based on the mother's status/lineage.
     */
    function calculateChildRank(fatherId, motherId, gender) {
        const defaultRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
        const defaultRel = gender === 'M' ? '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™' : '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤';
        
        const monarchParent = state.members.find(m => m.id === fatherId);
        const otherParent = state.members.find(m => m.id === motherId);

        // NEW: Determine Royal Surname for the child
        let royalSurname = '';
        if (monarchParent) {
            // Royal children inherit the Royal Surname from the bloodline (Monarch or other parent)
            royalSurname = monarchParent.royalSurname || otherParent?.royalSurname || monarchParent.surname || otherParent?.surname || ''; 
        }

        // If Monarch parent is not the current Monarch (or not found/invalid), use fallback
        if (!monarchParent || !monarchParent.isMonarch) {
            return { royalRank: defaultRank, titlePrefix: '', relationship: defaultRel, royalSurname, surname: '' };
        }

        // --- Rule 3: Mother is Royal Consort (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤/‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤) ---
        if (otherParent && (otherParent.relationship || '').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
            const prefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
            return { royalRank: '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)', titlePrefix: prefix, relationship: defaultRel, royalSurname, surname: '' };
        }

        // --- Other Parent must be a royal bloodline for higher rank (not a commoner wife) ---
        if (!otherParent || (otherParent.royalRank || '').includes('‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô')) {
            const prefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
            return { royalRank: defaultRank, titlePrefix: prefix, relationship: defaultRel, royalSurname, surname: '' };
        }

        // --- Lineage Check (Other Parent is Royal) ---
        let motherRankLevel = 0; // 1 = Daughter of King, 2 = Grandchild/Further of King
        
        let mFather = state.members.find(m => m.id === otherParent.fatherId);
        let mMother = state.members.find(m => m.id === otherParent.motherId);
        
        if ((mFather?.isMonarch && mFather.id !== monarchParent.id) || (mMother?.isMonarch && mMother.id !== monarchParent.id)) {
            motherRankLevel = 1;
        }

        if (motherRankLevel === 0) {
            const grandparents = [mFather, mMother].filter(p => p);
            let isGrandchildOfMonarch = false;
            
            for (const gp of grandparents) {
                const ggf = state.members.find(m => m.id === gp.fatherId);
                const ggm = state.members.find(m => m.id === gp.motherId);
                
                if ((ggf?.isMonarch && ggf.id !== monarchParent.id) || (ggm?.isMonarch && ggm.id !== monarchParent.id)) {
                    isGrandchildOfMonarch = true;
                    break;
                }
            }

            if (isGrandchildOfMonarch) {
                motherRankLevel = 2; 
            }
        }


        // --- Apply Rank based on Mother's Lineage ---
        let royalRank = defaultRank;
        let titlePrefix;
        
        if (motherRankLevel === 1) {
            royalRank = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
            titlePrefix = gender === 'M' ? '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        } else if (motherRankLevel === 2) {
            royalRank = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)';
            titlePrefix = gender === 'M' ? '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        } else if (otherParent.royalRank && (otherParent.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || otherParent.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤'))) {
            royalRank = '‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
            titlePrefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        } else {
             titlePrefix = gender === 'M' ? '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠';
        }

        return { royalRank, titlePrefix, relationship: defaultRel, royalSurname, surname: '' };
    }


    /**
     * Calculates the appropriate Royal Rank, Title Prefix, and Surname for a child
     * who is NOT a direct child of the current reigning monarch.
     * Implements rules for commoner marriage and MR/ML generation.
     */
    function calculateChildRankGeneric(fatherId, motherId, gender) {
        const defaultCommonerRank = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        const defaultCommonerRel = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
        
        const father = state.members.find(m => m.id === fatherId);
        const mother = state.members.find(m => m.id === motherId);
        
        // Default to commoner status
        let royalRank = defaultCommonerRank;
        let titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
        let relationship = defaultCommonerRel;
        let royalSurname = '';
        let surname = '';

        // --- 1. Check for Royal Male Bloodline (Father is Royal) ---
        if (father && !isCommonerDescendant(father)) {
            const fatherRank = father.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            // Royal descent: Inherit the Royal Surname from Father
            royalSurname = father.royalSurname || father.surname || '';
            surname = ''; // Clear explicit commoner surname on auto rank, reliance is on royalSurname
            
            // A. Father is '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤'
            if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤')) {
                royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå';
                titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå'; 
                relationship = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            } 
            // B. Father is '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' (NEW RULE: MRW -> ML)
            else if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå')) {
                royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á';
                titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á'; 
                relationship = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            } 
            // C. Father is a higher-rank Prince (Chao Fa/Phra Ong Chao) but NOT the King
            else if (fatherRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || fatherRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤')) {
                 // Children of Princes/Princesses (not the King) get ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ rank
                royalRank = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤';
                relationship = '‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå';
            } 
             // D. Father is ‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á or lower (Child is commoner)
            else if (fatherRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') || isCommonerDescendant(father)) {
                royalRank = defaultCommonerRank;
                titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
                relationship = defaultCommonerRel;
            }
        }
        
        // --- 2. Check for Royal Female Bloodline + Commoner Male (Rule: Child is Commoner) ---
        else if ((!father || isCommonerDescendant(father))) {
            if (mother && !isCommonerDescendant(mother)) {
                
                // Rule: If high-rank royal female marries commoner, child is commoner.
                // Exception: "‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏´‡∏ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö1" -> This function is for non-Monarch children.
                royalRank = defaultCommonerRank;
                titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
                relationship = defaultCommonerRel;
                
                // Child inherits the royal surname lineage from the mother (if any), but is still a commoner.
                royalSurname = mother.royalSurname || '';
                surname = ''; // Clear explicit commoner surname
                
                showToast(`‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${mother.name} (${mother.royalRank}) ‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô, ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô`);
            }
        }

        // Final check on title prefix for commoners (in case of manual override or fallback)
        if (royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
            if (!titlePrefix || titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') {
                 titlePrefix = gender === 'M' ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß';
            }
        } else if (royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') || royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á')) {
            // Ensure titlePrefix matches rank for M.R.W./M.L.
             titlePrefix = royalRank.split(' ')[0];
        }

        return { royalRank, titlePrefix, relationship, royalSurname, surname };
    }

    // Helper to check if someone is a direct descendant of the Monarch (child or grandchild)
    function isDirectDescendant(ancestorId, descendantId) {
        const d = state.members.find(m => m.id === descendantId);
        if (!d) return { isChild: false, isGrandchild: false };
        
        // Check Child
        const isChild = (d.fatherId === ancestorId || d.motherId === ancestorId);
        if (isChild) return { isChild: true, isGrandchild: false };

        // Check Grandchild (Child of the Monarch's child)
        const father = state.members.find(m => m.id === d.fatherId);
        const mother = state.members.find(m => m.id === d.motherId);
        
        const isGrandchild = (father && (father.fatherId === ancestorId || father.motherId === ancestorId)) ||
                             (mother && (mother.fatherId === ancestorId || mother.motherId === ancestorId));
        
        return { isChild: false, isGrandchild: isGrandchild };
    }

    // ================= NEW SURNAME FIELD LOGIC =================
    
    function toggleSurnameFields() {
        const isFounder = document.getElementById('p_isSurnameFounder').checked;
        const rank = document.getElementById('p_royalRank').value;
        const isCommonerRank = rank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';

        document.getElementById('royalSurnameFounderPanel').classList.toggle('hidden', !isFounder);
        
        // Commoner surname input appears only if rank is commoner AND they are NOT a founder
        document.getElementById('commonerSurnamePanel').classList.toggle('hidden', !isCommonerRank || isFounder);
    }
    
    // ================= PRECEDENCE LOGIC (‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏° Micro Scale) =================

    // ============================================================
// THE SUPREME POJIAM LOGIC 2025 (Unified Version)
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏£‡∏ß‡∏°‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå, ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó, ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á
// ============================================================
function calculatePojiamScore(person) {
    if (!person) return 0;



    // --- 1. ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô (Exclusion): ‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡πÄ‡∏à‡∏µ‡∏¢‡∏° ---
    if (!person.isQueenConsort) {
        if ((person.relationship || '').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || person.relationship === '‡∏´‡∏°‡πà‡∏≠‡∏°') {
            return 0; 
        }
        if (person.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || person.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå' || person.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á') {
            return 0;
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
    
    // --- 2. ZONE A: ‡∏ä‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (8,000 - 10,000) ---
    
    // ‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
    if (person.isMonarch) {
        if (person.isAlive && !person.isExMonarch) return 10000; // ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        if (person.isExMonarch && person.isAlive) return 9780;   // ‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡πå)
        if (!person.isAlive) return 9900 + (parseInt(person.globalReignNumber) || 0); // ‡∏ö‡∏π‡∏£‡∏û‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡∏≤‡∏ò‡∏¥‡∏£‡∏≤‡∏ä
    }

    // ‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ (Queen Consort)
    if (person.isQueenConsort) {
        const isCurrentSpouse = activeMonarch && (activeMonarch.spouseIds || []).includes(person.id);
        if (isCurrentSpouse) return 9800; // ‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ/‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        return 9500; // ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô
    }

    // ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
    const heirOrder = parseInt(person.heirOrder) || 999;
    if (person.isHeir && heirOrder === 1) return 8000;

    

    // --- 3. ZONE B: ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏°‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£) ---
    let score = 0;

    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏¢‡∏® (Royal Rank)
    const rankScoreMap = {
        "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 700, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 600, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 500,
        "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 400, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 300, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 250,
        "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 200
    };
    score += rankScoreMap[person.royalRank] || 0;

    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" (‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Engine ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á)
    if (person.relationship?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™") || person.relationship?.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤")) {
        score += 50; // ‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
    } else if (person.titlePrefix?.includes("‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå")) {
        score += 40; // ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤
    } else if (person.titlePrefix?.includes("‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå")) {
        score += 30; // ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á
    }

    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®)
    if (state.prefixScores && person.titlePrefix && state.prefixScores[person.titlePrefix]) {
        score += parseInt(state.prefixScores[person.titlePrefix]);
    }
    if (state.suffixScores && person.titleSuffix && state.suffixScores[person.titleSuffix]) {
        score += parseInt(state.suffixScores[person.titleSuffix]);
    }

    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏®‡∏Å‡∏£‡∏° (Krom Rank)
    const kromScoreMap = { 
        "‡∏Å‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞": 50, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞‡∏¢‡∏≤": 40, "‡∏Å‡∏£‡∏°‡∏û‡∏£‡∏∞": 30, 
        "‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏ß‡∏á": 20, "‡∏Å‡∏£‡∏°‡∏Ç‡∏∏‡∏ô": 10, "‡∏Å‡∏£‡∏°‡∏´‡∏°‡∏∑‡πà‡∏ô": 5 
    };
    score += kromScoreMap[person.kromRank] || 0;
    
    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏â‡∏±‡∏ï‡∏£ (Umbrella)
    if (person.hasUmbrella) {
        if (person.umbrellaType.includes("‡∏ô‡∏û‡∏î‡∏•")) score += 9;
        else if (person.umbrellaType.includes("‡∏™‡∏±‡∏õ‡∏ï‡∏î‡∏•")) score += 7;
        else if (person.umbrellaType.includes("‡πÄ‡∏ö‡∏ç‡∏à‡∏î‡∏•")) score += 5;
    }

    // ‡∏Å‡∏é Seniority (Tie-breaker): ‡πÉ‡∏Ñ‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô (ID ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤) ‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    let seniorityScore = parseInt(person.id.substring(person.id.length - 6)) / 1000000;
    score -= seniorityScore;

    return score;
}

    function movePrecedence(id, direction) {
        showToast("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ");
    }

    function resetPrecedence() {
        state.members.forEach(m => delete m.customPrecedence);
        saveState();
        renderTable();
        showToast("‡∏£‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }

// ================= RANK MANAGER (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) =================
let selR = null, selP = null;
let editingItem = { type: null, value: null }; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ñ‡∏ß‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà

function openRankManagementModal() { 
    editingItem = { type: null, value: null }; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    renderRM(); 
    document.getElementById('rankManagementModal').classList.add('active'); 
    setTimeout(initSortableColumns, 100); 
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
function editData(type, value) {
    editingItem = { type: type, value: value };
    renderRM();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function cancelInlineEdit() {
    editingItem = { type: null, value: null };
    renderRM();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
function saveInlineEdit(type, oldVal) {
    const nameInput = document.getElementById('inline_edit_name');
    const scoreInput = document.getElementById('inline_edit_score');
    
    const newVal = nameInput ? nameInput.value.trim() : oldVal;
    const newScore = scoreInput ? parseInt(scoreInput.value) || 0 : 0;

    if (!newVal) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

    if (type === 'rel') {
        state.hierarchy[newVal] = state.hierarchy[oldVal];
        if (newVal !== oldVal) delete state.hierarchy[oldVal];
        if (selR === oldVal) selR = newVal;
    } 
    else if (type === 'pre') {
        const idx = state.hierarchy[selR].prefixes.indexOf(oldVal);
        if (idx !== -1) state.hierarchy[selR].prefixes[idx] = newVal;
        if (newVal !== oldVal) {
            state.hierarchy[selR].suffixes[newVal] = state.hierarchy[selR].suffixes[oldVal];
            delete state.hierarchy[selR].suffixes[oldVal];
            if (selP === oldVal) selP = newVal;
        }
        state.prefixScores[newVal] = newScore;
        if (newVal !== oldVal) delete state.prefixScores[oldVal];
    } 
    else if (type === 'suf') {
        const idx = state.hierarchy[selR].suffixes[selP].indexOf(oldVal);
        if (idx !== -1) state.hierarchy[selR].suffixes[selP][idx] = newVal;
        state.suffixScores[newVal] = newScore;
        if (newVal !== oldVal) delete state.suffixScores[oldVal];
    }
    else if (type === 'reign') {
        const idx = state.reignNames.indexOf(oldVal);
        if (idx !== -1) state.reignNames[idx] = newVal;
    }

    editingItem = { type: null, value: null };
    saveState();
    renderRM();
    refreshAllDisplays();
    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®");
}

function renderRM() {
    if(!state.prefixScores) state.prefixScores = {};
    if(!state.suffixScores) state.suffixScores = {};

    // 1. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
    const rl = document.getElementById('rl'); rl.innerHTML = '';
    Object.keys(state.hierarchy).forEach(k => {
        if (editingItem.type === 'rel' && editingItem.value === k) {
            rl.innerHTML += inlineEditHTML('rel', k);
        } else {
            rl.innerHTML += itemHTML('rel', k, `delData('rel','${k}')`, `selectRel('${k}')`, null, selR === k);
        }
    });

    // 2. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
    const pl = document.getElementById('pl');
    pl.innerHTML = selR ? '' : '<div class="text-center py-10 text-slate-300 text-[10px] italic">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô</div>';
    if(selR) {
        state.hierarchy[selR].prefixes.forEach(p => {
            const score = state.prefixScores[p] || 0;
            if (editingItem.type === 'pre' && editingItem.value === p) {
                pl.innerHTML += inlineEditHTML('pre', p, score);
            } else {
                pl.innerHTML += itemHTML('pre', p, `delData('pre','${p}')`, `selectPre('${p}')`, score, selP === p);
            }
        });
    }

    // 3. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°
    const sl = document.getElementById('sl');
    sl.innerHTML = (selR && selP) ? '' : '<div class="text-center py-10 text-slate-300 text-[10px] italic">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div>';
    if(selR && selP) {
        (state.hierarchy[selR].suffixes[selP] || []).forEach(s => {
            const score = state.suffixScores[s] || 0;
            if (editingItem.type === 'suf' && editingItem.value === s) {
                sl.innerHTML += inlineEditHTML('suf', s, score);
            } else {
                sl.innerHTML += itemHTML('suf', s, `delData('suf','${s}')`, "", score);
            }
        });
    }

    // 4. ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
    const gl = document.getElementById('reignl'); gl.innerHTML = '';
    state.reignNames.forEach(n => { 
        if (editingItem.type === 'reign' && editingItem.value === n) {
            gl.innerHTML += inlineEditHTML('reign', n);
        } else {
            gl.innerHTML += itemHTML('reign', n, `delData('reign','${n}')`); 
        }
    });
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÅ‡∏ô‡∏ö‡∏°‡∏≤)
function inlineEditHTML(type, value, score = 0) {
    const showScore = (type === 'pre' || type === 'suf');
    return `
        <div class="p-3 bg-white rounded-2xl border-2 border-blue-100 shadow-sm mb-2 space-y-2 animate-fade-in">
            <div class="flex gap-2">
                <input id="inline_edit_name" class="flex-1 px-3 py-2 rounded-xl border-2 border-sky-400 outline-none text-sm font-bold" value="${value}">
                ${showScore ? `<input id="inline_edit_score" type="number" class="w-16 px-1 py-2 rounded-xl border-2 border-slate-100 outline-none text-sm text-center" value="${score}">` : ''}
            </div>
            <div class="flex gap-2">
                <button onclick="saveInlineEdit('${type}', '${value}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl text-[11px] font-bold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="cancelInlineEdit()" class="px-4 bg-slate-400 hover:bg-slate-500 text-white py-2 rounded-xl text-[11px] font-bold transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>`;
}

function itemHTML(type, value, deleteFn, clickFn = "", score = null, isSelected = false) {
    const scoreBadge = score !== null ? `<div class="text-[10px] text-slate-400 font-mono">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}</div>` : '';
    const activeClass = isSelected ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-50';
    return `
        <li data-id="${value}" data-type="${type}" class="flex justify-between items-center p-3 border rounded-2xl transition group ${activeClass} mb-1" onclick="${clickFn}">
            <div class="flex items-center gap-3 overflow-hidden">
                <i class="fa-solid fa-grip-vertical text-slate-200 text-xs shrink-0 cursor-grab"></i>
                <div class="truncate">
                    <div class="text-sm font-bold ${isSelected ? 'text-indigo-600' : 'text-slate-700'} truncate">${value}</div>
                    ${scoreBadge}
                </div>
            </div>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                <button onclick="event.stopPropagation(); editData('${type}', '${value}')" class="p-1.5 text-blue-400 hover:bg-blue-50 rounded-lg">
                    <i class="fa-solid fa-pen-to-square text-xs"></i>
                </button>
                <button onclick="event.stopPropagation(); ${deleteFn}" class="p-1.5 text-red-300 hover:text-red-500">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
            </div>
        </li>`;
}

function selectRel(k){ selR=k; selP=null; renderRM(); }
function selectPre(p){ selP=p; renderRM(); }

function addData(type) {
    if (type === 'rel') {
        const val = document.getElementById('nr').value.trim();
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå");
        state.hierarchy[val] = { prefixes: [], suffixes: {} };
        document.getElementById('nr').value = '';
    } 
    else if (type === 'pre') {
        if (!selR) return showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô");
        const val = document.getElementById('np').value.trim();
        const score = parseInt(document.getElementById('np_score').value) || 0;
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤");
        state.hierarchy[selR].prefixes.push(val);
        state.hierarchy[selR].suffixes[val] = [];
        state.prefixScores[val] = score;
        document.getElementById('np').value = ''; document.getElementById('np_score').value = '';
    } 
    else if (type === 'suf') {
        if (!selR || !selP) return showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
        const val = document.getElementById('ns').value.trim();
        const score = parseInt(document.getElementById('ns_score').value) || 0;
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°");
        state.hierarchy[selR].suffixes[selP].push(val);
        state.suffixScores[val] = score;
        document.getElementById('ns').value = ''; document.getElementById('ns_score').value = '0';
    } 
    else if (type === 'reign') {
        const val = document.getElementById('nreign').value.trim();
        if (!val) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô");
        state.reignNames.push(val);
        document.getElementById('nreign').value = '';
    }
    saveState(); renderRM(); refreshAllDisplays(); showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚ú®");
}

function delData(type, val) {
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
    if(type==='rel') delete state.hierarchy[val];
    else if(type==='pre') {
        state.hierarchy[selR].prefixes = state.hierarchy[selR].prefixes.filter(x=>x!==val);
        if(state.prefixScores) delete state.prefixScores[val];
    }
    else if(type==='suf') {
        state.hierarchy[selR].suffixes[selP] = state.hierarchy[selR].suffixes[selP].filter(x=>x!==val);
        if(state.suffixScores) delete state.suffixScores[val];
    }
    else if(type==='reign') state.reignNames = state.reignNames.filter(x=>x!==val);
    saveState(); renderRM(); refreshAllDisplays();
}

function initSortableColumns() {
    const config = {
        animation: 150, handle: '.fa-grip-vertical',
        onEnd: function(evt) {
            const type = evt.item.getAttribute('data-type');
            reorderState(type, evt.from);
        }
    };
    if (document.getElementById('rl')) new Sortable(document.getElementById('rl'), config);
    if (document.getElementById('pl')) new Sortable(document.getElementById('pl'), config);
    if (document.getElementById('sl')) new Sortable(document.getElementById('sl'), config);
    if (document.getElementById('reignl')) new Sortable(document.getElementById('reignl'), config);
}

function reorderState(type, parentEl) {
    const newOrder = Array.from(parentEl.children).map(li => li.getAttribute('data-id')).filter(id => id);
    if (type === 'rel') {
        const newHierarchy = {};
        newOrder.forEach(key => { if(state.hierarchy[key]) newHierarchy[key] = state.hierarchy[key]; });
        state.hierarchy = newHierarchy;
    } else if (type === 'pre' && selR) {
        state.hierarchy[selR].prefixes = newOrder;
    } else if (type === 'suf' && selR && selP) {
        state.hierarchy[selR].suffixes[selP] = newOrder;
    } else if (type === 'reign') {
        state.reignNames = newOrder;
    }
    saveState(); refreshAllDisplays();
}
    

    function selectRel(k){ selR=k; renderRM(); }
    function selectPre(p){ selP=p; renderRM(); }

    // ================= TABLE RENDER =================

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î
function onTableFilterChange() {
    const filterStatus = document.getElementById('tableFilterStatus').value;
    const monarchContainer = document.getElementById('monarchFilterContainer');
    const royalHeader = document.getElementById('royalChildrenHeader');
    
    if (filterStatus === 'royal_children') {
        monarchContainer.classList.remove('hidden');
        monarchContainer.classList.add('flex');
        populateMonarchFilterSelect();
    } else {
        monarchContainer.classList.add('hidden');
        monarchContainer.classList.remove('flex');
        if (royalHeader) royalHeader.classList.add('hidden');
    }
    renderTable();
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
function populateMonarchFilterSelect() {
    const sel = document.getElementById('monarchFilterSelect');
    const currentVal = sel.value;
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà...) --</option>';
    
    const monarchs = state.members
        .filter(m => m.isMonarch)
        .sort((a, b) => (parseInt(a.globalReignNumber) || 0) - (parseInt(b.globalReignNumber) || 0));
        
    monarchs.forEach(m => {
        const reignText = m.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : '';
        const op = new Option(`${reignText} ${m.name}`, m.id);
        sel.add(op);
    });
    if (currentVal) sel.value = currentVal;
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á 2 ‡πÅ‡∏ö‡∏ö)
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)
function getMotherRankScore(p) {
    if (!p) return 0;
    const pre = p.titlePrefix || "";
    const suf = p.titleSuffix || "";
    const full = pre + suf;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1-15 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏°‡πÄ‡∏´‡∏™‡∏µ/‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ")) return 1000;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 990;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ")) return 980;
    if (pre === "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ") return 970;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 960;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 950;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ")) return 940;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 930;
    if (full.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 920;
    if (pre.includes("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 910;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 900;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤") && suf.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 890;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤") && suf.includes("‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 880;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è") && suf.includes("‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ")) return 870;
    if (pre === "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠") return 860;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 16-20 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤/‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞)
    if (pre === "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 850;
    if (pre.includes("‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤")) return 840;
    if (pre === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠") return 830;
     if (pre === "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤") return 825;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡∏∞") return 820;
    if (pre === "‡∏û‡∏£‡∏∞") return 810;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 21-24 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏ß/‡∏û‡∏£‡∏∞‡∏™‡∏ô‡∏°‡πÄ‡∏≠‡∏Å)
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏™‡∏∏‡πÄ‡∏£‡∏ô‡∏ó‡∏£‡πå")) return 800;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πÄ‡∏ó‡∏ß‡∏µ")) return 790;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå")) return 780;
    if (pre.includes("‡∏ó‡πâ‡∏≤‡∏ß‡∏®‡∏£‡∏µ‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå")) return 770;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 25-28 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤)
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 760;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤") return 750;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏°") return 740;
    if (pre === "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°") return 730;

    return calculatePojiamScore(p); // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const q = document.getElementById('tableSearch').value.toLowerCase();
    const filterStatus = document.getElementById('tableFilterStatus').value;
    const royalHeader = document.getElementById('royalChildrenHeader');
    const subFilter = document.getElementById('royalSubFilter') ? document.getElementById('royalSubFilter').value : 'mother_rank';
    const activeMonarchData = state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch);
    
    let list = [...state.members];

    // ================= ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á (Royal Children) =================
    if (filterStatus === 'royal_children') {
        const selectedMonarchId = document.getElementById('monarchFilterSelect').value;
        if (!selectedMonarchId) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400 italic">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</td></tr>`;
            if (royalHeader) royalHeader.classList.add('hidden');
            return;
        }
        
        const monarch = state.members.find(m => m.id === selectedMonarchId);
        if (monarch && royalHeader) {
            royalHeader.innerText = `‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™ ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤‡πÉ‡∏ô ${getFullDisplayTitle(monarch)}`;
            royalHeader.classList.remove('hidden');
        }

        let children = state.members.filter(m => m.fatherId === selectedMonarchId || m.motherId === selectedMonarchId);

        if (subFilter === 'age_all') {
            // --- 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏û‡∏µ‡πà‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏î‡∏≤) ---
            children.sort((a, b) => (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999) || a.id.localeCompare(b.id));
            if (q) children = children.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));

            children.forEach((m, idx) => {
                const otherParentId = (m.fatherId === selectedMonarchId) ? m.motherId : m.fatherId;
                const mother = state.members.find(p => p.id === otherParentId);
                renderRoyalRow(tbody, m, idx + 1, mother, true); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà
            });
        } else {
            // --- 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏≤‡∏£‡∏î‡∏≤ (‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏°‡πà ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å) ---
            children.sort((a, b) => {
                const mIdA = (a.fatherId === selectedMonarchId) ? a.motherId : a.fatherId;
                const mIdB = (b.fatherId === selectedMonarchId) ? b.motherId : b.fatherId;
                const motherA = state.members.find(p => p.id === mIdA);
                const motherB = state.members.find(p => p.id === mIdB);
                
                const scoreA = getMotherRankScore(motherA);
                const scoreB = getMotherRankScore(motherB);
                
                if (scoreB !== scoreA) return scoreB - scoreA; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÅ‡∏°‡πà
                if (mIdA !== mIdB) return mIdA.localeCompare(mIdB); // ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏°‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                return (parseInt(a.birthYear) || 9999) - (parseInt(b.birthYear) || 9999); // ‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
            });

            if (q) children = children.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));
            let currentMotherId = null;
            let localIdx = 0;

            children.forEach((m) => {
                const motherId = (m.fatherId === selectedMonarchId) ? m.motherId : m.fatherId;
                const mother = state.members.find(p => p.id === motherId);
                
                if (motherId !== currentMotherId) {
                    currentMotherId = motherId;
                    localIdx = 1; 
                    const hRow = document.createElement('tr');
                    hRow.className = "mother-group-header";
                    hRow.innerHTML = `<td colspan="5"><i class="fa-solid fa-crown mr-2 text-amber-500"></i> ‡πÉ‡∏ô ${mother ? getFullDisplayTitle(mother) : '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ô‡∏≤‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤'}</td>`;
                    tbody.appendChild(hRow);
                } else {
                    localIdx++;
                }
                renderRoyalRow(tbody, m, localIdx, mother, false); // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà
            });
        }
        return; 
    }

    // ================= ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (All, Alive, Dead, Precedence) =================
    if (filterStatus === 'alive') list = list.filter(m => m.isAlive);
    else if (filterStatus === 'dead') list = list.filter(m => !m.isAlive);
    else if (filterStatus === 'precedence') list = list.filter(m => m.isAlive && calculatePojiamScore(m) > 0);
    
    if (q) list = list.filter(m => getFullDisplayTitle(m).toLowerCase().includes(q));

    list.sort((a,b) => (filterStatus === 'precedence') ? (calculatePojiamScore(b) - calculatePojiamScore(a)) : ((parseInt(a.birthYear)||Infinity) - (parseInt(b.birthYear)||Infinity)));

    list.forEach((m, index) => {
        const dTerm = m.isAlive ? "" : getDeathTerm(m);
        const statusHTML = m.isAlive 
            ? '<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-600 text-xs font-bold">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>'
            : `<span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-500 text-xs font-bold">${dTerm}</span>`;
        
        let fullName = getFullDisplayTitle(m);
        let postNameTag = '';
        const reignLabel = m.globalReignNumber ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(m.globalReignNumber)}` : '';

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
        if (m.isMonarch) {
            if (m.isAlive && !m.isExMonarch) {
                postNameTag = `<span class="monarch-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignLabel}</span>`;
            } else if (m.isExMonarch && m.isAlive) {
                postNameTag = `<span class="monarch-tag-table bg-purple-50 text-purple-600 border-purple-200">${reignLabel}</span>`;
            } else {
                postNameTag = `<span class="monarch-tag-table opacity-70 border-slate-300 text-slate-600 bg-slate-50">${reignLabel}</span>`;
            }
        } else if (m.isQueenConsort && activeMonarchData && (activeMonarchData.spouseIds||[]).includes(m.id)) {
            postNameTag = `<span class="queen-consort-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå</span>`;
        } else if (m.isHeir && parseInt(m.heirOrder) === 1) {
            postNameTag = `<span class="heir-tag-table">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó</span>`;
        }

        const row = document.createElement('tr');
        row.className = "data-row transition border-b border-slate-100 hover:bg-slate-50";
        row.innerHTML = `
            <td class="text-center py-2"><img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-8 h-8 rounded-full mx-auto object-cover border"></td>
            <td class="py-2 text-sm font-bold text-slate-700" onclick="showDetail('${m.id}')">
                ${filterStatus === 'precedence' ? `<span class="mr-2 text-slate-400 font-mono">${index + 1}</span>` : ''}${fullName}${postNameTag}
            </td>
            <td class="py-2">${statusHTML}</td>
            <td class="py-2 text-xs text-slate-500">${state.members.find(x=>x.id===m.fatherId)?.name || '-'} / ${state.members.find(x=>x.id===m.motherId)?.name || '-'}</td>
            <td class="text-center py-2"><button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button></td>
        `;
        tbody.appendChild(row);
    });
}

function renderRoyalRow(tbody, m, displayIdx, mother, showMotherTag) {
    let fullName = getFullDisplayTitle(m);
    if (m.monarchSpouseContext) fullName = fullName.replace(m.monarchSpouseContext, "").trim();

    const row = document.createElement('tr');
    row.className = "data-row border-b border-slate-100 hover:bg-slate-50 transition";
    
    let motherTagHTML = "";
    if (showMotherTag) {
        motherTagHTML = `
            <div class="mother-tag-container">
                <span class="mother-tag-label">‡∏°‡∏≤‡∏£‡∏î‡∏≤:</span>
                <span class="mother-tag-value">${mother ? getFullDisplayTitle(mother).replace(/‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà\s*\d+/, "").trim() : '-'}</span>
            </div>
        `;
    }

    row.innerHTML = `
        <td class="text-center py-3"><img src="${m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE)}" class="w-10 h-10 rounded-full mx-auto object-cover border shadow-sm"></td>
        <td class="py-3 text-sm font-bold text-slate-700" onclick="showDetail('${m.id}')">
            <div class="flex items-center">
                <span class="child-index-circle">${toThaiNumerals(displayIdx)}</span>
                <div class="ml-3">
                    <div class="flex items-center flex-wrap gap-y-1">
                        ${fullName}
                        ${motherTagHTML}
                    </div>
                </div>
            </div>
        </td>
        <td class="py-3">${m.isAlive ? '<span class="text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded-full text-[11px]">‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span>' : '<span class="text-slate-400 bg-slate-50 px-2 py-1 rounded-full text-[11px]">'+getDeathTerm(m)+'</span>'}</td>
        <td class="py-3 text-xs text-slate-500">‡∏û.‡∏®. ${m.birthYear ? toThaiNumerals(m.birthYear) : '-'}</td>
        <td class="text-center py-3"><button onclick="editPersonDirect('${m.id}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button></td>
    `;
    tbody.appendChild(row);
}

    // ================= MONARCH & MODAL HELPERS (RESTORED) =================

    function renderMonarchBanner() {
        try {
            const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
            const banner = document.getElementById('monarchBanner');
            const vacant = document.getElementById('monarchVacant');
            if(activeMonarch) {
                banner.classList.remove('hidden'); banner.classList.add('flex'); vacant.classList.add('hidden'); vacant.classList.remove('flex');
                document.getElementById('monarchImg').src = activeMonarch.image || (activeMonarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
                document.getElementById('monarchName').innerText = getFullDisplayTitle(activeMonarch) + " " + getGlobalReignLabel(activeMonarch);
            } else {
                banner.classList.add('hidden'); banner.classList.remove('flex');
                if(state.members.length > 0) { vacant.classList.remove('hidden'); vacant.classList.add('flex'); } 
                else { vacant.classList.add('hidden'); vacant.classList.remove('flex'); }
            }
        } catch(e) { console.error("Banner Render Error:", e); }
    }

    // ================= MONARCH & QUEEN CONSORT HELPERS (FIXED ORDERING) =================

    function checkQueenConsortEligible() { 
        const g = document.querySelector('input[name="gender"]:checked').value; 
        const r = document.getElementById('p_relationship').value; 
        const ok = g === 'F' && (r === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || r === '‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤' || (r||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || r === '‡∏´‡∏°‡πà‡∏≠‡∏°'); 
        document.getElementById('queenConsortOption').classList.toggle('hidden', !ok); 
    }

    function updateQueenConsortSelector(d) {
        const selDiv = document.getElementById('maleMonarchQueenSelect');
        const sel = document.getElementById('p_queenSelectForKing');
        const genderEl = document.querySelector('input[name="gender"]:checked');
        const genderVal = genderEl ? genderEl.value : 'M';
        const isKing = document.getElementById('p_isMonarch').checked && genderVal === 'M';
        if(isKing) {
            selDiv.classList.remove('hidden');
            sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
            const spouseIds = [];
            document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));
            let currentQueenId = null;
            spouseIds.forEach(sid => {
                const s = state.members.find(m => m.id === sid);
                const isConsort = s && s.gender === 'F' && (s.relationship === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || s.relationship === '‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤' || s.relationship === '‡∏´‡∏°‡πà‡∏≠‡∏°' || (s.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤'));
                if(isConsort) {
                    const op = document.createElement('option');
                    op.value = s.id; op.innerText = s.name;
                    sel.appendChild(op);
                    if(s.isQueenConsort) currentQueenId = s.id;
                }
            });
            if(currentQueenId) sel.value = currentQueenId;
        } else { selDiv.classList.add('hidden'); }
    }

    function toggleMonarch() { 
        const isM = document.getElementById('p_isMonarch').checked; 
        document.getElementById('monarchPanel').classList.toggle('hidden', !isM); 
        checkQueenConsortEligible(); updateQueenConsortSelector(); 
        if(isM && document.getElementById('p_isEditMode').value !== 'true') {
             const monarchs = state.members.filter(x => x.isMonarch);
             const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
             document.getElementById('p_globalReignNumber').value = maxGlobal + 1;
        }
    }
    // ================= END MONARCH HELPERS =================


    function openAppointModal() {
        const s = document.getElementById('appointSelectModal'); s.innerHTML = '';
        const eligible = state.members.filter(m => m.isAlive && !m.royalRank.includes('‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') && !m.royalRank.includes('‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') && !(m.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤'));
        if(eligible.length === 0) { showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∑‡∏ö‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥"); return; }
        eligible.forEach(m => { const op = document.createElement('option'); op.value = m.id; op.innerText = `${m.royalRank} ${m.name}`; s.appendChild(op); });
        document.getElementById('appointModal').classList.add('active');
    }

    let tempAppointId = null;
    function appointFromModal() {
        const id = document.getElementById('appointSelectModal').value;
        closeModal('appointModal');
        openReignNameSelectionModal(id);
    }

    function openReignNameSelectionModal(id) {
        tempAppointId = id;
        const s = document.getElementById('reignSelectionInput');
        s.innerHTML = '';
        state.reignNames.forEach(n => {
            const op = document.createElement('option');
            op.value = n; op.innerText = n;
            s.appendChild(op);
        });
        document.getElementById('reignSelectionModal').classList.add('active');
    }

    function confirmReignSelection() {
        const rName = document.getElementById('reignSelectionInput').value;
        if(tempAppointId && rName) {
            performSuccession(tempAppointId, rName);
            closeModal('reignSelectionModal');
        }
    }

 // ================= SUCCESSION & LIFE EVENTS LOGIC =================

function performSuccession(newMonarchId, reignNameBase) {
    const newMonarch = state.members.find(m => m.id === newMonarchId);
    if (!newMonarch) return;

    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó
    state.members.forEach(p => {
        if (p.isHeir && p.id !== newMonarchId) {
            if (p.heirOrder && parseInt(p.heirOrder) > 1) {
                p.heirOrder = parseInt(p.heirOrder) - 1;
            }
        } else if (p.id === newMonarchId) {
            p.isHeir = false;
            p.heirOrder = null;
        }

        if (p.id !== newMonarchId && p.isMonarch && !p.isExMonarch) {
            if (!p.reignEnd) p.reignEnd = new Date().getFullYear() + 543;
            p.isExMonarch = p.isAlive;
        }
    });

    // 2. ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡πÉ‡∏´‡∏°‡πà
    newMonarch.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå";
    newMonarch.isMonarch = true;
    newMonarch.isExMonarch = false;
    newMonarch.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞";
    newMonarch.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
    newMonarch.titleSuffix = "‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏±‡∏ß";
    newMonarch.reignStart = new Date().getFullYear() + 543;
    newMonarch.reignNameBase = reignNameBase;
    newMonarch.useReignName = true;

    const monarchs = state.members.filter(x => x.isMonarch);
    const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber || 0)));
    if (!newMonarch.globalReignNumber) newMonarch.globalReignNumber = maxGlobal + 1;
    recordTitleHistory(newMonarch);

    // ============================================================
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Triple-Pass Engine)
    // ============================================================

    // --- PASS 0: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™ (‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤) ---
    (newMonarch.spouseIds || []).forEach(sid => {
        const spouse = state.members.find(s => s.id === sid);
        if (spouse && spouse.isAlive) {
            if (spouse.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || spouse.relationship === '‡∏´‡∏°‡πà‡∏≠‡∏°' || spouse.relationship === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
                const hasChildrenWithMonarch = state.members.some(child =>
                    (child.fatherId === newMonarchId && child.motherId === spouse.id) ||
                    (child.motherId === newMonarchId && child.fatherId === spouse.id)
                );
                spouse.relationship = "‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤";
                spouse.titlePrefix = hasChildrenWithMonarch ? "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏≠‡∏°";
                spouse.surname = ""; 
                spouse.hideRoyalRank = false;
                recordTitleHistory(spouse);
            }
        }
    });

    // --- PASS 1: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ "‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" (‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏°) ---
    state.members.forEach(p => {
        if (p.id === newMonarchId || !p.isAlive) return;

        if (p.fatherId === newMonarchId || p.motherId === newMonarchId) {
            const isMale = p.gender === 'M';
            const father = state.members.find(f => f.id === p.fatherId);
            const mother = state.members.find(mo => mo.id === p.motherId);
            const otherParent = (p.fatherId === newMonarchId) ? mother : father;
            const isOtherParentHighRoyal = otherParent && (otherParent.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || otherParent.isQueenConsort);

            p.relationship = isMale ? "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™" : "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤";
            if (isOtherParentHighRoyal) {
                p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                p.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
            } else {
                p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                p.titlePrefix = isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
            }
            p.surname = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏µ‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
            p.hideRoyalRank = false;
            recordTitleHistory(p);
        }
    });

    // --- PASS 2: ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ "‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå (‡∏ö‡∏£‡∏°‡πÄ‡∏ò‡∏≠)" / "‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠" / "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á" ---
    state.members.forEach(p => {
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏ß‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ó‡∏≥‡πÉ‡∏ô Pass 1 ‡πÅ‡∏•‡πâ‡∏ß)
        if (p.id === newMonarchId || !p.isAlive || p.fatherId === newMonarchId || p.motherId === newMonarchId) return;

        const isMale = p.gender === 'M';
        const father = state.members.find(f => f.id === p.fatherId);
        const mother = state.members.find(mo => mo.id === p.motherId);
        const mBirthYear = parseInt(newMonarch.birthYear) || Infinity;
        const pBirthYear = parseInt(p.birthYear) || Infinity;

        const isSameFather = (p.fatherId === newMonarch.fatherId && p.fatherId);
        const isSameMother = (p.motherId === newMonarch.motherId && p.motherId);
        const isSibling = isSameFather || isSameMother;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå" (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡πÉ‡∏î) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏£‡∏°‡πÄ‡∏ò‡∏≠"
        const isChildOfAnyMonarch = (father && father.isMonarch) || (mother && mother.isMonarch);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á" (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
        const isDirectGrandchild = (father && (father.fatherId === newMonarchId || father.motherId === newMonarchId)) ||
                                   (mother && (mother.fatherId === newMonarchId || mother.motherId === newMonarchId));

        // --- ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ---

        // A. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏ò‡∏≠
        if (isSibling) {
            const isFullSibling = isSameFather && isSameMother;
            const ageSuffix = pBirthYear < mBirthYear ? (isMale ? '‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠') : (isMale ? '‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠' : '‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠');
            if (p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                p.titlePrefix = isFullSibling ? `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤${ageSuffix}` : `‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞${ageSuffix}`;
            } else {
                p.titlePrefix = isFullSibling ? `‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤${ageSuffix}` : `‡∏û‡∏£‡∏∞${ageSuffix}`;
            }
            p.relationship = isFullSibling ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤";
        } 
        // B. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (‡∏ö‡∏£‡∏°‡πÄ‡∏ò‡∏≠) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô
        // ‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤: ‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ô‡∏µ‡πâ
        else if (isChildOfAnyMonarch) {
            p.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
            p.titlePrefix = p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
            p.surname = ""; 
            p.hideRoyalRank = false;
        }
        // C. ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å) ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°
        else if (isDirectGrandchild) {
            const royalParent = (father && (father.fatherId === newMonarchId || father.motherId === newMonarchId)) ? father : mother;
            p.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            if (royalParent && royalParent.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤')) {
                p.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                p.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            } else {
                p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                p.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
            }
            p.surname = "";
            p.hideRoyalRank = false;
        }
        // D. ‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå (‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô
        else if (p.relationship === "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠" || p.relationship === "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå") {
            p.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
            p.titlePrefix = p.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }

        recordTitleHistory(p);
    });

    saveState();
    updateApp();
    closeModal('reignSelectionModal');
    showFantasyPopup(newMonarch);
}

function handleMonarchDeath(monarch) {
    if(monarch.spouseIds && monarch.spouseIds.length > 0) {
        const reignNum = getGlobalReignLabel(monarch); 
        monarch.spouseIds.forEach(sid => {
            const sp = state.members.find(x => x.id === sid);
            if(sp && sp.isAlive) {
                const rel = sp.relationship || '';
                if (rel === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || sp.isQueenConsort) {
                    sp.isQueenConsort = false;
                    sp.monarchSpouseContext = `‡πÉ‡∏ô${reignNum}`;
                    showToast(`‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏°/‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏ó‡πâ‡∏≤‡∏¢: ${sp.name} ‡∏î‡πâ‡∏ß‡∏¢ ${sp.monarchSpouseContext}`);
                } else {
                     sp.monarchSpouseContext = null;
                }
            }
        });
    }
    
    monarch.isExMonarch = false; 
    monarch.reignEnd = new Date().getFullYear() + 543;
    
    const heirs = state.members.filter(m => m.isHeir && m.isAlive).sort((a,b) => (a.heirOrder||99) - (b.heirOrder||99));
    if(heirs.length > 0 && parseInt(heirs[0].heirOrder) === 1) { 
        const successor = heirs[0];
        showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${successor.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå...`);
        setTimeout(() => {
            openReignNameSelectionModal(successor.id);
            state.members.filter(m => m.isHeir && m.isAlive && m.id !== successor.id).forEach(h => { 
                if(h.heirOrder > 1) h.heirOrder--; 
            });
            saveState();
        }, 2000);
    } else {
         showToast(`‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë`);
         saveState();
    }
}

function handleHeirDeath(p) {
    if (!p.heirOrder) return;
    const deadOrder = parseInt(p.heirOrder);
    
    p.isHeir = false;
    p.heirOrder = null;

    state.members.forEach(m => {
        if (m.isAlive && m.isHeir && m.heirOrder) {
            if (parseInt(m.heirOrder) > deadOrder) {
                m.heirOrder = parseInt(m.heirOrder) - 1;
                recordTitleHistory(m); 
            }
        }
    });
}

function showFantasyPopup(monarch) {
    const modal = document.getElementById('fantasyModal');
    if(!modal) return; // ‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ Modal ‡πÉ‡∏ô HTML
    document.getElementById('fan_name').innerText = getFullDisplayTitle(monarch);
    document.getElementById('fan_rama').innerText = getGlobalReignLabel(monarch);
    document.getElementById('fan_img').src = monarch.image || (monarch.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
    document.getElementById('fan_dynasty').innerText = state.dynastyName || '-';
    document.getElementById('fan_kingdom').innerText = state.kingdomName || '-';
    const pc = document.getElementById('fantasyParticles'); pc.innerHTML = '';
    for(let i=0; i<30; i++) {
        const p = document.createElement('div'); p.className = 'particle';
        p.style.left = Math.random()*100 + '%'; p.style.width = Math.random()*6 + 2 + 'px'; p.style.height = p.style.width; p.style.animationDelay = Math.random()*2 + 's';
        p.style.background = Math.random() > 0.5 ? '#ffd700' : '#fff'; pc.appendChild(p);
    }
    modal.classList.add('active');
}

function abdicateCurrent() {
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏≠‡∏á‡∏Ñ‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë)')) return;
    
    const monarch = state.members.find(m => m.id === window.curPID); 
    if (!monarch || !monarch.isMonarch || monarch.isExMonarch) {
        showToast("‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå");
        return;
    }
    
    const currentReignNum = monarch.globalReignNumber;
    monarch.isExMonarch = true;
    monarch.reignEnd = new Date().getFullYear() + 543;
    
    if(monarch.spouseIds && monarch.spouseIds.length > 0) {
        const reignLabel = `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(currentReignNum)}`; 
        monarch.spouseIds.forEach(sid => {
            const sp = state.members.find(x => x.id === sid);
            if(sp && sp.isAlive) {
                const rel = sp.relationship || '';
                if (rel === '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' || rel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || sp.isQueenConsort) {
                    sp.isQueenConsort = false;
                    sp.monarchSpouseContext = `‡πÉ‡∏ô${reignLabel}`;
                }
            }
        });
    }
    
    const heirs = state.members.filter(m => m.isHeir && m.isAlive)
                               .sort((a,b) => (a.heirOrder||99) - (b.heirOrder||99));
    
    saveState(); 
    closeModal('detailModal'); 
    
    if(heirs.length > 0 && parseInt(heirs[0].heirOrder) === 1) {
        const successor = heirs[0];
        showToast(`‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${successor.name} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå`);
        setTimeout(() => {
            openReignNameSelectionModal(successor.id);
        }, 800);
    } else {
        showToast(`‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ‡πë`);
        if(typeof refreshAllDisplays === 'function') refreshAllDisplays(); 
    }
}
    // ================= END ABDICATION LOGIC =================
    
    // ================= NEW SPOUSE SELECTION MODAL LOGIC =================
    
    // 1. New function to open the selection modal (replaces the old openAddSpouseModal(id))
    function openSpouseSelectionModal(id) {
        closeModal('detailModal');
        
        targetOriginIdForSpouse = id;
        const originPerson = state.members.find(m => m.id === id);
        
        // Prepare list of eligible spouses (not self, not current spouse)
        const currentSpouseIds = originPerson.spouseIds || [];
        const eligible = state.members.filter(m => 
            m.id !== id && 
            !currentSpouseIds.includes(m.id) &&
            m.isAlive // Only suggest living people
        );

        const dl = document.getElementById('eligibleSpouseList');
        dl.innerHTML = '';
        eligible.forEach(m => {
            const op = document.createElement('option');
            // Format: ID : Full Name
            op.value = `${m.id} : ${getFullDisplayTitle(m)}`; 
            dl.appendChild(op);
        });

        // Reset inputs
        document.getElementById('existingSpouseSearch').value = '';
        document.getElementById('selectedExistingSpouseId').value = '';

        document.getElementById('spouseSelectionModal').classList.add('active');
    }

    // 2. Validate input against datalist options
    function validateExistingSpouseInput() {
        const input = document.getElementById('existingSpouseSearch').value.trim();
        const hiddenId = document.getElementById('selectedExistingSpouseId');
        
        hiddenId.value = ''; // Reset ID

        // Try matching the whole string (ID : Name)
        const eligibleOptions = document.getElementById('eligibleSpouseList').options;
        for (let i = 0; i < eligibleOptions.length; i++) {
            if (eligibleOptions[i].value === input) {
                // Extract ID from "ID : Name" format
                const id = input.split(' : ')[0].trim();
                hiddenId.value = id;
                return;
            }
        }

        // Try matching just the ID or Name
        const parts = input.split(' : ');
        const searchVal = parts.length > 1 ? parts[0].trim() : input; // If split, use ID part, otherwise use full input
        
        const exists = state.members.find(m => m.id === searchVal || m.name === searchVal);
        
        if (exists) {
            hiddenId.value = exists.id;
            // Optionally, update the input value to the full format for clarity
            document.getElementById('existingSpouseSearch').value = `${exists.id} : ${getFullDisplayTitle(exists)}`;
        }
    }

    // 3. Link the selected existing spouse
    function confirmLinkExistingSpouse() {
        const spouseId = document.getElementById('selectedExistingSpouseId').value;
        if (!spouseId || !targetOriginIdForSpouse) {
            showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
        }

        const p1 = state.members.find(m => m.id === targetOriginIdForSpouse);
        const p2 = state.members.find(m => m.id === spouseId);

        if (p1 && p2) {
            // Add ID to spouseIds of both parties
            if (!p1.spouseIds) p1.spouseIds = [];
            if (!p2.spouseIds) p2.spouseIds = [];

            if (!p1.spouseIds.includes(p2.id)) p1.spouseIds.push(p2.id);
            if (!p2.spouseIds.includes(p1.id)) p2.spouseIds.push(p1.id);

            // Re-run checkConsortMotherhood if p1 or p2 is a female consort and now has children
            [p1, p2].forEach(p => {
                if (p.gender === 'F' && (p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
                    checkConsortMotherhood(p); // This function mutates the state (updates titlePrefix)
                }
            });
            
            saveState();
            closeModal('spouseSelectionModal');
            showToast(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á ${p1.name} ‡πÅ‡∏•‡∏∞ ${p2.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
            refreshAllDisplays();
            
            // Open detail view for confirmation
            showDetail(targetOriginIdForSpouse);
        } else {
             showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á");
        }
    }

    // 4. Proceed to the normal Add New Person form
    function proceedToNewSpouse() {
        closeModal('spouseSelectionModal');
        
        const m = state.members.find(x => x.id === targetOriginIdForSpouse);
        
        if (m) {
            // If the original person has spouses, we should only suggest the opposite gender
            const recommendedGender = m.gender === 'M' ? 'F' : 'M';
            
            // Pass the original person's ID as the spouse in the initial data
            openModal({ 
                spouseIds: [m.id], 
                gender: recommendedGender,
                // If the original person is a King/Prince, the new spouse should default to a consort/wife rank
                relationship: m.isMonarch ? '‡∏û‡∏£‡∏∞‡∏†‡∏£‡∏£‡∏¢‡∏≤‡πÄ‡∏à‡πâ‡∏≤' : (m.royalRank.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤') || m.royalRank.includes('‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤') ? '‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤' : '‡∏´‡∏°‡πà‡∏≠‡∏°') 
            }, false, `‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á ${m.name}`);
        } else {
             showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á");
        }
    }

    // 5. Update showDetail to call the new function
    function showDetail(id) {
        window.curPID = id;
        const m = state.members.find(x => x.id === id);
        if(!m) return;
        
   // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï) ---
    const btnPromoteMC = document.getElementById('btnPromoteMC');
    if (m.royalRank === '‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤') {
        btnPromoteMC.classList.remove('hidden');
    } else {
        btnPromoteMC.classList.add('hidden');
    }
    // ------------------------------------------------------------------
        
        // Find and replace the onclick handler for the "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™" button
        const addSpouseButton = document.querySelector('#detailModal button[onclick^="openSpouseSelectionModal"]');
        if (addSpouseButton) {
             addSpouseButton.onclick = () => openSpouseSelectionModal(window.curPID);
        } else {
             // Fallback/Safety Check: Ensure the button uses the correct function in the HTML
        }
        
        // Control Abdicate Button
        const btnAbdicate = document.getElementById('btnAbdicate');
        const btnDeath = document.getElementById('btnDeath');
        const activeMonarch = state.members.find(p => p.isMonarch && p.isAlive && !p.isExMonarch);

        // MODIFICATION (Rule 1 & 2): Show 4 buttons for active monarch
        const isActiveMonarch = m.isMonarch && m.isAlive && !m.isExMonarch && m.id === activeMonarch?.id;

        if (isActiveMonarch) {
            btnAbdicate.classList.remove('hidden');
            btnDeath.classList.remove('hidden'); // <-- Keep Death button visible
        } else {
            btnAbdicate.classList.add('hidden');
            btnDeath.classList.remove('hidden');
        }
        
        document.getElementById('d_img').src = m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
        document.getElementById('d_name').innerText = getFullDisplayTitle(m);
        document.getElementById('d_id').innerText = m.id;
        const kromEl = document.getElementById('d_krom');
        
        const isHighRoyalTitle = isActiveMonarch || (m.isHeir && parseInt(m.heirOrder) === 1);
        if(m.kromRank && m.kromTitle && !isHighRoyalTitle) { 
            kromEl.innerText = `${m.kromRank}${m.kromTitle}`; 
            kromEl.classList.remove('hidden'); 
        } else { 
            kromEl.classList.add('hidden'); 
        }
        
        const badgesContainer = document.getElementById('d_badges'); badgesContainer.innerHTML = '';
        
        if (m.isMonarch && m.isExMonarch && m.isAlive) { // NEW: Ex-Monarch Badge
             const reignNum = m.globalReignNumber ? `‡∏£. ${toThaiNumerals(m.globalReignNumber)}` : '';
             const b = document.createElement('div');
             b.className = "bg-purple-100 text-purple-800 border border-purple-300 px-3 py-1 rounded-full text-xs font-bold";
             b.innerText = `‡∏≠‡∏î‡∏µ‡∏ï‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå ${reignNum}`; badgesContainer.appendChild(b);
        } else if (m.isMonarch && m.useReignName && m.reignNameBase && !m.isExMonarch) {
            let reignTxt = m.reignNameBase;
            const autoNum = getReignNameRank(m);
            if(autoNum) reignTxt += `‡∏ó‡∏µ‡πà ${toThaiNumerals(autoNum)}`;
            const b = document.createElement('div');
            b.className = "bg-yellow-100 text-yellow-800 border border-yellow-300 px-3 py-1 rounded-full text-xs font-bold";
            b.innerText = reignTxt; badgesContainer.appendChild(b);
        }
        
        if (m.isQueenConsort) {
            const b = document.createElement('div');
            b.className = "bg-pink-100 text-pink-800 border border-pink-300 px-3 py-1 rounded-full text-xs font-bold";
            b.innerText = "‡∏°‡πÄ‡∏´‡∏™‡∏µ‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå"; badgesContainer.appendChild(b);
        }
        if (m.isHeir) {
            const b = document.createElement('div');
            b.className = "bg-red-100 text-red-800 border border-red-300 px-3 py-1 rounded-full text-xs font-bold";
            b.innerText = `‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${toThaiNumerals(m.heirOrder)}`; badgesContainer.appendChild(b);
        }
        
        // --- DETAIL MODAL: Show Surname ONLY for the Founder (Per user request) ---
        // "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏™‡∏Å‡∏∏‡∏•‡∏ó‡∏µ‡πàpop-up ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∑‡∏ö‡∏™‡∏Å‡∏∏‡∏•" -> Show only for founder
        if (m.isRoyalSurnameFounder && m.royalSurname) {
            const b = document.createElement('div');
            b.className = "bg-indigo-100 text-indigo-800 border border-indigo-300 px-3 py-1 rounded-full text-xs font-bold";
            b.innerText = `‡∏î‡∏±‡∏ô‡∏£‡∏≤‡∏ä‡∏™‡∏Å‡∏∏‡∏• ${m.royalSurname}`; badgesContainer.appendChild(b);
        }
        // --- END DETAIL MODAL SURNAME ---

        const dTerm = m.isAlive ? "‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" : getDeathTerm(m);
        document.getElementById('d_status').innerHTML = m.isAlive ? `<span class="text-emerald-600">${dTerm}</span>` : `<span class="text-slate-500">${dTerm}</span>`;
        
        document.getElementById('d_birthYear').innerText = m.birthYear ? toThaiNumerals(m.birthYear) : "-"; 

        document.getElementById('d_spouses_count').innerText = (m.spouseIds||[]).length + " ‡∏Ñ‡∏ô";
        document.getElementById('d_umbrella').innerText = m.hasUmbrella ? m.umbrellaType : "-";
        const cr = document.getElementById('d_crown');
        if(m.isMonarch || m.isQueenConsort) { 
            cr.classList.remove('hidden'); 
            cr.className = `fa-solid fa-crown absolute -top-6 left-1/2 -translate-x-1/2 text-3xl drop-shadow-md ${isActiveMonarch ?'text-yellow-400 animate-pulse':'text-slate-500'}`; 
        } else { 
            cr.classList.add('hidden'); 
        }
        
        state.viewRootId = id; 
        document.getElementById('detailModal').classList.add('active');
    }

    // ================= END NEW SPOUSE SELECTION MODAL LOGIC =================
   // ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <script>
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ç‡∏ì‡∏∞‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ê‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏µ‡∏û
 */
function promoteMomChao() {
    const p = state.members.find(m => m.id === window.curPID);
    if (!p) return;

    const currentTitle = getFullDisplayTitle(p);
    const statusText = p.isAlive ? "" : " (‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏±‡∏ê‡∏¥)";
    
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${currentTitle} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤${statusText}?`)) return;

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏®‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
    p.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"; 
    p.titlePrefix = "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    p.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";

    // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÉ‡∏ô‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏û‡∏£‡∏∞‡∏¢‡∏® (Title History)
    recordTitleHistory(p);

    // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    saveState();
    showDetail(p.id); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Pop-up ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateApp();      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ú‡∏±‡∏á (Node ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ/‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà)
    
    showToast(`‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤ ${p.name} ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®`);
} 
    
function recordTitleHistory(p) {
    if (!p.titleHistory) p.titleHistory = [];
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
    const currentReign = activeMonarch ? `‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà ${toThaiNumerals(activeMonarch.globalReignNumber)}` : "‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•/‡∏õ‡∏ê‡∏°‡∏ß‡∏á‡∏®‡πå";
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° isExMonarch ‡πÅ‡∏•‡∏∞ monarchSpouseContext ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏£‡πâ‡∏≠‡∏¢
    const currentDataSignature = [
        p.relationship,
        p.titlePrefix,
        p.royalRank,
        p.name,
        p.titleSuffix,
        p.kromRank,
        p.kromTitle,
        p.isExMonarch,        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå
        p.monarchSpouseContext // ‡∏™‡∏£‡πâ‡∏≠‡∏¢ "‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà..."
    ].join('|');
    
    const lastEntry = p.titleHistory[p.titleHistory.length - 1];
    const lastSignature = lastEntry ? lastEntry.signature : null;
    
    if (currentDataSignature !== lastSignature) {
        const fullTitle = getFullDisplayTitle(p);
        p.titleHistory.push({ 
            title: fullTitle, 
            reign: currentReign, 
            year: new Date().getFullYear() + 543,
            signature: currentDataSignature 
        });
    }
}

/// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡πÅ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å ‡πÅ‡∏•‡∏∞ ‡∏û‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏≤‡∏ô
function triggerHierarchyPromotion(personId, newRank, fullTitle) {
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡πà)
    const children = state.members.filter(m => m.motherId === personId || m.fatherId === personId);
    
    children.forEach(child => {
        const isMale = child.gender === 'M';
        let updated = false;
        let oldRank = child.royalRank;

        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤) ---
        const activeMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
        const isSpouseOfCurrentKing = activeMonarch && (activeMonarch.spouseIds || []).includes(personId);

        if (isSpouseOfCurrentKing) {
            const rankEkKeywords = ["‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏≠‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ"];
            const rankThoKeywords = ["‡∏û‡∏£‡∏∞‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏≤‡∏è", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤", "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠", "‡∏û‡∏£‡∏∞‡∏≠‡∏£‡∏£‡∏Ñ‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤", "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ä‡∏≤‡∏¢‡∏≤"];

            if (rankEkKeywords.some(key => fullTitle.includes(key))) {
                child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
                child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
                updated = true;
            } else if (rankThoKeywords.some(key => fullTitle.includes(key))) {
                child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)";
                child.titlePrefix = isMale ? "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠";
                updated = true;
            }
        }

       // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏û‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏û‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤) ---
        if (newRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤")) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡∏π‡∏Å‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å/‡πÇ‡∏ó)
            if (child.royalRank !== "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)" && child.royalRank !== "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)") {
                
                // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏°‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                const mother = state.members.find(m => m.id === child.motherId);
                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const isMotherChaoFa = mother && (mother.royalRank && mother.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤"));

                if (isMotherChaoFa) {
                    // ‡∏Å‡∏é: ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤" (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)
                    child.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
                    child.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
                } else {
                    // ‡∏Å‡∏é: ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ + ‡πÅ‡∏°‡πà‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ (‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô/‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤) -> ‡∏•‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤"
                    child.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤";
                    child.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤";
                }
                
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥: ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á ---
                child.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠"; 
                
                updated = true;
            }
        }
        // ‡∏ñ‡πâ‡∏≤‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" -> ‡∏•‡∏π‡∏Å‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"
        else if (newRank === "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤" && (child.royalRank === "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô" || !child.royalRank)) {
            child.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            child.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
            updated = true;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏ô (Recursive)
        if (updated && oldRank !== child.royalRank) {
            recordTitleHistory(child);
            showToast(`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏™‡∏≤‡∏¢‡πÇ‡∏•‡∏´‡∏¥‡∏ï: ${child.name} ‡πÄ‡∏õ‡πá‡∏ô ${child.royalRank}`);
            // ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡πÉ‡∏´‡πâ "‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏ô" ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
            triggerHierarchyPromotion(child.id, child.royalRank, child.titlePrefix);
        }
    });
}

    function handleSavePerson(e) {
        try {
            e.preventDefault();
            const id = document.getElementById('p_id').value || Date.now().toString();
            const isEdit = document.getElementById('p_isEditMode').value === 'true';
            
            const spouseIds = [];
            document.getElementById('p_spouseList').querySelectorAll('li').forEach(li => spouseIds.push(li.dataset.id));

            const oldP = isEdit ? state.members.find(x => x.id === id) : null;

            const isFounder = document.getElementById('p_isSurnameFounder').checked;
            const rank = document.getElementById('p_royalRank').value;
            const commonerInput = document.getElementById('p_commonerSurnameInput').value;
            const royalInput = document.getElementById('p_royalSurnameInput').value;

            let p = {
                id: id,
                name: document.getElementById('p_name').value || '-',
                nickname: document.getElementById('p_nickname').value || '',
                gender: document.querySelector('input[name="gender"]:checked').value,
                isAlive: document.getElementById('p_isAlive').checked,
                relationship: document.getElementById('p_relationship').value,
                titlePrefix: document.getElementById('p_titlePrefix').value || '',
                titleSuffix: document.getElementById('p_titleSuffix').value || '',
                royalRank: document.getElementById('p_royalRank').value,
                kromRank: document.getElementById('p_kromRank').value || '',
                kromTitle: document.getElementById('p_kromTitle').value || '',
                isMonarch: document.getElementById('p_isMonarch').checked,
                isHeir: document.getElementById('p_isHeir').checked,
                heirOrder: document.getElementById('p_heirOrder').value || null,
                isQueenConsort: document.getElementById('p_isQueenConsort').checked,
                useReignName: document.getElementById('p_useReignName').checked,
                reignNameBase: document.getElementById('p_reignNameSelect').value || '',
                globalReignNumber: document.getElementById('p_globalReignNumber').value || null,
                reignStart: document.getElementById('p_reignStart').value || '',
                reignEnd: document.getElementById('p_reignEnd').value || '',
                eraName: document.getElementById('p_eraName').value || '',
                hasUmbrella: document.getElementById('p_hasUmbrella').checked,
                umbrellaType: document.getElementById('p_umbrellaType').value,
                image: document.getElementById('p_imageFinal').value,
                fatherId: document.getElementById('p_fatherId').value || null,
                motherId: document.getElementById('p_motherId').value || null,
                spouseIds: spouseIds,
                hideRoyalRank: document.getElementById('p_hideRoyalRank').checked,
                birthYear: document.getElementById('p_birthYear').value || null,
                
                // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    titleHistory: oldP?.titleHistory || [], 
    // ----------------------------

    isRoyalSurnameFounder: isFounder,
                // --- Surname Logic Mapping ---
                // isRoyalSurnameFounder: Use checkbox state if checked, otherwise default to false (or keep old if editing)
                isRoyalSurnameFounder: isFounder,

                // royalSurname: Set only if this person is a founder OR inherit from old value for non-founders
                royalSurname: isFounder ? royalInput : (oldP?.royalSurname || ''),
                
                // surname: Set only if rank is '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' and they are NOT a founder (used for *non-royal* commoner lineage display)
                surname: (rank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' && !isFounder) ? commonerInput : '', 
                
                // NEW: Hide Surname State
                hideSurname: document.getElementById('p_hideSurname').checked,

                // NEW: Ex-Monarch Flag (Retain old state if editing and Monarch status hasn't changed drastically)
                // MODIFICATION: Preserve old Ex-Monarch state only if isMonarch is still true, otherwise clear it.
                isExMonarch: (oldP?.isExMonarch || false) && (document.getElementById('p_isMonarch').checked || false),

                monarchSpouseContext: (oldP && oldP.monarchSpouseContext && oldP.relationship === document.getElementById('p_relationship').value) ? oldP.monarchSpouseContext : null
            };
            
            // --- NEW: Auto-inherit Royal Surname if not explicitly set and parent has one ---
            // If the person is NOT an explicit founder, inherit the name from the parent lineage
            if (!p.isRoyalSurnameFounder && !p.surname) { // Check that they aren't marked as founder AND aren't a commoner with a commoner surname
                 const father = state.members.find(m => m.id === p.fatherId);
                 const mother = state.members.find(m => m.id === p.motherId);

                 // Priority 1: Father's Royal Surname
                 if (father?.royalSurname) {
                     p.royalSurname = father.royalSurname;
                 } 
                 // Priority 2: Mother's Royal Surname (if father doesn't have one or is commoner)
                 else if (mother?.royalSurname) {
                     p.royalSurname = mother.royalSurname;
                 }
                 // Priority 3: Spouse's Royal Surname (for new spouse added)
                 else if (!isEdit && spouseIds.length > 0) {
                      const primarySpouse = state.members.find(s => s.id === spouseIds[0]);
                      if (primarySpouse?.royalSurname) {
                          p.royalSurname = primarySpouse.royalSurname;
                      }
                 }
            }


            if (p.isMonarch) {
                p.kromRank = '';
                p.kromTitle = '';
                p.isExMonarch = false; // Cannot edit to be Ex-Monarch while setting as Monarch
            } else if (oldP?.isMonarch) {
                 // If changing from Monarch (isMonarch=true) to non-Monarch (isMonarch=false) during edit, it should probably be an abdication or a death process, not a simple form edit.
                 // We preserve oldExMonarch state here to allow a deceased Ex-Monarch to be edited.
                 p.isExMonarch = oldP.isExMonarch; 
            }
            
            p = checkConsortMotherhood(p);
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î Save ---
        recordTitleHistory(p); 
        // -----------------------------------------------------------

            if(isEdit) {
                const idx = state.members.findIndex(m => m.id === id);
                if(idx !== -1) {
                    const old = state.members[idx];
                    old.spouseIds.forEach(sid => { if(!spouseIds.includes(sid)) { const s = state.members.find(x => x.id === sid); if(s) s.spouseIds = s.spouseIds.filter(x => x !== id); } });
                    state.members[idx] = p;
                }
            } else {
                state.members.push(p);
            }

            spouseIds.forEach(sid => { const s = state.members.find(x => x.id === sid); if(s && !s.spouseIds.includes(id)) s.spouseIds.push(id); });

            if(p.isMonarch && p.gender === 'M') {
                const selectedQueenId = document.getElementById('p_queenSelectForKing').value;
                p.spouseIds.forEach(sid => {
                    const s = state.members.find(m => m.id === sid);
                    if(s) s.isQueenConsort = false;
                });
                if(selectedQueenId) {
                    const q = state.members.find(m => m.id === selectedQueenId);
                    if(q) q.isQueenConsort = true;
                }
            }
            
            // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 1750 ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleSavePerson ---

if (!isEdit && (p.fatherId || p.motherId)) {
    [p.fatherId, p.motherId].forEach(parentId => {
        if (parentId) {
            const parent = state.members.find(m => m.id === parentId);
            if (parent) {
                const updatedParent = checkConsortMotherhood(parent);
                
                // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏®‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏•‡∏π‡∏Å]
                recordTitleHistory(updatedParent); 
                // ----------------------------------------------------

                const idx = state.members.findIndex(x => x.id === parentId);
                if(idx !== -1) state.members[idx] = updatedParent;
            }
        }
    });
}
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏¢ (‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏ô)
            const currentFullTitle = getFullDisplayTitle(p);
            triggerHierarchyPromotion(p.id, p.royalRank, currentFullTitle);
saveState();
            closeModal('personModal');
            if(p.isMonarch && !isEdit && p.isAlive) showFantasyPopup(p);
            
            // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å refreshAllDisplays(); ‡πÄ‡∏õ‡πá‡∏ô updateApp(); ‡πÅ‡∏•‡πâ‡∏ß
            updateApp(); 
            
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } catch (err) {
            console.error(err);
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ updateApp ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå alert ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);
        }
    }

    function openModal(d={}, edit=false, contextTitle=null) {
        try {
            const f = document.getElementById('personForm'); f.reset();
            document.getElementById('p_isEditMode').value = edit;
            const titleEl = document.getElementById('modalTitle');
            if(contextTitle) { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (${contextTitle})`; } 
            else { titleEl.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•`; }
            if (!edit && !d.gender) { const mRadio = document.querySelector('input[name="gender"][value="M"]'); if(mRadio) mRadio.checked = true; } 
            else if(d.gender) { document.querySelector(`input[name="gender"][value="${d.gender}"]`).checked = true; }
            
            // --- NEW RANK CALCULATION LOGIC ---
            let calculatedRank = {};
            if (!edit && (d.fatherId || d.motherId)) {
                const currentMonarch = state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
                const gender = d.gender || document.querySelector('input[name="gender"]:checked').value;
                
                if (currentMonarch && (d.fatherId === currentMonarch.id || d.motherId === currentMonarch.id)) {
                    const monarchParentId = d.fatherId === currentMonarch.id ? d.fatherId : d.motherId;
                    const otherParentId = d.fatherId === currentMonarch.id ? d.motherId : d.fatherId;
                    calculatedRank = calculateChildRank(monarchParentId, otherParentId, gender);
                } else {
                    calculatedRank = calculateChildRankGeneric(d.fatherId, d.motherId, gender);
                }
                
                // Apply calculated rank and names
                d.royalRank = calculatedRank.royalRank;
                d.titlePrefix = calculatedRank.titlePrefix;
                d.relationship = calculatedRank.relationship;
                // If it's a new person, use the calculated surname for display
                d.royalSurname = d.royalSurname || calculatedRank.royalSurname; 
                d.surname = d.surname || calculatedRank.surname;
            }
            // --- END NEW RANK CALCULATION LOGIC ---
            
            document.getElementById('p_royalRank').value = d.royalRank || '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
            document.getElementById('p_hideRoyalRank').checked = !!d.hideRoyalRank;
            if(!edit) { updateAutoId(); } else { document.getElementById('p_id').value = d.id || ''; }
            document.getElementById('p_name').value = d.name || '';
            document.getElementById('p_nickname').value = d.nickname || '';
            document.getElementById('p_isAlive').checked = d.isAlive !== false;
            
            document.getElementById('p_birthYear').value = d.birthYear || ''; 
            
            // NEW: Load surname fields and toggles
            // A person is marked as founder ONLY if their saved data explicitly says so (d.isRoyalSurnameFounder).
            // This prevents descendants/spouses who auto-inherit the name from being marked as founders.
            const isFounder = !!d.isRoyalSurnameFounder;
            document.getElementById('p_isSurnameFounder').checked = isFounder;
            document.getElementById('p_royalSurnameInput').value = d.royalSurname || ''; // Shows inherited royal surname
            document.getElementById('p_commonerSurnameInput').value = d.surname || '';
            // NEW: Hide Surname Checkbox
            document.getElementById('p_hideSurname').checked = !!d.hideSurname;
            
            populateRelSelect(d.relationship);
            updatePrefixOptions(d.titlePrefix);
            updateSuffixOptions(d.titleSuffix);
            document.getElementById('p_fatherId').value = d.fatherId || '';
            document.getElementById('p_fatherSearch').value = d.fatherId ? (state.members.find(x=>x.id==d.fatherId)?.name || d.fatherId) : '';
            document.getElementById('p_motherId').value = d.motherId || '';
            document.getElementById('p_motherSearch').value = d.motherId ? (state.members.find(x=>x.id==d.motherId)?.name || d.motherId) : '';
            
            // MODIFICATION: The checkbox value is based directly on the historical data (d.isMonarch)
            document.getElementById('p_isMonarch').checked = !!d.isMonarch;
            
            document.getElementById('p_useReignName').checked = !!d.useReignName;
            populateReignSelect(d.reignNameBase);
            if(!edit && d.isMonarch === undefined) {
                 const monarchs = state.members.filter(x => x.isMonarch);
                 const maxGlobal = Math.max(0, ...monarchs.map(x => parseInt(x.globalReignNumber||0)));
                 document.getElementById('p_globalReignNumber').value = maxGlobal + 1;
            } else { document.getElementById('p_globalReignNumber').value = d.globalReignNumber || ''; }
            document.getElementById('p_reignStart').value = d.reignStart || '';
            document.getElementById('p_reignEnd').value = d.reignEnd || '';
            document.getElementById('p_eraName').value = d.eraName || '';
            toggleMonarch();
            document.getElementById('p_isHeir').checked = !!d.isHeir;
            document.getElementById('p_heirOrder').value = d.heirOrder || '';
            toggleHeirOrder();
            document.getElementById('p_isQueenConsort').checked = !!d.isQueenConsort;
            document.getElementById('p_hasUmbrella').checked = !!d.hasUmbrella;
            document.getElementById('p_umbrellaType').value = d.umbrellaType || '‡∏ï‡∏£‡∏µ‡∏î‡∏•‡πÄ‡∏®‡∏ß‡∏ï‡∏â‡∏±‡∏ï‡∏£';
            toggleUmbrella();
            document.getElementById('p_kromRank').value = d.kromRank || '';
            document.getElementById('p_kromTitle').value = d.kromTitle || '';
            toggleKrom();
            const ul = document.getElementById('p_spouseList'); ul.innerHTML = '';
            (d.spouseIds || []).forEach(sid => { const s = state.members.find(x => x.id === sid); if(s) addSpouseLi(s); });
            document.getElementById('p_imagePreview').src = d.image || (d.gender==='F'?DEFAULT_IMG_FEMALE:DEFAULT_IMG_MALE);
            document.getElementById('p_imageFinal').value = d.image || '';
            
            if (d.fatherOptions || d.motherOptions) {
                updateDatalists(d.id, d.fatherOptions, d.motherOptions);
            } else {
                updateDatalists(d.id);
            }

            updateQueenConsortSelector(d);
            setTimeout(checkQueenConsortEligible, 100);
            toggleSurnameFields(); // Initialize visibility of new fields
            document.getElementById('personModal').classList.add('active');
        } catch(e) { console.error(e); }
    }

    function openAddRootModal() { openModal({}); }
    function editCurrent() { closeModal('detailModal'); openModal(state.members.find(m=>m.id===window.curPID), true); }
    
    function toggleDeath() { 
    const p = state.members.find(m => m.id === window.curPID); 
    const wasActiveMonarch = p.isMonarch && p.isAlive && !p.isExMonarch;
    
    p.isAlive = !p.isAlive; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏õ‡πá‡∏ô/‡∏ï‡∏≤‡∏¢

    if (!p.isAlive) { 
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏±‡∏ä‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (p.isHeir) {
            handleHeirDeath(p);
        }
        if (wasActiveMonarch) {
            handleMonarchDeath(p); 
        }
    } else {
        p.monarchSpouseContext = null; 
    }
        if (p.gender === 'F' && (p.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤')) {
            const updatedP = checkConsortMotherhood(p);
            p.titlePrefix = updatedP.titlePrefix; 
        }
       saveState(); 
    showDetail(p.id); 
    updateApp(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏ú‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Real-time)
}
    
    function deleteCurrent() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
        const id = window.curPID;
        state.members = state.members.filter(m => m.id !== id);
        state.members.forEach(m => {
            if(m.fatherId === id) m.fatherId = null;
            if(m.motherId === id) m.motherId = null;
            m.spouseIds = m.spouseIds.filter(sid => sid !== id);
        });
        const possibleMothers = state.members.filter(m => (m.relationship||'').includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') && m.gender === 'F');
        possibleMothers.forEach(m => {
            const updatedM = checkConsortMotherhood(m);
            if (updatedM.titlePrefix !== m.titlePrefix) {
                const idx = state.members.findIndex(x => x.id === m.id);
                if(idx !== -1) state.members[idx] = updatedM;
            }
        });
        
        saveState(); closeModal('detailModal'); refreshAllDisplays();
    }

    function openRelationshipModal() {
        document.getElementById('rel_input_a').value = '';
        document.getElementById('rel_input_b').value = '';
        document.getElementById('rel_id_a').value = '';
        document.getElementById('rel_id_b').value = '';
        document.getElementById('rel_img_a').src = '';
        document.getElementById('rel_img_b').src = '';
        
        const dl = document.getElementById('relOptions');
        dl.innerHTML = '';
        state.members.forEach(m => {
            const op = document.createElement('option');
            op.value = `${m.id} : ${m.name}`;
            dl.appendChild(op);
        });
        
        document.getElementById('relationshipModal').classList.add('active');
    }

    function updateRelPreview(side) {
        const input = document.getElementById(`rel_input_${side}`).value;
        const match = input.match(/^(.*?)\s*:\s*(.*)$/);
        let id = null;
        if(match) {
            id = match[1].trim();
        } else {
             const m = state.members.find(x => x.name === input.trim());
             if (m) id = m.id;
        }

        if(id) {
            const m = state.members.find(x => x.id === id);
            if(m) {
                document.getElementById(`rel_id_${side}`).value = id;
                document.getElementById(`rel_img_${side}`).src = m.image || (m.gender==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE);
                document.getElementById(`rel_img_${side}`).classList.remove('opacity-50');
                return;
            }
        }
        document.getElementById(`rel_id_${side}`).value = '';
        document.getElementById(`rel_img_${side}`).src = '';
        document.getElementById(`rel_img_${side}`).classList.add('opacity-50');
    }

    function calculateRelationship() {
        const idA = document.getElementById('rel_id_a').value;
        const idB = document.getElementById('rel_id_b').value;
        
        if(!idA || !idB) { showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô"); return; }
        if(idA === idB) { showToast("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô"); return; }
        
        const path = findRelationshipPath(idA, idB);
        
        if(!path) {
            showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ");
            return;
        }

        closeModal('relationshipModal');
        state.highlightIds = [idA, idB];
        const midId = path[Math.floor(path.length/2)];
        state.viewRootId = midId; 
        state.treeViewType = 'all'; 
        
        saveState();
        renderTree();
        resetView();
        showToast("‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡πâ‡∏ß");
        setTimeout(() => { state.highlightIds = []; renderTree(); }, 5000);
    }

    function findRelationshipPath(startId, endId) {
        const queue = [[startId]];
        const visited = new Set();
        visited.add(startId);
        
        while (queue.length > 0) {
            const path = queue.shift();
            const node = path[path.length - 1];
            
            if (node === endId) return path;
            
            const neighbors = [];
            const m = state.members.find(x => x.id === node);
            if(m) {
                if(m.fatherId) neighbors.push(m.fatherId);
                if(m.motherId) neighbors.push(m.motherId);
                if(m.spouseIds) neighbors.push(...m.spouseIds);
                state.members.filter(c => c.fatherId === node || c.motherId === node).forEach(c => neighbors.push(c.id));
            }
            
            for (const neighbor of neighbors) {
                if (!visited.has(neighbor)) {
                    visited.add(neighbor);
                    const newPath = [...path, neighbor];
                    queue.push(newPath);
                }
            }
        }
        return null;
    }

    function setAsRoot(id) { 
        state.viewRootId = id; 
        
        // NEW LOGIC: Auto-switch to Royal Surname View if the person belongs to one
        const founderId = getSurnameFounderForPerson(id);
        
        if (founderId) {
            state.treeViewType = 'royalSurname';
            state.currentSurnameRootId = founderId;
            // Update the dropdown immediately for visual feedback
            document.getElementById('treeViewMode').value = 'royalSurname';
        } else if (state.treeViewType === 'royalSurname') {
            // If they don't have a surname, but we were in surname view, reset to 'all'
             state.treeViewType = 'all';
             document.getElementById('treeViewMode').value = 'all';
        }
        
        saveState(); 
        closeModal('detailModal'); 
        renderTree(); 
        resetView(); 
    }
    function focusOnPerson(val) { 
        const id = val.split(':')[0].trim(); 
        if(state.members.find(m => m.id === id)) { 
            state.viewRootId = id; 
            renderTree(); 
        } 
    }
    function focusOnMonarch() { const m = state.members.find(x => x.isMonarch && x.isAlive && !x.isExMonarch); if(m) { state.viewRootId = m.id; renderTree(); resetView(); } }
    function populateSearchLists() { const dl = document.getElementById('focusOptions'); dl.innerHTML = ''; state.members.forEach(m => { const op = document.createElement('option'); op.value = `${m.id} : ${m.name}`; dl.appendChild(op); }); }
    function openAddParentModal(childId) { closeModal('detailModal'); openModal({}); showToast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥ ID ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‡∏û‡∏£‡∏∞‡∏ö‡∏¥‡∏î‡∏≤/‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤ ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å"); }
    
    // NOTE: openAddSpouseModal is now openSpouseSelectionModal
    // function openAddSpouseModal(id) { closeModal('detailModal'); const m = state.members.find(x => x.id === id); openModal({ spouseIds: [id], gender: m.gender==='M'?'F':'M' }, false, `‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á ${m.name}`); }
    
    function openAddChildModal(id) { 
        closeModal('detailModal'); 
        const m = state.members.find(x => x.id === id); 
        
        const defaults = m.gender === 'M' ? { fatherId: id } : { motherId: id }; 
        
        const spouseObjects = (m.spouseIds || [])
            .map(sid => state.members.find(x => x.id === sid))
            .filter(s => s);
            
        let otherParentId = null;
        let filteredParentList = []; 
        
        if (spouseObjects.length > 0) {
            const requiredGender = m.gender === 'M' ? 'F' : 'M';
            filteredParentList = spouseObjects.filter(s => s.gender === requiredGender);

            if (filteredParentList.length === 1) {
                otherParentId = filteredParentList[0].id;
            }
        }
        
        if (otherParentId) {
            if (m.gender === 'M') {
                defaults.motherId = otherParentId;
            } else {
                defaults.fatherId = otherParentId;
            }
        }

        if (m.gender === 'M') {
             defaults.motherOptions = filteredParentList;
        } else {
             defaults.fatherOptions = filteredParentList;
        }

        openModal(defaults, false, `‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ${m.name}`); 
        
        const otherInputId = m.gender === 'M' ? 'p_motherSearch' : 'p_fatherSearch';
        const type = m.gender === 'M' ? 'mother' : 'father';
        const inputEl = document.getElementById(otherInputId);
        if(inputEl) {
            inputEl.onchange = function() {
                validateParent(type);
                setTimeout(() => {
                    const baseTitle = `‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á ${m.name}`;
                    const otherParent = state.members.find(x => x.id === document.getElementById(type==='mother'?'p_motherId':'p_fatherId').value);
                    const newTitle = otherParent ? `${baseTitle} ‡∏Å‡∏±‡∏ö ${otherParent.name}` : baseTitle;
                    document.getElementById('modalTitle').innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (${newTitle})`;
                }, 100);
            };
            if (otherParentId) {
                const autoSelectedParent = state.members.find(x => x.id === otherParentId);
                if (autoSelectedParent) {
                    inputEl.value = autoSelectedParent.name;
                }
            }
        }
    }
    
    function toggleReignName() { const u = document.getElementById('p_useReignName').checked; document.getElementById('p_reignNameSelect').classList.toggle('hidden', !u); document.getElementById('p_autoReignNameNumber').classList.toggle('hidden', !u); }
    function toggleHeirOrder() { const h = document.getElementById('p_isHeir').checked; document.getElementById('p_heirOrder').classList.toggle('hidden', !h); }
    function toggleUmbrella() { const h = document.getElementById('p_hasUmbrella').checked; document.getElementById('p_umbrellaType').classList.toggle('hidden', !h); }
    function toggleKrom() { const v = document.getElementById('p_kromRank').value; document.getElementById('p_kromTitle').classList.toggle('hidden', !v); }
    function populateReignSelect(selVal) { const s = document.getElementById('p_reignNameSelect'); s.innerHTML = ''; state.reignNames.forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); if(selVal) s.value = selVal; }
  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏î‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®)
function populateRelSelect(v) { 
    const s = document.getElementById('p_relationship'); 
    s.innerHTML = '<option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå -</option>'; 
    
    // ‡∏î‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏®‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    Object.keys(state.hierarchy).forEach(rel => {
        const op = new Option(rel, rel);
        s.add(op);
    });

    if(v) s.value = v; 
    s.onchange = () => updatePrefixOptions();
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ô‡∏±‡πâ‡∏ô)
function updatePrefixOptions(v) { 
    const rel = document.getElementById('p_relationship').value; 
    const s = document.getElementById('p_titlePrefix'); 
    s.innerHTML = '<option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ -</option>'; 
    
    if(rel && state.hierarchy[rel]) {
        state.hierarchy[rel].prefixes.forEach(p => {
            s.add(new Option(p, p));
        });
    }
    
    if(v) s.value = v; 
    s.onchange = () => {
        updateSuffixOptions();
        checkQueenConsortEligible(); 
    };
    
    updateSuffixOptions(); 
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° (‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
function updateSuffixOptions(v) { 
    const rel = document.getElementById('p_relationship').value; 
    const pre = document.getElementById('p_titlePrefix').value; 
    const s = document.getElementById('p_titleSuffix'); 
    s.innerHTML = '<option value="">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏£‡πâ‡∏≠‡∏¢ -</option>'; 
    
    if(rel && pre && state.hierarchy[rel] && state.hierarchy[rel].suffixes[pre]) {
        state.hierarchy[rel].suffixes[pre].forEach(x => {
            s.add(new Option(x, x));
        });
    }
    
    if(v) s.value = v; 
}
    
    function updateDatalists(selfId, filteredFatherList, filteredMotherList) { 
        const fo = document.getElementById('fatherOptions'); fo.innerHTML=''; 
        const mo = document.getElementById('motherOptions'); mo.innerHTML=''; 
        const so = document.getElementById('spouseOptions'); so.innerHTML=''; 
        
        let fatherCandidates = filteredFatherList || state.members.filter(m => m.gender === 'M');
        let motherCandidates = filteredMotherList || state.members.filter(m => m.gender === 'F');

        fatherCandidates.forEach(m => {
            if(m.id === selfId) return; 
            const op = document.createElement('option'); 
            op.value = m.id; 
            op.innerText = m.name; 
            fo.appendChild(op);
        });

        motherCandidates.forEach(m => {
            if(m.id === selfId) return; 
            const op = document.createElement('option'); 
            op.value = m.id; 
            op.innerText = m.name; 
            mo.appendChild(op);
        });
        
        state.members.forEach(m => { 
            if(m.id === selfId) return; 
            const op = `<option value="${m.id}">${m.name}</option>`;
            so.innerHTML += op; 
        });
    }

    function validateParent(type) { const i = document.getElementById(type==='father'?'p_fatherSearch':'p_motherSearch'); const h = document.getElementById(type==='father'?'p_fatherId':'p_motherId'); const val = i.value.trim(); const found = state.members.find(m => m.id === val || m.name === val); if(found) { h.value = found.id; i.value = found.name; } else { h.value = ''; } }
    function addSpouse() { 
        const val = document.getElementById('p_spouseSearch').value; 
        const m = state.members.find(x => x.id === val || x.name === val); 
        if(m) { 
            const ul = document.getElementById('p_spouseList'); 
            if([...ul.children].some(li => li.dataset.id === m.id)) { showToast("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"); return; }
            addSpouseLi(m); 
            document.getElementById('p_spouseSearch').value = ''; 
            updateQueenConsortSelector(); 
        } 
    }
    function addSpouseLi(m) { const ul = document.getElementById('p_spouseList'); const li = document.createElement('li'); li.className = "bg-rose-50 text-rose-600 px-2 py-1 rounded-lg flex items-center gap-2 border border-rose-100"; li.dataset.id = m.id; li.innerHTML = `<span>${m.name}</span> <button type="button" onclick="this.parentElement.remove(); updateQueenConsortSelector()" class="text-rose-300 hover:text-red-500">√ó</button>`; ul.appendChild(li); }
    function handleImageUpload(i){ const r=new FileReader(); r.onload=e=>{ document.getElementById('p_imagePreview').src=e.target.result; document.getElementById('p_imageFinal').value=e.target.result; }; if(i.files[0]) r.readAsDataURL(i.files[0]); }
    function updateDefaultImage(){ if(!document.getElementById('p_imageFinal').value) document.getElementById('p_imagePreview').src = document.querySelector('input[name="gender"]:checked').value==='M'?DEFAULT_IMG_MALE:DEFAULT_IMG_FEMALE; }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = msg; c.appendChild(t); setTimeout(()=>t.remove(), 3000); }
    function copyToClipboard(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÅ‡∏•‡πâ‡∏ß'); }
    function setTheme(t) { document.body.setAttribute('data-theme', t); state.currentTheme=t; saveState(); }

    // ================= PAN & ZOOM FIXES (VERIFIED SMOOTH DRAGGING) =================
    function setupPanZoom() { 
        const c = document.getElementById('canvas-container'); 
        
        // MOUSE DOWN: Start Dragging, prevent default browser behavior (e.g., text selection)
        c.addEventListener('mousedown',e=>{ 
            // Only start drag if clicking on the main SVG or the viewport group (not a node or control)
            if(e.target.id!=='main-svg' && e.target.id!=='viewport-group') return; 
            e.preventDefault(); 
            state.isDragging=true; 
            state.startX=e.clientX-state.panX; 
            state.startY=e.clientY-state.panY; 
        }); 
        
        // MOUSE UP: Stop Dragging
        window.addEventListener('mouseup',()=>{
            state.isDragging=false;
        }); 
        
        // MOUSE MOVE: Dragging action
        window.addEventListener('mousemove',e=>{ 
            if(!state.isDragging)return; 
            e.preventDefault(); // Prevents cursor change/jerkiness during drag (fixes lag/bug)
            state.panX=e.clientX-state.startX; 
            state.panY=e.clientY-state.startY; 
            updateTrans(); 
        }); 
        
        // WHEEL: Zooming
        c.addEventListener('wheel',e=>{ 
            e.preventDefault(); 
            state.zoom = Math.min(Math.max(0.1, state.zoom + (-e.deltaY*0.001)), 5); 
            updateTrans(); 
        }, {passive:false}); 
    }

    function updateTrans(){ document.getElementById('viewport-group').setAttribute("transform", `translate(${state.panX},${state.panY}) scale(${state.zoom})`); }
    function zoomIn(){ state.zoom *= 1.2; updateTrans(); }
    function zoomOut(){ state.zoom /= 1.2; updateTrans(); }
    function resetView(){ 
        // Get viewport size
        const canvas = document.getElementById('canvas-container');
        const vw = canvas.clientWidth;
        
        state.zoom=1; 
        state.panX=vw/2 - BASE_CONFIG.nodeWidth/2; 
        state.panY=50; 
        updateTrans(); 
    }
    function toggleOrientation(){ state.isHorizontal=!state.isHorizontal; renderTree(); resetView(); }
   function showHistoryModal(id) {
    const p = state.members.find(m => m.id === id);
    if (!p) return;
    
    if (!p.titleHistory || p.titleHistory.length === 0) recordTitleHistory(p);
    
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    
    p.titleHistory.forEach((h, index) => {
        const item = document.createElement('div');
        item.className = "relative pl-8 border-l-2 border-slate-100 pb-4 last:pb-0 group";
        item.innerHTML = `
            <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-200 border-2 border-white"></div>
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-500 inline-block mb-1">
                        ‡∏™‡∏°‡∏±‡∏¢${h.reign}
                    </div>
                    <div class="text-sm font-bold text-slate-700 leading-snug">${h.title}</div>
           
                </div>
                <button onclick="deleteHistoryEntry('${p.id}', ${index})" class="opacity-0 group-hover:opacity-100 p-1.5 text-red-300 hover:text-red-500 transition-all">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
            </div>
        `;
        list.appendChild(item);
    });
    
    document.getElementById('historyModal').classList.add('active');
}
function deleteHistoryEntry(personId, index) {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

    const p = state.members.find(m => m.id === personId);
    if (p && p.titleHistory) {
        p.titleHistory.splice(index, 1);
        saveState();
        showHistoryModal(personId); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö
        showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }
}
// ============================================================
// THE SUPREME ROYAL ENGINE 2025 - FINAL INTEGRATED (V27)
// ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏é: ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå | ‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå | ‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á | ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°/‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà | ‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ | ‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå
// ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: HYBRID COMMAND MODE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©: SMART SPOUSE SELECTION + AUTO-TRANSITION (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
// ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° | ‡∏¢‡∏®‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£ (Sticky Rank) | ‡πÅ‡∏°‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏û‡πà‡∏≠ | Dropdown Guard
// ============================================================

/**
 * 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
function getCurrentMonarch() {
    return state.members.find(m => m.isMonarch && m.isAlive && !m.isExMonarch);
}

/**
 * 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏® (Rank), ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (Prefix) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
 */
function calculateChildRank(fatherId, motherId, gender, birthYearInput) {
    const father = state.members.find(m => m.id === fatherId);
    const mother = state.members.find(m => m.id === motherId);
    const currentMonarch = getCurrentMonarch();
    const isMale = gender === 'M';
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏µ‡πà‡∏¢‡∏≤-‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
    const bYear = birthYearInput ? parseInt(birthYearInput) : null;
    
    const currentPersonId = document.getElementById('p_id')?.value;
    const monarchId = currentMonarch?.id;
    const monarchFatherId = currentMonarch?.fatherId;
    const monarchMotherId = currentMonarch?.motherId;
    const monarchBirthYear = currentMonarch?.birthYear ? parseInt(currentMonarch.birthYear) : 0;

    let result = {
        royalRank: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô',
        titlePrefix: isMale ? '‡∏ô‡∏≤‡∏¢' : '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß',
        relationship: '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô',
        royalSurname: father?.royalSurname || ''
    };

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 0: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏¢‡∏® (Rank Weighting) ---
    const rankWeight = {
        "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 10, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 9, "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 8,
        "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)": 7, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)": 6, "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)": 5,
        "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤": 4, "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå": 3, "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á": 2, "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô": 1
    };
    const fW = father ? (rankWeight[father.royalRank] || 1) : 1;
    const mW = mother ? (rankWeight[mother.royalRank] || 1) : 1;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: Sticky Rank Logic (‡∏¢‡∏®‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö) ---
    const currentPerson = state.members.find(m => m.id === currentPersonId);
    let isAlreadyPromoted = false;
    if (currentPerson && (currentPerson.royalRank.includes("‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤") || currentPerson.royalRank.includes("‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤") || currentPerson.royalRank.includes("‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå"))) {
        isAlreadyPromoted = true;
        result.royalRank = currentPerson.royalRank;
        result.titlePrefix = currentPerson.titlePrefix;
        result.relationship = currentPerson.relationship;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1.1: ‡∏Å‡∏é‡πÅ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏û‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô ---
    const isFatherCommoner = !father || (father.royalRank === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô' || father.titlePrefix === '‡∏ô‡∏≤‡∏¢');
    const isMotherRoyal = mother && (mW > 1);

    if (isFatherCommoner && isMotherRoyal && !isAlreadyPromoted) {
        result.relationship = '‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô (‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ó‡∏£‡∏á‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏±‡∏ô‡∏î‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå)';
        return result; 
    }

    if (!father && !mother) return result;

    // ============================================================
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏∞‡∏ö‡∏ö AUTO-TRANSITION (‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
    // ============================================================

    // A: ‡∏´‡∏≤‡∏Å‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ -> ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠)
    if (father && father.id === monarchId) {
        result.relationship = isMale ? '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏£‡∏™' : '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏¥‡∏î‡∏≤';
        if (mother && (mW >= 8 || (mother.titleSuffix && mother.titleSuffix.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä")))) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à" + (isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠");
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = (isMale ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠");
        }
        return result;
    }

    // B: ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏£‡πà‡∏ß‡∏°‡∏û‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) - ‡∏ó‡∏±‡πâ‡∏á‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà
    const isSiblingOfMonarch = father && monarchFatherId && String(father.id) === String(monarchFatherId);
    if (isSiblingOfMonarch && monarchId && currentPersonId !== monarchId) {
        const isSameMother = mother && mother.id === monarchMotherId;
        const isMotherHighRoyal = mother && (mW >= 8);
        
        result.relationship = isSameMother ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤" : "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏£‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤";
        
        let ageLabel = "";
        if (bYear && monarchBirthYear > 0) {
            const isOlder = bYear < monarchBirthYear;
            if (isMale) ageLabel = isOlder ? "‡∏û‡∏µ‡πà‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠";
            else ageLabel = isOlder ? "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠" : "‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
        } else {
            ageLabel = isMale ? "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡πÄ‡∏ò‡∏≠";
        }

        if (isMotherHighRoyal || isSameMother) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞" + ageLabel;
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏û‡∏£‡∏∞" + ageLabel; 
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: Logic ‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á ---
    const fKrom = father?.kromTitle || "";
    if (fKrom.includes("‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•") || fKrom.includes("‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏∏‡∏Ç")) {
        const isWangNa = fKrom.includes("‡∏ö‡∏ß‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•");
        const prefix = isWangNa ? "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏£‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠" : "‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        result.relationship = prefix;
        if (mother && (mW >= 5 || mother.relationship === "‡∏û‡∏£‡∏∞‡∏ä‡∏≤‡∏¢‡∏≤")) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            result.titlePrefix = prefix + " ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤";
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)";
            result.titlePrefix = prefix;
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: Logic ‡∏•‡∏π‡∏Å‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï (‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå) ---
    const isPastMonarch = father && father.isMonarch && (father.id !== monarchId);
    if (isPastMonarch) {
        result.relationship = "‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå";
        const isMotherHighRoyal = mother && (mW >= 8 || (mother.titleSuffix && mother.titleSuffix.includes("‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä")));
        if (isMotherHighRoyal) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠"; 
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
            result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡∏£‡∏°‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠ (‡∏´‡∏•‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) ---
    const isFatherChildOfMonarch = father && (father.fatherId === monarchId || father.motherId === monarchId);
    if (isFatherChildOfMonarch) {
        result.relationship = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        if (mW >= 8) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"; result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        } else {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)"; result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏ô‡πÄ‡∏ò‡∏≠";
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Å‡∏é‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡∏¥‡∏î‡∏≤ (‡∏¢‡∏®‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏û‡πà‡∏≠) ---
    if (mW > fW && fW > 1 && !isAlreadyPromoted) {
        if (fW >= 5 && fW <= 7) { 
            result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"; result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤";
        } else if (fW === 4) { 
            result.royalRank = "‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô"; result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå";
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: Logic ‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠ (‡∏Å‡∏£‡∏ì‡∏µ‡∏ö‡∏¥‡∏î‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏á) ---
    if (fW >= 5) { // ‡∏ö‡∏¥‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        result.relationship = "‡∏û‡∏£‡∏∞‡∏≠‡∏ô‡∏∏‡∏ß‡∏á‡∏®‡πå";
        if (fW >= 8 && mW >= 8) {
            result.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"; result.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        } 
        else if ((fW >= 5 && fW <= 7) && (mW >= 5 && mW <= 7)) {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏µ)"; result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
        else if (fW >= 8 && mW >= 4) {
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)"; result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
        else if (fW === 10 && mW === 1) { // ‡∏û‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡πÄ‡∏≠‡∏Å + ‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô
            result.royalRank = "‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡πÄ‡∏à‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏ó)"; result.titlePrefix = "‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏ß‡∏£‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏ò‡∏≠";
        }
       else {
            // ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (isAlreadyPromoted) return result;
            result.royalRank = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"; 
            result.titlePrefix = "‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤"; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡πà‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤
        }
        return result;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7: Default ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏™‡∏∑‡∏ö‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• ---
    if (father && !isAlreadyPromoted) {
        if (fW === 4) result.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå';
        else if (father.titlePrefix === '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå') result.titlePrefix = '‡∏´‡∏°‡πà‡∏≠‡∏°‡∏´‡∏•‡∏ß‡∏á';
    }

    return result;
}

/**
 * 3. SMART PARENT SELECTION
 */
function handleParentSelection(type) {
    validateParent(type); 
    const targetId = document.getElementById(type === 'father' ? 'p_fatherId' : 'p_motherId').value;
    const otherType = type === 'father' ? 'mother' : 'father';
    const otherSearchInput = document.getElementById(otherType === 'father' ? 'p_fatherSearch' : 'p_motherSearch');
    const otherIdInput = document.getElementById(otherType === 'father' ? 'p_fatherId' : 'p_motherId');
    const otherDatalist = document.getElementById(otherType === 'father' ? 'fatherOptions' : 'motherOptions');

    if (targetId) {
        const person = state.members.find(m => m.id === targetId);
        const spouses = person.spouseIds || [];
        if (spouses.length === 1) {
            const spouse = state.members.find(m => m.id === spouses[0]);
            if (spouse) {
                otherIdInput.value = spouse.id;
                otherSearchInput.value = spouse.name;
            }
        } 
        else if (spouses.length > 1) {
            otherDatalist.innerHTML = ''; 
            spouses.forEach(sid => {
                const s = state.members.find(m => m.id === sid);
                if (s) {
                    const op = document.createElement('option');
                    op.value = s.id; op.innerText = s.name + " (‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™)";
                    otherDatalist.appendChild(op);
                }
            });
            if (!otherIdInput.value) {
                otherSearchInput.focus();
                otherSearchInput.value = ''; 
            }
        }
    }
    autoFillRank(); 
}

/**
 * 5. HYBRID UI LOGIC - AUTO FILL
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 */
function autoFillRank() {
    const fId = document.getElementById('p_fatherId').value;
    const mId = document.getElementById('p_motherId').value;
    const gender = document.querySelector('input[name="gender"]:checked')?.value || 'M';
    const bYear = document.getElementById('p_birthYear').value;
    const isMonarchCheckbox = document.getElementById('p_isMonarch').checked;

    const auto = calculateChildRank(fId, mId, gender, bYear);

    if (isMonarchCheckbox) {
        auto.relationship = "‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå";
        auto.titlePrefix = "‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞";
        auto.royalRank = "‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)";
    }

    document.getElementById('p_relationship').value = auto.relationship;
    
    updatePrefixOptions();
    
    const prefixDropdown = document.getElementById('p_titlePrefix');
    const optionExists = Array.from(prefixDropdown.options).some(opt => opt.value === auto.titlePrefix);
    
    if (!optionExists && auto.titlePrefix) {
        const newOpt = document.createElement('option');
        newOpt.value = auto.titlePrefix; newOpt.text = auto.titlePrefix;
        prefixDropdown.add(newOpt);
    }

    prefixDropdown.value = auto.titlePrefix;
    document.getElementById('p_royalRank').value = auto.royalRank;
    document.getElementById('p_royalSurnameInput').value = auto.royalSurname || '';
    updateSuffixOptions();
}

/**
 * 6. MANUAL COMMAND MODE (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö - ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
 * ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠
 */
document.getElementById('p_relationship').addEventListener('change', function() {
    const selectedRel = this.value;
    if (!selectedRel) return;

    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
    updatePrefixOptions(); 
    
    const rankSelect = document.getElementById('p_royalRank');
    if (selectedRel.includes('‡∏ö‡∏≤‡∏ó‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏£‡∏¥‡∏Å‡∏≤') || selectedRel === '‡∏´‡∏°‡πà‡∏≠‡∏°' || selectedRel.includes('‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') || selectedRel === '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô') {
        rankSelect.value = '‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ä‡∏ô';
    } else if (selectedRel === '‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå') {
        rankSelect.value = '‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤ (‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏Å)';
    }

    const prefixSelect = document.getElementById('p_titlePrefix');
    if (prefixSelect.options.length > 1) {
        prefixSelect.selectedIndex = 1; 
        updateSuffixOptions();
    }
});

// ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡πÅ‡∏¢‡∏Å Auto ‡πÅ‡∏•‡∏∞ Manual ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
document.getElementById('p_isMonarch').addEventListener('change', autoFillRank);
document.getElementById('p_fatherSearch').addEventListener('change', () => handleParentSelection('father'));
document.getElementById('p_motherSearch').addEventListener('change', () => handleParentSelection('mother'));
document.querySelectorAll('input[name="gender"]').forEach(el => el.addEventListener('change', autoFillRank));
document.getElementById('p_birthYear').addEventListener('input', autoFillRank);

function calculateChildRankGeneric(fatherId, motherId, gender) {
    const bYear = document.getElementById('p_birthYear')?.value || null;
    return calculateChildRank(fatherId, motherId, gender, bYear);
}
</script>
</body>
</html>
